const md=function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&t(a)}).observe(document,{childList:!0,subtree:!0});function n(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerpolicy&&(r.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?r.credentials="include":e.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(e){if(e.ep)return;e.ep=!0;const r=n(e);fetch(e.href,r)}};md();var Dr;(function(i){i[i.Disjoint=0]="Disjoint",i[i.Contains=1]="Contains",i[i.Intersects=2]="Intersects"})(Dr||(Dr={}));var Rt;(function(i){i[i.Back=0]="Back",i[i.Front=1]="Front",i[i.Intersecting=2]="Intersecting"})(Rt||(Rt={}));function Lo(i,o){for(var n=0;n<o.length;n++){var t=o[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(i,t.key,t)}}function va(i,o,n){return o&&Lo(i.prototype,o),n&&Lo(i,n),Object.defineProperty(i,"prototype",{writable:!1}),i}var H=function(){function i(){}return i.clamp=function(n,t,e){return Math.max(t,Math.min(e,n))},i.equals=function(n,t){return Math.abs(n-t)<=i.zeroTolerance},i.isPowerOf2=function(n){return(n&n-1)===0},i.radianToDegree=function(n){return n*i.radToDegreeFactor},i.degreeToRadian=function(n){return n*i.degreeToRadFactor},i}();H.zeroTolerance=1e-6;H.radToDegreeFactor=180/Math.PI;H.degreeToRadFactor=Math.PI/180;var T=function(){i.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._z=t._z+e._z,r._onValueChanged&&r._onValueChanged()},i.subtract=function(t,e,r){r._x=t._x-e._x,r._y=t._y-e._y,r._z=t._z-e._z,r._onValueChanged&&r._onValueChanged()},i.multiply=function(t,e,r){r._x=t._x*e._x,r._y=t._y*e._y,r._z=t._z*e._z,r._onValueChanged&&r._onValueChanged()},i.divide=function(t,e,r){r._x=t._x/e._x,r._y=t._y/e._y,r._z=t._z/e._z,r._onValueChanged&&r._onValueChanged()},i.dot=function(t,e){return t._x*e._x+t._y*e._y+t._z*e._z},i.cross=function(t,e,r){var a=t._x,s=t._y,l=t._z,c=e._x,u=e._y,h=e._z;r.set(s*h-l*u,l*c-a*h,a*u-s*c)},i.distance=function(t,e){var r=e._x-t._x,a=e._y-t._y,s=e._z-t._z;return Math.sqrt(r*r+a*a+s*s)},i.distanceSquared=function(t,e){var r=e._x-t._x,a=e._y-t._y,s=e._z-t._z;return r*r+a*a+s*s},i.equals=function(t,e){return H.equals(t._x,e._x)&&H.equals(t._y,e._y)&&H.equals(t._z,e._z)},i.lerp=function(t,e,r,a){var s=t._x,l=t._y,c=t._z;a._x=s+(e._x-s)*r,a._y=l+(e._y-l)*r,a._z=c+(e._z-c)*r,a._onValueChanged&&a._onValueChanged()},i.max=function(t,e,r){r._x=Math.max(t._x,e._x),r._y=Math.max(t._y,e._y),r._z=Math.max(t._z,e._z),r._onValueChanged&&r._onValueChanged()},i.min=function(t,e,r){r._x=Math.min(t._x,e._x),r._y=Math.min(t._y,e._y),r._z=Math.min(t._z,e._z),r._onValueChanged&&r._onValueChanged()},i.negate=function(t,e){e._x=-t._x,e._y=-t._y,e._z=-t._z,e._onValueChanged&&e._onValueChanged()},i.normalize=function(t,e){var r=t._x,a=t._y,s=t._z,l=Math.sqrt(r*r+a*a+s*s);l>H.zeroTolerance&&(l=1/l,e.set(r*l,a*l,s*l))},i.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._z=t._z*e,r._onValueChanged&&r._onValueChanged()},i.transformNormal=function(t,e,r){var a=t._x,s=t._y,l=t._z,c=e.elements;r._x=a*c[0]+s*c[4]+l*c[8],r._y=a*c[1]+s*c[5]+l*c[9],r._z=a*c[2]+s*c[6]+l*c[10],r._onValueChanged&&r._onValueChanged()},i.transformToVec3=function(t,e,r){var a=t._x,s=t._y,l=t._z,c=e.elements;r._x=a*c[0]+s*c[4]+l*c[8]+c[12],r._y=a*c[1]+s*c[5]+l*c[9]+c[13],r._z=a*c[2]+s*c[6]+l*c[10]+c[14],r._onValueChanged&&r._onValueChanged()},i.transformToVec4=function(t,e,r){var a=t._x,s=t._y,l=t._z,c=e.elements;r._x=a*c[0]+s*c[4]+l*c[8]+c[12],r._y=a*c[1]+s*c[5]+l*c[9]+c[13],r._z=a*c[2]+s*c[6]+l*c[10]+c[14],r._w=a*c[3]+s*c[7]+l*c[11]+c[15],r._onValueChanged&&r._onValueChanged()},i.transformCoordinate=function(t,e,r){var a=t._x,s=t._y,l=t._z,c=e.elements,u=a*c[3]+s*c[7]+l*c[11]+c[15];u=1/u,r._x=(a*c[0]+s*c[4]+l*c[8]+c[12])*u,r._y=(a*c[1]+s*c[5]+l*c[9]+c[13])*u,r._z=(a*c[2]+s*c[6]+l*c[10]+c[14])*u,r._onValueChanged&&r._onValueChanged()},i.transformByQuat=function(t,e,r){var a=t._x,s=t._y,l=t._z,c=e._x,u=e._y,h=e._z,d=e._w,f=d*a+u*l-h*s,_=d*s+h*a-c*l,g=d*l+c*s-u*a,v=-c*a-u*s-h*l;r._x=f*d-v*c-_*h+g*u,r._y=_*d-v*u-g*c+f*h,r._z=g*d-v*h-f*u+_*c,r._onValueChanged&&r._onValueChanged()};function i(n,t,e){n===void 0&&(n=0),t===void 0&&(t=0),e===void 0&&(e=0),this._x=void 0,this._y=void 0,this._z=void 0,this._onValueChanged=null,this._x=n,this._y=t,this._z=e}var o=i.prototype;return o.set=function(t,e,r){return this._x=t,this._y=e,this._z=r,this._onValueChanged&&this._onValueChanged(),this},o.add=function(t){return this._x+=t._x,this._y+=t._y,this._z+=t._z,this._onValueChanged&&this._onValueChanged(),this},o.subtract=function(t){return this._x-=t._x,this._y-=t._y,this._z-=t._z,this._onValueChanged&&this._onValueChanged(),this},o.multiply=function(t){return this._x*=t._x,this._y*=t._y,this._z*=t._z,this._onValueChanged&&this._onValueChanged(),this},o.divide=function(t){return this._x/=t._x,this._y/=t._y,this._z/=t._z,this._onValueChanged&&this._onValueChanged(),this},o.length=function(){var t=this._x,e=this._y,r=this._z;return Math.sqrt(t*t+e*e+r*r)},o.lengthSquared=function(){var t=this._x,e=this._y,r=this._z;return t*t+e*e+r*r},o.negate=function(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._onValueChanged&&this._onValueChanged(),this},o.normalize=function(){return i.normalize(this,this),this},o.scale=function(t){return this._x*=t,this._y*=t,this._z*=t,this._onValueChanged&&this._onValueChanged(),this},o.transformNormal=function(t){return i.transformNormal(this,t,this),this},o.transformToVec3=function(t){return i.transformToVec3(this,t,this),this},o.transformCoordinate=function(t){return i.transformCoordinate(this,t,this),this},o.transformByQuat=function(t){return i.transformByQuat(this,t,this),this},o.clone=function(){return new i(this._x,this._y,this._z)},o.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._onValueChanged&&this._onValueChanged(),this},o.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._onValueChanged&&this._onValueChanged(),this},o.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z},va(i,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onValueChanged&&this._onValueChanged()}}]),i}();T._zero=new T(0,0,0);T._one=new T(1,1,1);new T;var ir=function(){i.fromCenterAndExtent=function(t,e,r){T.subtract(t,e,r.min),T.add(t,e,r.max)},i.fromPoints=function(t,e){if(!t||t.length===0)throw new Error("points must be array and length must > 0");var r=e.min,a=e.max;r.x=r.y=r.z=Number.MAX_VALUE,a.x=a.y=a.z=-Number.MAX_VALUE;for(var s=0,l=t.length;s<l;++s){var c=t[s];T.min(r,c,r),T.max(a,c,a)}},i.fromSphere=function(t,e){var r=t.center,a=t.radius,s=e.min,l=e.max;s.x=r.x-a,s.y=r.y-a,s.z=r.z-a,l.x=r.x+a,l.y=r.y+a,l.z=r.z+a},i.transform=function(t,e,r){var a=i._tempVec30,s=i._tempVec31;t.getCenter(a),t.getExtent(s),T.transformCoordinate(a,e,a);var l=s.x,c=s.y,u=s.z,h=e.elements;s.x=Math.abs(l*h[0])+Math.abs(c*h[4])+Math.abs(u*h[8]),s.y=Math.abs(l*h[1])+Math.abs(c*h[5])+Math.abs(u*h[9]),s.z=Math.abs(l*h[2])+Math.abs(c*h[6])+Math.abs(u*h[10]),T.subtract(a,s,r.min),T.add(a,s,r.max)},i.merge=function(t,e,r){return T.min(t.min,e.min,r.min),T.max(t.max,e.max,r.max),r};function i(n,t){n===void 0&&(n=null),t===void 0&&(t=null),this.min=new T,this.max=new T,n&&this.min.copyFrom(n),t&&this.max.copyFrom(t)}var o=i.prototype;return o.getCenter=function(t){return T.add(this.min,this.max,t),T.scale(t,.5,t),t},o.getExtent=function(t){return T.subtract(this.max,this.min,t),T.scale(t,.5,t),t},o.getCorners=function(t){t===void 0&&(t=[]);var e=this.min,r=this.max,a=e.x,s=e.y,l=e.z,c=r.x,u=r.y,h=r.z,d=t.length;if(d<8)for(var f=0,_=8-d;f<_;++f)t[d+f]=new T;return t[0].set(a,u,h),t[1].set(c,u,h),t[2].set(c,s,h),t[3].set(a,s,h),t[4].set(a,u,l),t[5].set(c,u,l),t[6].set(c,s,l),t[7].set(a,s,l),t},o.transform=function(t){return i.transform(this,t,this),this},o.clone=function(){return new i(this.min,this.max)},o.copyFrom=function(t){return this.min.copyFrom(t.min),this.max.copyFrom(t.max),this},i}();ir._tempVec30=new T;ir._tempVec31=new T;var Ei=function(){function i(){}return i.distancePlaneAndPoint=function(n,t){return T.dot(n.normal,t)+n.distance},i.intersectsPlaneAndPoint=function(n,t){var e=i.distancePlaneAndPoint(n,t);return e>0?Rt.Front:e<0?Rt.Back:Rt.Intersecting},i.intersectsPlaneAndBox=function(n,t){var e=t.min,r=t.max,a=n.normal,s=i._tempVec30,l=i._tempVec31;return a.x>=0?(s.x=r.x,l.x=e.x):(s.x=e.x,l.x=r.x),a.y>=0?(s.y=r.y,l.y=e.y):(s.y=e.y,l.y=r.y),a.z>=0?(s.z=r.z,l.z=e.z):(s.z=e.z,l.z=r.z),i.distancePlaneAndPoint(n,s)<0?Rt.Back:i.distancePlaneAndPoint(n,l)>0?Rt.Front:Rt.Intersecting},i.intersectsPlaneAndSphere=function(n,t){var e=t.center,r=t.radius,a=i.distancePlaneAndPoint(n,e);return a>r?Rt.Front:a<-r?Rt.Back:Rt.Intersecting},i.intersectsRayAndPlane=function(n,t){var e=t.normal,r=H.zeroTolerance,a=T.dot(e,n.direction);if(Math.abs(a)<r)return-1;var s=T.dot(e,n.origin),l=(-t.distance-s)/a;if(l<0){if(l<-r)return-1;l=0}return l},i.intersectsRayAndBox=function(n,t){var e=H.zeroTolerance,r=n.origin,a=n.direction,s=t.min,l=t.max,c=a.x,u=a.y,h=a.z,d=r.x,f=r.y,_=r.z,g=0,v=Number.MAX_VALUE;if(Math.abs(c)<e){if(d<s.x||d>l.x)return-1}else{var p=1/c,m=(s.x-d)*p,y=(l.x-d)*p;if(m>y){var x=m;m=y,y=x}if(g=Math.max(m,g),v=Math.min(y,v),g>v)return-1}if(Math.abs(u)<e){if(f<s.y||f>l.y)return-1}else{var S=1/u,w=(s.y-f)*S,b=(l.y-f)*S;if(w>b){var A=w;w=b,b=A}if(g=Math.max(w,g),v=Math.min(b,v),g>v)return-1}if(Math.abs(h)<e){if(_<s.z||_>l.z)return-1}else{var E=1/h,C=(s.z-_)*E,M=(l.z-_)*E;if(C>M){var P=C;C=M,M=P}if(g=Math.max(C,g),v=Math.min(M,v),g>v)return-1}return g},i.intersectsRayAndSphere=function(n,t){var e=n.origin,r=n.direction,a=t.center,s=t.radius,l=i._tempVec30;T.subtract(e,a,l);var c=T.dot(l,r),u=T.dot(l,l)-s*s;if(c>0&&u>0)return-1;var h=c*c-u;if(h<0)return-1;var d=-c-Math.sqrt(h);return d<0&&(d=0),d},i.intersectsBoxAndBox=function(n,t){return n.min.x>t.max.x||t.min.x>n.max.x||n.min.y>t.max.y||t.min.y>n.max.y?!1:!(n.min.z>t.max.z||t.min.z>n.max.z)},i.intersectsSphereAndSphere=function(n,t){var e=n.radius+t.radius;return T.distanceSquared(n.center,t.center)<e*e},i.intersectsSphereAndBox=function(n,t){var e=n.center,r=t.max,a=t.min,s=i._tempVec30;s.set(Math.max(a.x,Math.min(e.x,r.x)),Math.max(a.y,Math.min(e.y,r.y)),Math.max(a.z,Math.min(e.z,r.z)));var l=T.distanceSquared(e,s);return l<=n.radius*n.radius},i.intersectsFrustumAndBox=function(n,t){for(var e=t.min,r=t.max,a=i._tempVec30,s=0;s<6;++s){var l=n.getPlane(s),c=l.normal;if(a.set(c.x>=0?e.x:r.x,c.y>=0?e.y:r.y,c.z>=0?e.z:r.z),T.dot(c,a)>-l.distance)return!1}return!0},i.frustumContainsBox=function(n,t){for(var e=t.min,r=t.max,a=i._tempVec30,s=i._tempVec31,l=Dr.Contains,c=0;c<6;++c){var u=n.getPlane(c),h=u.normal;if(h.x>=0?(a.x=r.x,s.x=e.x):(a.x=e.x,s.x=r.x),h.y>=0?(a.y=r.y,s.y=e.y):(a.y=e.y,s.y=r.y),h.z>=0?(a.z=r.z,s.z=e.z):(a.z=e.z,s.z=r.z),i.intersectsPlaneAndPoint(u,s)===Rt.Front)return Dr.Disjoint;i.intersectsPlaneAndPoint(u,a)===Rt.Front&&(l=Dr.Intersects)}return l},i.frustumContainsSphere=function(n,t){for(var e=Dr.Contains,r=0;r<6;++r){var a=n.getPlane(r),s=i.intersectsPlaneAndSphere(a,t);if(s===Rt.Front)return Dr.Disjoint;if(s===Rt.Intersecting){e=Dr.Intersects;break}}return e},i}();Ei._tempVec30=new T;Ei._tempVec31=new T;var Oi=function(){i.normalize=function(t,e){var r=t.normal,a=1/r.length();T.scale(r,a,e.normal),e.distance=t.distance*a},i.fromPoints=function(t,e,r,a){var s=t.x,l=t.y,c=t.z,u=e.x-s,h=e.y-l,d=e.z-c,f=r.x-s,_=r.y-l,g=r.z-c,v=h*g-d*_,p=d*f-u*g,m=u*_-h*f,y=1/Math.sqrt(v*v+p*p+m*m),x=v*y,S=p*y,w=m*y,b=a.normal;b.x=x,b.y=S,b.z=w,a.distance=-(x*s+S*l+w*c)};function i(n,t){n===void 0&&(n=null),t===void 0&&(t=0),this.normal=new T,this.distance=0,n&&this.normal.copyFrom(n),this.distance=t}var o=i.prototype;return o.normalize=function(){return i.normalize(this,this),this},o.clone=function(){var t=new i;return t.copyFrom(this),t},o.copyFrom=function(t){return this.normal.copyFrom(t.normal),this.distance=t.distance,this},i}(),yd=function(){function i(n){n===void 0&&(n=null),this.near=void 0,this.far=void 0,this.left=void 0,this.right=void 0,this.top=void 0,this.bottom=void 0,this.near=new Oi,this.far=new Oi,this.left=new Oi,this.right=new Oi,this.top=new Oi,this.bottom=new Oi,n&&this.calculateFromMatrix(n)}var o=i.prototype;return o.getPlane=function(t){switch(t){case 0:return this.near;case 1:return this.far;case 2:return this.left;case 3:return this.right;case 4:return this.top;case 5:return this.bottom;default:return null}},o.calculateFromMatrix=function(t){var e=t.elements,r=e[0],a=e[1],s=e[2],l=e[3],c=e[4],u=e[5],h=e[6],d=e[7],f=e[8],_=e[9],g=e[10],v=e[11],p=e[12],m=e[13],y=e[14],x=e[15],S=this.near.normal;S.set(-l-s,-d-h,-v-g),this.near.distance=-x-y,this.near.normalize();var w=this.far.normal;w.set(s-l,h-d,g-v),this.far.distance=y-x,this.far.normalize();var b=this.left.normal;b.set(-l-r,-d-c,-v-f),this.left.distance=-x-p,this.left.normalize();var A=this.right.normal;A.set(r-l,c-d,f-v),this.right.distance=p-x,this.right.normalize();var E=this.top.normal;E.set(a-l,u-d,_-v),this.top.distance=m-x,this.top.normalize();var C=this.bottom.normal;C.set(-l-a,-d-u,-v-_),this.bottom.distance=-x-m,this.bottom.normalize()},o.intersectsBox=function(t){return Ei.intersectsFrustumAndBox(this,t)},o.intersectsSphere=function(t){return Ei.frustumContainsSphere(this,t)!==Dr.Disjoint},o.clone=function(){var t=new i;return t.copyFrom(this),t},o.copyFrom=function(t){return this.near.copyFrom(t.near),this.far.copyFrom(t.far),this.left.copyFrom(t.left),this.right.copyFrom(t.right),this.top.copyFrom(t.top),this.bottom.copyFrom(t.bottom),this},i}(),Gi=function(){i.add=function(t,e,r){var a=t.elements,s=e.elements,l=r.elements;l[0]=a[0]+s[0],l[1]=a[1]+s[1],l[2]=a[2]+s[2],l[3]=a[3]+s[3],l[4]=a[4]+s[4],l[5]=a[5]+s[5],l[6]=a[6]+s[6],l[7]=a[7]+s[7],l[8]=a[8]+s[8]},i.subtract=function(t,e,r){var a=t.elements,s=e.elements,l=r.elements;l[0]=a[0]-s[0],l[1]=a[1]-s[1],l[2]=a[2]-s[2],l[3]=a[3]-s[3],l[4]=a[4]-s[4],l[5]=a[5]-s[5],l[6]=a[6]-s[6],l[7]=a[7]-s[7],l[8]=a[8]-s[8]},i.multiply=function(t,e,r){var a=t.elements,s=e.elements,l=r.elements,c=a[0],u=a[1],h=a[2],d=a[3],f=a[4],_=a[5],g=a[6],v=a[7],p=a[8],m=s[0],y=s[1],x=s[2],S=s[3],w=s[4],b=s[5],A=s[6],E=s[7],C=s[8];l[0]=c*m+d*y+g*x,l[1]=u*m+f*y+v*x,l[2]=h*m+_*y+p*x,l[3]=c*S+d*w+g*b,l[4]=u*S+f*w+v*b,l[5]=h*S+_*w+p*b,l[6]=c*A+d*E+g*C,l[7]=u*A+f*E+v*C,l[8]=h*A+_*E+p*C},i.equals=function(t,e){var r=t.elements,a=e.elements;return H.equals(r[0],a[0])&&H.equals(r[1],a[1])&&H.equals(r[2],a[2])&&H.equals(r[3],a[3])&&H.equals(r[4],a[4])&&H.equals(r[5],a[5])&&H.equals(r[6],a[6])&&H.equals(r[7],a[7])&&H.equals(r[8],a[8])},i.lerp=function(t,e,r,a){var s=t.elements,l=e.elements,c=a.elements,u=1-r;c[0]=s[0]*u+l[0]*r,c[1]=s[1]*u+l[1]*r,c[2]=s[2]*u+l[2]*r,c[3]=s[3]*u+l[3]*r,c[4]=s[4]*u+l[4]*r,c[5]=s[5]*u+l[5]*r,c[6]=s[6]*u+l[6]*r,c[7]=s[7]*u+l[7]*r,c[8]=s[8]*u+l[8]*r},i.rotationQuaternion=function(t,e){var r=e.elements,a=t._x,s=t._y,l=t._z,c=t._w,u=a+a,h=s+s,d=l+l,f=a*u,_=s*u,g=s*h,v=l*u,p=l*h,m=l*d,y=c*u,x=c*h,S=c*d;r[0]=1-g-m,r[3]=_-S,r[6]=v+x,r[1]=_+S,r[4]=1-f-m,r[7]=p-y,r[2]=v-x,r[5]=p+y,r[8]=1-f-g},i.scaling=function(t,e){var r=e.elements;r[0]=t._x,r[1]=0,r[2]=0,r[3]=0,r[4]=t._y,r[5]=0,r[6]=0,r[7]=0,r[8]=1},i.translation=function(t,e){var r=e.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=t._x,r[7]=t._y,r[8]=1},i.invert=function(t,e){var r=t.elements,a=e.elements,s=r[0],l=r[1],c=r[2],u=r[3],h=r[4],d=r[5],f=r[6],_=r[7],g=r[8],v=g*h-d*_,p=-g*u+d*f,m=_*u-h*f,y=s*v+l*p+c*m;!y||(y=1/y,a[0]=v*y,a[1]=(-g*l+c*_)*y,a[2]=(d*l-c*h)*y,a[3]=p*y,a[4]=(g*s-c*f)*y,a[5]=(-d*s+c*u)*y,a[6]=m*y,a[7]=(-_*s+l*f)*y,a[8]=(h*s-l*u)*y)},i.normalMatrix=function(t,e){var r=t.elements,a=e.elements,s=r[0],l=r[1],c=r[2],u=r[3],h=r[4],d=r[5],f=r[6],_=r[7],g=r[8],v=r[9],p=r[10],m=r[11],y=r[12],x=r[13],S=r[14],w=r[15],b=s*d-l*h,A=s*f-c*h,E=s*_-u*h,C=l*f-c*d,M=l*_-u*d,P=c*_-u*f,R=g*x-v*y,B=g*S-p*y,D=g*w-m*y,L=v*S-p*x,N=v*w-m*x,W=p*w-m*S,I=b*W-A*N+E*L+C*D-M*B+P*R;if(!I)return null;I=1/I,a[0]=(d*W-f*N+_*L)*I,a[1]=(f*D-h*W-_*B)*I,a[2]=(h*N-d*D+_*R)*I,a[3]=(c*N-l*W-u*L)*I,a[4]=(s*W-c*D+u*B)*I,a[5]=(l*D-s*N-u*R)*I,a[6]=(x*P-S*M+w*C)*I,a[7]=(S*E-y*P-w*A)*I,a[8]=(y*M-x*E+w*b)*I},i.rotate=function(t,e,r){var a=t.elements,s=r.elements,l=Math.sin(e),c=Math.cos(e),u=a[0],h=a[1],d=a[2],f=a[3],_=a[4],g=a[5],v=a[6],p=a[7],m=a[8];s[0]=c*u+l*f,s[1]=c*h+l*_,s[2]=c*d+l*g,s[3]=c*f-l*u,s[4]=c*_-l*h,s[5]=c*g-l*d,s[6]=v,s[7]=p,s[8]=m},i.scale=function(t,e,r){var a=e._x,s=e._y,l=t.elements,c=r.elements;c[0]=a*l[0],c[1]=a*l[1],c[2]=a*l[2],c[3]=s*l[3],c[4]=s*l[4],c[5]=s*l[5],c[6]=l[6],c[7]=l[7],c[8]=l[8]},i.translate=function(t,e,r){var a=e._x,s=e._y,l=t.elements,c=r.elements,u=l[0],h=l[1],d=l[2],f=l[3],_=l[4],g=l[5],v=l[6],p=l[7],m=l[8];c[0]=u,c[1]=h,c[2]=d,c[3]=f,c[4]=_,c[5]=g,c[6]=a*u+s*f+v,c[7]=a*h+s*_+p,c[8]=a*d+s*g+m},i.transpose=function(t,e){var r=t.elements,a=e.elements;if(e===t){var s=r[1],l=r[2],c=r[5];a[1]=r[3],a[2]=r[6],a[3]=s,a[5]=r[7],a[6]=l,a[7]=c}else a[0]=r[0],a[1]=r[3],a[2]=r[6],a[3]=r[1],a[4]=r[4],a[5]=r[7],a[6]=r[2],a[7]=r[5],a[8]=r[8]};function i(n,t,e,r,a,s,l,c,u){n===void 0&&(n=1),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),a===void 0&&(a=1),s===void 0&&(s=0),l===void 0&&(l=0),c===void 0&&(c=0),u===void 0&&(u=1),this.elements=new Float32Array(9);var h=this.elements;h[0]=n,h[1]=t,h[2]=e,h[3]=r,h[4]=a,h[5]=s,h[6]=l,h[7]=c,h[8]=u}var o=i.prototype;return o.set=function(t,e,r,a,s,l,c,u,h){var d=this.elements;return d[0]=t,d[1]=e,d[2]=r,d[3]=a,d[4]=s,d[5]=l,d[6]=c,d[7]=u,d[8]=h,this},o.add=function(t){return i.add(this,t,this),this},o.subtract=function(t){return i.subtract(this,t,this),this},o.multiply=function(t){return i.multiply(this,t,this),this},o.determinant=function(){var t=this.elements,e=t[0],r=t[1],a=t[2],s=t[3],l=t[4],c=t[5],u=t[6],h=t[7],d=t[8],f=d*l-c*h,_=-d*s+c*u,g=h*s-l*u;return e*f+r*_+a*g},o.identity=function(){var t=this.elements;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},o.invert=function(){return i.invert(this,this),this},o.rotate=function(t){return i.rotate(this,t,this),this},o.scale=function(t){return i.scale(this,t,this),this},o.translate=function(t){return i.translate(this,t,this),this},o.transpose=function(){return i.transpose(this,this),this},o.clone=function(){var t=this.elements,e=new i(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]);return e},o.copyFrom=function(t){var e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],this},o.copyFromArray=function(t,e){e===void 0&&(e=0);for(var r=this.elements,a=0;a<12;a++)r[a]=t[a+e];return this},o.copyToArray=function(t,e){e===void 0&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8]},o.copyFromMatrix=function(t){var e=t.elements,r=this.elements;return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],this},i}(),De=function(){i.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._z=t._z+e._z,r._w=t._w+e._w,r._onValueChanged&&r._onValueChanged()},i.multiply=function(t,e,r){var a=t._x,s=t._y,l=t._z,c=t._w,u=e._x,h=e._y,d=e._z,f=e._w;r._x=a*f+c*u+s*d-l*h,r._y=s*f+c*h+l*u-a*d,r._z=l*f+c*d+a*h-s*u,r._w=c*f-a*u-s*h-l*d,r._onValueChanged&&r._onValueChanged()},i.conjugate=function(t,e){e._x=-t._x,e._y=-t._y,e._z=-t._z,e._w=t._w,e._onValueChanged&&e._onValueChanged()},i.dot=function(t,e){return t._x*e._x+t._y*e._y+t._z*e._z+t._w*e._w},i.equals=function(t,e){return H.equals(t._x,e._x)&&H.equals(t._y,e._y)&&H.equals(t._z,e._z)&&H.equals(t._w,e._w)},i.rotationAxisAngle=function(t,e,r){var a=i._tempVector3;T.normalize(t,a),e*=.5;var s=Math.sin(e);r._x=a._x*s,r._y=a._y*s,r._z=a._z*s,r._w=Math.cos(e),r._onValueChanged&&r._onValueChanged()},i.rotationEuler=function(t,e,r,a){i.rotationYawPitchRoll(e,t,r,a)},i.rotationYawPitchRoll=function(t,e,r,a){var s=r*.5,l=e*.5,c=t*.5,u=Math.sin(s),h=Math.cos(s),d=Math.sin(l),f=Math.cos(l),_=Math.sin(c),g=Math.cos(c),v=g*f,p=_*d;a._x=g*d*h+_*f*u,a._y=_*f*h-g*d*u,a._z=v*u-p*h,a._w=v*h+p*u,a._onValueChanged&&a._onValueChanged()},i.rotationMatrix3x3=function(t,e){var r=t.elements,a=r[0],s=r[1],l=r[2],c=r[3],u=r[4],h=r[5],d=r[6],f=r[7],_=r[8],g=a+u+_,v,p;g>0?(v=Math.sqrt(g+1),e._w=v*.5,v=.5/v,e._x=(h-f)*v,e._y=(d-l)*v,e._z=(s-c)*v):a>=u&&a>=_?(v=Math.sqrt(1+a-u-_),p=.5/v,e._x=.5*v,e._y=(s+c)*p,e._z=(l+d)*p,e._w=(h-f)*p):u>_?(v=Math.sqrt(1+u-a-_),p=.5/v,e._x=(c+s)*p,e._y=.5*v,e._z=(f+h)*p,e._w=(d-l)*p):(v=Math.sqrt(1+_-a-u),p=.5/v,e._x=(l+d)*p,e._y=(h+f)*p,e._z=.5*v,e._w=(s-c)*p),e._onValueChanged&&e._onValueChanged()},i.invert=function(t,e){var r=t._x,a=t._y,s=t._z,l=t._w,c=r*r+a*a+s*s+l*l;if(c>H.zeroTolerance){var u=1/c;e._x=-r*u,e._y=-a*u,e._z=-s*u,e._w=l*u,e._onValueChanged&&e._onValueChanged()}},i.lerp=function(t,e,r,a){var s=1-r;i.dot(t,e)>=0?(a._x=t._x*s+e._x*r,a._y=t._y*s+e._y*r,a._z=t._z*s+e._z*r,a._w=t._w*s+e._w*r):(a._x=t._x*s-e._x*r,a._y=t._y*s-e._y*r,a._z=t._z*s-e._z*r,a._w=t._w*s-e._w*r),a.normalize()},i.slerp=function(t,e,r,a){var s=t._x,l=t._y,c=t._z,u=t._w,h=e._x,d=e._y,f=e._z,_=e._w,g,v,p=s*h+l*d+c*f+u*_;if(p<0&&(p=-p,h=-h,d=-d,f=-f,_=-_),1-p>H.zeroTolerance){var m=Math.acos(p),y=Math.sin(m);g=Math.sin((1-r)*m)/y,v=Math.sin(r*m)/y}else g=1-r,v=r;a._x=g*s+v*h,a._y=g*l+v*d,a._z=g*c+v*f,a._w=g*u+v*_,a._onValueChanged&&a._onValueChanged()},i.normalize=function(t,e){var r=t._x,a=t._y,s=t._z,l=t._w,c=Math.sqrt(r*r+a*a+s*s+l*l);c>H.zeroTolerance&&(c=1/c,e._x=r*c,e._y=a*c,e._z=s*c,e._w=l*c,e._onValueChanged&&e._onValueChanged())},i.rotationX=function(t,e){t*=.5;var r=Math.sin(t),a=Math.cos(t);e._x=r,e._y=0,e._z=0,e._w=a,e._onValueChanged&&e._onValueChanged()},i.rotationY=function(t,e){t*=.5;var r=Math.sin(t),a=Math.cos(t);e._x=0,e._y=r,e._z=0,e._w=a,e._onValueChanged&&e._onValueChanged()},i.rotationZ=function(t,e){t*=.5;var r=Math.sin(t),a=Math.cos(t);e._x=0,e._y=0,e._z=r,e._w=a,e._onValueChanged&&e._onValueChanged()},i.rotateX=function(t,e,r){var a=t._x,s=t._y,l=t._z,c=t._w;e*=.5;var u=Math.sin(e),h=Math.cos(e);r._x=a*h+c*u,r._y=s*h+l*u,r._z=l*h-s*u,r._w=c*h-a*u,r._onValueChanged&&r._onValueChanged()},i.rotateY=function(t,e,r){var a=t._x,s=t._y,l=t._z,c=t._w;e*=.5;var u=Math.sin(e),h=Math.cos(e);r._x=a*h-l*u,r._y=s*h+c*u,r._z=l*h+a*u,r._w=c*h-s*u,r._onValueChanged&&r._onValueChanged()},i.rotateZ=function(t,e,r){var a=t._x,s=t._y,l=t._z,c=t._w;e*=.5;var u=Math.sin(e),h=Math.cos(e);r._x=a*h+s*u,r._y=s*h-a*u,r._z=l*h+c*u,r._w=c*h-l*u,r._onValueChanged&&r._onValueChanged()},i.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._z=t._z*e,r._w=t._w*e,r._onValueChanged&&r._onValueChanged()};function i(n,t,e,r){n===void 0&&(n=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=1),this._x=void 0,this._y=void 0,this._z=void 0,this._w=void 0,this._onValueChanged=null,this._x=n,this._y=t,this._z=e,this._w=r}var o=i.prototype;return o.set=function(t,e,r,a){return this._x=t,this._y=e,this._z=r,this._w=a,this._onValueChanged&&this._onValueChanged(),this},o.conjugate=function(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onValueChanged&&this._onValueChanged(),this},o.getAxisAngle=function(t){var e=this._x,r=this._y,a=this._z,s=e*e+r*r+a*a;if(s<H.zeroTolerance)return t._x=1,t._y=0,t._z=0,0;var l=1/s;return t._x=this._x*l,t._y=this._y*l,t._z=this._z*l,Math.acos(this._w)*2},o.identity=function(){return this._x=0,this._y=0,this._z=0,this._w=1,this._onValueChanged&&this._onValueChanged(),this},o.length=function(){var t=this._x,e=this._y,r=this._z,a=this._w;return Math.sqrt(t*t+e*e+r*r+a*a)},o.lengthSquared=function(){var t=this._x,e=this._y,r=this._z,a=this._w;return t*t+e*e+r*r+a*a},o.normalize=function(){return i.normalize(this,this),this},o.toEuler=function(t){this._toYawPitchRoll(t);var e=t._x;return t._x=t._y,t._y=e,t._onValueChanged&&t._onValueChanged(),t},o.toYawPitchRoll=function(t){return this._toYawPitchRoll(t),t._onValueChanged&&t._onValueChanged(),t},o.rotateX=function(t){return i.rotateX(this,t,this),this},o.rotateY=function(t){return i.rotateY(this,t,this),this},o.rotateZ=function(t){return i.rotateZ(this,t,this),this},o.rotationAxisAngle=function(t,e){return i.rotationAxisAngle(t,e,this),this},o.multiply=function(t){return i.multiply(this,t,this),this},o.invert=function(){return i.invert(this,this),this},o.dot=function(t){return i.dot(this,t)},o.lerp=function(t,e){return i.lerp(this,t,e,this),this},o.rotateAxisAngle=function(t,e){return i._tempQuat1.rotationAxisAngle(t,e),this.multiply(i._tempQuat1),this},o.clone=function(){return new i(this._x,this._y,this._z,this._w)},o.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onValueChanged&&this._onValueChanged(),this},o.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onValueChanged&&this._onValueChanged(),this},o.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w},o._toYawPitchRoll=function(t){var e=this._x,r=this._y,a=this._z,s=this._w,l=e*e,c=r*r,u=a*a,h=e*r,d=a*s,f=a*e,_=r*s,g=r*a,v=e*s;return t._y=Math.asin(2*(v-g)),Math.cos(t.y)>H.zeroTolerance?(t._z=Math.atan2(2*(h+d),1-2*(u+l)),t._x=Math.atan2(2*(f+_),1-2*(c+l))):(t._z=Math.atan2(-2*(h-d),1-2*(c+u)),t._x=0),t},va(i,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onValueChanged&&this._onValueChanged()}},{key:"normalized",get:function(){return Math.abs(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w-1)<H.zeroTolerance}},{key:"w",get:function(){return this._w},set:function(t){this._w=t,this._onValueChanged&&this._onValueChanged()}}]),i}();De._tempVector3=new T;De._tempQuat1=new De;var ce=function(){i.multiply=function(t,e,r){var a=t.elements,s=e.elements,l=r.elements,c=a[0],u=a[1],h=a[2],d=a[3],f=a[4],_=a[5],g=a[6],v=a[7],p=a[8],m=a[9],y=a[10],x=a[11],S=a[12],w=a[13],b=a[14],A=a[15],E=s[0],C=s[1],M=s[2],P=s[3],R=s[4],B=s[5],D=s[6],L=s[7],N=s[8],W=s[9],I=s[10],V=s[11],se=s[12],Z=s[13],Y=s[14],ue=s[15];l[0]=c*E+f*C+p*M+S*P,l[1]=u*E+_*C+m*M+w*P,l[2]=h*E+g*C+y*M+b*P,l[3]=d*E+v*C+x*M+A*P,l[4]=c*R+f*B+p*D+S*L,l[5]=u*R+_*B+m*D+w*L,l[6]=h*R+g*B+y*D+b*L,l[7]=d*R+v*B+x*D+A*L,l[8]=c*N+f*W+p*I+S*V,l[9]=u*N+_*W+m*I+w*V,l[10]=h*N+g*W+y*I+b*V,l[11]=d*N+v*W+x*I+A*V,l[12]=c*se+f*Z+p*Y+S*ue,l[13]=u*se+_*Z+m*Y+w*ue,l[14]=h*se+g*Z+y*Y+b*ue,l[15]=d*se+v*Z+x*Y+A*ue},i.equals=function(t,e){var r=t.elements,a=e.elements;return H.equals(r[0],a[0])&&H.equals(r[1],a[1])&&H.equals(r[2],a[2])&&H.equals(r[3],a[3])&&H.equals(r[4],a[4])&&H.equals(r[5],a[5])&&H.equals(r[6],a[6])&&H.equals(r[7],a[7])&&H.equals(r[8],a[8])&&H.equals(r[9],a[9])&&H.equals(r[10],a[10])&&H.equals(r[11],a[11])&&H.equals(r[12],a[12])&&H.equals(r[13],a[13])&&H.equals(r[14],a[14])&&H.equals(r[15],a[15])},i.lerp=function(t,e,r,a){var s=t.elements,l=e.elements,c=a.elements,u=1-r;c[0]=s[0]*u+l[0]*r,c[1]=s[1]*u+l[1]*r,c[2]=s[2]*u+l[2]*r,c[3]=s[3]*u+l[3]*r,c[4]=s[4]*u+l[4]*r,c[5]=s[5]*u+l[5]*r,c[6]=s[6]*u+l[6]*r,c[7]=s[7]*u+l[7]*r,c[8]=s[8]*u+l[8]*r,c[9]=s[9]*u+l[9]*r,c[10]=s[10]*u+l[10]*r,c[11]=s[11]*u+l[11]*r,c[12]=s[12]*u+l[12]*r,c[13]=s[13]*u+l[13]*r,c[14]=s[14]*u+l[14]*r,c[15]=s[15]*u+l[15]*r},i.rotationQuaternion=function(t,e){var r=e.elements,a=t._x,s=t._y,l=t._z,c=t._w,u=a+a,h=s+s,d=l+l,f=a*u,_=s*u,g=s*h,v=l*u,p=l*h,m=l*d,y=c*u,x=c*h,S=c*d;r[0]=1-g-m,r[1]=_+S,r[2]=v-x,r[3]=0,r[4]=_-S,r[5]=1-f-m,r[6]=p+y,r[7]=0,r[8]=v+x,r[9]=p-y,r[10]=1-f-g,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},i.rotationAxisAngle=function(t,e,r){var a=r.elements,s=t._x,l=t._y,c=t._z,u=Math.sqrt(s*s+l*l+c*c),h,d,f;Math.abs(u)<H.zeroTolerance||(u=1/u,s*=u,l*=u,c*=u,h=Math.sin(e),d=Math.cos(e),f=1-d,a[0]=s*s*f+d,a[1]=l*s*f+c*h,a[2]=c*s*f-l*h,a[3]=0,a[4]=s*l*f-c*h,a[5]=l*l*f+d,a[6]=c*l*f+s*h,a[7]=0,a[8]=s*c*f+l*h,a[9]=l*c*f-s*h,a[10]=c*c*f+d,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1)},i.rotationTranslation=function(t,e,r){i.rotationQuaternion(t,r);var a=r.elements;a[12]=e._x,a[13]=e._y,a[14]=e._z},i.affineTransformation=function(t,e,r,a){var s=a.elements,l=e._x,c=e._y,u=e._z,h=e._w,d=l+l,f=c+c,_=u+u,g=l*d,v=l*f,p=l*_,m=c*f,y=c*_,x=u*_,S=h*d,w=h*f,b=h*_,A=t._x,E=t._y,C=t._z;s[0]=(1-(m+x))*A,s[1]=(v+b)*A,s[2]=(p-w)*A,s[3]=0,s[4]=(v-b)*E,s[5]=(1-(g+x))*E,s[6]=(y+S)*E,s[7]=0,s[8]=(p+w)*C,s[9]=(y-S)*C,s[10]=(1-(g+m))*C,s[11]=0,s[12]=r._x,s[13]=r._y,s[14]=r._z,s[15]=1},i.scaling=function(t,e){var r=e.elements;r[0]=t._x,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t._y,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t._z,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},i.translation=function(t,e){var r=e.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=t._x,r[13]=t._y,r[14]=t._z,r[15]=1},i.invert=function(t,e){var r=t.elements,a=e.elements,s=r[0],l=r[1],c=r[2],u=r[3],h=r[4],d=r[5],f=r[6],_=r[7],g=r[8],v=r[9],p=r[10],m=r[11],y=r[12],x=r[13],S=r[14],w=r[15],b=s*d-l*h,A=s*f-c*h,E=s*_-u*h,C=l*f-c*d,M=l*_-u*d,P=c*_-u*f,R=g*x-v*y,B=g*S-p*y,D=g*w-m*y,L=v*S-p*x,N=v*w-m*x,W=p*w-m*S,I=b*W-A*N+E*L+C*D-M*B+P*R;if(!I)return null;I=1/I,a[0]=(d*W-f*N+_*L)*I,a[1]=(c*N-l*W-u*L)*I,a[2]=(x*P-S*M+w*C)*I,a[3]=(p*M-v*P-m*C)*I,a[4]=(f*D-h*W-_*B)*I,a[5]=(s*W-c*D+u*B)*I,a[6]=(S*E-y*P-w*A)*I,a[7]=(g*P-p*E+m*A)*I,a[8]=(h*N-d*D+_*R)*I,a[9]=(l*D-s*N-u*R)*I,a[10]=(y*M-x*E+w*b)*I,a[11]=(v*E-g*M-m*b)*I,a[12]=(d*B-h*L-f*R)*I,a[13]=(s*L-l*B+c*R)*I,a[14]=(x*A-y*C-S*b)*I,a[15]=(g*C-v*A+p*b)*I},i.lookAt=function(t,e,r,a){var s=a.elements,l=i._tempVec30,c=i._tempVec31,u=i._tempVec32;T.subtract(t,e,u),u.normalize(),T.cross(r,u,l),l.normalize(),T.cross(u,l,c),s[0]=l._x,s[1]=c._x,s[2]=u._x,s[3]=0,s[4]=l._y,s[5]=c._y,s[6]=u._y,s[7]=0,s[8]=l._z,s[9]=c._z,s[10]=u._z,s[11]=0,s[12]=-T.dot(l,t),s[13]=-T.dot(c,t),s[14]=-T.dot(u,t),s[15]=1},i.ortho=function(t,e,r,a,s,l,c){var u=c.elements,h=1/(t-e),d=1/(r-a),f=1/(s-l);u[0]=-2*h,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=-2*d,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=2*f,u[11]=0,u[12]=(t+e)*h,u[13]=(a+r)*d,u[14]=(l+s)*f,u[15]=1},i.perspective=function(t,e,r,a,s){var l=s.elements,c=1/Math.tan(t/2),u=1/(r-a);l[0]=c/e,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=c,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=(a+r)*u,l[11]=-1,l[12]=0,l[13]=0,l[14]=2*a*r*u,l[15]=0},i.rotateAxisAngle=function(t,e,r,a){var s=e._x,l=e._y,c=e._z,u=Math.sqrt(s*s+l*l+c*c);if(!(Math.abs(u)<H.zeroTolerance)){var h=t.elements,d=a.elements,f,_,g;u=1/u,s*=u,l*=u,c*=u,f=Math.sin(r),_=Math.cos(r),g=1-_;var v=h[0],p=h[1],m=h[2],y=h[3],x=h[4],S=h[5],w=h[6],b=h[7],A=h[8],E=h[9],C=h[10],M=h[11],P=s*s*g+_,R=l*s*g+c*f,B=c*s*g-l*f,D=s*l*g-c*f,L=l*l*g+_,N=c*l*g+s*f,W=s*c*g+l*f,I=l*c*g-s*f,V=c*c*g+_;d[0]=v*P+x*R+A*B,d[1]=p*P+S*R+E*B,d[2]=m*P+w*R+C*B,d[3]=y*P+b*R+M*B,d[4]=v*D+x*L+A*N,d[5]=p*D+S*L+E*N,d[6]=m*D+w*L+C*N,d[7]=y*D+b*L+M*N,d[8]=v*W+x*I+A*V,d[9]=p*W+S*I+E*V,d[10]=m*W+w*I+C*V,d[11]=y*W+b*I+M*V,t!==a&&(d[12]=h[12],d[13]=h[13],d[14]=h[14],d[15]=h[15])}},i.scale=function(t,e,r){var a=t.elements,s=r.elements,l=e._x,c=e._y,u=e._z;s[0]=a[0]*l,s[1]=a[1]*l,s[2]=a[2]*l,s[3]=a[3]*l,s[4]=a[4]*c,s[5]=a[5]*c,s[6]=a[6]*c,s[7]=a[7]*c,s[8]=a[8]*u,s[9]=a[9]*u,s[10]=a[10]*u,s[11]=a[11]*u,s[12]=a[12],s[13]=a[13],s[14]=a[14],s[15]=a[15]},i.translate=function(t,e,r){var a=t.elements,s=r.elements,l=e._x,c=e._y,u=e._z;if(t===r)s[12]=a[0]*l+a[4]*c+a[8]*u+a[12],s[13]=a[1]*l+a[5]*c+a[9]*u+a[13],s[14]=a[2]*l+a[6]*c+a[10]*u+a[14],s[15]=a[3]*l+a[7]*c+a[11]*u+a[15];else{var h=a[0],d=a[1],f=a[2],_=a[3],g=a[4],v=a[5],p=a[6],m=a[7],y=a[8],x=a[9],S=a[10],w=a[11];s[0]=h,s[1]=d,s[2]=f,s[3]=_,s[4]=g,s[5]=v,s[6]=p,s[7]=m,s[8]=y,s[9]=x,s[10]=S,s[11]=w,s[12]=h*l+g*c+y*u+a[12],s[13]=d*l+v*c+x*u+a[13],s[14]=f*l+p*c+S*u+a[14],s[15]=_*l+m*c+w*u+a[15]}},i.transpose=function(t,e){var r=t.elements,a=e.elements;if(e===t){var s=r[1],l=r[2],c=r[3],u=r[6],h=r[7],d=r[11];a[1]=r[4],a[2]=r[8],a[3]=r[12],a[4]=s,a[6]=r[9],a[7]=r[13],a[8]=l,a[9]=u,a[11]=r[14],a[12]=c,a[13]=h,a[14]=d}else a[0]=r[0],a[1]=r[4],a[2]=r[8],a[3]=r[12],a[4]=r[1],a[5]=r[5],a[6]=r[9],a[7]=r[13],a[8]=r[2],a[9]=r[6],a[10]=r[10],a[11]=r[14],a[12]=r[3],a[13]=r[7],a[14]=r[11],a[15]=r[15]};function i(n,t,e,r,a,s,l,c,u,h,d,f,_,g,v,p){n===void 0&&(n=1),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),a===void 0&&(a=0),s===void 0&&(s=1),l===void 0&&(l=0),c===void 0&&(c=0),u===void 0&&(u=0),h===void 0&&(h=0),d===void 0&&(d=1),f===void 0&&(f=0),_===void 0&&(_=0),g===void 0&&(g=0),v===void 0&&(v=0),p===void 0&&(p=1),this.elements=new Float32Array(16);var m=this.elements;m[0]=n,m[1]=t,m[2]=e,m[3]=r,m[4]=a,m[5]=s,m[6]=l,m[7]=c,m[8]=u,m[9]=h,m[10]=d,m[11]=f,m[12]=_,m[13]=g,m[14]=v,m[15]=p}var o=i.prototype;return o.set=function(t,e,r,a,s,l,c,u,h,d,f,_,g,v,p,m){var y=this.elements;return y[0]=t,y[1]=e,y[2]=r,y[3]=a,y[4]=s,y[5]=l,y[6]=c,y[7]=u,y[8]=h,y[9]=d,y[10]=f,y[11]=_,y[12]=g,y[13]=v,y[14]=p,y[15]=m,this},o.multiply=function(t){return i.multiply(this,t,this),this},o.determinant=function(){var t=this.elements,e=t[0],r=t[1],a=t[2],s=t[3],l=t[4],c=t[5],u=t[6],h=t[7],d=t[8],f=t[9],_=t[10],g=t[11],v=t[12],p=t[13],m=t[14],y=t[15],x=e*c-r*l,S=e*u-a*l,w=e*h-s*l,b=r*u-a*c,A=r*h-s*c,E=a*h-s*u,C=d*p-f*v,M=d*m-_*v,P=d*y-g*v,R=f*m-_*p,B=f*y-g*p,D=_*y-g*m;return x*D-S*B+w*R+b*P-A*M+E*C},o.decompose=function(t,e,r){var a=i._tempMat30,s=this.elements,l=a.elements,c=s[0],u=s[1],h=s[2],d=s[3],f=s[4],_=s[5],g=s[6],v=s[7],p=s[8],m=s[9],y=s[10],x=s[11];t.set(s[12],s[13],s[14]);var S=Math.sign(c*u*h*d)<0?-1:1,w=Math.sign(f*_*g*v)<0?-1:1,b=Math.sign(p*m*y*x)<0?-1:1,A=S*Math.sqrt(c*c+u*u+h*h),E=w*Math.sqrt(f*f+_*_+g*g),C=b*Math.sqrt(p*p+m*m+y*y);if(r.set(A,E,C),Math.abs(A)<H.zeroTolerance||Math.abs(E)<H.zeroTolerance||Math.abs(C)<H.zeroTolerance)return e.identity(),!1;var M=1/A,P=1/E,R=1/C;return l[0]=c*M,l[1]=u*M,l[2]=h*M,l[3]=f*P,l[4]=_*P,l[5]=g*P,l[6]=p*R,l[7]=m*R,l[8]=y*R,De.rotationMatrix3x3(a,e),!0},o.getRotation=function(t){var e=this.elements,r=e[0]+e[5]+e[10];if(r>H.zeroTolerance){var a=Math.sqrt(r+1)*2;t._w=.25*a,t._x=(e[6]-e[9])/a,t._y=(e[8]-e[2])/a,t._z=(e[1]-e[4])/a}else if(e[0]>e[5]&&e[0]>e[10]){var s=Math.sqrt(1+e[0]-e[5]-e[10])*2;t._w=(e[6]-e[9])/s,t._x=.25*s,t._y=(e[1]+e[4])/s,t._z=(e[8]+e[2])/s}else if(e[5]>e[10]){var l=Math.sqrt(1+e[5]-e[0]-e[10])*2;t._w=(e[8]-e[2])/l,t._x=(e[1]+e[4])/l,t._y=.25*l,t._z=(e[6]+e[9])/l}else{var c=Math.sqrt(1+e[10]-e[0]-e[5])*2;t._w=(e[1]-e[4])/c,t._x=(e[8]+e[2])/c,t._y=(e[6]+e[9])/c,t._z=.25*c}return t._onValueChanged&&t._onValueChanged(),t},o.getScaling=function(t){var e=this.elements,r=e[0],a=e[1],s=e[2],l=e[4],c=e[5],u=e[6],h=e[8],d=e[9],f=e[10];return t.set(Math.sqrt(r*r+a*a+s*s),Math.sqrt(l*l+c*c+u*u),Math.sqrt(h*h+d*d+f*f)),t},o.getTranslation=function(t){var e=this.elements;return t.set(e[12],e[13],e[14]),t},o.identity=function(){var t=this.elements;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},o.invert=function(){return i.invert(this,this),this},o.rotateAxisAngle=function(t,e){return i.rotateAxisAngle(this,t,e,this),this},o.scale=function(t){return i.scale(this,t,this),this},o.translate=function(t){return i.translate(this,t,this),this},o.transpose=function(){return i.transpose(this,this),this},o.clone=function(){var t=this.elements,e=new i(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]);return e},o.copyFrom=function(t){var e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],this},o.copyFromArray=function(t,e){e===void 0&&(e=0);for(var r=this.elements,a=0;a<16;a++)r[a]=t[a+e];return this},o.copyToArray=function(t,e){e===void 0&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t[e+9]=r[9],t[e+10]=r[10],t[e+11]=r[11],t[e+12]=r[12],t[e+13]=r[13],t[e+14]=r[14],t[e+15]=r[15]},i}();ce._tempVec30=new T;ce._tempVec31=new T;ce._tempVec32=new T;ce._tempMat30=new Gi;ce._identity=new ce(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);var xd=function(){function i(n,t){n===void 0&&(n=null),t===void 0&&(t=null),this.origin=new T,this.direction=new T,n&&this.origin.copyFrom(n),t&&this.direction.copyFrom(t)}var o=i.prototype;return o.intersectPlane=function(t){return Ei.intersectsRayAndPlane(this,t)},o.intersectSphere=function(t){return Ei.intersectsRayAndSphere(this,t)},o.intersectBox=function(t){return Ei.intersectsRayAndBox(this,t)},o.getPoint=function(t,e){return T.scale(this.direction,t,e),e.add(this.origin)},i}(),q=function(){i.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._onValueChanged&&r._onValueChanged()},i.subtract=function(t,e,r){r._x=t._x-e._x,r._y=t._y-e._y,r._onValueChanged&&r._onValueChanged()},i.multiply=function(t,e,r){r._x=t._x*e._x,r._y=t._y*e._y,r._onValueChanged&&r._onValueChanged()},i.divide=function(t,e,r){r._x=t._x/e._x,r._y=t._y/e._y,r._onValueChanged&&r._onValueChanged()},i.dot=function(t,e){return t._x*e._x+t._y*e._y},i.distance=function(t,e){var r=e._x-t._x,a=e._y-t._y;return Math.sqrt(r*r+a*a)},i.distanceSquared=function(t,e){var r=e._x-t._x,a=e._y-t._y;return r*r+a*a},i.equals=function(t,e){return H.equals(t._x,e._x)&&H.equals(t._y,e._y)},i.lerp=function(t,e,r,a){var s=t._x,l=t._y;a._x=s+(e._x-s)*r,a._y=l+(e._y-l)*r,a._onValueChanged&&a._onValueChanged()},i.max=function(t,e,r){r._x=Math.max(t._x,e._x),r._y=Math.max(t._y,e._y),r._onValueChanged&&r._onValueChanged()},i.min=function(t,e,r){r._x=Math.min(t._x,e._x),r._y=Math.min(t._y,e._y),r._onValueChanged&&r._onValueChanged()},i.negate=function(t,e){e._x=-t._x,e._y=-t._y,e._onValueChanged&&e._onValueChanged()},i.normalize=function(t,e){var r=t._x,a=t._y,s=Math.sqrt(r*r+a*a);s>H.zeroTolerance&&(s=1/s,e._x=r*s,e._y=a*s,e._onValueChanged&&e._onValueChanged())},i.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._onValueChanged&&r._onValueChanged()};function i(n,t){n===void 0&&(n=0),t===void 0&&(t=0),this._x=void 0,this._y=void 0,this._onValueChanged=null,this._x=n,this._y=t}var o=i.prototype;return o.set=function(t,e){return this._x=t,this._y=e,this._onValueChanged&&this._onValueChanged(),this},o.add=function(t){return this._x+=t._x,this._y+=t._y,this._onValueChanged&&this._onValueChanged(),this},o.subtract=function(t){return this._x-=t._x,this._y-=t._y,this._onValueChanged&&this._onValueChanged(),this},o.multiply=function(t){return this._x*=t._x,this._y*=t._y,this._onValueChanged&&this._onValueChanged(),this},o.divide=function(t){return this._x/=t._x,this._y/=t._y,this._onValueChanged&&this._onValueChanged(),this},o.length=function(){var t=this._x,e=this._y;return Math.sqrt(t*t+e*e)},o.lengthSquared=function(){var t=this._x,e=this._y;return t*t+e*e},o.negate=function(){return this._x=-this._x,this._y=-this._y,this._onValueChanged&&this._onValueChanged(),this},o.normalize=function(){return i.normalize(this,this),this},o.scale=function(t){return this._x*=t,this._y*=t,this._onValueChanged&&this._onValueChanged(),this},o.clone=function(){return new i(this._x,this._y)},o.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._onValueChanged&&this._onValueChanged(),this},o.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._onValueChanged&&this._onValueChanged(),this},o.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y},va(i,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}}]),i}();q._zero=new q(0,0);q._one=new q(1,1);var Ve=function(){i.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._z=t._z+e._z,r._w=t._w+e._w,r._onValueChanged&&r._onValueChanged()},i.subtract=function(t,e,r){r._x=t._x-e._x,r._y=t._y-e._y,r._z=t._z-e._z,r._w=t._w-e._w,r._onValueChanged&&r._onValueChanged()},i.multiply=function(t,e,r){r._x=t._x*e._x,r._y=t._y*e._y,r._z=t._z*e._z,r._w=t._w*e._w,r._onValueChanged&&r._onValueChanged()},i.divide=function(t,e,r){r._x=t._x/e._x,r._y=t._y/e._y,r._z=t._z/e._z,r._w=t._w/e._w,r._onValueChanged&&r._onValueChanged()},i.dot=function(t,e){return t._x*e._x+t._y*e._y+t._z*e._z+t._w*e._w},i.distance=function(t,e){var r=e._x-t._x,a=e._y-t._y,s=e._z-t._z,l=e._w-t._w;return Math.sqrt(r*r+a*a+s*s+l*l)},i.distanceSquared=function(t,e){var r=e._x-t._x,a=e._y-t._y,s=e._z-t._z,l=e._w-t._w;return r*r+a*a+s*s+l*l},i.equals=function(t,e){return H.equals(t._x,e._x)&&H.equals(t._y,e._y)&&H.equals(t._z,e._z)&&H.equals(t._w,e._w)},i.lerp=function(t,e,r,a){var s=t._x,l=t._y,c=t._z,u=t._w;a._x=s+(e._x-s)*r,a._y=l+(e._y-l)*r,a._z=c+(e._z-c)*r,a._w=u+(e._w-u)*r,a._onValueChanged&&a._onValueChanged()},i.max=function(t,e,r){r._x=Math.max(t._x,e._x),r._y=Math.max(t._y,e._y),r._z=Math.max(t._z,e._z),r._w=Math.max(t._w,e._w),r._onValueChanged&&r._onValueChanged()},i.min=function(t,e,r){r._x=Math.min(t._x,e._x),r._y=Math.min(t._y,e._y),r._z=Math.min(t._z,e._z),r._w=Math.min(t._w,e._w),r._onValueChanged&&r._onValueChanged()},i.negate=function(t,e){e._x=-t._x,e._y=-t._y,e._z=-t._z,e._w=-t._w,e._onValueChanged&&e._onValueChanged()},i.normalize=function(t,e){var r=t._x,a=t._y,s=t._z,l=t._w,c=Math.sqrt(r*r+a*a+s*s+l*l);c>H.zeroTolerance&&(c=1/c,e._x=r*c,e._y=a*c,e._z=s*c,e._w=l*c,e._onValueChanged&&e._onValueChanged())},i.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._z=t._z*e,r._w=t._w*e,r._onValueChanged&&r._onValueChanged()},i.transform=function(t,e,r){var a=t._x,s=t._y,l=t._z,c=t._w,u=e.elements;r._x=a*u[0]+s*u[4]+l*u[8]+c*u[12],r._y=a*u[1]+s*u[5]+l*u[9]+c*u[13],r._z=a*u[2]+s*u[6]+l*u[10]+c*u[14],r._w=a*u[3]+s*u[7]+l*u[11]+c*u[15],r._onValueChanged&&r._onValueChanged()},i.transformByQuat=function(t,e,r){var a=t._x,s=t._y,l=t._z,c=t._w,u=e._x,h=e._y,d=e._z,f=e._w,_=f*a+h*l-d*s,g=f*s+d*a-u*l,v=f*l+u*s-h*a,p=-u*a-h*s-d*l;r._x=_*f-p*u-g*d+v*h,r._y=g*f-p*h-v*u+_*d,r._z=v*f-p*d-_*h+g*u,r._w=c,r._onValueChanged&&r._onValueChanged()};function i(n,t,e,r){n===void 0&&(n=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),this._x=void 0,this._y=void 0,this._z=void 0,this._w=void 0,this._onValueChanged=null,this._x=n,this._y=t,this._z=e,this._w=r}var o=i.prototype;return o.set=function(t,e,r,a){return this._x=t,this._y=e,this._z=r,this._w=a,this._onValueChanged&&this._onValueChanged(),this},o.add=function(t){return this._x+=t._x,this._y+=t._y,this._z+=t._z,this._w+=t._w,this._onValueChanged&&this._onValueChanged(),this},o.subtract=function(t){return this._x-=t._x,this._y-=t._y,this._z-=t._z,this._w-=t._w,this._onValueChanged&&this._onValueChanged(),this},o.multiply=function(t){return this._x*=t._x,this._y*=t._y,this._z*=t._z,this._w*=t._w,this._onValueChanged&&this._onValueChanged(),this},o.divide=function(t){return this._x/=t._x,this._y/=t._y,this._z/=t._z,this._w/=t._w,this._onValueChanged&&this._onValueChanged(),this},o.length=function(){var t=this._x,e=this._y,r=this._z,a=this._w;return Math.sqrt(t*t+e*e+r*r+a*a)},o.lengthSquared=function(){var t=this._x,e=this._y,r=this._z,a=this._w;return t*t+e*e+r*r+a*a},o.negate=function(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._w=-this._w,this._onValueChanged&&this._onValueChanged(),this},o.normalize=function(){return i.normalize(this,this),this},o.scale=function(t){return this._x*=t,this._y*=t,this._z*=t,this._w*=t,this._onValueChanged&&this._onValueChanged(),this},o.clone=function(){var t=new i(this._x,this._y,this._z,this._w);return t},o.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onValueChanged&&this._onValueChanged(),this},o.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onValueChanged&&this._onValueChanged(),this},o.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w},va(i,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onValueChanged&&this._onValueChanged()}},{key:"w",get:function(){return this._w},set:function(t){this._w=t,this._onValueChanged&&this._onValueChanged()}}]),i}();Ve._zero=new Ve(0,0,0,0);Ve._one=new Ve(1,1,1,1);var oe=function(){i.gammaToLinearSpace=function(t){return t<=0?0:t<=.04045?t/12.92:t<1?Math.pow((t+.055)/1.055,2.4):Math.pow(t,2.4)},i.linearToGammaSpace=function(t){return t<=0?0:t<.0031308?12.92*t:t<1?1.055*Math.pow(t,.41666)-.055:Math.pow(t,.41666)},i.equals=function(t,e){return H.equals(t.r,e.r)&&H.equals(t.g,e.g)&&H.equals(t.b,e.b)&&H.equals(t.a,e.a)},i.add=function(t,e,r){return r.r=t.r+e.r,r.g=t.g+e.g,r.b=t.b+e.b,r.a=t.a+e.a,r},i.scale=function(t,e,r){return r.r=t.r*e,r.g=t.g*e,r.b=t.b*e,r.a=t.a*e,r};function i(n,t,e,r){n===void 0&&(n=1),t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0,this.r=n,this.g=t,this.b=e,this.a=r}var o=i.prototype;return o.set=function(t,e,r,a){return this.r=t,this.g=e,this.b=r,this.a=a,this},o.add=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},o.scale=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},o.clone=function(){var t=new i(this.r,this.g,this.b,this.a);return t},o.copyFrom=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},o.toLinear=function(t){return t.r=i.gammaToLinearSpace(this.r),t.g=i.gammaToLinearSpace(this.g),t.b=i.gammaToLinearSpace(this.b),t},o.toGamma=function(t){return t.r=i.linearToGammaSpace(this.r),t.g=i.linearToGammaSpace(this.g),t.b=i.linearToGammaSpace(this.b),t},i}(),Na=function(){function i(n,t,e,r){n===void 0&&(n=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),this.x=void 0,this.y=void 0,this.width=void 0,this.height=void 0,this.x=n,this.y=t,this.width=e,this.height=r}var o=i.prototype;return o.set=function(t,e,r,a){return this.x=t,this.y=e,this.width=r,this.height=a,this},o.clone=function(){return new i(this.x,this.y,this.width,this.height)},o.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this},i}(),bd=function(){function i(){this.coefficients=new Float32Array(27)}var o=i.prototype;return o.addLight=function(t,e,r){e.scale(r);var a=this.coefficients,s=t._x,l=t._y,c=t._z,u=e.r,h=e.g,d=e.b,f=.282095,_=-.488603*l,g=.488603*c,v=-.488603*s,p=1.092548*(s*l),m=-1.092548*(l*c),y=.315392*(3*c*c-1),x=-1.092548*(s*c),S=.546274*(s*s-l*l);a[0]+=u*f,a[1]+=h*f,a[2]+=d*f,a[3]+=u*_,a[4]+=h*_,a[5]+=d*_,a[6]+=u*g,a[7]+=h*g,a[8]+=d*g,a[9]+=u*v,a[10]+=h*v,a[11]+=d*v,a[12]+=u*p,a[13]+=h*p,a[14]+=d*p,a[15]+=u*m,a[16]+=h*m,a[17]+=d*m,a[18]+=u*y,a[19]+=h*y,a[20]+=d*y,a[21]+=u*x,a[22]+=h*x,a[23]+=d*x,a[24]+=u*S,a[25]+=h*S,a[26]+=d*S},o.evaluate=function(t,e){var r=this.coefficients,a=t._x,s=t._y,l=t._z,c=.886227,u=-1.023327*s,h=1.023327*l,d=-1.023327*a,f=.858086*s*a,_=-.858086*s*l,g=.247708*(3*l*l-1),v=-.858086*l*a,p=.429042*(a*a-s*s),m=r[0]*c,y=r[1]*c,x=r[2]*c;return m+=r[3]*u+r[6]*h+r[9]*d,y+=r[4]*u+r[7]*h+r[10]*d,x+=r[5]*u+r[8]*h+r[11]*d,m+=r[12]*f+r[15]*_+r[18]*g+r[21]*v+r[24]*p,y+=r[13]*f+r[16]*_+r[19]*g+r[22]*v+r[25]*p,x+=r[14]*f+r[17]*_+r[20]*g+r[23]*v+r[26]*p,e.set(m,y,x,1),e},o.scale=function(t){var e=this.coefficients;e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e[4]*=t,e[5]*=t,e[6]*=t,e[7]*=t,e[8]*=t,e[9]*=t,e[10]*=t,e[11]*=t,e[12]*=t,e[13]*=t,e[14]*=t,e[15]*=t,e[16]*=t,e[17]*=t,e[18]*=t,e[19]*=t,e[20]*=t,e[21]*=t,e[22]*=t,e[23]*=t,e[24]*=t,e[25]*=t,e[26]*=t},o.clone=function(){var t=new i;return t.copyFrom(this),t},o.copyFrom=function(t){return t.copyToArray(this.coefficients),this},o.copyFromArray=function(t,e){e===void 0&&(e=0);var r=this.coefficients;r[0]=t[e],r[1]=t[1+e],r[2]=t[2+e],r[3]=t[3+e],r[4]=t[4+e],r[5]=t[5+e],r[6]=t[6+e],r[7]=t[7+e],r[8]=t[8+e],r[9]=t[9+e],r[10]=t[10+e],r[11]=t[11+e],r[12]=t[12+e],r[13]=t[13+e],r[14]=t[14+e],r[15]=t[15+e],r[16]=t[16+e],r[17]=t[17+e],r[18]=t[18+e],r[19]=t[19+e],r[20]=t[20+e],r[21]=t[21+e],r[22]=t[22+e],r[23]=t[23+e],r[24]=t[24+e],r[25]=t[25+e],r[26]=t[26+e]},o.copyToArray=function(t,e){e===void 0&&(e=0);var r=this.coefficients;t[0+e]=r[0],t[1+e]=r[1],t[2+e]=r[2],t[3+e]=r[3],t[4+e]=r[4],t[5+e]=r[5],t[6+e]=r[6],t[7+e]=r[7],t[8+e]=r[8],t[9+e]=r[9],t[10+e]=r[10],t[11+e]=r[11],t[12+e]=r[12],t[13+e]=r[13],t[14+e]=r[14],t[15+e]=r[15],t[16+e]=r[16],t[17+e]=r[17],t[18+e]=r[18],t[19+e]=r[19],t[20+e]=r[20],t[21+e]=r[21],t[22+e]=r[22],t[23+e]=r[23],t[24+e]=r[24],t[25+e]=r[25],t[26+e]=r[26]},i}();function zo(i,o){var n=Object.keys(i);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(i);o&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})),n.push.apply(n,t)}return n}function Oo(i){for(var o=1;o<arguments.length;o++){var n=arguments[o]!=null?arguments[o]:{};o%2?zo(Object(n),!0).forEach(function(t){wd(i,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(n)):zo(Object(n)).forEach(function(t){Object.defineProperty(i,t,Object.getOwnPropertyDescriptor(n,t))})}return i}function Io(i,o){for(var n=0;n<o.length;n++){var t=o[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(i,t.key,t)}}function te(i,o,n){return o&&Io(i.prototype,o),n&&Io(i,n),Object.defineProperty(i,"prototype",{writable:!1}),i}function wd(i,o,n){return o in i?Object.defineProperty(i,o,{value:n,enumerable:!0,configurable:!0,writable:!0}):i[o]=n,i}function Cn(){return Cn=Object.assign?Object.assign.bind():function(i){for(var o=1;o<arguments.length;o++){var n=arguments[o];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(i[t]=n[t])}return i},Cn.apply(this,arguments)}function J(i,o){i.prototype=Object.create(o.prototype),i.prototype.constructor=i,Tn(i,o)}function Ua(i){return Ua=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(n){return n.__proto__||Object.getPrototypeOf(n)},Ua(i)}function Tn(i,o){return Tn=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Tn(i,o)}function Sd(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Jn(i,o,n){return Sd()?Jn=Reflect.construct.bind():Jn=function(e,r,a){var s=[null];s.push.apply(s,r);var l=Function.bind.apply(e,s),c=new l;return a&&Tn(c,a.prototype),c},Jn.apply(null,arguments)}function Cd(i){return Function.toString.call(i).indexOf("[native code]")!==-1}function ka(i){var o=typeof Map=="function"?new Map:void 0;return ka=function(t){if(t===null||!Cd(t))return t;if(typeof t!="function")throw new TypeError("Super expression must either be null or a function");if(typeof o!="undefined"){if(o.has(t))return o.get(t);o.set(t,e)}function e(){return Jn(t,arguments,Ua(this).constructor)}return e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),Tn(e,t)},ka(i)}function z(i){if(i===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return i}function Td(i,o){if(!!i){if(typeof i=="string")return No(i,o);var n=Object.prototype.toString.call(i).slice(8,-1);if(n==="Object"&&i.constructor&&(n=i.constructor.name),n==="Map"||n==="Set")return Array.from(i);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return No(i,o)}}function No(i,o){(o==null||o>i.length)&&(o=i.length);for(var n=0,t=new Array(o);n<o;n++)t[n]=i[n];return t}function Ad(i,o){var n=typeof Symbol!="undefined"&&i[Symbol.iterator]||i["@@iterator"];if(n)return(n=n.call(i)).next.bind(n);if(Array.isArray(i)||(n=Td(i))||o&&i&&typeof i.length=="number"){n&&(i=n);var t=0;return function(){return t>=i.length?{done:!0}:{done:!1,value:i[t++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function U(i,o,n,t){!n||Object.defineProperty(i,o,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(t):void 0})}function k(i,o,n,t,e){var r={};return Object.keys(t).forEach(function(a){r[a]=t[a]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=n.slice().reverse().reduce(function(a,s){return s(i,o,a)||a},r),e&&r.initializer!==void 0&&(r.value=r.initializer?r.initializer.call(e):void 0,r.initializer=void 0),r.initializer===void 0&&(Object.defineProperty(i,o,r),r=null),r}var Zn={isArray:"isArray"in Array?Array.isArray:function(i){return toString.call(i)==="[object Array]"},isArrayLike:function(o){return!!o&&typeof o.length=="number"&&typeof o!="function"},clone:function(o){if(typeof o!="object"||o===null)return o;var n;if(Zn.isArrayLike(o)){n=o.slice();for(var t=0,e=o.length;t<e;t++)n[t]=Zn.clone(o[t])}else{n={};for(var r in o)o.hasOwnProperty(r)&&(n[r]=Zn.clone(o[r]))}return n},downloadBlob:function(o,n){n===void 0&&(n="");var t=window.URL.createObjectURL(o),e=document.createElement("a");document.body.appendChild(e),e.style.display="none",e.href=t,e.download=n,e.addEventListener("click",function(){e.parentElement&&e.parentElement.removeChild(e)}),e.click(),window.URL.revokeObjectURL(t)}};function Pd(i,o){var n=i.indexOf(o);if(n<0)return!1;var t=i.length-1;if(n!==t){var e=i[t];i[n]=e}return i.length--,!0}function Va(i){return Object.keys(i).map(function(o){return i[o]})}var Md=function(){function i(){}return i._reflectGet=function(n,t){for(var e=this._stringToPath(t),r=n,a=0,s=e.length;r!=null&&a<s;)r=r[e[a++]];return a&&a==s?r:void 0},i._stringToPath=function(n){var t=[];return n.charCodeAt(0)===Ed&&t.push(""),n.replace(Fd,function(e,r,a,s){var l=e;a?l=s.replace(Rd,"$1"):r&&(l=r.trim()),t.push(l)}),t},i}(),Ed=".".charCodeAt(0),Rd=/\\(\\)?/g,Fd=RegExp(`[^.[\\]]+|\\[(?:([^"'][^[]*)|(["'])((?:(?!\\2)[^\\\\]|\\\\.)*?)\\2)\\]|(?=(?:\\.|\\[\\])(?:\\.|\\[\\]|$))`,"g"),Ci;(function(i){i[i.Success=0]="Success",i[i.Pending=1]="Pending",i[i.Failed=2]="Failed"})(Ci||(Ci={}));var ot=function(i){J(n,i),n.all=function(e){return new n(function(r,a,s){if(!Array.isArray(e))return r([e]);var l=0,c=e.length,u=new Array(c);e.forEach(function(h,d){Promise.resolve(h).then(function(f){u[d]=f,l+=1,s(l/c),l==c&&r(u)}).catch(function(f){return a(f)})})})};var o=n.prototype;o.onProgress=function(e){return this._listeners.add(e),this},o.cancel=function(){return this._status!==Ci.Pending?this:(this._reject("Promise Canceled"),this)};function n(t){var e,r,a=function(l){if(!(l<=e._progress)){e._progress=l;for(var c=Ad(e._listeners),u;!(u=c()).done;){var h=u.value;h(l)}}};return e=i.call(this,function(s,l){r=function(u){Promise.resolve().then(function(){e._status=Ci.Failed,l(u)})},t(function(c){Promise.resolve().then(function(){a(1),e._status=Ci.Success,s(c)})},r,function(c){Promise.resolve().then(function(){a(c)})})})||this,e._status=void 0,e._progress=void 0,e._reject=void 0,e._listeners=void 0,e._reject=r,e._listeners=new Set,e._progress=0,e._status=Ci.Pending,e}return te(n,[{key:"status",get:function(){return this._status}},{key:"progress",get:function(){return this._progress}}]),n}(ka(Promise)),On=function(){i._addLoader=function(t,e,r){this._loaders[t]=e;for(var a=0,s=r.length;a<s;a++)this._extTypeMapping[r[a]]=t},i._getTypeByUrl=function(t){var e=t.split("?")[0];return this._extTypeMapping[e.substring(e.lastIndexOf(".")+1)]};function i(n){this.engine=n,this.retryCount=1,this.retryInterval=0,this.timeout=2e4,this._objectPool=Object.create(null),this._editorResourceConfig=Object.create(null),this._virtualPathMap=Object.create(null),this._assetPool=Object.create(null),this._assetUrlPool=Object.create(null),this._refObjectPool=Object.create(null),this._loadingPromises={}}var o=i.prototype;return o.load=function(t){var e=this;if(!Array.isArray(t))return this._loadSingleItem(t);var r=t.map(function(a){return e._loadSingleItem(a)});return ot.all(r)},o.cancelNotLoaded=function(t){var e=this;if(!t)Va(this._loadingPromises).forEach(function(a){a.cancel()});else if(typeof t=="string"){var r;(r=this._loadingPromises[t])===null||r===void 0||r.cancel()}else t.forEach(function(a){var s;(s=e._loadingPromises[a])===null||s===void 0||s.cancel()})},o.gc=function(){this._gc(!1)},o.getAssetPath=function(t){return this._assetPool[t]},o.getResourceByRef=function(t){var e=t.refId,r=t.key,a=t.isClone,s=this._objectPool[e],l=s?Promise.resolve(s):this.load({type:this._editorResourceConfig[e].type,url:this._editorResourceConfig[e].path});return l.then(function(c){return r?Md._reflectGet(c,r):c}).then(function(c){return a?c.clone():c})},o.initVirtualResources=function(t){var e=this;t.forEach(function(r){e._virtualPathMap[r.virtualPath]=r.path,e._editorResourceConfig[r.id]=r})},o._addAsset=function(t,e){this._assetPool[e.instanceId]=t,this._assetUrlPool[t]=e},o._deleteAsset=function(t){var e=t.instanceId,r=this._assetPool[e];r&&(delete this._assetPool[e],delete this._assetUrlPool[r])},o._addRefObject=function(t,e){this._refObjectPool[t]=e},o._deleteRefObject=function(t){delete this._refObjectPool[t]},o._destroy=function(){this.cancelNotLoaded(),this._gc(!0),this._assetPool=null,this._assetUrlPool=null,this._refObjectPool=null,this._loadingPromises=null},o._assignDefaultOptions=function(t){var e,r,a,s,l;if(t.type=(e=t.type)!=null?e:i._getTypeByUrl(t.url),t.type===void 0)throw"asset type should be specified: "+t.url;return t.retryCount=(r=t.retryCount)!=null?r:this.retryCount,t.timeout=(a=t.timeout)!=null?a:this.timeout,t.retryInterval=(s=t.retryInterval)!=null?s:this.retryInterval,t.url=(l=t.url)!=null?l:t.urls.join(","),t},o._loadSingleItem=function(t){var e=this,r=this._assignDefaultOptions(typeof t=="string"?{url:t}:t),a=r.url,s=this._virtualPathMap[a]?this._virtualPathMap[a]:a;if(this._assetUrlPool[s])return new ot(function(u){u(e._assetUrlPool[s])});if(this._loadingPromises[s])return this._loadingPromises[r.url];var l=i._loaders[r.type];if(!l)throw"loader not found: "+r.type;r.url=s;var c=l.load(r,this);return this._loadingPromises[s]=c,c.then(function(u){l.useCache&&e._addAsset(s,u),e._loadingPromises&&delete e._loadingPromises[s]}).catch(function(u){Promise.reject(u),e._loadingPromises&&delete e._loadingPromises[s]}),c},o._gc=function(t){for(var e=Va(this._refObjectPool),r=0,a=e.length;r<a;r++)(!e[r].isGCIgnored||t)&&e[r].destroy()},i}();On._loaders={};On._extTypeMapping={};function Tt(i,o,n){return n===void 0&&(n=!0),function(t){var e=new t(n);On._addLoader(i,e,o)}}var Ga=function(){function i(n,t,e,r){t===void 0&&(t=null),e===void 0&&(e={}),r===void 0&&(r=!0),this.data=void 0,this._timeStamp=void 0,this._target=void 0,this._currentTarget=void 0,this._bubbles=void 0,this._propagationStopped=void 0,this._type=void 0,this._timeStamp=new Date().getTime(),this._target=t,this.data=e,this._currentTarget=null,this._bubbles=r,this._propagationStopped=!1,this._type=n}var o=i.prototype;return o.stopPropagation=function(){this._propagationStopped=!0},te(i,[{key:"propagationStopped",get:function(){return this._propagationStopped}},{key:"target",get:function(){return this._target},set:function(t){this._target=t}},{key:"timeStamp",get:function(){return this._timeStamp}},{key:"currentTarget",get:function(){return this._currentTarget},set:function(t){this._currentTarget=t}},{key:"bubbles",get:function(){return this._bubbles}},{key:"type",get:function(){return this._type}}]),i}(),Or;(function(i){i[i.Ignore=0]="Ignore",i[i.Assignment=1]="Assignment",i[i.Shallow=2]="Shallow",i[i.Deep=3]="Deep"})(Or||(Or={}));function re(i,o){nr.registerCloneMode(i,o,Or.Ignore)}function qe(i,o){nr.registerCloneMode(i,o,Or.Assignment)}function ch(i,o){nr.registerCloneMode(i,o,Or.Shallow)}function tt(i,o){nr.registerCloneMode(i,o,Or.Deep)}var nr=function(){function i(){}return i.registerCloneMode=function(n,t,e){var r=i._subCloneModeMap.get(n.constructor);r||(r=Object.create(null),i._subCloneModeMap.set(n.constructor,r)),r[t]=e},i.getCloneMode=function(n){var t=i._cloneModeMap.get(n);if(!t){t=Object.create(null),i._cloneModeMap.set(n,t);for(var e=i._objectType,r=i._subCloneModeMap;n!==e;){var a=r.get(n);a&&Cn(t,a),n=Object.getPrototypeOf(n)}}return t},i.deepCloneObject=function(n,t){var e=n.constructor;switch(e){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:t.set(n);break;case Array:for(var r=0,a=n.length;r<a;r++)i._deepCloneObjectItem(n,t,r);break;default:var s=n;if(s.clone&&s.cloneTo)s.cloneTo(t);else for(var l=Object.keys(n),c=0,u=l.length;c<u;c++)i._deepCloneObjectItem(n,t,l[c])}},i._deepCloneObjectItem=function(n,t,e){var r=n[e];if(r instanceof Object){var a=r.constructor;switch(a){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:var s=r,l=t[e];l==null?t[e]=s.slice():l.set(s);break;case Array:var c=r,u=t[e];u==null?t[e]=new Array(c.length):u.length=c.length,i.deepCloneObject(c,u);break;default:if(r.clone&&r.cloneTo){var h=r,d=t[e];d?h.cloneTo(d):t[e]=h.clone()}else{var f=t[e];f==null&&(t[e]=f=new r.constructor),i.deepCloneObject(r,f);break}}}else t[e]=r},i}();nr._subCloneModeMap=new Map;nr._cloneModeMap=new Map;nr._objectType=Object.getPrototypeOf(Object);var Aa,Uo,uh=(Aa=function(){function i(){U(this,"_evts",Uo,this),this._evtCount=0}var o=i.prototype;return o.hasEvent=function(t){return this._evts[t]!=null},o.eventNames=function(){return this._evtCount===0?[]:Object.keys(this._evts)},o.listenerCount=function(t){var e=this._evts[t];return e?e.fn?1:e.length:0},o.dispatch=function(t,e){if(!this._evts[t])return!1;var r=this._evts[t];if(r.fn)r.once&&this.removeEventListener(t,r.fn),r.fn(e);else for(var a=r.length,s=0;s<a;s++)r[s].once&&this.removeEventListener(t,r[s].fn),r[s].fn(e);return!0},o.on=function(t,e){return this.addEventListener(t,e)},o.once=function(t,e){return this.addEventListener(t,e,!0)},o.addEventListener=function(t,e,r){var a={fn:e,once:r},s=this._evts;return s[t]?s[t].fn?s[t]=[s[t],a]:s[t].push(a):(s[t]=a,this._evtCount++),this},o.off=function(t,e){if(!this._evts[t])return this;if(!e)return this._clearEvent(t),this;var r=this._evts[t];if(r.fn&&r.fn===e)this._clearEvent(t);else{var a=r.indexOf(e);if(a>-1){var s=r[r.length-1];r[a]=s,r.length--,r.length===1&&(this._evts[t]=r[0])}}return this},o.removeEventListener=function(t,e){return this.off(t,e)},o.removeAllEventListeners=function(t){t?this._evts[t]&&this._clearEvent(t):(this._evts=Object.create(null),this._evtCount=0)},o.trigger=function(t){this.dispatch(t.type,t.data)},o._clearEvent=function(t){--this._evtCount===0?this._evts=Object.create(null):delete this._evts[t]},i}(),Uo=k(Aa.prototype,"_evts",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Object.create(null)}}),Aa),Wr=function(o){},Bd=console.log.bind(console),Dd=console.info.bind(console),Ld=console.warn.bind(console),zd=console.error.bind(console),me={debug:Wr,info:Wr,warn:Wr,error:Wr,isEnabled:!1,enable:function(){this.debug=Bd,this.info=Dd,this.warn=Ld,this.error=zd,this.isEnabled=!0},disable:function(){this.debug=Wr,this.info=Wr,this.warn=Wr,this.error=Wr,this.isEnabled=!1}},hh=function(){function i(){this._clock=void 0,this._timeScale=void 0,this._deltaTime=void 0,this._startTime=void 0,this._lastTickTime=void 0,this._clock=performance||Date,this._timeScale=1,this._deltaTime=1e-4;var n=this._clock.now();this._startTime=n,this._lastTickTime=n}var o=i.prototype;return o.reset=function(){this._lastTickTime=this._clock.now()},o.tick=function(){var t=this.nowTime;this._deltaTime=(t-this._lastTickTime)*this._timeScale,this._lastTickTime=t},te(i,[{key:"nowTime",get:function(){return this._clock.now()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"timeScale",get:function(){return this._timeScale},set:function(t){this._timeScale=t}},{key:"unscaledDeltaTime",get:function(){return this._deltaTime/this._timeScale}},{key:"timeSinceStartup",get:function(){return this.nowTime-this._startTime}}]),i}(),Vn,ko,Vo,Pa,Vr=(Vn=(Pa=function(){function i(n){U(this,"instanceId",ko,this),U(this,"_engine",Vo,this),this._destroyed=!1,this._engine=n}var o=i.prototype;return o.destroy=function(){var t;this._destroyed||((t=this._engine.resourceManager)===null||t===void 0||t._deleteAsset(this),this._destroyed=!0)},te(i,[{key:"engine",get:function(){return this._engine}},{key:"destroyed",get:function(){return this._destroyed}}]),i}(),Pa._instanceIdCounter=0,Pa),ko=k(Vn.prototype,"instanceId",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return++Vr._instanceIdCounter}}),Vo=k(Vn.prototype,"_engine",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Vn),et;(function(i){i[i.FLOAT=5126]="FLOAT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT=5124]="INT",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.FLOAT_ARRAY=35677]="FLOAT_ARRAY",i[i.FLOAT_VEC2_ARRAY=1e5]="FLOAT_VEC2_ARRAY",i[i.FLOAT_VEC3_ARRAY=100001]="FLOAT_VEC3_ARRAY",i[i.FLOAT_VEC4_ARRAY=100002]="FLOAT_VEC4_ARRAY",i[i.INT_ARRAY=100003]="INT_ARRAY",i[i.INT_VEC2_ARRAY=100004]="INT_VEC2_ARRAY",i[i.INT_VEC3_ARRAY=100005]="INT_VEC3_ARRAY",i[i.INT_VEC4_ARRAY=100006]="INT_VEC4_ARRAY",i[i.FLOAT_MAT2_ARRAY=100007]="FLOAT_MAT2_ARRAY",i[i.FLOAT_MAT3_ARRAY=100008]="FLOAT_MAT3_ARRAY",i[i.FLOAT_MAT4_ARRAY=100009]="FLOAT_MAT4_ARRAY",i[i.SAMPLER_2D_ARRAY=100010]="SAMPLER_2D_ARRAY",i[i.SAMPLER_CUBE_ARRAY=100011]="SAMPLER_CUBE_ARRAY",i[i.SAMPLER_2D=35678]="SAMPLER_2D",i[i.SAMPLER_CUBE=35680]="SAMPLER_CUBE",i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.UNSIGNED_INT=5125]="UNSIGNED_INT"})(et||(et={}));var ae;(function(i){i.shaderVertexID="shaderVertexID",i.standardDerivatives="OES_standard_derivatives",i.shaderTextureLod="EXT_shader_texture_lod",i.elementIndexUint="OES_element_index_uint",i.depthTexture="WEBGL_depth_texture",i.drawBuffers="WEBGL_draw_buffers",i.vertexArrayObject="OES_vertex_array_object",i.instancedArrays="ANGLE_instanced_arrays",i.multipleSample="multipleSampleOnlySupportedInWebGL2",i.textureFloat="OES_texture_float",i.textureFloatLinear="OES_texture_float_linear",i.textureHalfFloat="OES_texture_half_float",i.textureHalfFloatLinear="OES_texture_half_float_linear",i.WEBGL_colorBufferFloat="WEBGL_color_buffer_float",i.colorBufferFloat="EXT_color_buffer_float",i.colorBufferHalfFloat="EXT_color_buffer_half_float",i.textureFilterAnisotropic="EXT_texture_filter_anisotropic",i.blendMinMax="EXT_blend_minmax",i.astc="WEBGL_compressed_texture_astc",i.astc_webkit="WEBKIT_WEBGL_compressed_texture_astc",i.etc="WEBGL_compressed_texture_etc",i.etc_webkit="WEBKIT_WEBGL_compressed_texture_etc",i.etc1="WEBGL_compressed_texture_etc1",i.etc1_webkit="WEBKIT_WEBGL_compressed_texture_etc1",i.pvrtc="WEBGL_compressed_texture_pvrtc",i.pvrtc_webkit="WEBKIT_WEBGL_compressed_texture_pvrtc",i.s3tc="WEBGL_compressed_texture_s3tc",i.s3tc_webkit="WEBKIT_WEBGL_compressed_texture_s3tc"})(ae||(ae={}));var Dt=function(){function i(n){n===void 0&&(n=0),this._elements=void 0,this.length=0,this._elements=new Array(n)}var o=i.prototype;return o.add=function(t){this.length===this._elements.length?this._elements.push(t):this._elements[this.length]=t,this.length++},o.delete=function(t){var e=this._elements.indexOf(t);this.deleteByIndex(e)},o.get=function(t){if(t>=this.length)throw"Index is out of range.";return this._elements[t]},o.deleteByIndex=function(t){var e=this._elements,r=null,a=this.length-1;return t!==a&&(r=e[a],e[t]=r),this.length--,r},o.garbageCollection=function(){this._elements.length=this.length},i}(),Yt=function(){function i(){this._mask=[],this._length=0}i.unionCollection=function(t,e,r){var a=r._mask,s,l,c,u;t._length<e._length?(s=t._length,l=e._length,c=t._mask,u=e._mask):(s=e._length,l=t._length,c=e._mask,u=t._mask);var h=0;for(a.length<l&&(a.length=l);h<s;h++)a[h]=c[h]|u[h];for(;h<l;h++)a[h]=u[h];r._length=l};var o=i.prototype;return o.enable=function(t){var e=t._maskIndex,r=e+1,a=this._mask,s=this._length;if(s<r){for(a.length<r&&(a.length=r);s<e;s++)a[s]=0;a[e]=t._maskValue,this._length=r}else a[e]|=t._maskValue},o.disable=function(t){var e=t._maskIndex,r=this._mask,a=this._length-1;if(!(e>a)){var s=r[e]&~t._maskValue;e==a&&s===0?this._length--:r[e]=s}},o.unionCollection=function(t){var e=t._mask,r=t._length,a=this._mask,s=this._length;if(s<r){a.length<r&&(a.length=r);for(var l=0;l<s;l++)a[l]|=e[l];for(;l<r;l++)a[l]=e[l];this._length=r}else for(var c=0;c<r;c++)a[c]|=e[c]},o.complementaryCollection=function(t){for(var e=t._mask,r=this._mask,a=this._length-1,s=Math.min(t._length-1,a);s>=0;s--){var l=r[s]&~e[s];s==a&&l===0?(a--,this._length--):r[s]=l}},o.intersectionCollection=function(t){for(var e=t._mask,r=this._mask,a=this._length-1;a>=0;a--){var s=r[a]&e[a];s==0&&a==this._length-1?this._length--:r[a]=s}},o.isEnable=function(t){var e=t._maskIndex;return e>=this._length?!1:(this._mask[e]&t._maskValue)!==0},o.clear=function(){this._length=0},i}(),po=function(){function i(){this._onStartScripts=new Dt,this._onUpdateScripts=new Dt,this._onLateUpdateScripts=new Dt,this._onPhysicsUpdateScripts=new Dt,this._disableScripts=[],this._destroyScripts=[],this._onUpdateAnimations=new Dt,this._renderers=new Dt,this._onUpdateRenderers=new Dt,this._componentsContainerPool=[]}var o=i.prototype;return o.addRenderer=function(t){t._rendererIndex=this._renderers.length,this._renderers.add(t)},o.removeRenderer=function(t){var e=this._renderers.deleteByIndex(t._rendererIndex);e&&(e._rendererIndex=t._rendererIndex),t._rendererIndex=-1},o.addOnStartScript=function(t){t._onStartIndex=this._onStartScripts.length,this._onStartScripts.add(t)},o.removeOnStartScript=function(t){var e=this._onStartScripts.deleteByIndex(t._onStartIndex);e&&(e._onStartIndex=t._onStartIndex),t._onStartIndex=-1},o.addOnUpdateScript=function(t){t._onUpdateIndex=this._onUpdateScripts.length,this._onUpdateScripts.add(t)},o.removeOnUpdateScript=function(t){var e=this._onUpdateScripts.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},o.addOnLateUpdateScript=function(t){t._onLateUpdateIndex=this._onLateUpdateScripts.length,this._onLateUpdateScripts.add(t)},o.removeOnLateUpdateScript=function(t){var e=this._onLateUpdateScripts.deleteByIndex(t._onLateUpdateIndex);e&&(e._onLateUpdateIndex=t._onLateUpdateIndex),t._onLateUpdateIndex=-1},o.addOnPhysicsUpdateScript=function(t){t._onPhysicsUpdateIndex=this._onPhysicsUpdateScripts.length,this._onPhysicsUpdateScripts.add(t)},o.removeOnPhysicsUpdateScript=function(t){var e=this._onPhysicsUpdateScripts.deleteByIndex(t._onPhysicsUpdateIndex);e&&(e._onPhysicsUpdateIndex=t._onPhysicsUpdateIndex),t._onPhysicsUpdateIndex=-1},o.addOnUpdateAnimations=function(t){t._onUpdateIndex=this._onUpdateAnimations.length,this._onUpdateAnimations.add(t)},o.removeOnUpdateAnimations=function(t){var e=this._onUpdateAnimations.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},o.addOnUpdateRenderers=function(t){t._onUpdateIndex=this._onUpdateRenderers.length,this._onUpdateRenderers.add(t)},o.removeOnUpdateRenderers=function(t){var e=this._onUpdateRenderers.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},o.addDisableScript=function(t){this._disableScripts.push(t)},o.addDestroyScript=function(t){this._destroyScripts.push(t)},o.callScriptOnStart=function(){var t=this._onStartScripts;if(t.length>0){for(var e=t._elements,r=0;r<t.length;r++){var a=e[r];a._waitHandlingInValid||(a._started=!0,a._onStartIndex=-1,a.onStart())}t.length=0}},o.callScriptOnUpdate=function(t){for(var e=this._onUpdateScripts._elements,r=this._onUpdateScripts.length-1;r>=0;--r){var a=e[r];!a._waitHandlingInValid&&a._started&&a.onUpdate(t)}},o.callScriptOnLateUpdate=function(t){for(var e=this._onLateUpdateScripts._elements,r=this._onLateUpdateScripts.length-1;r>=0;--r){var a=e[r];!a._waitHandlingInValid&&a._started&&a.onLateUpdate(t)}},o.callScriptOnPhysicsUpdate=function(){for(var t=this._onPhysicsUpdateScripts._elements,e=this._onPhysicsUpdateScripts.length-1;e>=0;--e){var r=t[e];!r._waitHandlingInValid&&r._started&&r.onPhysicsUpdate()}},o.callAnimationUpdate=function(t){for(var e=this._onUpdateAnimations._elements,r=this._onUpdateAnimations.length-1;r>=0;--r)e[r].update(t)},o.callRendererOnUpdate=function(t){for(var e=this._onUpdateRenderers._elements,r=this._onUpdateRenderers.length-1;r>=0;--r)e[r].update(t)},o.callRender=function(t){for(var e=t._camera,r=this._renderers._elements,a=this._renderers.length-1;a>=0;--a){var s=r[a];if(!!(e.cullingMask&s._entity.layer)&&!(e.enableFrustumCulling&&(s.isCulled=!e._frustum.intersectsBox(s.bounds),s.isCulled))){var l=e.entity.transform,c=l.worldPosition,u=s.bounds.getCenter(i._tempVector0);if(e.isOrthographic){var h=l.getWorldForward(i._tempVector1);T.subtract(u,c,u),s._distanceForSort=T.dot(u,h)}else s._distanceForSort=T.distanceSquared(u,c);s._updateShaderData(t),s._render(e),Yt.unionCollection(e._globalShaderMacro,s.shaderData._macroCollection,s._globalShaderMacro)}}},o.handlingInvalidScripts=function(){var t=this._disableScripts,e=this._destroyScripts,r=t.length;if(r>0){for(var a=r-1;a>=0;a--){var s=t[a];s._waitHandlingInValid&&s._handlingInValid()}t.length=0}if(r=e.length,r>0){for(var l=r-1;l>=0;l--)e[l].onDestroy();e.length=0}},o.callCameraOnBeginRender=function(t){for(var e=t.entity._scripts,r=e.length-1;r>=0;--r){var a=e.get(r);a._waitHandlingInValid||a.onBeginRender(t)}},o.callCameraOnEndRender=function(t){for(var e=t.entity._scripts,r=e.length-1;r>=0;--r){var a=e.get(r);a._waitHandlingInValid||a.onEndRender(t)}},o.getActiveChangedTempList=function(){return this._componentsContainerPool.length?this._componentsContainerPool.pop():[]},o.putActiveChangedTempList=function(t){t.length=0,this._componentsContainerPool.push(t)},i}();po._tempVector0=new T;po._tempVector1=new T;var Od=function(){function i(){}return i.cloneComponent=function(n,t){for(var e=nr.getCloneMode(n.constructor),r=Object.keys(n),a=0,s=r.length;a<s;a++){var l=r[a],c=e[l];switch(c){case void 0:case Or.Assignment:t[l]=n[l];break;case Or.Shallow:var u=n[l];if(u instanceof Object){var h=t[l];h==null&&(h=t[l]=u.constructor()),Cn(h,u)}else t[l]=u;break;case Or.Deep:var d=n[l];if(d instanceof Object){var f=t[l];f==null&&(f=t[l]=d.constructor()),nr.deepCloneObject(d,f)}else t[l]=d;break}}n._cloneTo&&n._cloneTo(t)},i}(),An=function(){i._register=function(n,t){this._addDependency(n,t,this._dependenciesMap),this._addDependency(t,n,this._invDependenciesMap)},i._addCheck=function(n,t){var e=i._dependenciesMap.get(t);if(e)for(var r=0,a=e.length;r<a;r++){var s=e[r];n.getComponent(s)||n.addComponent(s)}},i._removeCheck=function(n,t){var e=i._invDependenciesMap.get(t);if(e){for(var r=0,a=e.length;r<a;r++)if(n.getComponent(e[r]))throw"you should remove "+e[r]+" before adding "+t}},i._addDependency=function(n,t,e){var r=e.get(n);r||(r=[],e.set(n,r)),r.indexOf(t)===-1&&r.push(t)};function i(){}return i}();An._dependenciesMap=new Map;An._invDependenciesMap=new Map;function In(){for(var i=arguments.length,o=new Array(i),n=0;n<i;n++)o[n]=arguments[n];return function(t){o.forEach(function(e){return An._register(t,e)})}}var Ot;(function(i){i[i.Layer0=1]="Layer0",i[i.Layer1=2]="Layer1",i[i.Layer2=4]="Layer2",i[i.Layer3=8]="Layer3",i[i.Layer4=16]="Layer4",i[i.Layer5=32]="Layer5",i[i.Layer6=64]="Layer6",i[i.Layer7=128]="Layer7",i[i.Layer8=256]="Layer8",i[i.Layer9=512]="Layer9",i[i.Layer10=1024]="Layer10",i[i.Layer11=2048]="Layer11",i[i.Layer12=4096]="Layer12",i[i.Layer13=8192]="Layer13",i[i.Layer14=16384]="Layer14",i[i.Layer15=32768]="Layer15",i[i.Layer16=65536]="Layer16",i[i.Layer17=131072]="Layer17",i[i.Layer18=262144]="Layer18",i[i.Layer19=524288]="Layer19",i[i.Layer20=1048576]="Layer20",i[i.Layer21=2097152]="Layer21",i[i.Layer22=4194304]="Layer22",i[i.Layer23=8388608]="Layer23",i[i.Layer24=16777216]="Layer24",i[i.Layer25=33554432]="Layer25",i[i.Layer26=67108864]="Layer26",i[i.Layer27=134217728]="Layer27",i[i.Layer28=268435456]="Layer28",i[i.Layer29=536870912]="Layer29",i[i.Layer30=1073741824]="Layer30",i[i.Layer31=2147483648]="Layer31",i[i.Everything=4294967295]="Everything",i[i.Nothing=0]="Nothing"})(Ot||(Ot={}));var dh=function(){function i(){this._flagManagers=[]}var o=i.prototype;return o.clearFromManagers=function(){this._removeFromManagers(),this._flagManagers.length=0},o.destroy=function(){this._removeFromManagers(),this._flagManagers=null},o._removeFromManagers=function(){for(var t=this._flagManagers,e=0,r=t.length;e<r;e++)Pd(t[e]._updateFlags,this)},i}(),nn=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t.flag=!0,t}var n=o.prototype;return n.dispatch=function(){this.flag=!0},o}(dh),Ii,Go,Ho,Wo,Xo,ar=(Ii=function(i){J(o,i);function o(t){var e;return e=i.call(this,t.engine)||this,U(e,"_entity",Go,z(e)),U(e,"_destroyed",Ho,z(e)),U(e,"_enabled",Wo,z(e)),U(e,"_awoken",Xo,z(e)),e._entity=t,e}var n=o.prototype;return n.destroy=function(){this._destroyed||(this._entity._removeComponent(this),this._entity.isActiveInHierarchy&&this._enabled&&this._onDisable(),this._destroyed=!0,this._onDestroy())},n._onAwake=function(){},n._onEnable=function(){},n._onDisable=function(){},n._onDestroy=function(){},n._setActive=function(e){e?(this._awoken||(this._awoken=!0,this._onAwake()),this._entity._isActiveInHierarchy&&this._onEnable()):this._onDisable()},te(o,[{key:"enabled",get:function(){return this._enabled},set:function(e){e!==this._enabled&&(this._enabled=e,e?this._entity.isActiveInHierarchy&&this._onEnable():this._entity.isActiveInHierarchy&&this._onDisable())}},{key:"destroyed",get:function(){return this._destroyed}},{key:"entity",get:function(){return this._entity}},{key:"scene",get:function(){return this._entity.scene}}]),o}(Vr),Go=k(Ii.prototype,"_entity",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ho=k(Ii.prototype,"_destroyed",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Wo=k(Ii.prototype,"_enabled",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Xo=k(Ii.prototype,"_awoken",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ii),pa=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t.listener=void 0,t}var n=o.prototype;return n.dispatch=function(e){this.listener&&this.listener(e)},o}(dh),Ri=function(){function i(){this._updateFlags=[]}var o=i.prototype;return o.createFlag=function(t){var e=new t;return this.addFlag(e),e},o.addFlag=function(t){this._updateFlags.push(t),t._flagManagers.push(this)},o.dispatch=function(t){for(var e=this._updateFlags,r=e.length-1;r>=0;r--)e[r].dispatch(t)},i}(),Mt,jo,$o,qo,Yo,Qo,Jo,Zo,Ko,es,ts,rs,is,ns,or,$t=(Mt=(or=function(i){J(o,i);function o(t){var e;return e=i.call(this,t)||this,U(e,"_position",jo,z(e)),U(e,"_rotation",$o,z(e)),U(e,"_rotationQuaternion",qo,z(e)),U(e,"_scale",Yo,z(e)),U(e,"_worldPosition",Qo,z(e)),U(e,"_worldRotation",Jo,z(e)),U(e,"_worldRotationQuaternion",Zo,z(e)),U(e,"_lossyWorldScale",Ko,z(e)),U(e,"_localMatrix",es,z(e)),U(e,"_worldMatrix",ts,z(e)),U(e,"_updateFlagManager",rs,z(e)),U(e,"_isParentDirty",is,z(e)),U(e,"_parentTransformCache",ns,z(e)),e._dirtyFlag=ve.WmWpWeWqWs,e._onPositionChanged=e._onPositionChanged.bind(z(e)),e._onWorldPositionChanged=e._onWorldPositionChanged.bind(z(e)),e._onRotationChanged=e._onRotationChanged.bind(z(e)),e._onWorldRotationChanged=e._onWorldRotationChanged.bind(z(e)),e._onRotationQuaternionChanged=e._onRotationQuaternionChanged.bind(z(e)),e._onWorldRotationQuaternionChanged=e._onWorldRotationQuaternionChanged.bind(z(e)),e._onScaleChanged=e._onScaleChanged.bind(z(e)),e._position._onValueChanged=e._onPositionChanged,e._worldPosition._onValueChanged=e._onWorldPositionChanged,e._rotation._onValueChanged=e._onRotationChanged,e._worldRotation._onValueChanged=e._onWorldRotationChanged,e._rotationQuaternion._onValueChanged=e._onRotationQuaternionChanged,e._worldRotationQuaternion._onValueChanged=e._onWorldRotationQuaternionChanged,e._scale._onValueChanged=e._onScaleChanged,e}var n=o.prototype;return n.setPosition=function(e,r,a){this._position.set(e,r,a)},n.setRotation=function(e,r,a){this._rotation.set(e,r,a)},n.setRotationQuaternion=function(e,r,a,s){this._rotationQuaternion.set(e,r,a,s)},n.setScale=function(e,r,a){this._scale.set(e,r,a)},n.setWorldPosition=function(e,r,a){this._worldPosition.set(e,r,a)},n.setWorldRotation=function(e,r,a){this._worldRotation.set(e,r,a)},n.setWorldRotationQuaternion=function(e,r,a,s){this._worldRotationQuaternion.set(e,r,a,s)},n.getWorldForward=function(e){var r=this.worldMatrix.elements;return e.set(-r[8],-r[9],-r[10]),e.normalize()},n.getWorldRight=function(e){var r=this.worldMatrix.elements;return e.set(r[0],r[1],r[2]),e.normalize()},n.getWorldUp=function(e){var r=this.worldMatrix.elements;return e.set(r[4],r[5],r[6]),e.normalize()},n.translate=function(e,r,a,s){if(typeof e=="number"){var l=o._tempVec30;l.set(e,r,a),this._translate(l,s)}else this._translate(e,r)},n.rotate=function(e,r,a,s){typeof e=="number"?this._rotateXYZ(e,r,a,s):this._rotateXYZ(e.x,e.y,e.z,r)},n.rotateByAxis=function(e,r,a){a===void 0&&(a=!0);var s=r*H.degreeToRadFactor;De.rotationAxisAngle(e,s,o._tempQuat0),this._rotateByQuat(o._tempQuat0,a)},n.lookAt=function(e,r){var a=o._tempVec30;T.subtract(this.worldPosition,e,a);var s=a.length();if(!(s<=H.zeroTolerance)){a.scale(1/s);var l=o._tempVec31;if(r?T.cross(r,a,l):l.set(a.z,0,-a.x),s=l.length(),!(s<=H.zeroTolerance)){l.scale(1/s);var c=o._tempVec32;T.cross(a,l,c);var u=o._tempMat41,h=u.elements;h[0]=l.x,h[1]=l.y,h[2]=l.z,h[4]=c.x,h[5]=c.y,h[6]=c.z,h[8]=a.x,h[9]=a.y,h[10]=a.z,u.getRotation(this._worldRotationQuaternion)}}},n.registerWorldChangeFlag=function(){return this._updateFlagManager.createFlag(nn)},n._registerWorldChangeListener=function(){return this._updateFlagManager.createFlag(pa)},n._parentChange=function(){this._isParentDirty=!0,this._updateAllWorldFlag()},n._isFrontFaceInvert=function(){var e=this.lossyWorldScale,r=e.x<0;return e.y<0&&(r=!r),e.z<0&&(r=!r),r},n._updateWorldPositionFlag=function(){if(!this._isContainDirtyFlags(ve.WmWp)){this._worldAssociatedChange(ve.WmWp);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var s;(s=e[r].transform)===null||s===void 0||s._updateWorldPositionFlag()}}},n._updateWorldRotationFlag=function(){if(!this._isContainDirtyFlags(ve.WmWeWq)){this._worldAssociatedChange(ve.WmWeWq);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var s;(s=e[r].transform)===null||s===void 0||s._updateWorldPositionAndRotationFlag()}}},n._updateWorldPositionAndRotationFlag=function(){if(!this._isContainDirtyFlags(ve.WmWpWeWq)){this._worldAssociatedChange(ve.WmWpWeWq);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var s;(s=e[r].transform)===null||s===void 0||s._updateWorldPositionAndRotationFlag()}}},n._updateWorldScaleFlag=function(){if(!this._isContainDirtyFlags(ve.WmWs)){this._worldAssociatedChange(ve.WmWs);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var s;(s=e[r].transform)===null||s===void 0||s._updateWorldPositionAndScaleFlag()}}},n._updateWorldPositionAndScaleFlag=function(){if(!this._isContainDirtyFlags(ve.WmWpWs)){this._worldAssociatedChange(ve.WmWpWs);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var s;(s=e[r].transform)===null||s===void 0||s._updateWorldPositionAndScaleFlag()}}},n._updateAllWorldFlag=function(){if(!this._isContainDirtyFlags(ve.WmWpWeWqWs)){this._worldAssociatedChange(ve.WmWpWeWqWs);for(var e=this._entity._children,r=0,a=e.length;r<a;r++){var s;(s=e[r].transform)===null||s===void 0||s._updateAllWorldFlag()}}},n._getParentTransform=function(){if(!this._isParentDirty)return this._parentTransformCache;for(var e=null,r=this._entity.parent;r;){var a=r.transform;if(a){e=a;break}else r=r.parent}return this._parentTransformCache=e,this._isParentDirty=!1,e},n._getScaleMatrix=function(){var e=o._tempQuat0,r=o._tempMat30,a=o._tempMat31,s=o._tempMat32;return a.copyFromMatrix(this.worldMatrix),De.invert(this.worldRotationQuaternion,e),Gi.rotationQuaternion(e,r),Gi.multiply(r,a,s),s},n._isContainDirtyFlags=function(e){return(this._dirtyFlag&e)===e},n._isContainDirtyFlag=function(e){return(this._dirtyFlag&e)!=0},n._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},n._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},n._worldAssociatedChange=function(e){this._dirtyFlag|=e,this._updateFlagManager.dispatch()},n._rotateByQuat=function(e,r){r?De.multiply(this.rotationQuaternion,e,this._rotationQuaternion):De.multiply(e,this.worldRotationQuaternion,this._worldRotationQuaternion)},n._translate=function(e,r){if(r===void 0&&(r=!0),r){var a=o._tempVec30;T.transformByQuat(e,this.worldRotationQuaternion,a),this._worldPosition.add(a)}else this._worldPosition.add(e)},n._rotateXYZ=function(e,r,a,s){s===void 0&&(s=!0);var l=H.degreeToRadFactor,c=o._tempQuat0;De.rotationEuler(e*l,r*l,a*l,c),this._rotateByQuat(c,s)},n._onPositionChanged=function(){this._setDirtyFlagTrue(ve.LocalMatrix),this._updateWorldPositionFlag()},n._onWorldPositionChanged=function(){var e=this._worldPosition,r=this._getParentTransform();r?(ce.invert(r.worldMatrix,o._tempMat41),T.transformCoordinate(e,o._tempMat41,this._position)):this._position.copyFrom(e),this._setDirtyFlagFalse(ve.WorldPosition)},n._onRotationChanged=function(){this._setDirtyFlagTrue(ve.LocalMatrix|ve.LocalQuat),this._setDirtyFlagFalse(ve.LocalEuler),this._updateWorldRotationFlag()},n._onWorldRotationChanged=function(){var e=this._worldRotation;De.rotationEuler(H.degreeToRadian(e.x),H.degreeToRadian(e.y),H.degreeToRadian(e.z),this._worldRotationQuaternion),this._setDirtyFlagFalse(ve.WorldEuler)},n._onRotationQuaternionChanged=function(){this._setDirtyFlagTrue(ve.LocalMatrix|ve.LocalEuler),this._setDirtyFlagFalse(ve.LocalQuat),this._updateWorldRotationFlag()},n._onWorldRotationQuaternionChanged=function(){var e=this._worldRotationQuaternion,r=this._getParentTransform();if(r){var a=o._tempQuat0;De.invert(r.worldRotationQuaternion,a),De.multiply(a,e,this._rotationQuaternion)}else this._rotationQuaternion.copyFrom(e);this._setDirtyFlagFalse(ve.WorldQuat)},n._onScaleChanged=function(){this._setDirtyFlagTrue(ve.LocalMatrix),this._updateWorldScaleFlag()},te(o,[{key:"position",get:function(){return this._position},set:function(e){this._position!==e&&this._position.copyFrom(e)}},{key:"worldPosition",get:function(){var e=this._worldPosition;return this._isContainDirtyFlag(ve.WorldPosition)&&(e._onValueChanged=null,this._getParentTransform()?this.worldMatrix.getTranslation(e):e.copyFrom(this._position),e._onValueChanged=this._onWorldPositionChanged,this._setDirtyFlagFalse(ve.WorldPosition)),e},set:function(e){this._worldPosition!==e&&this._worldPosition.copyFrom(e)}},{key:"rotation",get:function(){var e=this._rotation;return this._isContainDirtyFlag(ve.LocalEuler)&&(e._onValueChanged=null,this._rotationQuaternion.toEuler(e),e._onValueChanged=this._onRotationChanged,e.scale(H.radToDegreeFactor),this._setDirtyFlagFalse(ve.LocalEuler)),e},set:function(e){this._rotation!==e&&this._rotation.copyFrom(e)}},{key:"worldRotation",get:function(){var e=this._worldRotation;return this._isContainDirtyFlag(ve.WorldEuler)&&(e._onValueChanged=null,this.worldRotationQuaternion.toEuler(e),e.scale(H.radToDegreeFactor),e._onValueChanged=this._onWorldRotationChanged,this._setDirtyFlagFalse(ve.WorldEuler)),e},set:function(e){this._worldRotation!==e&&this._worldRotation.copyFrom(e)}},{key:"rotationQuaternion",get:function(){var e=this._rotationQuaternion;return this._isContainDirtyFlag(ve.LocalQuat)&&(e._onValueChanged=null,De.rotationEuler(H.degreeToRadian(this._rotation.x),H.degreeToRadian(this._rotation.y),H.degreeToRadian(this._rotation.z),e),e._onValueChanged=this._onRotationQuaternionChanged,this._setDirtyFlagFalse(ve.LocalQuat)),e},set:function(e){this._rotationQuaternion!==e?e.normalized?this._rotationQuaternion.copyFrom(e):De.normalize(e,this._rotationQuaternion):e.normalized||e.normalize()}},{key:"worldRotationQuaternion",get:function(){var e=this._worldRotationQuaternion;if(this._isContainDirtyFlag(ve.WorldQuat)){e._onValueChanged=null;var r=this._getParentTransform();r!=null?De.multiply(r.worldRotationQuaternion,this.rotationQuaternion,e):e.copyFrom(this.rotationQuaternion),e._onValueChanged=this._onWorldRotationQuaternionChanged,this._setDirtyFlagFalse(ve.WorldQuat)}return e},set:function(e){this._worldRotationQuaternion!==e&&(e.normalized?this._worldRotationQuaternion.copyFrom(e):De.normalize(e,this._worldRotationQuaternion)),e.normalized||e.normalize()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale!==e&&this._scale.copyFrom(e)}},{key:"lossyWorldScale",get:function(){if(this._isContainDirtyFlag(ve.WorldScale)){if(this._getParentTransform()){var e=this._getScaleMatrix(),r=e.elements;this._lossyWorldScale.set(r[0],r[4],r[8])}else this._lossyWorldScale.copyFrom(this._scale);this._setDirtyFlagFalse(ve.WorldScale)}return this._lossyWorldScale}},{key:"localMatrix",get:function(){return this._isContainDirtyFlag(ve.LocalMatrix)&&(ce.affineTransformation(this._scale,this.rotationQuaternion,this._position,this._localMatrix),this._setDirtyFlagFalse(ve.LocalMatrix)),this._localMatrix},set:function(e){this._localMatrix!==e&&this._localMatrix.copyFrom(e),this._localMatrix.decompose(this._position,this._rotationQuaternion,this._scale),this._setDirtyFlagTrue(ve.LocalEuler),this._setDirtyFlagFalse(ve.LocalMatrix),this._updateAllWorldFlag()}},{key:"worldMatrix",get:function(){if(this._isContainDirtyFlag(ve.WorldMatrix)){var e=this._getParentTransform();e?ce.multiply(e.worldMatrix,this.localMatrix,this._worldMatrix):this._worldMatrix.copyFrom(this.localMatrix),this._setDirtyFlagFalse(ve.WorldMatrix)}return this._worldMatrix},set:function(e){this._worldMatrix!==e&&this._worldMatrix.copyFrom(e);var r=this._getParentTransform();r?(ce.invert(r.worldMatrix,o._tempMat42),ce.multiply(o._tempMat42,e,this._localMatrix)):this._localMatrix.copyFrom(e),this.localMatrix=this._localMatrix,this._setDirtyFlagFalse(ve.WorldMatrix)}}]),o}(ar),or._tempQuat0=new De,or._tempVec30=new T,or._tempVec31=new T,or._tempVec32=new T,or._tempMat30=new Gi,or._tempMat31=new Gi,or._tempMat32=new Gi,or._tempMat41=new ce,or._tempMat42=new ce,or),jo=k(Mt.prototype,"_position",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new T}}),$o=k(Mt.prototype,"_rotation",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new T}}),qo=k(Mt.prototype,"_rotationQuaternion",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new De}}),Yo=k(Mt.prototype,"_scale",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new T(1,1,1)}}),Qo=k(Mt.prototype,"_worldPosition",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new T}}),Jo=k(Mt.prototype,"_worldRotation",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new T}}),Zo=k(Mt.prototype,"_worldRotationQuaternion",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new De}}),Ko=k(Mt.prototype,"_lossyWorldScale",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new T(1,1,1)}}),es=k(Mt.prototype,"_localMatrix",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),ts=k(Mt.prototype,"_worldMatrix",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),rs=k(Mt.prototype,"_updateFlagManager",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ri}}),is=k(Mt.prototype,"_isParentDirty",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ns=k(Mt.prototype,"_parentTransformCache",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mt),ve;(function(i){i[i.LocalEuler=1]="LocalEuler",i[i.LocalQuat=2]="LocalQuat",i[i.WorldPosition=4]="WorldPosition",i[i.WorldEuler=8]="WorldEuler",i[i.WorldQuat=16]="WorldQuat",i[i.WorldScale=32]="WorldScale",i[i.LocalMatrix=64]="LocalMatrix",i[i.WorldMatrix=128]="WorldMatrix",i[i.WmWp=132]="WmWp",i[i.WmWeWq=152]="WmWeWq",i[i.WmWpWeWq=156]="WmWpWeWq",i[i.WmWs=160]="WmWs",i[i.WmWpWs=164]="WmWpWs",i[i.WmWpWeWqWs=188]="WmWpWeWqWs"})(ve||(ve={}));var Lr=function(i){J(o,i),o._findChildByName=function(e,r){for(var a=e._children,s=a.length-1;s>=0;s--){var l=a[s];if(l.name===r)return l}return null},o._traverseSetOwnerScene=function(e,r){e._scene=r;for(var a=e._children,s=e.childCount-1;s>=0;s--)this._traverseSetOwnerScene(a[s],r)};function o(t,e){var r;return r=i.call(this,t)||this,r.name=void 0,r.layer=Ot.Layer0,r.transform=void 0,r._isActiveInHierarchy=!1,r._components=[],r._scripts=new Dt,r._children=[],r._scene=void 0,r._isRoot=!1,r._isActive=!0,r._siblingIndex=-1,r._parent=null,r._activeChangedComponents=void 0,r._invModelMatrix=new ce,r._inverseWorldMatFlag=void 0,r.name=e,r.transform=r.addComponent($t),r._inverseWorldMatFlag=r.transform.registerWorldChangeFlag(),r}var n=o.prototype;return n.addComponent=function(e){An._addCheck(this,e);var r=new e(this);return this._components.push(r),this._isActiveInHierarchy&&r._setActive(!0),r},n.getComponent=function(e){for(var r=this._components.length-1;r>=0;r--){var a=this._components[r];if(a instanceof e)return a}},n.getComponents=function(e,r){r.length=0;for(var a=this._components.length-1;a>=0;a--){var s=this._components[a];s instanceof e&&r.push(s)}return r},n.getComponentsIncludeChildren=function(e,r){return r.length=0,this._getComponentsInChildren(e,r),r},n.addChild=function(e,r){var a;if(typeof e=="number"?a=e:(a=void 0,r=e),r._isRoot){r._scene._removeFromEntityList(r),r._isRoot=!1,this._addToChildrenList(a,r),r._parent=this;var s=this._scene;r._scene!==s&&o._traverseSetOwnerScene(r,s),this._isActiveInHierarchy?!r._isActiveInHierarchy&&r._isActive&&r._processActive():r._isActiveInHierarchy&&r._processInActive(),r._setTransformDirty()}else r._setParent(this,a)},n.removeChild=function(e){e._setParent(null)},n.getChild=function(e){return this._children[e]},n.findByName=function(e){var r=this._children,a=o._findChildByName(this,e);if(a)return a;for(var s=r.length-1;s>=0;s--){var l=r[s],c=l.findByName(e);if(c)return c}return null},n.findByPath=function(e){for(var r=e.split("/"),a=this,s=0,l=r.length;s<l;++s){var c=r[s];if(c&&(a=o._findChildByName(a,c),!a))return null}return a},n.createChild=function(e){var r=new o(this.engine,e);return r.layer=this.layer,r.parent=this,r},n.clearChildren=function(){for(var e=this._children,r=e.length-1;r>=0;r--){var a=e[r];a._parent=null,a._isActiveInHierarchy&&a._processInActive(),o._traverseSetOwnerScene(a,null)}e.length=0},n.clone=function(){var e=new o(this._engine,this.name);e._isActive=this._isActive,e.transform.localMatrix=this.transform.localMatrix;for(var r=this._children,a=0,s=this._children.length;a<s;a++){var l=r[a];e.addChild(l.clone())}for(var c=this._components,u=0,h=c.length;u<h;u++){var d=c[u];if(!(d instanceof $t)){var f=e.addComponent(d.constructor);Od.cloneComponent(d,f)}}return e},n.destroy=function(){if(!this._destroyed){i.prototype.destroy.call(this);for(var e=this._components,r=e.length-1;r>=0;r--)e[r].destroy();this._components.length=0;for(var a=this._children,s=a.length-1;s>=0;s--)a[s].destroy();this._children.length=0,this._removeFromParent()}},n._removeComponent=function(e){An._removeCheck(this,e.constructor);var r=this._components;r.splice(r.indexOf(e),1)},n._addScript=function(e){e._entityScriptsIndex=this._scripts.length,this._scripts.add(e)},n._removeScript=function(e){var r=this._scripts.deleteByIndex(e._entityScriptsIndex);r&&(r._entityScriptsIndex=e._entityScriptsIndex),e._entityScriptsIndex=-1},n._removeFromParent=function(){var e=this._parent;if(e!=null){var r=e._children,a=this._siblingIndex;r.splice(a,1);for(var s=r.length;a<s;a++)r[a]._siblingIndex--;this._parent=null,this._siblingIndex=-1}},n._processActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main inActive entity' active in hierarchy, if the operation is in main inActive entity or it's children script's onDisable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!0)},n._processInActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main active entity' inActive in hierarchy, if the operation is in main active entity or it's children script's onEnable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setInActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!1)},n._addToChildrenList=function(e,r){var a=this._children,s=a.length;if(e===void 0)r._siblingIndex=s,a.push(r);else{if(e<0||e>s)throw"The index "+e+" is out of child list bounds "+s;r._siblingIndex=e,a.splice(e,0,r);for(var l=e+1,c=s+1;l<c;l++)a[l]._siblingIndex++}},n._setParent=function(e,r){var a=this._parent;if(e!==a){if(this._removeFromParent(),this._parent=e,e){e._addToChildrenList(r,this);var s=e._scene;this._scene!==s&&o._traverseSetOwnerScene(this,s),e._isActiveInHierarchy?!this._isActiveInHierarchy&&this._isActive&&this._processActive():this._isActiveInHierarchy&&this._processInActive()}else this._isActiveInHierarchy&&this._processInActive(),a&&o._traverseSetOwnerScene(this,null);this._setTransformDirty()}},n._getComponentsInChildren=function(e,r){for(var a=this._components.length-1;a>=0;a--){var s=this._components[a];s instanceof e&&r.push(s)}for(var l=this._children.length-1;l>=0;l--)this._children[l]._getComponentsInChildren(e,r)},n._setActiveComponents=function(e){for(var r=this._activeChangedComponents,a=0,s=r.length;a<s;++a)r[a]._setActive(e);this._engine._componentsManager.putActiveChangedTempList(r),this._activeChangedComponents=null},n._setActiveInHierarchy=function(e){this._isActiveInHierarchy=!0;for(var r=this._components,a=r.length-1;a>=0;a--){var s=r[a];s.enabled&&e.push(s)}for(var l=this._children,c=l.length-1;c>=0;c--){var u=l[c];u.isActive&&u._setActiveInHierarchy(e)}},n._setInActiveInHierarchy=function(e){this._isActiveInHierarchy=!1;for(var r=this._components,a=r.length-1;a>=0;a--){var s=r[a];s.enabled&&e.push(s)}for(var l=this._children,c=l.length-1;c>=0;c--){var u=l[c];u.isActive&&u._setInActiveInHierarchy(e)}},n._setTransformDirty=function(){if(this.transform)this.transform._parentChange();else for(var e=0,r=this._children.length;e<r;e++)this._children[e]._setTransformDirty()},n._setSiblingIndex=function(e,r){if(r=Math.min(r,e.length-1),r<0)throw"Sibling index "+r+" should large than 0";if(this._siblingIndex!==r){var a=this._siblingIndex;if(r<a)for(var s=a;s>=r;s--){var l=s==r?this:e[s-1];e[s]=l,l._siblingIndex=s}else for(var c=a;c<=r;c++){var u=c==r?this:e[c+1];e[c]=u,u._siblingIndex=c}}},n.getInvModelMatrix=function(){return this._inverseWorldMatFlag.flag&&(ce.invert(this.transform.worldMatrix,this._invModelMatrix),this._inverseWorldMatFlag.flag=!1),this._invModelMatrix},te(o,[{key:"isActive",get:function(){return this._isActive},set:function(e){if(e!==this._isActive)if(this._isActive=e,e){var r=this._parent;(r!=null&&r._isActiveInHierarchy||this._isRoot&&this._scene._isActiveInEngine)&&this._processActive()}else this._isActiveInHierarchy&&this._processInActive()}},{key:"isActiveInHierarchy",get:function(){return this._isActiveInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this._setParent(e)}},{key:"children",get:function(){return this._children}},{key:"childCount",get:function(){return this._children.length}},{key:"scene",get:function(){return this._scene}},{key:"siblingIndex",get:function(){return this._siblingIndex},set:function(e){if(this._siblingIndex===-1)throw"The entity "+this.name+" is not in the hierarchy";this._setSiblingIndex(this._isRoot?this._scene._rootEntities:this._parent._children,e)}}]),o}(Vr),_h=function(){function i(){this._features=[],this._objects=[]}var o=i.prototype;return o.registerFeature=function(t){for(var e=this._features,r=0,a=e.length;r<a;r++)if(e[r]===t)return;e.push(t);for(var s=this._objects,l=0,c=s.length;l<c;l++)s[l].features.push(new t)},o.addObject=function(t){t.features=[];for(var e=0,r=this._features.length;e<r;e++){var a;t.features.push(new this._features[e]((a=t.engine)!=null?a:t))}this._objects.push(t)},o.callFeatureMethod=function(t,e,r){for(var a=t.features,s=a.length,l=0;l<s;l++){var c=a[l];c[e]&&c[e].apply(c,r)}},o.findFeature=function(t,e){for(var r=t.features,a=r.length,s=0;s<a;s++){var l=r[s];if(l.constructor===e)return l}},i}(),er;(function(i){i[i.Backquote=0]="Backquote",i[i.Backslash=1]="Backslash",i[i.Backspace=2]="Backspace",i[i.BracketLeft=3]="BracketLeft",i[i.BracketRight=4]="BracketRight",i[i.Comma=5]="Comma",i[i.Digit0=6]="Digit0",i[i.Digit1=7]="Digit1",i[i.Digit2=8]="Digit2",i[i.Digit3=9]="Digit3",i[i.Digit4=10]="Digit4",i[i.Digit5=11]="Digit5",i[i.Digit6=12]="Digit6",i[i.Digit7=13]="Digit7",i[i.Digit8=14]="Digit8",i[i.Digit9=15]="Digit9",i[i.Equal=16]="Equal",i[i.IntlBackslash=17]="IntlBackslash",i[i.IntlRo=18]="IntlRo",i[i.IntlYen=19]="IntlYen",i[i.KeyA=20]="KeyA",i[i.KeyB=21]="KeyB",i[i.KeyC=22]="KeyC",i[i.KeyD=23]="KeyD",i[i.KeyE=24]="KeyE",i[i.KeyF=25]="KeyF",i[i.KeyG=26]="KeyG",i[i.KeyH=27]="KeyH",i[i.KeyI=28]="KeyI",i[i.KeyJ=29]="KeyJ",i[i.KeyK=30]="KeyK",i[i.KeyL=31]="KeyL",i[i.KeyM=32]="KeyM",i[i.KeyN=33]="KeyN",i[i.KeyO=34]="KeyO",i[i.KeyP=35]="KeyP",i[i.KeyQ=36]="KeyQ",i[i.KeyR=37]="KeyR",i[i.KeyS=38]="KeyS",i[i.KeyT=39]="KeyT",i[i.KeyU=40]="KeyU",i[i.KeyV=41]="KeyV",i[i.KeyW=42]="KeyW",i[i.KeyX=43]="KeyX",i[i.KeyY=44]="KeyY",i[i.KeyZ=45]="KeyZ",i[i.Minus=46]="Minus",i[i.Period=47]="Period",i[i.Quote=48]="Quote",i[i.Semicolon=49]="Semicolon",i[i.Slash=50]="Slash",i[i.AltLeft=51]="AltLeft",i[i.AltRight=52]="AltRight",i[i.CapsLock=53]="CapsLock",i[i.ContextMenu=54]="ContextMenu",i[i.ControlLeft=55]="ControlLeft",i[i.ControlRight=56]="ControlRight",i[i.Enter=57]="Enter",i[i.MetaLeft=58]="MetaLeft",i[i.MetaRight=59]="MetaRight",i[i.ShiftLeft=60]="ShiftLeft",i[i.ShiftRight=61]="ShiftRight",i[i.Space=62]="Space",i[i.Tab=63]="Tab",i[i.Convert=64]="Convert",i[i.KanaMode=65]="KanaMode",i[i.Lang1=66]="Lang1",i[i.Lang2=67]="Lang2",i[i.Lang3=68]="Lang3",i[i.Lang4=69]="Lang4",i[i.Lang5=70]="Lang5",i[i.NonConvert=71]="NonConvert",i[i.Delete=72]="Delete",i[i.End=73]="End",i[i.Help=74]="Help",i[i.Home=75]="Home",i[i.Insert=76]="Insert",i[i.PageDown=77]="PageDown",i[i.PageUp=78]="PageUp",i[i.ArrowDown=79]="ArrowDown",i[i.ArrowLeft=80]="ArrowLeft",i[i.ArrowRight=81]="ArrowRight",i[i.ArrowUp=82]="ArrowUp",i[i.NumLock=83]="NumLock",i[i.Numpad0=84]="Numpad0",i[i.Numpad1=85]="Numpad1",i[i.Numpad2=86]="Numpad2",i[i.Numpad3=87]="Numpad3",i[i.Numpad4=88]="Numpad4",i[i.Numpad5=89]="Numpad5",i[i.Numpad6=90]="Numpad6",i[i.Numpad7=91]="Numpad7",i[i.Numpad8=92]="Numpad8",i[i.Numpad9=93]="Numpad9",i[i.NumpadAdd=94]="NumpadAdd",i[i.NumpadBackspace=95]="NumpadBackspace",i[i.NumpadClear=96]="NumpadClear",i[i.NumpadClearEntry=97]="NumpadClearEntry",i[i.NumpadComma=98]="NumpadComma",i[i.NumpadDecimal=99]="NumpadDecimal",i[i.NumpadDivide=100]="NumpadDivide",i[i.NumpadEnter=101]="NumpadEnter",i[i.NumpadEqual=102]="NumpadEqual",i[i.NumpadHash=103]="NumpadHash",i[i.NumpadMemoryAdd=104]="NumpadMemoryAdd",i[i.NumpadMemoryClear=105]="NumpadMemoryClear",i[i.NumpadMemoryRecall=106]="NumpadMemoryRecall",i[i.NumpadMemoryStore=107]="NumpadMemoryStore",i[i.NumpadMemorySubtract=108]="NumpadMemorySubtract",i[i.NumpadMultiply=109]="NumpadMultiply",i[i.NumpadParenLeft=110]="NumpadParenLeft",i[i.NumpadParenRight=111]="NumpadParenRight",i[i.NumpadStar=112]="NumpadStar",i[i.NumpadSubtract=113]="NumpadSubtract",i[i.Escape=114]="Escape",i[i.F1=115]="F1",i[i.F2=116]="F2",i[i.F3=117]="F3",i[i.F4=118]="F4",i[i.F5=119]="F5",i[i.F6=120]="F6",i[i.F7=121]="F7",i[i.F8=122]="F8",i[i.F9=123]="F9",i[i.F10=124]="F10",i[i.F11=125]="F11",i[i.F12=126]="F12",i[i.F13=127]="F13",i[i.F14=128]="F14",i[i.F15=129]="F15",i[i.Fn=130]="Fn",i[i.FnLock=131]="FnLock",i[i.PrintScreen=132]="PrintScreen",i[i.ScrollLock=133]="ScrollLock",i[i.Pause=134]="Pause",i[i.BrowserBack=135]="BrowserBack",i[i.BrowserFavorites=136]="BrowserFavorites",i[i.BrowserForward=137]="BrowserForward",i[i.BrowserHome=138]="BrowserHome",i[i.BrowserRefresh=139]="BrowserRefresh",i[i.BrowserSearch=140]="BrowserSearch",i[i.BrowserStop=141]="BrowserStop",i[i.Eject=142]="Eject",i[i.LaunchApp1=143]="LaunchApp1",i[i.LaunchApp2=144]="LaunchApp2",i[i.LaunchMail=145]="LaunchMail",i[i.MediaPlayPause=146]="MediaPlayPause",i[i.MediaSelect=147]="MediaSelect",i[i.MediaStop=148]="MediaStop",i[i.MediaTrackNext=149]="MediaTrackNext",i[i.MediaTrackPrevious=150]="MediaTrackPrevious",i[i.Power=151]="Power",i[i.Sleep=152]="Sleep",i[i.AudioVolumeDown=153]="AudioVolumeDown",i[i.AudioVolumeMute=154]="AudioVolumeMute",i[i.AudioVolumeUp=155]="AudioVolumeUp",i[i.WakeUp=156]="WakeUp",i[i.Hyper=157]="Hyper",i[i.Super=158]="Super",i[i.Turbo=159]="Turbo",i[i.Abort=160]="Abort",i[i.Resume=161]="Resume",i[i.Suspend=162]="Suspend",i[i.Again=163]="Again",i[i.Copy=164]="Copy",i[i.Cut=165]="Cut",i[i.Find=166]="Find",i[i.Open=167]="Open",i[i.Paste=168]="Paste",i[i.Props=169]="Props",i[i.Select=170]="Select",i[i.Undo=171]="Undo",i[i.Hiragana=172]="Hiragana",i[i.Katakana=173]="Katakana",i[i.Unidentified=174]="Unidentified"})(er||(er={}));var Id=function(){function i(n){this._curHeldDownKeyToIndexMap=[],this._upKeyToFrameCountMap=[],this._downKeyToFrameCountMap=[],this._curFrameHeldDownList=new Dt,this._curFrameDownList=new Dt,this._curFrameUpList=new Dt,this._htmlCanvas=void 0,this._nativeEvents=[],this._hadListener=!1,this._htmlCanvas=n,n.tabIndex=n.tabIndex,this._onKeyEvent=this._onKeyEvent.bind(this),n.addEventListener("keydown",this._onKeyEvent),n.addEventListener("keyup",this._onKeyEvent),this._hadListener=!0}var o=i.prototype;return o._update=function(t){var e=this._nativeEvents,r=this._curFrameDownList,a=this._curFrameUpList;if(r.length=0,a.length=0,e.length>0){for(var s=this._curHeldDownKeyToIndexMap,l=this._curFrameHeldDownList,c=this._downKeyToFrameCountMap,u=this._upKeyToFrameCountMap,h=0,d=e.length;h<d;h++){var f=e[h],_=er[f.code];switch(f.type){case"keydown":s[_]==null&&(r.add(_),l.add(_),s[_]=l.length-1,c[_]=t);break;case"keyup":var g=s[_];if(g!=null){s[_]=null;var v=l.deleteByIndex(g);v&&(s[v]=g)}a.add(_),u[_]=t;break}}e.length=0}},o._onFocus=function(){this._hadListener||(this._htmlCanvas.addEventListener("keydown",this._onKeyEvent),this._htmlCanvas.addEventListener("keyup",this._onKeyEvent),this._hadListener=!0)},o._onBlur=function(){this._hadListener&&(this._htmlCanvas.removeEventListener("keydown",this._onKeyEvent),this._htmlCanvas.removeEventListener("keyup",this._onKeyEvent),this._curHeldDownKeyToIndexMap.length=0,this._curFrameHeldDownList.length=0,this._curFrameDownList.length=0,this._curFrameUpList.length=0,this._nativeEvents.length=0,this._hadListener=!1)},o._destroy=function(){this._hadListener&&(this._htmlCanvas.removeEventListener("keydown",this._onKeyEvent),this._htmlCanvas.removeEventListener("keyup",this._onKeyEvent),this._hadListener=!1),this._curHeldDownKeyToIndexMap=null,this._upKeyToFrameCountMap=null,this._downKeyToFrameCountMap=null,this._nativeEvents=null,this._curFrameHeldDownList=null,this._curFrameDownList=null,this._curFrameUpList=null},o._onKeyEvent=function(t){t.cancelable&&t.preventDefault(),this._nativeEvents.push(t)},i}(),vr;(function(i){i[i.None=0]="None",i[i.Color=1]="Color",i[i.Depth=2]="Depth",i[i.Stencil=4]="Stencil",i[i.ColorDepth=3]="ColorDepth",i[i.ColorStencil=5]="ColorStencil",i[i.DepthStencil=6]="DepthStencil",i[i.All=7]="All"})(vr||(vr={}));var fh=function(){this.entity=null,this.distance=0,this.point=new T,this.normal=new T},kt=function(){function i(n){var t=this;this._initialized=!1,this._engine=void 0,this._restTime=0,this._colliders=new Dt,this._gravity=new T(0,-9.81,0),this._nativePhysicsManager=void 0,this._physicalObjectsMap={},this._onContactEnter=function(e,r){for(var a=t._physicalObjectsMap[e],s=t._physicalObjectsMap[r],l=a.collider.entity._scripts,c=0,u=l.length;c<u;c++){var h=l.get(c);h._waitHandlingInValid||h.onCollisionEnter(s)}l=s.collider.entity._scripts;for(var d=0,f=l.length;d<f;d++){var _=l.get(d);_._waitHandlingInValid||_.onCollisionEnter(a)}},this._onContactExit=function(e,r){for(var a=t._physicalObjectsMap[e],s=t._physicalObjectsMap[r],l=a.collider.entity._scripts,c=0,u=l.length;c<u;c++){var h=l.get(c);h._waitHandlingInValid||h.onCollisionExit(s)}l=s.collider.entity._scripts;for(var d=0,f=l.length;d<f;d++){var _=l.get(d);_._waitHandlingInValid||_.onCollisionExit(a)}},this._onContactStay=function(e,r){for(var a=t._physicalObjectsMap[e],s=t._physicalObjectsMap[r],l=a.collider.entity._scripts,c=0,u=l.length;c<u;c++){var h=l.get(c);h._waitHandlingInValid||h.onCollisionStay(s)}l=s.collider.entity._scripts;for(var d=0,f=l.length;d<f;d++){var _=l.get(d);_._waitHandlingInValid||_.onCollisionStay(a)}},this._onTriggerEnter=function(e,r){for(var a=t._physicalObjectsMap[e],s=t._physicalObjectsMap[r],l=a.collider.entity._scripts,c=0,u=l.length;c<u;c++){var h=l.get(c);h._waitHandlingInValid||h.onTriggerEnter(s)}l=s.collider.entity._scripts;for(var d=0,f=l.length;d<f;d++){var _=l.get(d);_._waitHandlingInValid||_.onTriggerEnter(a)}},this._onTriggerExit=function(e,r){for(var a=t._physicalObjectsMap[e],s=t._physicalObjectsMap[r],l=a.collider.entity._scripts,c=0,u=l.length;c<u;c++){var h=l.get(c);h._waitHandlingInValid||h.onTriggerExit(s)}l=s.collider.entity._scripts;for(var d=0,f=l.length;d<f;d++){var _=l.get(d);_._waitHandlingInValid||_.onTriggerExit(a)}},this._onTriggerStay=function(e,r){for(var a=t._physicalObjectsMap[e],s=t._physicalObjectsMap[r],l=a.collider.entity._scripts,c=0,u=l.length;c<u;c++){var h=l.get(c);h._waitHandlingInValid||h.onTriggerStay(s)}l=s.collider.entity._scripts;for(var d=0,f=l.length;d<f;d++){var _=l.get(d);_._waitHandlingInValid||_.onTriggerStay(a)}},this.fixedTimeStep=1/60,this.maxSumTimeStep=1/3,this._engine=n}var o=i.prototype;return o.initialize=function(t){this._initialized||(i._nativePhysics=t,this._nativePhysicsManager=i._nativePhysics.createPhysicsManager(this._onContactEnter,this._onContactExit,this._onContactStay,this._onTriggerEnter,this._onTriggerExit,this._onTriggerStay),this._initialized=!0)},o.raycast=function(t,e,r,a){var s=this,l,c=Number.MAX_VALUE;typeof e=="number"?c=e:e!=null&&(l=e);var u=Ot.Everything;if(typeof r=="number"?u=r:r!=null&&(l=r),a&&(l=a),l!=null){var h=this._nativePhysicsManager.raycast(t,c,function(d,f,_,g){l.entity=s._physicalObjectsMap[d]._collider.entity,l.distance=f,l.normal.copyFrom(g),l.point.copyFrom(_)});return h?l.entity.layer&u?!0:(l.entity=null,l.distance=0,l.point.set(0,0,0),l.normal.set(0,0,0),!1):!1}else return this._nativePhysicsManager.raycast(t,c)},o._update=function(t){var e=this.fixedTimeStep,r=this._nativePhysicsManager,a=this._engine._componentsManager,s=t+this._restTime,l=Math.floor(Math.min(this.maxSumTimeStep,s)/e);this._restTime=s-l*e;for(var c=0;c<l;c++)a.callScriptOnPhysicsUpdate(),this._callColliderOnUpdate(),r.update(e),this._callColliderOnLateUpdate()},o._addColliderShape=function(t){this._physicalObjectsMap[t.id]=t,this._nativePhysicsManager.addColliderShape(t._nativeShape)},o._removeColliderShape=function(t){delete this._physicalObjectsMap[t.id],this._nativePhysicsManager.removeColliderShape(t._nativeShape)},o._addCollider=function(t){t._index===-1&&(t._index=this._colliders.length,this._colliders.add(t)),this._nativePhysicsManager.addCollider(t._nativeCollider)},o._addCharacterController=function(t){t._index===-1&&(t._index=this._colliders.length,this._colliders.add(t)),this._nativePhysicsManager.addCharacterController(t._nativeCollider)},o._removeCollider=function(t){var e=this._colliders.deleteByIndex(t._index);e&&(e._index=t._index),t._index=-1,this._nativePhysicsManager.removeCollider(t._nativeCollider)},o._removeCharacterController=function(t){var e=this._colliders.deleteByIndex(t._index);e&&(e._index=t._index),t._index=-1,this._nativePhysicsManager.removeCharacterController(t._nativeCollider)},o._callColliderOnUpdate=function(){for(var t=this._colliders._elements,e=this._colliders.length-1;e>=0;--e)t[e]._onUpdate()},o._callColliderOnLateUpdate=function(){for(var t=this._colliders._elements,e=this._colliders.length-1;e>=0;--e)t[e]._onLateUpdate()},te(i,[{key:"gravity",get:function(){return this._gravity},set:function(t){var e=this._gravity;e!==t&&e.copyFrom(t),this._nativePhysicsManager.setGravity(e)}}]),i}();kt._nativePhysics=void 0;var Pn;(function(i){i[i.Average=0]="Average",i[i.Minimum=1]="Minimum",i[i.Multiply=2]="Multiply",i[i.Maximum=3]="Maximum"})(Pn||(Pn={}));var vh=function(){function i(){this._bounciness=.1,this._dynamicFriction=.1,this._staticFriction=.1,this._bounceCombine=Pn.Average,this._frictionCombine=Pn.Average,this._nativeMaterial=void 0,this._nativeMaterial=kt._nativePhysics.createPhysicsMaterial(this._staticFriction,this._dynamicFriction,this._bounciness,this._bounceCombine,this._frictionCombine)}var o=i.prototype;return o._destroy=function(){this._nativeMaterial.destroy()},te(i,[{key:"bounciness",get:function(){return this._bounciness},set:function(t){this._bounciness=t,this._nativeMaterial.setBounciness(t)}},{key:"dynamicFriction",get:function(){return this._dynamicFriction},set:function(t){this._dynamicFriction=t,this._nativeMaterial.setDynamicFriction(t)}},{key:"staticFriction",get:function(){return this._staticFriction},set:function(t){this._staticFriction=t,this._nativeMaterial.setStaticFriction(t)}},{key:"bounceCombine",get:function(){return this._bounceCombine},set:function(t){this._bounceCombine=t,this._nativeMaterial.setBounceCombine(t)}},{key:"frictionCombine",get:function(){return this._frictionCombine},set:function(t){this._frictionCombine=t,this._nativeMaterial.setFrictionCombine(t)}}]),i}(),as,os,Ma,ss,ci=(as=In($t),as(os=(Ma=function(i){J(o,i);function o(t){var e;return e=i.call(this,t)||this,U(e,"_index",ss,z(e)),e._nativeCollider=void 0,e._updateFlag=void 0,e._shapes=[],e._updateFlag=e.entity.transform.registerWorldChangeFlag(),e}var n=o.prototype;return n.addShape=function(e){var r=e._collider;r!==this&&(r&&r.removeShape(e),this._shapes.push(e),this.engine.physicsManager._addColliderShape(e),e._collider=this,this._nativeCollider.addShape(e._nativeShape))},n.removeShape=function(e){var r=this._shapes.indexOf(e);r!==-1&&(this._shapes.splice(r,1),this.engine.physicsManager._removeColliderShape(e),e._collider=null,this._nativeCollider.removeShape(e._nativeShape))},n.clearShapes=function(){for(var e=this._shapes,r=0,a=e.length;r<a;r++){var s=e[r];this.engine.physicsManager._removeColliderShape(s),s._destroy(),this._nativeCollider.removeShape(s._nativeShape)}e.length=0},n._onUpdate=function(){if(this._updateFlag.flag){var e=this.entity.transform;this._nativeCollider.setWorldTransform(e.worldPosition,e.worldRotationQuaternion);for(var r=e.lossyWorldScale,a=0,s=this.shapes.length;a<s;a++)this.shapes[a]._nativeShape.setWorldScale(r);this._updateFlag.flag=!1}},n._onLateUpdate=function(){},n._onEnable=function(){this.engine.physicsManager._addCollider(this)},n._onDisable=function(){this.engine.physicsManager._removeCollider(this)},n._onDestroy=function(){this.clearShapes(),this._nativeCollider.destroy()},te(o,[{key:"shapes",get:function(){return this._shapes}}]),o}(ar),ss=k(Ma.prototype,"_index",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ma))||os),na;(function(i){i[i.PreventClimbing=0]="PreventClimbing",i[i.PreventClimbingAndForceSliding=1]="PreventClimbingAndForceSliding"})(na||(na={}));var Nd=function(i){J(o,i);function o(t){var e;return e=i.call(this,t)||this,e._index=-1,e._stepOffset=0,e._nonWalkableMode=na.PreventClimbing,e._upDirection=new T(0,1,0),e._slopeLimit=0,e._nativeCollider=kt._nativePhysics.createCharacterController(),e}var n=o.prototype;return n.move=function(e,r,a){return this._nativeCollider.move(e,r,a)},n.addShape=function(e){if(this._shapes.length>0)throw"only allow single shape on controller!";i.prototype.addShape.call(this,e)},n.clearShapes=function(){this._shapes.length>0&&i.prototype.removeShape.call(this,this._shapes[0])},n._onUpdate=function(){if(this._updateFlag.flag){var e=this.entity.transform;this._nativeCollider.setWorldPosition(e.worldPosition);for(var r=e.lossyWorldScale,a=0,s=this.shapes.length;a<s;a++)this.shapes[a]._nativeShape.setWorldScale(r);this._updateFlag.flag=!1}},n._onLateUpdate=function(){var e=this.entity.transform.worldPosition;this._nativeCollider.getWorldPosition(e),this.entity.transform.worldPosition=e,this._updateFlag.flag=!1},n._onEnable=function(){this.engine.physicsManager._addCharacterController(this)},n._onDisable=function(){this.engine.physicsManager._removeCharacterController(this)},te(o,[{key:"stepOffset",get:function(){return this._stepOffset},set:function(e){this._stepOffset=e,this._nativeCollider.setStepOffset(e)}},{key:"nonWalkableMode",get:function(){return this._nonWalkableMode},set:function(e){this._nonWalkableMode=e,this._nativeCollider.setNonWalkableMode(e)}},{key:"upDirection",get:function(){return this._upDirection},set:function(e){this._upDirection!==e&&this._upDirection.copyFrom(e),this._nativeCollider.setUpDirection(this._upDirection)}},{key:"slopeLimit",get:function(){return this._slopeLimit},set:function(e){this._slopeLimit=e,this._nativeCollider.setSlopeLimit(e)}}]),o}(ci),an=function(){function i(){this._collider=void 0,this._nativeShape=void 0,this._id=void 0,this._position=new T,this._material=void 0,this._isTrigger=!1,this._isSceneQuery=!0,this._contactOffset=0,this._material=new vh,this._id=i._idGenerator++}var o=i.prototype;return o.setPosition=function(t,e,r){this._position.set(t,e,r),this._nativeShape.setPosition(this._position)},o._destroy=function(){this._material._destroy(),this._nativeShape.destroy()},te(i,[{key:"collider",get:function(){return this._collider}},{key:"id",get:function(){return this._id}},{key:"contactOffset",get:function(){return this._contactOffset},set:function(t){this._contactOffset=t,this._nativeShape.setContactOffset(t)}},{key:"material",get:function(){return this._material},set:function(t){this._material=t,this._nativeShape.setMaterial(t._nativeMaterial)}},{key:"position",get:function(){return this._position},set:function(t){this._position!==t&&this._position.copyFrom(t),this._nativeShape.setPosition(t)}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(t){this._isTrigger=t,this._nativeShape.setIsTrigger(t)}}]),i}();an._idGenerator=0;var Ud=function(i){J(o,i);function o(){var t;return t=i.call(this)||this,t._size=new T(1,1,1),t._nativeShape=kt._nativePhysics.createBoxColliderShape(t._id,t._size,t._material._nativeMaterial),t}var n=o.prototype;return n.setSize=function(e,r,a){this._size.x=e,this._size.y=r,this._size.z=a,this._nativeShape.setSize(this._size)},te(o,[{key:"size",get:function(){return this._size},set:function(e){this._size!=e&&this._size.copyFrom(e),this._nativeShape.setSize(e)}}]),o}(an),kd=function(i){J(o,i);function o(){var n;return n=i.call(this)||this,n._radius=1,n._nativeShape=kt._nativePhysics.createSphereColliderShape(n._id,n._radius,n._material._nativeMaterial),n}return te(o,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t,this._nativeShape.setRadius(t)}}]),o}(an),Vd=function(i){J(o,i);function o(){var t;return t=i.call(this)||this,t._rotation=new T,t._nativeShape=kt._nativePhysics.createPlaneColliderShape(t._id,t._material._nativeMaterial),t}var n=o.prototype;return n.setRotation=function(e,r,a){this._rotation.set(e,r,a),this._nativeShape.setRotation(this._rotation)},te(o,[{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation!=e&&this._rotation.copyFrom(e),this._nativeShape.setRotation(e)}}]),o}(an),Mn;(function(i){i[i.X=0]="X",i[i.Y=1]="Y",i[i.Z=2]="Z"})(Mn||(Mn={}));var Gd=function(i){J(o,i);function o(){var n;return n=i.call(this)||this,n._radius=1,n._height=2,n._upAxis=Mn.Y,n._nativeShape=kt._nativePhysics.createCapsuleColliderShape(n._id,n._radius,n._height,n._material._nativeMaterial),n._nativeShape.setUpAxis(Mn.Y),n}return te(o,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t,this._nativeShape.setRadius(t)}},{key:"height",get:function(){return this._height},set:function(t){this._height=t,this._nativeShape.setHeight(t)}},{key:"upAxis",get:function(){return this._upAxis},set:function(t){this._upAxis=t,this._nativeShape.setUpAxis(t)}}]),o}(an),ls,cs,ga=(ls=In(ci),ls(cs=function(i){J(o,i);function o(n){var t;return t=i.call(this,n)||this,t._connectedCollider=new us,t._collider=new us,t._nativeJoint=void 0,t._force=0,t._torque=0,t._connectedCollider.localPosition=new T,t}return te(o,[{key:"connectedCollider",get:function(){return this._connectedCollider.collider},set:function(t){this._connectedCollider.collider!==t&&(this._connectedCollider.collider=t,this._nativeJoint.setConnectedCollider(t._nativeCollider))}},{key:"connectedAnchor",get:function(){return this._connectedCollider.localPosition},set:function(t){var e=this._connectedCollider.localPosition;t!==e&&e.copyFrom(t),this._nativeJoint.setConnectedAnchor(t)}},{key:"connectedMassScale",get:function(){return this._connectedCollider.massScale},set:function(t){t!==this._connectedCollider.massScale&&(this._connectedCollider.massScale=t,this._nativeJoint.setConnectedMassScale(t))}},{key:"connectedInertiaScale",get:function(){return this._connectedCollider.inertiaScale},set:function(t){t!==this._connectedCollider.inertiaScale&&(this._connectedCollider.inertiaScale=t,this._nativeJoint.setConnectedInertiaScale(t))}},{key:"massScale",get:function(){return this._collider.massScale},set:function(t){t!==this._collider.massScale&&(this._collider.massScale=t,this._nativeJoint.setMassScale(t))}},{key:"inertiaScale",get:function(){return this._collider.inertiaScale},set:function(t){t!==this._collider.inertiaScale&&(this._collider.inertiaScale=t,this._nativeJoint.setInertiaScale(t))}},{key:"breakForce",get:function(){return this._force},set:function(t){t!==this._force&&(this._force=t,this._nativeJoint.setBreakForce(t))}},{key:"breakTorque",get:function(){return this._torque},set:function(t){t!==this._torque&&(this._torque=t,this._nativeJoint.setBreakTorque(t))}}]),o}(ar))||cs),us=function(){this.collider=null,this.localPosition=void 0,this.localRotation=void 0,this.massScale=0,this.inertiaScale=0},Hd=function(i){J(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n._onAwake=function(){var e=this._collider;e.collider=this.entity.getComponent(ci),this._nativeJoint=kt._nativePhysics.createFixedJoint(e.collider._nativeCollider)},o}(ga),hr;(function(i){i[i.LimitEnabled=1]="LimitEnabled",i[i.DriveEnabled=2]="DriveEnabled",i[i.DriveFreeSpin=4]="DriveFreeSpin"})(hr||(hr={}));var Wd=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t._axis=new T(1,0,0),t._hingeFlags=0,t._useSpring=!1,t._jointMonitor=void 0,t._limits=void 0,t}var n=o.prototype;return n._onAwake=function(){var e=this._collider;e.localPosition=new T,e.collider=this.entity.getComponent(ci),this._nativeJoint=kt._nativePhysics.createHingeJoint(e.collider._nativeCollider)},te(o,[{key:"axis",get:function(){return this._axis},set:function(e){var r=this._axis;e!==r&&r.copyFrom(e),this._nativeJoint.setAxis(r)}},{key:"swingOffset",get:function(){return this._collider.localPosition},set:function(e){var r=this._collider.localPosition;e!==r&&r.copyFrom(e),this._nativeJoint.setSwingOffset(r)}},{key:"angle",get:function(){return this._nativeJoint.getAngle()}},{key:"velocity",get:function(){return this._nativeJoint.getVelocity()}},{key:"useLimits",get:function(){return(this._hingeFlags&hr.LimitEnabled)==hr.LimitEnabled},set:function(e){e!==this.useLimits&&(this._hingeFlags|=hr.LimitEnabled),this._nativeJoint.setHingeJointFlag(hr.LimitEnabled,e)}},{key:"useMotor",get:function(){return(this._hingeFlags&hr.DriveEnabled)==hr.DriveEnabled},set:function(e){e!==this.useMotor&&(this._hingeFlags|=hr.DriveEnabled),this._nativeJoint.setHingeJointFlag(hr.DriveEnabled,e)}},{key:"useSpring",get:function(){return this._useSpring},set:function(e){this._useSpring=e,this.limits=this._limits}},{key:"motor",get:function(){return this._jointMonitor},set:function(e){this._jointMonitor=e,this._nativeJoint.setDriveVelocity(e.targetVelocity),this._nativeJoint.setDriveForceLimit(e.forceLimit),this._nativeJoint.setDriveGearRatio(e.gearRation),this._nativeJoint.setHingeJointFlag(hr.DriveFreeSpin,e.freeSpin)}},{key:"limits",get:function(){return this._limits},set:function(e){this._limits=e,this.useSpring?this._nativeJoint.setSoftLimit(e.min,e.max,e.stiffness,e.damping):this._nativeJoint.setHardLimit(e.min,e.max,e.contactDistance)}}]),o}(ga),Xd=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t._minDistance=0,t._maxDistance=0,t._tolerance=.25,t._stiffness=0,t._damping=0,t}var n=o.prototype;return n._onAwake=function(){var e=this._collider;e.localPosition=new T,e.collider=this.entity.getComponent(ci),this._nativeJoint=kt._nativePhysics.createSpringJoint(e.collider._nativeCollider)},te(o,[{key:"swingOffset",get:function(){return this._collider.localPosition},set:function(e){var r=this._collider.localPosition;e!==r&&r.copyFrom(e),this._nativeJoint.setSwingOffset(e)}},{key:"minDistance",get:function(){return this._minDistance},set:function(e){this._minDistance=e,this._nativeJoint.setMinDistance(e)}},{key:"maxDistance",get:function(){return this._maxDistance},set:function(e){this._maxDistance=e,this._nativeJoint.setMaxDistance(e)}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance=e,this._nativeJoint.setTolerance(e)}},{key:"stiffness",get:function(){return this._stiffness},set:function(e){this._stiffness=e,this._nativeJoint.setStiffness(e)}},{key:"damping",get:function(){return this._damping},set:function(e){this._damping=e,this._nativeJoint.setDamping(e)}}]),o}(ga),jd=function(){this.max=0,this.min=0,this.contactDistance=-1,this.stiffness=0,this.damping=0},$d=function(){this.targetVelocity=0,this.forceLimit=Number.MAX_VALUE,this.gearRation=1,this.freeSpin=!1},Ha;(function(i){i[i.Sides=1]="Sides",i[i.Up=2]="Up",i[i.Down=4]="Down"})(Ha||(Ha={}));var qd=function(i){J(o,i);function o(n){var t;t=i.call(this,n)||this;var e=t.entity.transform;return t._nativeCollider=kt._nativePhysics.createStaticCollider(e.worldPosition,e.worldRotationQuaternion),t}return o}(ci),Yd=function(i){J(o,i);function o(t){var e;e=i.call(this,t)||this,e._linearDamping=0,e._angularDamping=0,e._linearVelocity=new T,e._angularVelocity=new T,e._mass=0,e._centerOfMass=new T,e._inertiaTensor=new T,e._maxAngularVelocity=0,e._maxDepenetrationVelocity=0,e._sleepThreshold=0,e._solverIterations=0,e._isKinematic=!1,e._constraints=0,e._collisionDetectionMode=aa.Discrete;var r=e.entity.transform;return e._nativeCollider=kt._nativePhysics.createDynamicCollider(r.worldPosition,r.worldRotationQuaternion),e}var n=o.prototype;return n.applyForce=function(e){this._nativeCollider.addForce(e)},n.applyTorque=function(e){this._nativeCollider.addTorque(e)},n.move=function(e,r){this._nativeCollider.move(e,r)},n.sleep=function(){this._nativeCollider.sleep()},n.wakeUp=function(){this._nativeCollider.wakeUp()},n._onLateUpdate=function(){var e=this.entity.transform,r=e.worldPosition,a=e.worldRotationQuaternion;this._nativeCollider.getWorldTransform(r,a),e.worldPosition=r,e.worldRotationQuaternion=a,this._updateFlag.flag=!1},te(o,[{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._nativeCollider.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._nativeCollider.setAngularDamping(e)}},{key:"linearVelocity",get:function(){return this._linearVelocity},set:function(e){this._linearVelocity!==e&&this._linearVelocity.copyFrom(e),this._nativeCollider.setLinearVelocity(this._linearVelocity)}},{key:"angularVelocity",get:function(){return this._angularVelocity},set:function(e){this._angularVelocity!==e&&this._angularVelocity.copyFrom(e),this._nativeCollider.setAngularVelocity(this._angularVelocity)}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass=e,this._nativeCollider.setMass(e)}},{key:"centerOfMass",get:function(){return this._centerOfMass},set:function(e){this._centerOfMass!==e&&this._centerOfMass.copyFrom(e),this._nativeCollider.setCenterOfMass(this._centerOfMass)}},{key:"inertiaTensor",get:function(){return this._inertiaTensor},set:function(e){this._inertiaTensor!==e&&this._inertiaTensor.copyFrom(e),this._nativeCollider.setInertiaTensor(this._inertiaTensor)}},{key:"maxAngularVelocity",get:function(){return this._maxAngularVelocity},set:function(e){this._maxAngularVelocity=e,this._nativeCollider.setMaxAngularVelocity(e)}},{key:"maxDepenetrationVelocity",get:function(){return this._maxDepenetrationVelocity},set:function(e){this._maxDepenetrationVelocity=e,this._nativeCollider.setMaxDepenetrationVelocity(e)}},{key:"sleepThreshold",get:function(){return this._sleepThreshold},set:function(e){this._sleepThreshold=e,this._nativeCollider.setSleepThreshold(e)}},{key:"solverIterations",get:function(){return this._solverIterations},set:function(e){this._solverIterations=e,this._nativeCollider.setSolverIterations(e)}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e,this._nativeCollider.setIsKinematic(e)}},{key:"constraints",get:function(){return this._constraints},set:function(e){this._constraints=e,this._nativeCollider.setConstraints(e)}},{key:"collisionDetectionMode",get:function(){return this._collisionDetectionMode},set:function(e){this._collisionDetectionMode=e,this._nativeCollider.setCollisionDetectionMode(e)}}]),o}(ci),aa;(function(i){i[i.Discrete=0]="Discrete",i[i.Continuous=1]="Continuous",i[i.ContinuousDynamic=2]="ContinuousDynamic",i[i.ContinuousSpeculative=3]="ContinuousSpeculative"})(aa||(aa={}));var Wa;(function(i){i[i.None=0]="None",i[i.FreezePositionX=1]="FreezePositionX",i[i.FreezePositionY=2]="FreezePositionY",i[i.FreezePositionZ=4]="FreezePositionZ",i[i.FreezeRotationX=8]="FreezeRotationX",i[i.FreezeRotationY=16]="FreezeRotationY",i[i.FreezeRotationZ=32]="FreezeRotationZ"})(Wa||(Wa={}));var dr;(function(i){i[i.Down=0]="Down",i[i.Move=1]="Move",i[i.Up=2]="Up",i[i.Leave=3]="Leave"})(dr||(dr={}));var ri;(function(i){i[i.Primary=0]="Primary",i[i.Auxiliary=1]="Auxiliary",i[i.Secondary=2]="Secondary",i[i.XButton1=3]="XButton1",i[i.XButton2=4]="XButton2",i[i.XButton3=5]="XButton3",i[i.XButton4=6]="XButton4",i[i.XButton5=7]="XButton5",i[i.XButton6=8]="XButton6",i[i.XButton7=9]="XButton7",i[i.XButton8=10]="XButton8"})(ri||(ri={}));var ph=function(o){this.id=void 0,this.phase=dr.Leave,this.position=new q,this._uniqueID=void 0,this.id=o},en=function(){function i(n,t){this._pointers=[],this._movingDelta=new q,this._multiPointerEnabled=!0,this._buttons=0,this._upMap=[],this._downMap=[],this._downList=new Dt,this._upList=new Dt,this._currentPosition=new q,this._currentPressedEntity=void 0,this._currentEnteredEntity=void 0,this._engine=void 0,this._canvas=void 0,this._htmlCanvas=void 0,this._nativeEvents=[],this._pointerPool=void 0,this._keyEventList=[],this._keyEventCount=0,this._needOverallPointers=!1,this._hadListener=!1,this._lastPositionFrameCount=0,this._engine=n,this._canvas=n.canvas,this._htmlCanvas=t,t.oncontextmenu=function(r){return!1};var e=this._onPointerEvent=this._onPointerEvent.bind(this);t.addEventListener("pointerdown",e),t.addEventListener("pointerup",e),t.addEventListener("pointerout",e),t.addEventListener("pointermove",e),this._hadListener=!0,this._pointerPool=new Array(11)}var o=i.prototype;return o._update=function(t){if(this._needOverallPointers&&this._overallPointers(),this._downList.length=0,this._upList.length=0,this._movingDelta.set(0,0),this._nativeEvents.length>0&&this._handlePointerEvent(this._nativeEvents,t),this._engine.physicsManager._initialized){var e=this._pointerRayCast(),r=this._keyEventCount;if(r>0){for(var a=this._keyEventList,s=0;s<r;s++)switch(a[s]){case Qr.Down:this._firePointerDown(e);break;case Qr.Up:this._firePointerUpAndClick(e);break}this._firePointerExitAndEnter(e),a[r-1]===Qr.Leave&&(this._currentPressedEntity=null),this._keyEventCount=0}else this._firePointerDrag(),this._firePointerExitAndEnter(e)}},o._onFocus=function(){if(!this._hadListener){var t=this._htmlCanvas,e=this._onPointerEvent;t.addEventListener("pointerdown",e),t.addEventListener("pointerup",e),t.addEventListener("pointerout",e),t.addEventListener("pointermove",e),this._hadListener=!0}},o._onBlur=function(){if(this._hadListener){var t=this._htmlCanvas,e=this._onPointerEvent;t.removeEventListener("pointerdown",e),t.removeEventListener("pointerup",e),t.removeEventListener("pointerout",e),t.removeEventListener("pointermove",e),this._nativeEvents.length=0,this._pointerPool.length=0,this._currentEnteredEntity=null,this._currentPressedEntity=null,this._downList.length=0,this._upList.length=0,this._hadListener=!1}},o._destroy=function(){if(this._hadListener){var t=this._htmlCanvas,e=this._onPointerEvent;t.removeEventListener("pointerdown",e),t.removeEventListener("pointerup",e),t.removeEventListener("pointerout",e),t.removeEventListener("pointermove",e),this._hadListener=!1}this._nativeEvents.length=0,this._pointerPool.length=0,this._pointers.length=0,this._currentPosition=null,this._currentEnteredEntity=null,this._currentPressedEntity=null,this._engine=null,this._canvas=null},o._onPointerEvent=function(t){t.cancelable&&t.preventDefault(),t.type==="pointerdown"&&this._htmlCanvas.focus(),this._nativeEvents.push(t)},o._overallPointers=function(){for(var t=this._pointers,e=0,r=t.length,a=0;a<r;a++)t[a].phase===dr.Leave?e++:e>0&&(t[a-e]=t[a]);t.length=r-e,this._needOverallPointers=!1},o._getIndexByPointerID=function(t){for(var e=this._pointers,r=e.length-1;r>=0;r--)if(e[r]._uniqueID===t)return r;return-1},o._addPointer=function(t,e,r,a){var s=this._pointers,l=s.length;if(l===0||this._multiPointerEnabled){for(var c=this._pointerPool,u=0;u<l&&!(s[u].id>u);u++);var h=c[u];h||(h=c[u]=new ph(u)),h._uniqueID=t,h.position.set(e,r),h.phase=a,s.splice(u,0,h)}},o._removePointer=function(t){var e=this._pointers[t];e.phase=dr.Leave},o._updatePointer=function(t,e,r,a){var s=this._pointers[t];s.position.set(e,r),s.phase=a},o._handlePointerEvent=function(t,e){for(var r=this._pointers,a=this._keyEventList,s=this._upMap,l=this._downMap,c=this._upList,u=this._downList,h=r.length,d=this._canvas.width/this._htmlCanvas.clientWidth,f=this._canvas.height/this._htmlCanvas.clientHeight,_=t.length,g=0;g<_;g++){var v=t[g],p=v.button|ri.Primary,m=this._getIndexByPointerID(v.pointerId);switch(v.type){case"pointerdown":m===-1?(this._addPointer(v.pointerId,v.offsetX*d,v.offsetY*f,dr.Down),h++):this._updatePointer(m,v.offsetX*d,v.offsetY*f,dr.Down),h===1&&(a[this._keyEventCount++]=Qr.Down),u.add(p),l[p]=e;break;case"pointerup":m>=0&&(this._updatePointer(m,v.offsetX*d,v.offsetY*f,dr.Up),h===1&&(a[this._keyEventCount++]=Qr.Up)),c.add(p),s[p]=e;break;case"pointermove":m===-1?(this._addPointer(v.pointerId,v.offsetX*d,v.offsetY*f,dr.Move),h++):this._updatePointer(m,v.offsetX*d,v.offsetY*f,dr.Move);break;case"pointerout":m>=0&&(this._removePointer(m),--h===0&&(a[this._keyEventCount++]=Qr.Leave),this._needOverallPointers=!0);break}}this._buttons=t[_-1].buttons;var y=r.length;if(y>0){var x=this._currentPosition,S=x.x,w=x.y;if(h===0){var b=t[_-1];x.set(b.offsetX*d,b.offsetY*f)}else{x.set(0,0);for(var A=0;A<y;A++)x.add(r[A].position);x.scale(1/y)}this._lastPositionFrameCount===e-1&&this._movingDelta.set(x.x-S,x.y-w),this._lastPositionFrameCount=e}t.length=0},o._pointerRayCast=function(){if(this._pointers.length>0)for(var t=i._tempPoint,e=i._tempRay,r=i._tempHitResult,a=this._engine.sceneManager.activeScene._activeCameras,s=this._currentPosition.x/this._canvas.width,l=this._currentPosition.y/this._canvas.height,c=a.length-1;c>=0;c--){var u=a[c];if(!(!u.enabled||u.renderTarget)){var h=u.viewport,d=h.x,f=h.y,_=h.z,g=h.w;if(s>=d&&l>=f&&s-d<=_&&l-f<=g){if(t.set((s-d)/_,(l-f)/g),this._engine.physicsManager.raycast(u.viewportPointToRay(t,e),Number.MAX_VALUE,u.cullingMask,r))return r.entity;if(u.clearFlags&vr.Color)return null}}}return null},o._firePointerDrag=function(){if(this._currentPressedEntity)for(var t=this._currentPressedEntity._scripts,e=t.length-1;e>=0;e--){var r=t.get(e);r._waitHandlingInValid||r.onPointerDrag()}},o._firePointerExitAndEnter=function(t){if(this._currentEnteredEntity!==t){if(this._currentEnteredEntity)for(var e=this._currentEnteredEntity._scripts,r=e.length-1;r>=0;r--){var a=e.get(r);a._waitHandlingInValid||a.onPointerExit()}if(t)for(var s=t._scripts,l=s.length-1;l>=0;l--){var c=s.get(l);c._waitHandlingInValid||c.onPointerEnter()}this._currentEnteredEntity=t}},o._firePointerDown=function(t){if(t)for(var e=t._scripts,r=e.length-1;r>=0;r--){var a=e.get(r);a._waitHandlingInValid||a.onPointerDown()}this._currentPressedEntity=t},o._firePointerUpAndClick=function(t){var e=this._currentPressedEntity;if(e){for(var r=e===t,a=e._scripts,s=a.length-1;s>=0;s--){var l=a.get(s);l._waitHandlingInValid||(r&&l.onPointerClick(),l.onPointerUp())}this._currentPressedEntity=null}},i}();en.Buttons=[1,4,2,8,16,32,64,128,256,512,1024];en._tempRay=new xd;en._tempPoint=new q;en._tempHitResult=new fh;var Qr;(function(i){i[i.Down=0]="Down",i[i.Up=1]="Up",i[i.Leave=2]="Leave"})(Qr||(Qr={}));var Qd=function(){function i(n){this._delta=new T,this._nativeEvents=[],this._canvas=void 0,this._hadListener=void 0,this._onWheelEvent=this._onWheelEvent.bind(this),n.addEventListener("wheel",this._onWheelEvent),this._canvas=n,this._hadListener=!0}var o=i.prototype;return o._update=function(){var t=this._delta;t.set(0,0,0);var e=this._nativeEvents;if(e.length>0){for(var r=e.length-1;r>=0;r--){var a=e[r];t.x+=a.deltaX,t.y+=a.deltaY,t.z+=a.deltaZ}e.length=0}},o._onFocus=function(){this._hadListener||(this._canvas.addEventListener("wheel",this._onWheelEvent),this._hadListener=!0)},o._onBlur=function(){this._hadListener&&(this._canvas.removeEventListener("wheel",this._onWheelEvent),this._nativeEvents.length=0,this._delta.set(0,0,0),this._hadListener=!1)},o._destroy=function(){this._hadListener&&(this._canvas.removeEventListener("wheel",this._onWheelEvent),this._hadListener=!1),this._nativeEvents=null},o._onWheelEvent=function(t){t.cancelable&&t.preventDefault(),this._nativeEvents.push(t)},i}(),gh=function(){var i=o.prototype;i.isKeyHeldDown=function(t){return this._initialized?t===void 0?this._keyboardManager._curFrameHeldDownList.length>0:this._keyboardManager._curHeldDownKeyToIndexMap[t]!=null:!1},i.isKeyDown=function(t){return this._initialized?t===void 0?this._keyboardManager._curFrameDownList.length>0:this._keyboardManager._downKeyToFrameCountMap[t]===this._curFrameCount:!1},i.isKeyUp=function(t){return this._initialized?t===void 0?this._keyboardManager._curFrameUpList.length>0:this._keyboardManager._upKeyToFrameCountMap[t]===this._curFrameCount:!1},i.isPointerHeldDown=function(t){return this._initialized?t===void 0?this._pointerManager._buttons!==0:(this._pointerManager._buttons&en.Buttons[t])!==0:!1},i.isPointerDown=function(t){return this._initialized?t===void 0?this._pointerManager._downList.length>0:this._pointerManager._downMap[t]===this._curFrameCount:!1},i.isPointerUp=function(t){return this._initialized?t===void 0?this._pointerManager._upList.length>0:this._pointerManager._upMap[t]===this._curFrameCount:!1};function o(n){this._initialized=!1,this._curFrameCount=0,this._wheelManager=void 0,this._pointerManager=void 0,this._keyboardManager=void 0;var t=n._canvas._webCanvas;(typeof OffscreenCanvas=="undefined"||!(t instanceof OffscreenCanvas))&&(this._wheelManager=new Qd(t),this._pointerManager=new en(n,t),this._keyboardManager=new Id(t),this._onBlur=this._onBlur.bind(this),window.addEventListener("blur",this._onBlur),this._onFocus=this._onFocus.bind(this),window.addEventListener("focus",this._onFocus),this._initialized=!0)}return i._update=function(){this._initialized&&(++this._curFrameCount,this._wheelManager._update(),this._pointerManager._update(this._curFrameCount),this._keyboardManager._update(this._curFrameCount))},i._destroy=function(){this._initialized&&(window.removeEventListener("blur",this._onBlur),window.removeEventListener("focus",this._onFocus),this._wheelManager._destroy(),this._pointerManager._destroy(),this._keyboardManager._destroy())},i._onBlur=function(){this._wheelManager._onBlur(),this._pointerManager._onBlur(),this._keyboardManager._onBlur()},i._onFocus=function(){this._wheelManager._onFocus(),this._pointerManager._onFocus(),this._keyboardManager._onFocus()},te(o,[{key:"pointers",get:function(){return this._initialized?this._pointerManager._pointers:null}},{key:"multiPointerEnabled",get:function(){return this._initialized?this._pointerManager._multiPointerEnabled:!1},set:function(t){this._initialized&&(this._pointerManager._multiPointerEnabled=t)}},{key:"wheelDelta",get:function(){return this._initialized?this._wheelManager._delta:null}},{key:"pointerMovingDelta",get:function(){return this._initialized?this._pointerManager._movingDelta:null}},{key:"pointerPosition",get:function(){return this._initialized&&this._pointerManager._pointers.length>0?this._pointerManager._currentPosition:null}}]),o}(),bt;(function(i){i[i.Opaque=0]="Opaque",i[i.AlphaTest=1]="AlphaTest",i[i.Transparent=2]="Transparent"})(bt||(bt={}));var Gr=function(i){J(o,i);function o(t){var e;return e=i.call(this,t)||this,e.isGCIgnored=!1,e._refCount=0,t.resourceManager._addRefObject(e.instanceId,z(e)),e}var n=o.prototype;return n.destroy=function(e){if(e===void 0&&(e=!1),this._destroyed)return!0;if(!e&&this._refCount!==0)return!1;var r=this._engine.resourceManager;r&&(i.prototype.destroy.call(this),r._deleteRefObject(this.instanceId));var a=this._getRefCount();return a>0&&this._addRefCount(-a),this._engine=null,this._onDestroy(),!0},n._getRefCount=function(){return this._refCount},n._addRefCount=function(e){this._refCount+=e},n._addToResourceManager=function(e){this._engine.resourceManager._addAsset(e,this)},te(o,[{key:"refCount",get:function(){return this._refCount}}]),o}(Vr),_r;(function(i){i[i.Scene=0]="Scene",i[i.Camera=1]="Camera",i[i.Renderer=2]="Renderer",i[i.Material=3]="Material"})(_r||(_r={}));var Rr=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t.name=void 0,t._platformTexture=void 0,t._mipmap=void 0,t._format=void 0,t._width=void 0,t._height=void 0,t._mipmapCount=void 0,t._wrapModeU=void 0,t._wrapModeV=void 0,t._filterMode=void 0,t._anisoLevel=1,t}var n=o.prototype;return n.generateMipmaps=function(){!this._mipmap||this._platformTexture.generateMipmaps()},n._onDestroy=function(){this._platformTexture.destroy(),this._platformTexture=null},n._getMaxMiplevel=function(e){return Math.floor(Math.log2(e))},n._getMipmapCount=function(){return this._mipmap?Math.floor(Math.log2(Math.max(this._width,this._height)))+1:1},te(o,[{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"wrapModeU",get:function(){return this._wrapModeU},set:function(e){e!==this._wrapModeU&&(this._wrapModeU=e,this._platformTexture.wrapModeU=e)}},{key:"wrapModeV",get:function(){return this._wrapModeV},set:function(e){e!==this._wrapModeV&&(this._wrapModeV=e,this._platformTexture.wrapModeV=e)}},{key:"mipmapCount",get:function(){return this._mipmapCount}},{key:"filterMode",get:function(){return this._filterMode},set:function(e){e!==this._filterMode&&(this._filterMode=e,this._platformTexture.filterMode=e)}},{key:"anisoLevel",get:function(){return this._anisoLevel},set:function(e){var r=this._engine._hardwareRenderer.capability.maxAnisoLevel;e>r&&(me.warn("anisoLevel:"+e+", exceeds the limit and is automatically downgraded to:"+r),e=r),e<1&&(me.warn("anisoLevel:"+e+", must be greater than 0, and is automatically downgraded to 1"),e=1),e!==this._anisoLevel&&(this._anisoLevel=e,this._platformTexture.anisoLevel=e)}}]),o}(Gr),Jd=`#define GLSLIFY 1
#define PI 3.14159265359
#define RECIPROCAL_PI 0.31830988618
#define EPSILON 1e-6
#define LOG2 1.442695
#define saturate( a ) clamp( a, 0.0, 1.0 )
#define whiteCompliment(a) ( 1.0 - saturate( a ) )
float pow2(float x){return x*x;}vec4 RGBMToLinear(vec4 value,float maxRange){return vec4(value.rgb*value.a*maxRange,1.0);}vec4 gammaToLinear(vec4 srgbIn){return vec4(pow(srgbIn.rgb,vec3(2.2)),srgbIn.a);}vec4 linearToGamma(vec4 linearIn){return vec4(pow(linearIn.rgb,vec3(1.0/2.2)),linearIn.a);}`,Zd=`#define GLSLIFY 1
attribute vec3 POSITION;
#ifdef O3_HAS_UV
attribute vec2 TEXCOORD_0;
#endif
#ifdef O3_HAS_UV1
attribute vec2 TEXCOORD_1;
#endif
#ifdef O3_HAS_SKIN
attribute vec4 JOINTS_0;attribute vec4 WEIGHTS_0;
#ifdef O3_USE_JOINT_TEXTURE
uniform sampler2D u_jointSampler;uniform float u_jointCount;mat4 getJointMatrix(sampler2D smp,float index){float base=index/u_jointCount;float hf=0.5/u_jointCount;float v=base+hf;vec4 m0=texture2D(smp,vec2(0.125,v));vec4 m1=texture2D(smp,vec2(0.375,v));vec4 m2=texture2D(smp,vec2(0.625,v));vec4 m3=texture2D(smp,vec2(0.875,v));return mat4(m0,m1,m2,m3);}
#else
uniform mat4 u_jointMatrix[O3_JOINTS_NUM];
#endif
#endif
#ifdef O3_HAS_VERTEXCOLOR
attribute vec4 COLOR_0;
#endif
uniform mat4 u_localMat;uniform mat4 u_modelMat;uniform mat4 u_viewMat;uniform mat4 u_projMat;uniform mat4 u_MVMat;uniform mat4 u_MVPMat;uniform mat4 u_normalMat;uniform vec3 u_cameraPos;uniform vec4 u_tilingOffset;
#ifndef OMIT_NORMAL
#ifdef O3_HAS_NORMAL
attribute vec3 NORMAL;
#endif
#ifdef O3_HAS_TANGENT
attribute vec4 TANGENT;
#endif
#endif
`,Kd=`#define GLSLIFY 1
uniform mat4 u_localMat;uniform mat4 u_modelMat;uniform mat4 u_viewMat;uniform mat4 u_projMat;uniform mat4 u_MVMat;uniform mat4 u_MVPMat;uniform mat4 u_normalMat;uniform vec3 u_cameraPos;`,e_=`#define GLSLIFY 1
#ifdef O3_HAS_VERTEXCOLOR
varying vec4 v_color;
#endif
`,t_=`#define GLSLIFY 1
#ifndef OMIT_NORMAL
#ifdef O3_HAS_NORMAL
varying vec3 v_normal;
#if defined(O3_HAS_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )
varying mat3 v_TBN;
#endif
#endif
#endif
`,r_=`#define GLSLIFY 1
varying vec2 v_uv;
#ifdef O3_HAS_UV1
varying vec2 v_uv1;
#endif
`,i_=`#define GLSLIFY 1
#ifdef O3_NEED_WORLDPOS
varying vec3 v_pos;
#endif
`,n_=`#define GLSLIFY 1
#ifdef O3_GENERATE_SHADOW_MAP
uniform mat4 u_viewMatFromLight;uniform mat4 u_projMatFromLight;
#endif
#ifdef O3_SHADOW_MAP_COUNT
uniform mat4 u_viewMatFromLight[O3_SHADOW_MAP_COUNT];uniform mat4 u_projMatFromLight[O3_SHADOW_MAP_COUNT];varying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];
#endif
`,a_=`#define GLSLIFY 1
#ifdef O3_HAS_FOG
varying vec3 v_fogDepth;uniform vec3 u_fogColor;
#ifdef O3_FOG_EXP2
uniform float u_fogDensity;
#else
uniform float u_fogNear;uniform float u_fogFar;
#endif
#endif
`,o_=`#define GLSLIFY 1
#ifndef OMIT_NORMAL
#ifdef O3_HAS_NORMAL
vec3 normal=vec3(NORMAL);
#endif
#ifdef O3_HAS_TANGENT
vec4 tangent=vec4(TANGENT);
#endif
#endif
`,s_=`#define GLSLIFY 1
vec4 position=vec4(POSITION,1.0);`,l_=`#define GLSLIFY 1
#ifndef O3_GENERATE_SHADOW_MAP
gl_Position=u_MVPMat*position;
#endif
`,c_=`#define GLSLIFY 1
#ifdef O3_HAS_VERTEXCOLOR
v_color=COLOR_0;
#endif
`,u_=`#define GLSLIFY 1
#ifndef OMIT_NORMAL
#ifdef O3_HAS_NORMAL
v_normal=normalize(mat3(u_normalMat)*normal);
#if defined(O3_HAS_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )
vec3 normalW=normalize(mat3(u_normalMat)*normal.xyz);vec3 tangentW=normalize(mat3(u_normalMat)*tangent.xyz);vec3 bitangentW=cross(normalW,tangentW)*tangent.w;v_TBN=mat3(tangentW,bitangentW,normalW);
#endif
#endif
#endif
`,h_=`#define GLSLIFY 1
#ifdef O3_HAS_SKIN
#ifdef O3_USE_JOINT_TEXTURE
mat4 skinMatrix=WEIGHTS_0.x*getJointMatrix(u_jointSampler,JOINTS_0.x)+WEIGHTS_0.y*getJointMatrix(u_jointSampler,JOINTS_0.y)+WEIGHTS_0.z*getJointMatrix(u_jointSampler,JOINTS_0.z)+WEIGHTS_0.w*getJointMatrix(u_jointSampler,JOINTS_0.w);
#else
mat4 skinMatrix=WEIGHTS_0.x*u_jointMatrix[int(JOINTS_0.x)]+WEIGHTS_0.y*u_jointMatrix[int(JOINTS_0.y)]+WEIGHTS_0.z*u_jointMatrix[int(JOINTS_0.z)]+WEIGHTS_0.w*u_jointMatrix[int(JOINTS_0.w)];
#endif
position=skinMatrix*position;
#if defined(O3_HAS_NORMAL) && !defined(OMIT_NORMAL)
normal=vec4(skinMatrix*vec4(normal,0.0)).xyz;
#if defined(O3_HAS_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )
tangent.xyz=vec4(skinMatrix*vec4(tangent.xyz,0.0)).xyz;
#endif
#endif
#endif
`,d_=`#define GLSLIFY 1
#ifdef OASIS_BLENDSHAPE
#ifdef OASIS_BLENDSHAPE_TEXTURE
uniform mediump sampler2DArray u_blendShapeTexture;uniform ivec3 u_blendShapeTextureInfo;uniform float u_blendShapeWeights[OASIS_BLENDSHAPE_COUNT];
#else
attribute vec3 POSITION_BS0;attribute vec3 POSITION_BS1;attribute vec3 POSITION_BS2;attribute vec3 POSITION_BS3;
#if defined( OASIS_BLENDSHAPE_NORMAL ) || defined( OASIS_BLENDSHAPE_TANGENT )
#ifdef OASIS_BLENDSHAPE_NORMAL
attribute vec3 NORMAL_BS0;attribute vec3 NORMAL_BS1;attribute vec3 NORMAL_BS2;attribute vec3 NORMAL_BS3;
#endif
#ifdef OASIS_BLENDSHAPE_TANGENT
attribute vec3 TANGENT_BS0;attribute vec3 TANGENT_BS1;attribute vec3 TANGENT_BS2;attribute vec3 TANGENT_BS3;
#endif
uniform float u_blendShapeWeights[4];
#else
attribute vec3 POSITION_BS4;attribute vec3 POSITION_BS5;attribute vec3 POSITION_BS6;attribute vec3 POSITION_BS7;uniform float u_blendShapeWeights[8];
#endif
#endif
#ifdef OASIS_BLENDSHAPE_TEXTURE
vec3 getBlendShapeVertexElement(int blendShapeIndex,int vertexElementIndex){int y=vertexElementIndex/u_blendShapeTextureInfo.y;int x=vertexElementIndex-y*u_blendShapeTextureInfo.y;ivec3 uv=ivec3(x,y,blendShapeIndex);return texelFetch(u_blendShapeTexture,uv,0).xyz;}
#endif
#endif
`,__=`#define GLSLIFY 1
#ifdef OASIS_BLENDSHAPE
#ifdef OASIS_BLENDSHAPE_TEXTURE
int vertexOffset=gl_VertexID*u_blendShapeTextureInfo.x;for(int i=0;i<OASIS_BLENDSHAPE_COUNT;i++){int vertexElementOffset=vertexOffset;float weight=u_blendShapeWeights[i];position.xyz+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;
#ifndef OMIT_NORMAL
#if defined( O3_HAS_NORMAL ) && defined( OASIS_BLENDSHAPE_NORMAL )
vertexElementOffset+=1;normal+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;
#endif
#if defined( O3_HAS_TANGENT ) && defined(OASIS_BLENDSHAPE_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )
vertexElementOffset+=1;tangent.xyz+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;
#endif
#endif
}
#else
position.xyz+=POSITION_BS0*u_blendShapeWeights[0];position.xyz+=POSITION_BS1*u_blendShapeWeights[1];position.xyz+=POSITION_BS2*u_blendShapeWeights[2];position.xyz+=POSITION_BS3*u_blendShapeWeights[3];
#if defined( OASIS_BLENDSHAPE_NORMAL ) || defined( OASIS_BLENDSHAPE_TANGENT )
#ifndef OMIT_NORMAL
#if defined( O3_HAS_NORMAL ) && defined( OASIS_BLENDSHAPE_NORMAL )
normal+=NORMAL_BS0*u_blendShapeWeights[0];normal+=NORMAL_BS1*u_blendShapeWeights[1];normal+=NORMAL_BS2*u_blendShapeWeights[2];normal+=NORMAL_BS3*u_blendShapeWeights[3];
#endif
#if defined( O3_HAS_TANGENT ) && defined(OASIS_BLENDSHAPE_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )
tangent.xyz+=TANGENT_BS0*u_blendShapeWeights[0];tangent.xyz+=TANGENT_BS1*u_blendShapeWeights[1];tangent.xyz+=TANGENT_BS2*u_blendShapeWeights[2];tangent.xyz+=TANGENT_BS3*u_blendShapeWeights[3];
#endif
#endif
#else
position.xyz+=POSITION_BS4*u_blendShapeWeights[4];position.xyz+=POSITION_BS5*u_blendShapeWeights[5];position.xyz+=POSITION_BS6*u_blendShapeWeights[6];position.xyz+=POSITION_BS7*u_blendShapeWeights[7];
#endif
#endif
#endif
`,f_=`#define GLSLIFY 1
#ifdef O3_HAS_UV
v_uv=TEXCOORD_0;
#else
v_uv=vec2(0.,0.);
#endif
#ifdef O3_HAS_UV1
v_uv1=TEXCOORD_1;
#endif
#ifdef O3_NEED_TILINGOFFSET
v_uv=v_uv*u_tilingOffset.xy+u_tilingOffset.zw;
#endif
`,v_=`#define GLSLIFY 1
#ifdef O3_NEED_WORLDPOS
vec4 temp_pos=u_modelMat*position;v_pos=temp_pos.xyz/temp_pos.w;
#endif
`,p_=`#define GLSLIFY 1
#ifdef O3_GENERATE_SHADOW_MAP
gl_Position=u_projMatFromLight*u_viewMatFromLight*u_modelMat*position;
#endif
#ifdef O3_SHADOW_MAP_COUNT
for(int i=0;i<O3_SHADOW_MAP_COUNT;i++){v_PositionFromLight[i]=u_projMatFromLight[i]*u_viewMatFromLight[i]*u_modelMat*vec4(POSITION,1.0);}
#endif
`,g_=`#define GLSLIFY 1
#ifdef O3_HAS_FOG
v_fogDepth=(u_MVMat*position).xyz;
#endif
`,m_=`#define GLSLIFY 1
#ifdef O3_DIRECT_LIGHT_COUNT
struct DirectLight{vec3 color;vec3 direction;};uniform vec3 u_directLightColor[O3_DIRECT_LIGHT_COUNT];uniform vec3 u_directLightDirection[O3_DIRECT_LIGHT_COUNT];
#endif
#ifdef O3_POINT_LIGHT_COUNT
struct PointLight{vec3 color;vec3 position;float distance;};uniform vec3 u_pointLightColor[O3_POINT_LIGHT_COUNT];uniform vec3 u_pointLightPosition[O3_POINT_LIGHT_COUNT];uniform float u_pointLightDistance[O3_POINT_LIGHT_COUNT];
#endif
#ifdef O3_SPOT_LIGHT_COUNT
struct SpotLight{vec3 color;vec3 position;vec3 direction;float distance;float angleCos;float penumbraCos;};uniform vec3 u_spotLightColor[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightPosition[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightDirection[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightDistance[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightAngleCos[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightPenumbraCos[O3_SPOT_LIGHT_COUNT];
#endif
struct EnvMapLight{vec3 diffuse;float mipMapLevel;float diffuseIntensity;float specularIntensity;};uniform EnvMapLight u_envMapLight;
#ifdef O3_USE_SH
uniform vec3 u_env_sh[9];
#endif
#ifdef O3_USE_SPECULAR_ENV
uniform samplerCube u_env_specularSampler;
#endif
`,y_=`#define GLSLIFY 1
uniform vec4 u_emissiveColor;uniform vec4 u_baseColor;uniform vec4 u_specularColor;uniform float u_shininess;uniform float u_normalIntensity;uniform float u_alphaCutoff;
#ifdef EMISSIVETEXTURE
uniform sampler2D u_emissiveTexture;
#endif
#ifdef BASETEXTURE
uniform sampler2D u_baseTexture;
#endif
#ifdef O3_SPECULAR_TEXTURE
uniform sampler2D u_specularTexture;
#endif
#ifdef NORMALTEXTURE
uniform sampler2D u_normalTexture;
#endif
`,x_=`#define GLSLIFY 1
#ifdef O3_HAS_FOG
float fogDepth=length(v_fogDepth);
#ifdef O3_FOG_EXP2
float fogFactor=whiteCompliment(exp2(-u_fogDensity*u_fogDensity*fogDepth*fogDepth*LOG2));
#else
float fogFactor=smoothstep(u_fogNear,u_fogFar,fogDepth);
#endif
gl_FragColor.rgb=mix(gl_FragColor.rgb,u_fogColor,fogFactor);
#endif
`,b_=`#define GLSLIFY 1
vec4 ambient=vec4(0.0);vec4 emission=u_emissiveColor;vec4 diffuse=u_baseColor;vec4 specular=u_specularColor;
#ifdef EMISSIVETEXTURE
vec4 emissiveTextureColor=texture2D(u_emissiveTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
emissiveTextureColor=gammaToLinear(emissiveTextureColor);
#endif
emission*=emissiveTextureColor;
#endif
#ifdef BASETEXTURE
vec4 diffuseTextureColor=texture2D(u_baseTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
diffuseTextureColor=gammaToLinear(diffuseTextureColor);
#endif
diffuse*=diffuseTextureColor;
#endif
#ifdef O3_HAS_VERTEXCOLOR
diffuse*=v_color;
#endif
#ifdef O3_SPECULAR_TEXTURE
vec4 specularTextureColor=texture2D(u_specularTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
specularTextureColor=gammaToLinear(specularTextureColor);
#endif
specular*=specularTextureColor;
#endif
ambient=vec4(u_envMapLight.diffuse*u_envMapLight.diffuseIntensity,1.0)*diffuse;`,w_=`#define GLSLIFY 1
#ifdef O3_NEED_WORLDPOS
vec3 V=normalize(u_cameraPos-v_pos);
#endif
`,S_=`#define GLSLIFY 1
#ifdef NORMALTEXTURE
mat3 tbn=getTBN();vec3 N=getNormalByNormalTexture(tbn,u_normalTexture,u_normalIntensity,v_uv);
#else
vec3 N=getNormal();
#endif
vec3 lightDiffuse=vec3(0.0,0.0,0.0);vec3 lightSpecular=vec3(0.0,0.0,0.0);
#ifdef O3_DIRECT_LIGHT_COUNT
DirectLight directionalLight;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){directionalLight.color=u_directLightColor[i];directionalLight.direction=u_directLightDirection[i];float d=max(dot(N,-directionalLight.direction),0.0);lightDiffuse+=directionalLight.color*d;vec3 halfDir=normalize(V-directionalLight.direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess);lightSpecular+=directionalLight.color*s;}
#endif
#ifdef O3_POINT_LIGHT_COUNT
PointLight pointLight;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){pointLight.color=u_pointLightColor[i];pointLight.position=u_pointLightPosition[i];pointLight.distance=u_pointLightDistance[i];vec3 direction=v_pos-pointLight.position;float dist=length(direction);direction/=dist;float decay=clamp(1.0-pow(dist/pointLight.distance,4.0),0.0,1.0);float d=max(dot(N,-direction),0.0)*decay;lightDiffuse+=pointLight.color*d;vec3 halfDir=normalize(V-direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decay;lightSpecular+=pointLight.color*s;}
#endif
#ifdef O3_SPOT_LIGHT_COUNT
SpotLight spotLight;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){spotLight.color=u_spotLightColor[i];spotLight.position=u_spotLightPosition[i];spotLight.direction=u_spotLightDirection[i];spotLight.distance=u_spotLightDistance[i];spotLight.angleCos=u_spotLightAngleCos[i];spotLight.penumbraCos=u_spotLightPenumbraCos[i];vec3 direction=spotLight.position-v_pos;float lightDistance=length(direction);direction/=lightDistance;float angleCos=dot(direction,-spotLight.direction);float decay=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayTotal=decay*spotEffect;float d=max(dot(N,direction),0.0)*decayTotal;lightDiffuse+=spotLight.color*d;vec3 halfDir=normalize(V+direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decayTotal;lightSpecular+=spotLight.color*s;}
#endif
diffuse*=vec4(lightDiffuse,1.0);specular*=vec4(lightSpecular,1.0);
#ifdef ALPHA_CUTOFF
if(diffuse.a<u_alphaCutoff){discard;}
#endif
`,C_=`#define GLSLIFY 1
vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec2 mod289(vec2 x){return x-floor(x*(1.0/289.0))*289.0;}float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod7(vec4 x){return x-floor(x*(1.0/7.0))*7.0;}vec3 mod7(vec3 x){return x-floor(x*(1.0/7.0))*7.0;}vec4 permute(vec4 x){return mod289((34.0*x+1.0)*x);}vec3 permute(vec3 x){return mod289((34.0*x+1.0)*x);}float permute(float x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float taylorInvSqrt(float r){return 1.79284291400159-0.85373472095314*r;}vec4 fade(vec4 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec3 fade(vec3 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec2 fade(vec2 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}
#define K 0.142857142857
#define Ko 0.428571428571
#define K2 0.020408163265306
#define Kd2 0.0714285714285
#define Kz 0.166666666667
#define Kzo 0.416666666667
#define jitter 1.0
#define jitter1 0.8
`,T_=`#define GLSLIFY 1
vec2 cellular(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec3 oi=vec3(-1.0,0.0,1.0);vec3 of=vec3(-0.5,0.5,1.5);vec3 px=permute(Pi.x+oi);vec3 p=permute(px.x+Pi.y+oi);vec3 ox=fract(p*K)-Ko;vec3 oy=mod7(floor(p*K))*K-Ko;vec3 dx=Pf.x+0.5+jitter*ox;vec3 dy=Pf.y-of+jitter*oy;vec3 d1=dx*dx+dy*dy;p=permute(px.y+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-0.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d2=dx*dx+dy*dy;p=permute(px.z+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-1.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d3=dx*dx+dy*dy;vec3 d1a=min(d1,d2);d2=max(d1,d2);d2=min(d2,d3);d1=min(d1a,d2);d2=max(d1a,d2);d1.xy=(d1.x<d1.y)? d1.xy : d1.yx;d1.xz=(d1.x<d1.z)? d1.xz : d1.zx;d1.yz=min(d1.yz,d2.yz);d1.y=min(d1.y,d1.z);d1.y=min(d1.y,d2.x);return sqrt(d1.xy);}`,A_=`#define GLSLIFY 1
vec2 cellular2x2(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec4 Pfx=Pf.x+vec4(-0.5,-1.5,-0.5,-1.5);vec4 Pfy=Pf.y+vec4(-0.5,-0.5,-1.5,-1.5);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 ox=mod7(p)*K+Kd2;vec4 oy=mod7(floor(p*K))*K+Kd2;vec4 dx=Pfx+jitter1*ox;vec4 dy=Pfy+jitter1*oy;vec4 d=dx*dx+dy*dy;d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.y=min(d.y,d.z);d.y=min(d.y,d.w);return sqrt(d.xy);}`,P_=`#define GLSLIFY 1
vec2 cellular2x2x2(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P);vec4 Pfx=Pf.x+vec4(0.0,-1.0,0.0,-1.0);vec4 Pfy=Pf.y+vec4(0.0,0.0,-1.0,-1.0);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 p1=permute(p+Pi.z);vec4 p2=permute(p+Pi.z+vec4(1.0));vec4 ox1=fract(p1*K)-Ko;vec4 oy1=mod7(floor(p1*K))*K-Ko;vec4 oz1=floor(p1*K2)*Kz-Kzo;vec4 ox2=fract(p2*K)-Ko;vec4 oy2=mod7(floor(p2*K))*K-Ko;vec4 oz2=floor(p2*K2)*Kz-Kzo;vec4 dx1=Pfx+jitter1*ox1;vec4 dy1=Pfy+jitter1*oy1;vec4 dz1=Pf.z+jitter1*oz1;vec4 dx2=Pfx+jitter1*ox2;vec4 dy2=Pfy+jitter1*oy2;vec4 dz2=Pf.z-1.0+jitter1*oz2;vec4 d1=dx1*dx1+dy1*dy1+dz1*dz1;vec4 d2=dx2*dx2+dy2*dy2+dz2*dz2;vec4 d=min(d1,d2);d2=max(d1,d2);d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.yzw=min(d.yzw,d2.yzw);d.y=min(d.y,d.z);d.y=min(d.y,d.w);d.y=min(d.y,d2.x);return sqrt(d.xy);}`,M_=`#define GLSLIFY 1
vec2 cellular(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P)-0.5;vec3 Pfx=Pf.x+vec3(1.0,0.0,-1.0);vec3 Pfy=Pf.y+vec3(1.0,0.0,-1.0);vec3 Pfz=Pf.z+vec3(1.0,0.0,-1.0);vec3 p=permute(Pi.x+vec3(-1.0,0.0,1.0));vec3 p1=permute(p+Pi.y-1.0);vec3 p2=permute(p+Pi.y);vec3 p3=permute(p+Pi.y+1.0);vec3 p11=permute(p1+Pi.z-1.0);vec3 p12=permute(p1+Pi.z);vec3 p13=permute(p1+Pi.z+1.0);vec3 p21=permute(p2+Pi.z-1.0);vec3 p22=permute(p2+Pi.z);vec3 p23=permute(p2+Pi.z+1.0);vec3 p31=permute(p3+Pi.z-1.0);vec3 p32=permute(p3+Pi.z);vec3 p33=permute(p3+Pi.z+1.0);vec3 ox11=fract(p11*K)-Ko;vec3 oy11=mod7(floor(p11*K))*K-Ko;vec3 oz11=floor(p11*K2)*Kz-Kzo;vec3 ox12=fract(p12*K)-Ko;vec3 oy12=mod7(floor(p12*K))*K-Ko;vec3 oz12=floor(p12*K2)*Kz-Kzo;vec3 ox13=fract(p13*K)-Ko;vec3 oy13=mod7(floor(p13*K))*K-Ko;vec3 oz13=floor(p13*K2)*Kz-Kzo;vec3 ox21=fract(p21*K)-Ko;vec3 oy21=mod7(floor(p21*K))*K-Ko;vec3 oz21=floor(p21*K2)*Kz-Kzo;vec3 ox22=fract(p22*K)-Ko;vec3 oy22=mod7(floor(p22*K))*K-Ko;vec3 oz22=floor(p22*K2)*Kz-Kzo;vec3 ox23=fract(p23*K)-Ko;vec3 oy23=mod7(floor(p23*K))*K-Ko;vec3 oz23=floor(p23*K2)*Kz-Kzo;vec3 ox31=fract(p31*K)-Ko;vec3 oy31=mod7(floor(p31*K))*K-Ko;vec3 oz31=floor(p31*K2)*Kz-Kzo;vec3 ox32=fract(p32*K)-Ko;vec3 oy32=mod7(floor(p32*K))*K-Ko;vec3 oz32=floor(p32*K2)*Kz-Kzo;vec3 ox33=fract(p33*K)-Ko;vec3 oy33=mod7(floor(p33*K))*K-Ko;vec3 oz33=floor(p33*K2)*Kz-Kzo;vec3 dx11=Pfx+jitter*ox11;vec3 dy11=Pfy.x+jitter*oy11;vec3 dz11=Pfz.x+jitter*oz11;vec3 dx12=Pfx+jitter*ox12;vec3 dy12=Pfy.x+jitter*oy12;vec3 dz12=Pfz.y+jitter*oz12;vec3 dx13=Pfx+jitter*ox13;vec3 dy13=Pfy.x+jitter*oy13;vec3 dz13=Pfz.z+jitter*oz13;vec3 dx21=Pfx+jitter*ox21;vec3 dy21=Pfy.y+jitter*oy21;vec3 dz21=Pfz.x+jitter*oz21;vec3 dx22=Pfx+jitter*ox22;vec3 dy22=Pfy.y+jitter*oy22;vec3 dz22=Pfz.y+jitter*oz22;vec3 dx23=Pfx+jitter*ox23;vec3 dy23=Pfy.y+jitter*oy23;vec3 dz23=Pfz.z+jitter*oz23;vec3 dx31=Pfx+jitter*ox31;vec3 dy31=Pfy.z+jitter*oy31;vec3 dz31=Pfz.x+jitter*oz31;vec3 dx32=Pfx+jitter*ox32;vec3 dy32=Pfy.z+jitter*oy32;vec3 dz32=Pfz.y+jitter*oz32;vec3 dx33=Pfx+jitter*ox33;vec3 dy33=Pfy.z+jitter*oy33;vec3 dz33=Pfz.z+jitter*oz33;vec3 d11=dx11*dx11+dy11*dy11+dz11*dz11;vec3 d12=dx12*dx12+dy12*dy12+dz12*dz12;vec3 d13=dx13*dx13+dy13*dy13+dz13*dz13;vec3 d21=dx21*dx21+dy21*dy21+dz21*dz21;vec3 d22=dx22*dx22+dy22*dy22+dz22*dz22;vec3 d23=dx23*dx23+dy23*dy23+dz23*dz23;vec3 d31=dx31*dx31+dy31*dy31+dz31*dz31;vec3 d32=dx32*dx32+dy32*dy32+dz32*dz32;vec3 d33=dx33*dx33+dy33*dy33+dz33*dz33;vec3 d1a=min(d11,d12);d12=max(d11,d12);d11=min(d1a,d13);d13=max(d1a,d13);d12=min(d12,d13);vec3 d2a=min(d21,d22);d22=max(d21,d22);d21=min(d2a,d23);d23=max(d2a,d23);d22=min(d22,d23);vec3 d3a=min(d31,d32);d32=max(d31,d32);d31=min(d3a,d33);d33=max(d3a,d33);d32=min(d32,d33);vec3 da=min(d11,d21);d21=max(d11,d21);d11=min(da,d31);d31=max(da,d31);d11.xy=(d11.x<d11.y)? d11.xy : d11.yx;d11.xz=(d11.x<d11.z)? d11.xz : d11.zx;d12=min(d12,d21);d12=min(d12,d22);d12=min(d12,d31);d12=min(d12,d32);d11.yz=min(d11.yz,d12.xy);d11.y=min(d11.y,d12.z);d11.y=min(d11.y,d11.z);return sqrt(d11.xy);}`,E_=`#define GLSLIFY 1
#include <noise_cellular_2D>
#include <noise_cellular_3D>
#include <noise_cellular_2x2>
#include <noise_cellular_2x2x2>
`,R_=`#define GLSLIFY 1
float perlin(vec2 P){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}float perlin(vec2 P,vec2 rep){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod(Pi,rep.xyxy);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}`,F_=`#define GLSLIFY 1
float perlin(vec3 P){vec3 Pi0=floor(P);vec3 Pi1=Pi0+vec3(1.0);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}float perlin(vec3 P,vec3 rep){vec3 Pi0=mod(floor(P),rep);vec3 Pi1=mod(Pi0+vec3(1.0),rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}`,B_=`#define GLSLIFY 1
float perlin(vec4 P){vec4 Pi0=floor(P);vec4 Pi1=Pi0+1.0;Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}float perlin(vec4 P,vec4 rep){vec4 Pi0=mod(floor(P),rep);vec4 Pi1=mod(Pi0+1.0,rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}`,D_=`#define GLSLIFY 1
#include <noise_perlin_2D>
#include <noise_perlin_3D>
#include <noise_perlin_4D>
`,L_=`#define GLSLIFY 1
vec2 rgrad2(vec2 p,float rot){float u=permute(permute(p.x)+p.y)*0.0243902439+rot;u=fract(u)*6.28318530718;return vec2(cos(u),sin(u));}vec3 psrdnoise(vec2 pos,vec2 per,float rot){pos.y+=0.01;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 psdnoise(vec2 pos,vec2 per){return psrdnoise(pos,per,0.0);}float psrnoise(vec2 pos,vec2 per,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float psnoise(vec2 pos,vec2 per){return psrnoise(pos,per,0.0);}vec3 srdnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 sdnoise(vec2 pos){return srdnoise(pos,0.0);}float srnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float snoise(vec2 pos){return srnoise(pos,0.0);}`,z_=`#define GLSLIFY 1
float simplex(vec2 v){const vec4 C=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);vec2 i=floor(v+dot(v,C.yy));vec2 x0=v-i+dot(i,C.xx);vec2 i1;i1=(x0.x>x0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec4 x12=x0.xyxy+C.xxzz;x12.xy-=i1;i=mod289(i);vec3 p=permute(permute(i.y+vec3(0.0,i1.y,1.0))+i.x+vec3(0.0,i1.x,1.0));vec3 m=max(0.5-vec3(dot(x0,x0),dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)),0.0);m=m*m;m=m*m;vec3 x=2.0*fract(p*C.www)-1.0;vec3 h=abs(x)-0.5;vec3 ox=floor(x+0.5);vec3 a0=x-ox;m*=1.79284291400159-0.85373472095314*(a0*a0+h*h);vec3 g;g.x=a0.x*x0.x+h.x*x0.y;g.yz=a0.yz*x12.xz+h.yz*x12.yw;return 130.0*dot(m,g);}`,O_=`#define GLSLIFY 1
float simplex(vec3 v,out vec3 gradient){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);vec4 m2=m*m;vec4 m4=m2*m2;vec4 pdotx=vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3));vec4 temp=m2*m*pdotx;gradient=-8.0*(temp.x*x0+temp.y*x1+temp.z*x2+temp.w*x3);gradient+=m4.x*p0+m4.y*p1+m4.z*p2+m4.w*p3;gradient*=42.0;return 42.0*dot(m4,pdotx);}`,I_=`#define GLSLIFY 1
float simplex(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}`,N_=`#define GLSLIFY 1
vec4 grad4(float j,vec4 ip){const vec4 ones=vec4(1.0,1.0,1.0,-1.0);vec4 p,s;p.xyz=floor(fract(vec3(j)*ip.xyz)*7.0)*ip.z-1.0;p.w=1.5-dot(abs(p.xyz),ones.xyz);s=vec4(lessThan(p,vec4(0.0)));p.xyz=p.xyz+(s.xyz*2.0-1.0)*s.www;return p;}
#define F4 0.309016994374947451
float simplex(vec4 v){const vec4 C=vec4(0.138196601125011,0.276393202250021,0.414589803375032,-0.447213595499958);vec4 i=floor(v+dot(v,vec4(F4)));vec4 x0=v-i+dot(i,C.xxxx);vec4 i0;vec3 isX=step(x0.yzw,x0.xxx);vec3 isYZ=step(x0.zww,x0.yyz);i0.x=isX.x+isX.y+isX.z;i0.yzw=1.0-isX;i0.y+=isYZ.x+isYZ.y;i0.zw+=1.0-isYZ.xy;i0.z+=isYZ.z;i0.w+=1.0-isYZ.z;vec4 i3=clamp(i0,0.0,1.0);vec4 i2=clamp(i0-1.0,0.0,1.0);vec4 i1=clamp(i0-2.0,0.0,1.0);vec4 x1=x0-i1+C.xxxx;vec4 x2=x0-i2+C.yyyy;vec4 x3=x0-i3+C.zzzz;vec4 x4=x0+C.wwww;i=mod289(i);float j0=permute(permute(permute(permute(i.w)+i.z)+i.y)+i.x);vec4 j1=permute(permute(permute(permute(i.w+vec4(i1.w,i2.w,i3.w,1.0))+i.z+vec4(i1.z,i2.z,i3.z,1.0))+i.y+vec4(i1.y,i2.y,i3.y,1.0))+i.x+vec4(i1.x,i2.x,i3.x,1.0));vec4 ip=vec4(1.0/294.0,1.0/49.0,1.0/7.0,0.0);vec4 p0=grad4(j0,ip);vec4 p1=grad4(j1.x,ip);vec4 p2=grad4(j1.y,ip);vec4 p3=grad4(j1.z,ip);vec4 p4=grad4(j1.w,ip);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;p4*=taylorInvSqrt(dot(p4,p4));vec3 m0=max(0.6-vec3(dot(x0,x0),dot(x1,x1),dot(x2,x2)),0.0);vec2 m1=max(0.6-vec2(dot(x3,x3),dot(x4,x4)),0.0);m0=m0*m0;m1=m1*m1;return 49.0*(dot(m0*m0,vec3(dot(p0,x0),dot(p1,x1),dot(p2,x2)))+dot(m1*m1,vec2(dot(p3,x3),dot(p4,x4))));}`,U_=`#define GLSLIFY 1
#include <noise_simplex_2D>
#include <noise_simplex_3D>
#include <noise_simplex_3D_grad>
#include <noise_simplex_4D>
`,k_=`#define GLSLIFY 1
uniform float u_alphaCutoff;uniform vec4 u_baseColor;uniform float u_metal;uniform float u_roughness;uniform vec3 u_PBRSpecularColor;uniform float u_glossiness;uniform vec3 u_emissiveColor;
#ifdef CLEARCOAT
uniform float u_clearCoat;uniform float u_clearCoatRoughness;
#endif
uniform float u_normalIntensity;uniform float u_occlusionIntensity;uniform float u_occlusionTextureCoord;
#ifdef BASETEXTURE
uniform sampler2D u_baseTexture;
#endif
#ifdef NORMALTEXTURE
uniform sampler2D u_normalTexture;
#endif
#ifdef EMISSIVETEXTURE
uniform sampler2D u_emissiveTexture;
#endif
#ifdef ROUGHNESSMETALLICTEXTURE
uniform sampler2D u_roughnessMetallicTexture;
#endif
#ifdef SPECULARGLOSSINESSTEXTURE
uniform sampler2D u_specularGlossinessTexture;
#endif
#ifdef OCCLUSIONTEXTURE
uniform sampler2D u_occlusionTexture;
#endif
#ifdef HAS_CLEARCOATTEXTURE
uniform sampler2D u_clearCoatTexture;
#endif
#ifdef HAS_CLEARCOATROUGHNESSTEXTURE
uniform sampler2D u_clearCoatRoughnessTexture;
#endif
#ifdef HAS_CLEARCOATNORMALTEXTURE
uniform sampler2D u_clearCoatNormalTexture;
#endif
struct ReflectedLight{vec3 directDiffuse;vec3 directSpecular;vec3 indirectDiffuse;vec3 indirectSpecular;};struct Geometry{vec3 position;vec3 normal;vec3 viewDir;float dotNV;
#ifdef CLEARCOAT
vec3 clearCoatNormal;float clearCoatDotNV;
#endif
};struct Material{vec3 diffuseColor;float roughness;vec3 specularColor;float opacity;
#ifdef CLEARCOAT
float clearCoat;float clearCoatRoughness;
#endif
};`,V_=`#define GLSLIFY 1
#include <normal_get>
float computeSpecularOcclusion(float ambientOcclusion,float roughness,float dotNV){return saturate(pow(dotNV+ambientOcclusion,exp2(-16.0*roughness-1.0))-1.0+ambientOcclusion);}float getAARoughnessFactor(vec3 normal){
#ifdef HAS_DERIVATIVES
vec3 dxy=max(abs(dFdx(normal)),abs(dFdy(normal)));return 0.04+max(max(dxy.x,dxy.y),dxy.z);
#else
return 0.04;
#endif
}void initGeometry(out Geometry geometry){geometry.position=v_pos;geometry.viewDir=normalize(u_cameraPos-v_pos);
#if defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE)
mat3 tbn=getTBN();
#endif
#ifdef NORMALTEXTURE
geometry.normal=getNormalByNormalTexture(tbn,u_normalTexture,u_normalIntensity,v_uv);
#else
geometry.normal=getNormal();
#endif
geometry.dotNV=saturate(dot(geometry.normal,geometry.viewDir));
#ifdef CLEARCOAT
#ifdef HAS_CLEARCOATNORMALTEXTURE
geometry.clearCoatNormal=getNormalByNormalTexture(tbn,u_clearCoatNormalTexture,u_normalIntensity,v_uv);
#else
geometry.clearCoatNormal=getNormal();
#endif
geometry.clearCoatDotNV=saturate(dot(geometry.clearCoatNormal,geometry.viewDir));
#endif
}void initMaterial(out Material material,const in Geometry geometry){vec4 baseColor=u_baseColor;float metal=u_metal;float roughness=u_roughness;vec3 specularColor=u_PBRSpecularColor;float glossiness=u_glossiness;float alphaCutoff=u_alphaCutoff;
#ifdef BASETEXTURE
vec4 baseTextureColor=texture2D(u_baseTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
baseTextureColor=gammaToLinear(baseTextureColor);
#endif
baseColor*=baseTextureColor;
#endif
#ifdef O3_HAS_VERTEXCOLOR
baseColor*=v_color;
#endif
#ifdef ALPHA_CUTOFF
if(baseColor.a<alphaCutoff){discard;}
#endif
#ifdef ROUGHNESSMETALLICTEXTURE
vec4 metalRoughMapColor=texture2D(u_roughnessMetallicTexture,v_uv);roughness*=metalRoughMapColor.g;metal*=metalRoughMapColor.b;
#endif
#ifdef SPECULARGLOSSINESSTEXTURE
vec4 specularGlossinessColor=texture2D(u_specularGlossinessTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
specularGlossinessColor=gammaToLinear(specularGlossinessColor);
#endif
specularColor*=specularGlossinessColor.rgb;glossiness*=specularGlossinessColor.a;
#endif
#ifdef IS_METALLIC_WORKFLOW
material.diffuseColor=baseColor.rgb*(1.0-metal);material.specularColor=mix(vec3(0.04),baseColor.rgb,metal);material.roughness=roughness;
#else
float specularStrength=max(max(specularColor.r,specularColor.g),specularColor.b);material.diffuseColor=baseColor.rgb*(1.0-specularStrength);material.specularColor=specularColor;material.roughness=1.0-glossiness;
#endif
material.roughness=max(material.roughness,getAARoughnessFactor(geometry.normal));
#ifdef CLEARCOAT
material.clearCoat=u_clearCoat;material.clearCoatRoughness=u_clearCoatRoughness;
#ifdef HAS_CLEARCOATTEXTURE
material.clearCoat*=texture2D(u_clearCoatTexture,v_uv).r;
#endif
#ifdef HAS_CLEARCOATROUGHNESSTEXTURE
material.clearCoatRoughness*=texture2D(u_clearCoatRoughnessTexture,v_uv).g;
#endif
material.clearCoat=saturate(material.clearCoat);material.clearCoatRoughness=max(material.clearCoatRoughness,getAARoughnessFactor(geometry.clearCoatNormal));
#endif
material.opacity=baseColor.a;}
#include <brdf>
#include <direct_irradiance_frag_define>
#include <ibl_frag_define>
`,G_=`#define GLSLIFY 1
float F_Schlick(float dotLH){return 0.04+0.96*(pow(1.0-dotLH,5.0));}vec3 F_Schlick(vec3 specularColor,float dotLH){float fresnel=exp2((-5.55473*dotLH-6.98316)*dotLH);return(1.0-specularColor)*fresnel+specularColor;}float G_GGX_SmithCorrelated(float alpha,float dotNL,float dotNV){float a2=pow2(alpha);float gv=dotNL*sqrt(a2+(1.0-a2)*pow2(dotNV));float gl=dotNV*sqrt(a2+(1.0-a2)*pow2(dotNL));return 0.5/max(gv+gl,EPSILON);}float D_GGX(float alpha,float dotNH){float a2=pow2(alpha);float denom=pow2(dotNH)*(a2-1.0)+1.0;return RECIPROCAL_PI*a2/pow2(denom);}vec3 BRDF_Specular_GGX(vec3 incidentDirection,vec3 viewDir,vec3 normal,vec3 specularColor,float roughness){float alpha=pow2(roughness);vec3 halfDir=normalize(incidentDirection+viewDir);float dotNL=saturate(dot(normal,incidentDirection));float dotNV=saturate(dot(normal,viewDir));float dotNH=saturate(dot(normal,halfDir));float dotLH=saturate(dot(incidentDirection,halfDir));vec3 F=F_Schlick(specularColor,dotLH);float G=G_GGX_SmithCorrelated(alpha,dotNL,dotNV);float D=D_GGX(alpha,dotNH);return F*(G*D);}vec3 BRDF_Diffuse_Lambert(vec3 diffuseColor){return RECIPROCAL_PI*diffuseColor;}`,H_=`#define GLSLIFY 1
void addDirectRadiance(vec3 incidentDirection,vec3 color,Geometry geometry,Material material,inout ReflectedLight reflectedLight){float attenuation=1.0;
#ifdef CLEARCOAT
float clearCoatDotNL=saturate(dot(geometry.clearCoatNormal,incidentDirection));vec3 clearCoatIrradiance=clearCoatDotNL*color;reflectedLight.directSpecular+=material.clearCoat*clearCoatIrradiance*BRDF_Specular_GGX(incidentDirection,geometry.viewDir,geometry.clearCoatNormal,vec3(0.04),material.clearCoatRoughness);attenuation-=material.clearCoat*F_Schlick(geometry.clearCoatDotNV);
#endif
float dotNL=saturate(dot(geometry.normal,incidentDirection));vec3 irradiance=dotNL*color*PI;reflectedLight.directSpecular+=attenuation*irradiance*BRDF_Specular_GGX(incidentDirection,geometry.viewDir,geometry.normal,material.specularColor,material.roughness);reflectedLight.directDiffuse+=attenuation*irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}
#ifdef O3_DIRECT_LIGHT_COUNT
void addDirectionalDirectLightRadiance(DirectLight directionalLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 color=directionalLight.color;vec3 direction=-directionalLight.direction;addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
#ifdef O3_POINT_LIGHT_COUNT
void addPointDirectLightRadiance(PointLight pointLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 lVector=pointLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);vec3 color=pointLight.color;color*=clamp(1.0-pow(lightDistance/pointLight.distance,4.0),0.0,1.0);addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
#ifdef O3_SPOT_LIGHT_COUNT
void addSpotDirectLightRadiance(SpotLight spotLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 lVector=spotLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);float angleCos=dot(direction,-spotLight.direction);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayEffect=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);vec3 color=spotLight.color;color*=spotEffect*decayEffect;addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
void addTotalDirectRadiance(Geometry geometry,Material material,inout ReflectedLight reflectedLight){
#ifdef O3_DIRECT_LIGHT_COUNT
DirectLight directionalLight;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){directionalLight.color=u_directLightColor[i];directionalLight.direction=u_directLightDirection[i];addDirectionalDirectLightRadiance(directionalLight,geometry,material,reflectedLight);}
#endif
#ifdef O3_POINT_LIGHT_COUNT
PointLight pointLight;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){pointLight.color=u_pointLightColor[i];pointLight.position=u_pointLightPosition[i];pointLight.distance=u_pointLightDistance[i];addPointDirectLightRadiance(pointLight,geometry,material,reflectedLight);}
#endif
#ifdef O3_SPOT_LIGHT_COUNT
SpotLight spotLight;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){spotLight.color=u_spotLightColor[i];spotLight.position=u_spotLightPosition[i];spotLight.direction=u_spotLightDirection[i];spotLight.distance=u_spotLightDistance[i];spotLight.angleCos=u_spotLightAngleCos[i];spotLight.penumbraCos=u_spotLightPenumbraCos[i];addSpotDirectLightRadiance(spotLight,geometry,material,reflectedLight);}
#endif
}`,W_=`#define GLSLIFY 1
vec3 getLightProbeIrradiance(vec3 sh[9],vec3 normal){normal.x=-normal.x;vec3 result=sh[0]+sh[1]*(normal.y)+sh[2]*(normal.z)+sh[3]*(normal.x)+sh[4]*(normal.y*normal.x)+sh[5]*(normal.y*normal.z)+sh[6]*(3.0*normal.z*normal.z-1.0)+sh[7]*(normal.z*normal.x)+sh[8]*(normal.x*normal.x-normal.y*normal.y);return max(result,vec3(0.0));}vec3 envBRDFApprox(vec3 specularColor,float roughness,float dotNV){const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}float getSpecularMIPLevel(float roughness,int maxMIPLevel){return roughness*float(maxMIPLevel);}vec3 getLightProbeRadiance(vec3 viewDir,vec3 normal,float roughness,int maxMIPLevel,float specularIntensity){
#ifndef O3_USE_SPECULAR_ENV
return vec3(0);
#else
vec3 reflectVec=reflect(-viewDir,normal);reflectVec.x=-reflectVec.x;float specularMIPLevel=getSpecularMIPLevel(roughness,maxMIPLevel);
#ifdef HAS_TEX_LOD
vec4 envMapColor=textureCubeLodEXT(u_env_specularSampler,reflectVec,specularMIPLevel);
#else
vec4 envMapColor=textureCube(u_env_specularSampler,reflectVec,specularMIPLevel);
#endif
#ifdef O3_DECODE_ENV_RGBM
envMapColor.rgb=RGBMToLinear(envMapColor,5.0).rgb;
#ifdef OASIS_COLORSPACE_GAMMA
envMapColor=linearToGamma(envMapColor);
#endif
#else
#ifndef OASIS_COLORSPACE_GAMMA
envMapColor=gammaToLinear(envMapColor);
#endif
#endif
return envMapColor.rgb*specularIntensity;
#endif
}`,X_=`#define GLSLIFY 1
Geometry geometry;Material material;ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));initGeometry(geometry);initMaterial(material,geometry);addTotalDirectRadiance(geometry,material,reflectedLight);
#ifdef O3_USE_SH
vec3 irradiance=getLightProbeIrradiance(u_env_sh,geometry.normal);
#ifdef OASIS_COLORSPACE_GAMMA
irradiance=linearToGamma(vec4(irradiance,1.0)).rgb;
#endif
irradiance*=u_envMapLight.diffuseIntensity;
#else
vec3 irradiance=u_envMapLight.diffuse*u_envMapLight.diffuseIntensity;irradiance*=PI;
#endif
reflectedLight.indirectDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);vec3 radiance=getLightProbeRadiance(geometry.viewDir,geometry.normal,material.roughness,int(u_envMapLight.mipMapLevel),u_envMapLight.specularIntensity);float radianceAttenuation=1.0;
#ifdef CLEARCOAT
vec3 clearCoatRadiance=getLightProbeRadiance(geometry.viewDir,geometry.clearCoatNormal,material.clearCoatRoughness,int(u_envMapLight.mipMapLevel),u_envMapLight.specularIntensity);reflectedLight.indirectSpecular+=clearCoatRadiance*material.clearCoat*envBRDFApprox(vec3(0.04),material.clearCoatRoughness,geometry.clearCoatDotNV);radianceAttenuation-=material.clearCoat*F_Schlick(geometry.clearCoatDotNV);
#endif
reflectedLight.indirectSpecular+=radianceAttenuation*radiance*envBRDFApprox(material.specularColor,material.roughness,geometry.dotNV);
#ifdef OCCLUSIONTEXTURE
vec2 aoUV=v_uv;
#ifdef O3_HAS_UV1
if(u_occlusionTextureCoord==1.0){aoUV=v_uv1;}
#endif
float ambientOcclusion=(texture2D(u_occlusionTexture,aoUV).r-1.0)*u_occlusionIntensity+1.0;reflectedLight.indirectDiffuse*=ambientOcclusion;
#ifdef O3_USE_SPECULAR_ENV
reflectedLight.indirectSpecular*=computeSpecularOcclusion(ambientOcclusion,material.roughness,geometry.dotNV);
#endif
#endif
vec3 emissiveRadiance=u_emissiveColor;
#ifdef EMISSIVETEXTURE
vec4 emissiveColor=texture2D(u_emissiveTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
emissiveColor=gammaToLinear(emissiveColor);
#endif
emissiveRadiance*=emissiveColor.rgb;
#endif
vec3 totalRadiance=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+emissiveRadiance;vec4 targetColor=vec4(totalRadiance,material.opacity);
#ifndef OASIS_COLORSPACE_GAMMA
targetColor=linearToGamma(targetColor);
#endif
gl_FragColor=targetColor;`,j_={pbr_frag_define:k_,pbr_helper:V_,brdf:G_,direct_irradiance_frag_define:H_,ibl_frag_define:W_,pbr_frag:X_},$_=`#define GLSLIFY 1
vec3 getNormal(){
#ifdef O3_HAS_NORMAL
vec3 normal=normalize(v_normal);
#elif defined(HAS_DERIVATIVES)
vec3 pos_dx=dFdx(v_pos);vec3 pos_dy=dFdy(v_pos);vec3 normal=normalize(cross(pos_dx,pos_dy));
#else
vec3 normal=vec3(0,0,1);
#endif
normal*=float(gl_FrontFacing)*2.0-1.0;return normal;}vec3 getNormalByNormalTexture(mat3 tbn,sampler2D normalTexture,float normalIntensity,vec2 uv){vec3 normal=texture2D(normalTexture,uv).rgb;normal=normalize(tbn*((2.0*normal-1.0)*vec3(normalIntensity,normalIntensity,1.0)));normal*=float(gl_FrontFacing)*2.0-1.0;return normal;}mat3 getTBN(){
#if defined(O3_HAS_NORMAL) && defined(O3_HAS_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )
mat3 tbn=v_TBN;
#else
vec3 normal=getNormal();vec3 position=v_pos;vec2 uv=gl_FrontFacing? v_uv:-v_uv;
#ifdef HAS_DERIVATIVES
vec3 dp1=dFdx(position);vec3 dp2=dFdy(position);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 binormal=dp2perp*duv1.y+dp1perp*duv2.y;float invmax=inversesqrt(max(dot(tangent,tangent),dot(binormal,binormal)));mat3 tbn=mat3(tangent*invmax,binormal*invmax,normal);
#else
mat3 tbn=mat3(vec3(0.0),vec3(0.0),normal);
#endif
#endif
return tbn;}`,q_=Oo(Oo({common:Jd,common_vert:Zd,common_frag:Kd,color_share:e_,normal_share:t_,uv_share:r_,worldpos_share:i_,shadow_share:n_,fog_share:a_,begin_normal_vert:o_,begin_position_vert:s_,position_vert:l_,color_vert:c_,normal_vert:u_,skinning_vert:h_,blendShape_input:d_,blendShape_vert:__,uv_vert:f_,worldpos_vert:v_,shadow_vert:p_,fog_vert:g_,light_frag_define:m_,mobile_material_frag:y_,fog_frag:x_,begin_mobile_frag:b_,begin_viewdir_frag:w_,mobile_blinnphong_frag:S_,noise_common:C_,noise_cellular_2D:T_,noise_cellular_2x2:A_,noise_cellular_2x2x2:P_,noise_cellular_3D:M_,noise_cellular:E_,noise_perlin_2D:R_,noise_perlin_3D:F_,noise_perlin_4D:B_,noise_perlin:D_,noise_psrd_2D:L_,noise_simplex_2D:z_,noise_simplex_3D_grad:O_,noise_simplex_3D:I_,noise_simplex_4D:N_,noise_simplex:U_},j_),{},{normal_get:$_}),xi=function(){function i(){}return i.parseCustomMacros=function(n){return n.map(function(t){return"#define "+t+`
`}).join("")},i.parseIncludes=function(n){var t=/^[ \t]*#include +<([\w\d.]+)>/gm;function e(r,a){var s=q_[a];return s===void 0?(me.error('Shader slice "'+r.trim()+'" not founded.'),""):i.parseIncludes(s)}return n.replace(t,e)},i.parseExtension=function(n){return n.map(function(t){return"#extension "+t+` : enable
`}).join("")},i.convertTo300=function(n,t){if(n=n.replace(/\battribute\b/g,"in"),n=n.replace(/\bvarying\b/g,t?"in":"out"),n=n.replace(/\btexture(2D|Cube)\b/g,"texture"),n=n.replace(/\btexture(2D|Cube)LodEXT\b/g,"textureLod"),t){var e=/\bgl_FragData\[.+?\]/g.test(n);if(e){n=n.replace(/\bgl_FragColor\b/g,"gl_FragData[0]");var r=n.match(/\bgl_FragData\[.+?\]/g);n=this._replaceMRTShader(n,r)}else n=n.replace(/void\s+?main\s*\(/g,`out vec4 glFragColor;
void main(`),n=n.replace(/\bgl_FragColor\b/g,"glFragColor")}return n},i._replaceMRTShader=function(n,t){for(var e="",r=new Set,a=0;a<t.length;a++){var s=t[a].match(/\bgl_FragData\[(.+?)\]/);r.add(s[1])}return r.forEach(function(l){e+="layout(location="+l+") out vec4 fragOutColor"+l+`;
`}),e+="void main(",n=n.replace(/\bgl_FragData\[(.+?)\]/g,"fragOutColor$1"),n=n.replace(/void\s+?main\s*\(/g,e),n},i}(),ma=function i(o,n,t,e){this.name=void 0,this.value=void 0,this._nameId=void 0,this._maskIndex=void 0,this._maskValue=void 0,this.name=o,this._maskIndex=t,this._maskValue=e,this.value=n;var r=i._macroNameIdMap,a=r[o];r[o]===void 0&&(r[o]=a=i._macroNameCounter++),this._nameId=a};ma._macroNameIdMap=Object.create(null);ma._macroNameCounter=0;var ii;(function(i){i[i.Linear=0]="Linear",i[i.Gamma=1]="Gamma"})(ii||(ii={}));var Y_=function(){function i(n){this.name=void 0,this.propertyId=void 0,this.location=void 0,this.applyFunc=void 0,this.cacheValue=void 0,this.textureIndex=void 0,this.textureDefault=void 0,this._rhi=void 0,this._gl=void 0,this._colorSpace=void 0;var t=n._hardwareRenderer;this._rhi=t,this._gl=t.gl,this._colorSpace=n.settings.colorSpace}var o=i.prototype;return o.upload1f=function(t,e){this.cacheValue!==e&&(this._gl.uniform1f(t.location,e),this.cacheValue=e)},o.upload1fv=function(t,e){this._gl.uniform1fv(t.location,e)},o.upload2f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g)&&(this._colorSpace===ii.Linear?this._gl.uniform2f(t.location,oe.gammaToLinearSpace(e.r),oe.gammaToLinearSpace(e.g)):this._gl.uniform2f(t.location,e.r,e.g),r.x=e.r,r.y=e.g):(r.x!==e.x||r.y!==e.y)&&(this._gl.uniform2f(t.location,e.x,e.y),r.x=e.x,r.y=e.y)},o.upload2fv=function(t,e){this._gl.uniform2fv(t.location,e)},o.upload3f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b)&&(this._colorSpace===ii.Linear?this._gl.uniform3f(t.location,oe.gammaToLinearSpace(e.r),oe.gammaToLinearSpace(e.g),oe.gammaToLinearSpace(e.b)):this._gl.uniform3f(t.location,e.r,e.g,e.b),r.x=e.r,r.y=e.g,r.z=e.b):(r.x!==e.x||r.y!==e.y||r.z!==e.z)&&(this._gl.uniform3f(t.location,e.x,e.y,e.z),r.x=e.x,r.y=e.y,r.z=e.z)},o.upload3fv=function(t,e){this._gl.uniform3fv(t.location,e)},o.upload4f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b||r.w!==e.a)&&(this._colorSpace===ii.Linear?this._gl.uniform4f(t.location,oe.gammaToLinearSpace(e.r),oe.gammaToLinearSpace(e.g),oe.gammaToLinearSpace(e.b),e.a):this._gl.uniform4f(t.location,e.r,e.g,e.b,e.a),r.x=e.r,r.y=e.g,r.z=e.b,r.w=e.a):(r.x!==e.x||r.y!==e.y||r.z!==e.z||r.w!==e.w)&&(this._gl.uniform4f(t.location,e.x,e.y,e.z,e.w),r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w)},o.upload4fv=function(t,e){this._gl.uniform4fv(t.location,e)},o.upload1i=function(t,e){this.cacheValue!==e&&(this._gl.uniform1i(t.location,e),this.cacheValue=e)},o.upload1iv=function(t,e){this._gl.uniform1iv(t.location,e)},o.upload2i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g)&&(this._gl.uniform2i(t.location,e.r,e.g),r.x=e.r,r.y=e.g):(r.x!==e.x||r.y!==e.y)&&(this._gl.uniform2i(t.location,e.x,e.y),r.x=e.x,r.y=e.y)},o.upload2iv=function(t,e){this._gl.uniform2iv(t.location,e)},o.upload3i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b)&&(this._gl.uniform3i(t.location,e.r,e.g,e.b),r.x=e.r,r.y=e.g,r.z=e.b):(r.x!==e.x||r.y!==e.y||r.z!==e.z)&&(this._gl.uniform3i(t.location,e.x,e.y,e.z),r.x=e.x,r.y=e.y,r.z=e.z)},o.upload3iv=function(t,e){this._gl.uniform3iv(t.location,e)},o.upload4i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b||r.w!==e.a)&&(this._gl.uniform4i(t.location,e.r,e.g,e.b,e.a),r.x=e.r,r.y=e.g,r.z=e.b,r.w=e.a):(r.x!==e.x||r.y!==e.y||r.z!==e.z||r.w!==e.w)&&(this._gl.uniform4i(t.location,e.x,e.y,e.z,e.w),r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w)},o.upload4iv=function(t,e){this._gl.uniform4iv(t.location,e)},o.uploadMat4=function(t,e){this._gl.uniformMatrix4fv(t.location,!1,e.elements)},o.uploadMat4v=function(t,e){this._gl.uniformMatrix4fv(t.location,!1,e)},o.uploadTexture=function(t,e){var r=this._rhi;r.activeTexture(t.textureIndex),r.bindTexture(e._platformTexture)},o.uploadTextureArray=function(t,e){for(var r=this._rhi,a=t.textureIndex,s=0;s<e.length;s++){var l=e[s];r.activeTexture(a[s]),r.bindTexture(l._platformTexture)}},i}(),sn=function(){this.constUniforms=[],this.textureUniforms=[]},mh=function(){i._addLineNum=function(t){var e=t.split(`
`),r=(e.length+1).toString().length+6,a;return e.map(function(s,l){if(a="0:"+(l+1),a.length>=r)return a.substring(0,r)+s;for(var c=0;c<r-a.length;c++)a+=" ";return a+s}).join(`
`)};function i(n,t,e){this.id=void 0,this.sceneUniformBlock=new sn,this.cameraUniformBlock=new sn,this.rendererUniformBlock=new sn,this.materialUniformBlock=new sn,this.otherUniformBlock=new sn,this._uploadRenderCount=-1,this._uploadCamera=void 0,this._uploadRenderer=void 0,this._uploadMaterial=void 0,this.attributeLocation=Object.create(null),this._isValid=void 0,this._engine=void 0,this._gl=void 0,this._vertexShader=void 0,this._fragmentShader=void 0,this._glProgram=void 0,this._activeTextureUint=0,this._engine=n,this._gl=n._hardwareRenderer.gl,this._glProgram=this._createProgram(t,e),this._glProgram?(this._isValid=!0,this._recordLocation()):this._isValid=!1,this.id=i._counter++}var o=i.prototype;return o.uploadAll=function(t,e){this.uploadUniforms(t,e),this.uploadTextures(t,e)},o.uploadUniforms=function(t,e){for(var r=e._properties,a=t.constUniforms,s=0,l=a.length;s<l;s++){var c=a[s],u=r[c.propertyId];u!=null&&c.applyFunc(c,u)}},o.uploadTextures=function(t,e){var r=e._properties,a=t.textureUniforms;if(a)for(var s=0,l=a.length;s<l;s++){var c=a[s],u=r[c.propertyId];u?c.applyFunc(c,u):c.applyFunc(c,c.textureDefault)}},o.uploadUnGroupTextures=function(){var t=this.otherUniformBlock.textureUniforms;if(t)for(var e=0,r=t.length;e<r;e++){var a=t[e];a.applyFunc(a,a.textureDefault)}},o.groupingOtherUniformBlock=function(){var t=this.otherUniformBlock,e=t.constUniforms,r=t.textureUniforms;e.length>0&&this._groupingSubOtherUniforms(e,!1),r.length>0&&this._groupingSubOtherUniforms(r,!0)},o.bind=function(){var t=this._engine._hardwareRenderer;return t._currentBind!==this?(this._gl.useProgram(this._glProgram),t._currentBind=this,!0):!1},o.destroy=function(){var t=this._gl;this._vertexShader&&t.deleteShader(this._vertexShader),this._fragmentShader&&t.deleteShader(this._fragmentShader),this._glProgram&&t.deleteProgram(this._glProgram)},o._groupingSubOtherUniforms=function(t,e){for(var r=t.length-1;r>=0;r--){var a=t[r],s=F._getShaderPropertyGroup(a.name);s!==void 0&&(t.splice(t.indexOf(a),1),this._groupingUniform(a,s,e))}},o._groupingUniform=function(t,e,r){switch(e){case _r.Scene:r?this.sceneUniformBlock.textureUniforms.push(t):this.sceneUniformBlock.constUniforms.push(t);break;case _r.Camera:r?this.cameraUniformBlock.textureUniforms.push(t):this.cameraUniformBlock.constUniforms.push(t);break;case _r.Renderer:r?this.rendererUniformBlock.textureUniforms.push(t):this.rendererUniformBlock.constUniforms.push(t);break;case _r.Material:r?this.materialUniformBlock.textureUniforms.push(t):this.materialUniformBlock.constUniforms.push(t);break;default:r?this.otherUniformBlock.textureUniforms.push(t):this.otherUniformBlock.constUniforms.push(t)}},o._createProgram=function(t,e){var r=this._gl,a=this._createShader(r.VERTEX_SHADER,t);if(!a)return null;var s=this._createShader(r.FRAGMENT_SHADER,e);if(!s)return null;var l=r.createProgram();return r.attachShader(l,a),r.attachShader(l,s),r.linkProgram(l),r.validateProgram(l),r.isContextLost()?(me.error("Context lost while linking program."),r.deleteShader(a),r.deleteShader(s),null):me.isEnabled&&!r.getProgramParameter(l,r.LINK_STATUS)?(me.error(`Could not link WebGL program. 
`+r.getProgramInfoLog(l)),r.deleteProgram(l),null):(this._vertexShader=a,this._fragmentShader=s,l)},o._createShader=function(t,e){var r=this._gl,a=r.createShader(t);return a?(r.shaderSource(a,e),r.compileShader(a),r.isContextLost()?(me.error("Context lost while compiling shader."),r.deleteShader(a),null):me.isEnabled&&!r.getShaderParameter(a,r.COMPILE_STATUS)?(me.error(`Could not compile WebGL shader.
`+r.getShaderInfoLog(a),i._addLineNum(e)),r.deleteShader(a),null):a):(me.error("Context lost while create shader."),null)},o._recordLocation=function(){var t=this,e=this._gl,r=this._glProgram,a=this._getUniformInfos(),s=this._getAttributeInfos();a.forEach(function(l){var c=l.name,u=l.size,h=l.type,d=new Y_(t._engine),f=!1,_=!1;c.indexOf("[0]")>0&&(c=c.substr(0,c.length-3),f=!0);var g=F._getShaderPropertyGroup(c),v=e.getUniformLocation(r,c);switch(d.name=c,d.propertyId=F.getPropertyByName(c)._uniqueId,d.location=v,h){case e.FLOAT:f?d.applyFunc=d.upload1fv:(d.applyFunc=d.upload1f,d.cacheValue=0);break;case e.FLOAT_VEC2:f?d.applyFunc=d.upload2fv:(d.applyFunc=d.upload2f,d.cacheValue=new q(0,0));break;case e.FLOAT_VEC3:f?d.applyFunc=d.upload3fv:(d.applyFunc=d.upload3f,d.cacheValue=new T(0,0,0));break;case e.FLOAT_VEC4:f?d.applyFunc=d.upload4fv:(d.applyFunc=d.upload4f,d.cacheValue=new Ve(0,0,0,0));break;case e.BOOL:case e.INT:f?d.applyFunc=d.upload1iv:(d.applyFunc=d.upload1i,d.cacheValue=0);break;case e.BOOL_VEC2:case e.INT_VEC2:f?d.applyFunc=d.upload2iv:(d.applyFunc=d.upload2i,d.cacheValue=new q(0,0));break;case e.BOOL_VEC3:case e.INT_VEC3:d.applyFunc=f?d.upload3iv:d.upload3i,d.cacheValue=new T(0,0,0);break;case e.BOOL_VEC4:case e.INT_VEC4:f?d.applyFunc=d.upload4iv:(d.applyFunc=d.upload4i,d.cacheValue=new Ve(0,0,0));break;case e.FLOAT_MAT4:d.applyFunc=f?d.uploadMat4v:d.uploadMat4;break;case e.SAMPLER_2D:case e.SAMPLER_CUBE:case e.SAMPLER_2D_ARRAY:var p;switch(h){case e.SAMPLER_2D:p=t._engine._whiteTexture2D;break;case e.SAMPLER_CUBE:p=t._engine._whiteTextureCube;break;case e.SAMPLER_2D_ARRAY:p=t._engine._whiteTexture2DArray;break;default:throw new Error("Unsupported texture type.")}if(_=!0,f){for(var m=new Array(u),y=new Int32Array(u),x=new Array(u),S=0;S<u;S++)m[S]=p,y[S]=t._activeTextureUint,x[S]=e.TEXTURE0+t._activeTextureUint++;d.textureDefault=m,d.textureIndex=x,d.applyFunc=d.uploadTextureArray,t.bind(),e.uniform1iv(v,y),d.uploadTextureArray(d,m)}else{var w=e.TEXTURE0+t._activeTextureUint;d.textureDefault=p,d.textureIndex=w,d.applyFunc=d.uploadTexture,t.bind(),e.uniform1i(v,t._activeTextureUint++),d.uploadTexture(d,p)}break}t._groupingUniform(d,g,_)}),s.forEach(function(l){var c=l.name;t.attributeLocation[c]=e.getAttribLocation(r,c)})},o._getUniformInfos=function(){for(var t=this._gl,e=this._glProgram,r=new Array,a=t.getProgramParameter(e,t.ACTIVE_UNIFORMS),s=0;s<a;++s){var l=t.getActiveUniform(e,s);r[s]=l}return r},o._getAttributeInfos=function(){for(var t=this._gl,e=this._glProgram,r=new Array,a=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),s=0;s<a;++s){var l=t.getActiveAttrib(e,s);r[s]=l}return r},te(i,[{key:"isValid",get:function(){return this._isValid}}]),i}();mh._counter=0;var yh=function i(o){this._uniqueId=void 0,this._group=void 0,this.name=void 0,this.name=o,this._uniqueId=i._propertyNameCounter++};yh._propertyNameCounter=0;var F=function(){i.create=function(t,e,r){var a=i._shaderMap;if(a[t])throw'Shader named "'+t+'" already exists.';return a[t]=new i(t,e,r)},i.find=function(t){return i._shaderMap[t]},i.getMacroByName=function(t,e){var r=e?t+" "+e:t,a=i._macroMap[r];if(!a){var s=i._macroMaskMap,l=i._macroCounter,c=Math.floor(l/32),u=l%32;a=new ma(t,e,c,1<<u),i._macroMap[r]=a,c==s.length&&(s.length++,s[c]=new Array(32)),s[c][u]=r,i._macroCounter++}return a},i.getPropertyByName=function(t){var e=i._propertyNameMap;if(e[t]!=null)return e[t];var r=new yh(t);return e[t]=r,r},i._getShaderPropertyGroup=function(t){var e=i._propertyNameMap[t];return e==null?void 0:e._group},i._getNamesByMacros=function(t,e){var r=i._macroMaskMap,a=t._mask;e.length=0;for(var s=0,l=t._length;s<l;s++)for(var c=r[s],u=a[s],h=u<0?32:Math.floor(Math.log2(u))+1,d=0;d<h;d++)u&1<<d&&e.push(c[d])};function i(n,t,e){this.name=void 0,this._shaderId=0,this._vertexSource=void 0,this._fragmentSource=void 0,this._shaderId=i._shaderCounter++,this.name=n,this._vertexSource=t,this._fragmentSource=e}var o=i.prototype;return o.compileVariant=function(t,e){var r=i._compileMacros;r.clear();for(var a=0,s=e.length;a<s;a++)r.enable(i.getMacroByName(e[a]));return this._getShaderProgram(t,r).isValid},o._getShaderProgram=function(t,e){var r=t._getShaderProgramPool(this),a=r.get(e);if(a)return a;var s=t._hardwareRenderer.isWebGL2,l=[];i._getNamesByMacros(e,l);var c=xi.parseCustomMacros(l),u=s?"#version 300 es":"#version 100",h=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
      precision highp float;
      precision highp int;
    #else
      precision mediump float;
      precision mediump int;
    #endif
    `;t._hardwareRenderer.canIUse(ae.shaderTextureLod)&&(h+=`#define HAS_TEX_LOD
`),t._hardwareRenderer.canIUse(ae.standardDerivatives)&&(h+=`#define HAS_DERIVATIVES
`);var d=xi.parseIncludes(" "+u+`
        `+h+`
        `+c+`
        `+this._vertexSource),f=xi.parseIncludes(" "+u+`
        `+(s?"":xi.parseExtension(i._shaderExtension))+`
        `+h+`
        `+c+`
      `+this._fragmentSource);return s&&(d=xi.convertTo300(d),f=xi.convertTo300(f,!0)),a=new mh(t,d,f),r.cache(a),a},i}();F._compileMacros=new Yt;F._shaderCounter=0;F._shaderMap=Object.create(null);F._propertyNameMap=Object.create(null);F._macroMaskMap=[];F._macroCounter=0;F._macroMap=Object.create(null);F._shaderExtension=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives","GL_EXT_draw_buffers"];var Nn=function(){function i(n){this._group=void 0,this._properties=Object.create(null),this._macroCollection=new Yt,this._macroMap=Object.create(null),this._refCount=0,this._group=n}var o=i.prototype;return o.getFloat=function(t){return this._getData(t)},o.setFloat=function(t,e){this._setData(t,e)},o.getInt=function(t){return this._getData(t)},o.setInt=function(t,e){this._setData(t,e)},o.getFloatArray=function(t){return this._getData(t)},o.setFloatArray=function(t,e){this._setData(t,e)},o.getIntArray=function(t){return this._getData(t)},o.setIntArray=function(t,e){this._setData(t,e)},o.getVector2=function(t){return this._getData(t)},o.setVector2=function(t,e){this._setData(t,e)},o.getVector3=function(t){return this._getData(t)},o.setVector3=function(t,e){this._setData(t,e)},o.getVector4=function(t){return this._getData(t)},o.setVector4=function(t,e){this._setData(t,e)},o.getMatrix=function(t){return this._getData(t)},o.setMatrix=function(t,e){this._setData(t,e)},o.getColor=function(t){return this._getData(t)},o.setColor=function(t,e){this._setData(t,e)},o.getTexture=function(t){return this._getData(t)},o.setTexture=function(t,e){if(this._getRefCount()>0){var r=this._getData(t);r&&r._addRefCount(-1),e&&e._addRefCount(1)}this._setData(t,e)},o.getTextureArray=function(t){return this._getData(t)},o.setTextureArray=function(t,e){if(this._getRefCount()>0){var r=this._getData(t);if(r)for(var a=0,s=r.length;a<s;a++)r[a]._addRefCount(-1);if(e)for(var l=0,c=e.length;l<c;l++)e[l]._addRefCount(1)}this._setData(t,e)},o.enableMacro=function(t,e){typeof t=="string"&&(t=F.getMacroByName(t,e));var r=t._nameId,a=this._macroMap[r];if(a!==t){var s=this._macroCollection;a&&s.disable(a),s.enable(t),this._macroMap[r]=t}},o.disableMacro=function(t){var e;if(typeof t=="string"){if(e=ma._macroNameIdMap[t],e===void 0)return}else e=t._nameId;var r=this._macroMap[e];r&&(this._macroCollection.disable(r),delete this._macroMap[e])},o.getMacros=function(t){if(t){var e=this._macroMap;t.length=0;for(var r in e)t.push(e[r])}else return Object.values(this._macroMap)},o.clone=function(){var t=new i(this._group);return this.cloneTo(t),t},o.cloneTo=function(t){nr.deepCloneObject(this._macroCollection,t._macroCollection),Cn(t._macroMap,this._macroMap);for(var e=this._properties,r=t._properties,a=Object.keys(e),s=0,l=a.length;s<l;s++){var c=a[s],u=e[c];if(u!=null)if(typeof u=="number")r[c]=u;else if(u instanceof Rr)r[c]=u;else if(u instanceof Array||u instanceof Float32Array||u instanceof Int32Array)r[c]=u.slice();else{var h=r[c];h?h.copyFrom(u):r[c]=u.clone()}else r[c]=u}},o._getData=function(t){return typeof t=="string"&&(t=F.getPropertyByName(t)),this._properties[t._uniqueId]},o._setData=function(t,e){if(typeof t=="string"&&(t=F.getPropertyByName(t)),t._group!==this._group)if(t._group===void 0)t._group=this._group;else throw"Shader property "+t.name+" has been used as "+_r[t._group]+" property.";this._properties[t._uniqueId]=e},o._getRefCount=function(){return this._refCount},o._addRefCount=function(t){this._refCount+=t;var e=this._properties;for(var r in e){var a=e[r];a&&a instanceof Rr&&a._addRefCount(t)}},i}(),de;(function(i){i[i.Zero=0]="Zero",i[i.One=1]="One",i[i.SourceColor=2]="SourceColor",i[i.OneMinusSourceColor=3]="OneMinusSourceColor",i[i.DestinationColor=4]="DestinationColor",i[i.OneMinusDestinationColor=5]="OneMinusDestinationColor",i[i.SourceAlpha=6]="SourceAlpha",i[i.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",i[i.DestinationAlpha=8]="DestinationAlpha",i[i.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",i[i.SourceAlphaSaturate=10]="SourceAlphaSaturate",i[i.BlendColor=11]="BlendColor",i[i.OneMinusBlendColor=12]="OneMinusBlendColor"})(de||(de={}));var Xt;(function(i){i[i.Add=0]="Add",i[i.Subtract=1]="Subtract",i[i.ReverseSubtract=2]="ReverseSubtract",i[i.Min=3]="Min",i[i.Max=4]="Max"})(Xt||(Xt={}));var fr;(function(i){i[i.None=0]="None",i[i.Red=1]="Red",i[i.Green=2]="Green",i[i.Blue=4]="Blue",i[i.Alpha=8]="Alpha",i[i.All=15]="All"})(fr||(fr={}));var Q_=function(){this.enabled=!1,this.colorBlendOperation=Xt.Add,this.alphaBlendOperation=Xt.Add,this.sourceColorBlendFactor=de.One,this.sourceAlphaBlendFactor=de.One,this.destinationColorBlendFactor=de.Zero,this.destinationAlphaBlendFactor=de.Zero,this.colorWriteMask=fr.All},J_=function(){function i(){this.targetBlendState=new Q_,this.blendColor=new oe(0,0,0,0),this.alphaToCoverage=!1}i._getGLBlendFactor=function(t,e){var r=t.gl;switch(e){case de.Zero:return r.ZERO;case de.One:return r.ONE;case de.SourceColor:return r.SRC_COLOR;case de.OneMinusSourceColor:return r.ONE_MINUS_SRC_COLOR;case de.DestinationColor:return r.DST_COLOR;case de.OneMinusDestinationColor:return r.ONE_MINUS_DST_COLOR;case de.SourceAlpha:return r.SRC_ALPHA;case de.OneMinusSourceAlpha:return r.ONE_MINUS_SRC_ALPHA;case de.DestinationAlpha:return r.DST_ALPHA;case de.OneMinusDestinationAlpha:return r.ONE_MINUS_DST_ALPHA;case de.SourceAlphaSaturate:return r.SRC_ALPHA_SATURATE;case de.BlendColor:return r.CONSTANT_COLOR;case de.OneMinusBlendColor:return r.ONE_MINUS_CONSTANT_COLOR}},i._getGLBlendOperation=function(t,e){var r=t.gl;switch(e){case Xt.Add:return r.FUNC_ADD;case Xt.Subtract:return r.FUNC_SUBTRACT;case Xt.ReverseSubtract:return r.FUNC_REVERSE_SUBTRACT;case Xt.Min:if(!t.canIUse(ae.blendMinMax))throw new Error("BlendOperation.Min is not supported in this context");return r.MIN;case Xt.Max:if(!t.canIUse(ae.blendMinMax))throw new Error("BlendOperation.Max is not supported in this context");return r.MAX}};var o=i.prototype;return o._apply=function(t,e){this._platformApply(t,e.blendState)},o._platformApply=function(t,e){var r=t.gl,a=e.targetBlendState,s=this.targetBlendState,l=s.enabled,c=s.colorBlendOperation,u=s.alphaBlendOperation,h=s.sourceColorBlendFactor,d=s.destinationColorBlendFactor,f=s.sourceAlphaBlendFactor,_=s.destinationAlphaBlendFactor,g=s.colorWriteMask;if(l!==a.enabled&&(l?r.enable(r.BLEND):r.disable(r.BLEND),a.enabled=l),l){(h!==a.sourceColorBlendFactor||d!==a.destinationColorBlendFactor||f!==a.sourceAlphaBlendFactor||_!==a.destinationAlphaBlendFactor)&&(r.blendFuncSeparate(i._getGLBlendFactor(t,h),i._getGLBlendFactor(t,d),i._getGLBlendFactor(t,f),i._getGLBlendFactor(t,_)),a.sourceColorBlendFactor=h,a.destinationColorBlendFactor=d,a.sourceAlphaBlendFactor=f,a.destinationAlphaBlendFactor=_),(c!==a.colorBlendOperation||u!==a.alphaBlendOperation)&&(r.blendEquationSeparate(i._getGLBlendOperation(t,c),i._getGLBlendOperation(t,u)),a.colorBlendOperation=c,a.alphaBlendOperation=u);var v=this.blendColor;oe.equals(e.blendColor,v)||(r.blendColor(v.r,v.g,v.b,v.a),e.blendColor.copyFrom(v))}g!==a.colorWriteMask&&(r.colorMask((g&fr.Red)!==0,(g&fr.Green)!==0,(g&fr.Blue)!==0,(g&fr.Alpha)!==0),a.colorWriteMask=g);var p=this.alphaToCoverage;p!==e.alphaToCoverage&&(p?r.enable(r.SAMPLE_ALPHA_TO_COVERAGE):r.disable(r.SAMPLE_ALPHA_TO_COVERAGE),e.alphaToCoverage=p)},i}(),Ne;(function(i){i[i.Never=0]="Never",i[i.Less=1]="Less",i[i.Equal=2]="Equal",i[i.LessEqual=3]="LessEqual",i[i.Greater=4]="Greater",i[i.NotEqual=5]="NotEqual",i[i.GreaterEqual=6]="GreaterEqual",i[i.Always=7]="Always"})(Ne||(Ne={}));var Z_=function(){function i(){this.enabled=!0,this.writeEnabled=!0,this.compareFunction=Ne.Less}i._getGLCompareFunction=function(t,e){var r=t.gl;switch(e){case Ne.Never:return r.NEVER;case Ne.Less:return r.LESS;case Ne.Equal:return r.EQUAL;case Ne.LessEqual:return r.LEQUAL;case Ne.Greater:return r.GREATER;case Ne.NotEqual:return r.NOTEQUAL;case Ne.GreaterEqual:return r.GEQUAL;case Ne.Always:return r.ALWAYS}};var o=i.prototype;return o._apply=function(t,e){this._platformApply(t,e.depthState)},o._platformApply=function(t,e){var r=t.gl,a=this.enabled,s=this.compareFunction,l=this.writeEnabled;a!=e.enabled&&(a?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),e.enabled=a),a&&(s!=e.compareFunction&&(r.depthFunc(i._getGLCompareFunction(t,s)),e.compareFunction=s),l!=e.writeEnabled&&(r.depthMask(l),e.writeEnabled=l))},i}(),qt;(function(i){i[i.Off=0]="Off",i[i.Front=1]="Front",i[i.Back=2]="Back"})(qt||(qt={}));var K_=function(){function i(){this.cullMode=qt.Back,this.depthBias=0,this.slopeScaledDepthBias=0,this._cullFaceEnable=!0,this._frontFaceInvert=!1}var o=i.prototype;return o._apply=function(t,e,r){this._platformApply(t,e.rasterState,r)},o._platformApply=function(t,e,r){var a=t.gl,s=this.cullMode,l=this.depthBias,c=this.slopeScaledDepthBias,u=s!==qt.Off;u!==e._cullFaceEnable&&(u?a.enable(a.CULL_FACE):a.disable(a.CULL_FACE),e._cullFaceEnable=u),u&&s!==e.cullMode&&(s==qt.Back?a.cullFace(a.BACK):a.cullFace(a.FRONT),e.cullMode=s),r!==e._frontFaceInvert&&(r?a.frontFace(a.CW):a.frontFace(a.CCW),e._frontFaceInvert=r),(l!==e.depthBias||c!==e.slopeScaledDepthBias)&&(l!==0||c!==0?(a.enable(a.POLYGON_OFFSET_FILL),a.polygonOffset(c,l)):a.disable(a.POLYGON_OFFSET_FILL),e.depthBias=l,e.slopeScaledDepthBias=c)},i}(),_t;(function(i){i[i.Keep=0]="Keep",i[i.Zero=1]="Zero",i[i.Replace=2]="Replace",i[i.IncrementSaturate=3]="IncrementSaturate",i[i.DecrementSaturate=4]="DecrementSaturate",i[i.Invert=5]="Invert",i[i.IncrementWrap=6]="IncrementWrap",i[i.DecrementWrap=7]="DecrementWrap"})(_t||(_t={}));var ef=function(){function i(){this.enabled=!1,this.referenceValue=0,this.mask=255,this.writeMask=255,this.compareFunctionFront=Ne.Always,this.compareFunctionBack=Ne.Always,this.passOperationFront=_t.Keep,this.passOperationBack=_t.Keep,this.failOperationFront=_t.Keep,this.failOperationBack=_t.Keep,this.zFailOperationFront=_t.Keep,this.zFailOperationBack=_t.Keep}i._getGLCompareFunction=function(t,e){var r=t.gl;switch(e){case Ne.Never:return r.NEVER;case Ne.Less:return r.LESS;case Ne.Equal:return r.EQUAL;case Ne.LessEqual:return r.LEQUAL;case Ne.Greater:return r.GREATER;case Ne.NotEqual:return r.NOTEQUAL;case Ne.GreaterEqual:return r.GEQUAL;case Ne.Always:return r.ALWAYS}},i._getGLStencilOperation=function(t,e){var r=t.gl;switch(e){case _t.Keep:return r.KEEP;case _t.Zero:return r.ZERO;case _t.Replace:return r.REPLACE;case _t.IncrementSaturate:return r.INCR;case _t.DecrementSaturate:return r.DECR;case _t.Invert:return r.INVERT;case _t.IncrementWrap:return r.INCR_WRAP;case _t.DecrementWrap:return r.DECR_WRAP}};var o=i.prototype;return o._apply=function(t,e){this._platformApply(t,e.stencilState)},o._platformApply=function(t,e){var r=t.gl,a=this.enabled,s=this.referenceValue,l=this.mask,c=this.compareFunctionFront,u=this.compareFunctionBack,h=this.failOperationFront,d=this.zFailOperationFront,f=this.passOperationFront,_=this.failOperationBack,g=this.zFailOperationBack,v=this.passOperationBack,p=this.writeMask;if(a!=e.enabled&&(a?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),e.enabled=a),a){var m=s!==e.referenceValue||l!==e.mask;(m||c!==e.compareFunctionFront)&&(r.stencilFuncSeparate(r.FRONT,i._getGLCompareFunction(t,c),s,l),e.compareFunctionFront=c),(m||u!==e.compareFunctionBack)&&(r.stencilFuncSeparate(r.BACK,i._getGLCompareFunction(t,u),s,l),e.compareFunctionBack=this.compareFunctionBack),m&&(e.referenceValue=this.referenceValue,e.mask=this.mask),(h!==e.failOperationFront||d!==e.zFailOperationFront||f!==e.passOperationFront)&&(r.stencilOpSeparate(r.FRONT,i._getGLStencilOperation(t,h),i._getGLStencilOperation(t,d),i._getGLStencilOperation(t,f)),e.failOperationFront=h,e.zFailOperationFront=d,e.passOperationFront=f),(_!==e.failOperationBack||g!==e.zFailOperationBack||v!==e.passOperationBack)&&(r.stencilOpSeparate(r.BACK,i._getGLStencilOperation(t,_),i._getGLStencilOperation(t,g),i._getGLStencilOperation(t,v)),e.failOperationBack=_,e.zFailOperationBack=g,e.passOperationBack=v),p!==e.writeMask&&(r.stencilMask(p),e.writeMask=p)}},i}(),xh=function(){function i(){this.blendState=new J_,this.depthState=new Z_,this.stencilState=new ef,this.rasterState=new K_}var o=i.prototype;return o._apply=function(t,e){var r=t._hardwareRenderer,a=t._lastRenderState;this.blendState._apply(r,a),this.depthState._apply(r,a),this.stencilState._apply(r,a),this.rasterState._apply(r,a,e)},i}(),pr=function(i){J(o,i);function o(t,e){var r;return r=i.call(this,t)||this,r.name=void 0,r.shader=void 0,r.renderQueueType=bt.Opaque,r.shaderData=new Nn(_r.Material),r.renderState=new xh,r.shader=e,r}var n=o.prototype;return n.clone=function(){var e=new o(this._engine,this.shader);return this.cloneTo(e),e},n.cloneTo=function(e){e.shader=this.shader,e.renderQueueType=this.renderQueueType,this.shaderData.cloneTo(e.shaderData),nr.deepCloneObject(this.renderState,e.renderState)},n._addRefCount=function(e){i.prototype._addRefCount.call(this,e),this.shaderData._addRefCount(e)},n._preRender=function(e){},n._onDestroy=function(){},o}(Gr),Ti=function(){function i(n){this._elementPoolIndex=0,this._elementPool=[],this._type=void 0,this._type=n}var o=i.prototype;return o.getFromPool=function(){var t=this._elementPoolIndex,e=this._elementPool;if(this._elementPoolIndex++,e.length===t){var r=new this._type;return e.push(r),r}else return e[t]},o.resetPool=function(){this._elementPoolIndex=0},i}(),tf=function(){function i(){this._camera=void 0,this._viewProjectMatrix=new ce}var o=i.prototype;return o._setContext=function(t){this._camera=t,ce.multiply(t.projectionMatrix,t.viewMatrix,this._viewProjectMatrix)},i}(),ya=function(){this.component=void 0,this.material=void 0,this.multiRenderData=void 0},bh=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t.mesh=void 0,t.subMesh=void 0,t}var n=o.prototype;return n.setValue=function(e,r,a,s){this.component=e,this.mesh=r,this.subMesh=a,this.material=s},o}(ya),wh=function(i){J(o,i);function o(){var t;return t=i.call(this)||this,t.renderData=void 0,t.texture=void 0,t.multiRenderData=!1,t}var n=o.prototype;return n.setValue=function(e,r,a,s){this.component=e,this.renderData=r,this.material=a,this.texture=s},o}(ya),rf=function(i){J(o,i);function o(){var t;return t=i.call(this)||this,t.renderData=void 0,t.isAdd=!0,t.multiRenderData=!1,t}var n=o.prototype;return n.setValue=function(e,r,a){this.component=e,this.renderData=r,this.material=a},o}(ya),tr;(function(i){i[i.None=0]="None",i[i.VisibleInsideMask=1]="VisibleInsideMask",i[i.VisibleOutsideMask=2]="VisibleOutsideMask"})(tr||(tr={}));var hs,ds,vt,_s,fs,vs,ps,gs,ms,ys,xs,bs,ws,Ss,Cs,Ts,As,Ps,Ms,Xr,Un=(hs=In($t),hs(ds=(vt=(Xr=function(i){J(o,i);function o(t){var e;e=i.call(this,t)||this,U(e,"shaderData",_s,z(e)),U(e,"isCulled",fs,z(e)),U(e,"_distanceForSort",vs,z(e)),U(e,"_onUpdateIndex",ps,z(e)),U(e,"_rendererIndex",gs,z(e)),U(e,"_globalShaderMacro",ms,z(e)),U(e,"_transformChangeFlag",ys,z(e)),U(e,"_bounds",xs,z(e)),U(e,"_overrideUpdate",bs,z(e)),U(e,"_materials",ws,z(e)),U(e,"_mvMatrix",Ss,z(e)),U(e,"_mvpMatrix",Cs,z(e)),U(e,"_mvInvMatrix",Ts,z(e)),U(e,"_normalMatrix",As,z(e)),U(e,"_materialsInstanced",Ps,z(e)),U(e,"_priority",Ms,z(e));var r=o.prototype;return e._overrideUpdate=e.update!==r.update,e._transformChangeFlag=e.entity.transform.registerWorldChangeFlag(),e.shaderData._addRefCount(1),e}var n=o.prototype;return n.getInstanceMaterial=function(e){e===void 0&&(e=0);var r=this._materials;if(r.length>e){var a=r[e];if(a)return this._materialsInstanced[e]?a:this._createInstanceMaterial(a,e)}return null},n.getMaterial=function(e){return e===void 0&&(e=0),this._materials[e]||null},n.setMaterial=function(e,r){r===void 0&&(r=null),typeof e=="number"?this._setMaterial(e,r):this._setMaterial(0,e)},n.getInstanceMaterials=function(){for(var e=this._materials,r=this._materialsInstanced,a=0,s=e.length;a<s;a++)r[a]||this._createInstanceMaterial(this._materials[a],a);return e},n.getMaterials=function(){return this._materials},n.setMaterials=function(e){for(var r=e.length,a=this._materials,s=this._materialsInstanced,l=r,c=a.length;l<c;l++){var u=a[l];u&&u._addRefCount(-1)}a.length!==r&&(a.length=r),s.length!==0&&(s.length=0);for(var h=0;h<r;h++){var d=a[h],f=e[h];d!==f&&(a[h]=f,d&&d._addRefCount(-1),f&&f._addRefCount(1))}},n.update=function(e){},n._updateShaderData=function(e){var r=this.shaderData,a=this.entity.transform.worldMatrix,s=this._mvMatrix,l=this._mvpMatrix,c=this._mvInvMatrix,u=this._normalMatrix;ce.multiply(e._camera.viewMatrix,a,s),ce.multiply(e._viewProjectMatrix,a,l),ce.invert(s,c),ce.invert(a,u),u.transpose(),r.setMatrix(o._localMatrixProperty,this.entity.transform.localMatrix),r.setMatrix(o._worldMatrixProperty,a),r.setMatrix(o._mvMatrixProperty,s),r.setMatrix(o._mvpMatrixProperty,l),r.setMatrix(o._mvInvMatrixProperty,c),r.setMatrix(o._normalMatrixProperty,u)},n._onEnable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.addOnUpdateRenderers(this),e.addRenderer(this)},n._onDisable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.removeOnUpdateRenderers(this),e.removeRenderer(this)},n._render=function(e){throw"not implement"},n._onDestroy=function(){var e=this._transformChangeFlag;e&&(e.destroy(),this._transformChangeFlag=null),this.shaderData._addRefCount(-1);for(var r=this._materials,a=0,s=r.length;a<s;a++){var l;(l=r[a])===null||l===void 0||l._addRefCount(-1)}},n._updateBounds=function(e){},n._createInstanceMaterial=function(e,r){var a=e.clone();return a.name=a.name+"(Instance)",e._addRefCount(-1),a._addRefCount(1),this._materialsInstanced[r]=!0,this._materials[r]=a,a},n._setMaterial=function(e,r){var a=this._materials;e>=a.length&&(a.length=e+1);var s=a[e];if(s!==r){var l=this._materialsInstanced;e<l.length&&(l[e]=!1),s&&s._addRefCount(-1),r&&r._addRefCount(1),a[e]=r}},te(o,[{key:"materialCount",get:function(){return this._materials.length},set:function(e){var r=this._materials,a=this._materialsInstanced;r.length!==e&&(r.length=e),a.length>e&&(a.length=e)}},{key:"bounds",get:function(){var e=this._transformChangeFlag;return e.flag&&(this._updateBounds(this._bounds),e.flag=!1),this._bounds}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}}]),o}(ar),Xr._localMatrixProperty=F.getPropertyByName("u_localMat"),Xr._worldMatrixProperty=F.getPropertyByName("u_modelMat"),Xr._mvMatrixProperty=F.getPropertyByName("u_MVMat"),Xr._mvpMatrixProperty=F.getPropertyByName("u_MVPMat"),Xr._mvInvMatrixProperty=F.getPropertyByName("u_MVInvMat"),Xr._normalMatrixProperty=F.getPropertyByName("u_normalMat"),Xr),_s=k(vt.prototype,"shaderData",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Nn(_r.Renderer)}}),fs=k(vt.prototype,"isCulled",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vs=k(vt.prototype,"_distanceForSort",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ps=k(vt.prototype,"_onUpdateIndex",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),gs=k(vt.prototype,"_rendererIndex",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ms=k(vt.prototype,"_globalShaderMacro",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yt}}),ys=k(vt.prototype,"_transformChangeFlag",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),xs=k(vt.prototype,"_bounds",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ir}}),bs=k(vt.prototype,"_overrideUpdate",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ws=k(vt.prototype,"_materials",[ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ss=k(vt.prototype,"_mvMatrix",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),Cs=k(vt.prototype,"_mvpMatrix",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),Ts=k(vt.prototype,"_mvInvMatrix",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),As=k(vt.prototype,"_normalMatrix",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),Ps=k(vt.prototype,"_materialsInstanced",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ms=k(vt.prototype,"_priority",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vt))||ds);function Sh(){return function(i){}}var Es,Rs,Gn,dn=(Es=Sh(),Es(Rs=(Gn=function(){function i(){}return i.resetData=function(n){var t=n._renderData,e=t.vertexCount=4,r=t.positions,a=t.uvs;if(r.length<e)for(var s=r.length;s<e;s++)r.push(new T),a.push(new q);t.triangles=i._rectangleTriangles},i.updatePositions=function(n){var t=n.width,e=n.height,r=n.sprite,a=r.pivot,s=a.x,l=a.y,c=i._worldMatrix,u=c.elements,h=n.entity.transform.worldMatrix.elements,d=n.flipX?-t:t,f=n.flipY?-e:e;u[0]=h[0]*d,u[1]=h[1]*d,u[2]=h[2]*d,u[4]=h[4]*f,u[5]=h[5]*f,u[6]=h[6]*f,u[8]=h[8],u[9]=h[9],u[10]=h[10],u[12]=h[12]-s*u[0]-l*u[4],u[13]=h[13]-s*u[1]-l*u[5],u[14]=h[14];for(var _=r._getPositions(),g=n._renderData.positions,v=0;v<4;v++){var p=_[v],m=p.x,y=p.y;g[v].set(u[0]*m+u[4]*y+u[12],u[1]*m+u[5]*y+u[13],u[2]*m+u[6]*y+u[14])}ir.transform(r._getBounds(),c,n._bounds)},i.updateUVs=function(n){var t=n.sprite._getUVs(),e=n._renderData.uvs,r=t[0],a=r.x,s=r.y,l=t[3],c=l.x,u=l.y;e[0].set(a,s),e[1].set(c,s),e[2].set(a,u),e[3].set(c,u)},i}(),Gn._rectangleTriangles=[0,1,2,2,1,3],Gn._worldMatrix=new ce,Gn))||Rs),go=function(o,n,t,e,r){e===void 0&&(e=null),r===void 0&&(r=null),this.vertexCount=o,this.positions=n,this.uvs=t,this.triangles=e,this.color=r},je;(function(i){i[i.texture=1]="texture",i[i.size=2]="size",i[i.atlasRotate=4]="atlasRotate",i[i.atlasRegion=8]="atlasRegion",i[i.atlasRegionOffset=16]="atlasRegionOffset",i[i.region=32]="region",i[i.pivot=64]="pivot",i[i.border=128]="border"})(je||(je={}));var tn;(function(i){i[i.Layer0=1]="Layer0",i[i.Layer1=2]="Layer1",i[i.Layer2=4]="Layer2",i[i.Layer3=8]="Layer3",i[i.Layer4=16]="Layer4",i[i.Layer5=32]="Layer5",i[i.Layer6=64]="Layer6",i[i.Layer7=128]="Layer7",i[i.Layer8=256]="Layer8",i[i.Layer9=512]="Layer9",i[i.Layer10=1024]="Layer10",i[i.Layer11=2048]="Layer11",i[i.Layer12=4096]="Layer12",i[i.Layer13=8192]="Layer13",i[i.Layer14=16384]="Layer14",i[i.Layer15=32768]="Layer15",i[i.Layer16=65536]="Layer16",i[i.Layer17=131072]="Layer17",i[i.Layer18=262144]="Layer18",i[i.Layer19=524288]="Layer19",i[i.Layer20=1048576]="Layer20",i[i.Layer21=2097152]="Layer21",i[i.Layer22=4194304]="Layer22",i[i.Layer23=8388608]="Layer23",i[i.Layer24=16777216]="Layer24",i[i.Layer25=33554432]="Layer25",i[i.Layer26=67108864]="Layer26",i[i.Layer27=134217728]="Layer27",i[i.Layer28=268435456]="Layer28",i[i.Layer29=536870912]="Layer29",i[i.Layer30=1073741824]="Layer30",i[i.Layer31=2147483648]="Layer31",i[i.Everything=4294967295]="Everything"})(tn||(tn={}));var sr,Fs,Bs,Ds,Ls,zs,Os,Is,Ns,Us,Hn,Xa=(sr=(Hn=function(i){J(o,i);function o(t){var e;return e=i.call(this,t)||this,U(e,"influenceLayers",Fs,z(e)),e._maskElement=void 0,e._renderData=void 0,U(e,"_sprite",Bs,z(e)),U(e,"_width",Ds,z(e)),U(e,"_height",Ls,z(e)),U(e,"_flipX",zs,z(e)),U(e,"_flipY",Os,z(e)),U(e,"_alphaCutoff",Is,z(e)),U(e,"_dirtyFlag",Ns,z(e)),U(e,"_spriteChangeFlag",Us,z(e)),e._renderData=new go(4,[],[]),dn.resetData(z(e)),e.setMaterial(e._engine._spriteMaskDefaultMaterial),e.shaderData.setFloat(o._alphaCutoffProperty,e._alphaCutoff),e._onSpriteChange=e._onSpriteChange.bind(z(e)),e}var n=o.prototype;return n._onDestroy=function(){this._sprite=null,this._renderData=null,this._spriteChangeFlag&&(this._spriteChangeFlag.destroy(),this._spriteChangeFlag=null),i.prototype._onDestroy.call(this)},n._render=function(e){var r;if(!(!((r=this.sprite)!==null&&r!==void 0&&r.texture)||!this.width||!this.height)){(this._transformChangeFlag.flag||this._dirtyFlag&Ft.Position)&&(dn.updatePositions(this),this._dirtyFlag&=~Ft.Position,this._transformChangeFlag.flag=!1),this._dirtyFlag&Ft.UV&&(dn.updateUVs(this),this._dirtyFlag&=~Ft.UV);var a=this._engine._spriteMaskElementPool,s=a.getFromPool();s.setValue(this,this._renderData,this.getMaterial()),e._renderPipeline._allSpriteMasks.add(this),this._maskElement=s}},n._cloneTo=function(e){e.sprite=this._sprite},n._onSpriteChange=function(e){switch(e){case je.texture:this.shaderData.setTexture(o._textureProperty,this.sprite.texture);break;case je.region:case je.atlasRegionOffset:this._dirtyFlag|=Ft.All;break;case je.atlasRegion:this._dirtyFlag|=Ft.UV;break}},te(o,[{key:"width",get:function(){return this._width===void 0&&this._sprite&&(this.width=this._sprite.width),this._width},set:function(e){this._width!==e&&(this._width=e,this._dirtyFlag|=Ft.Position)}},{key:"height",get:function(){return this._height===void 0&&this._sprite&&(this.height=this._sprite.height),this._height},set:function(e){this._height!==e&&(this._height=e,this._dirtyFlag|=Ft.Position)}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._dirtyFlag|=Ft.Position)}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._dirtyFlag|=Ft.Position)}},{key:"sprite",get:function(){return this._sprite},set:function(e){this._sprite!==e&&(this._sprite=e,this._spriteChangeFlag&&this._spriteChangeFlag.destroy(),e?(this._spriteChangeFlag=e._registerUpdateFlag(),this._spriteChangeFlag.listener=this._onSpriteChange,this._dirtyFlag|=Ft.All,this.shaderData.setTexture(o._textureProperty,e.texture)):(this._spriteChangeFlag=null,this.shaderData.setTexture(o._textureProperty,null)))}},{key:"alphaCutoff",get:function(){return this._alphaCutoff},set:function(e){this._alphaCutoff!==e&&(this._alphaCutoff=e,this.shaderData.setFloat(o._alphaCutoffProperty,e))}},{key:"bounds",get:function(){var e;return!((e=this.sprite)!==null&&e!==void 0&&e.texture)||!this.width||!this.height?yr._defaultBoundingBox:((this._transformChangeFlag.flag||this._dirtyFlag&Ft.Position)&&(dn.updatePositions(this),this._dirtyFlag&=~Ft.Position,this._transformChangeFlag.flag=!1),this._bounds)}}]),o}(Un),Hn._textureProperty=F.getPropertyByName("u_maskTexture"),Hn._alphaCutoffProperty=F.getPropertyByName("u_maskAlphaCutoff"),Hn),Fs=k(sr.prototype,"influenceLayers",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tn.Everything}}),Bs=k(sr.prototype,"_sprite",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ds=k(sr.prototype,"_width",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),Ls=k(sr.prototype,"_height",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),zs=k(sr.prototype,"_flipX",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Os=k(sr.prototype,"_flipY",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Is=k(sr.prototype,"_alphaCutoff",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return .5}}),Ns=k(sr.prototype,"_dirtyFlag",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Us=k(sr.prototype,"_spriteChangeFlag",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sr),Ft;(function(i){i[i.Position=1]="Position",i[i.UV=2]="UV",i[i.All=3]="All"})(Ft||(Ft={}));var ne;(function(i){i[i.Float=0]="Float",i[i.Vector2=1]="Vector2",i[i.Vector3=2]="Vector3",i[i.Vector4=3]="Vector4",i[i.Byte4=4]="Byte4",i[i.UByte4=5]="UByte4",i[i.NormalizedByte4=6]="NormalizedByte4",i[i.NormalizedUByte4=7]="NormalizedUByte4",i[i.Short2=8]="Short2",i[i.UShort2=9]="UShort2",i[i.NormalizedShort2=10]="NormalizedShort2",i[i.NormalizedUShort2=11]="NormalizedUShort2",i[i.Short4=12]="Short4",i[i.UShort4=13]="UShort4",i[i.NormalizedShort4=14]="NormalizedShort4",i[i.NormalizedUShort4=15]="NormalizedUShort4"})(ne||(ne={}));var Pt;(function(i){i[i.Static=0]="Static",i[i.Dynamic=1]="Dynamic",i[i.Stream=2]="Stream"})(Pt||(Pt={}));var nt;(function(i){i[i.UInt8=0]="UInt8",i[i.UInt16=1]="UInt16",i[i.UInt32=2]="UInt32"})(nt||(nt={}));var En=function(){function i(){}return i._getGLBufferUsage=function(n,t){switch(t){case Pt.Static:return n.STATIC_DRAW;case Pt.Dynamic:return n.DYNAMIC_DRAW;case Pt.Stream:return n.STREAM_DRAW}},i._getGLIndexType=function(n){switch(n){case nt.UInt8:return et.UNSIGNED_BYTE;case nt.UInt16:return et.UNSIGNED_SHORT;case nt.UInt32:return et.UNSIGNED_INT}},i._getGLIndexByteCount=function(n){switch(n){case nt.UInt8:return 1;case nt.UInt16:return 2;case nt.UInt32:return 4}},i._getElementInfo=function(n){var t,e,r=!1;switch(n){case ne.Float:t=1,e=et.FLOAT;break;case ne.Vector2:t=2,e=et.FLOAT;break;case ne.Vector3:t=3,e=et.FLOAT;break;case ne.Vector4:t=4,e=et.FLOAT;break;case ne.Byte4:t=4,e=et.BYTE;break;case ne.UByte4:t=4,e=et.UNSIGNED_BYTE;break;case ne.NormalizedByte4:t=4,e=et.BYTE,r=!0;break;case ne.NormalizedUByte4:t=4,e=et.UNSIGNED_BYTE,r=!0;break;case ne.Short2:t=2,e=et.SHORT;break;case ne.UShort2:t=2,e=et.UNSIGNED_SHORT;break;case ne.NormalizedShort2:t=2,e=et.SHORT,r=!0;break;case ne.NormalizedUShort2:t=2,e=et.UNSIGNED_SHORT,r=!0;break;case ne.Short4:t=4,e=et.SHORT;break;case ne.UShort4:t=4,e=et.UNSIGNED_SHORT;break;case ne.NormalizedShort4:t=4,e=et.SHORT,r=!0;break;case ne.NormalizedUShort4:t=4,e=et.UNSIGNED_SHORT,r=!0;break}return{size:t,type:e,normalized:r}},i}(),Ee=function(){function i(o,n,t,e,r){r===void 0&&(r=0),this._glElementInfo=void 0,this._semantic=void 0,this._offset=void 0,this._format=void 0,this._bindingIndex=void 0,this._instanceStepRate=void 0,this._semantic=o,this._offset=n,this._format=t,this._bindingIndex=e,this._glElementInfo=En._getElementInfo(this.format),this._instanceStepRate=Math.floor(r)}return te(i,[{key:"semantic",get:function(){return this._semantic}},{key:"offset",get:function(){return this._offset},set:function(n){this._offset=n}},{key:"format",get:function(){return this._format}},{key:"bindingIndex",get:function(){return this._bindingIndex},set:function(n){this._bindingIndex=n}},{key:"instanceStepRate",get:function(){return this._instanceStepRate}}]),i}(),gr;(function(i){i[i.VertexBuffer=0]="VertexBuffer",i[i.IndexBuffer=1]="IndexBuffer"})(gr||(gr={}));var Rn;(function(i){i[i.None=0]="None",i[i.Discard=1]="Discard"})(Rn||(Rn={}));var Ur=function(i){J(o,i);function o(t,e,r,a){var s;a===void 0&&(a=Pt.Static),s=i.call(this,t)||this,s._glBindTarget=void 0,s._glBufferUsage=void 0,s._nativeBuffer=void 0,s._hardwareRenderer=void 0,s._type=void 0,s._byteLength=void 0,s._bufferUsage=void 0,s._engine=t,s._type=e,s._bufferUsage=a;var l=t._hardwareRenderer,c=l.gl,u=En._getGLBufferUsage(c,a),h=e===gr.VertexBuffer?c.ARRAY_BUFFER:c.ELEMENT_ARRAY_BUFFER;return s._nativeBuffer=c.createBuffer(),s._hardwareRenderer=l,s._glBufferUsage=u,s._glBindTarget=h,s.bind(),typeof r=="number"?(s._byteLength=r,c.bufferData(h,r,u)):(s._byteLength=r.byteLength,c.bufferData(h,r,u)),c.bindBuffer(h,null),s}var n=o.prototype;return n.bind=function(){var e=this._hardwareRenderer.gl;e.bindBuffer(this._glBindTarget,this._nativeBuffer)},n.setData=function(e,r,a,s,l){r===void 0&&(r=0),a===void 0&&(a=0),l===void 0&&(l=Rn.None);var c=this._hardwareRenderer.gl,u=this._hardwareRenderer.isWebGL2,h=this._glBindTarget;this.bind(),l===Rn.Discard&&c.bufferData(h,this._byteLength,this._glBufferUsage);var d=e.BYTES_PER_ELEMENT||1,f=s?d*s:e.byteLength;if(a!==0||f<e.byteLength){var _=e.byteOffset!==void 0;if(u&&_)c.bufferSubData(h,r,e,a,f/d);else{var g=new Uint8Array(_?e.buffer:e,a*d,f);c.bufferSubData(h,r,g)}}else c.bufferSubData(h,r,e);c.bindBuffer(h,null)},n.getData=function(e,r,a,s){r===void 0&&(r=0),a===void 0&&(a=0);var l=this._hardwareRenderer.isWebGL2;if(l){var c=this._hardwareRenderer.gl;this.bind(),c.getBufferSubData(this._glBindTarget,r,e,a,s)}else throw"Buffer is write-only on WebGL1.0 platforms."},n._onDestroy=function(){var e=this._hardwareRenderer.gl;e.deleteBuffer(this._nativeBuffer),this._nativeBuffer=null,this._hardwareRenderer=null},n.resize=function(e){this.bind();var r=this._hardwareRenderer.gl;r.bufferData(this._glBindTarget,e,this._glBufferUsage),this._byteLength=e},te(o,[{key:"type",get:function(){return this._type}},{key:"byteLength",get:function(){return this._byteLength}},{key:"bufferUsage",get:function(){return this._bufferUsage}}]),o}(Gr),oi;(function(i){i[i.Points=0]="Points",i[i.Lines=1]="Lines",i[i.LineLoop=2]="LineLoop",i[i.LineStrip=3]="LineStrip",i[i.Triangles=4]="Triangles",i[i.TriangleStrip=5]="TriangleStrip",i[i.TriangleFan=6]="TriangleFan"})(oi||(oi={}));var oa=function(){function i(o,n){this._buffer=void 0,this._format=void 0,this._buffer=o,this._format=n}return te(i,[{key:"buffer",get:function(){return this._buffer}},{key:"format",get:function(){return this._format}}]),i}(),Fn=function(o,n,t){o===void 0&&(o=0),n===void 0&&(n=0),t===void 0&&(t=oi.Triangles),this.start=void 0,this.count=void 0,this.topology=void 0,this.start=o,this.count=n,this.topology=t},mo=function(i){J(o,i);function o(t,e){var r;return r=i.call(this,t)||this,r.name=void 0,r.bounds=new ir,r._vertexElementMap={},r._glIndexType=void 0,r._glIndexByteCount=void 0,r._platformPrimitive=void 0,r._instanceCount=0,r._vertexBufferBindings=[],r._indexBufferBinding=null,r._vertexElements=[],r._enableVAO=!0,r._subMeshes=[],r._updateFlagManager=new Ri,r.name=e,r._platformPrimitive=r._engine._hardwareRenderer.createPlatformPrimitive(z(r)),r}var n=o.prototype;return n.addSubMesh=function(e,r,a){return a===void 0&&(a=oi.Triangles),typeof e=="number"&&(e=new Fn(e,r,a)),this._subMeshes.push(e),e},n.removeSubMesh=function(e){var r=this._subMeshes,a=r.indexOf(e);a!==-1&&r.splice(a,1)},n.clearSubMesh=function(){this._subMeshes.length=0},n.registerUpdateFlag=function(){return this._updateFlagManager.createFlag(nn)},n._clearVertexElements=function(){this._vertexElements.length=0;var e=this._vertexElementMap;for(var r in e)delete e[r]},n._addVertexElement=function(e){var r=e.semantic;this._vertexElementMap[r]=e,this._vertexElements.push(e),this._updateFlagManager.dispatch()},n._setVertexBufferBinding=function(e,r){if(this._getRefCount()>0){var a=this._vertexBufferBindings[e];a&&a._buffer._addRefCount(-1),r._buffer._addRefCount(1)}this._vertexBufferBindings[e]=r},n._draw=function(e,r){this._platformPrimitive.draw(e,r)},n._addRefCount=function(e){i.prototype._addRefCount.call(this,e);for(var r=this._vertexBufferBindings,a=0,s=r.length;a<s;a++)r[a]._buffer._addRefCount(e)},n._onDestroy=function(){this._vertexBufferBindings=null,this._indexBufferBinding=null,this._vertexElements=null,this._vertexElementMap=null,this._platformPrimitive.destroy()},n._setVertexElements=function(e){this._clearVertexElements();for(var r=0,a=e.length;r<a;r++)this._addVertexElement(e[r])},n._setIndexBufferBinding=function(e){e?(this._indexBufferBinding=e,this._glIndexType=En._getGLIndexType(e.format),this._glIndexByteCount=En._getGLIndexByteCount(e.format)):(this._indexBufferBinding=null,this._glIndexType=void 0)},te(o,[{key:"subMesh",get:function(){return this._subMeshes[0]||null}},{key:"subMeshes",get:function(){return this._subMeshes}}]),o}(Gr),xa=function(){function i(o,n){this._buffer=void 0,this._stride=void 0,this._buffer=o,this._stride=n}return te(i,[{key:"buffer",get:function(){return this._buffer}},{key:"stride",get:function(){return this._stride}}]),i}(),gt;(function(i){i[i.Depth=0]="Depth",i[i.DepthStencil=1]="DepthStencil",i[i.Stencil=2]="Stencil",i[i.Depth16=3]="Depth16",i[i.Depth24=4]="Depth24",i[i.Depth32=5]="Depth32",i[i.Depth24Stencil8=6]="Depth24Stencil8",i[i.Depth32Stencil8=7]="Depth32Stencil8"})(gt||(gt={}));var It;(function(i){i[i.PositiveX=0]="PositiveX",i[i.NegativeX=1]="NegativeX",i[i.PositiveY=2]="PositiveY",i[i.NegativeY=3]="NegativeY",i[i.PositiveZ=4]="PositiveZ",i[i.NegativeZ=5]="NegativeZ"})(It||(It={}));var Ut;(function(i){i[i.Point=0]="Point",i[i.Bilinear=1]="Bilinear",i[i.Trilinear=2]="Trilinear"})(Ut||(Ut={}));var ee;(function(i){i[i.R8G8B8=0]="R8G8B8",i[i.R8G8B8A8=1]="R8G8B8A8",i[i.R4G4B4A4=2]="R4G4B4A4",i[i.R5G5B5A1=3]="R5G5B5A1",i[i.R5G6B5=4]="R5G6B5",i[i.Alpha8=5]="Alpha8",i[i.LuminanceAlpha=6]="LuminanceAlpha",i[i.R16G16B16A16=7]="R16G16B16A16",i[i.R32G32B32A32=8]="R32G32B32A32",i[i.DXT1=9]="DXT1",i[i.DXT5=10]="DXT5",i[i.ETC1_RGB=11]="ETC1_RGB",i[i.ETC2_RGB=12]="ETC2_RGB",i[i.ETC2_RGBA5=13]="ETC2_RGBA5",i[i.ETC2_RGBA8=14]="ETC2_RGBA8",i[i.PVRTC_RGB2=15]="PVRTC_RGB2",i[i.PVRTC_RGBA2=16]="PVRTC_RGBA2",i[i.PVRTC_RGB4=17]="PVRTC_RGB4",i[i.PVRTC_RGBA4=18]="PVRTC_RGBA4",i[i.ASTC_4x4=19]="ASTC_4x4",i[i.ASTC_5x5=20]="ASTC_5x5",i[i.ASTC_6x6=21]="ASTC_6x6",i[i.ASTC_8x8=22]="ASTC_8x8",i[i.ASTC_10x10=23]="ASTC_10x10",i[i.ASTC_12x12=24]="ASTC_12x12",i[i.Depth=25]="Depth",i[i.DepthStencil=26]="DepthStencil",i[i.Stencil=27]="Stencil",i[i.Depth16=28]="Depth16",i[i.Depth24=29]="Depth24",i[i.Depth32=30]="Depth32",i[i.Depth24Stencil8=31]="Depth24Stencil8",i[i.Depth32Stencil8=32]="Depth32Stencil8"})(ee||(ee={}));var Nt;(function(i){i[i.Clamp=0]="Clamp",i[i.Repeat=1]="Repeat",i[i.Mirror=2]="Mirror"})(Nt||(Nt={}));var Bn=function(i){J(o,i);function o(t,e,r,a,s,l){var c;return s===void 0&&(s=gt.Depth),l===void 0&&(l=1),c=i.call(this,t)||this,c._platformRenderTarget=void 0,c._depth=void 0,c._antiAliasing=void 0,c._autoGenerateMipmaps=!0,c._width=void 0,c._height=void 0,c._colorTextures=void 0,c._depthTexture=void 0,c._width=e,c._height=r,c._antiAliasing=l,c._depth=s,a?c._colorTextures=a instanceof Array?a.slice():[a]:c._colorTextures=[],s instanceof Rr&&(c._depthTexture=s),c._platformRenderTarget=t._hardwareRenderer.createPlatformRenderTarget(z(c)),c}var n=o.prototype;return n.getColorTexture=function(e){return e===void 0&&(e=0),this._colorTextures[e]},n.generateMipmaps=function(){if(this._autoGenerateMipmaps){for(var e=this._colorTextures,r=0,a=e.length;r<a;r++){var s=e[r];s.generateMipmaps()}this._depthTexture&&this._depthTexture.generateMipmaps()}},n.destroy=function(){this._platformRenderTarget.destroy(),this._colorTextures.length=0,this._depthTexture=null,this._depth=null},n._setRenderTargetInfo=function(e,r){this._platformRenderTarget.setRenderTargetInfo(e,r)},n._blitRenderTarget=function(){this._platformRenderTarget.blitRenderTarget()},te(o,[{key:"autoGenerateMipmaps",get:function(){return this._autoGenerateMipmaps},set:function(e){this._autoGenerateMipmaps=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorTextureCount",get:function(){return this._colorTextures.length}},{key:"depthTexture",get:function(){return this._depthTexture}},{key:"antiAliasing",get:function(){return this._antiAliasing}}]),o}(Vr),Ct=function(i){J(o,i);function o(t,e,r,a,s){var l;return a===void 0&&(a=ee.R8G8B8A8),s===void 0&&(s=!0),l=i.call(this,t)||this,l._mipmap=s,l._width=e,l._height=r,l._format=a,l._mipmapCount=l._getMipmapCount(),l._platformTexture=t._hardwareRenderer.createPlatformTexture2D(z(l)),l.filterMode=Ut.Bilinear,l.wrapModeU=l.wrapModeV=Nt.Repeat,l}var n=o.prototype;return n.setPixelBuffer=function(e,r,a,s,l,c){r===void 0&&(r=0),a===void 0&&(a=0),s===void 0&&(s=0),this._platformTexture.setPixelBuffer(e,r,a,s,l,c)},n.setImageSource=function(e,r,a,s,l,c){r===void 0&&(r=0),a===void 0&&(a=!1),s===void 0&&(s=!1),l===void 0&&(l=0),c===void 0&&(c=0),this._platformTexture.setImageSource(e,r,a,s,l,c)},n.getPixelBuffer=function(e,r,a,s,l,c){var u=arguments.length;u===1?this._platformTexture.getPixelBuffer(0,0,this._width,this._height,0,e):u===2?this._platformTexture.getPixelBuffer(0,0,this._width>>e,this._height>>e,e,r):u===5?this._platformTexture.getPixelBuffer(e,r,a,s,0,l):u===6&&this._platformTexture.getPixelBuffer(e,r,a,s,l,c)},o}(Rr),yo=function(i){J(o,i);function o(t,e,r,a,s,l){var c;return s===void 0&&(s=ee.R8G8B8A8),l===void 0&&(l=!0),c=i.call(this,t)||this,c._length=void 0,c._mipmap=l,c._width=e,c._height=r,c._length=a,c._format=s,c._mipmapCount=c._getMipmapCount(),c._platformTexture=t._hardwareRenderer.createPlatformTexture2DArray(z(c)),c.filterMode=Ut.Bilinear,c.wrapModeU=c.wrapModeV=Nt.Repeat,c}var n=o.prototype;return n.setPixelBuffer=function(e,r,a,s,l,c,u,h){a===void 0&&(a=0),s===void 0&&(s=0),l===void 0&&(l=0),this._platformTexture.setPixelBuffer(e,r,a,s,l,c,u,h)},n.setImageSource=function(e,r,a,s,l,c,u){a===void 0&&(a=0),s===void 0&&(s=!1),l===void 0&&(l=!1),c===void 0&&(c=0),u===void 0&&(u=0),this._platformTexture.setImageSource(e,r,a,s,l,c,u)},n.getPixelBuffer=function(e,r,a,s,l,c,u){var h=arguments.length;h===1?this._platformTexture.getPixelBuffer(e,0,0,this._width,this._height,0,r):h===2?this._platformTexture.getPixelBuffer(e,0,0,this._width>>r,this._height>>r,r,a):h===5?this._platformTexture.getPixelBuffer(e,r,a,s,l,0,c):h===6&&this._platformTexture.getPixelBuffer(e,r,a,s,l,c,u)},te(o,[{key:"length",get:function(){return this._length}}]),o}(Rr),jt=function(i){J(o,i);function o(t,e,r,a){var s;return r===void 0&&(r=ee.R8G8B8A8),a===void 0&&(a=!0),s=i.call(this,t)||this,s._mipmap=a,s._width=e,s._height=e,s._format=r,s._mipmapCount=s._getMipmapCount(),s._platformTexture=t._hardwareRenderer.createPlatformTextureCube(z(s)),s.filterMode=Ut.Bilinear,s.wrapModeU=s.wrapModeV=Nt.Clamp,s}var n=o.prototype;return n.setPixelBuffer=function(e,r,a,s,l,c,u){a===void 0&&(a=0),s===void 0&&(s=0),l===void 0&&(l=0),this._platformTexture.setPixelBuffer(e,r,a,s,l,c,u)},n.setImageSource=function(e,r,a,s,l,c,u){a===void 0&&(a=0),s===void 0&&(s=!1),l===void 0&&(l=!1),c===void 0&&(c=0),u===void 0&&(u=0),this._platformTexture.setImageSource(e,r,a,s,l,c,u)},n.getPixelBuffer=function(e,r,a,s,l,c,u){var h=arguments.length;h===2?this._platformTexture.getPixelBuffer(e,0,0,this._width,this._height,0,r):h===3?this._platformTexture.getPixelBuffer(e,0,0,this._width>>r,this._height>>r,r,a):h===6?this._platformTexture.getPixelBuffer(e,r,a,s,l,0,c):h===7&&this._platformTexture.getPixelBuffer(e,r,a,s,l,c,u)},o}(Rr),ui=function(){function i(n,t){this._blendShapeCount=0,this._blendShapes=[],this._blendShapeNames=void 0,this._layoutDirtyListener=new pa,this._subDataDirtyFlags=[],this._vertexTexture=void 0,this._vertexBuffers=[],this._vertices=void 0,this._blendShapeCountChangeManager=new Ri,this._useBlendNormal=!1,this._useBlendTangent=!1,this._vertexElementCount=0,this._vertexElementOffset=void 0,this._storeInVertexBufferInfo=[],this._maxCountSingleVertexBuffer=0,this._engine=void 0,this._modelMesh=void 0,this._lastCreateHostInfo=new T(0,0,0),this._canUseTextureStoreData=!0,this._dataTextureInfo=new T,this._engine=n,this._modelMesh=t,this._canUseTextureStoreData=this._engine._hardwareRenderer.capability.canUseFloatTextureBlendShape,this._layoutDirtyListener.listener=this._updateLayoutChange.bind(this)}var o=i.prototype;return o._addBlendShape=function(t){this._blendShapes.push(t),this._blendShapeCount++,t._addLayoutChangeFlag(this._layoutDirtyListener),this._updateLayoutChange(t),this._subDataDirtyFlags.push(t._createSubDataDirtyFlag()),this._blendShapeCountChangeManager.dispatch()},o._clearBlendShapes=function(){this._useBlendNormal=!1,this._useBlendTangent=!1,this._vertexElementCount=0,this._blendShapes.length=0,this._blendShapeCount=0,this._layoutDirtyListener.clearFromManagers();for(var t=this._subDataDirtyFlags,e=0,r=t.length;e<r;e++)t[e].destroy();t.length=0,this._blendShapeCountChangeManager.dispatch()},o._updateShaderData=function(t,e){var r=this._blendShapeCount;if(r>0){if(t.enableMacro(i._blendShapeMacro),this._useTextureMode())t.enableMacro(i._blendShapeTextureMacro),t.setTexture(i._blendShapeTextureProperty,this._vertexTexture),t.setVector3(i._blendShapeTextureInfoProperty,this._dataTextureInfo),t.setFloatArray(i._blendShapeWeightsProperty,e._blendShapeWeights);else{var a=this._getVertexBufferModeSupportCount();if(r>a){var s=e._condensedBlendShapeWeights;s||(s=new Float32Array(a),e._condensedBlendShapeWeights=s),this._filterCondensedBlendShapeWeights(e._blendShapeWeights,s),t.setFloatArray(i._blendShapeWeightsProperty,s),this._modelMesh._enableVAO=!1,r=a}else t.setFloatArray(i._blendShapeWeightsProperty,e._blendShapeWeights),this._modelMesh._enableVAO=!0;t.disableMacro(i._blendShapeTextureMacro)}t.enableMacro("OASIS_BLENDSHAPE_COUNT",r.toString()),this._useBlendNormal?t.enableMacro(i._blendShapeNormalMacro):t.disableMacro(i._blendShapeNormalMacro),this._useBlendTangent?t.enableMacro(i._blendShapeTangentMacro):t.disableMacro(i._blendShapeTangentMacro)}else t.disableMacro(i._blendShapeMacro),t.disableMacro("OASIS_BLENDSHAPE_COUNT")},o._useTextureMode=function(){return this._canUseTextureStoreData?this._blendShapeCount>this._getVertexBufferModeSupportCount():!1},o._layoutOrCountChange=function(){var t=this._lastCreateHostInfo;return t.x!==this._blendShapeCount||!!t.y!==this._useBlendNormal||!!t.z!==this._useBlendTangent},o._vertexElementsNeedUpdate=function(){var t=this._getVertexBufferModeSupportCount(),e=this._lastCreateHostInfo;return Math.min(e.x,t)!==Math.min(this._blendShapeCount,t)||!!e.y!==this._useBlendNormal||!!e.z!==this._useBlendTangent},o._needUpdateData=function(){for(var t=this._subDataDirtyFlags,e=0,r=t.length;e<r;e++)if(t[e].flag)return!0;return!1},o._addVertexElements=function(t){var e=0;this._vertexElementOffset=t._vertexElements.length;for(var r=0,a=Math.min(this._blendShapeCount,this._getVertexBufferModeSupportCount());r<a;r++)t._addVertexElement(new Ee("POSITION_BS"+r,e,ne.Vector3,1)),e+=12,this._useBlendNormal&&(t._addVertexElement(new Ee("NORMAL_BS"+r,e,ne.Vector3,1)),e+=12),this._useBlendTangent&&(t._addVertexElement(new Ee("TANGENT_BS"+r,e,ne.Vector3,1)),e+=12)},o._update=function(t,e){var r=this._modelMesh.vertexCount,a=this._useTextureMode(),s=this._layoutOrCountChange()||t;s&&(a?this._createTextureArray(r):this._createVertexBuffers(r,e),this._lastCreateHostInfo.set(this._blendShapeCount,+this._useBlendNormal,+this._useBlendTangent)),this._needUpdateData()&&(a?this._updateTextureArray(r,s):this._updateVertexBuffers(r,s))},o._releaseMemoryCache=function(){for(var t=this._blendShapes,e=t.length,r=new Array(e),a=0;a<e;a++)r[a]=t[a].name;this._blendShapeNames=r,this._layoutDirtyListener.destroy();for(var s=this._subDataDirtyFlags,l=0,c=s.length;l<c;l++)s[l].destroy();this._layoutDirtyListener=null,this._subDataDirtyFlags=null,this._blendShapes=null,this._vertices=null},o._createVertexBuffers=function(t,e){var r=this._engine,a=this._modelMesh,s=this._blendShapeCount,l=this._vertexBuffers,c=this._vertexElementCount*3,u=c*4,h=Math.floor(255/u),d=Math.ceil(s/h),f=c*t*Math.min(h,s);l.length=d,this._vertices=new Float32Array(f),this._maxCountSingleVertexBuffer=h,this._storeInVertexBufferInfo.length=s;for(var _=0;_<d;_++){var g=d-1,v=_===g?s-g*h:h,p=v*u,m=p*t,y=e?Pt.Static:Pt.Dynamic,x=new Ur(r,gr.VertexBuffer,m,y);a._setVertexBufferBinding(_+1,new xa(x,p)),l[_]=x}},o._createTextureArray=function(t){var e=this._engine._hardwareRenderer.capability.maxTextureSize,r=this._vertexElementCount,a=r*t,s=1;a>e&&(s=Math.ceil(a/e),a=e);var l=this._vertexTexture,c=this._blendShapes.length;l&&l.destroy(),l=new yo(this._engine,a,s,c,ee.R32G32B32A32,!1),l.filterMode=Ut.Point,this._vertices=new Float32Array(c*a*s*4),this._vertexTexture=l,this._dataTextureInfo.set(r,a,s)},o._updateVertexBuffers=function(t,e){for(var r=this._blendShapes,a=this._maxCountSingleVertexBuffer,s=this._vertices,l=this._vertexBuffers,c=this._storeInVertexBufferInfo,u=this._subDataDirtyFlags,h=this._vertexElementCount*3,d=h*4,f=0,_=r.length;f<_;f++){var g=u[f];if(e||g.flag){var v=r[f].frames,p=v.length,m=v[p-1];if(p>0&&m.deltaPositions.length!==t)throw"BlendShape frame deltaPositions length must same with mesh vertexCount.";var y=Math.floor(f/a),x=f%a,S=l[y],w=S.byteLength/(t*4),b=x*h,A=c[f];A||(c[f]=A=new q),A.set(y+1,x*d);for(var E=m.deltaPositions,C=0;C<t;C++){var M=b+w*C,P=E[C];P&&(s[M]=P.x,s[M+1]=P.y,s[M+2]=P.z)}if(b+=3,this._useBlendNormal){var R=m.deltaNormals;if(R)for(var B=0;B<t;B++){var D=b+w*B,L=R[B];L&&(s[D]=L.x,s[D+1]=L.y,s[D+2]=L.z)}b+=3}if(this._useBlendTangent){var N=m.deltaTangents;if(N)for(var W=0;W<t;W++){var I=b+w*W,V=N[W];V&&(s[I]=V.x,s[I+1]=V.y,s[I+2]=V.z)}b+=3}(x===a-1||f===_-1)&&S.setData(s,0,0,S.byteLength/4),g.flag=!1}}},o._updateTextureArray=function(t,e){for(var r=this._blendShapes,a=this._vertexTexture,s=this._vertices,l=this._subDataDirtyFlags,c=0,u=r.length;c<u;c++){var h=l[c],d=a.width*a.height*4;if(e||h.flag){var f=r[c].frames,_=f.length,g=f[_-1];if(_>0&&g.deltaPositions.length!==t)throw"BlendShape frame deltaPositions length must same with mesh vertexCount.";for(var v=g.deltaPositions,p=g.deltaNormals,m=g.deltaTangents,y=c*d,x=0;x<t;x++){var S=v[x];if(s[y]=S.x,s[y+1]=S.y,s[y+2]=S.z,y+=4,p){var w=p[x];s[y]=w.x,s[y+1]=w.y,s[y+2]=w.z,y+=4}if(m){var b=m[x];s[y]=b.x,s[y+1]=b.y,s[y+2]=b.z,y+=4}}h.flag=!1}}a.setPixelBuffer(0,s)},o._updateLayoutChange=function(t){var e=this._blendShapeCount>1,r=1,a=t._useBlendShapeNormal,s=t._useBlendShapeTangent;e&&(a&&(a=this._useBlendNormal),s&&(s=this._useBlendTangent)),a&&r++,s&&r++,this._useBlendNormal=a,this._useBlendTangent=s,this._vertexElementCount=r},o._attributeModeUpdateVertexElement=function(t,e,r,a){var s=this._vertexElementOffset+this._vertexElementCount*a,l=e[r],c=l.x,u=l.y,h=t[s];if(h.bindingIndex=c,h.offset=u,this._useBlendNormal){var d=t[++s];u+=12,d.bindingIndex=c,d.offset=u}if(this._useBlendTangent){var f=t[++s];u+=12,f.bindingIndex=c,f.offset=u}},o._getVertexBufferModeSupportCount=function(){return this._useBlendNormal||this._useBlendTangent?4:8},o._filterCondensedBlendShapeWeights=function(t,e){for(var r=e.length,a=this._modelMesh._vertexElements,s=this._storeInVertexBufferInfo,l=Number.POSITIVE_INFINITY,c,u=0,h=Math.min(t.length,this._blendShapeCount);u<h;u++){var d=t[u];if(u<r)this._attributeModeUpdateVertexElement(a,s,u,u),e[u]=d,d<l&&(l=d,c=u);else if(d>l){this._attributeModeUpdateVertexElement(a,s,u,c),e[c]=d,l=Number.POSITIVE_INFINITY;for(var f=0;f<r;f++){var _=e[f];_<l&&(l=_,c=f)}}}},i}();ui._blendShapeMacro=F.getMacroByName("OASIS_BLENDSHAPE");ui._blendShapeTextureMacro=F.getMacroByName("OASIS_BLENDSHAPE_TEXTURE");ui._blendShapeNormalMacro=F.getMacroByName("OASIS_BLENDSHAPE_NORMAL");ui._blendShapeTangentMacro=F.getMacroByName("OASIS_BLENDSHAPE_TANGENT");ui._blendShapeWeightsProperty=F.getPropertyByName("u_blendShapeWeights");ui._blendShapeTextureProperty=F.getPropertyByName("u_blendShapeTexture");ui._blendShapeTextureInfoProperty=F.getPropertyByName("u_blendShapeTextureInfo");var Wt=function(i){J(o,i);function o(t,e){var r;return r=i.call(this,t)||this,r._blendShapeManager=void 0,r._vertexCount=0,r._accessible=!0,r._verticesFloat32=null,r._verticesUint8=null,r._indices=null,r._indicesFormat=null,r._vertexSlotChanged=!0,r._vertexChangeFlag=0,r._indicesChangeFlag=!1,r._vertexStrideFloat=0,r._lastUploadVertexCount=-1,r._positions=[],r._normals=null,r._colors=null,r._tangents=null,r._uv=null,r._uv1=null,r._uv2=null,r._uv3=null,r._uv4=null,r._uv5=null,r._uv6=null,r._uv7=null,r._boneWeights=null,r._boneIndices=null,r.name=e,r._blendShapeManager=new ui(t,z(r)),r}var n=o.prototype;return n.setPositions=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._positions=e,this._vertexCount=e.length,this._vertexChangeFlag|=Le.Position},n.getPositions=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._positions},n.setNormals=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._normals!=!!e,this._vertexChangeFlag|=Le.Normal,this._normals=e},n.getNormals=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._normals},n.setColors=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._colors!=!!e,this._vertexChangeFlag|=Le.Color,this._colors=e},n.getColors=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._colors},n.setBoneWeights=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=e!=null,this._vertexChangeFlag|=Le.BoneWeight,this._boneWeights=e},n.getBoneWeights=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._boneWeights},n.setBoneIndices=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._boneIndices!=!!e,this._vertexChangeFlag|=Le.BoneIndex,this._boneIndices=e},n.getBoneIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._boneIndices},n.setTangents=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._tangents!=!!e,this._vertexChangeFlag|=Le.Tangent,this._tangents=e},n.getTangents=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._tangents},n.setUVs=function(e,r){var a;if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";switch(r=(a=r)!=null?a:0,r){case 0:this._vertexSlotChanged=!!this._uv!=!!e,this._vertexChangeFlag|=Le.UV,this._uv=e;break;case 1:this._vertexSlotChanged=!!this._uv1!=!!e,this._vertexChangeFlag|=Le.UV1,this._uv1=e;break;case 2:this._vertexSlotChanged=!!this._uv2!=!!e,this._vertexChangeFlag|=Le.UV2,this._uv2=e;break;case 3:this._vertexSlotChanged=!!this._uv3!=!!e,this._vertexChangeFlag|=Le.UV3,this._uv3=e;break;case 4:this._vertexSlotChanged=!!this._uv4!=!!e,this._vertexChangeFlag|=Le.UV4,this._uv4=e;break;case 5:this._vertexSlotChanged=!!this._uv5!=!!e,this._vertexChangeFlag|=Le.UV5,this._uv5=e;break;case 6:this._vertexSlotChanged=!!this._uv6!=!!e,this._vertexChangeFlag|=Le.UV6,this._uv6=e;break;case 7:this._vertexSlotChanged=!!this._uv7!=!!e,this._vertexChangeFlag|=Le.UV7,this._uv7=e;break;default:throw"The index of channel needs to be in range [0 - 7]."}},n.getUVs=function(e){var r;if(!this._accessible)throw"Not allowed to access data while accessible is false.";switch(e=(r=e)!=null?r:0,e){case 0:return this._uv;case 1:return this._uv1;case 2:return this._uv2;case 3:return this._uv3;case 4:return this._uv4;case 5:return this._uv5;case 6:return this._uv6;case 7:return this._uv7}throw"The index of channel needs to be in range [0 - 7]."},n.setIndices=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._indices!==e&&(this._indices=e,e instanceof Uint8Array?this._indicesFormat=nt.UInt8:e instanceof Uint16Array?this._indicesFormat=nt.UInt16:e instanceof Uint32Array&&(this._indicesFormat=nt.UInt32)),this._indicesChangeFlag=!0},n.getIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._indices},n.addBlendShape=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._blendShapeManager._addBlendShape(e)},n.clearBlendShapes=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._blendShapeManager._clearBlendShapes()},n.getBlendShapeName=function(e){if(this._accessible){var r=this._blendShapeManager._blendShapes;return r[e].name}else return this._blendShapeManager._blendShapeNames[e]},n.uploadData=function(e){var r,a;if(!this._accessible)throw"Not allowed to access data while accessible is false.";var s=this._vertexCount,l=this._updateVertexElements(),c=this._lastUploadVertexCount!==s,u=(r=this._vertexBufferBindings[0])===null||r===void 0?void 0:r._buffer;if(c){u==null||u.destroy();var h=this._vertexStrideFloat,d=h*s,f=new Float32Array(d);this._verticesFloat32=f,this._verticesUint8=new Uint8Array(f.buffer),this._updateVertices(f,!0);var _=new Ur(this._engine,gr.VertexBuffer,f,e?Pt.Static:Pt.Dynamic);this._setVertexBufferBinding(0,new xa(_,h*4)),this._lastUploadVertexCount=s}else if(this._vertexChangeFlag&Le.All){var g=this._verticesFloat32;this._updateVertices(g,l),u.setData(g)}var v=this._indices,p=(a=this._indexBufferBinding)===null||a===void 0?void 0:a._buffer;if(v)if(!p||v.byteLength!=p.byteLength){p==null||p.destroy();var m=new Ur(this._engine,gr.IndexBuffer,v);this._setIndexBufferBinding(new oa(m,this._indicesFormat)),this._indicesChangeFlag=!1}else this._indicesChangeFlag&&(p.setData(v),this._indexBufferBinding._format!==this._indicesFormat&&this._setIndexBufferBinding(new oa(p,this._indicesFormat)),this._indicesChangeFlag=!1);else p&&(p.destroy(),this._setIndexBufferBinding(null));var y=this._blendShapeManager;y._blendShapeCount>0&&y._update(c,e),e&&(this._accessible=!1,this._releaseCache())},n._onDestroy=function(){i.prototype._onDestroy.call(this),this._accessible&&this._releaseCache()},n._updateVertexElements=function(){var e=this._blendShapeManager,r=!e._useTextureMode();if(this._vertexSlotChanged||r&&e._vertexElementsNeedUpdate()){var a=12,s=3;return this._clearVertexElements(),this._addVertexElement(nf),this._normals&&(this._addVertexElement(new Ee("NORMAL",a,ne.Vector3,0)),a+=12,s+=3),this._colors&&(this._addVertexElement(new Ee("COLOR_0",a,ne.Vector4,0)),a+=16,s+=4),this._boneWeights&&(this._addVertexElement(new Ee("WEIGHTS_0",a,ne.Vector4,0)),a+=16,s+=4),this._boneIndices&&(this._addVertexElement(new Ee("JOINTS_0",a,ne.UByte4,0)),a+=4,s+=1),this._tangents&&(this._addVertexElement(new Ee("TANGENT",a,ne.Vector4,0)),a+=16,s+=4),this._uv&&(this._addVertexElement(new Ee("TEXCOORD_0",a,ne.Vector2,0)),a+=8,s+=2),this._uv1&&(this._addVertexElement(new Ee("TEXCOORD_1",a,ne.Vector2,0)),a+=8,s+=2),this._uv2&&(this._addVertexElement(new Ee("TEXCOORD_2",a,ne.Vector2,0)),a+=8,s+=2),this._uv3&&(this._addVertexElement(new Ee("TEXCOORD_3",a,ne.Vector2,0)),a+=8,s+=2),this._uv4&&(this._addVertexElement(new Ee("TEXCOORD_4",a,ne.Vector2,0)),a+=8,s+=2),this._uv5&&(this._addVertexElement(new Ee("TEXCOORD_5",a,ne.Vector2,0)),a+=8,s+=2),this._uv6&&(this._addVertexElement(new Ee("TEXCOORD_6",a,ne.Vector2,0)),a+=8,s+=2),this._uv7&&(this._addVertexElement(new Ee("TEXCOORD_7",a,ne.Vector2,0)),a+=8,s+=2),r&&e._blendShapeCount>0&&e._addVertexElements(this),this._vertexSlotChanged=!1,this._vertexStrideFloat=s,!0}return!1},n._updateVertices=function(e,r){var a=this._vertexStrideFloat,s=this._vertexCount,l=this._positions,c=this._normals,u=this._colors,h=this._vertexChangeFlag,d=this._boneWeights,f=this._boneIndices,_=this._tangents,g=this._uv,v=this._uv1,p=this._uv2,m=this._uv3,y=this._uv4,x=this._uv5,S=this._uv6,w=this._uv7;if(r&&(this._vertexChangeFlag=Le.All),h&Le.Position)for(var b=0;b<s;b++){var A=a*b,E=l[b];e[A]=E.x,e[A+1]=E.y,e[A+2]=E.z}var C=3;if(c){if(h&Le.Normal)for(var M=0;M<s;M++){var P=a*M+C,R=c[M];R&&(e[P]=R.x,e[P+1]=R.y,e[P+2]=R.z)}C+=3}if(u){if(h&Le.Color)for(var B=0;B<s;B++){var D=a*B+C,L=u[B];L&&(e[D]=L.r,e[D+1]=L.g,e[D+2]=L.b,e[D+3]=L.a)}C+=4}if(d){if(h&Le.BoneWeight)for(var N=0;N<s;N++){var W=a*N+C,I=d[N];I&&(e[W]=I.x,e[W+1]=I.y,e[W+2]=I.z,e[W+3]=I.w)}C+=4}if(f){if(h&Le.BoneIndex)for(var V=this._verticesUint8,se=0;se<s;se++){var Z=a*se+C,Y=f[se];if(Y){var ue=Z*4;V[ue]=Y.x,V[ue+1]=Y.y,V[ue+2]=Y.z,V[ue+3]=Y.w}}C+=1}if(_){if(h&Le.Tangent)for(var ie=0;ie<s;ie++){var be=a*ie+C,ye=_[ie];ye&&(e[be]=ye.x,e[be+1]=ye.y,e[be+2]=ye.z,e[be+3]=ye.w)}C+=4}if(g){if(h&Le.UV)for(var Fe=0;Fe<s;Fe++){var Qe=a*Fe+C,Be=g[Fe];Be&&(e[Qe]=Be.x,e[Qe+1]=Be.y)}C+=2}if(v){if(h&Le.UV1)for(var Oe=0;Oe<s;Oe++){var Ge=a*Oe+C,Ae=v[Oe];Ae&&(e[Ge]=Ae.x,e[Ge+1]=Ae.y)}C+=2}if(p){if(h&Le.UV2)for(var pe=0;pe<s;pe++){var Je=a*pe+C,Ze=p[pe];Ze&&(e[Je]=Ze.x,e[Je+1]=Ze.y)}C+=2}if(m){if(h&Le.UV3)for(var He=0;He<s;He++){var Ke=a*He+C,ft=m[He];ft&&(e[Ke]=ft.x,e[Ke+1]=ft.y)}C+=2}if(y){if(h&Le.UV4)for(var Ue=0;Ue<s;Ue++){var ke=a*Ue+C,wr=y[Ue];wr&&(e[ke]=wr.x,e[ke+1]=wr.y)}C+=2}if(x){if(h&Le.UV5)for(var Br=0;Br<s;Br++){var $=a*Br+C,X=x[Br];X&&(e[$]=X.x,e[$+1]=X.y)}C+=2}if(S){if(h&Le.UV6)for(var Q=0;Q<s;Q++){var K=a*Q+C,j=S[Q];j&&(e[K]=j.x,e[K+1]=j.y)}C+=2}if(w){if(h&Le.UV7)for(var le=0;le<s;le++){var he=a*le+C,we=w[le];we&&(e[he]=we.x,e[he+1]=we.y)}C+=2}this._vertexChangeFlag=0},n._releaseCache=function(){this._verticesUint8=null,this._indices=null,this._verticesFloat32=null,this._positions.length=0,this._tangents=null,this._normals=null,this._colors=null,this._uv=null,this._uv1=null,this._uv2=null,this._uv3=null,this._uv4=null,this._uv5=null,this._uv6=null,this._uv7=null,this._blendShapeManager._releaseMemoryCache()},te(o,[{key:"accessible",get:function(){return this._accessible}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"blendShapes",get:function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._blendShapeManager._blendShapes}},{key:"blendShapeCount",get:function(){return this._blendShapeManager._blendShapeCount}}]),o}(mo),nf=new Ee("POSITION",0,ne.Vector3,0),Le;(function(i){i[i.Position=1]="Position",i[i.Normal=2]="Normal",i[i.Color=4]="Color",i[i.Tangent=8]="Tangent",i[i.BoneWeight=16]="BoneWeight",i[i.BoneIndex=32]="BoneIndex",i[i.UV=64]="UV",i[i.UV1=128]="UV1",i[i.UV2=256]="UV2",i[i.UV3=512]="UV3",i[i.UV4=1024]="UV4",i[i.UV5=2048]="UV5",i[i.UV6=4096]="UV6",i[i.UV7=8192]="UV7",i[i.All=65535]="All"})(Le||(Le={}));var Ch=function(i){J(o,i);function o(n){var t;return t=i.call(this,null)||this,t.name=n,t.inverseBindMatrices=void 0,t.joints=void 0,t.skeleton=void 0,t.inverseBindMatrices=[],t.joints=[],t.skeleton="none",t}return o}(Vr),Wn,ks,Vs,pi,Ir=(Wn=(pi=function(i){J(o,i);function o(t){var e;return e=i.call(this,t)||this,U(e,"_mesh",ks,z(e)),U(e,"_meshUpdateFlag",Vs,z(e)),e}var n=o.prototype;return n._render=function(e){var r=this._mesh;if(r){if(this._meshUpdateFlag.flag){var a=this.shaderData,s=r._vertexElements;a.disableMacro(o._uvMacro),a.disableMacro(o._uv1Macro),a.disableMacro(o._normalMacro),a.disableMacro(o._tangentMacro),a.disableMacro(o._vertexColorMacro);for(var l=0,c=s.length;l<c;l++){var u=s[l].semantic;switch(u){case"TEXCOORD_0":a.enableMacro(o._uvMacro);break;case"TEXCOORD_1":a.enableMacro(o._uv1Macro);break;case"NORMAL":a.enableMacro(o._normalMacro);break;case"TANGENT":a.enableMacro(o._tangentMacro);break;case"COLOR_0":a.enableMacro(o._vertexColorMacro);break}}this._meshUpdateFlag.flag=!1}for(var h=r.subMeshes,d=e._renderPipeline,f=this._engine._renderElementPool,_=0,g=h.length;_<g;_++){var v=this._materials[_];if(v){var p=f.getFromPool();p.setValue(this,r,h[_],v),d.pushPrimitive(p)}}}else me.error("mesh is null.")},n._onDestroy=function(){i.prototype._onDestroy.call(this);var e=this._mesh;e&&!e.destroyed&&(e._addRefCount(-1),this._mesh=null)},n._cloneTo=function(e){e.mesh=this._mesh},n._updateBounds=function(e){var r=this._mesh;if(r){var a=r.bounds,s=this._entity.transform.worldMatrix;ir.transform(a,s,e)}else e.min.set(0,0,0),e.max.set(0,0,0)},n._setMesh=function(e){var r=this._mesh;r&&(r._addRefCount(-1),this._meshUpdateFlag.destroy()),e&&(e._addRefCount(1),this._meshUpdateFlag=e.registerUpdateFlag()),this._mesh=e},te(o,[{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&this._setMesh(e)}}]),o}(Un),pi._uvMacro=F.getMacroByName("O3_HAS_UV"),pi._uv1Macro=F.getMacroByName("O3_HAS_UV1"),pi._normalMacro=F.getMacroByName("O3_HAS_NORMAL"),pi._tangentMacro=F.getMacroByName("O3_HAS_TANGENT"),pi._vertexColorMacro=F.getMacroByName("O3_HAS_VERTEXCOLOR"),pi),ks=k(Wn.prototype,"_mesh",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Vs=k(Wn.prototype,"_meshUpdateFlag",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Wn),Sr,Gs,Hs,Ws,Xs,js,$s,qs,Ys,Ni,si=(Sr=(Ni=function(i){J(o,i);function o(t){var e;return e=i.call(this,t)||this,U(e,"matrixPalette",Gs,z(e)),U(e,"jointNodes",Hs,z(e)),U(e,"jointTexture",Ws,z(e)),U(e,"_hasInitJoints",Xs,z(e)),U(e,"_mat",js,z(e)),U(e,"_useJointTexture",$s,z(e)),e._skin=void 0,e._blendShapeCountChangeFlag=new nn,U(e,"_blendShapeWeights",qs,z(e)),U(e,"_condensedBlendShapeWeights",Ys,z(e)),e._mat=new ce,e._skin=null,e}var n=o.prototype;return n._updateShaderData=function(e){i.prototype._updateShaderData.call(this,e);var r=this.shaderData;!this._useJointTexture&&this.matrixPalette&&r.setFloatArray(o._jointMatrixProperty,this.matrixPalette);var a=this.mesh;a._blendShapeManager._updateShaderData(r,this)},n._initJoints=function(){if(!!this._skin){for(var e=this._skin,r=e.joints,a=[],s=r.length-1;s>=0;s--)a[s]=this.findByNodeName(this.entity,r[s]);this.matrixPalette=new Float32Array(a.length*16),this.jointNodes=a;var l=this.entity.engine._hardwareRenderer;if(!!l){var c=l.renderStates.getParameter(l.gl.MAX_VERTEX_UNIFORM_VECTORS),u=Math.floor((c-30)/4),h=this.shaderData,d=a.length;if(d)if(h.enableMacro("O3_HAS_SKIN"),h.setInt(o._jointCountProperty,d),d>u)l.canIUseMoreJoints?this._useJointTexture=!0:me.error("component's joints count("+d+") greater than device's MAX_VERTEX_UNIFORM_VECTORS number "+c+", and don't support jointTexture in this device. suggest joint count less than "+u+".",this);else{var f=Math.max(o._maxJoints,d);o._maxJoints=f,h.disableMacro("O3_USE_JOINT_TEXTURE"),h.enableMacro("O3_JOINTS_NUM",f.toString())}else h.disableMacro("O3_HAS_SKIN")}}},n.findByNodeName=function(e,r){if(!e)return null;var a=e.findByName(r);return a||this.findByNodeName(e.parent,r)},n.update=function(){if(this._hasInitJoints||(this._initJoints(),this._hasInitJoints=!0),this._skin){for(var e=this.jointNodes,r=this._skin.inverseBindMatrices,a=this.matrixPalette,s=this.entity.getInvModelMatrix(),l=this._mat,c=e.length-1;c>=0;c--)l.identity(),e[c]?ce.multiply(e[c].transform.worldMatrix,r[c],l):l.copyFrom(r[c]),ce.multiply(s,l,l),a.set(l.elements,c*16);this._useJointTexture&&this.createJointTexture()}},n.createJointTexture=function(){if(!this.jointTexture){var e=this.engine,r=e._hardwareRenderer;if(!r)return;this.jointTexture=new Ct(e,4,this.jointNodes.length,ee.R32G32B32A32,!1),this.jointTexture.filterMode=Ut.Point,this.shaderData.enableMacro("O3_USE_JOINT_TEXTURE"),this.shaderData.setTexture(o._jointSamplerProperty,this.jointTexture)}this.jointTexture.setPixelBuffer(this.matrixPalette)},n._setMesh=function(e){var r=this._mesh;i.prototype._setMesh.call(this,e),r&&this._blendShapeCountChangeFlag.clearFromManagers(),e&&e._blendShapeManager._blendShapeCountChangeManager.addFlag(this._blendShapeCountChangeFlag),this._resetBlendShapeWeights(e)},n._cloneTo=function(e){i.prototype._cloneTo.call(this,e),e.blendShapeWeights=this._blendShapeWeights.slice()},n._resetBlendShapeWeights=function(e){var r=e?e.blendShapeCount:0;this._blendShapeWeights&&this._blendShapeWeights.length!==r?this._blendShapeWeights=new Float32Array(r):this._blendShapeWeights.fill(0)},te(o,[{key:"blendShapeWeights",get:function(){return this._blendShapeCountChangeFlag.flag&&(this._resetBlendShapeWeights(this._mesh),this._blendShapeCountChangeFlag.flag=!1),this._blendShapeWeights},set:function(e){var r=this._blendShapeWeights;if(e.length<=r.length)r.set(e);else for(var a=0,s=r.length;a<s;a++)r[a]=e[a]}},{key:"skin",get:function(){return this._skin},set:function(e){this._skin=e}}]),o}(Ir),Ni._jointCountProperty=F.getPropertyByName("u_jointCount"),Ni._jointSamplerProperty=F.getPropertyByName("u_jointSampler"),Ni._jointMatrixProperty=F.getPropertyByName("u_jointMatrix"),Ni._maxJoints=0,Ni),Gs=k(Sr.prototype,"matrixPalette",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Hs=k(Sr.prototype,"jointNodes",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ws=k(Sr.prototype,"jointTexture",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Xs=k(Sr.prototype,"_hasInitJoints",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),js=k(Sr.prototype,"_mat",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),$s=k(Sr.prototype,"_useJointTexture",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qs=k(Sr.prototype,"_blendShapeWeights",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Float32Array(0)}}),Ys=k(Sr.prototype,"_condensedBlendShapeWeights",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Sr),vn=function(){function i(){}return i.createSphere=function(n,t,e,r){t===void 0&&(t=.5),e===void 0&&(e=18),r===void 0&&(r=!0);var a=new Wt(n);e=Math.max(2,Math.floor(e));for(var s=e+1,l=s*s,c=e*e,u=i._generateIndices(n,l,c*6),h=Math.PI,d=h*2,f=1/s,_=1/e,g=new Array(l),v=new Array(l),p=new Array(l),m=0;m<l;++m){var y=m%s,x=m*f|0,S=y*_,w=x*_,b=S*d,A=w*h,E=Math.sin(A),C=-t*Math.cos(b)*E,M=t*Math.cos(A),P=t*Math.sin(b)*E;g[m]=new T(C,M,P),v[m]=new T(C,M,P),p[m]=new q(S,w)}for(var R=0,B=0;B<c;++B){var D=B%e,L=B*_|0,N=L*s+D,W=N+1,I=N+s,V=I+1;u[R++]=W,u[R++]=N,u[R++]=V,u[R++]=N,u[R++]=I,u[R++]=V}var se=a.bounds;return se.min.set(-t,-t,-t),se.max.set(t,t,t),i._initialize(a,g,v,p,u,r),a},i.createCuboid=function(n,t,e,r,a){t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),a===void 0&&(a=!0);var s=new Wt(n),l=t/2,c=e/2,u=r/2,h=new Array(24),d=new Array(24),f=new Array(24);h[0]=new T(-l,c,-u),h[1]=new T(l,c,-u),h[2]=new T(l,c,u),h[3]=new T(-l,c,u),d[0]=new T(0,1,0),d[1]=new T(0,1,0),d[2]=new T(0,1,0),d[3]=new T(0,1,0),f[0]=new q(0,0),f[1]=new q(1,0),f[2]=new q(1,1),f[3]=new q(0,1),h[4]=new T(-l,-c,-u),h[5]=new T(l,-c,-u),h[6]=new T(l,-c,u),h[7]=new T(-l,-c,u),d[4]=new T(0,-1,0),d[5]=new T(0,-1,0),d[6]=new T(0,-1,0),d[7]=new T(0,-1,0),f[4]=new q(0,1),f[5]=new q(1,1),f[6]=new q(1,0),f[7]=new q(0,0),h[8]=new T(-l,c,-u),h[9]=new T(-l,c,u),h[10]=new T(-l,-c,u),h[11]=new T(-l,-c,-u),d[8]=new T(-1,0,0),d[9]=new T(-1,0,0),d[10]=new T(-1,0,0),d[11]=new T(-1,0,0),f[8]=new q(0,0),f[9]=new q(1,0),f[10]=new q(1,1),f[11]=new q(0,1),h[12]=new T(l,c,-u),h[13]=new T(l,c,u),h[14]=new T(l,-c,u),h[15]=new T(l,-c,-u),d[12]=new T(1,0,0),d[13]=new T(1,0,0),d[14]=new T(1,0,0),d[15]=new T(1,0,0),f[12]=new q(1,0),f[13]=new q(0,0),f[14]=new q(0,1),f[15]=new q(1,1),h[16]=new T(-l,c,u),h[17]=new T(l,c,u),h[18]=new T(l,-c,u),h[19]=new T(-l,-c,u),d[16]=new T(0,0,1),d[17]=new T(0,0,1),d[18]=new T(0,0,1),d[19]=new T(0,0,1),f[16]=new q(0,0),f[17]=new q(1,0),f[18]=new q(1,1),f[19]=new q(0,1),h[20]=new T(-l,c,-u),h[21]=new T(l,c,-u),h[22]=new T(l,-c,-u),h[23]=new T(-l,-c,-u),d[20]=new T(0,0,-1),d[21]=new T(0,0,-1),d[22]=new T(0,0,-1),d[23]=new T(0,0,-1),f[20]=new q(1,0),f[21]=new q(0,0),f[22]=new q(0,1),f[23]=new q(1,1);var _=new Uint16Array(36);_[0]=0,_[1]=2,_[2]=1,_[3]=2,_[4]=0,_[5]=3,_[6]=4,_[7]=6,_[8]=7,_[9]=6,_[10]=4,_[11]=5,_[12]=8,_[13]=10,_[14]=9,_[15]=10,_[16]=8,_[17]=11,_[18]=12,_[19]=14,_[20]=15,_[21]=14,_[22]=12,_[23]=13,_[24]=16,_[25]=18,_[26]=17,_[27]=18,_[28]=16,_[29]=19,_[30]=20,_[31]=22,_[32]=23,_[33]=22,_[34]=20,_[35]=21;var g=s.bounds;return g.min.set(-l,-c,-u),g.max.set(l,c,u),i._initialize(s,h,d,f,_,a),s},i.createPlane=function(n,t,e,r,a,s){t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),a===void 0&&(a=1),s===void 0&&(s=!0);var l=new Wt(n);r=Math.max(1,Math.floor(r)),a=Math.max(1,Math.floor(a));for(var c=r+1,u=a+1,h=t/2,d=e/2,f=t/r,_=e/a,g=c*u,v=a*r,p=i._generateIndices(n,g,v*6),m=1/c,y=1/r,x=1/a,S=new Array(g),w=new Array(g),b=new Array(g),A=0;A<g;++A){var E=A%c,C=A*m|0;S[A]=new T(E*f-h,0,C*_-d),w[A]=new T(0,1,0),b[A]=new q(E*y,C*x)}for(var M=0,P=0;P<v;++P){var R=P%r,B=P*y|0,D=B*c+R,L=D+1,N=D+c,W=N+1;p[M++]=D,p[M++]=N,p[M++]=L,p[M++]=N,p[M++]=W,p[M++]=L}var I=l.bounds;return I.min.set(-h,0,-d),I.max.set(h,0,d),i._initialize(l,S,w,b,p,s),l},i.createCylinder=function(n,t,e,r,a,s,l){t===void 0&&(t=.5),e===void 0&&(e=.5),r===void 0&&(r=2),a===void 0&&(a=20),s===void 0&&(s=1),l===void 0&&(l=!0);var c=new Wt(n);a=Math.floor(a),s=Math.floor(s);for(var u=a+1,h=s+1,d=r*.5,f=r/s,_=u*h,g=a*s,v=a*2,p=_+2+v,m=i._generateIndices(n,p,g*6+v*3),y=1/u,x=1/a,S=1/s,w=new Array(p),b=new Array(p),A=new Array(p),E=0,C=Math.PI,M=Math.PI*2,P=e-t,R=P/r,B=P/s,D=0;D<_;++D){var L=D%u,N=D*y|0,W=L*x,I=N*S,V=C+W*M,se=Math.sin(V),Z=Math.cos(V),Y=e-N*B,ue=Y*se,ie=N*f-d,be=Y*Z;w[D]=new T(ue,ie,be),b[D]=new T(se,R,Z),A[D]=new q(W,1-I)}for(var ye=0;ye<g;++ye){var Fe=ye%a,Qe=ye*x|0,Be=Qe*u+Fe,Oe=Be+1,Ge=Be+u,Ae=Ge+1;m[E++]=Oe,m[E++]=Ge,m[E++]=Be,m[E++]=Oe,m[E++]=Ae,m[E++]=Ge}w[_]=new T(0,-d,0),b[_]=new T(0,-1,0),A[_]=new q(.5,.5),w[_+1]=new T(0,d,0),b[_+1]=new T(0,1,0),A[_+1]=new q(.5,.5);for(var pe=_+2,Je=1/(t*2),Ze=1/(e*2),He=u*s,Ke=0;Ke<a;++Ke){var ft=w[Ke],Ue=ft.x,ke=ft.z;w[pe]=new T(Ue,-d,ke),b[pe]=new T(0,-1,0),A[pe++]=new q(Ue*Ze+.5,.5-ke*Ze);var wr=w[Ke+He];Ue=wr.x,ke=wr.z,w[pe]=new T(Ue,d,ke),b[pe]=new T(0,1,0),A[pe++]=new q(Ue*Je+.5,ke*Je+.5)}for(var Br=_+1,$=_+2,X=$+1,Q=0;Q<a;++Q){var K=Q*2,j=Q===a-1?0:K+2;m[E++]=_,m[E++]=$+j,m[E++]=$+K,m[E++]=Br,m[E++]=X+K,m[E++]=X+j}var le=c.bounds,he=Math.max(t,e);return le.min.set(-he,-d,-he),le.max.set(he,d,he),i._initialize(c,w,b,A,m,l),c},i.createTorus=function(n,t,e,r,a,s,l){t===void 0&&(t=.5),e===void 0&&(e=.1),r===void 0&&(r=30),a===void 0&&(a=30),s===void 0&&(s=360),l===void 0&&(l=!0);var c=new Wt(n);r=Math.floor(r),a=Math.floor(a);var u=(r+1)*(a+1),h=r*a,d=i._generateIndices(n,u,h*6),f=new Array(u),_=new Array(u),g=new Array(u);s=s/180*Math.PI;for(var v=0,p=0;p<=r;p++)for(var m=0;m<=a;m++){var y=m/a*s,x=p/r*Math.PI*2,S=Math.cos(x),w=Math.sin(x),b=Math.cos(y),A=Math.sin(y),E=new T((t+e*S)*b,(t+e*S)*A,e*w);f[v]=E;var C=t*b,M=t*A;_[v]=new T(E.x-C,E.y-M,E.z).normalize(),g[v++]=new q(m/a,p/r)}v=0;for(var P=1;P<=r;P++)for(var R=1;R<=a;R++){var B=(a+1)*P+R-1,D=(a+1)*(P-1)+R-1,L=(a+1)*(P-1)+R,N=(a+1)*P+R;d[v++]=B,d[v++]=D,d[v++]=N,d[v++]=D,d[v++]=L,d[v++]=N}var W=c.bounds,I=t+e;return W.min.set(-I,-I,-e),W.max.set(I,I,e),i._initialize(c,f,_,g,d,l),c},i.createCone=function(n,t,e,r,a,s){t===void 0&&(t=.5),e===void 0&&(e=2),r===void 0&&(r=20),a===void 0&&(a=1),s===void 0&&(s=!0);var l=new Wt(n);r=Math.floor(r),a=Math.floor(a);for(var c=r+1,u=a+1,h=e*.5,d=e/a,f=c*u,_=r*a,g=f+1+r,v=i._generateIndices(n,g,_*6+r*3),p=1/c,m=1/r,y=1/a,x=new Array(g),S=new Array(g),w=new Array(g),b=0,A=Math.PI,E=Math.PI*2,C=t/e,M=0;M<f;++M){var P=M%c,R=M*p|0,B=P*m,D=R*y,L=A+B*E,N=Math.sin(L),W=Math.cos(L),I=t-R*t,V=I*N,se=R*d-h,Z=I*W;x[M]=new T(V,se,Z),S[M]=new T(N,C,W),w[M]=new q(B,1-D)}for(var Y=0;Y<_;++Y){var ue=Y%r,ie=Y*m|0,be=ie*c+ue,ye=be+1,Fe=be+c,Qe=Fe+1;v[b++]=ye,v[b++]=Fe,v[b++]=be,v[b++]=ye,v[b++]=Qe,v[b++]=Fe}x[f]=new T(0,-h,0),S[f]=new T(0,-1,0),w[f]=new q(.5,.5);for(var Be=f+1,Oe=1/(t*2),Ge=0;Ge<r;++Ge){var Ae=x[Ge],pe=Ae.x,Je=Ae.z;x[Be]=new T(pe,-h,Je),S[Be]=new T(0,-1,0),w[Be++]=new q(pe*Oe+.5,.5-Je*Oe)}for(var Ze=f+1,He=0;He<r;++He){var Ke=He,ft=He===r-1?0:Ke+1;v[b++]=f,v[b++]=Ze+ft,v[b++]=Ze+Ke}var Ue=l.bounds;return Ue.min.set(-t,-h,-t),Ue.max.set(t,h,t),i._initialize(l,x,S,w,v,s),l},i.createCapsule=function(n,t,e,r,a,s){t===void 0&&(t=.5),e===void 0&&(e=2),r===void 0&&(r=6),a===void 0&&(a=1),s===void 0&&(s=!0);var l=new Wt(n);r=Math.max(2,Math.floor(r)),a=Math.floor(a);for(var c=r+1,u=a+1,h=e*.5,d=e/a,f=c*u,_=r*a,g=c*c,v=r*r,p=f+2*g,m=i._generateIndices(n,p,(_+2*v)*6),y=1/c,x=1/r,S=1/a,w=Math.PI,b=Math.PI*2,A=new Array(p),E=new Array(p),C=new Array(p),M=0,P=0;P<f;++P){var R=P%c,B=P*y|0,D=R*x,L=B*S,N=w+D*b,W=Math.sin(N),I=Math.cos(N);A[P]=new T(t*W,B*d-h,t*I),E[P]=new T(W,0,I),C[P]=new q(D,1-L)}for(var V=0;V<_;++V){var se=V%r,Z=V*x|0,Y=Z*c+se,ue=Y+1,ie=Y+c,be=ie+1;m[M++]=ue,m[M++]=ie,m[M++]=Y,m[M++]=ue,m[M++]=be,m[M++]=ie}i._createCapsuleCap(t,e,r,b,f,1,A,E,C,m,M),i._createCapsuleCap(t,e,r,-b,f+g,-1,A,E,C,m,M+6*v);var ye=l.bounds;return ye.min.set(-t,-t-h,-t),ye.max.set(t,t+h,t),i._initialize(l,A,E,C,m,s),l},i._initialize=function(n,t,e,r,a,s){n.setPositions(t),n.setNormals(e),n.setUVs(r),n.setIndices(a),n.uploadData(s),n.addSubMesh(0,a.length)},i._generateIndices=function(n,t,e){var r=null;if(t>65535)if(n._hardwareRenderer.canIUse(ae.elementIndexUint))r=new Uint32Array(e);else throw Error("The vertex count is over limit.");else r=new Uint16Array(e);return r},i._createCapsuleCap=function(n,t,e,r,a,s,l,c,u,h,d){for(var f=e+1,_=t*.5*s,g=f*f,v=e*e,p=1/f,m=1/e,y=0;y<g;++y){var x=y%f,S=y*p|0,w=x*m,b=S*m,A=w*r,E=b*Math.PI/2,C=Math.sin(E),M=-n*Math.cos(A)*C,P=n*Math.cos(E)*s+_,R=n*Math.sin(A)*C,B=y+a;l[B]=new T(M,P,R),c[B]=new T(M,P-_,R),u[B]=new q(w,b)}for(var D=0;D<v;++D){var L=D%e,N=D*m|0,W=N*f+L+a,I=W+1,V=W+f,se=V+1;h[d++]=I,h[d++]=W,h[d++]=se,h[d++]=W,h[d++]=V,h[d++]=se}},i}(),ba=function(i){J(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.setVertexElements=function(e){this._setVertexElements(e)},n.setVertexBufferBinding=function(e,r,a){r===void 0&&(r=0),a===void 0&&(a=0);var s=e,l=s.buffer!==void 0;l||(s=new xa(e,r));var c=this._vertexBufferBindings;c.length<=a&&(c.length=a+1),this._setVertexBufferBinding(l?r:a,s)},n.setVertexBufferBindings=function(e,r){r===void 0&&(r=0);var a=this._vertexBufferBindings,s=e.length,l=r+s;a.length<l&&(a.length=l);for(var c=0;c<s;c++)this._setVertexBufferBinding(r+c,e[c])},n.setIndexBufferBinding=function(e,r){var a=e;if(a){var s=a.buffer!==void 0;s||(a=new oa(e,r))}this._setIndexBufferBinding(a)},te(o,[{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"vertexBufferBindings",get:function(){return this._vertexBufferBindings}},{key:"indexBufferBinding",get:function(){return this._indexBufferBinding}},{key:"vertexElements",get:function(){return this._vertexElements}}]),o}(mo),Th=function(o,n,t,e){if(t===void 0&&(t=null),e===void 0&&(e=null),this.weight=void 0,this.deltaPositions=void 0,this.deltaNormals=void 0,this.deltaTangents=void 0,t&&t.length!==n.length)throw"deltaNormals length must same with deltaPositions length.";if(e&&e.length!==n.length)throw"deltaTangents length must same with deltaPositions length.";this.weight=o,this.deltaPositions=n,this.deltaNormals=t,this.deltaTangents=e},xo=function(){function i(n){this.name=void 0,this._useBlendShapeNormal=!0,this._useBlendShapeTangent=!0,this._layoutChangeManager=new Ri,this._dataChangeManager=new Ri,this._frames=[],this.name=n}var o=i.prototype;return o.addFrame=function(t,e,r,a){if(typeof t=="number"){var s=new Th(t,e,r,a);return this._addFrame(s),s}else this._addFrame(t)},o.clearFrames=function(){this._frames.length=0,this._updateUseNormalAndTangent(!0,!0),this._dataChangeManager.dispatch()},o._addLayoutChangeFlag=function(t){this._layoutChangeManager.addFlag(t)},o._addDataDirtyFlag=function(t){this._dataChangeManager.addFlag(t)},o._createSubDataDirtyFlag=function(){return this._dataChangeManager.createFlag(nn)},o._addFrame=function(t){var e=this._frames,r=e.length;if(r>0&&t.deltaPositions.length!==e[r-1].deltaPositions.length)throw"Frame's deltaPositions length must same with before frame deltaPositions length.";this._frames.push(t),this._updateUseNormalAndTangent(!!t.deltaNormals,!!t.deltaTangents),this._dataChangeManager.dispatch()},o._updateUseNormalAndTangent=function(t,e){var r=this._useBlendShapeNormal&&t,a=this._useBlendShapeTangent&&e;(this._useBlendShapeNormal!==r||this._useBlendShapeTangent!==a)&&(this._useBlendShapeNormal=r,this._useBlendShapeTangent=a,this._layoutChangeManager.dispatch(this))},te(i,[{key:"frames",get:function(){return this._frames}}]),i}(),wa=function(){function i(n){this._engine=void 0,this._subMeshPool=new Ti(Fn),this._batchedQueue=[],this._meshes=[],this._meshCount=1,this._vertexBuffers=[],this._indiceBuffers=[],this._vertices=void 0,this._indices=void 0,this._flushId=0,this._vertexCount=0,this._elementCount=0,this._engine=n;var t=i.MAX_VERTEX_COUNT;this._vertices=new Float32Array(t*9),this._indices=new Uint16Array(t*3);for(var e=this._meshes,r=this._meshCount,a=0;a<r;a++)e[a]=this._createMesh(n,a)}var o=i.prototype;return o.drawElement=function(t,e,r){if(t.multiRenderData)for(var a=t.charElements,s=0,l=a.length;s<l;++s)this._drawSubElement(a[s],e,r);else this._drawSubElement(t,e,r)},o._drawSubElement=function(t,e,r){var a=t.renderData.vertexCount;this._vertexCount+a>i.MAX_VERTEX_COUNT&&this.flush(e,r),this._vertexCount+=a,this._batchedQueue[this._elementCount++]=t},o.flush=function(t,e){var r=this._batchedQueue;r.length!==0&&(this._updateData(this._engine),this.drawBatches(t,e),i._canUploadSameBuffer||this._flushId++,r.length=0,this._subMeshPool.resetPool(),this._vertexCount=0,this._elementCount=0)},o.clear=function(){this._flushId=0,this._vertexCount=0,this._elementCount=0,this._batchedQueue.length=0},o.destroy=function(){this._batchedQueue=null;for(var t=this._meshes,e=this._vertexBuffers,r=this._indiceBuffers,a=0,s=t.length;a<s;++a)t[a].destroy();this._meshes=null;for(var l=0,c=e.length;l<c;++l)e[l].destroy();this._vertexBuffers=null;for(var u=0,h=r.length;u<h;++u)r[u].destroy();this._indiceBuffers=null},o._createMesh=function(t,e){var r=i.MAX_VERTEX_COUNT,a=new ba(t,"BufferMesh"+e),s=[],l=this.createVertexElements(s);return this._vertexBuffers[e]=new Ur(t,gr.VertexBuffer,r*4*l,Pt.Dynamic),this._indiceBuffers[e]=new Ur(t,gr.IndexBuffer,r*3,Pt.Dynamic),a.setVertexBufferBinding(this._vertexBuffers[e],l),a.setIndexBufferBinding(this._indiceBuffers[e],nt.UInt16),a.setVertexElements(s),a},o._updateData=function(t){var e=this._meshes,r=this._flushId;!i._canUploadSameBuffer&&this._meshCount<=r&&(this._meshCount++,e[r]=this._createMesh(t,r));var a=this._batchedQueue,s=this._vertices,l=this._indices,c=e[r];c.clearSubMesh();for(var u=0,h=0,d=0,f=0,_=0,g=0,v=null,p=0,m=a.length;p<m;p++){var y=a[p];u=this.updateVertices(y,s,u);for(var x=y.renderData.triangles,S=x.length,w=0;w<S;w++)l[h++]=x[w]+_;_+=y.renderData.vertexCount,v===null||this.canBatch(v,y)?f+=S:(c.addSubMesh(this._getSubMeshFromPool(d,f)),d+=f,f=S,a[g++]=v),v=y}c.addSubMesh(this._getSubMeshFromPool(d,f)),a[g]=v,this._vertexBuffers[r].setData(s,0,0,u),this._indiceBuffers[r].setData(l,0,0,h)},o._getSubMeshFromPool=function(t,e){var r=this._subMeshPool.getFromPool();return r.start=t,r.count=e,r.topology=oi.Triangles,r},i}();wa.MAX_VERTEX_COUNT=4096;wa._canUploadSameBuffer=!0;var af=function(i){J(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.createVertexElements=function(e){return e[0]=new Ee("POSITION",0,ne.Vector3,0),e[1]=new Ee("TEXCOORD_0",12,ne.Vector2,0),20},n.canBatch=function(e,r){if(e.isAdd!==r.isAdd)return!1;var a=e.component.shaderData,s=r.component.shaderData,l=Xa._textureProperty,c=Xa._alphaCutoffProperty;return a.getTexture(l)===s.getTexture(l)&&a.getTexture(c)===s.getTexture(c)},n.updateVertices=function(e,r,a){for(var s=e.renderData,l=s.positions,c=s.uvs,u=s.vertexCount,h=0;h<u;h++){var d=l[h],f=c[h];r[a++]=d.x,r[a++]=d.y,r[a++]=d.z,r[a++]=f.x,r[a++]=f.y}return a},n.drawBatches=function(e){for(var r=this._engine,a=this._batchedQueue,s=this._meshes[this._flushId],l=s.subMeshes,c=e.scene.shaderData,u=e.shaderData,h=0,d=l.length;h<d;h++){var f=l[h],_=a[h];if(!f||!_)return;var g=_.component,v=_.material,p=F._compileMacros;Yt.unionCollection(g._globalShaderMacro,v.shaderData._macroCollection,p);var m=v.renderState.stencilState,y=_.isAdd?_t.IncrementSaturate:_t.DecrementSaturate;m.passOperationFront=y,m.passOperationBack=y;var x=v.shader._getShaderProgram(r,p);if(!x.isValid)return;x.bind(),x.groupingOtherUniformBlock(),x.uploadAll(x.sceneUniformBlock,c),x.uploadAll(x.cameraUniformBlock,u),x.uploadAll(x.rendererUniformBlock,g.shaderData),x.uploadAll(x.materialUniformBlock,v.shaderData),v.renderState._apply(r,!1),r._hardwareRenderer.drawPrimitive(s,f,x)}},o}(wa),of=function(){function i(n){this._batcher=void 0,this._preMaskLayer=0,this._batcher=new af(n)}var o=i.prototype;return o.clear=function(){this._preMaskLayer=0,this._batcher.clear()},o.preRender=function(t,e){e.maskInteraction!==tr.None&&(this._batcher.clear(),this._processMasksDiff(t,e),this._batcher.flush(t,null))},o.postRender=function(t){t.maskInteraction!==tr.None&&(this._preMaskLayer=t.maskLayer)},o.destroy=function(){this._batcher.destroy(),this._batcher=null},o._processMasksDiff=function(t,e){var r=this._preMaskLayer,a=e.maskLayer;if(r!==a)for(var s=t._renderPipeline._allSpriteMasks,l=r&a,c=a&~r,u=r&~a,h=s._elements,d=0,f=s.length;d<f;d++){var _=h[d],g=_.influenceLayers;if(!(g&l)){if(g&c){var v=_._maskElement;v.isAdd=!0,this._batcher.drawElement(v,t,null);continue}if(g&u){var p=_._maskElement;p.isAdd=!1,this._batcher.drawElement(p,t,null)}}}},i}(),sf=function(i){J(o,i);function o(){var n;return n=i.call(this)||this,n.charElements=[],n.multiRenderData=!0,n}return o}(ya),rr;(function(i){i[i.SolidColor=0]="SolidColor",i[i.Sky=1]="Sky",i[i.Texture=2]="Texture"})(rr||(rr={}));var Kr;(function(i){i[i.AspectFitWidth=0]="AspectFitWidth",i[i.AspectFitHeight=1]="AspectFitHeight",i[i.Fill=2]="Fill"})(Kr||(Kr={}));var Ah=function(){this.material=void 0,this.mesh=void 0,this._matrix=new ce},Ph=function(){function i(n){this._engine=n,this.mode=rr.SolidColor,this.solidColor=new oe(.25,.25,.25,1),this.sky=new Ah,this._textureFillMode=Kr.AspectFitHeight,this._mesh=void 0,this._texture=null,this._mesh=this._createPlane(n)}var o=i.prototype;return o._resizeBackgroundTexture=function(){if(!!this._texture){var t=this._engine.canvas,e=t.width,r=t.height,a=this._mesh,s=a.getPositions();switch(this._textureFillMode){case Kr.Fill:s[0].set(-1,-1,1),s[1].set(1,-1,1),s[2].set(-1,1,1),s[3].set(1,1,1);break;case Kr.AspectFitWidth:var l=this._texture.height*e/this.texture.width/r;s[0].set(-1,-l,1),s[1].set(1,-l,1),s[2].set(-1,l,1),s[3].set(1,l,1);break;case Kr.AspectFitHeight:var c=this._texture.width*r/this.texture.height/e;s[0].set(-c,-1,1),s[1].set(c,-1,1),s[2].set(-c,1,1),s[3].set(c,1,1);break}a.setPositions(s),a.uploadData(!1)}},o._createPlane=function(t){var e=new Wt(t);e.isGCIgnored=!0;for(var r=new Uint8Array([1,2,0,1,3,2]),a=new Array(4),s=new Array(4),l=0;l<4;++l)a[l]=new T,s[l]=new q(l%2,1-(l*.5|0));return e.setPositions(a),e.setUVs(s),e.setIndices(r),e.uploadData(!1),e.addSubMesh(0,r.length),e},te(i,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture!==t&&(this._texture=t,this._engine._backgroundTextureMaterial.shaderData.setTexture("u_baseTexture",t))}},{key:"textureFillMode",get:function(){return this._textureFillMode},set:function(t){t!==this._textureFillMode&&(this._textureFillMode=t,this._resizeBackgroundTexture())}}]),i}(),rn;(function(i){i[i.SolidColor=0]="SolidColor",i[i.SphericalHarmonics=1]="SphericalHarmonics"})(rn||(rn={}));var Jt=function(){function i(){this._diffuseSphericalHarmonics=void 0,this._diffuseSolidColor=new oe(.212,.227,.259),this._diffuseIntensity=1,this._specularTexture=void 0,this._specularIntensity=1,this._diffuseMode=rn.SolidColor,this._shArray=new Float32Array(27),this._scenes=[],this._specularTextureDecodeRGBM=!1}var o=i.prototype;return o._addToScene=function(t){this._scenes.push(t);var e=t.shaderData;e.setColor(i._diffuseColorProperty,this._diffuseSolidColor),e.setFloat(i._diffuseIntensityProperty,this._diffuseIntensity),e.setFloat(i._specularIntensityProperty,this._specularIntensity),e.setFloatArray(i._diffuseSHProperty,this._shArray),this._setDiffuseMode(e),this._setSpecularTextureDecodeRGBM(e),this._setSpecularTexture(e)},o._removeFromScene=function(t){var e=this._scenes,r=e.indexOf(t);e.splice(r,1)},o._setDiffuseMode=function(t){this._diffuseMode===rn.SphericalHarmonics?t.enableMacro(i._shMacro):t.disableMacro(i._shMacro)},o._setSpecularTexture=function(t){this._specularTexture?(t.setTexture(i._specularTextureProperty,this._specularTexture),t.setFloat(i._mipLevelProperty,this._specularTexture.mipmapCount-1),t.enableMacro(i._specularMacro)):t.disableMacro(i._specularMacro)},o._setSpecularTextureDecodeRGBM=function(t){this._specularTextureDecodeRGBM?t.enableMacro(i._decodeRGBMMacro):t.disableMacro(i._decodeRGBMMacro)},o._preComputeSH=function(t,e){var r=t.coefficients;e[0]=r[0]*.886227,e[1]=r[1]*.886227,e[2]=r[2]*.886227,e[3]=r[3]*-1.023327,e[4]=r[4]*-1.023327,e[5]=r[5]*-1.023327,e[6]=r[6]*1.023327,e[7]=r[7]*1.023327,e[8]=r[8]*1.023327,e[9]=r[9]*-1.023327,e[10]=r[10]*-1.023327,e[11]=r[11]*-1.023327,e[12]=r[12]*.858086,e[13]=r[13]*.858086,e[14]=r[14]*.858086,e[15]=r[15]*-.858086,e[16]=r[16]*-.858086,e[17]=r[17]*-.858086,e[18]=r[18]*.247708,e[19]=r[19]*.247708,e[20]=r[20]*.247708,e[21]=r[21]*-.858086,e[22]=r[22]*-.858086,e[23]=r[23]*-.858086,e[24]=r[24]*.429042,e[25]=r[25]*.429042,e[26]=r[26]*.429042},te(i,[{key:"specularTextureDecodeRGBM",get:function(){return this._specularTextureDecodeRGBM},set:function(t){this._specularTextureDecodeRGBM=t;for(var e=this._scenes,r=0,a=e.length;r<a;r++)this._setSpecularTextureDecodeRGBM(e[r].shaderData)}},{key:"diffuseMode",get:function(){return this._diffuseMode},set:function(t){this._diffuseMode=t;for(var e=this._scenes,r=0,a=e.length;r<a;r++)this._setDiffuseMode(e[r].shaderData)}},{key:"diffuseSolidColor",get:function(){return this._diffuseSolidColor},set:function(t){t!==this._diffuseSolidColor&&this._diffuseSolidColor.copyFrom(t)}},{key:"diffuseSphericalHarmonics",get:function(){return this._diffuseSphericalHarmonics},set:function(t){if(this._diffuseSphericalHarmonics=t,t){this._preComputeSH(t,this._shArray);for(var e=this._scenes,r=0,a=e.length;r<a;r++)e[r].shaderData.setFloatArray(i._diffuseSHProperty,this._shArray)}}},{key:"diffuseIntensity",get:function(){return this._diffuseIntensity},set:function(t){this._diffuseIntensity=t;for(var e=this._scenes,r=0,a=e.length;r<a;r++)e[r].shaderData.setFloat(i._diffuseIntensityProperty,t)}},{key:"specularTexture",get:function(){return this._specularTexture},set:function(t){this._specularTexture=t;for(var e=this._scenes,r=0,a=e.length;r<a;r++)this._setSpecularTexture(e[r].shaderData)}},{key:"specularIntensity",get:function(){return this._specularIntensity},set:function(t){this._specularIntensity=t;for(var e=0,r=this._scenes.length;e<r;e++)this._scenes[e].shaderData.setFloat(i._specularIntensityProperty,t)}}]),i}();Jt._shMacro=F.getMacroByName("O3_USE_SH");Jt._specularMacro=F.getMacroByName("O3_USE_SPECULAR_ENV");Jt._decodeRGBMMacro=F.getMacroByName("O3_DECODE_ENV_RGBM");Jt._diffuseColorProperty=F.getPropertyByName("u_envMapLight.diffuse");Jt._diffuseSHProperty=F.getPropertyByName("u_env_sh");Jt._diffuseIntensityProperty=F.getPropertyByName("u_envMapLight.diffuseIntensity");Jt._specularTextureProperty=F.getPropertyByName("u_env_specularSampler");Jt._specularIntensityProperty=F.getPropertyByName("u_envMapLight.specularIntensity");Jt._mipLevelProperty=F.getPropertyByName("u_envMapLight.mipMapLevel");var bo=function(){function i(){}var o=i.prototype;return o.preUpdate=function(t){},o.postUpdate=function(t){},o.preRender=function(t,e){},o.postRender=function(t,e){},o.destroy=function(t){},i}(),wt=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t._viewMat=void 0,t._inverseViewMat=void 0,t}var n=o.prototype;return n._onEnable=function(){this.scene.findFeature(Fi).attachRenderLight(this)},n._onDisable=function(){this.scene.findFeature(Fi).detachRenderLight(this)},te(o,[{key:"viewMatrix",get:function(){return this._viewMat||(this._viewMat=new ce),ce.invert(this.entity.transform.worldMatrix,this._viewMat),this._viewMat}},{key:"inverseViewMatrix",get:function(){return this._inverseViewMat||(this._inverseViewMat=new ce),ce.invert(this.viewMatrix,this._inverseViewMat),this._inverseViewMat}}]),o}(ar);wt._maxLight=10;var mr=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t.color=new oe(1,1,1,1),t.intensity=1,t._forward=new T,t._lightColor=new oe(1,1,1,1),t._reverseDirection=new T,t}o._updateShaderData=function(e){var r=o._combinedData;e.setFloatArray(o._colorProperty,r.color),e.setFloatArray(o._directionProperty,r.direction)};var n=o.prototype;return n._appendData=function(e){var r=e*3,a=e*3,s=this.lightColor,l=this.direction,c=o._combinedData;c.color[r]=s.r,c.color[r+1]=s.g,c.color[r+2]=s.b,c.direction[a]=l.x,c.direction[a+1]=l.y,c.direction[a+2]=l.z},te(o,[{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}},{key:"reverseDirection",get:function(){return T.scale(this.direction,-1,this._reverseDirection),this._reverseDirection}}]),o}(wt);mr._colorProperty=F.getPropertyByName("u_directLightColor");mr._directionProperty=F.getPropertyByName("u_directLightDirection");mr._combinedData={color:new Float32Array(3*wt._maxLight),direction:new Float32Array(3*wt._maxLight)};var kr=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t.color=new oe(1,1,1,1),t.intensity=1,t.distance=100,t._lightColor=new oe(1,1,1,1),t}o._updateShaderData=function(e){var r=o._combinedData;e.setFloatArray(o._colorProperty,r.color),e.setFloatArray(o._positionProperty,r.position),e.setFloatArray(o._distanceProperty,r.distance)};var n=o.prototype;return n._appendData=function(e){var r=e*3,a=e*3,s=e,l=this.lightColor,c=this.position,u=o._combinedData;u.color[r]=l.r,u.color[r+1]=l.g,u.color[r+2]=l.b,u.position[a]=c.x,u.position[a+1]=c.y,u.position[a+2]=c.z,u.distance[s]=this.distance},te(o,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}}]),o}(wt);kr._colorProperty=F.getPropertyByName("u_pointLightColor");kr._positionProperty=F.getPropertyByName("u_pointLightPosition");kr._distanceProperty=F.getPropertyByName("u_pointLightDistance");kr._combinedData={color:new Float32Array(3*wt._maxLight),position:new Float32Array(3*wt._maxLight),distance:new Float32Array(wt._maxLight)};var Qt=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t.color=new oe(1,1,1,1),t.intensity=1,t.distance=100,t.angle=Math.PI/6,t.penumbra=Math.PI/12,t._forward=new T,t._lightColor=new oe(1,1,1,1),t._inverseDirection=new T,t}o._updateShaderData=function(e){var r=o._combinedData;e.setFloatArray(o._colorProperty,r.color),e.setFloatArray(o._positionProperty,r.position),e.setFloatArray(o._directionProperty,r.direction),e.setFloatArray(o._distanceProperty,r.distance),e.setFloatArray(o._angleCosProperty,r.angleCos),e.setFloatArray(o._penumbraCosProperty,r.penumbraCos)};var n=o.prototype;return n._appendData=function(e){var r=e*3,a=e*3,s=e*3,l=e,c=e,u=e,h=this.lightColor,d=this.position,f=this.direction,_=o._combinedData;_.color[r]=h.r,_.color[r+1]=h.g,_.color[r+2]=h.b,_.position[a]=d.x,_.position[a+1]=d.y,_.position[a+2]=d.z,_.direction[s]=f.x,_.direction[s+1]=f.y,_.direction[s+2]=f.z,_.distance[l]=this.distance,_.angleCos[u]=Math.cos(this.angle),_.penumbraCos[c]=Math.cos(this.angle+this.penumbra)},te(o,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"reverseDirection",get:function(){return T.scale(this.direction,-1,this._inverseDirection),this._inverseDirection}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}}]),o}(wt);Qt._colorProperty=F.getPropertyByName("u_spotLightColor");Qt._positionProperty=F.getPropertyByName("u_spotLightPosition");Qt._directionProperty=F.getPropertyByName("u_spotLightDirection");Qt._distanceProperty=F.getPropertyByName("u_spotLightDistance");Qt._angleCosProperty=F.getPropertyByName("u_spotLightAngleCos");Qt._penumbraCosProperty=F.getPropertyByName("u_spotLightPenumbraCos");Qt._combinedData={color:new Float32Array(3*wt._maxLight),position:new Float32Array(3*wt._maxLight),direction:new Float32Array(3*wt._maxLight),distance:new Float32Array(wt._maxLight),angleCos:new Float32Array(wt._maxLight),penumbraCos:new Float32Array(wt._maxLight)};function lf(){return this.findFeature(Fi).visibleLights.length>0}var Fi=function(i){J(o,i);function o(){var t;return t=i.call(this)||this,t.visibleLights=void 0,t.visibleLights=[],t}var n=o.prototype;return n.attachRenderLight=function(e){var r=this.visibleLights.indexOf(e);r==-1?this.visibleLights.push(e):me.warn("Light already attached.")},n.detachRenderLight=function(e){var r=this.visibleLights.indexOf(e);r!=-1&&this.visibleLights.splice(r,1)},n._updateShaderData=function(e){for(var r=0,a=0,s=0,l=this.visibleLights,c=0,u=l.length;c<u;c++){var h=l[c];h instanceof mr?h._appendData(r++):h instanceof kr?h._appendData(a++):h instanceof Qt&&h._appendData(s++)}r?(mr._updateShaderData(e),e.enableMacro("O3_DIRECT_LIGHT_COUNT",r.toString())):e.disableMacro("O3_DIRECT_LIGHT_COUNT"),a?(kr._updateShaderData(e),e.enableMacro("O3_POINT_LIGHT_COUNT",a.toString())):e.disableMacro("O3_POINT_LIGHT_COUNT"),s?(Qt._updateShaderData(e),e.enableMacro("O3_SPOT_LIGHT_COUNT",s.toString())):e.disableMacro("O3_SPOT_LIGHT_COUNT")},o}(bo),Nr=function(i){J(o,i);function o(t,e){var r;r=i.call(this,t)||this,r.name=void 0,r.background=new Ph(r._engine),r.shaderData=new Nn(_r.Scene),r._activeCameras=[],r._isActiveInEngine=!1,r._globalShaderMacro=new Yt,r._rootEntities=[],r._ambientLight=void 0,r.features=[],r.name=e||"";var a=r.shaderData;return o.sceneFeatureManager.addObject(z(r)),a._addRefCount(1),r.ambientLight=new Jt,t.sceneManager._allScenes.push(z(r)),r}var n=o.prototype;return n.createRootEntity=function(e){var r=new Lr(this._engine,e);return this.addRootEntity(r),r},n.addRootEntity=function(e,r){var a;typeof e=="number"?a=e:(a=void 0,r=e);var s=r._isRoot;s||(r._isRoot=!0,r._removeFromParent());var l=r._scene;l!==this?(l&&s&&l._removeFromEntityList(r),this._addToRootEntityList(a,r),Lr._traverseSetOwnerScene(r,this)):s||this._addToRootEntityList(a,r),this._isActiveInEngine?!r._isActiveInHierarchy&&r._isActive&&r._processActive():r._isActiveInHierarchy&&r._processInActive()},n.removeRootEntity=function(e){e._isRoot&&e._scene==this&&(this._removeFromEntityList(e),e._isRoot=!1,this._isActiveInEngine&&e._isActiveInHierarchy&&e._processInActive(),Lr._traverseSetOwnerScene(e,null))},n.getRootEntity=function(e){return e===void 0&&(e=0),this._rootEntities[e]},n.findEntityByName=function(e){for(var r=this._rootEntities,a=r.length-1;a>=0;a--){var s=r[a];if(s.name===e)return s}for(var l=r.length-1;l>=0;l--){var c=r[l],u=c.findByName(e);if(u)return u}return null},n.findEntityByPath=function(e){for(var r=e.split("/").filter(Boolean),a=0,s=this.rootEntitiesCount;a<s;a++){var l=this.getRootEntity(a);if(l.name==r[0]){for(var c=1,u=r.length;c<u&&(l=Lr._findChildByName(l,r[c]),!!l);++c);return l}}return null},n.destroy=function(){if(!this._destroyed){this._destroy();var e=this.engine.sceneManager._allScenes;e.splice(e.indexOf(this),1)}},n._attachRenderCamera=function(e){var r=this._activeCameras.indexOf(e);r===-1?this._activeCameras.push(e):me.warn("Camera already attached.")},n._detachRenderCamera=function(e){var r=this._activeCameras.indexOf(e);r!==-1&&this._activeCameras.splice(r,1)},n._processActive=function(e){this._isActiveInEngine=e;for(var r=this._rootEntities,a=r.length-1;a>=0;a--){var s=r[a];s._isActive&&(e?s._processActive():s._processInActive())}},n._updateShaderData=function(){this.findFeature(Fi)._updateShaderData(this.shaderData),Yt.unionCollection(this.engine._macroCollection,this.shaderData._macroCollection,this._globalShaderMacro)},n._removeFromEntityList=function(e){var r=this._rootEntities,a=e._siblingIndex;r.splice(a,1);for(var s=r.length;a<s;a++)r[a]._siblingIndex--;e._siblingIndex=-1},n._destroy=function(){this._isActiveInEngine&&(this._engine.sceneManager.activeScene=null),o.sceneFeatureManager.callFeatureMethod(this,"destroy",[this]);for(var e=0,r=this.rootEntitiesCount;e<r;e++)this._rootEntities[e].destroy();this._rootEntities.length=0,this._activeCameras.length=0,o.sceneFeatureManager._objects=[],this.shaderData._addRefCount(-1)},n._addToRootEntityList=function(e,r){var a=this._rootEntities,s=a.length;if(e===void 0)r._siblingIndex=s,a.push(r);else{if(e<0||e>s)throw"The index "+e+" is out of child list bounds "+s;r._siblingIndex=e,a.splice(e,0,r);for(var l=e+1,c=s+1;l<c;l++)a[l]._siblingIndex++}},o.registerFeature=function(e){o.sceneFeatureManager.registerFeature(e)},n.findFeature=function(e){return o.sceneFeatureManager.findFeature(this,e)},te(o,[{key:"ambientLight",get:function(){return this._ambientLight},set:function(e){if(!e){me.warn("The scene must have one ambient light");return}var r=this._ambientLight;r!==e&&(r&&r._removeFromScene(this),e._addToScene(this),this._ambientLight=e)}},{key:"rootEntitiesCount",get:function(){return this._rootEntities.length}},{key:"rootEntities",get:function(){return this._rootEntities}}]),o}(Vr);Nr.sceneFeatureManager=new _h;var Mh=function(){function i(n){this.engine=n,this._allScenes=[],this._activeScene=void 0}var o=i.prototype;return o.loadScene=function(t,e){var r=this;e===void 0&&(e=!0);var a=this.engine.resourceManager.load(t);return a.then(function(s){var l=r._activeScene;r.activeScene=s,l&&e&&l.destroy()}),a},o.mergeScenes=function(t,e){for(var r=t.rootEntities,a=0,s=r.length;a<s;a++)e.addRootEntity(r[a])},o._destroy=function(){for(var t=this._allScenes,e=0,r=t.length;e<r;e++)t[e]._destroy();t.length=0},te(i,[{key:"activeScene",get:function(){return this._activeScene},set:function(t){var e=this._activeScene;e!==t&&(e&&e._processActive(!1),t&&t._processActive(!0),this._activeScene=t)}}]),i}(),cf=`#define GLSLIFY 1
#include <common>
#include <common_frag>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <mobile_material_frag>
#include <fog_share>
#include <normal_get>
void main(){
#include <begin_mobile_frag>
#include <begin_viewdir_frag>
#include <mobile_blinnphong_frag>
gl_FragColor=emission+ambient+diffuse+specular;gl_FragColor.a=diffuse.a;
#ifndef OASIS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
#include <fog_frag>
}`,uf=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <color_share>
#include <normal_share>
#include <worldpos_share>
#include <shadow_share>
#include <fog_share>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <color_vert>
#include <normal_vert>
#include <worldpos_vert>
#include <shadow_vert>
#include <position_vert>
#include <fog_vert>
}`,hf=`#define GLSLIFY 1
varying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;uniform sampler2D u_texture;void main(){if(v_lifeLeft==1.0){discard;}float alphaFactor=1.0;
#ifdef fadeIn
float fadeInFactor=step(0.5,v_lifeLeft);alphaFactor=2.0*fadeInFactor*(1.0-v_lifeLeft)+(1.0-fadeInFactor);
#endif
#ifdef fadeOut
float fadeOutFactor=step(0.5,v_lifeLeft);alphaFactor=alphaFactor*2.0*(1.0-fadeOutFactor)*v_lifeLeft+alphaFactor*fadeOutFactor;
#endif
#ifdef particleTexture
vec4 tex=texture2D(u_texture,v_uv);
#ifdef useOriginColor
gl_FragColor=vec4(tex.rgb,alphaFactor*tex.a*v_color.w);
#else
gl_FragColor=vec4(v_color.xyz*tex.rgb,alphaFactor*tex.a*v_color.w);
#endif
#else
gl_FragColor=vec4(v_color.xyz,alphaFactor*v_color.w);
#endif
}`,df=`#define GLSLIFY 1
attribute vec3 a_position;attribute vec3 a_velocity;attribute vec3 a_acceleration;attribute vec4 a_color;attribute vec4 a_lifeAndSize;attribute vec2 a_rotation;attribute vec3 a_uv;attribute vec2 a_normalizedUv;uniform float u_time;uniform bool u_once;uniform mat4 u_MVPMat;varying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;
#ifdef is2d
uniform mat4 u_viewInvMat;uniform mat4 u_projMat;uniform mat4 u_viewMat;uniform mat4 u_modelMat;
#endif
mat2 rotation2d(float angle){float s=sin(angle);float c=cos(angle);return mat2(c,-s,s,c);}void main(){v_color=a_color;v_uv=a_uv.xy;float life=a_lifeAndSize.y;float startTime=a_lifeAndSize.x;float deltaTime=max(mod(u_time-startTime,life),0.0);if((u_once&&u_time>life+startTime)){deltaTime=0.0;}v_lifeLeft=1.0-deltaTime/life;float scale=a_lifeAndSize.z;vec3 position=a_position+(a_velocity+a_acceleration*deltaTime*0.5)*deltaTime;
#ifdef isScaleByLifetime
scale*=v_lifeLeft;
#else
scale*=pow(a_lifeAndSize.w,deltaTime);
#endif
#ifdef rotateToVelocity
vec3 v=a_velocity+a_acceleration*deltaTime;float angle=atan(v.z,v.x)*2.0;
#else
float deltaAngle=deltaTime*a_rotation.y;float angle=a_rotation.x+deltaAngle;
#endif
#ifdef is2d
vec2 rotatedPoint=rotation2d(angle)*vec2(a_normalizedUv.x,a_normalizedUv.y*a_uv.z);vec3 basisX=u_viewInvMat[0].xyz;vec3 basisZ=u_viewInvMat[1].xyz;vec3 localPosition=vec3(basisX*rotatedPoint.x+basisZ*rotatedPoint.y)*scale+position;gl_Position=u_projMat*u_viewMat*vec4(localPosition+u_modelMat[3].xyz,1.);
#else
#ifdef rotateToVelocity
float s=sin(angle);float c=cos(angle);
#else
float s=sin(angle);float c=cos(angle);
#endif
vec4 rotatedPoint=vec4((a_normalizedUv.x*c+a_normalizedUv.y*a_uv.z*s)*scale,0.,(a_normalizedUv.x*s-a_normalizedUv.y*a_uv.z*c)*scale,1.);vec4 orientation=vec4(0,0,0,1);vec4 q2=orientation+orientation;vec4 qx=orientation.xxxw*q2.xyzx;vec4 qy=orientation.xyyw*q2.xyzy;vec4 qz=orientation.xxzw*q2.xxzz;mat4 localMatrix=mat4((1.0-qy.y)-qz.z,qx.y+qz.w,qx.z-qy.w,0,qx.y-qz.w,(1.0-qx.x)-qz.z,qy.z+qx.w,0,qx.z+qy.w,qy.z-qx.w,(1.0-qx.x)-qy.y,0,position.x,position.y,position.z,1);rotatedPoint=localMatrix*rotatedPoint;gl_Position=u_MVPMat*rotatedPoint;
#endif
}`,_f=`#define GLSLIFY 1
#define IS_METALLIC_WORKFLOW
#include <common>
#include <common_frag>
#include <fog_share>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <pbr_frag_define>
#include <pbr_helper>
void main(){
#include <pbr_frag>
#include <fog_frag>
}`,ff=`#define GLSLIFY 1
#include <common>
#include <common_frag>
#include <fog_share>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <pbr_frag_define>
#include <pbr_helper>
void main(){
#include <pbr_frag>
#include <fog_frag>
}`,Qs=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <color_share>
#include <normal_share>
#include <worldpos_share>
#include <shadow_share>
#include <fog_share>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <color_vert>
#include <normal_vert>
#include <worldpos_vert>
#include <shadow_vert>
#include <position_vert>
#include <fog_vert>
}`,vf=`#define GLSLIFY 1
vec4 pack(float depth){const vec4 bitShift=vec4(1.0,256.0,256.0*256.0,256.0*256.0*256.0);const vec4 bitMask=vec4(1.0/256.0,1.0/256.0,1.0/256.0,0.0);vec4 rgbaDepth=fract(depth*bitShift);rgbaDepth-=rgbaDepth.gbaa*bitMask;return rgbaDepth;}void main(){gl_FragColor=pack(gl_FragCoord.z);}`,Js=`#define GLSLIFY 1
#include <common_vert>
#include <blendShape_input>
#include <normal_share>
#include <shadow_share>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <shadow_vert>
#include <position_vert>
}`,pf=`#define GLSLIFY 1
#ifdef O3_SHADOW_MAP_COUNT
uniform float u_shadowBias[O3_SHADOW_MAP_COUNT];uniform float u_shadowIntensity[O3_SHADOW_MAP_COUNT];uniform float u_shadowRadius[O3_SHADOW_MAP_COUNT];uniform vec2 u_shadowMapSize[O3_SHADOW_MAP_COUNT];uniform sampler2D u_shadowMaps[O3_SHADOW_MAP_COUNT];varying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];const vec4 bitShift=vec4(1.0,1.0/256.0,1.0/(256.0*256.0),1.0/(256.0*256.0*256.0));float unpack(const in vec4 rgbaDepth){return dot(rgbaDepth,bitShift);}float getVisibility(vec4 positionFromLight,const in sampler2D shadowMap,vec2 mapSize,float intensity,float bias,float radius){vec3 shadowCoord=(positionFromLight.xyz/positionFromLight.w)/2.0+0.5;float filterX=step(0.0,shadowCoord.x)*(1.0-step(1.0,shadowCoord.x));float filterY=step(0.0,shadowCoord.y)*(1.0-step(1.0,shadowCoord.y));shadowCoord.z-=bias;vec2 texelSize=vec2(1.0)/mapSize;float visibility=0.0;for(float y=-1.0;y<=1.0;y+=1.0){for(float x=-1.0;x<=1.0;x+=1.0){vec2 uv=shadowCoord.xy+texelSize*vec2(x,y)*radius;vec4 rgbaDepth=texture2D(shadowMap,uv);float depth=unpack(rgbaDepth);visibility+=step(depth,shadowCoord.z)*intensity;}}visibility*=(1.0/9.0);return visibility*filterX*filterY;}
#endif
void main(){vec4 shadowColor=vec4(1.0,1.0,1.0,1.0);
#ifdef O3_SHADOW_MAP_COUNT
float visibility=1.0;
#if (O3_SHADOW_MAP_COUNT == 1)
visibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);
#elif (O3_SHADOW_MAP_COUNT == 2)
visibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);visibility-=getVisibility(v_PositionFromLight[1],u_shadowMaps[1],u_shadowMapSize[1],u_shadowIntensity[1],u_shadowBias[1],u_shadowRadius[1]);
#elif (O3_SHADOW_MAP_COUNT == 3)
visibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);visibility-=getVisibility(v_PositionFromLight[1],u_shadowMaps[1],u_shadowMapSize[1],u_shadowIntensity[1],u_shadowBias[1],u_shadowRadius[1]);visibility-=getVisibility(v_PositionFromLight[2],u_shadowMaps[2],u_shadowMapSize[2],u_shadowIntensity[2],u_shadowBias[2],u_shadowRadius[2]);
#endif
visibility=clamp(visibility,0.0,1.0);shadowColor=vec4(visibility,visibility,visibility,1.0);
#endif
gl_FragColor=shadowColor;}`,gf=`#define GLSLIFY 1
#include <common>
uniform samplerCube u_cube;varying vec3 v_cubeUV;uniform vec4 u_cubeDecodeParam;void main(){vec4 textureColor=textureCube(u_cube,v_cubeUV);if(u_cubeDecodeParam.x>0.0){textureColor=RGBMToLinear(textureColor,u_cubeDecodeParam.y);textureColor=linearToGamma(textureColor);}gl_FragColor=textureColor;}`,mf=`#define GLSLIFY 1
#include <common_vert>
uniform mat4 u_mvpNoscale;varying vec3 v_cubeUV;void main(){v_cubeUV=vec3(-POSITION.x,POSITION.yz);gl_Position=u_mvpNoscale*vec4(POSITION,1.0);gl_Position.z=gl_Position.w;}`,yf=`#define GLSLIFY 1
uniform sampler2D u_maskTexture;uniform float u_maskAlphaCutoff;varying vec2 v_uv;void main(){vec4 color=texture2D(u_maskTexture,v_uv);if(color.a<u_maskAlphaCutoff){discard;}gl_FragColor=color;}`,xf=`#define GLSLIFY 1
uniform mat4 u_VPMat;attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=u_VPMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`,bf=`#define GLSLIFY 1
#ifdef USE_CUSTOM_TEXTURE
uniform sampler2D u_cusTomTexture;
#else
uniform sampler2D u_spriteTexture;
#endif
varying vec2 v_uv;varying vec4 v_color;void main(){
#ifdef USE_CUSTOM_TEXTURE
vec4 baseColor=texture2D(u_cusTomTexture,v_uv);
#else
vec4 baseColor=texture2D(u_spriteTexture,v_uv);
#endif
gl_FragColor=baseColor*v_color;}`,wf=`#define GLSLIFY 1
#ifdef USE_MODEL_MATRIX
uniform mat4 u_MVPMat;
#else
uniform mat4 u_VPMat;
#endif
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;attribute vec4 COLOR_0;varying vec2 v_uv;varying vec4 v_color;void main(){
#ifdef USE_MODEL_MATRIX
gl_Position=u_MVPMat*vec4(POSITION,1.0);
#else
gl_Position=u_VPMat*vec4(POSITION,1.0);
#endif
v_uv=TEXCOORD_0;v_color=COLOR_0;}`,Sf=`#define GLSLIFY 1
#include <common>
#include <uv_share>
#include <fog_share>
uniform vec4 u_baseColor;uniform float u_alphaCutoff;
#ifdef BASETEXTURE
uniform sampler2D u_baseTexture;
#endif
void main(){vec4 baseColor=u_baseColor;
#ifdef BASETEXTURE
vec4 textureColor=texture2D(u_baseTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
textureColor=gammaToLinear(textureColor);
#endif
baseColor*=textureColor;
#endif
#ifdef ALPHA_CUTOFF
if(baseColor.a<u_alphaCutoff){discard;}
#endif
#ifndef OASIS_COLORSPACE_GAMMA
baseColor=linearToGamma(baseColor);
#endif
gl_FragColor=baseColor;
#include <fog_frag>
}`,Cf=`#define GLSLIFY 1
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <fog_share>
void main(){
#include <begin_position_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <position_vert>
#include <fog_vert>
}`,Tf=`#define GLSLIFY 1
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`,Af=`#define GLSLIFY 1
uniform sampler2D u_baseTexture;varying vec2 v_uv;void main(){gl_FragColor=texture2D(u_baseTexture,v_uv);}`,Pf=function(){function i(){}return i.init=function(){F.create("blinn-phong",uf,cf),F.create("pbr",Qs,_f),F.create("pbr-specular",Qs,ff),F.create("unlit",Cf,Sf),F.create("shadow-map",Js,vf),F.create("shadow",Js,pf),F.create("skybox",mf,gf),F.create("particle-shader",df,hf),F.create("SpriteMask",xf,yf),F.create("Sprite",wf,bf),F.create("background-texture",Tf,Af)},i}(),Mf=function(){function i(){this._cacheHierarchy=1,this._cacheMap=Object.create(null),this._lastQueryMap=void 0,this._lastQueryKey=void 0}var o=i.prototype;return o.get=function(t){var e=this._cacheMap,r=t._length;r>this._cacheHierarchy&&this._resizeCacheMapHierarchy(e,0,r);for(var a=t._mask,s=t._length-1,l=this._cacheHierarchy-1,c=0;c<l;c++){var u=s<c?0:a[c],h=e[u];h||(e[u]=h=Object.create(null)),e=h}var d=s<l?0:a[l],f=e[d];return f||(this._lastQueryKey=d,this._lastQueryMap=e),f},o.cache=function(t){this._lastQueryMap[this._lastQueryKey]=t},o._resizeCacheMapHierarchy=function(t,e,r){var a=this._cacheHierarchy-1;if(e==a){for(var s in t)for(var l=t[s],c=0,u=r-a;c<u;c++)c==u-1?t[0]=l:t=t[c==0?s:0]=Object.create(null);this._cacheHierarchy=r}else for(var h in t)this._resizeCacheMapHierarchy(t[h],++e,r)},i}(),jr=new _h;Pf.init();var yr=function(i){J(o,i);function o(t,e,r){var a;a=i.call(this)||this,a.physicsManager=void 0,a.inputManager=void 0,a._componentsManager=new po,a._hardwareRenderer=void 0,a._lastRenderState=new xh,a._renderElementPool=new Ti(bh),a._spriteElementPool=new Ti(wh),a._spriteMaskElementPool=new Ti(rf),a._textElementPool=new Ti(sf),a._spriteDefaultMaterial=void 0,a._spriteMaskDefaultMaterial=void 0,a._renderContext=new tf,a._whiteTexture2D=void 0,a._whiteTextureCube=void 0,a._whiteTexture2DArray=void 0,a._backgroundTextureMaterial=void 0,a._renderCount=0,a._shaderProgramPools=[],a._spriteMaskManager=void 0,a._canSpriteBatch=!0,a._macroCollection=new Yt,a._canvas=void 0,a._settings={},a._resourceManager=new On(z(a)),a._sceneManager=new Mh(z(a)),a._vSyncCount=1,a._targetFrameRate=60,a._time=new hh,a._isPaused=!0,a._requestId=void 0,a._timeoutId=void 0,a._vSyncCounter=1,a._targetFrameInterval=1e3/60,a._animate=function(){a._vSyncCount?(a._requestId=requestAnimationFrame(a._animate),a._vSyncCounter++%a._vSyncCount===0&&(a.update(),a._vSyncCounter=1)):(a._timeoutId=window.setTimeout(a._animate,a._targetFrameInterval),a.update())},a.features=[],a._hardwareRenderer=e,a._hardwareRenderer.init(t),a.physicsManager=new kt(z(a)),a._canvas=t,jr.addObject(z(a)),a._sceneManager.activeScene=new Nr(z(a),"DefaultScene"),a._spriteMaskManager=new of(z(a)),a._spriteDefaultMaterial=a._createSpriteMaterial(),a._spriteMaskDefaultMaterial=a._createSpriteMaskMaterial(),a.inputManager=new gh(z(a));var s=new Uint8Array([255,255,255,255]),l=new Ct(z(a),1,1,ee.R8G8B8A8,!1);l.setPixelBuffer(s),l.isGCIgnored=!0;var c=new jt(z(a),1,ee.R8G8B8A8,!1);if(c.setPixelBuffer(It.PositiveX,s),c.setPixelBuffer(It.NegativeX,s),c.setPixelBuffer(It.PositiveY,s),c.setPixelBuffer(It.NegativeY,s),c.setPixelBuffer(It.PositiveZ,s),c.setPixelBuffer(It.NegativeZ,s),c.isGCIgnored=!0,a._whiteTexture2D=l,a._whiteTextureCube=c,e.isWebGL2){var u=new yo(z(a),1,1,1,ee.R8G8B8A8,!1);u.setPixelBuffer(0,s),u.isGCIgnored=!0,a._whiteTexture2DArray=u}a._backgroundTextureMaterial=new pr(z(a),F.find("background-texture")),a._backgroundTextureMaterial.isGCIgnored=!0,a._backgroundTextureMaterial.renderState.depthState.compareFunction=Ne.LessEqual;var h=(r==null?void 0:r.colorSpace)||ii.Linear;return h===ii.Gamma&&a._macroCollection.enable(o._gammaMacro),a._settings.colorSpace=h,a}var n=o.prototype;return n.createEntity=function(e){return new Lr(this,e)},n.pause=function(){this._isPaused=!0,cancelAnimationFrame(this._requestId),clearTimeout(this._timeoutId)},n.resume=function(){!this._isPaused||(this._isPaused=!1,this.time.reset(),this._requestId=requestAnimationFrame(this._animate))},n.update=function(){var e=this._time,r=e.deltaTime;e.tick(),this._renderElementPool.resetPool(),this._spriteElementPool.resetPool(),this._spriteMaskElementPool.resetPool(),this._textElementPool.resetPool(),jr.callFeatureMethod(this,"preTick",[this,this._sceneManager._activeScene]);var a=this._sceneManager._activeScene,s=this._componentsManager;a&&(a._activeCameras.sort(function(l,c){return l.priority-c.priority}),s.callScriptOnStart(),this.physicsManager._initialized&&this.physicsManager._update(r/1e3),this.inputManager._update(),s.callScriptOnUpdate(r),s.callAnimationUpdate(r),s.callScriptOnLateUpdate(r),this._render(a),s.handlingInvalidScripts()),jr.callFeatureMethod(this,"postTick",[this,this._sceneManager._activeScene])},n.run=function(){jr.callFeatureMethod(this,"preLoad",[this]),this.resume(),this.trigger(new Ga("run",this))},n.destroy=function(){this._sceneManager&&(this._whiteTexture2D.destroy(!0),this._whiteTextureCube.destroy(!0),this.inputManager._destroy(),this.trigger(new Ga("shutdown",this)),jr.callFeatureMethod(this,"shutdown",[this]),this.pause(),this._animate=null,this._sceneManager._destroy(),this._resourceManager._destroy(),this._componentsManager.handlingInvalidScripts(),this._sceneManager=null,this._resourceManager=null,this._canvas=null,this.features=[],this._time=null,this._spriteMaskManager.destroy(),jr._objects=[],this.removeAllEventListeners())},n._getShaderProgramPool=function(e){var r=e._shaderId,a=this._shaderProgramPools,s=a[r];if(!s){var l=r+1;l<a.length&&(a.length=l),a[r]=s=new Mf}return s},n._render=function(e){var r=e._activeCameras,a=this._componentsManager,s=this.time.deltaTime;if(a.callRendererOnUpdate(s),e._updateShaderData(),r.length>0)for(var l=0,c=r.length;l<c;l++){var u=r[l];a.callCameraOnBeginRender(u),Nr.sceneFeatureManager.callFeatureMethod(e,"preRender",[e,u]),u.render(),Nr.sceneFeatureManager.callFeatureMethod(e,"postRender",[e,u]),a.callCameraOnEndRender(u)}else me.debug("NO active camera.")},n._createSpriteMaterial=function(){var e=new pr(this,F.find("Sprite")),r=e.renderState,a=r.blendState.targetBlendState;return a.enabled=!0,a.sourceColorBlendFactor=de.SourceAlpha,a.destinationColorBlendFactor=de.OneMinusSourceAlpha,a.sourceAlphaBlendFactor=de.One,a.destinationAlphaBlendFactor=de.OneMinusSourceAlpha,a.colorBlendOperation=a.alphaBlendOperation=Xt.Add,r.depthState.writeEnabled=!1,r.rasterState.cullMode=qt.Off,e.renderQueueType=bt.Transparent,e.isGCIgnored=!0,e},n._createSpriteMaskMaterial=function(){var e=new pr(this,F.find("SpriteMask")),r=e.renderState;return r.blendState.targetBlendState.colorWriteMask=fr.None,r.rasterState.cullMode=qt.Off,r.stencilState.enabled=!0,r.depthState.enabled=!1,e.isGCIgnored=!0,e},n.findFeature=function(e){return jr.findFeature(this,e)},o.registerFeature=function(e){jr.registerFeature(e)},te(o,[{key:"settings",get:function(){return this._settings}},{key:"canvas",get:function(){return this._canvas}},{key:"resourceManager",get:function(){return this._resourceManager}},{key:"sceneManager",get:function(){return this._sceneManager}},{key:"time",get:function(){return this._time}},{key:"isPaused",get:function(){return this._isPaused}},{key:"vSyncCount",get:function(){return this._vSyncCount},set:function(e){this._vSyncCount=Math.max(0,Math.floor(e))}},{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(e){e=Math.max(1e-6,e),this._targetFrameRate=e,this._targetFrameInterval=1e3/e}}]),o}(uh);yr._gammaMacro=F.getMacroByName("OASIS_COLORSPACE_GAMMA");yr._pixelsPerUnit=100;yr._defaultBoundingBox=new ir(new T(0,0,0),new T(0,0,0));var Ef=function(){function i(){}return i._isIos=function(){if(!window)return!1;var n=window.navigator.userAgent.toLocaleLowerCase();return/iphone|ipad|ipod/.test(n)},te(i,null,[{key:"devicePixelRatio",get:function(){return window.devicePixelRatio}}]),i}(),Rf=function(){function i(){}var o=i.prototype;return o.preLoad=function(t){},o.preTick=function(t,e){},o.postTick=function(t,e){},o.shutdown=function(t){},i}(),lr,Zs,Ks,el,tl,rl,il,nl,al,ol,Di=(lr=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,U(t,"_started",Zs,z(t)),U(t,"_onStartIndex",Ks,z(t)),U(t,"_onUpdateIndex",el,z(t)),U(t,"_onLateUpdateIndex",tl,z(t)),U(t,"_onPhysicsUpdateIndex",rl,z(t)),U(t,"_onPreRenderIndex",il,z(t)),U(t,"_onPostRenderIndex",nl,z(t)),U(t,"_entityScriptsIndex",al,z(t)),U(t,"_waitHandlingInValid",ol,z(t)),t}var n=o.prototype;return n.onAwake=function(){},n.onEnable=function(){},n.onStart=function(){},n.onUpdate=function(e){},n.onLateUpdate=function(e){},n.onBeginRender=function(e){},n.onEndRender=function(e){},n.onPhysicsUpdate=function(){},n.onTriggerEnter=function(e){},n.onTriggerExit=function(e){},n.onTriggerStay=function(e){},n.onCollisionEnter=function(e){},n.onCollisionExit=function(e){},n.onCollisionStay=function(e){},n.onPointerDown=function(){},n.onPointerUp=function(){},n.onPointerClick=function(){},n.onPointerEnter=function(){},n.onPointerExit=function(){},n.onPointerDrag=function(){},n.onDisable=function(){},n.onDestroy=function(){},n._onAwake=function(){this.onAwake()},n._onEnable=function(){if(this._waitHandlingInValid)this._waitHandlingInValid=!1;else{var e=this.engine._componentsManager,r=o.prototype;this._started||e.addOnStartScript(this),this.onUpdate!==r.onUpdate&&e.addOnUpdateScript(this),this.onLateUpdate!==r.onLateUpdate&&e.addOnLateUpdateScript(this),this.onPhysicsUpdate!==r.onPhysicsUpdate&&e.addOnPhysicsUpdateScript(this),this._entity._addScript(this)}this.onEnable()},n._onDisable=function(){this._waitHandlingInValid=!0,this._engine._componentsManager.addDisableScript(this),this.onDisable()},n._onDestroy=function(){this._engine._componentsManager.addDestroyScript(this)},n._handlingInValid=function(){var e=this.engine._componentsManager;this._onUpdateIndex!==-1&&e.removeOnUpdateScript(this),this._onLateUpdateIndex!==-1&&e.removeOnLateUpdateScript(this),this._onPhysicsUpdateIndex!==-1&&e.removeOnPhysicsUpdateScript(this),this._entityScriptsIndex!==-1&&this._entity._removeScript(this),this._waitHandlingInValid=!1},o}(ar),Zs=k(lr.prototype,"_started",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ks=k(lr.prototype,"_onStartIndex",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),el=k(lr.prototype,"_onUpdateIndex",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),tl=k(lr.prototype,"_onLateUpdateIndex",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),rl=k(lr.prototype,"_onPhysicsUpdateIndex",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),il=k(lr.prototype,"_onPreRenderIndex",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),nl=k(lr.prototype,"_onPostRenderIndex",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),al=k(lr.prototype,"_entityScriptsIndex",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ol=k(lr.prototype,"_waitHandlingInValid",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lr),Ff=0,ei=function(){function i(n,t,e,r,a){n===void 0&&(n="RENDER_PASS"+Ff++),t===void 0&&(t=0),e===void 0&&(e=null),r===void 0&&(r=null),a===void 0&&(a=null),this.name=void 0,this.enabled=void 0,this.priority=void 0,this.renderTarget=void 0,this.replaceMaterial=void 0,this.mask=void 0,this.renderOverride=void 0,this.clearFlags=void 0,this.clearColor=void 0,this.name=n,this.enabled=!0,this.priority=t,this.renderTarget=e,this.replaceMaterial=r,this.mask=a||Ot.Everything,this.renderOverride=!1}var o=i.prototype;return o.render=function(t,e,r,a){},o.preRender=function(t,e,r,a){},o.postRender=function(t,e,r,a){},i}(),Eh=function(i){J(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.createVertexElements=function(e){return e[0]=new Ee("POSITION",0,ne.Vector3,0),e[1]=new Ee("TEXCOORD_0",12,ne.Vector2,0),e[2]=new Ee("COLOR_0",20,ne.Vector4,0),36},n.canBatch=function(e,r){if(!this._engine._canSpriteBatch)return!1;var a=e.component,s=r.component;return!this.checkBatchWithMask(a,s)||e.texture!==r.texture?!1:e.material===r.material},n.checkBatchWithMask=function(e,r){var a=e.maskInteraction;return a!==r.maskInteraction?!1:a===tr.None?!0:e.maskLayer===r.maskLayer},n.updateVertices=function(e,r,a){for(var s=e.renderData,l=s.positions,c=s.uvs,u=s.color,h=s.vertexCount,d=0;d<h;d++){var f=l[d],_=c[d];r[a++]=f.x,r[a++]=f.y,r[a++]=f.z,r[a++]=_.x,r[a++]=_.y,r[a++]=u.r,r[a++]=u.g,r[a++]=u.b,r[a++]=u.a}return a},n.drawBatches=function(e,r){for(var a=this._engine,s=this._batchedQueue,l=this._meshes[this._flushId],c=l.subMeshes,u=a._spriteMaskManager,h=e.scene.shaderData,d=e.shaderData,f=0,_=c.length;f<_;f++){var g=c[f],v=s[f];if(!g||!v)return;var p=v.component,m=v.material;u.preRender(e,p);var y=F._compileMacros;Yt.unionCollection(p._globalShaderMacro,m.shaderData._macroCollection,y),(r||m)._preRender(v);var x=(r||m).shader._getShaderProgram(a,y);if(!x.isValid)return;p.shaderData.setTexture(o._textureProperty,v.texture),x.bind(),x.groupingOtherUniformBlock(),x.uploadAll(x.sceneUniformBlock,h),x.uploadAll(x.cameraUniformBlock,d),x.uploadAll(x.rendererUniformBlock,p.shaderData),x.uploadAll(x.materialUniformBlock,m.shaderData),m.renderState._apply(a,!1),a._hardwareRenderer.drawPrimitive(l,g,x),u.postRender(p)}},n.destroy=function(){this._batchedQueue=null;for(var e=this._meshes,r=this._vertexBuffers,a=this._indiceBuffers,s=0,l=e.length;s<l;++s)e[s].destroy();this._meshes=null;for(var c=0,u=r.length;c<u;++c)r[c].destroy();this._vertexBuffers=null;for(var h=0,d=a.length;h<d;++h)a[h].destroy();this._indiceBuffers=null},o}(wa);Eh._textureProperty=F.getPropertyByName("u_spriteTexture");var bi=function(){i._compareFromNearToFar=function(t,e){return t.component.priority-e.component.priority||t.component._distanceForSort-e.component._distanceForSort},i._compareFromFarToNear=function(t,e){return t.component.priority-e.component.priority||e.component._distanceForSort-t.component._distanceForSort};function i(n){this.items=[],this._spriteBatcher=void 0,this._spriteBatcher=new Eh(n)}var o=i.prototype;return o.pushPrimitive=function(t){this.items.push(t)},o.render=function(t,e,r){var a=this.items;if(a.length!==0){for(var s=t.engine,l=t.scene,c=s._renderCount,u=s._hardwareRenderer,h=l.shaderData,d=t.shaderData,f=0,_=a.length;f<_;f++){var g=a[f],v=g.component.entity.layer;if(!!(v&r))if(g.mesh){this._spriteBatcher.flush(t,e);var p=F._compileMacros,m=g,y=m.component,x=m.material,S=y.shaderData,w=x.shaderData;(e||x)._preRender(m),Yt.unionCollection(y._globalShaderMacro,w._macroCollection,p);var b=(e||x).shader._getShaderProgram(s,p);if(!b.isValid)continue;var A=b.bind(),E=c!==b._uploadRenderCount;E?(b.groupingOtherUniformBlock(),b.uploadAll(b.sceneUniformBlock,h),b.uploadAll(b.cameraUniformBlock,d),b.uploadAll(b.rendererUniformBlock,S),b.uploadAll(b.materialUniformBlock,w),b.uploadUnGroupTextures(),b._uploadCamera=t,b._uploadRenderer=y,b._uploadMaterial=x,b._uploadRenderCount=c):(b._uploadCamera!==t?(b.uploadAll(b.cameraUniformBlock,d),b._uploadCamera=t):A&&b.uploadTextures(b.cameraUniformBlock,d),b._uploadRenderer!==y?(b.uploadAll(b.rendererUniformBlock,S),b._uploadRenderer=y):A&&b.uploadTextures(b.rendererUniformBlock,S),b._uploadMaterial!==x?(b.uploadAll(b.materialUniformBlock,w),b._uploadMaterial=x):A&&b.uploadTextures(b.materialUniformBlock,w),A&&b.uploadUnGroupTextures()),x.renderState._apply(s,y.entity.transform._isFrontFaceInvert()),u.drawPrimitive(m.mesh,m.subMesh,b)}else{var C=g;this._spriteBatcher.drawElement(C,t,e)}}this._spriteBatcher.flush(t,e)}},o.clear=function(){this.items.length=0,this._spriteBatcher.clear()},o.destroy=function(){this._spriteBatcher.destroy(),this._spriteBatcher=null},o.sort=function(t){this._quickSort(this.items,0,this.items.length,t)},o._quickSort=function(t,e,r,a){for(;;){if(r-e<=10){this._insertionSort(t,e,r,a);return}var s=e+r>>1,l=t[e],c=t[r-1],u=t[s],h=a(l,c);if(h>0){var d=l;l=c,c=d}var f=a(l,u);if(f>=0){var _=l;l=u,u=c,c=_}else{var g=a(c,u);if(g>0){var v=c;c=u,u=v}}t[e]=l,t[r-1]=u;var p=c,m=e+1,y=r-1;t[s]=t[m],t[m]=p;e:for(var x=m+1;x<y;x++){var S=t[x],w=a(S,p);if(w<0)t[x]=t[m],t[m]=S,m++;else if(w>0){do{if(y--,y==x)break e;var b=t[y];w=a(b,p)}while(w>0);t[x]=t[y],t[y]=S,w<0&&(S=t[x],t[x]=t[m],t[m]=S,m++)}}r-y<m-e?(this._quickSort(t,y,r,a),r=m):(this._quickSort(t,e,m,a),e=y)}},o._insertionSort=function(t,e,r,a){for(var s=e+1;s<r;s++){var l=void 0,c=t[s];for(l=s-1;l>=e;l--){var u=t[l],h=a(u,c);if(h>0)t[l+1]=u;else break}t[l+1]=c}},i}(),Rh=function(){function i(n){this._opaqueQueue=void 0,this._transparentQueue=void 0,this._alphaTestQueue=void 0,this._allSpriteMasks=new Dt,this._camera=void 0,this._defaultPass=void 0,this._renderPassArray=void 0,this._lastCanvasSize=new q,this._camera=n;var t=n.engine;this._opaqueQueue=new bi(t),this._alphaTestQueue=new bi(t),this._transparentQueue=new bi(t),this._renderPassArray=[],this._defaultPass=new ei("default",0,null,null,0),this.addRenderPass(this._defaultPass)}var o=i.prototype;return o.addRenderPass=function(t,e,r,a,s){if(e===void 0&&(e=null),r===void 0&&(r=null),a===void 0&&(a=null),s===void 0&&(s=null),typeof t=="string"){var l=new ei(t,e,r,a,s);this._renderPassArray.push(l)}else t instanceof ei&&this._renderPassArray.push(t);this._renderPassArray.sort(function(c,u){return c.priority-u.priority})},o.removeRenderPass=function(t){var e;if(typeof t=="string"?e=this.getRenderPass(t):t instanceof ei&&(e=t),e){var r=this._renderPassArray.indexOf(e);this._renderPassArray.splice(r,1)}},o.getRenderPass=function(t){for(var e=0,r=this._renderPassArray.length;e<r;e++){var a=this._renderPassArray[e];if(a.name===t)return a}return null},o.destroy=function(){this._opaqueQueue.destroy(),this._alphaTestQueue.destroy(),this._transparentQueue.destroy(),this._allSpriteMasks=null,this._renderPassArray=null,this._defaultPass=null,this._camera=null},o.render=function(t,e,r){var a=this._camera,s=this._opaqueQueue,l=this._alphaTestQueue,c=this._transparentQueue;a.engine._spriteMaskManager.clear(),s.clear(),l.clear(),c.clear(),this._allSpriteMasks.length=0,a.engine._componentsManager.callRender(t),s.sort(bi._compareFromNearToFar),l.sort(bi._compareFromNearToFar),c.sort(bi._compareFromFarToNear);for(var u=0,h=this._renderPassArray.length;u<h;u++)this._drawRenderPass(this._renderPassArray[u],a,e,r)},o._drawRenderPass=function(t,e,r,a){if(t.preRender(e,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue),t.enabled){var s,l,c=e.engine,u=e.scene,h=u.background,d=c._hardwareRenderer,f=e.renderTarget||t.renderTarget;d.activeRenderTarget(f,e,a),f==null||f._setRenderTargetInfo(r,a);var _=(s=t.clearFlags)!=null?s:e.clearFlags,g=(l=t.clearColor)!=null?l:h.solidColor;_!==vr.None&&d.clearRenderTarget(e.engine,_,g),t.renderOverride?t.render(e,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue):(this._opaqueQueue.render(e,t.replaceMaterial,t.mask),this._alphaTestQueue.render(e,t.replaceMaterial,t.mask),e.clearFlags&vr.Color&&(h.mode===rr.Sky?this._drawSky(c,e,h.sky):h.mode===rr.Texture&&h.texture&&this._drawBackgroundTexture(c,h)),this._transparentQueue.render(e,t.replaceMaterial,t.mask)),f==null||f._blitRenderTarget(),f==null||f.generateMipmaps()}t.postRender(e,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue)},o.pushPrimitive=function(t){switch(t.material.renderQueueType){case bt.Transparent:this._transparentQueue.pushPrimitive(t);break;case bt.AlphaTest:this._alphaTestQueue.pushPrimitive(t);break;case bt.Opaque:this._opaqueQueue.pushPrimitive(t);break}},o._drawBackgroundTexture=function(t,e){var r=t._hardwareRenderer,a=t._backgroundTextureMaterial,s=t.canvas,l=e._mesh;(this._lastCanvasSize.x!==s.width||this._lastCanvasSize.y!==s.height)&&e._textureFillMode!==Kr.Fill&&(this._lastCanvasSize.set(s.width,s.height),e._resizeBackgroundTexture());var c=a.shader._getShaderProgram(t,F._compileMacros);c.bind(),c.uploadAll(c.materialUniformBlock,a.shaderData),c.uploadUnGroupTextures(),a.renderState._apply(t,!1),r.drawPrimitive(l,l.subMesh,c)},o._drawSky=function(t,e,r){var a=r.material,s=r.mesh,l=r._matrix;if(!a){me.warn("The material of sky is not defined.");return}if(!s){me.warn("The mesh of sky is not defined.");return}var c=t._hardwareRenderer,u=a.shaderData,h=a.shader,d=a.renderState,f=F._compileMacros;Yt.unionCollection(e._globalShaderMacro,u._macroCollection,f);var _=e.viewMatrix,g=e.projectionMatrix;l.copyFrom(_);var v=l.elements;v[12]=v[13]=v[14]=0,ce.multiply(g,l,l),u.setMatrix("u_mvpNoscale",l);var p=h._getShaderProgram(t,f);p.bind(),p.groupingOtherUniformBlock(),p.uploadAll(p.materialUniformBlock,u),p.uploadUnGroupTextures(),d._apply(t,!1),c.drawPrimitive(s,s.subMesh,p)},te(i,[{key:"defaultRenderPass",get:function(){return this._defaultPass}}]),i}(),sl,ll,zt,cl,ul,hl,dl,_l,fl,vl,pl,gl,ml,yl,xl,$r,Ai=function(){};Ai.tempVec4=new Ve;Ai.tempVec3=new T;Ai.tempVec2=new q;var Sa=(sl=In($t),sl(ll=(zt=($r=function(i){J(o,i);function o(t){var e;e=i.call(this,t)||this,e.shaderData=new Nn(_r.Camera),e.priority=0,e.enableFrustumCulling=!0,e.clearFlags=vr.All,e.cullingMask=Ot.Everything,e._globalShaderMacro=new Yt,U(e,"_frustum",cl,z(e)),U(e,"_renderPipeline",ul,z(e)),e._isOrthographic=!1,e._isProjMatSetting=!1,e._nearClipPlane=.1,e._farClipPlane=100,e._fieldOfView=45,e._orthographicSize=10,e._isProjectionDirty=!0,e._isInvProjMatDirty=!0,e._isFrustumProjectDirty=!0,e._customAspectRatio=void 0,e._renderTarget=null,U(e,"_frustumViewChangeFlag",hl,z(e)),U(e,"_transform",dl,z(e)),U(e,"_isViewMatrixDirty",_l,z(e)),U(e,"_isInvViewProjDirty",fl,z(e)),U(e,"_projectionMatrix",vl,z(e)),U(e,"_viewMatrix",pl,z(e)),U(e,"_viewport",gl,z(e)),U(e,"_inverseProjectionMatrix",ml,z(e)),U(e,"_lastAspectSize",yl,z(e)),U(e,"_invViewProjMat",xl,z(e));var r=e.entity.transform;return e._transform=r,e._isViewMatrixDirty=r.registerWorldChangeFlag(),e._isInvViewProjDirty=r.registerWorldChangeFlag(),e._frustumViewChangeFlag=r.registerWorldChangeFlag(),e._renderPipeline=new Rh(z(e)),e.shaderData._addRefCount(1),e}var n=o.prototype;return n.resetProjectionMatrix=function(){this._isProjMatSetting=!1,this._projMatChange()},n.resetAspectRatio=function(){this._customAspectRatio=void 0,this._projMatChange()},n.worldToViewportPoint=function(e,r){var a=Ai.tempVec3,s=Ai.tempVec4;T.transformCoordinate(e,this.viewMatrix,a),T.transformToVec4(a,this.projectionMatrix,s);var l=s.w;return r.set((s.x/l+1)*.5,(1-s.y/l)*.5,-a.z),r},n.viewportToWorldPoint=function(e,r){var a=this.nearClipPlane,s=this.farClipPlane,l=1/(a-s),c;if(this.isOrthographic)c=-e.z*2*l,c+=(s+a)*l;else{var u=e.z;c=-u*(a+s)*l,c+=2*a*s*l,c=c/u}return this._innerViewportToWorldPoint(e.x,e.y,(c+1)/2,this._getInvViewProjMat(),r),r},n.viewportPointToRay=function(e,r){var a=this._getInvViewProjMat(),s=this._innerViewportToWorldPoint(e.x,e.y,0,a,r.origin),l=this._innerViewportToWorldPoint(e.x,e.y,1,a,r.direction);return T.subtract(l,s,l),l.normalize(),r},n.screenToViewportPoint=function(e,r){var a=this.engine.canvas,s=this.viewport;return r.x=(e.x/a.width-s.x)/s.z,r.y=(e.y/a.height-s.y)/s.w,e.z!==void 0&&(r.z=e.z),r},n.viewportToScreenPoint=function(e,r){var a=this.engine.canvas,s=this.viewport;return r.x=(s.x+e.x*s.z)*a.width,r.y=(s.y+e.y*s.w)*a.height,e.z!==void 0&&(r.z=e.z),r},n.worldToScreenPoint=function(e,r){return this.worldToViewportPoint(e,r),this.viewportToScreenPoint(r,r)},n.screenToWorldPoint=function(e,r){return this.screenToViewportPoint(e,r),this.viewportToWorldPoint(r,r)},n.screenPointToRay=function(e,r){var a=Ai.tempVec2;return this.screenToViewportPoint(e,a),this.viewportPointToRay(a,r)},n.render=function(e,r){r===void 0&&(r=0);var a=this.engine._renderContext;a._setContext(this),this.enableFrustumCulling&&(this._frustumViewChangeFlag.flag||this._isFrustumProjectDirty)&&(this._frustum.calculateFromMatrix(a._viewProjectMatrix),this._frustumViewChangeFlag.flag=!1,this._isFrustumProjectDirty=!1),this._updateShaderData(a),Yt.unionCollection(this.scene._globalShaderMacro,this.shaderData._macroCollection,this._globalShaderMacro),r>0&&!this.engine._hardwareRenderer.isWebGL2&&(r=0,me.error("mipLevel only take effect in WebGL2.0")),this._renderPipeline.render(a,e,r),this._engine._renderCount++},n._onEnable=function(){this.entity.scene._attachRenderCamera(this)},n._onDisable=function(){this.entity.scene._detachRenderCamera(this)},n._onDestroy=function(){var e;(e=this._renderPipeline)===null||e===void 0||e.destroy(),this._isInvViewProjDirty.destroy(),this._isViewMatrixDirty.destroy(),this.shaderData._addRefCount(-1)},n._projMatChange=function(){this._isFrustumProjectDirty=!0,this._isProjectionDirty=!0,this._isInvProjMatDirty=!0,this._isInvViewProjDirty.flag=!0},n._innerViewportToWorldPoint=function(e,r,a,s,l){var c=Ai.tempVec3;return c.set(e*2-1,1-r*2,a*2-1),T.transformCoordinate(c,s,l),l},n._updateShaderData=function(e){var r=this.shaderData;r.setMatrix(o._viewMatrixProperty,this.viewMatrix),r.setMatrix(o._projectionMatrixProperty,this.projectionMatrix),r.setMatrix(o._vpMatrixProperty,e._viewProjectMatrix),r.setMatrix(o._inverseViewMatrixProperty,this._transform.worldMatrix),r.setMatrix(o._inverseProjectionMatrixProperty,this._getInverseProjectionMatrix()),r.setVector3(o._cameraPositionProperty,this._transform.worldPosition)},n._getInvViewProjMat=function(){return this._isInvViewProjDirty.flag&&(this._isInvViewProjDirty.flag=!1,ce.multiply(this._transform.worldMatrix,this._getInverseProjectionMatrix(),this._invViewProjMat)),this._invViewProjMat},n._getInverseProjectionMatrix=function(){return this._isInvProjMatDirty&&(this._isInvProjMatDirty=!1,ce.invert(this.projectionMatrix,this._inverseProjectionMatrix)),this._inverseProjectionMatrix},te(o,[{key:"nearClipPlane",get:function(){return this._nearClipPlane},set:function(e){this._nearClipPlane=e,this._projMatChange()}},{key:"farClipPlane",get:function(){return this._farClipPlane},set:function(e){this._farClipPlane=e,this._projMatChange()}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._projMatChange()}},{key:"aspectRatio",get:function(){var e,r=this._entity.engine.canvas;return(e=this._customAspectRatio)!=null?e:r.width*this._viewport.z/(r.height*this._viewport.w)},set:function(e){this._customAspectRatio=e,this._projMatChange()}},{key:"viewport",get:function(){return this._viewport},set:function(e){e!==this._viewport&&this._viewport.copyFrom(e),this._projMatChange()}},{key:"isOrthographic",get:function(){return this._isOrthographic},set:function(e){this._isOrthographic=e,this._projMatChange()}},{key:"orthographicSize",get:function(){return this._orthographicSize},set:function(e){this._orthographicSize=e,this._projMatChange()}},{key:"viewMatrix",get:function(){return this._isViewMatrixDirty.flag&&(this._isViewMatrixDirty.flag=!1,ce.rotationTranslation(this._transform.worldRotationQuaternion,this._transform.worldPosition,this._viewMatrix),this._viewMatrix.invert()),this._viewMatrix}},{key:"projectionMatrix",get:function(){var e=this._entity.engine.canvas;if((!this._isProjectionDirty||this._isProjMatSetting)&&this._lastAspectSize.x===e.width&&this._lastAspectSize.y===e.height)return this._projectionMatrix;this._isProjectionDirty=!1,this._lastAspectSize.x=e.width,this._lastAspectSize.y=e.height;var r=this.aspectRatio;if(!this._isOrthographic)ce.perspective(H.degreeToRadian(this._fieldOfView),r,this._nearClipPlane,this._farClipPlane,this._projectionMatrix);else{var a=this._orthographicSize*r,s=this._orthographicSize;ce.ortho(-a,a,-s,s,this._nearClipPlane,this._farClipPlane,this._projectionMatrix)}return this._projectionMatrix},set:function(e){this._projectionMatrix=e,this._isProjMatSetting=!0,this._projMatChange()}},{key:"enableHDR",get:function(){return console.log("not implementation"),!1},set:function(e){console.log("not implementation")}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget=e}}]),o}(ar),$r._viewMatrixProperty=F.getPropertyByName("u_viewMat"),$r._projectionMatrixProperty=F.getPropertyByName("u_projMat"),$r._vpMatrixProperty=F.getPropertyByName("u_VPMat"),$r._inverseViewMatrixProperty=F.getPropertyByName("u_viewInvMat"),$r._inverseProjectionMatrixProperty=F.getPropertyByName("u_projInvMat"),$r._cameraPositionProperty=F.getPropertyByName("u_cameraPos"),$r),cl=k(zt.prototype,"_frustum",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new yd}}),ul=k(zt.prototype,"_renderPipeline",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),hl=k(zt.prototype,"_frustumViewChangeFlag",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),dl=k(zt.prototype,"_transform",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_l=k(zt.prototype,"_isViewMatrixDirty",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),fl=k(zt.prototype,"_isInvViewProjDirty",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),vl=k(zt.prototype,"_projectionMatrix",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),pl=k(zt.prototype,"_viewMatrix",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),gl=k(zt.prototype,"_viewport",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ve(0,0,1,1)}}),ml=k(zt.prototype,"_inverseProjectionMatrix",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),yl=k(zt.prototype,"_lastAspectSize",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new q(0,0)}}),xl=k(zt.prototype,"_invViewProjMat",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ce}}),zt))||ll),Bf={json:"json",gltf:"json",mtl:"json",prefab:"json",txt:"text",bin:"arraybuffer",png:"image",webp:"image",jpg:"image"},Df=4,Lf=15e3,zf=500;function pn(i,o){return o===void 0&&(o={}),new ot(function(n,t,e){var r,a,s,l,c=(r=o.retryCount)!=null?r:Df,u=(a=o.retryInterval)!=null?a:zf;o.timeout=(s=o.timeout)!=null?s:Lf,o.type=(l=o.type)!=null?l:Nf(i);var h=o.type==="image"?Of:If,d,f=new Uf(function(){return h(i,o).onProgress(e).then(function(_){n(_),f.stop()}).catch(function(_){return d=_})},c,u);f.start(function(){t(d)})})}function Of(i,o){return new ot(function(n,t){var e=o.timeout,r=new Image,a=function(){t(new Error("request "+i+" fail"))};r.onerror=a,r.onabort=a;var s=setTimeout(function(){t(new Error("request "+i+" timeout"))},e);r.onload=function(l){return function(){requestAnimationFrame(function(){n(r),r.onload=null,r.onerror=null,r.onabort=null}),clearTimeout(l)}}(s),r.crossOrigin="anonymous",r.src=i})}function If(i,o){return new ot(function(n,t,e){var r,a=new XMLHttpRequest;a.timeout=o.timeout,o.method=(r=o.method)!=null?r:"get",a.onload=function(){var l;if(a.status<200||a.status>=300){t(new Error("request failed from: "+i));return}var c=(l=a.response)!=null?l:a.responseText;n(c)},a.onerror=function(){t(new Error("request failed from: "+i))},a.ontimeout=function(){t(new Error("request timeout from: "+i))},a.onprogress=function(l){e(l.loaded/l.total)},a.open(o.method,i,!0),a.withCredentials=o.credentials==="include",a.responseType=o.type;var s=o.headers;s&&Object.keys(s).forEach(function(l){a.setRequestHeader(l,s[l])}),a.send(o.body)})}function Nf(i){var o=i.substring(i.lastIndexOf(".")+1);return Bf[o]}var Uf=function(){function i(n,t,e){this.execFunc=n,this.totalCount=t,this.interval=e,this._timeoutId=-100,this._currentCount=0,this.done=void 0,this.exec=this.exec.bind(this)}var o=i.prototype;return o.start=function(t){this.done=t,this.exec()},o.stop=function(){clearTimeout(this._timeoutId)},o.exec=function(){var t=this;if(this._currentCount>=this.totalCount){this.done&&this.done();return}this._currentCount++,this.execFunc(this._currentCount).then(function(){t._timeoutId=setTimeout(t.exec,t.interval)})},i}(),st=function(){i.registerClass=function(n,t){this._engineObjects[n]=t},i.getClass=function(n){return this._engineObjects[n]};function i(o){this.useCache=o,this.request=pn}return i}();st._engineObjects={};var Xe;(function(i){i.Text="text",i.JSON="json",i.Buffer="buffer",i.Texture2D="texture2d",i.TextureCube="texture-cube",i.Material="material",i.Mesh="mesh",i.AnimationClip="animation-clip",i.Prefab="prefab",i.KTX="ktx",i.KTXCube="ktx-cube",i.Sprite="sprite",i.SpriteAtlas="sprite-atlas",i.Env="environment",i.Scene="scene",i.HDR="HDR"})(Xe||(Xe={}));var Mr;(function(i){i[i.Front=0]="Front",i[i.Back=1]="Back",i[i.Double=2]="Double"})(Mr||(Mr={}));var Qi;(function(i){i[i.Normal=0]="Normal",i[i.Additive=1]="Additive"})(Qi||(Qi={}));var ni;(function(i){i[i.UV0=0]="UV0",i[i.UV1=1]="UV1",i[i.UV2=2]="UV2",i[i.UV3=3]="UV3",i[i.UV4=4]="UV4",i[i.UV5=5]="UV5",i[i.UV6=6]="UV6",i[i.UV7=7]="UV7"})(ni||(ni={}));var ut=function(i){J(o,i);function o(t,e){var r;return r=i.call(this,t,e)||this,r._renderFace=Mr.Front,r._isTransparent=!1,r._blendMode=void 0,r.blendMode=Qi.Normal,r.shaderData.setFloat(o._alphaCutoffProp,0),r}var n=o.prototype;return n.clone=function(){var e=new o(this._engine,this.shader);return this.cloneTo(e),e},n.cloneTo=function(e){i.prototype.cloneTo.call(this,e),e._renderFace=this._renderFace,e._isTransparent=this._isTransparent,e._blendMode=this._blendMode},te(o,[{key:"isTransparent",get:function(){return this._isTransparent},set:function(e){if(e!==this._isTransparent){this._isTransparent=e;var r=this.renderState,a=r.depthState,s=r.blendState.targetBlendState;e?(s.enabled=!0,a.writeEnabled=!1,this.renderQueueType=bt.Transparent):(s.enabled=!1,a.writeEnabled=!0,this.renderQueueType=this.shaderData.getFloat(o._alphaCutoffProp)?bt.AlphaTest:bt.Opaque)}}},{key:"alphaCutoff",get:function(){return this.shaderData.getFloat(o._alphaCutoffProp)},set:function(e){this.shaderData.setFloat(o._alphaCutoffProp,e),e>0?(this.shaderData.enableMacro(o._alphaCutoffMacro),this.renderQueueType=this._isTransparent?bt.Transparent:bt.AlphaTest):(this.shaderData.disableMacro(o._alphaCutoffMacro),this.renderQueueType=this._isTransparent?bt.Transparent:bt.Opaque)}},{key:"renderFace",get:function(){return this._renderFace},set:function(e){if(e!==this._renderFace)switch(this._renderFace=e,e){case Mr.Front:this.renderState.rasterState.cullMode=qt.Back;break;case Mr.Back:this.renderState.rasterState.cullMode=qt.Front;break;case Mr.Double:this.renderState.rasterState.cullMode=qt.Off;break}}},{key:"blendMode",get:function(){return this._blendMode},set:function(e){if(e!==this._blendMode){this._blendMode=e;var r=this.renderState.blendState.targetBlendState;switch(e){case Qi.Normal:r.sourceColorBlendFactor=de.SourceAlpha,r.destinationColorBlendFactor=de.OneMinusSourceAlpha,r.sourceAlphaBlendFactor=de.One,r.destinationAlphaBlendFactor=de.OneMinusSourceAlpha,r.colorBlendOperation=r.alphaBlendOperation=Xt.Add;break;case Qi.Additive:r.sourceColorBlendFactor=de.SourceAlpha,r.destinationColorBlendFactor=de.One,r.sourceAlphaBlendFactor=de.One,r.destinationAlphaBlendFactor=de.OneMinusSourceAlpha,r.colorBlendOperation=r.alphaBlendOperation=Xt.Add;break}}}}]),o}(pr);ut._baseColorProp=F.getPropertyByName("u_baseColor");ut._baseTextureProp=F.getPropertyByName("u_baseTexture");ut._baseTextureMacro=F.getMacroByName("BASETEXTURE");ut._tilingOffsetProp=F.getPropertyByName("u_tilingOffset");ut._normalTextureProp=F.getPropertyByName("u_normalTexture");ut._normalIntensityProp=F.getPropertyByName("u_normalIntensity");ut._normalTextureMacro=F.getMacroByName("NORMALTEXTURE");ut._emissiveColorProp=F.getPropertyByName("u_emissiveColor");ut._emissiveTextureProp=F.getPropertyByName("u_emissiveTexture");ut._emissiveTextureMacro=F.getMacroByName("EMISSIVETEXTURE");ut._alphaCutoffProp=F.getPropertyByName("u_alphaCutoff");ut._alphaCutoffMacro=F.getMacroByName("ALPHA_CUTOFF");var on=function(i){J(o,i);function o(t){var e;e=i.call(this,t,F.find("blinn-phong"))||this;var r=e.shaderData;return r.enableMacro("O3_NEED_WORLDPOS"),r.enableMacro("O3_NEED_TILINGOFFSET"),r.setColor(o._baseColorProp,new oe(1,1,1,1)),r.setColor(o._specularColorProp,new oe(1,1,1,1)),r.setColor(o._emissiveColorProp,new oe(0,0,0,1)),r.setVector4(o._tilingOffsetProp,new Ve(1,1,0,0)),r.setFloat(o._shininessProp,16),r.setFloat(o._normalIntensityProp,1),e}var n=o.prototype;return n.clone=function(){var e=new o(this._engine);return this.cloneTo(e),e},te(o,[{key:"baseColor",get:function(){return this.shaderData.getColor(o._baseColorProp)},set:function(e){var r=this.shaderData.getColor(o._baseColorProp);e!==r&&r.copyFrom(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(o._baseTextureProp)},set:function(e){this.shaderData.setTexture(o._baseTextureProp,e),e?this.shaderData.enableMacro(o._baseTextureMacro):this.shaderData.disableMacro(o._baseTextureMacro)}},{key:"specularColor",get:function(){return this.shaderData.getColor(o._specularColorProp)},set:function(e){var r=this.shaderData.getColor(o._specularColorProp);e!==r&&r.copyFrom(e)}},{key:"specularTexture",get:function(){return this.shaderData.getTexture(o._specularTextureProp)},set:function(e){this.shaderData.setTexture(o._specularTextureProp,e),e?this.shaderData.enableMacro("O3_SPECULAR_TEXTURE"):this.shaderData.disableMacro("O3_SPECULAR_TEXTURE")}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(o._emissiveColorProp)},set:function(e){var r=this.shaderData.getColor(o._emissiveColorProp);e!==r&&r.copyFrom(e)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(o._emissiveTextureProp)},set:function(e){this.shaderData.setTexture(o._emissiveTextureProp,e),e?this.shaderData.enableMacro(o._emissiveTextureMacro):this.shaderData.disableMacro(o._emissiveTextureMacro)}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(o._normalTextureProp)},set:function(e){this.shaderData.setTexture(o._normalTextureProp,e),e?this.shaderData.enableMacro(o._normalTextureMacro):this.shaderData.disableMacro(o._normalTextureMacro)}},{key:"normalIntensity",get:function(){return this.shaderData.getFloat(o._normalIntensityProp)},set:function(e){this.shaderData.setFloat(o._normalIntensityProp,e)}},{key:"shininess",get:function(){return this.shaderData.getFloat(o._shininessProp)},set:function(e){this.shaderData.setFloat(o._shininessProp,Math.max(e,1e-4))}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(o._tilingOffsetProp)},set:function(e){var r=this.shaderData.getVector4(o._tilingOffsetProp);e!==r&&r.copyFrom(e)}}]),o}(ut);on._specularColorProp=F.getPropertyByName("u_specularColor");on._shininessProp=F.getPropertyByName("u_shininess");on._specularTextureProp=F.getPropertyByName("u_specularTexture");var Zt=function(i){J(o,i);function o(n,t){var e;e=i.call(this,n,t)||this;var r=e.shaderData;return r.enableMacro("O3_NEED_WORLDPOS"),r.enableMacro("O3_NEED_TILINGOFFSET"),r.setColor(o._baseColorProp,new oe(1,1,1,1)),r.setColor(o._emissiveColorProp,new oe(0,0,0,1)),r.setVector4(o._tilingOffsetProp,new Ve(1,1,0,0)),r.setFloat(o._normalIntensityProp,1),r.setFloat(o._occlusionTextureIntensityProp,1),r.setFloat(o._occlusionTextureCoordProp,ni.UV0),r.setFloat(o._clearCoatProp,0),r.setFloat(o._clearCoatRoughnessProp,0),e}return te(o,[{key:"baseColor",get:function(){return this.shaderData.getColor(o._baseColorProp)},set:function(t){var e=this.shaderData.getColor(o._baseColorProp);t!==e&&e.copyFrom(t)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(o._baseTextureProp)},set:function(t){this.shaderData.setTexture(o._baseTextureProp,t),t?this.shaderData.enableMacro(o._baseTextureMacro):this.shaderData.disableMacro(o._baseTextureMacro)}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(o._normalTextureProp)},set:function(t){this.shaderData.setTexture(o._normalTextureProp,t),t?this.shaderData.enableMacro(o._normalTextureMacro):this.shaderData.disableMacro(o._normalTextureMacro)}},{key:"normalTextureIntensity",get:function(){return this.shaderData.getFloat(o._normalIntensityProp)},set:function(t){this.shaderData.setFloat(o._normalIntensityProp,t)}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(o._emissiveColorProp)},set:function(t){var e=this.shaderData.getColor(o._emissiveColorProp);t!==e&&e.copyFrom(t)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(o._emissiveTextureProp)},set:function(t){this.shaderData.setTexture(o._emissiveTextureProp,t),t?this.shaderData.enableMacro(o._emissiveTextureMacro):this.shaderData.disableMacro(o._emissiveTextureMacro)}},{key:"occlusionTexture",get:function(){return this.shaderData.getTexture(o._occlusionTextureProp)},set:function(t){this.shaderData.setTexture(o._occlusionTextureProp,t),t?this.shaderData.enableMacro("OCCLUSIONTEXTURE"):this.shaderData.disableMacro("OCCLUSIONTEXTURE")}},{key:"occlusionTextureIntensity",get:function(){return this.shaderData.getFloat(o._occlusionTextureIntensityProp)},set:function(t){this.shaderData.setFloat(o._occlusionTextureIntensityProp,t)}},{key:"occlusionTextureCoord",get:function(){return this.shaderData.getFloat(o._occlusionTextureCoordProp)},set:function(t){t>ni.UV1&&me.warn("Occlusion texture uv coordinate must be UV0 or UV1."),this.shaderData.setFloat(o._occlusionTextureCoordProp,t)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(o._tilingOffsetProp)},set:function(t){var e=this.shaderData.getVector4(o._tilingOffsetProp);t!==e&&e.copyFrom(t)}},{key:"clearCoat",get:function(){return this.shaderData.getFloat(o._clearCoatProp)},set:function(t){!!this.shaderData.getFloat(o._clearCoatProp)!=!!t&&(t===0?this.shaderData.disableMacro("CLEARCOAT"):this.shaderData.enableMacro("CLEARCOAT")),this.shaderData.setFloat(o._clearCoatProp,t)}},{key:"clearCoatTexture",get:function(){return this.shaderData.getTexture(o._clearCoatTextureProp)},set:function(t){this.shaderData.setTexture(o._clearCoatTextureProp,t),t?this.shaderData.enableMacro("HAS_CLEARCOATTEXTURE"):this.shaderData.disableMacro("HAS_CLEARCOATTEXTURE")}},{key:"clearCoatRoughness",get:function(){return this.shaderData.getFloat(o._clearCoatRoughnessProp)},set:function(t){this.shaderData.setFloat(o._clearCoatRoughnessProp,t)}},{key:"clearCoatRoughnessTexture",get:function(){return this.shaderData.getTexture(o._clearCoatRoughnessTextureProp)},set:function(t){this.shaderData.setTexture(o._clearCoatRoughnessTextureProp,t),t?this.shaderData.enableMacro("HAS_CLEARCOATROUGHNESSTEXTURE"):this.shaderData.disableMacro("HAS_CLEARCOATROUGHNESSTEXTURE")}},{key:"clearCoatNormalTexture",get:function(){return this.shaderData.getTexture(o._clearCoatNormalTextureProp)},set:function(t){this.shaderData.setTexture(o._clearCoatNormalTextureProp,t),t?this.shaderData.enableMacro("HAS_CLEARCOATNORMALTEXTURE"):this.shaderData.disableMacro("HAS_CLEARCOATNORMALTEXTURE")}}]),o}(ut);Zt._occlusionTextureIntensityProp=F.getPropertyByName("u_occlusionIntensity");Zt._occlusionTextureCoordProp=F.getPropertyByName("u_occlusionTextureCoord");Zt._occlusionTextureProp=F.getPropertyByName("u_occlusionTexture");Zt._clearCoatProp=F.getPropertyByName("u_clearCoat");Zt._clearCoatTextureProp=F.getPropertyByName("u_clearCoatTexture");Zt._clearCoatRoughnessProp=F.getPropertyByName("u_clearCoatRoughness");Zt._clearCoatRoughnessTextureProp=F.getPropertyByName("u_clearCoatRoughnessTexture");Zt._clearCoatNormalTextureProp=F.getPropertyByName("u_clearCoatNormalTexture");var Li=function(i){J(o,i);function o(t){var e;return e=i.call(this,t,F.find("pbr"))||this,e.shaderData.setFloat(o._metallicProp,1),e.shaderData.setFloat(o._roughnessProp,1),e}var n=o.prototype;return n.clone=function(){var e=new o(this._engine);return this.cloneTo(e),e},te(o,[{key:"metallic",get:function(){return this.shaderData.getFloat(o._metallicProp)},set:function(e){this.shaderData.setFloat(o._metallicProp,e)}},{key:"roughness",get:function(){return this.shaderData.getFloat(o._roughnessProp)},set:function(e){this.shaderData.setFloat(o._roughnessProp,e)}},{key:"roughnessMetallicTexture",get:function(){return this.shaderData.getTexture(o._roughnessMetallicTextureProp)},set:function(e){this.shaderData.setTexture(o._roughnessMetallicTextureProp,e),e?this.shaderData.enableMacro("ROUGHNESSMETALLICTEXTURE"):this.shaderData.disableMacro("ROUGHNESSMETALLICTEXTURE")}}]),o}(Zt);Li._metallicProp=F.getPropertyByName("u_metal");Li._roughnessProp=F.getPropertyByName("u_roughness");Li._roughnessMetallicTextureProp=F.getPropertyByName("u_roughnessMetallicTexture");var hi=function(i){J(o,i);function o(t){var e;return e=i.call(this,t,F.find("pbr-specular"))||this,e.shaderData.setColor(o._specularColorProp,new oe(1,1,1,1)),e.shaderData.setFloat(o._glossinessProp,1),e}var n=o.prototype;return n.clone=function(){var e=new o(this._engine);return this.cloneTo(e),e},te(o,[{key:"specularColor",get:function(){return this.shaderData.getColor(o._specularColorProp)},set:function(e){var r=this.shaderData.getColor(o._specularColorProp);e!==r&&r.copyFrom(e)}},{key:"glossiness",get:function(){return this.shaderData.getFloat(o._glossinessProp)},set:function(e){this.shaderData.setFloat(o._glossinessProp,e)}},{key:"specularGlossinessTexture",get:function(){return this.shaderData.getTexture(o._specularGlossinessTextureProp)},set:function(e){this.shaderData.setTexture(o._specularGlossinessTextureProp,e),e?this.shaderData.enableMacro(o._specularGlossinessTextureMacro):this.shaderData.disableMacro(o._specularGlossinessTextureMacro)}}]),o}(Zt);hi._specularColorProp=F.getPropertyByName("u_PBRSpecularColor");hi._glossinessProp=F.getPropertyByName("u_glossiness");hi._specularGlossinessTextureProp=F.getPropertyByName("u_specularGlossinessTexture");hi._specularGlossinessTextureMacro=F.getMacroByName("SPECULARGLOSSINESSTEXTURE");var ai=function(i){J(o,i);function o(t){var e;e=i.call(this,t,F.find("unlit"))||this;var r=e.shaderData;return r.enableMacro("OMIT_NORMAL"),r.enableMacro("O3_NEED_TILINGOFFSET"),r.setColor(o._baseColorProp,new oe(1,1,1,1)),r.setVector4(o._tilingOffsetProp,new Ve(1,1,0,0)),e}var n=o.prototype;return n.clone=function(){var e=new o(this._engine);return this.cloneTo(e),e},te(o,[{key:"baseColor",get:function(){return this.shaderData.getColor(o._baseColorProp)},set:function(e){var r=this.shaderData.getColor(o._baseColorProp);e!==r&&r.copyFrom(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(o._baseTextureProp)},set:function(e){this.shaderData.setTexture(o._baseTextureProp,e),e?this.shaderData.enableMacro(o._baseTextureMacro):this.shaderData.disableMacro(o._baseTextureMacro)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(o._tilingOffsetProp)},set:function(e){var r=this.shaderData.getVector4(o._tilingOffsetProp);e!==r&&r.copyFrom(e)}}]),o}(ut),Pi;(function(i){i[i.Left=0]="Left",i[i.Center=1]="Center",i[i.Right=2]="Right"})(Pi||(Pi={}));var Mi;(function(i){i[i.Top=0]="Top",i[i.Center=1]="Center",i[i.Bottom=2]="Bottom"})(Mi||(Mi={}));var Bi;(function(i){i[i.Overflow=0]="Overflow",i[i.Truncate=1]="Truncate"})(Bi||(Bi={}));var ti;(function(i){i[i.None=0]="None",i[i.Bold=1]="Bold",i[i.Italic=2]="Italic"})(ti||(ti={}));var Fh=function(i){J(n,i);var o=n.prototype;o.getSprite=function(e){var r=this._sprites[this._spriteNamesToIndex[e]];return r||console.warn("There is no sprite named "+e+" in the atlas."),r},o.getSprites=function(e,r){r.length=0;var a=this._spriteNamesToIndex[e];if(a!==void 0)for(var s=this._sprites;a>=0;a--){var l=s[a];l.name===e&&r.push(l)}else console.warn("The name of the sprite you want to find is not exit in SpriteAtlas.");return r};function n(t){var e;return e=i.call(this,t)||this,e._sprites=new Array,e._spriteNamesToIndex={},e}return o._addSprite=function(e){this._spriteNamesToIndex[e.name]=this._sprites.push(e)-1},o._onDestroy=function(){this._sprites=null,this._spriteNamesToIndex=null},te(n,[{key:"sprites",get:function(){return this._sprites}}]),n}(Gr),Jr;(function(i){i[i.Simple=0]="Simple",i[i.Sliced=1]="Sliced"})(Jr||(Jr={}));var wo=function(i){J(o,i);function o(t,e,r,a,s,l){var c;return e===void 0&&(e=null),r===void 0&&(r=null),a===void 0&&(a=null),s===void 0&&(s=null),l===void 0&&(l=null),c=i.call(this,t)||this,c.name=void 0,c._assetID=void 0,c._width=void 0,c._height=void 0,c._positions=[new q,new q,new q,new q],c._uvs=[new q,new q,new q,new q],c._bounds=new ir,c._texture=null,c._atlasRotated=!1,c._atlasRegion=new Na(0,0,1,1),c._atlasRegionOffset=new Ve(0,0,0,0),c._region=new Na(0,0,1,1),c._pivot=new q(.5,.5),c._border=new Ve(0,0,0,0),c._dirtyFlag=Ar.all,c._updateFlagManager=new Ri,c._texture=e,r&&c._region.copyFrom(r),a&&c._pivot.copyFrom(a),s&&c._border.copyFrom(s),c.name=l,c}var n=o.prototype;return n.clone=function(){var e=new o(this._engine,this._texture,this._region,this._pivot,this._border,this.name);return e._assetID=this._assetID,e._atlasRotated=this._atlasRotated,e._atlasRegion.copyFrom(this._atlasRegion),e._atlasRegionOffset.copyFrom(this._atlasRegionOffset),e},n._registerUpdateFlag=function(){return this._updateFlagManager.createFlag(pa)},n._getPositions=function(){return this._dirtyFlag&Ar.positions&&this._updatePositions(),this._positions},n._getUVs=function(){return this._dirtyFlag&Ar.uvs&&this._updateUVs(),this._uvs},n._getBounds=function(){return this._dirtyFlag&Ar.positions&&this._updatePositions(),this._bounds},n._onDestroy=function(){this._texture&&(this._texture=null)},n._calDefaultSize=function(){if(this._texture){var e=this._texture,r=this._atlasRegion,a=this._atlasRegionOffset,s=this._region,l=1/yr._pixelsPerUnit;this.width=e.width*r.width/(1-a.x-a.z)*s.width*l,this.height=e.height*r.height/(1-a.y-a.w)*s.height*l}},n._updatePositions=function(){var e=this._atlasRegionOffset,r=this._region,a=r.x,s=r.y,l=r.width,c=r.height,u=1-a-l,h=1-s-c,d=Math.max(e.x-a,0)/l,f=Math.max(e.w-s,0)/c,_=1-Math.max(e.z-u,0)/l,g=1-Math.max(e.y-h,0)/c,v=this._positions;v[0].set(d,f),v[1].set(_,f),v[2].set(d,g),v[3].set(_,g);var p=this._bounds,m=p.min,y=p.max;m.set(d,f,0),y.set(_,g,0),this._dirtyFlag&=~Ar.positions},n._updateUVs=function(){var e=this._uvs,r=this._atlasRegionOffset,a=this._region,s=a.x,l=a.y,c=a.width,u=a.height,h=1-s-c,d=1-l-u,f=this._atlasRegion,_=f.x,g=f.y,v=f.width,p=f.height,m=r.x,y=r.y,x=r.z,S=r.w,w=v/(1-m-x),b=p/(1-y-S),A=Math.max(s-m,0)*w+_,E=Math.max(d-y,0)*b+g,C=v+_-Math.max(h-x,0)*w,M=p+g-Math.max(l-S,0)*b,P=this._border,R=P.x,B=P.y,D=P.z,L=P.w;e[0].set(A,M),e[1].set((s-m+R*c)*w+_,p+g-(l-S+B*u)*b),e[2].set(v+_-(h-x+D*c)*w,(d-y+L*u)*b+g),e[3].set(C,E),this._dirtyFlag&=~Ar.uvs},n._dispatchSpriteChange=function(e){switch(e){case je.atlasRegionOffset:case je.region:this._dirtyFlag|=Ar.all;break;case je.atlasRegion:case je.border:this._dirtyFlag|=Ar.uvs;break}this._updateFlagManager.dispatch(e)},te(o,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e,this._dispatchSpriteChange(je.texture))}},{key:"width",get:function(){return this._width===void 0&&this._calDefaultSize(),this._width},set:function(e){this._width!==e&&(this._width=e,this._dispatchSpriteChange(je.size))}},{key:"height",get:function(){return this._height===void 0&&this._calDefaultSize(),this._height},set:function(e){this._height!==e&&(this._height=e,this._dispatchSpriteChange(je.size))}},{key:"atlasRotated",get:function(){return this._atlasRotated},set:function(e){this._atlasRotated!=e&&(this._atlasRotated=e)}},{key:"atlasRegion",get:function(){return this._atlasRegion},set:function(e){var r=H.clamp(e.x,0,1),a=H.clamp(e.y,0,1);this._atlasRegion.set(r,a,H.clamp(e.width,0,1-r),H.clamp(e.height,0,1-a)),this._dispatchSpriteChange(je.atlasRegion)}},{key:"atlasRegionOffset",get:function(){return this._atlasRegionOffset},set:function(e){var r=H.clamp(e.x,0,1),a=H.clamp(e.y,0,1);this._atlasRegionOffset.set(r,a,H.clamp(e.z,0,1-r),H.clamp(e.w,0,1-a)),this._dispatchSpriteChange(je.atlasRegionOffset)}},{key:"region",get:function(){return this._region},set:function(e){var r=this._region,a=H.clamp(e.x,0,1),s=H.clamp(e.y,0,1);r.set(a,s,H.clamp(e.width,0,1-a),H.clamp(e.height,0,1-s)),this._dispatchSpriteChange(je.region)}},{key:"pivot",get:function(){return this._pivot},set:function(e){var r=this._pivot;if(r===e)this._dispatchSpriteChange(je.pivot);else{var a=e.x,s=e.y;(r.x!==a||r.y!==s)&&(r.set(a,s),this._dispatchSpriteChange(je.pivot))}}},{key:"border",get:function(){return this._border},set:function(e){var r=this._border,a=H.clamp(e.x,0,1),s=H.clamp(e.y,0,1);r.set(a,s,H.clamp(e.z,0,1-a),H.clamp(e.w,0,1-s)),this._dispatchSpriteChange(je.border)}}]),o}(Gr),Ar;(function(i){i[i.positions=1]="positions",i[i.uvs=2]="uvs",i[i.all=3]="all"})(Ar||(Ar={}));var bl,wl,Ea,kf=(bl=Sh(),bl(wl=(Ea=function(){function i(){}return i.resetData=function(n){var t=n._renderData,e=t.positions,r=t.uvs;if(e.length<16)for(var a=e.length;a<16;a++)e.push(new T),r.push(new q);t.triangles=[]},i.updatePositions=function(n){var t=n.width,e=n.height,r=n.sprite,a=n._renderData,s=a.positions,l=a.uvs,c=a.triangles,u=r.border,h=r._getUVs(),d=r._getPositions(),f=d[0],_=f.x,g=f.y,v=d[3],p=v.x,m=v.y,y=r.width,x=r.height,S=y*u.x,w=x*u.y,b=x*u.z,A=y*u.w,E,C;if(S+b>t){var M=t/(S+b);E=[y*_*M,S*M,S*M,t-y*(1-p)*M]}else E=[y*_,S,t-b,t-y*(1-p)];if(A+w>e){var P=e/(A+w);C=[x*g*P,w*P,w*P,e-x*(1-m)*P]}else C=[x*g,w,e-A,e-x*(1-m)];var R=n.sprite.pivot,B=R.x,D=R.y,L=n.width*B,N=n.height*D,W=i._worldMatrix,I=W.elements,V=n.entity.transform.worldMatrix.elements,se=n.flipX?-1:1,Z=n.flipY?-1:1;I[0]=V[0]*se,I[1]=V[1]*se,I[2]=V[2]*se,I[4]=V[4]*Z,I[5]=V[5]*Z,I[6]=V[6]*Z,I[8]=V[8],I[9]=V[9],I[10]=V[10],I[12]=V[12]-L*I[0]-N*I[4],I[13]=V[13]-L*I[1]-N*I[5],I[14]=V[14];for(var Y=0,ue=0,ie=0;ie<4;ie++){for(var be=E[ie],ye=h[ie].x,Fe=0;Fe<4;Fe++){var Qe=C[Fe];s[Y].set(I[0]*be+I[4]*Qe+I[12],I[1]*be+I[5]*Qe+I[13],I[2]*be+I[6]*Qe+I[14]),l[Y].set(ye,h[Fe].y),++Y}++ue}for(var Be=Y/ue,Oe=0,Ge=0;Ge<ue-1;++Ge)for(var Ae=0;Ae<Be-1;++Ae){var pe=Ge*Be+Ae;c[Oe++]=pe,c[Oe++]=pe+1,c[Oe++]=pe+Be,c[Oe++]=pe+1,c[Oe++]=pe+Be+1,c[Oe++]=pe+Be}n._renderData.vertexCount=ue*Be,c.length=(ue-1)*(Be-1)*6;var Je=n._bounds,Ze=Je.min,He=Je.max;Ze.set(E[0],C[0],0),He.set(E[3],C[3],0),n._bounds.transform(W)},i.updateUVs=function(n){},i}(),Ea._worldMatrix=new ce,Ea))||wl),Et,Sl,Cl,Tl,Al,Pl,Ml,El,Rl,Fl,Bl,Dl,Ll,zl,Ra,Vf=(Et=(Ra=function(i){J(o,i);function o(t){var e;return e=i.call(this,t)||this,U(e,"_renderData",Sl,z(e)),U(e,"_drawMode",Cl,z(e)),U(e,"_assembler",Tl,z(e)),U(e,"_color",Al,z(e)),U(e,"_sprite",Pl,z(e)),U(e,"_width",Ml,z(e)),U(e,"_height",El,z(e)),U(e,"_flipX",Rl,z(e)),U(e,"_flipY",Fl,z(e)),U(e,"_maskLayer",Bl,z(e)),U(e,"_maskInteraction",Dl,z(e)),U(e,"_dirtyFlag",Ll,z(e)),U(e,"_spriteChangeFlag",zl,z(e)),e._renderData=new go(4,[],[],null,e._color),e.drawMode=Jr.Simple,e.setMaterial(e._engine._spriteDefaultMaterial),e._onSpriteChange=e._onSpriteChange.bind(z(e)),e}var n=o.prototype;return n._render=function(e){var r;if(!(!((r=this.sprite)!==null&&r!==void 0&&r.texture)||!this.width||!this.height)){(this._transformChangeFlag.flag||this._dirtyFlag&ht.Position)&&(this._assembler.updatePositions(this),this._dirtyFlag&=~ht.Position,this._transformChangeFlag.flag=!1),this._dirtyFlag&ht.UV&&(this._assembler.updateUVs(this),this._dirtyFlag&=~ht.UV);var a=this._engine._spriteElementPool.getFromPool();a.setValue(this,this._renderData,this.getMaterial(),this.sprite.texture),e._renderPipeline.pushPrimitive(a)}},n._cloneTo=function(e){e.sprite=this._sprite},n._onDestroy=function(){this._color=null,this._sprite=null,this._assembler=null,this._renderData=null,this._spriteChangeFlag&&(this._spriteChangeFlag.destroy(),this._spriteChangeFlag=null),i.prototype._onDestroy.call(this)},n._updateStencilState=function(){var e=this.getInstanceMaterial(),r=e.renderState.stencilState,a=this._maskInteraction;if(a===tr.None)r.enabled=!1,r.writeMask=255,r.referenceValue=0,r.compareFunctionFront=r.compareFunctionBack=Ne.Always;else{r.enabled=!0,r.writeMask=0,r.referenceValue=1;var s=a===tr.VisibleInsideMask?Ne.LessEqual:Ne.Greater;r.compareFunctionFront=s,r.compareFunctionBack=s}},n._onSpriteChange=function(e){switch(e){case je.texture:this.shaderData.setTexture(o._textureProperty,this.sprite.texture);break;case je.size:this._drawMode===Jr.Sliced&&(this._dirtyFlag|=ht.Position);break;case je.border:this._drawMode===Jr.Sliced&&(this._dirtyFlag|=ht.All);break;case je.region:case je.atlasRegionOffset:this._dirtyFlag|=ht.All;break;case je.atlasRegion:this._dirtyFlag|=ht.UV;break;case je.pivot:this._dirtyFlag|=ht.Position;break}},te(o,[{key:"drawMode",get:function(){return this._drawMode},set:function(e){if(this._drawMode!==e){switch(this._drawMode=e,e){case Jr.Simple:this._assembler=dn;break;case Jr.Sliced:this._assembler=kf;break}this._assembler.resetData(this),this._dirtyFlag|=ht.All}}},{key:"sprite",get:function(){return this._sprite},set:function(e){this._sprite!==e&&(this._sprite=e,this._spriteChangeFlag&&this._spriteChangeFlag.destroy(),e?(this._spriteChangeFlag=e._registerUpdateFlag(),this._spriteChangeFlag.listener=this._onSpriteChange,this._dirtyFlag|=ht.All,this.shaderData.setTexture(o._textureProperty,e.texture)):(this._spriteChangeFlag=null,this.shaderData.setTexture(o._textureProperty,null)))}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.copyFrom(e)}},{key:"width",get:function(){return this._width===void 0&&this._sprite&&(this.width=this._sprite.width),this._width},set:function(e){this._width!==e&&(this._width=e,this._dirtyFlag|=ht.Position)}},{key:"height",get:function(){return this._height===void 0&&this._sprite&&(this.height=this._sprite.height),this._height},set:function(e){this._height!==e&&(this._height=e,this._dirtyFlag|=ht.Position)}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._dirtyFlag|=ht.Position)}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._dirtyFlag|=ht.Position)}},{key:"bounds",get:function(){var e;return!((e=this.sprite)!==null&&e!==void 0&&e.texture)||!this.width||!this.height?yr._defaultBoundingBox:((this._transformChangeFlag.flag||this._dirtyFlag&ht.Position)&&(this._assembler.updatePositions(this),this._dirtyFlag&=~ht.Position,this._transformChangeFlag.flag=!1),this._bounds)}},{key:"maskLayer",get:function(){return this._maskLayer},set:function(e){this._maskLayer=e}},{key:"maskInteraction",get:function(){return this._maskInteraction},set:function(e){this._maskInteraction!==e&&(this._maskInteraction=e,this._updateStencilState())}}]),o}(Un),Ra._textureProperty=F.getPropertyByName("u_spriteTexture"),Ra),Sl=k(Et.prototype,"_renderData",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Cl=k(Et.prototype,"_drawMode",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Tl=k(Et.prototype,"_assembler",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Al=k(Et.prototype,"_color",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oe(1,1,1,1)}}),Pl=k(Et.prototype,"_sprite",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ml=k(Et.prototype,"_width",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),El=k(Et.prototype,"_height",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),Rl=k(Et.prototype,"_flipX",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Fl=k(Et.prototype,"_flipY",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Bl=k(Et.prototype,"_maskLayer",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tn.Layer0}}),Dl=k(Et.prototype,"_maskInteraction",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tr.None}}),Ll=k(Et.prototype,"_dirtyFlag",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zl=k(Et.prototype,"_spriteChangeFlag",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Et),ht;(function(i){i[i.Position=1]="Position",i[i.UV=2]="UV",i[i.All=3]="All"})(ht||(ht={}));var Gf=function(i){J(o,i);function o(t){var e;return e=i.call(this,t)||this,e._charInfoMap={},e._texture=void 0,e._space=1,e._curX=1,e._curY=1,e._nextY=1,e}var n=o.prototype;return n._onDestroy=function(){this._texture.destroy(),this._texture=null,this._charInfoMap={}},n.uploadCharTexture=function(e){var r=e.w,a=e.h,s=e.data,l=this._space,c=this.texture,u=c.width,h=r+l,d=a+l;if(1+h>=u||1+d>=u)throw Error("The char fontSize is too large.");var f=this._curX+h;f>=u&&(this._curX=l,this._curY=this._nextY+l);var _=this._curY+d;if(_>this._nextY&&(this._nextY=_),_>=u)return!1;r>0&&a>0&&s&&(c.setPixelBuffer(s,0,this._curX,this._curY,r,a),c.generateMipmaps());var g=1/u,v=this._curX,p=this._curY,m=r,y=a,x=v*g,S=(v+m)*g,w=p*g,b=(p+y)*g;e.x=v,e.y=p;var A=e.uvs;return A[0].set(x,w),A[1].set(S,w),A[2].set(S,b),A[3].set(x,b),this._curX+=h+l,!0},n.addCharInfo=function(e,r){this._charInfoMap[e.charCodeAt(0)]=r},n.getCharInfo=function(e){return this._charInfoMap[e.charCodeAt(0)]},te(o,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e}}]),o}(Gr),sa=function(i){J(o,i),o.createFromOS=function(e,r){r===void 0&&(r="");var a=o._fontMap,s=a[r];return s||(s=new o(e,r),a[r]=s,s)};function o(t,e){var r;return e===void 0&&(e=""),r=i.call(this,t)||this,r._name="",r._fontAtlases=[],r._lastIndex=-1,r._name=e,r}var n=o.prototype;return n._uploadCharTexture=function(e){var r=this._fontAtlases,a=this._lastIndex;a===-1&&(this._createFontAtlas(),a++);var s=r[a];s.uploadCharTexture(e)||(s=this._createFontAtlas(),s.uploadCharTexture(e),a++),this._lastIndex=a,e.data=null},n._addCharInfo=function(e,r){var a=this._lastIndex;r.index=a,this._fontAtlases[a].addCharInfo(e,r)},n._getCharInfo=function(e){for(var r=this._fontAtlases,a=0,s=r.length;a<s;++a){var l=r[a],c=l.getCharInfo(e);if(c)return c}return null},n._getTextureByIndex=function(e){var r=this._fontAtlases[e];return r?r.texture:null},n._getLastIndex=function(){return this._lastIndex},n._onDestroy=function(){for(var e=this._fontAtlases,r=0,a=e.length;r<a;++r)e[r].destroy(!0);e.length=0,delete o._fontMap[this._name]},n._createFontAtlas=function(){var e=this.engine,r=new Gf(e),a=new Ct(e,256,256);return r.texture=a,this._fontAtlases.push(r),r},te(o,[{key:"name",get:function(){return this._name}}]),o}(Gr);sa._fontMap={};var Bh=function i(){this.texture=void 0,this.localPositions=new Ve,this.renderData=void 0;var o=[new T,new T,new T,new T];this.renderData=new go(4,o,null,i.triangles,null)};Bh.triangles=[0,2,1,2,0,3];var Hf=function(){function i(n,t){this._elements=[],this._type=void 0,this._type=n;for(var e=this._elements,r=0;r<t;++r)e[r]=new n}var o=i.prototype;return o.get=function(){return this._elements.length>0?this._elements.pop():new this._type},o.put=function(t){this._elements.push(t)},i}(),Fr=function(){function i(){}return i.textContext=function(){var n=i._textContext;if(!n){var t;try{t=new OffscreenCanvas(0,0)}catch{t=document.createElement("canvas")}var e=t.getContext("2d");n={canvas:t,context:e},i._textContext=n}return n},i.measureFont=function(n){var t=i._fontSizeInfoCache,e=t[n];return e||(e=i._measureFontOrChar(n),t[n]=e,e)},i.getNativeFontString=function(n,t,e){var r=e&ti.Bold?"bold ":"";return e&ti.Italic&&(r+="italic "),!/([\"\'])[^\'\"]+\1/.test(n)&&i._genericFontFamilies.indexOf(n)==-1&&(n='"'+n+'"'),r+=t+"px "+n,r},i.measureChar=function(n,t){return i._measureFontOrChar(t,n)},i.measureTextWithWrap=function(n){for(var t=n.fontSize,e=n.fontStyle,r=n.font.name,a=i.getNativeFontString(r,t,e),s=n._charFont,l=i.measureFont(a),c=n.text.split(/(?:\r\n|\r|\n)/),u=new Array,h=new Array,d=new Array,f=yr._pixelsPerUnit,_=l.size+n.lineSpacing*f,g=n.width*f,v=0,p=0,m=c.length;p<m;++p){for(var y=c[p],x="",S=0,w=-1,b=-1,A=0,E=y.length;A<E;++A){var C=y[A],M=i._getCharInfo(C,a,s),P=M.w,R=M.offsetY,B=M.h*.5,D=B+R,L=B-R;S+P>g?S===0?(u.push(C),h.push(P),d.push({ascent:D,descent:L,size:D+L})):(u.push(x),h.push(S),d.push({ascent:w,descent:b,size:w+b}),x=C,S=M.xAdvance,w=D,b=L):(x+=C,S+=M.xAdvance,w<D&&(w=D),b<L&&(b=L))}S>0&&(u.push(x),h.push(S),d.push({ascent:w,descent:b,size:w+b}))}var N=n.height*f;return n.overflowMode===Bi.Overflow&&(N=_*u.length),{width:v,height:N,lines:u,lineWidths:h,lineHeight:_,lineMaxSizes:d}},i.measureTextWithoutWrap=function(n){var t=n.fontSize,e=n.fontStyle,r=n.font.name,a=i.getNativeFontString(r,t,e),s=n._charFont,l=i.measureFont(a),c=n.text.split(/(?:\r\n|\r|\n)/),u=c.length,h=new Array,d=new Array,f=yr._pixelsPerUnit,_=l.size+n.lineSpacing*f,g=0,v=n.height*f;n.overflowMode===Bi.Overflow&&(v=_*u);for(var p=0;p<u;++p){for(var m=c[p],y=0,x=-1,S=-1,w=0,b=m.length;w<b;++w){var A=i._getCharInfo(m[w],a,s);y+=A.xAdvance;var E=A.offsetY,C=A.h*.5,M=C+E,P=C-E;x<M&&(x=M),S<P&&(S=P)}h[p]=y,d[p]={ascent:x,descent:S,size:x+S},y>g&&(g=y)}return{width:g,height:v,lines:c,lineWidths:h,lineHeight:_,lineMaxSizes:d}},i.getNativeFontHash=function(n,t,e){var r=e&ti.Bold?"bold":"";return e&ti.Italic&&(r+="italic"),!/([\"\'])[^\'\"]+\1/.test(n)&&i._genericFontFamilies.indexOf(n)==-1&&(n=""+n),r+=t+"px"+n,r},i._measureFontOrChar=function(n,t){t===void 0&&(t="");var e=i.textContext(),r=e.canvas,a=e.context;a.font=n;var s=t||i._measureString,l=Math.round(a.measureText(s).width),c=Math.ceil(a.measureText(i._measureBaseline).width),u=c*i._heightMultiplier;c=i._baselineMultiplier*c|0,r.width=l,r.height=u,a.font=n,a.fillStyle="#000",a.clearRect(0,0,l,u),a.textBaseline="middle",a.fillStyle="#fff",a.fillText(s,0,c);for(var h=a.getImageData(0,0,l,u).data,d=h.length,f=-1,_=-1,g,v=0,p=0,m=0,y=r.width,x=1/y,S=0;S<d;S+=4)if(h[S+3]!==0){var w=S*.25;g=~~(w*x),f===-1&&(f=g),g>_&&(_=g)}f!==-1&&_!==-1&&(v=c-f,p=_-c+1,m=v+p);var b={ascent:v,descent:p,size:m};if(t){var A=null;if(m>0){var E=y*4;A=new Uint8Array(h.buffer,f*E,m*E)}return{x:0,y:0,w:l,h:m,offsetX:0,offsetY:(v-p)*.5,xAdvance:l,uvs:[new q,new q,new q,new q],ascent:v,descent:p,index:0,data:A}}else return b},i._getCharInfo=function(n,t,e){var r=e._getCharInfo(n);return r||(r=i.measureChar(n,t),e._uploadCharTexture(r),e._addCharInfo(n,r)),r},i}();Fr._genericFontFamilies=["serif","sans-serif","monospace","cursive","fantasy","system-ui","math","emoji","fangsong"];Fr._measureString="|\xC9q\xC5";Fr._measureBaseline="M";Fr._heightMultiplier=2;Fr._baselineMultiplier=1.4;Fr._fontSizeInfoCache={};Fr._textContext=null;var it,Ol,Il,Nl,Ul,kl,Vl,Gl,Hl,Wl,Xl,jl,$l,ql,Yl,Ql,Jl,Zl,Kl,ec,ln,Wf=(it=(ln=function(i){J(o,i);function o(t){var e;e=i.call(this,t)||this,U(e,"_charFont",Ol,z(e)),U(e,"_charRenderDatas",Il,z(e)),U(e,"_dirtyFlag",Nl,z(e)),U(e,"_isWorldMatrixDirty",Ul,z(e)),U(e,"_color",kl,z(e)),U(e,"_text",Vl,z(e)),U(e,"_width",Gl,z(e)),U(e,"_height",Hl,z(e)),U(e,"_localBounds",Wl,z(e)),U(e,"_font",Xl,z(e)),U(e,"_fontSize",jl,z(e)),U(e,"_fontStyle",$l,z(e)),U(e,"_lineSpacing",ql,z(e)),U(e,"_horizontalAlignment",Yl,z(e)),U(e,"_verticalAlignment",Ql,z(e)),U(e,"_enableWrapping",Jl,z(e)),U(e,"_overflowMode",Zl,z(e)),U(e,"_maskInteraction",Kl,z(e)),U(e,"_maskLayer",ec,z(e));var r=z(e),a=r.engine;return e._isWorldMatrixDirty=t.transform._registerWorldChangeListener(),e._isWorldMatrixDirty.listener=function(){e._setDirtyFlagTrue(Me.WorldPosition|Me.WorldBounds)},e.font=sa.createFromOS(a),e.setMaterial(a._spriteDefaultMaterial),e}var n=o.prototype;return n._render=function(e){if(!(this._text===""||this.enableWrapping&&this.width<=0||this.overflowMode===Bi.Truncate&&this.height<=0)){this._isContainDirtyFlag(Me.MaskInteraction)&&(this._updateStencilState(),this._setDirtyFlagFalse(Me.MaskInteraction));var r=this._isContainDirtyFlag(Me.Font);r&&(this._resetCharFont(),this._setDirtyFlagFalse(Me.Font)),(this._isContainDirtyFlag(Me.LocalPositionBounds)||r)&&(this._updateLocalData(),this._setDirtyFlagFalse(Me.LocalPositionBounds)),(this._isContainDirtyFlag(Me.WorldPosition)||r)&&(this._updatePosition(),this._setDirtyFlagFalse(Me.WorldPosition));var a=this._engine._spriteElementPool,s=this._engine._textElementPool.getFromPool(),l=s.charElements,c=this.getMaterial(),u=this._charRenderDatas,h=u.length;s.component=this,s.material=c,l.length=h;for(var d=0;d<h;++d){var f=u[d],_=a.getFromPool();_.setValue(this,f.renderData,c,f.texture),l[d]=_}e._renderPipeline.pushPrimitive(s)}},n._onDestroy=function(){for(var e=this._charRenderDatas,r=0,a=e.length;r<a;++r)o._charRenderDataPool.put(e[r]);e.length=0,this._isWorldMatrixDirty.destroy(),i.prototype._onDestroy.call(this)},n._cloneTo=function(e){e.font=this._font},n._isContainDirtyFlag=function(e){return(this._dirtyFlag&e)!=0},n._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},n._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},n._updateBounds=function(e){ir.transform(this._localBounds,this._entity.transform.worldMatrix,e)},n._updateStencilState=function(){var e=this.getInstanceMaterial(),r=e.renderState.stencilState,a=this._maskInteraction;if(a===tr.None)r.enabled=!1,r.writeMask=255,r.referenceValue=0,r.compareFunctionFront=r.compareFunctionBack=Ne.Always;else{r.enabled=!0,r.writeMask=0,r.referenceValue=1;var s=a===tr.VisibleInsideMask?Ne.LessEqual:Ne.Greater;r.compareFunctionFront=s,r.compareFunctionBack=s}},n._resetCharFont=function(){var e=this._charFont;e&&(e._addRefCount(-1),e.destroy()),this._charFont=sa.createFromOS(this.engine,Fr.getNativeFontHash(this.font.name,this.fontSize,this.fontStyle)),this._charFont._addRefCount(1)},n._updatePosition=function(){for(var e=this.entity.transform,r=e.worldMatrix.elements,a=this._charRenderDatas,s=r[0],l=r[1],c=r[2],u=r[4],h=r[5],d=r[6],f=r[12],_=r[13],g=r[14],v=o._tempVec31.set(u,h,d),p=o._tempVec30.set(s,l,c),m=0,y=a.length;m<y;++m){var x=a[m],S=x.localPositions,w=x.renderData.positions,b=S.x,A=S.y,E=w[0];E.x=b*s+A*u+f,E.y=b*l+A*h+_,E.z=b*c+A*d+g;var C=w[1];T.scale(p,S.z-b,C),T.add(E,C,C);var M=w[2];T.scale(v,S.w-A,M),T.add(E,M,w[3]),T.add(C,M,M)}},n._updateLocalData=function(){var e=this.color,r=this.horizontalAlignment,a=this.verticalAlignment,s=this._charRenderDatas,l=this._localBounds,c=l.min,u=l.max;c.set(0,0,0),u.set(0,0,0);var h=yr._pixelsPerUnit,d=1/h,f=this._charFont,_=this.width*h,g=_*.5,v=this.height*h,p=this.enableWrapping?Fr.measureTextWithWrap(this):Fr.measureTextWithoutWrap(this),m=p.height,y=p.lines,x=p.lineWidths,S=p.lineHeight,w=p.lineMaxSizes,b=o._charRenderDataPool,A=S*.5,E=y.length,C=0,M=S*.5-w[0].ascent,P=S*.5-w[E-1].descent-1;switch(a){case Mi.Top:C=v*.5-A+M;break;case Mi.Center:C=m*.5-A-(P-M)*.5;break;case Mi.Bottom:C=m-v*.5-A-P;break}for(var R=0,B=Number.MAX_SAFE_INTEGER,D=Number.MAX_SAFE_INTEGER,L=Number.MIN_SAFE_INTEGER,N=Number.MIN_SAFE_INTEGER,W=E-1,I=0;I<E;++I){var V=y[I],se=x[I],Z=0;switch(r){case Pi.Left:Z=-g;break;case Pi.Center:Z=-se*.5;break;case Pi.Right:Z=g-se;break}for(var Y=0,ue=V.length-1;Y<=ue;++Y){var ie=V[Y],be=f._getCharInfo(ie);if(be.h>0){var ye=s[R]||b.get(),Fe=ye.renderData,Qe=ye.localPositions;ye.texture=f._getTextureByIndex(be.index),Fe.color=e,Fe.uvs=be.uvs;var Be=be.w,Oe=be.ascent,Ge=be.descent,Ae=Z*d,pe=(Z+Be)*d,Je=(C+Oe)*d,Ze=(C-Ge+1)*d;Qe.set(Ae,Je,pe,Ze),s[R]=ye,R++,I===0&&(N=Math.max(N,Je)),I===W&&(D=Math.min(D,Ze)),Y===0&&(B=Math.min(B,Ae)),Y===ue&&(L=Math.max(L,pe))}Z+=be.xAdvance}C-=S}c.set(B,D,0),u.set(L,N,0);var He=s.length;if(He>R){for(var Ke=R;Ke<He;++Ke)b.put(s[Ke]);s.length=R}f._getLastIndex()>0&&s.sort(function(ft,Ue){return ft.texture.instanceId-Ue.texture.instanceId})},te(o,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.copyFrom(e)}},{key:"text",get:function(){return this._text},set:function(e){e=e||"",this._text!==e&&(this._text=e,this._setDirtyFlagTrue(Me.LocalPositionBounds))}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._setDirtyFlagTrue(Me.LocalPositionBounds))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._height=e,this._setDirtyFlagTrue(Me.LocalPositionBounds))}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._setDirtyFlagTrue(Me.Font))}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._setDirtyFlagTrue(Me.Font))}},{key:"fontStyle",get:function(){return this._fontStyle},set:function(e){this.fontStyle!==e&&(this._fontStyle=e,this._setDirtyFlagTrue(Me.Font))}},{key:"lineSpacing",get:function(){return this._lineSpacing},set:function(e){this._lineSpacing!==e&&(this._lineSpacing=e,this._setDirtyFlagTrue(Me.LocalPositionBounds))}},{key:"horizontalAlignment",get:function(){return this._horizontalAlignment},set:function(e){this._horizontalAlignment!==e&&(this._horizontalAlignment=e,this._setDirtyFlagTrue(Me.LocalPositionBounds))}},{key:"verticalAlignment",get:function(){return this._verticalAlignment},set:function(e){this._verticalAlignment!==e&&(this._verticalAlignment=e,this._setDirtyFlagTrue(Me.LocalPositionBounds))}},{key:"enableWrapping",get:function(){return this._enableWrapping},set:function(e){this._enableWrapping!==e&&(this._enableWrapping=e,this._setDirtyFlagTrue(Me.LocalPositionBounds))}},{key:"overflowMode",get:function(){return this._overflowMode},set:function(e){this._overflowMode!==e&&(this._overflowMode=e,this._setDirtyFlagTrue(Me.LocalPositionBounds))}},{key:"maskInteraction",get:function(){return this._maskInteraction},set:function(e){this._maskInteraction!==e&&(this._maskInteraction=e,this._setDirtyFlagTrue(Me.MaskInteraction))}},{key:"maskLayer",get:function(){return this._maskLayer},set:function(e){this._maskLayer=e}},{key:"bounds",get:function(){var e=this._isContainDirtyFlag(Me.Font),r=this._isContainDirtyFlag(Me.LocalPositionBounds),a=this._isContainDirtyFlag(Me.WorldBounds);return(e||r||a)&&(e&&this._resetCharFont(),r&&this._updateLocalData(),a&&this._updateBounds(this._bounds),this._setDirtyFlagFalse(Me.Font|Me.LocalPositionBounds|Me.WorldBounds)),this._bounds}}]),o}(Un),ln._charRenderDataPool=new Hf(Bh,50),ln._tempVec30=new T,ln._tempVec31=new T,ln),Ol=k(it.prototype,"_charFont",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Il=k(it.prototype,"_charRenderDatas",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Nl=k(it.prototype,"_dirtyFlag",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Me.Font|Me.LocalPositionBounds|Me.WorldPosition|Me.WorldBounds}}),Ul=k(it.prototype,"_isWorldMatrixDirty",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),kl=k(it.prototype,"_color",[tt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new oe(1,1,1,1)}}),Vl=k(it.prototype,"_text",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Gl=k(it.prototype,"_width",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hl=k(it.prototype,"_height",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wl=k(it.prototype,"_localBounds",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ir}}),Xl=k(it.prototype,"_font",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jl=k(it.prototype,"_fontSize",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 24}}),$l=k(it.prototype,"_fontStyle",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ti.None}}),ql=k(it.prototype,"_lineSpacing",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Yl=k(it.prototype,"_horizontalAlignment",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pi.Center}}),Ql=k(it.prototype,"_verticalAlignment",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mi.Center}}),Jl=k(it.prototype,"_enableWrapping",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zl=k(it.prototype,"_overflowMode",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bi.Overflow}}),Kl=k(it.prototype,"_maskInteraction",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tr.None}}),ec=k(it.prototype,"_maskLayer",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tn.Layer0}}),it),Me;(function(i){i[i.Font=1]="Font",i[i.LocalPositionBounds=2]="LocalPositionBounds",i[i.WorldPosition=4]="WorldPosition",i[i.WorldBounds=8]="WorldBounds",i[i.MaskInteraction=16]="MaskInteraction"})(Me||(Me={}));var Dh=function(){this.relativePath=void 0,this.type=void 0,this.property=void 0,this.curve=void 0},Lh=function(){this.time=void 0,this.functionName=void 0,this.parameter=void 0},xe;(function(i){i[i.Position=0]="Position",i[i.Rotation=1]="Rotation",i[i.Scale=2]="Scale",i[i.BlendShapeWeights=3]="BlendShapeWeights"})(xe||(xe={}));var Xf=function(){},zh=function(i){J(o,i);function o(t){var e;return e=i.call(this)||this,e.name=t,e._curveBindings=[],e._length=0,e._events=[],e}var n=o.prototype;return n.addEvent=function(e,r,a){if(typeof e=="string"){var s=new Lh;s.functionName=e,s.time=r,s.parameter=a,this._events.push(s)}else this._events.push(e);this._events.sort(function(l,c){return l.time-c.time})},n.clearEvents=function(){this._events.length=0},n.addCurveBinding=function(e,r,a,s){var l;switch(a){case"position":l=xe.Position;break;case"rotation":l=xe.Rotation;break;case"scale":l=xe.Scale;break;case"blendShapeWeights":l=xe.BlendShapeWeights;break}var c=new Dh;c.relativePath=e,c.type=r,c.property=l,c.curve=s,s.length>this._length&&(this._length=s.length),this._curveBindings.push(c)},n.clearCurveBindings=function(){this._curveBindings.length=0,this._length=0},n._sampleAnimation=function(e,r){for(var a=this._curveBindings.length,s=a-1;s>=0;s--){var l=this._curveBindings[s],c=l.curve,u=l.property,h=l.relativePath,d=l.type,f=c.evaluate(r),_=e.findByName(h),g=_.transform;if(d===$t)switch(u){case xe.Position:g.position=f;break;case xe.Rotation:g.rotationQuaternion=f;break;case xe.Scale:g.scale=f;break}}},te(o,[{key:"events",get:function(){return this._events}},{key:"curveBindings",get:function(){return this._curveBindings}},{key:"length",get:function(){return this._length}}]),o}(Xf),Te;(function(i){i[i.Float=0]="Float",i[i.FloatArray=1]="FloatArray",i[i.Vector2=2]="Vector2",i[i.Vector3=3]="Vector3",i[i.Vector4=4]="Vector4",i[i.Quaternion=5]="Quaternion"})(Te||(Te={}));var la=function(){function i(){}return i.scaleWeight=function(n,t,e){var r=n.x,a=n.y,s=n.z;e.x=r>0?Math.pow(Math.abs(r),t):-Math.pow(Math.abs(r),t),e.y=a>0?Math.pow(Math.abs(a),t):-Math.pow(Math.abs(a),t),e.z=s>0?Math.pow(Math.abs(s),t):-Math.pow(Math.abs(s),t)},i.scaleBlend=function(n,t,e,r){var a=i._tempVector30,s=i._tempVector31;i.scaleWeight(n,1-e,a),i.scaleWeight(t,e,s);var l=e>.5?t:n;r.x=l.x>0?Math.abs(a.x*s.x):-Math.abs(a.x*s.x),r.y=l.y>0?Math.abs(a.y*s.y):-Math.abs(a.y*s.y),r.z=l.z>0?Math.abs(a.z*s.z):-Math.abs(a.z*s.z)},i.quaternionWeight=function(n,t,e){e.x=n.x*t,e.y=n.y*t,e.z=n.z*t,e.w=n.w},i}();la._tempVector30=new T;la._tempVector31=new T;var Dn;(function(i){i[i.Override=0]="Override",i[i.Additive=1]="Additive"})(Dn||(Dn={}));var Bt;(function(i){i[i.UnStarted=0]="UnStarted",i[i.Playing=1]="Playing",i[i.Finished=2]="Finished"})(Bt||(Bt={}));var dt;(function(i){i[i.Standby=0]="Standby",i[i.Playing=1]="Playing",i[i.CrossFading=2]="CrossFading",i[i.FixedCrossFading=3]="FixedCrossFading"})(dt||(dt={}));var jf=function(){function i(n,t,e){switch(this.crossCurveMark=0,this.crossCurveIndex=void 0,this.target=void 0,this.type=void 0,this.property=void 0,this.component=void 0,this.defaultValue=void 0,this.fixedPoseValue=void 0,this._hasSavedDefaultValue=!1,this.target=n,this.type=t,this.property=e,e){case xe.Position:this.defaultValue=new T,this.fixedPoseValue=new T,this.component=n.transform;break;case xe.Rotation:this.defaultValue=new De,this.fixedPoseValue=new De,this.component=n.transform;break;case xe.Scale:this.defaultValue=new T,this.fixedPoseValue=new T,this.component=n.transform;break;case xe.BlendShapeWeights:this.component=n.getComponent(si);var r=this.component.blendShapeWeights.length;this.defaultValue=new Float32Array(r),this.fixedPoseValue=new Float32Array(r);break}}var o=i.prototype;return o.saveDefaultValue=function(){switch(this.property){case xe.Position:this.defaultValue.copyFrom(this.target.transform.position);break;case xe.Rotation:this.defaultValue.copyFrom(this.target.transform.rotationQuaternion);break;case xe.Scale:this.defaultValue.copyFrom(this.target.transform.scale);break;case xe.BlendShapeWeights:for(var t=this.component,e=t.blendShapeWeights,r=0,a=e.length;r<a;++r)this.defaultValue[r]=e[r];break}this._hasSavedDefaultValue=!0},o.saveFixedPoseValue=function(){switch(this.property){case xe.Position:this.fixedPoseValue.copyFrom(this.target.transform.position);break;case xe.Rotation:this.fixedPoseValue.copyFrom(this.target.transform.rotationQuaternion);break;case xe.Scale:this.fixedPoseValue.copyFrom(this.target.transform.scale);break;case xe.BlendShapeWeights:for(var t=this.component,e=t.blendShapeWeights,r=0,a=e.length;r<a;++r)this.fixedPoseValue[r]=this.component.blendShapeWeights[r];break}},i}(),$f=function(){this.event=void 0,this.handlers=[]},Oh=function(){this.duration=0,this.offset=0,this.exitTime=1,this.destinationState=void 0},Ln;(function(i){i[i.Once=0]="Once",i[i.Loop=1]="Loop"})(Ln||(Ln={}));var tc=function(){function i(){this.state=void 0,this.stateData=void 0,this.frameTime=void 0,this.playState=void 0,this.clipTime=void 0,this.currentEventIndex=void 0}var o=i.prototype;return o.reset=function(t,e,r){this.state=t,this.frameTime=r,this.stateData=e,this.playState=Bt.UnStarted,this.clipTime=t.clipStartTime*t.clip.length,this.currentEventIndex=0},o.update=function(t){var e=this.state,r=this.frameTime,a=e._getDuration();this.playState=Bt.Playing,e.wrapMode===Ln.Loop?r=a?r%a:0:Math.abs(r)>a&&(r=r<0?-a:a,this.playState=Bt.Finished),t&&r===0?this.clipTime=e.clipEndTime*e.clip.length:(r<0&&(r+=a),this.clipTime=r+e.clipStartTime*e.clip.length)},i}(),qf=function(){function i(){this.animatorStateDataMap={},this.srcPlayData=new tc,this.destPlayData=new tc,this.layerState=dt.Standby,this.crossCurveMark=0,this.manuallyTransition=new Oh,this.crossFadeTransition=void 0}var o=i.prototype;return o.switchPlayData=function(){var t=this.destPlayData,e=this.srcPlayData;this.srcPlayData=t,this.destPlayData=e},i}(),Yf=function(){this.curveOwners=[],this.eventHandlers=[]},Qf=function(){this.layerIndex=void 0,this.state=void 0},Jf=function(){this.curveOwner=void 0,this.srcCurveIndex=void 0,this.destCurveIndex=void 0},rc=function(){function i(){this.vector2=new q,this.vector3=new T,this.vector4=new Ve,this.quaternion=new De,this._floatArrayPool=[]}var o=i.prototype;return o.getFloatArray=function(t){var e=this._floatArrayPool[t];return e||(this._floatArrayPool[t]=e=new Float32Array(t)),e},i}(),cr,ic,nc,ac,oc,sc,lc,cc,uc,hc,Xn,So=(cr=(Xn=function(i){J(o,i);function o(t){var e;return e=i.call(this,t)||this,e._animatorController=void 0,U(e,"_speed",ic,z(e)),U(e,"_controllerUpdateFlag",nc,z(e)),U(e,"_animatorLayersData",ac,z(e)),U(e,"_crossCurveDataCollection",oc,z(e)),U(e,"_animationCurveOwners",sc,z(e)),U(e,"_crossCurveDataPool",lc,z(e)),U(e,"_animationEventHandlerPool",cc,z(e)),U(e,"_baseTempValue",uc,z(e)),U(e,"_crossTempValue",hc,z(e)),e}var n=o.prototype;return n.play=function(e,r,a){var s;r===void 0&&(r=-1),a===void 0&&(a=0),(s=this._controllerUpdateFlag)!==null&&s!==void 0&&s.flag&&this._clearPlayData();var l=this._getAnimatorStateInfo(e,r,o._animatorInfo),c=l.state;if(!!c){if(!c.clip){console.warn("The state named "+e+" has no AnimationClip data.");return}var u=this._getAnimatorLayerData(l.layerIndex),h=u.srcPlayData,d=h.state;d&&d!==c&&this._revertDefaultValue(h.state,h.stateData);var f=this._getAnimatorStateData(e,c,u);u.layerState=dt.Playing,h.reset(c,f,c._getDuration()*a),this._saveDefaultValues(f)}},n._reset=function(){var e=this._animatorController;if(e)for(var r=e.layers,a=0,s=r.length;a<s;++a)for(var l=r[a].stateMachine.states,c=this._getAnimatorLayerData(a),u=0,h=l.length;u<h;++u){var d=l[u],f=this._getAnimatorStateData(d.name,d,c);this._revertDefaultValue(d,f)}this._clearPlayData()},n.crossFade=function(e,r,a,s){var l;a===void 0&&(a=-1),s===void 0&&(s=0),(l=this._controllerUpdateFlag)!==null&&l!==void 0&&l.flag&&this._clearPlayData();var c=this._getAnimatorStateInfo(e,a,o._animatorInfo),u=c.state,h=this._getAnimatorLayerData(a),d=h.manuallyTransition;d.duration=r,d.offset=s,d.destinationState=u,this._crossFadeByTransition(d,a)},n.update=function(e){var r;if(this.speed!==0){var a=this._animatorController;if(!!a&&!((r=this._controllerUpdateFlag)!==null&&r!==void 0&&r.flag)){e*=this.speed;for(var s=0,l=a.layers.length;s<l;s++){var c=this._getAnimatorLayerData(s);c.layerState!==dt.Standby&&this._updateLayer(s,s===0,e/1e3)}}}},n.getCurrentAnimatorState=function(e){var r,a;return(r=this._animatorLayersData[e])===null||r===void 0||(a=r.srcPlayData)===null||a===void 0?void 0:a.state},n._onEnable=function(){this.engine._componentsManager.addOnUpdateAnimations(this)},n._onDisable=function(){this.engine._componentsManager.removeOnUpdateAnimations(this)},n._getAnimatorStateInfo=function(e,r,a){var s=null,l=this._animatorController;if(l){var c=l.layers;if(r===-1){for(var u=0,h=c.length;u<h;u++)if(s=c[u].stateMachine.findStateByName(e),s){r=u;break}}else s=c[r].stateMachine.findStateByName(e)}return a.layerIndex=r,a.state=s,a},n._saveDefaultValues=function(e){for(var r=e.curveOwners,a=r.length-1;a>=0;a--)r[a].saveDefaultValue()},n._getAnimatorStateData=function(e,r,a){var s=a.animatorStateDataMap,l=s[e];return l||(l=new Yf,s[e]=l,this._saveAnimatorStateData(r,l),this._saveAnimatorEventHandlers(r,l)),l},n._saveAnimatorStateData=function(e,r){for(var a=this.entity,s=this._animationCurveOwners,l=r.curveOwners,c=e.clip._curveBindings,u=c.length-1;u>=0;u--){var h=c[u],d=h.relativePath===""?a:a.findByPath(h.relativePath),f=h.property,_=d.instanceId,g=s[_]||(s[_]=[]);l[u]=g[f]||(g[f]=new jf(d,h.type,f))}},n._saveAnimatorEventHandlers=function(e,r){var a=this._animationEventHandlerPool,s=this._entity._scripts,l=s.length,c=r.eventHandlers,u=e.clip.events;a.resetPool(),c.length=0;for(var h=0,d=u.length;h<d;h++){var f=u[h],_=a.getFromPool(),g=f.functionName,v=_.handlers;_.event=f,v.length=0;for(var p=l-1;p>=0;p--){var m=s.get(p)[g];m&&v.push(m)}c.push(_)}},n._clearCrossData=function(e){e.crossCurveMark++,this._crossCurveDataCollection.length=0,this._crossCurveDataPool.resetPool()},n._addCrossCurveData=function(e,r,a,s){var l=this._crossCurveDataPool.getFromPool();l.curveOwner=r,l.srcCurveIndex=a,l.destCurveIndex=s,e.push(l)},n._prepareCrossFading=function(e){var r=this._crossCurveDataCollection,a=e.crossCurveMark;this._prepareSrcCrossData(r,e.srcPlayData,a,!1),this._prepareDestCrossData(r,e.destPlayData,a,!1)},n._prepareStandbyCrossFading=function(e){var r=this._crossCurveDataCollection,a=e.srcPlayData,s=e.crossCurveMark;a.state&&this._prepareSrcCrossData(r,a,s,!0),this._prepareDestCrossData(r,e.destPlayData,s,!0)},n._prepareFixedPoseCrossFading=function(e){for(var r=this._crossCurveDataCollection,a=r.length-1;a>=0;a--){var s=r[a];s.curveOwner.saveFixedPoseValue(),s.destCurveIndex=-1}this._prepareDestCrossData(r,e.destPlayData,e.crossCurveMark,!0)},n._prepareSrcCrossData=function(e,r,a,s){for(var l=r.stateData.curveOwners,c=l.length-1;c>=0;c--){var u=l[c];u.crossCurveMark=a,u.crossCurveIndex=e.length,s&&u.saveFixedPoseValue(),this._addCrossCurveData(e,u,c,-1)}},n._prepareDestCrossData=function(e,r,a,s){for(var l=r.stateData.curveOwners,c=l.length-1;c>=0;c--){var u=l[c];u.crossCurveMark===a?e[u.crossCurveIndex].destCurveIndex=c:(u.saveDefaultValue(),s&&u.saveFixedPoseValue(),u.crossCurveMark=a,u.crossCurveIndex=e.length,this._addCrossCurveData(e,u,-1,c))}},n._evaluateCurve=function(e,r,a,s,l){var c;switch(s&&(c=r.keys[0].value),r._valueType){case Te.Float:{var u=r.evaluate(a);return s?u-c:u}case Te.FloatArray:{var h=l.getFloatArray(r._valueSize);if(r._evaluate(a,h),s)for(var d=0,f=h.length;d<f;d++)h[d]=h[d]-c[d];return h}case Te.Vector2:{var _=l.vector2;return r._evaluate(a,_),s&&(e===xe.Scale?q.divide(_,c,_):q.subtract(_,c,_)),_}case Te.Vector3:{var g=l.vector3;return r._evaluate(a,g),s&&(e===xe.Scale?T.divide(g,c,g):T.subtract(g,c,g)),g}case Te.Vector4:{var v=l.vector4;return r._evaluate(a,v),s&&Ve.subtract(v,c,v),v}case Te.Quaternion:{var p=l.quaternion;if(r._evaluate(a,p),s){var m=o._tempQuat;De.conjugate(c,m),De.multiply(m,p,p)}return p}}},n._getAnimatorLayerData=function(e){var r=this._animatorLayersData[e];return r||(this._animatorLayersData[e]=r=new qf),r},n._updateLayer=function(e,r,a){var s=this._animatorController.layers[e],l=s.blendingMode,c=s.weight,u=this._animatorLayersData[e],h=u.srcPlayData,d=u.destPlayData,f=u.crossFadeTransition,_=l===Dn.Additive,g=r?1:c;switch(u.layerState!==dt.FixedCrossFading&&this._checkTransition(h,f,e),u.layerState){case dt.Playing:this._updatePlayingState(h,u,e,g,a,_);break;case dt.FixedCrossFading:this._updateCrossFadeFromPose(d,u,e,g,a,_);break;case dt.CrossFading:this._updateCrossFade(h,d,u,e,g,a,_);break}},n._updatePlayingState=function(e,r,a,s,l,c){var u=e.stateData,h=u.curveOwners,d=u.eventHandlers,f=e.state,_=e.playState,g=e.clipTime,v=f.clip._curveBindings;e.update(this.speed<0);var p=e.clipTime,m=e.playState;d.length&&this._fireAnimationEvents(e,d,g,p);for(var y=v.length-1;y>=0;y--){var x=h[y],S=this._evaluateCurve(x.property,v[y].curve,p,c,this._baseTempValue);c?this._applyClipValueAdditive(x,S,s):this._applyClipValue(x,S,s)}e.frameTime+=f.speed*l,m===Bt.Finished&&(r.layerState=dt.Standby),_===Bt.UnStarted&&this._callAnimatorScriptOnEnter(f,a),m===Bt.Finished?this._callAnimatorScriptOnExit(f,a):this._callAnimatorScriptOnUpdate(f,a)},n._updateCrossFade=function(e,r,a,s,l,c,u){var h=this._crossCurveDataCollection,d=e.state.clip._curveBindings,f=e.state,_=e.stateData,g=e.playState,v=_.eventHandlers,p=r.state,m=r.stateData,y=r.playState,x=m.eventHandlers,S=p.clip._curveBindings,w=e.clipTime,b=r.clipTime,A=Math.abs(r.frameTime)/(p._getDuration()*a.crossFadeTransition.duration);A>=1&&(A=1),e.update(this.speed<0),r.update(this.speed<0);var E=e.playState,C=r.playState;this._updateCrossFadeData(a,A,c,!1);var M=e.clipTime,P=r.clipTime;v.length&&this._fireAnimationEvents(e,v,w,M),x.length&&this._fireAnimationEvents(r,x,b,P),g===Bt.UnStarted&&this._callAnimatorScriptOnEnter(f,s),A===1||E===Bt.Finished?this._callAnimatorScriptOnExit(f,s):this._callAnimatorScriptOnUpdate(f,s),y===Bt.UnStarted&&this._callAnimatorScriptOnEnter(p,s),C===Bt.Finished?this._callAnimatorScriptOnExit(p,s):this._callAnimatorScriptOnUpdate(p,s);for(var R=h.length-1;R>=0;R--){var B=h[R],D=B.curveOwner,L=B.srcCurveIndex,N=B.destCurveIndex,W=D.property,I=D.defaultValue,V=L>=0?this._evaluateCurve(W,d[L].curve,M,u,this._baseTempValue):I,se=N>=0?this._evaluateCurve(W,S[N].curve,P,u,this._crossTempValue):I;this._applyCrossClipValue(D,V,se,A,l,u)}},n._updateCrossFadeFromPose=function(e,r,a,s,l,c){var u=this._crossCurveDataCollection,h=e.state,d=e.stateData,f=e.playState,_=d.eventHandlers,g=h.clip._curveBindings,v=e.clipTime,p=Math.abs(e.frameTime)/(h._getDuration()*r.crossFadeTransition.duration);p>=1&&(p=1),e.update(this.speed<0);var m=e.playState;this._updateCrossFadeData(r,p,l,!0);var y=e.clipTime;_.length&&this._fireAnimationEvents(e,_,v,y),f===Bt.UnStarted&&this._callAnimatorScriptOnEnter(h,a),m===Bt.Finished?this._callAnimatorScriptOnExit(h,a):this._callAnimatorScriptOnUpdate(h,a);for(var x=u.length-1;x>=0;x--){var S=u[x],w=S.curveOwner,b=S.destCurveIndex,A=b>=0?this._evaluateCurve(w.property,g[b].curve,y,c,this._crossTempValue):w.defaultValue;this._applyCrossClipValue(w,w.fixedPoseValue,A,p,s,c)}},n._updateCrossFadeData=function(e,r,a,s){var l=e.destPlayData;l.frameTime+=l.state.speed*a,r===1?(l.playState===Bt.Finished?e.layerState=dt.Standby:e.layerState=dt.Playing,e.switchPlayData()):s||(e.srcPlayData.frameTime+=e.srcPlayData.state.speed*a)},n._applyCrossClipValue=function(e,r,a,s,l,c){var u;if(e.type===$t)switch(e.property){case xe.Position:u=this._baseTempValue.vector3,T.lerp(r,a,s,u);break;case xe.Rotation:u=this._baseTempValue.quaternion,De.slerp(r,a,s,u);break;case xe.Scale:{u=this._baseTempValue.vector3,T.lerp(r,a,s,u);break}}else if(e.type===si)switch(e.property){case xe.BlendShapeWeights:u=this._baseTempValue.getFloatArray(r.length);for(var h=0,d=u.length;h<d;++h)u[h]=r[h]+(a[h]-r[h])*s;break}c?this._applyClipValueAdditive(e,u,l):this._applyClipValue(e,u,l)},n._applyClipValue=function(e,r,a){if(e.type===$t){var s=e.target.transform;switch(e.property){case xe.Position:if(a===1)s.position=r;else{var l=s.position;T.lerp(l,r,a,l)}break;case xe.Rotation:if(a===1)s.rotationQuaternion=r;else{var c=s.rotationQuaternion;De.slerp(c,r,a,c)}break;case xe.Scale:if(a===1)s.scale=r;else{var u=s.scale;T.lerp(u,r,a,u)}break}}else if(e.type===si)switch(e.property){case xe.BlendShapeWeights:if(a===1)e.component.blendShapeWeights=r;else for(var h=e.component,d=h.blendShapeWeights,f=0,_=d.length;f<_;++f)d[f]+=(r[f]-d[f])*a;break}},n._applyClipValueAdditive=function(e,r,a){if(e.type===$t){var s=e.target.transform;switch(e.property){case xe.Position:var l=s.position;l.x+=r.x*a,l.y+=r.y*a,l.z+=r.z*a,s.position=l;break;case xe.Rotation:var c=s.rotationQuaternion;la.quaternionWeight(r,a,r),r.normalize(),c.multiply(r),s.rotationQuaternion=c;break;case xe.Scale:var u=s.scale;la.scaleWeight(u,a,u),T.multiply(u,r,u),s.scale=u;break;case xe.BlendShapeWeights:for(var h=e.component,d=h.blendShapeWeights,f=0,_=d.length;f<_;++f)e.component.blendShapeWeights[f]+=r[f]*a;break}}},n._revertDefaultValue=function(e,r){var a=e.clip;if(a)for(var s=a._curveBindings,l=r.curveOwners,c=s.length-1;c>=0;c--){var u=l[c],h=u.target.transform;if(!!u._hasSavedDefaultValue)switch(u.property){case xe.Position:h.position=u.defaultValue;break;case xe.Rotation:h.rotationQuaternion=u.defaultValue;break;case xe.Scale:h.scale=u.defaultValue;break;case xe.BlendShapeWeights:for(var d=u.component,f=d.blendShapeWeights,_=0,g=f.length;_<g;++_)u.component.blendShapeWeights[_]=u.defaultValue[_];break}}},n._checkTransition=function(e,r,a){for(var s=e.state,l=e.clipTime,c=s._getDuration(),u=s.transitions,h=0,d=u.length;h<d;++h){var f=u[h];c*f.exitTime<=l&&r!==f&&this._crossFadeByTransition(f,a)}},n._crossFadeByTransition=function(e,r){var a=e.destinationState.name,s=this._getAnimatorStateInfo(a,r,o._animatorInfo),l=s.state;if(!!l){if(!l.clip){console.warn("The state named "+a+" has no AnimationClip data.");return}var c=this._getAnimatorLayerData(s.layerIndex),u=c.layerState,h=c.destPlayData,d=this._getAnimatorStateData(a,l,c),f=l._getDuration(),_=f*e.offset;switch(h.reset(l,d,_),u){case dt.Standby:c.layerState=dt.FixedCrossFading,this._clearCrossData(c),this._prepareStandbyCrossFading(c);break;case dt.Playing:c.layerState=dt.CrossFading,this._clearCrossData(c),this._prepareCrossFading(c);break;case dt.CrossFading:c.layerState=dt.FixedCrossFading,this._prepareFixedPoseCrossFading(c);break;case dt.FixedCrossFading:this._prepareFixedPoseCrossFading(c);break}c.crossFadeTransition=e}},n._fireAnimationEvents=function(e,r,a,s){var l=e.state,c=l.clip.length;this.speed>=0?s<a?(this._fireSubAnimationEvents(e,r,a,l.clipEndTime*c),e.currentEventIndex=0,this._fireSubAnimationEvents(e,r,l.clipStartTime*c,s)):this._fireSubAnimationEvents(e,r,a,s):s>a?(this._fireBackwardSubAnimationEvents(e,r,a,l.clipStartTime*c),e.currentEventIndex=r.length-1,this._fireBackwardSubAnimationEvents(e,r,l.clipEndTime*c,s)):this._fireBackwardSubAnimationEvents(e,r,a,s)},n._fireSubAnimationEvents=function(e,r,a,s){for(var l=e.currentEventIndex,c=r.length;l<c;l++){var u=r[l],h=u.event,d=h.time,f=h.parameter;if(d>s)break;var _=u.handlers;if(d>=a){for(var g=_.length-1;g>=0;g--)_[g](f);e.currentEventIndex=Math.min(l+1,c-1)}}},n._fireBackwardSubAnimationEvents=function(e,r,a,s){for(var l=e.currentEventIndex;l>=0;l--){var c=r[l],u=c.event,h=u.time,d=u.parameter;if(h<s)break;var f=c.handlers;if(h<=a){for(var _=f.length-1;_>=0;_--)f[_](d);e.currentEventIndex=Math.max(l-1,0)}}},n._callAnimatorScriptOnEnter=function(e,r){for(var a=e._onStateEnterScripts,s=0,l=a.length;s<l;s++)a[s].onStateEnter(this,e,r)},n._callAnimatorScriptOnUpdate=function(e,r){for(var a=e._onStateUpdateScripts,s=0,l=a.length;s<l;s++)a[s].onStateUpdate(this,e,r)},n._callAnimatorScriptOnExit=function(e,r){for(var a=e._onStateExitScripts,s=0,l=a.length;s<l;s++)a[s].onStateExit(this,e,r)},n._clearPlayData=function(){this._animatorLayersData.length=0,this._crossCurveDataCollection.length=0,this._animationCurveOwners.length=0,this._controllerUpdateFlag&&(this._controllerUpdateFlag.flag=!1)},te(o,[{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"animatorController",get:function(){return this._animatorController},set:function(e){e!==this._animatorController&&(this._controllerUpdateFlag&&this._controllerUpdateFlag.destroy(),this._controllerUpdateFlag=e&&e._registerChangeFlag(),this._animatorController=e)}}]),o}(ar),Xn._tempQuat=new De,Xn._animatorInfo=new Qf,Xn),ic=k(cr.prototype,"_speed",[qe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nc=k(cr.prototype,"_controllerUpdateFlag",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ac=k(cr.prototype,"_animatorLayersData",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oc=k(cr.prototype,"_crossCurveDataCollection",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sc=k(cr.prototype,"_animationCurveOwners",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lc=k(cr.prototype,"_crossCurveDataPool",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti(Jf)}}),cc=k(cr.prototype,"_animationEventHandlerPool",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ti($f)}}),uc=k(cr.prototype,"_baseTempValue",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rc}}),hc=k(cr.prototype,"_crossTempValue",[re],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rc}}),cr),Ih=function(){function i(){this._updateFlagManager=new Ri,this._layers=[],this._layersMap={}}var o=i.prototype;return o.findLayerByName=function(t){return this._layersMap[t]},o.addLayer=function(t){this._layers.push(t),this._layersMap[t.name]=t,this._distributeUpdateFlag()},o.removeLayer=function(t){var e=this.layers[t];this._layers.splice(t,1),delete this._layersMap[e.name],this._distributeUpdateFlag()},o.clearLayers=function(){this._layers.length=0;for(var t in this._layersMap)delete this._layersMap[t];this._distributeUpdateFlag()},o._registerChangeFlag=function(){return this._updateFlagManager.createFlag(nn)},o._distributeUpdateFlag=function(){this._updateFlagManager.dispatch()},te(i,[{key:"layers",get:function(){return this._layers}}]),i}(),Nh=function(o){this.name=o,this.weight=1,this.blendingMode=Dn.Override,this.stateMachine=void 0},ja=function(){function i(){this._destroyed=!1,this._state=void 0}var o=i.prototype;return o.onStateEnter=function(t,e,r){},o.onStateUpdate=function(t,e,r){},o.onStateExit=function(t,e,r){},o.destroy=function(){this._destroyed||(this._state._removeStateMachineScript(this),this._destroyed=!0)},i}(),Uh=function(){function i(n){this.name=n,this.speed=1,this.wrapMode=Ln.Loop,this._onStateEnterScripts=[],this._onStateUpdateScripts=[],this._onStateExitScripts=[],this._clipStartTime=0,this._clipEndTime=1,this._clip=void 0,this._transitions=[]}var o=i.prototype;return o.addTransition=function(t){this._transitions.push(t)},o.removeTransition=function(t){var e=this._transitions.indexOf(t);e!==-1&&this._transitions.splice(e,1)},o.addStateMachineScript=function(t){var e=new t;e._state=this;var r=ja.prototype;return e.onStateEnter!==r.onStateEnter&&this._onStateEnterScripts.push(e),e.onStateUpdate!==r.onStateUpdate&&this._onStateUpdateScripts.push(e),e.onStateExit!==r.onStateExit&&this._onStateExitScripts.push(e),e},o.clearTransitions=function(){this._transitions.length=0},o._getDuration=function(){return this.clip?(this._clipEndTime-this._clipStartTime)*this.clip.length:null},o._removeStateMachineScript=function(t){var e=ja.prototype;if(t.onStateEnter!==e.onStateEnter){var r=this._onStateEnterScripts.indexOf(t);r!==-1&&this._onStateEnterScripts.splice(r,1)}if(t.onStateUpdate!==e.onStateUpdate){var a=this._onStateUpdateScripts.indexOf(t);a!==-1&&this._onStateUpdateScripts.splice(a,1)}if(t.onStateExit!==e.onStateExit){var s=this._onStateExitScripts.indexOf(t);s!==-1&&this._onStateExitScripts.splice(s,1)}},te(i,[{key:"transitions",get:function(){return this._transitions}},{key:"clip",get:function(){return this._clip},set:function(t){this._clip=t,this._clipEndTime=Math.min(this._clipEndTime,1)}},{key:"clipStartTime",get:function(){return this._clipStartTime},set:function(t){this._clipStartTime=Math.max(t,0)}},{key:"clipEndTime",get:function(){return this._clipEndTime},set:function(t){this._clipEndTime=Math.min(t,1)}}]),i}(),kh=function(){function i(){this.states=[],this._statesMap={}}var o=i.prototype;return o.addState=function(t){var e=this.findStateByName(t);return e?console.warn("The state named "+t+" has existed."):(e=new Uh(t),this.states.push(e),this._statesMap[t]=e),e},o.removeState=function(t){var e=t.name,r=this.states.indexOf(t);r>-1&&this.states.splice(r,1),delete this._statesMap[e]},o.findStateByName=function(t){return this._statesMap[t]},o.makeUniqueStateName=function(t){for(var e=this._statesMap,r=t,a=0;e[t];)t=r+" "+a,a++;return t},i}(),Er;(function(i){i[i.Linear=0]="Linear",i[i.CubicSpine=1]="CubicSpine",i[i.Step=2]="Step",i[i.Hermite=3]="Hermite"})(Er||(Er={}));var Vh=function(){function i(){this.keys=[],this.interpolation=void 0,this._valueSize=void 0,this._valueType=void 0,this._tempValue=void 0,this._length=0,this._currentIndex=0}var o=i.prototype;return o.addKey=function(t){var e=t.time;if(this.keys.push(t),e>this._length&&(this._length=e),!this._valueSize&&(typeof t.value=="number"&&(this._valueSize=1,this._valueType=Te.Float,this._tempValue=0),t.value instanceof q&&(this._valueSize=2,this._valueType=Te.Vector2,this._tempValue=new q),t.value instanceof T&&(this._valueSize=3,this._valueType=Te.Vector3,this._tempValue=new T),t.value instanceof Ve&&(this._valueSize=4,this._valueType=Te.Vector4,this._tempValue=new Ve),t.value instanceof De&&(this._valueSize=4,this._valueType=Te.Quaternion,this._tempValue=new De),t.value instanceof Float32Array)){var r=t.value.length;this._valueSize=r,this._valueType=Te.FloatArray,this._tempValue=new Float32Array(r)}this.keys.sort(function(a,s){return a.time-s.time})},o.evaluate=function(t){return this._evaluate(t,this._tempValue)},o.moveKey=function(t,e){this.keys[t]=e},o.removeKey=function(t){this.keys.splice(t,1);for(var e=this.keys,r=this.keys.length,a=0,s=r-1;s>=0;s--)e[s].time>length&&(a=e[s].time);this._length=a},o._evaluate=function(t,e){var r=this.keys,a=this.interpolation;this._valueType;var s=this.keys.length,l=this._currentIndex;l!==-1&&t<r[l].time&&(l=-1);for(var c=l+1;c<s&&!(t<r[c].time);)l++,c++;this._currentIndex=l;var u;if(l===-1)u=this._evaluateStep(0,e);else if(c===s)u=this._evaluateStep(l,e);else{var h=r[l].time,d=r[c].time-h,f=(t-h)/d,_=d;switch(a){case Er.Linear:u=this._evaluateLinear(l,c,f,e);break;case Er.Step:u=this._evaluateStep(l,e);break;case Er.CubicSpine:case Er.Hermite:u=this._evaluateHermite(l,c,f,_,e)}}return u},o._evaluateLinear=function(t,e,r,a){var s=this._valueType,l=this.keys;switch(s){case Te.Float:return l[t].value*(1-r)+l[e].value*r;case Te.FloatArray:for(var c=l[t].value,u=l[e].value,h=0,d=c.length;h<d;h++)a[h]=c[h]*(1-r)+u[h]*r;return a;case Te.Vector2:return q.lerp(l[t].value,l[e].value,r,a),a;case Te.Vector3:return T.lerp(l[t].value,l[e].value,r,a),a;case Te.Vector4:return Ve.lerp(l[t].value,l[e].value,r,a),a;case Te.Quaternion:return De.slerp(l[t].value,l[e].value,r,a),a}},o._evaluateStep=function(t,e){var r=this._valueType,a=this.keys;switch(r){case Te.Float:return a[t].value;case Te.FloatArray:for(var s=a[t].value,l=0,c=s.length;l<c;l++)e[l]=s[l];return e;case Te.Vector2:case Te.Vector3:case Te.Vector4:case Te.Quaternion:return e.copyFrom(a[t].value),e}},o._evaluateHermite=function(t,e,r,a,s){var l=this._valueSize,c=this.keys,u=c[t],h=c[e];switch(l){case 1:{var d=u.outTangent,f=h.inTangent,_=u.value,g=h.value;if(Number.isFinite(d)&&Number.isFinite(f)){var v=r*r,p=v*r,m=2*p-3*v+1,y=p-2*v+r,x=p-v,S=-2*p+3*v;return m*_+y*d*a+x*f*a+S*g}else return u.value}case 2:{var w=u.value,b=u.outTangent,A=h.value,E=h.inTangent,C=r*r,M=C*r,P=2*M-3*C+1,R=M-2*C+r,B=M-C,D=-2*M+3*C,L=b.x,N=E.x;return Number.isFinite(L)&&Number.isFinite(N)?s.x=P*w.x+R*L*a+B*N*a+D*A.x:s.x=w.x,L=b.y,N=E.y,Number.isFinite(L)&&Number.isFinite(N)?s.y=P*w.y+R*L*a+B*N*a+D*A.y:s.y=w.y,s}case 3:{var W=u.value,I=u.outTangent,V=h.value,se=h.inTangent,Z=r*r,Y=Z*r,ue=2*Y-3*Z+1,ie=Y-2*Z+r,be=Y-Z,ye=-2*Y+3*Z,Fe=I.x,Qe=se.x;return Number.isFinite(Fe)&&Number.isFinite(Qe)?s.x=ue*W.x+ie*Fe*a+be*Qe*a+ye*V.x:s.x=W.x,Fe=I.y,Qe=se.y,Number.isFinite(Fe)&&Number.isFinite(Qe)?s.y=ue*W.y+ie*Fe*a+be*Qe*a+ye*V.y:s.y=W.y,Fe=I.z,Qe=se.z,Number.isFinite(Fe)&&Number.isFinite(Qe)?s.z=ue*W.z+ie*Fe*a+be*Qe*a+ye*V.z:s.z=W.z,s}case 4:{var Be=u.value,Oe=u.outTangent,Ge=h.value,Ae=h.inTangent,pe=r*r,Je=pe*r,Ze=2*Je-3*pe+1,He=Je-2*pe+r,Ke=Je-pe,ft=-2*Je+3*pe,Ue=Oe.x,ke=Ae.x;return Number.isFinite(Ue)&&Number.isFinite(ke)?s.x=Ze*Be.x+He*Ue*a+Ke*ke*a+ft*Ge.x:s.x=Be.x,Ue=Oe.y,ke=Ae.y,Number.isFinite(Ue)&&Number.isFinite(ke)?s.y=Ze*Be.y+He*Ue*a+Ke*ke*a+ft*Ge.y:s.y=Be.y,Ue=Oe.z,ke=Ae.z,Number.isFinite(Ue)&&Number.isFinite(ke)?s.z=Ze*Be.z+He*Ue*a+Ke*ke*a+ft*Ge.z:s.z=Be.z,Ue=Oe.w,ke=Ae.w,Number.isFinite(Ue)&&Number.isFinite(ke)?s.w=Ze*Be.w+He*Ue*a+Ke*ke*a+ft*Ge.w:s.w=Be.w,s}}},te(i,[{key:"length",get:function(){return this._length}}]),i}(),Gh=function(){this.time=void 0,this.value=void 0},wi=function(i){J(o,i);function o(){for(var n,t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return n=i.call.apply(i,[this].concat(e))||this,n.inTangent=void 0,n.outTangent=void 0,n}return o}(Gh),$a;(function(i){i[i.If=0]="If",i[i.IfNot=1]="IfNot",i[i.Greater=2]="Greater",i[i.Less=3]="Less",i[i.Equals=4]="Equals",i[i.NotEquals=5]="NotEquals"})($a||($a={}));var Co=function(i){J(o,i);function o(n){var t;return t=i.call(this,n,F.find("skybox"))||this,t._decodeParam=new Ve(0,5,0,0),t.renderState.rasterState.cullMode=qt.Off,t.renderState.depthState.compareFunction=Ne.LessEqual,t.shaderData.setVector4("u_cubeDecodeParam",t._decodeParam),t}return te(o,[{key:"textureDecodeRGBM",get:function(){return Boolean(this._decodeParam.x)},set:function(t){this._decodeParam.x=Number(t)}},{key:"RGBMDecodeFactor",get:function(){return this._decodeParam.y},set:function(t){this._decodeParam.y=t}},{key:"textureCubeMap",get:function(){return this.shaderData.getTexture("u_cube")},set:function(t){this.shaderData.setTexture("u_cube",t)}}]),o}(pr),Ce;(function(i){i[i.Position=1]="Position",i[i.Velocity=2]="Velocity",i[i.Acceleration=4]="Acceleration",i[i.Color=8]="Color",i[i.Alpha=16]="Alpha",i[i.Size=32]="Size",i[i.StartAngle=64]="StartAngle",i[i.StartTime=128]="StartTime",i[i.LifeTime=256]="LifeTime",i[i.RotateVelocity=512]="RotateVelocity",i[i.Scale=1024]="Scale",i[i.Everything=4294967295]="Everything"})(Ce||(Ce={}));var Ji;(function(i){i[i.Transparent=0]="Transparent",i[i.Additive=1]="Additive"})(Ji||(Ji={}));var Hh=function(i){J(o,i),o._getRandom=function(){return Math.random()-.5};function o(t){var e;return e=i.call(this,t)||this,e._vertexStride=void 0,e._vertices=void 0,e._vertexBuffer=void 0,e._maxCount=1e3,e._position=new T,e._positionRandomness=new T,e._positionArray=void 0,e._velocity=new T,e._velocityRandomness=new T,e._acceleration=new T,e._accelerationRandomness=new T,e._color=new oe(1,1,1,1),e._colorRandomness=0,e._size=1,e._sizeRandomness=0,e._alpha=1,e._alphaRandomness=0,e._startAngle=0,e._startAngleRandomness=0,e._rotateVelocity=0,e._rotateVelocityRandomness=0,e._lifetime=5,e._startTimeRandomness=0,e._scale=1,e._isOnce=!1,e._onceTime=0,e._time=0,e._isInit=!1,e._isStart=!1,e._updateDirtyFlag=Ce.Everything,e._isRotateToVelocity=!1,e._isUseOriginColor=!1,e._isScaleByLifetime=!1,e._is2d=!0,e._isFadeIn=!1,e._isFadeOut=!1,e._playOnEnable=!0,e._blendMode=Ji.Transparent,e.spriteSheet=void 0,e.setMaterial(e._createMaterial()),e}var n=o.prototype;return n.update=function(e){if(!(!this._isInit||!this._isStart)){if(this._isOnce&&this._time>this._onceTime)return this.stop();this._updateDirtyFlag&&(this._updateBuffer(),this._updateDirtyFlag=0),this._time+=e/1e3,this.shaderData.setFloat("u_time",this._time)}},n._onEnable=function(){i.prototype._onEnable.call(this),this._playOnEnable&&this.start()},n.start=function(){this._isStart=!0,this._time=0},n.stop=function(){this._isStart=!1},n._createMaterial=function(){var e=new pr(this.engine,F.find("particle-shader")),r=e.renderState,a=r.blendState.targetBlendState;return a.enabled=!0,a.sourceColorBlendFactor=de.SourceAlpha,a.destinationColorBlendFactor=de.OneMinusSourceAlpha,a.sourceAlphaBlendFactor=de.One,a.destinationAlphaBlendFactor=de.OneMinusSourceAlpha,r.depthState.writeEnabled=!1,e.renderQueueType=bt.Transparent,this.isUseOriginColor=!0,this.is2d=!0,this.isFadeOut=!0,e},n._createMesh=function(){var e=new ba(this._entity.engine,"particleMesh"),r=96,a=this._maxCount*4,s=a*r,l=new Float32Array(s),c=null,u=!1;if(a>o._uint16VertexLimit)if(this.engine._hardwareRenderer.canIUse(ae.elementIndexUint))u=!0,c=new Uint32Array(6*this._maxCount);else throw Error("The vertex count is over limit.");else c=new Uint16Array(6*this._maxCount);for(var h=0,d=0;h<this._maxCount;++h){var f=h*4;c[d++]=f,c[d++]=f+1,c[d++]=f+2,c[d++]=f,c[d++]=f+2,c[d++]=f+3}var _=[new Ee("a_position",0,ne.Vector3,0),new Ee("a_velocity",12,ne.Vector3,0),new Ee("a_acceleration",24,ne.Vector3,0),new Ee("a_color",36,ne.Vector4,0),new Ee("a_lifeAndSize",52,ne.Vector4,0),new Ee("a_rotation",68,ne.Vector2,0),new Ee("a_uv",76,ne.Vector3,0),new Ee("a_normalizedUv",88,ne.Vector2,0)],g=new Ur(this.engine,gr.VertexBuffer,s*4,Pt.Dynamic),v=new Ur(this.engine,gr.IndexBuffer,c,Pt.Dynamic);return e.setVertexBufferBinding(g,r),e.setIndexBufferBinding(v,u?nt.UInt32:nt.UInt16),e.setVertexElements(_),e.addSubMesh(0,c.length),this._vertexBuffer=g,this._vertexStride=r/4,this._vertices=l,e},n._updateBuffer=function(){for(var e=0;e<this._maxCount;e++)this._updateSingleBuffer(e);this._vertexBuffer.setData(this._vertices)},n._updateSingleBuffer=function(e){var r=this._updateDirtyFlag,a=this._vertices,s=this._vertexStride,l=o._getRandom,c=e*4,u=c*s,h=(c+1)*s,d=(c+2)*s,f=(c+3)*s;if(r&Ce.Position){var _=this._position,g=_.x,v=_.y,p=_.z,m=this._positionArray,y=this._positionRandomness;if(m){if(m.length!==this._maxCount)throw Error("The length of positionArray must be equal to maxCount.");var x=m[e];g+=x.x,v+=x.y,p+=x.z}else g+=l()*y.x,v+=l()*y.y,p+=l()*y.z;a[u]=a[h]=a[d]=a[f]=g,a[u+1]=a[h+1]=a[d+1]=a[f+1]=v,a[u+2]=a[h+2]=a[d+2]=a[f+2]=p}if(r&Ce.Velocity){var S=this._velocity,w=this._velocityRandomness;a[u+3]=a[h+3]=a[d+3]=a[f+3]=S.x+l()*w.x,a[u+4]=a[h+4]=a[d+4]=a[f+4]=S.y+l()*w.y,a[u+5]=a[h+5]=a[d+5]=a[f+5]=S.z+l()*w.z}if(r&Ce.Acceleration){var b=this._acceleration,A=this._accelerationRandomness;a[u+6]=a[h+6]=a[d+6]=a[f+6]=b.x+l()*A.x,a[u+7]=a[h+7]=a[d+7]=a[f+7]=b.y+l()*A.y,a[u+8]=a[h+8]=a[d+8]=a[f+8]=b.z+l()*A.z}if(r&Ce.Color){var E=this._color,C=this._colorRandomness;a[u+9]=a[h+9]=a[d+9]=a[f+9]=H.clamp(E.r+l()*C,0,1),a[u+10]=a[h+10]=a[d+10]=a[f+10]=H.clamp(E.g+l()*C,0,1),a[u+11]=a[h+11]=a[d+11]=a[f+11]=H.clamp(E.b+l()*C,0,1)}if(r&Ce.Alpha&&(a[u+12]=a[h+12]=a[d+12]=a[f+12]=H.clamp(this._alpha+l()*this._alphaRandomness,0,1)),r&Ce.StartTime&&(a[u+13]=a[h+13]=a[d+13]=a[f+13]=Math.random()*this._startTimeRandomness),r&Ce.LifeTime){var M=this._lifetime;a[u+14]=a[h+14]=a[d+14]=a[f+14]=M+l()*M}if((r&Ce.StartTime||r&Ce.LifeTime)&&(this._onceTime=Math.max(this._onceTime,a[u+13]+a[u+14])),r&Ce.Size){var P=this._size;a[u+15]=a[h+15]=a[d+15]=a[f+15]=Math.max(P+l()*this._sizeRandomness*P*2,0)}r&Ce.Scale&&(a[u+16]=a[h+16]=a[d+16]=a[f+16]=this._scale),r&Ce.StartAngle&&(a[u+17]=a[h+17]=a[d+17]=a[f+17]=this._startAngle+l()*Math.PI*this._startAngleRandomness*2),r&Ce.RotateVelocity&&(a[u+18]=a[h+18]=a[d+18]=a[f+18]=this._rotateVelocity+l()*this._rotateVelocityRandomness),this._updateSingleUv(e,u,h,d,f)},n._updateSingleUv=function(e,r,a,s,l){var c=this.spriteSheet,u=this.getMaterial().shaderData.getTexture("u_texture"),h=this._vertices;if(u){var d=u.width,f=u.height;if(c){var _=c[e%c.length],g=_.x,v=_.y,p=_.w,m=_.h,y=g/d,x=v/f,S=y+p/d,w=x+m/f,b=m/p;h[r+19]=y,h[r+20]=w,h[r+21]=b,h[a+19]=S,h[a+20]=w,h[a+21]=b,h[s+19]=S,h[s+20]=x,h[s+21]=b,h[l+19]=y,h[l+20]=x,h[l+21]=b}else{var A=f/d;h[r+19]=0,h[r+20]=1,h[r+21]=A,h[a+19]=1,h[a+20]=1,h[a+21]=A,h[s+19]=1,h[s+20]=0,h[s+21]=A,h[l+19]=0,h[l+20]=0,h[l+21]=A}}else h[r+19]=0,h[r+20]=0,h[r+21]=1,h[a+19]=1,h[a+20]=0,h[a+21]=1,h[s+19]=1,h[s+20]=1,h[s+21]=1,h[l+19]=0,h[l+20]=1,h[l+21]=1;h[r+22]=-.5,h[r+23]=-.5,h[a+22]=.5,h[a+23]=-.5,h[s+22]=.5,h[s+23]=.5,h[l+22]=-.5,h[l+23]=.5},te(o,[{key:"texture",get:function(){return this.getMaterial().shaderData.getTexture("u_texture")},set:function(e){e?(this.shaderData.enableMacro("particleTexture"),this.getMaterial().shaderData.setTexture("u_texture",e)):this.shaderData.disableMacro("particleTexture")}},{key:"position",get:function(){return this._position},set:function(e){this._updateDirtyFlag|=Ce.Position,this._position=e}},{key:"positionRandomness",get:function(){return this._positionRandomness},set:function(e){this._updateDirtyFlag|=Ce.Position,this._positionRandomness=e}},{key:"positionArray",get:function(){return this._positionArray},set:function(e){this._updateDirtyFlag|=Ce.Position,this._positionArray=e}},{key:"velocity",get:function(){return this._velocity},set:function(e){this._updateDirtyFlag|=Ce.Velocity,this._velocity=e}},{key:"velocityRandomness",get:function(){return this._velocityRandomness},set:function(e){this._updateDirtyFlag|=Ce.Velocity,this._velocityRandomness=e}},{key:"acceleration",get:function(){return this._acceleration},set:function(e){this._updateDirtyFlag|=Ce.Acceleration,this._acceleration=e}},{key:"accelerationRandomness",get:function(){return this._accelerationRandomness},set:function(e){this._updateDirtyFlag|=Ce.Acceleration,this._accelerationRandomness=e}},{key:"color",get:function(){return this._color},set:function(e){this._updateDirtyFlag|=Ce.Color,this._color=e}},{key:"colorRandomness",get:function(){return this._colorRandomness},set:function(e){this._updateDirtyFlag|=Ce.Color,this._colorRandomness=e}},{key:"size",get:function(){return this._size},set:function(e){this._updateDirtyFlag|=Ce.Size,this._size=e}},{key:"sizeRandomness",get:function(){return this._sizeRandomness},set:function(e){this._updateDirtyFlag|=Ce.Size,this._sizeRandomness=e}},{key:"alpha",get:function(){return this._alpha},set:function(e){this._updateDirtyFlag|=Ce.Alpha,this._alpha=e}},{key:"alphaRandomness",get:function(){return this._alphaRandomness},set:function(e){this._updateDirtyFlag|=Ce.Alpha,this._alphaRandomness=e}},{key:"angle",get:function(){return this._startAngle},set:function(e){this._updateDirtyFlag|=Ce.StartAngle,this._startAngle=e}},{key:"angleRandomness",get:function(){return this._startAngleRandomness},set:function(e){this._updateDirtyFlag|=Ce.StartAngle,this._startAngleRandomness=e}},{key:"rotateVelocity",get:function(){return this._rotateVelocity},set:function(e){this._updateDirtyFlag|=Ce.RotateVelocity,this._rotateVelocity=e}},{key:"rotateVelocityRandomness",get:function(){return this._rotateVelocityRandomness},set:function(e){this._updateDirtyFlag|=Ce.RotateVelocity,this._rotateVelocityRandomness=e}},{key:"lifetime",get:function(){return this._lifetime},set:function(e){this._updateDirtyFlag|=Ce.LifeTime,this._lifetime=e,this._onceTime=0}},{key:"startTimeRandomness",get:function(){return this._startTimeRandomness},set:function(e){this._updateDirtyFlag|=Ce.StartTime,this._startTimeRandomness=e,this._onceTime=0}},{key:"scale",get:function(){return this._scale},set:function(e){this._updateDirtyFlag|=Ce.Scale,this._scale=e}},{key:"maxCount",get:function(){return this._maxCount},set:function(e){this._isStart=!1,this._isInit=!1,this._maxCount=e,this._updateDirtyFlag=Ce.Everything,this.mesh=this._createMesh(),this._updateBuffer(),this._isInit=!0,this.shaderData.setFloat("u_time",0)}},{key:"isOnce",get:function(){return this._isOnce},set:function(e){this._time=0,this.shaderData.setInt("u_once",e?1:0),this._isOnce=e}},{key:"isRotateToVelocity",get:function(){return this._isRotateToVelocity},set:function(e){e?this.shaderData.enableMacro("rotateToVelocity"):this.shaderData.disableMacro("rotateToVelocity"),this._isRotateToVelocity=e}},{key:"isUseOriginColor",get:function(){return this._isUseOriginColor},set:function(e){e?this.shaderData.enableMacro("useOriginColor"):this.shaderData.disableMacro("useOriginColor"),this._isUseOriginColor=e}},{key:"isScaleByLifetime",get:function(){return this._isScaleByLifetime},set:function(e){e?this.shaderData.enableMacro("isScaleByLifetime"):this.shaderData.disableMacro("isScaleByLifetime"),this._isScaleByLifetime=e}},{key:"is2d",get:function(){return this._is2d},set:function(e){e?this.shaderData.enableMacro("is2d"):(this.shaderData.disableMacro("is2d"),this.getMaterial().renderState.rasterState.cullMode=qt.Off),this._is2d=e}},{key:"isFadeIn",get:function(){return this._isFadeIn},set:function(e){e?this.shaderData.enableMacro("fadeIn"):this.shaderData.disableMacro("fadeIn"),this._isFadeIn=e}},{key:"isFadeOut",get:function(){return this._isFadeOut},set:function(e){e?this.shaderData.enableMacro("fadeOut"):this.shaderData.disableMacro("fadeOut"),this._isFadeOut=e}},{key:"playOnEnable",get:function(){return this._playOnEnable},set:function(e){this._playOnEnable=e,e?this.start():this.stop()}},{key:"blendMode",get:function(){return this._blendMode},set:function(e){var r=this.getMaterial().renderState.blendState,a=r.targetBlendState;e===Ji.Transparent?(a.enabled=!0,a.sourceColorBlendFactor=de.SourceAlpha,a.destinationColorBlendFactor=de.OneMinusSourceAlpha,a.sourceAlphaBlendFactor=de.One,a.destinationAlphaBlendFactor=de.OneMinusSourceAlpha):e===Ji.Additive&&(a.enabled=!0,a.sourceColorBlendFactor=de.SourceAlpha,a.destinationColorBlendFactor=de.One,a.sourceAlphaBlendFactor=de.One,a.destinationAlphaBlendFactor=de.OneMinusSourceAlpha),this._blendMode=e}}]),o}(Ir);Hh._uint16VertexLimit=65535;var Zf=`#define GLSLIFY 1
varying vec2 v_uv;uniform sampler2D u_texture;void main(void){gl_FragColor=texture2D(u_texture,v_uv);}`,Kf=`#define GLSLIFY 1
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;uniform mat4 u_projMat;uniform mat4 u_viewMat;void main(){gl_Position=u_projMat*u_viewMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`;F.create("trail",Kf,Zf);var Wh=function(i){J(o,i);function o(n){var t;t=i.call(this,n,F.find("trail"))||this;var e=t.renderState.blendState.targetBlendState;return e.enabled=!0,e.sourceColorBlendFactor=e.sourceAlphaBlendFactor=de.SourceAlpha,e.destinationColorBlendFactor=e.destinationAlphaBlendFactor=de.One,t.renderState.depthState.writeEnabled=!1,t}return o}(pr),dc=new T,ev=function(i){J(o,i);function o(t,e){var r;r=i.call(this,t)||this,r._vertexStride=void 0,r._vertices=void 0,r._vertexBuffer=void 0,r._stroke=void 0,r._minSeg=void 0,r._lifetime=void 0,r._maxPointNum=void 0,r._points=void 0,r._pointStates=void 0,r._strapPoints=void 0,r._curPointNum=void 0,r._prePointsNum=void 0,r._stroke=e.stroke||.2,r._minSeg=e.minSeg||.02,r._lifetime=e.lifetime||1e3,r._maxPointNum=r._lifetime/1e3*t.engine.targetFrameRate,r._points=[],r._pointStates=[],r._strapPoints=[];for(var a=0;a<r._maxPointNum;a++)r._points.push(new T),r._pointStates.push(r._lifetime),r._strapPoints.push(new T),r._strapPoints.push(new T);r._curPointNum=0;var s=e.material||new Wh(r.engine);return r.setMaterial(s),r.setTexture(e.texture),r._initGeometry(),r}var n=o.prototype;return n.update=function(e){for(var r=0,a=0,s=0;s<this._curPointNum;s++)this._pointStates[s]-=e,this._pointStates[s]<0?r++:r>0&&(a=s-r,this._pointStates[a]=this._pointStates[s],this._points[a].copyFrom(this._points[s]));this._curPointNum-=r;var l=!0;if(this._curPointNum===this._maxPointNum)l=!1;else if(this._curPointNum>0){var c=this._points[this._points.length-1];T.distance(this.entity.transform.worldPosition,c)<this._minSeg&&(l=!1)}l&&(this._pointStates[this._curPointNum]=this._lifetime,this._points[this._curPointNum].copyFrom(this.entity.transform.worldPosition),this._curPointNum++)},n._render=function(e){this._updateStrapVertices(e,this._points),this._updateStrapCoords(),this._vertexBuffer.setData(this._vertices),i.prototype._render.call(this,e)},n.setTexture=function(e){e&&this.getMaterial().shaderData.setTexture("u_texture",e)},n._initGeometry=function(){var e=new ba(this._entity.engine),r=20,a=this._maxPointNum*2,s=a*r,l=new Float32Array(s),c=[new Ee("POSITION",0,ne.Vector3,0),new Ee("TEXCOORD_0",12,ne.Vector2,0)],u=new Ur(this.engine,s*4,Pt.Dynamic);e.setVertexBufferBinding(u,r),e.setVertexElements(c),e.addSubMesh(0,a,oi.TriangleStrip),this._vertexBuffer=u,this._vertexStride=r,this._vertices=l,this.mesh=e},n._updateStrapVertices=function(e,r){var a=e.viewMatrix,s=a.elements,l=new T(s[0],s[4],s[8]),c=new T(s[1],s[5],s[9]),u=new T(s[2],s[6],s[10]),h=this._stroke;c.scale(h);var d=new T,f=new T,_=new De;T.transformByQuat(l,_,l),T.transformByQuat(c,_,c);var g=new T,v=new T,p=new T;l.normalize();for(var m=this._vertices,y=0;y<this._maxPointNum;y++){if(y<this._curPointNum){var x=r[y];y===this._curPointNum-1&&y!==0?T.subtract(x,r[y-1],p):T.subtract(r[y+1],x,p),this._projectOnPlane(p,u,p),p.normalize();var S=Math.acos(T.dot(l,p));T.cross(l,p,v),T.dot(v,u)<=0&&(S=Math.PI*2-S),De.rotationAxisAngle(u,S,_),T.transformByQuat(c,_,g),T.add(x,g,d),T.subtract(x,g,f)}var w=y*2*this._vertexStride/4,b=(y*2+1)*this._vertexStride/4;m[w]=d.x,m[w+1]=d.y,m[w+2]=d.z,m[b]=f.x,m[b+1]=f.y,m[b+2]=f.z}},n._updateStrapCoords=function(){if(this._prePointsNum!==this._curPointNum){this._prePointsNum=this._curPointNum;for(var e=this._curPointNum,r=1/e,a=this._vertices,s=0;s<e;s++){var l=1-s*r,c=s*2*this._vertexStride/4,u=(s*2+1)*this._vertexStride/4;a[c]=0,a[c+1]=l,a[u]=1,a[u+1]=l}}},n._projectOnVector=function(e,r,a){var s=r.clone();T.normalize(s,s);var l=T.dot(e,s);a.x=s.x*l,a.y=s.y*l,a.z=s.z*l},n._projectOnPlane=function(e,r,a){this._projectOnVector(e,r,dc),T.subtract(e,dc,a)},o}(Ir),Ca=function(i){J(o,i);function o(t){var e;return e=i.call(this,t)||this,e._color=new oe(1,0,0,1),e.color=e._color,e}var n=o.prototype;return n._onEnable=function(){this.scene.shaderData.enableMacro("O3_HAS_FOG")},n._onDisable=function(){this.scene.shaderData.disableMacro("O3_HAS_FOG")},te(o,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this.scene.shaderData.setColor(o._colorProperty,e)}}]),o}(ar);Ca._colorProperty=F.getPropertyByName("u_fogColor");var Xh=function(i){J(o,i);function o(t){var e;return e=i.call(this,t)||this,e._density=.0025,e.density=e._density,e}var n=o.prototype;return n._onEnable=function(){this.scene.shaderData.enableMacro("O3_FOG_EXP2")},n._onDisable=function(){this.scene.shaderData.disableMacro("O3_FOG_EXP2")},te(o,[{key:"density",get:function(){return this._density},set:function(e){this._density=e,this.scene.shaderData.setFloat(o._densityProperty,e)}}]),o}(Ca);Xh._densityProperty=F.getPropertyByName("u_fogDensity");var To=function(i){J(o,i);function o(n){var t;return t=i.call(this,n)||this,t._near=1,t._far=1e3,t.near=t._near,t.far=t._far,t}return te(o,[{key:"near",get:function(){return this._near},set:function(t){this._near=t,this.scene.shaderData.setFloat(o._nearProperty,t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=t,this.scene.shaderData.setFloat(o._farProperty,t)}}]),o}(Ca);To._nearProperty=F.getPropertyByName("u_fogNear");To._farProperty=F.getPropertyByName("u_fogFar");var jh=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t.probeLayer=Ot.Everything,t.width=1024,t.height=1024,t.antiAliasing=1,t._isCube=!1,t._oriCameraRenderTarget=void 0,t._renderTarget=void 0,t._renderTargetSwap=void 0,t._activeRenderTarget=void 0,t._camera=void 0,t._oriCameraCullingMask=void 0,t}var n=o.prototype;return n.onTextureChange=function(e){},n.onBeginRender=function(e){!this.enabled||(this._camera=e,this._oriCameraCullingMask=e.cullingMask,e.cullingMask=this.probeLayer,(!this._activeRenderTarget||this._activeRenderTarget.width!==this.width||this._activeRenderTarget.height!==this.height||this._activeRenderTarget.antiAliasing!==this.antiAliasing)&&(this._renderTarget=new Bn(this.engine,this.width,this.height,this._isCube?new jt(this.engine,this.width):new Ct(this.engine,this.width,this.height),gt.Depth,this.antiAliasing),this._renderTargetSwap=new Bn(this.engine,this.width,this.height,this._isCube?new jt(this.engine,this.width):new Ct(this.engine,this.width,this.height),gt.Depth,this.antiAliasing),this._activeRenderTarget=this._renderTarget),this._oriCameraRenderTarget=e.renderTarget,e.renderTarget=this._activeRenderTarget)},n.onEndRender=function(e){!this.enabled||(this.onTextureChange&&this.onTextureChange(this._texture),this._activeRenderTarget=this._activeRenderTarget===this._renderTarget?this._renderTargetSwap:this._renderTarget)},n._reset=function(){!this.enabled||(this._camera.renderTarget=this._oriCameraRenderTarget,this._camera.cullingMask=this._oriCameraCullingMask)},te(o,[{key:"_texture",get:function(){var e;return(e=this._activeRenderTarget)===null||e===void 0?void 0:e.getColorTexture()}}]),o}(Di),_c=new T,gi=new T,mi=new T,tv=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t.position=new T(0,0,0),t._isCube=!0,t.oriViewMatrix=new ce,t._oriFieldOfView=void 0,t}var n=o.prototype;return n.onBeginRender=function(e){if(!!this.enabled){i.prototype.onBeginRender.call(this,e),this._storeCamera(e);for(var r=0;r<6;r++)this._setCamera(r,e),e.render(It.PositiveX+r);this._restoreCamera(e),i.prototype._reset.call(this)}},n._storeCamera=function(e){this.oriViewMatrix.copyFrom(e.viewMatrix),this._oriFieldOfView=e.fieldOfView},n._restoreCamera=function(e){e.viewMatrix.copyFrom(this.oriViewMatrix),e.fieldOfView=this._oriFieldOfView},n._setCamera=function(e,r){switch(e){case 0:gi.set(0,-1,0),mi.set(1,0,0);break;case 1:gi.set(0,-1,0),mi.set(-1,0,0);break;case 2:gi.set(0,0,1),mi.set(0,1,0);break;case 3:gi.set(0,0,-1),mi.set(0,-1,0);break;case 4:gi.set(0,-1,0),mi.set(0,0,1);break;case 5:gi.set(0,-1,0),mi.set(0,0,-1);break}T.add(this.position,mi,_c),ce.lookAt(this.position,_c,gi,r.viewMatrix),r.fieldOfView=90},o}(jh),mt=function(){i._updateShaderData=function(t){var e=i._combinedData;t.setFloatArray(i._viewMatFromLightProperty,e.viewMatrix),t.setFloatArray(i._projMatFromLightProperty,e.projectionMatrix),t.setFloatArray(i._shadowBiasProperty,e.bias),t.setFloatArray(i._shadowIntensityProperty,e.intensity),t.setFloatArray(i._shadowRadiusProperty,e.radius),t.setFloatArray(i._shadowMapSizeProperty,e.mapSize),t.setTextureArray(i._shadowMapsProperty,e.map)},i.clearMap=function(){i._combinedData.map.length=0};function i(n,t){t===void 0&&(t={engine:null,width:512,height:512}),this._mapSize=void 0,this._renderTarget=void 0,this.light=void 0,this.bias=.005,this.intensity=.2,this.radius=1,this.projectionMatrix=new ce,this.light=n;var e=t,r=e.engine,a=e.width,s=e.height;this._mapSize=new q(a,s),this._renderTarget=new Bn(r,a,s,new Ct(r,a,s))}var o=i.prototype;return o.initShadowProjectionMatrix=function(t){if(t instanceof mr&&ce.ortho(-5,5,-5,5,.1,50,this.projectionMatrix),t instanceof kr&&ce.perspective(H.degreeToRadian(50),1,.5,50,this.projectionMatrix),t instanceof Qt){var e=Math.min(Math.PI/2,t.angle*2*Math.sqrt(2));ce.perspective(e,1,.1,t.distance+5,this.projectionMatrix)}},o.appendData=function(t){var e=t*16,r=t*16,a=t,s=t,l=t,c=t*2,u=t,h=i._combinedData;h.viewMatrix.set(this.light.viewMatrix.elements,e),h.projectionMatrix.set(this.projectionMatrix.elements,r),h.bias[a]=this.bias,h.intensity[s]=this.intensity,h.radius[l]=this.radius,h.mapSize[c]=this.mapSize.x,h.mapSize[c+1]=this.mapSize.y,h.map[u]=this.map},te(i,[{key:"renderTarget",get:function(){return this._renderTarget}},{key:"map",get:function(){return this._renderTarget.getColorTexture()}},{key:"mapSize",get:function(){return this._mapSize}}]),i}();mt._viewMatFromLightProperty=F.getPropertyByName("u_viewMatFromLight");mt._projMatFromLightProperty=F.getPropertyByName("u_projMatFromLight");mt._shadowBiasProperty=F.getPropertyByName("u_shadowBias");mt._shadowIntensityProperty=F.getPropertyByName("u_shadowIntensity");mt._shadowRadiusProperty=F.getPropertyByName("u_shadowRadius");mt._shadowMapSizeProperty=F.getPropertyByName("u_shadowMapSize");mt._shadowMapsProperty=F.getPropertyByName("u_shadowMaps");mt._maxLight=3;mt._combinedData={viewMatrix:new Float32Array(16*mt._maxLight),projectionMatrix:new Float32Array(16*mt._maxLight),bias:new Float32Array(mt._maxLight),intensity:new Float32Array(mt._maxLight),radius:new Float32Array(mt._maxLight),mapSize:new Float32Array(2*mt._maxLight),map:[]};Object.defineProperty(wt.prototype,"enableShadow",{get:function(){return this._enableShadow},set:function(o){if(this._enableShadow=o,this._enableShadow){if(this instanceof Jt){this._enableShadow=!1,me.warn("Has no shadow!");return}this.shadow=this.shadow||new mt(this,{engine:this.engine,width:512,height:512}),this.shadow.initShadowProjectionMatrix(this)}}});Object.defineProperty(ar.prototype,"receiveShadow",{get:function(){return this._recieveShadow},set:function(o){this._recieveShadow=o}});Object.defineProperty(ar.prototype,"castShadow",{get:function(){return this._castShadow},set:function(o){this._castShadow=o}});var rv=function(i){J(o,i);function o(n){var t;return t=i.call(this,n,F.find("shadow-map"))||this,t.shaderData.enableMacro("O3_GENERATE_SHADOW_MAP"),t}return o}(pr),Ao=function(i){J(o,i);function o(t,e,r,a,s,l){var c;return c=i.call(this,t,e,r,a,s)||this,c.light=void 0,c.light=l,c.clearColor=new oe(1,1,1,1),c}var n=o.prototype;return n.preRender=function(e,r){var a=this.replaceMaterial.shaderData;a.setMatrix(o._viewMatFromLightProperty,this.light.viewMatrix),a.setMatrix(o._projMatFromLightProperty,this.light.shadow.projectionMatrix)},o}(ei);Ao._viewMatFromLightProperty=F.getPropertyByName("u_viewMatFromLight");Ao._projMatFromLightProperty=F.getPropertyByName("u_projMatFromLight");var iv=function(i){J(o,i);function o(n){var t;t=i.call(this,n,F.find("shadow"))||this;var e=t.renderState.blendState.targetBlendState;return e.enabled=!0,e.sourceColorBlendFactor=e.sourceAlphaBlendFactor=de.DestinationColor,e.destinationColorBlendFactor=e.destinationAlphaBlendFactor=de.Zero,t.renderState.depthState.compareFunction=Ne.LessEqual,t.renderQueueType=bt.Transparent,t}return o}(pr),nv=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t.clearFlags=vr.None,t}var n=o.prototype;return n.preRender=function(e,r){this.enabled=!1;var a=e.scene.findFeature(Fi),s=a.visibleLights,l=this.replaceMaterial.shaderData,c=e._renderPipeline.defaultRenderPass;this.renderTarget=c.renderTarget;var u=0;mt.clearMap();for(var h=0,d=s.length;h<d;h++){var f=s[h];f.enableShadow&&f.shadow.appendData(u++)}u?(this.enabled=!0,mt._updateShaderData(l),l.enableMacro("O3_SHADOW_MAP_COUNT",u.toString())):l.disableMacro("O3_SHADOW_MAP_COUNT")},o}(ei),av=function(i){J(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t._shadowPass=void 0,t._shadowMapMaterial=void 0,t}var n=o.prototype;return n.preRender=function(e,r){var a=e.findFeature(Fi).visibleLights;if(a.length>0){this._shadowPass||this.addShadowPass(r);for(var s=r._renderPipeline,l=0,c=a.length;l<c;l++){var u=a[l];u.enableShadow&&!u.shadowMapPass?u.shadowMapPass=this.addShadowMapPass(r,u):!u.enableShadow&&u.shadowMapPass&&(s.removeRenderPass(u.shadowMapPass),u.shadowMapPass=null)}this.updatePassRenderFlag(s._opaqueQueue),this.updatePassRenderFlag(s._alphaTestQueue),this.updatePassRenderFlag(s._transparentQueue)}},n.addShadowPass=function(e){var r=new iv(e.engine);this._shadowPass=new nv("ShadowPass",1,null,r,Ot.Layer30);var a=e._renderPipeline;a.addRenderPass(this._shadowPass)},n.addShadowMapPass=function(e,r){this._shadowMapMaterial=this._shadowMapMaterial||new rv(e.engine);var a=new Ao("ShadowMapPass",-1,r.shadow.renderTarget,this._shadowMapMaterial,Ot.Layer31,r),s=e._renderPipeline;return s.addRenderPass(a),a},n.updatePassRenderFlag=function(e){for(var r=e.items,a=0,s=r.length;a<s;a++){var l=r[a],c=l.component,u=c.recieveShadow,h=c.castShadow;u===!0?c.entity.layer|=Ot.Layer30:u===!1&&(c.entity.layer&=~Ot.Layer30),h===!0?c.entity.layer|=Ot.Layer31:h===!1&&(c.entity.layer&=~Ot.Layer31)}},o}(bo);Nr.registerFeature(av);Nr.registerFeature(Fi);Nr.prototype.hasLight=lf;var fc=Object.freeze(Object.defineProperty({__proto__:null,AmbientLight:Jt,AnimationClip:zh,AnimationClipCurveBinding:Dh,AnimationCurve:Vh,AnimationEvent:Lh,get AnimationProperty(){return xe},Animator:So,get AnimatorConditionMode(){return $a},AnimatorController:Ih,AnimatorControllerLayer:Nh,get AnimatorLayerBlendingMode(){return Dn},AnimatorState:Uh,AnimatorStateMachine:kh,AnimatorStateTransition:Oh,AssetPromise:ot,get AssetPromiseStatus(){return Ci},get AssetType(){return Xe},Background:Ph,get BackgroundMode(){return rr},get BackgroundTextureFillMode(){return Kr},BaseMaterial:ut,BasicRenderPipeline:Rh,get BlendFactor(){return de},get BlendMode(){return Qi},get BlendOperation(){return Xt},BlendShape:xo,BlendShapeFrame:Th,BlinnPhongMaterial:on,BoolUpdateFlag:nn,BoxColliderShape:Ud,Buffer:Ur,get BufferBindFlag(){return gr},BufferMesh:ba,get BufferUsage(){return Pt},BufferUtil:En,Camera:Sa,get CameraClearFlags(){return vr},CapsuleColliderShape:Gd,CharacterController:Nd,CloneManager:nr,Collider:ci,ColliderShape:an,get ColliderShapeUpAxis(){return Mn},get CollisionDetectionMode(){return aa},get ColorSpace(){return ii},get ColorWriteMask(){return fr},get CompareFunction(){return Ne},Component:ar,get ControllerCollisionFlag(){return Ha},get ControllerNonWalkableMode(){return na},CubeProbe:tv,get CullMode(){return qt},get DataType(){return et},get DiffuseMode(){return rn},DirectLight:mr,DynamicCollider:Yd,get DynamicColliderConstraints(){return Wa},EXP2Fog:Xh,Engine:yr,EngineFeature:Rf,EngineObject:Vr,Entity:Lr,Event:Ga,EventDispatcher:uh,FixedJoint:Hd,Fog:Ca,Font:sa,get FontStyle(){return ti},get GLCapabilityType(){return ae},HingeJoint:Wd,HitResult:fh,IndexBufferBinding:oa,get IndexFormat(){return nt},InputManager:gh,InterpolableKeyframe:wi,get InterpolableValueType(){return Te},get InterpolationType(){return Er},Joint:ga,JointLimits:jd,JointMotor:$d,Keyframe:Gh,get Keys(){return er},get Layer(){return Ot},Light:wt,LinearFog:To,ListenerUpdateFlag:pa,Loader:st,Logger:me,Material:pr,Mesh:mo,MeshRenderElement:bh,MeshRenderer:Ir,get MeshTopology(){return oi},ModelMesh:Wt,ObjectValues:Va,get OverflowMode(){return Bi},PBRBaseMaterial:Zt,PBRMaterial:Li,PBRSpecularMaterial:hi,ParticleRenderer:Hh,get ParticleRendererBlendMode(){return Ji},PhysicsManager:kt,PhysicsMaterial:vh,get PhysicsMaterialCombineMode(){return Pn},PlaneColliderShape:Vd,PointLight:kr,Pointer:ph,get PointerButton(){return ri},get PointerPhase(){return dr},PrimitiveMesh:vn,Probe:jh,RefObject:Gr,get RenderBufferDepthFormat(){return gt},get RenderFace(){return Mr},RenderPass:ei,RenderQueue:bi,get RenderQueueType(){return bt},RenderTarget:Bn,Renderer:Un,ResourceManager:On,Scene:Nr,SceneFeature:bo,SceneManager:Mh,Script:Di,get SetDataOptions(){return Rn},Shader:F,ShaderData:Nn,ShaderFactory:xi,Skin:Ch,SkinnedMeshRenderer:si,Sky:Ah,SkyBoxMaterial:Co,SphereColliderShape:kd,SpotLight:Qt,SpringJoint:Xd,Sprite:wo,SpriteAtlas:Fh,get SpriteDrawMode(){return Jr},SpriteElement:wh,SpriteMask:Xa,get SpriteMaskInteraction(){return tr},get SpriteMaskLayer(){return tn},SpriteRenderer:Vf,StateMachineScript:ja,StaticCollider:qd,get StencilOperation(){return _t},SubMesh:Fn,SystemInfo:Ef,get TextHorizontalAlignment(){return Pi},TextRenderer:Wf,get TextVerticalAlignment(){return Mi},Texture:Rr,Texture2D:Ct,Texture2DArray:yo,get TextureCoordinate(){return ni},TextureCube:jt,get TextureCubeFace(){return It},get TextureFilterMode(){return Ut},get TextureFormat(){return ee},get TextureWrapMode(){return Nt},Time:hh,TrailMaterial:Wh,TrailRenderer:ev,Transform:$t,UnlitMaterial:ai,Util:Zn,VertexBufferBinding:xa,VertexElement:Ee,get VertexElementFormat(){return ne},get WrapMode(){return Ln},assignmentClone:qe,deepClone:tt,dependentComponents:In,ignoreClone:re,request:pn,resourceLoader:Tt,shallowClone:ch},Symbol.toStringTag,{value:"Module"})),_e;(function(i){i[i.RGBA_ASTC_4X4_KHR=37808]="RGBA_ASTC_4X4_KHR",i[i.RGBA_ASTC_5X4_KHR=37809]="RGBA_ASTC_5X4_KHR",i[i.RGBA_ASTC_5X5_KHR=37810]="RGBA_ASTC_5X5_KHR",i[i.RGBA_ASTC_6X5_KHR=37811]="RGBA_ASTC_6X5_KHR",i[i.RGBA_ASTC_6X6_KHR=37812]="RGBA_ASTC_6X6_KHR",i[i.RGBA_ASTC_8X5_KHR=37813]="RGBA_ASTC_8X5_KHR",i[i.RGBA_ASTC_8X6_KHR=37814]="RGBA_ASTC_8X6_KHR",i[i.RGBA_ASTC_8X8_KHR=37815]="RGBA_ASTC_8X8_KHR",i[i.RGBA_ASTC_10X5_KHR=37816]="RGBA_ASTC_10X5_KHR",i[i.RGBA_ASTC_10X6_KHR=37817]="RGBA_ASTC_10X6_KHR",i[i.RGBA_ASTC_10X8_KHR=37818]="RGBA_ASTC_10X8_KHR",i[i.RGBA_ASTC_10X10_KHR=37819]="RGBA_ASTC_10X10_KHR",i[i.RGBA_ASTC_12X10_KHR=37820]="RGBA_ASTC_12X10_KHR",i[i.RGBA_ASTC_12X12_KHR=37821]="RGBA_ASTC_12X12_KHR",i[i.SRGB8_ALPHA8_ASTC_4X4_KHR=37840]="SRGB8_ALPHA8_ASTC_4X4_KHR",i[i.SRGB8_ALPHA8_ASTC_5X4_KHR=37841]="SRGB8_ALPHA8_ASTC_5X4_KHR",i[i.SRGB8_ALPHA8_ASTC_5X5_KHR=37842]="SRGB8_ALPHA8_ASTC_5X5_KHR",i[i.SRGB8_ALPHA8_ASTC_6X5_KHR=37843]="SRGB8_ALPHA8_ASTC_6X5_KHR",i[i.SRGB8_ALPHA8_ASTC_6X6_KHR=37844]="SRGB8_ALPHA8_ASTC_6X6_KHR",i[i.SRGB8_ALPHA8_ASTC_8X5_KHR=37845]="SRGB8_ALPHA8_ASTC_8X5_KHR",i[i.SRGB8_ALPHA8_ASTC_8X6_KHR=37846]="SRGB8_ALPHA8_ASTC_8X6_KHR",i[i.SRGB8_ALPHA8_ASTC_8X8_KHR=37847]="SRGB8_ALPHA8_ASTC_8X8_KHR",i[i.SRGB8_ALPHA8_ASTC_10X5_KHR=37848]="SRGB8_ALPHA8_ASTC_10X5_KHR",i[i.SRGB8_ALPHA8_ASTC_10X6_KHR=37849]="SRGB8_ALPHA8_ASTC_10X6_KHR",i[i.SRGB8_ALPHA8_ASTC_10X8_KHR=37850]="SRGB8_ALPHA8_ASTC_10X8_KHR",i[i.SRGB8_ALPHA8_ASTC_10X10_KHR=37851]="SRGB8_ALPHA8_ASTC_10X10_KHR",i[i.SRGB8_ALPHA8_ASTC_12X10_KHR=37852]="SRGB8_ALPHA8_ASTC_12X10_KHR",i[i.SRGB8_ALPHA8_ASTC_12X12_KHR=37853]="SRGB8_ALPHA8_ASTC_12X12_KHR",i[i.RGB_ETC1_WEBGL=36196]="RGB_ETC1_WEBGL",i[i.R11_EAC=37488]="R11_EAC",i[i.SIGNED_R11_EAC=37489]="SIGNED_R11_EAC",i[i.RG11_EAC=37490]="RG11_EAC",i[i.SIGNED_RG11_EAC=37491]="SIGNED_RG11_EAC",i[i.RGB8_ETC2=37492]="RGB8_ETC2",i[i.SRGB8_ETC2=37493]="SRGB8_ETC2",i[i.RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="RGB8_PUNCHTHROUGH_ALPHA1_ETC2",i[i.SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",i[i.RGBA8_ETC2_EAC=37496]="RGBA8_ETC2_EAC",i[i.SRGB8_ALPHA8_ETC2_EAC=37497]="SRGB8_ALPHA8_ETC2_EAC",i[i.RGB_PVRTC_4BPPV1_IMG=35840]="RGB_PVRTC_4BPPV1_IMG",i[i.RGB_PVRTC_2BPPV1_IMG=35841]="RGB_PVRTC_2BPPV1_IMG",i[i.RGBA_PVRTC_4BPPV1_IMG=35842]="RGBA_PVRTC_4BPPV1_IMG",i[i.RGBA_PVRTC_2BPPV1_IMG=35843]="RGBA_PVRTC_2BPPV1_IMG",i[i.RGB_S3TC_DXT1_EXT=33776]="RGB_S3TC_DXT1_EXT",i[i.RGBA_S3TC_DXT1_EXT=33777]="RGBA_S3TC_DXT1_EXT",i[i.RGBA_S3TC_DXT3_EXT=33778]="RGBA_S3TC_DXT3_EXT",i[i.RGBA_S3TC_DXT5_EXT=33779]="RGBA_S3TC_DXT5_EXT"})(_e||(_e={}));function vc(i,o){var n=Object.keys(i);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(i);o&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})),n.push.apply(n,t)}return n}function ov(i){for(var o=1;o<arguments.length;o++){var n=arguments[o]!=null?arguments[o]:{};o%2?vc(Object(n),!0).forEach(function(t){sv(i,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(n)):vc(Object(n)).forEach(function(t){Object.defineProperty(i,t,Object.getOwnPropertyDescriptor(n,t))})}return i}function pc(i,o){for(var n=0;n<o.length;n++){var t=o[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(i,t.key,t)}}function kn(i,o,n){return o&&pc(i.prototype,o),n&&pc(i,n),Object.defineProperty(i,"prototype",{writable:!1}),i}function sv(i,o,n){return o in i?Object.defineProperty(i,o,{value:n,enumerable:!0,configurable:!0,writable:!0}):i[o]=n,i}function Ta(i,o){i.prototype=Object.create(o.prototype),i.prototype.constructor=i,qa(i,o)}function qa(i,o){return qa=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},qa(i,o)}var lv=function(){var i=o.prototype;i.resizeByClientSize=function(t){t===void 0&&(t=window.devicePixelRatio);var e=this._webCanvas;(typeof OffscreenCanvas=="undefined"||!(e instanceof OffscreenCanvas))&&(this.width=e.clientWidth*t,this.height=e.clientHeight*t)};function o(n){this._webCanvas=void 0,this._width=void 0,this._height=void 0,this._scale=new q;var t=n.width,e=n.height;this._webCanvas=n,this._width=t,this._height=e}return i.setScale=function(t,e){this._scale.set(t,e),this.scale=this._scale},kn(o,[{key:"width",get:function(){return this._width},set:function(t){this._width!==t&&(this._webCanvas.width=t,this._width=t)}},{key:"height",get:function(){return this._height},set:function(t){this._height!==t&&(this._webCanvas.height=t,this._height=t)}},{key:"scale",get:function(){var t=this._webCanvas;return(typeof OffscreenCanvas=="undefined"||!(t instanceof OffscreenCanvas))&&this._scale.set(t.clientWidth*devicePixelRatio/t.width,t.clientHeight*devicePixelRatio/t.height),this._scale},set:function(t){var e=this._webCanvas;(typeof OffscreenCanvas=="undefined"||!(e instanceof OffscreenCanvas))&&(e.style.transformOrigin="left top",e.style.transform="scale("+t.x+", "+t.y+")")}}]),o}(),cv=function(){function i(n){this._maxDrawBuffers=void 0,this._maxAnisoLevel=void 0,this._maxAntiAliasing=void 0,this._rhi=void 0,this.capabilityList=void 0,this._rhi=n,this.capabilityList=new Map,this._init(),this._compatibleAllInterface()}var o=i.prototype;return o.canIUse=function(t){return this.capabilityList.get(t)},o.canIUseCompressedTextureInternalFormat=function(t){var e=_e.RGBA_ASTC_4X4_KHR,r=_e.RGBA_ASTC_12X12_KHR,a=_e.SRGB8_ALPHA8_ASTC_4X4_KHR,s=_e.SRGB8_ALPHA8_ASTC_12X12_KHR,l=_e.RGB_ETC1_WEBGL,c=_e.R11_EAC,u=_e.SRGB8_ALPHA8_ETC2_EAC,h=_e.RGB_PVRTC_4BPPV1_IMG,d=_e.RGBA_PVRTC_2BPPV1_IMG,f=_e.RGB_S3TC_DXT1_EXT,_=_e.RGBA_S3TC_DXT5_EXT;return t>=e&&r<=r||t>=a&&t<=s?this.canIUse(ae.astc):t===l?this.canIUse(ae.etc1):t>=c&&t<=u?this.canIUse(ae.etc):t>=h&&t<=d?this.canIUse(ae.pvrtc):t>=f&&t<=_?this.canIUse(ae.s3tc):!1},o._init=function(){var t=this.capabilityList,e=this.rhi.isWebGL2,r=this.rhi.requireExtension.bind(this.rhi),a=ae.shaderVertexID,s=ae.standardDerivatives,l=ae.shaderTextureLod,c=ae.elementIndexUint,u=ae.depthTexture,h=ae.vertexArrayObject,d=ae.instancedArrays,f=ae.multipleSample,_=ae.drawBuffers,g=ae.astc,v=ae.astc_webkit,p=ae.etc,m=ae.etc_webkit,y=ae.etc1,x=ae.etc1_webkit,S=ae.pvrtc,w=ae.pvrtc_webkit,b=ae.s3tc,A=ae.s3tc_webkit,E=ae.textureFloat,C=ae.textureHalfFloat,M=ae.textureFloatLinear,P=ae.textureHalfFloatLinear,R=ae.WEBGL_colorBufferFloat,B=ae.colorBufferFloat,D=ae.colorBufferHalfFloat,L=ae.textureFilterAnisotropic;t.set(a,e),t.set(s,e||!!r(s)),t.set(l,e||!!r(l)),t.set(c,e||!!r(c)),t.set(u,e||!!r(u)),t.set(h,e||!!r(h)),t.set(d,e||!!r(d)),t.set(f,e),t.set(_,e||!!r(_)),t.set(E,e||!!r(E)),t.set(C,e||!!r(C)),t.set(M,!!r(M)),t.set(P,e||!!r(P)),t.set(B,e&&!!r(B)||!!r(R)),t.set(D,e&&!!r(B)||!!r(D)),t.set(L,!!r(L)),t.set(g,!!(r(g)||r(v))),t.set(p,!!(r(p)||r(m))),t.set(y,!!(r(y)||r(x))),t.set(S,!!(r(S)||r(w))),t.set(b,!!(r(b)||r(A)))},o._compatibleInterface=function(t,e){var r=this.rhi,a=r.gl,s=null;if(s=r.requireExtension(t))for(var l in e){var c=e[l],u=s[c];u!=null&&u.bind?a[l]=u.bind(s):a[l]=u}},o._compatibleAllInterface=function(){var t=ae.depthTexture,e=ae.vertexArrayObject,r=ae.instancedArrays,a=ae.drawBuffers,s=ae.textureFilterAnisotropic,l=ae.textureHalfFloat,c=ae.colorBufferHalfFloat,u=ae.WEBGL_colorBufferFloat,h=this.rhi.isWebGL2;if(!h){this._compatibleInterface(t,{UNSIGNED_INT_24_8:"UNSIGNED_INT_24_8_WEBGL"}),this._compatibleInterface(e,{createVertexArray:"createVertexArrayOES",deleteVertexArray:"deleteVertexArrayOES",isVertexArray:"isVertexArrayOES",bindVertexArray:"bindVertexArrayOES"}),this._compatibleInterface(r,{drawArraysInstanced:"drawArraysInstancedANGLE",drawElementsInstanced:"drawElementsInstancedANGLE",vertexAttribDivisor:"vertexAttribDivisorANGLE"}),this._compatibleInterface(a,{MAX_DRAW_BUFFERS:"MAX_DRAW_BUFFERS_WEBGL"});var d={};if(this.canIUse(ae.drawBuffers)){for(var f=this.maxDrawBuffers,_=0;_<f;_++)_!=0&&(d["COLOR_ATTACHMENT"+_]="COLOR_ATTACHMENT"+_+"_WEBGL"),d["DRAW_BUFFER"+_]="DRAW_BUFFER"+_+"_WEBGL";this._compatibleInterface(a,ov({drawBuffers:"drawBuffersWEBGL"},d))}this._compatibleInterface(l,{HAFL_FLOAT:"HALF_FLOAT_OES"}),this._compatibleInterface(c,{RGBA16F:"RBGA16F_EXT"}),this._compatibleInterface(u,{RGBA32F:"RBGA32F_EXT"})}this._compatibleInterface(s,{TEXTURE_MAX_ANISOTROPY_EXT:"TEXTURE_MAX_ANISOTROPY_EXT"})},kn(i,[{key:"maxTextureSize",get:function(){return this.rhi.renderStates.getParameter(this.rhi.gl.MAX_TEXTURE_SIZE)}},{key:"canUseFloatTextureBlendShape",get:function(){return this.canIUse(ae.shaderVertexID)&&this.canIUse(ae.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"canIUseMoreJoints",get:function(){return this.canIUse(ae.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"maxDrawBuffers",get:function(){return this._maxDrawBuffers||(this.canIUse(ae.drawBuffers)?this._maxDrawBuffers=this._rhi.gl.getParameter(this._rhi.gl.MAX_DRAW_BUFFERS):this._maxDrawBuffers=1),this._maxDrawBuffers}},{key:"maxAnisoLevel",get:function(){if(!this._maxAnisoLevel){var t=this._rhi.requireExtension(ae.textureFilterAnisotropic);this._maxAnisoLevel=t?this._rhi.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1}return this._maxAnisoLevel}},{key:"maxAntiAliasing",get:function(){if(!this._maxAntiAliasing){var t=this._rhi.gl,e=this.canIUse(ae.multipleSample);this._maxAntiAliasing=e?t.getParameter(t.MAX_SAMPLES):1}return this._maxAntiAliasing}},{key:"rhi",get:function(){return this._rhi}}]),i}(),uv=function(){function i(n){this.rhi=void 0,this._requireResult=void 0,this.rhi=n,this._requireResult={}}var o=i.prototype;return o.requireExtension=function(t){return this._requireResult[t]!==void 0?this._requireResult[t]:(this._requireResult[t]=this.rhi.gl.getExtension(t),this._requireResult[t])},i}(),hv=function(){function i(n,t){this.attribLocArray=[],this._primitive=void 0,this.canUseInstancedArrays=void 0,this.gl=void 0,this.vao=new Map,this._useVao=void 0,this._primitive=t,this.canUseInstancedArrays=n.canIUse(ae.instancedArrays),this._useVao=n.canIUse(ae.vertexArrayObject),this.gl=n.gl}var o=i.prototype;return o.draw=function(t,e){var r=this.gl,a=this._primitive,s=this._useVao&&a._enableVAO;if(s){this.vao.has(t.id)||this.registerVAO(t);var l=this.vao.get(t.id);r.bindVertexArray(l)}else this.bindBufferAndAttrib(t);var c=a._indexBufferBinding,u=a._instanceCount,h=a._glIndexType,d=a._glIndexByteCount,f=e.topology,_=e.start,g=e.count;if(u)if(this.canUseInstancedArrays)if(c)if(this._useVao)r.drawElementsInstanced(f,g,h,_*d,u);else{var p=c.buffer._nativeBuffer;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,p),r.drawElementsInstanced(f,g,h,_*d,u),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}else r.drawArraysInstanced(f,_,g,u);else me.error("ANGLE_instanced_arrays extension is not supported");else if(c)if(s)r.drawElements(f,g,h,_*d);else{var v=c.buffer._nativeBuffer;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,v),r.drawElements(f,g,h,_*d),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}else r.drawArrays(f,_,g);this._useVao?r.bindVertexArray(null):this.disableAttrib()},o.destroy=function(){if(this._useVao){var t=this.gl;this.vao.forEach(function(e){t.deleteVertexArray(e)}),this.vao.clear()}},o.bindBufferAndAttrib=function(t){var e=this.gl,r=this._primitive,a=r._vertexBufferBindings;this.attribLocArray.length=0;var s=t.attributeLocation,l=r._vertexElementMap,c,u;for(var h in s){var d=s[h];if(d!==-1){var f=l[h];if(f){var _=a[f.bindingIndex],g=_.buffer,v=_.stride;c=g._nativeBuffer,u!==c&&(u=c,e.bindBuffer(e.ARRAY_BUFFER,c)),e.enableVertexAttribArray(d);var p=f._glElementInfo;e.vertexAttribPointer(d,p.size,p.type,p.normalized,v,f.offset),this.canUseInstancedArrays&&e.vertexAttribDivisor(d,f.instanceStepRate),this.attribLocArray.push(d)}else me.warn("vertex attribute not found: "+h)}}e.bindBuffer(e.ARRAY_BUFFER,null)},o.disableAttrib=function(){for(var t=this.gl,e=0,r=this.attribLocArray.length;e<r;e++)t.disableVertexAttribArray(this.attribLocArray[e])},o.registerVAO=function(t){var e=this.gl,r=e.createVertexArray();e.bindVertexArray(r);var a=this._primitive._indexBufferBinding;a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.buffer._nativeBuffer),this.bindBufferAndAttrib(t),e.bindVertexArray(null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),this.disableAttrib(),this.vao.set(t.id,r)},i}(),dv=function(){function i(n){this._gl=void 0,this._parameters={},this._gl=n,this._parameters={},this._parameters[n.MAX_COMBINED_TEXTURE_IMAGE_UNITS]=n.getParameter(n.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this._parameters[n.MAX_VERTEX_UNIFORM_VECTORS]=n.getParameter(n.MAX_VERTEX_UNIFORM_VECTORS),this._parameters[n.MAX_VERTEX_ATTRIBS]=n.getParameter(n.MAX_VERTEX_ATTRIBS),this._parameters[n.MAX_VERTEX_TEXTURE_IMAGE_UNITS]=n.getParameter(n.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._parameters[n.MAX_TEXTURE_SIZE]=n.getParameter(n.MAX_TEXTURE_SIZE),n.blendFuncSeparate(n.ONE,n.ZERO,n.ONE,n.ZERO),n.blendEquationSeparate(n.FUNC_ADD,n.FUNC_ADD),n.colorMask(!0,!0,!0,!0),n.blendColor(0,0,0,0),n.disable(n.SAMPLE_ALPHA_TO_COVERAGE),n.enable(n.DEPTH_TEST),n.depthFunc(n.LESS),n.depthMask(!0),n.disable(n.STENCIL_TEST),n.stencilFuncSeparate(n.FRONT,n.ALWAYS,0,255),n.stencilFuncSeparate(n.BACK,n.ALWAYS,0,255),n.stencilOpSeparate(n.FRONT,n.KEEP,n.KEEP,n.KEEP),n.stencilOpSeparate(n.BACK,n.KEEP,n.KEEP,n.KEEP),n.stencilMask(255),n.enable(n.CULL_FACE),n.cullFace(n.BACK),n.disable(n.POLYGON_OFFSET_FILL),n.polygonOffset(0,0)}var o=i.prototype;return o.getParameter=function(t){return this._parameters[t]},i}(),St=function(){i._isPowerOf2=function(t){return(t&t-1)===0},i._getFormatDetail=function(t,e,r){switch(t){case ee.R8G8B8:return{internalFormat:r?e.RGB8:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case ee.R8G8B8A8:return{internalFormat:r?e.RGBA8:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case ee.R4G4B4A4:return{internalFormat:r?e.RGBA4:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case ee.R5G5B5A1:return{internalFormat:r?e.RGB5_A1:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case ee.R5G6B5:return{internalFormat:r?e.RGB565:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case ee.Alpha8:return{internalFormat:e.ALPHA,baseFormat:e.ALPHA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case ee.LuminanceAlpha:return{internalFormat:e.LUMINANCE_ALPHA,baseFormat:e.LUMINANCE_ALPHA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case ee.R16G16B16A16:return{internalFormat:e.RGBA16F,baseFormat:e.RGBA,dataType:e.HALF_FLOAT,isCompressed:!1};case ee.R32G32B32A32:return{internalFormat:e.RGBA32F,baseFormat:e.RGBA,dataType:e.FLOAT,isCompressed:!1};case ee.DXT1:return{internalFormat:_e.RGB_S3TC_DXT1_EXT,isCompressed:!0};case ee.DXT5:return{internalFormat:_e.RGBA_S3TC_DXT5_EXT,isCompressed:!0};case ee.ETC1_RGB:return{internalFormat:_e.RGB_ETC1_WEBGL,isCompressed:!0};case ee.ETC2_RGB:return{internalFormat:_e.RGB8_ETC2,isCompressed:!0};case ee.ETC2_RGBA5:return{internalFormat:_e.RGB8_PUNCHTHROUGH_ALPHA1_ETC2,isCompressed:!0};case ee.ETC2_RGBA8:return{internalFormat:_e.RGBA8_ETC2_EAC,isCompressed:!0};case ee.PVRTC_RGB2:return{internalFormat:_e.RGB_PVRTC_2BPPV1_IMG,isCompressed:!0};case ee.PVRTC_RGBA2:return{internalFormat:_e.RGBA_PVRTC_2BPPV1_IMG,isCompressed:!0};case ee.PVRTC_RGB4:return{internalFormat:_e.RGB_PVRTC_4BPPV1_IMG,isCompressed:!0};case ee.PVRTC_RGBA4:return{internalFormat:_e.RGBA_PVRTC_4BPPV1_IMG,isCompressed:!0};case ee.ASTC_4x4:return{internalFormat:_e.RGBA_ASTC_4X4_KHR,isCompressed:!0};case ee.ASTC_5x5:return{internalFormat:_e.RGBA_ASTC_5X5_KHR,isCompressed:!0};case ee.ASTC_6x6:return{internalFormat:_e.RGBA_ASTC_6X6_KHR,isCompressed:!0};case ee.ASTC_8x8:return{internalFormat:_e.RGBA_ASTC_8X8_KHR,isCompressed:!0};case ee.ASTC_10x10:return{internalFormat:_e.RGBA_ASTC_10X10_KHR,isCompressed:!0};case ee.ASTC_12x12:return{internalFormat:_e.RGBA_ASTC_12X12_KHR,isCompressed:!0};default:throw new Error("this TextureFormat is not supported in Oasis Engine: "+t)}},i._getRenderBufferDepthFormatDetail=function(t,e,r){switch(t){case ee.Depth:case gt.Depth:return{internalFormat:r?e.DEPTH_COMPONENT32F:e.DEPTH_COMPONENT16,baseFormat:e.DEPTH_COMPONENT,dataType:r?e.FLOAT:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case ee.DepthStencil:case gt.DepthStencil:return{internalFormat:r?e.DEPTH24_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case ee.Stencil:case gt.Stencil:return{internalFormat:e.STENCIL_INDEX8,baseFormat:e.STENCIL_ATTACHMENT,dataType:e.UNSIGNED_BYTE,isCompressed:!1,attachment:e.STENCIL_ATTACHMENT};case ee.Depth16:case gt.Depth16:return{internalFormat:e.DEPTH_COMPONENT16,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case ee.Depth24:case gt.Depth24:return{internalFormat:e.DEPTH_COMPONENT24,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case ee.Depth32:case gt.Depth32:return{internalFormat:e.DEPTH_COMPONENT32F,baseFormat:e.DEPTH_COMPONENT,dataType:e.FLOAT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case ee.Depth24Stencil8:case gt.Depth24Stencil8:return{internalFormat:r?e.DEPTH24_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case ee.Depth32Stencil8:case gt.Depth32Stencil8:return{internalFormat:e.DEPTH32F_STENCIL8,baseFormat:e.DEPTH_STENCIL,dataType:e.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this TextureFormat is not supported in Oasis Engine: "+t)}},i._supportTextureFormat=function(t,e){var r=!0;switch(t){case ee.R16G16B16A16:e.canIUse(ae.textureHalfFloat)||(r=!1);break;case ee.R32G32B32A32:e.canIUse(ae.textureFloat)||(r=!1);break}return r},i._supportRenderBufferColorFormat=function(t,e){var r=!0;switch(t){case ee.R16G16B16A16:(!e.canIUse(ae.colorBufferHalfFloat)||!e.canIUse(ae.textureHalfFloat))&&(r=!1);break;case ee.R32G32B32A32:(!e.canIUse(ae.colorBufferFloat)||!e.canIUse(ae.textureFloat))&&(r=!1);break}return r},i._supportRenderBufferDepthFormat=function(t,e,r){var a=e.isWebGL2,s=!0;if(r&&!e.canIUse(ae.depthTexture))return!1;switch(t){case gt.Stencil:case ee.Stencil:s=!1;break;case ee.Depth24:case ee.Depth32:case ee.Depth32Stencil8:case gt.Depth24:case gt.Depth32:case gt.Depth32Stencil8:a||(s=!1);break}return s};function i(n,t,e){this._texture=void 0,this._glTexture=void 0,this._rhi=void 0,this._gl=void 0,this._isWebGL2=void 0,this._target=void 0,this._formatDetail=void 0,this._texture=t,this._rhi=n,this._gl=n.gl,this._isWebGL2=n.isWebGL2,this._target=e,this._glTexture=this._gl.createTexture()}var o=i.prototype;return o.destroy=function(){this._gl.deleteTexture(this._glTexture),this._texture=null,this._glTexture=null,this._formatDetail=null},o.generateMipmaps=function(){this._bind(),this._gl.generateMipmap(this._target)},o._bind=function(){this._rhi.bindTexture(this)},o._initMipmap=function(t){var e=this._gl,r=this._isWebGL2,a=this._formatDetail,s=a.internalFormat,l=a.baseFormat,c=a.dataType,u=this._texture,h=u.mipmapCount,d=u.width,f=u.height;if(this._bind(),r&&!(l===e.LUMINANCE_ALPHA||l===e.ALPHA))e.texStorage2D(this._target,h,s,d,f);else if(l!==s&&(s=l),t)for(var p=0;p<h;p++)for(var m=Math.max(1,d>>p),y=0;y<6;y++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+y,p,s,m,m,0,l,c,null);else for(var _=0;_<h;_++){var g=Math.max(1,d>>_),v=Math.max(1,f>>_);e.texImage2D(this._target,_,s,g,v,0,l,c,null)}},o._getPixelBuffer=function(t,e,r,a,s,l,c){var u=this._gl,h=this._formatDetail,d=h.baseFormat,f=h.dataType;u.bindFramebuffer(u.FRAMEBUFFER,this._getReadFrameBuffer()),l>0&&!this._isWebGL2&&(l=0,me.error("mipLevel only take effect in WebGL2.0")),t!=null?u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_CUBE_MAP_POSITIVE_X+t,this._glTexture,l):u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,this._glTexture,l),u.readPixels(e,r,a,s,d,f,c),u.bindFramebuffer(u.FRAMEBUFFER,null)},o._setWrapMode=function(t,e){var r=this._gl,a=this._isWebGL2,s=this._target,l=this._texture,c=l.width,u=l.height;switch(!a&&t!==Nt.Clamp&&(!i._isPowerOf2(c)||!i._isPowerOf2(u))&&(me.warn("non-power-2 texture is not supported for REPEAT or MIRRORED_REPEAT in WebGL1,and has automatically downgraded to CLAMP_TO_EDGE"),t=Nt.Clamp),t){case Nt.Clamp:r.texParameteri(s,e,r.CLAMP_TO_EDGE);break;case Nt.Repeat:r.texParameteri(s,e,r.REPEAT);break;case Nt.Mirror:r.texParameteri(s,e,r.MIRRORED_REPEAT);break}},o._getReadFrameBuffer=function(){var t=this._rhi._readFrameBuffer;return t||(this._rhi._readFrameBuffer=t=this._gl.createFramebuffer()),t},kn(i,[{key:"wrapModeU",set:function(t){this._bind(),this._setWrapMode(t,this._gl.TEXTURE_WRAP_S)}},{key:"wrapModeV",set:function(t){this._bind(),this._setWrapMode(t,this._gl.TEXTURE_WRAP_T)}},{key:"filterMode",set:function(t){var e=this._gl,r=this._target,a=this._texture._mipmap;switch(this._bind(),t){case Ut.Point:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(r,e.TEXTURE_MIN_FILTER,a?e.NEAREST_MIPMAP_NEAREST:e.NEAREST);break;case Ut.Bilinear:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(r,e.TEXTURE_MIN_FILTER,a?e.LINEAR_MIPMAP_NEAREST:e.LINEAR);break;case Ut.Trilinear:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(r,e.TEXTURE_MIN_FILTER,a?e.LINEAR_MIPMAP_LINEAR:e.LINEAR);break}}},{key:"anisoLevel",set:function(t){var e=this._gl;this._bind(),e.texParameterf(this._target,e.TEXTURE_MAX_ANISOTROPY_EXT,t)}}]),i}(),_v=function(){function i(n,t){this._gl=void 0,this._isWebGL2=void 0,this._target=void 0,this._frameBuffer=void 0,this._MSAAFrameBuffer=void 0,this._depthRenderBuffer=void 0,this._MSAAColorRenderBuffers=[],this._MSAADepthRenderBuffer=void 0,this._oriDrawBuffers=void 0,this._blitDrawBuffers=void 0,this._curMipLevel=0,this._gl=n.gl,this._isWebGL2=n.isWebGL2,this._target=t;for(var e=t._colorTextures,r=t._depth,a=t.width,s=t.height,l=r instanceof Rr,c=0,u=e.length;c<u;c++){var h=e[c]._format;if(!St._supportRenderBufferColorFormat(h,n))throw new Error("TextureFormat is not supported:"+ee[h]+" in RenderTarget")}if(!St._supportRenderBufferDepthFormat(l?r.format:r,n,l))throw new Error("TextureFormat is not supported:"+ee[r]+" in RenderTarget");if(e.length>1&&!n.canIUse(ae.drawBuffers))throw new Error("MRT is not supported");if(e.some(function(f){return f.width!==a||f.height!==s}))throw new Error("ColorTexture's size must as same as RenderTarget");if(l&&(r.width!==a||r.height!==s))throw new Error("DepthTexture's size must as same as RenderTarget");if(e.length>1&&e.some(function(f){return f instanceof jt}))throw new Error("MRT+Cube+[,MSAA] is not supported");var d=n.capability.maxAntiAliasing;t.antiAliasing>d&&(me.warn("MSAA antiAliasing exceeds the limit and is automatically downgraded to:"+d),t._antiAliasing=d),this._frameBuffer=this._gl.createFramebuffer(),this._bindMainFBO(),t.antiAliasing>1&&(this._MSAAFrameBuffer=this._gl.createFramebuffer(),this._bindMSAAFBO())}var o=i.prototype;return o.setRenderTargetInfo=function(t,e){var r=this._gl,a=this._target,s=a.depthTexture,l=a.getColorTexture(0),c=e!==this._curMipLevel;if(r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),l){var u=l instanceof jt;(c||u)&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,u?r.TEXTURE_CUBE_MAP_POSITIVE_X+t:r.TEXTURE_2D,l._platformTexture._glTexture,e)}if(s){var h=s instanceof jt;if(c||h){var d=s._platformTexture;r.framebufferTexture2D(r.FRAMEBUFFER,d._formatDetail.attachment,h?r.TEXTURE_CUBE_MAP_POSITIVE_X+t:r.TEXTURE_2D,d._glTexture,e)}}else if(c){var f=St._getRenderBufferDepthFormatDetail(a._depth,r,this._isWebGL2),_=f.internalFormat;r.bindRenderbuffer(r.RENDERBUFFER,this._depthRenderBuffer),r.renderbufferStorage(r.RENDERBUFFER,_,a.width>>e,a.height>>e)}this._curMipLevel=e,this._activeRenderTarget()},o.blitRenderTarget=function(){if(!!this._MSAAFrameBuffer){var t=this._gl,e=t.COLOR_BUFFER_BIT|(this._target.depthTexture?t.DEPTH_BUFFER_BIT:0),r=this._target,a=r.colorTextureCount,s=r.width,l=r.height;t.bindFramebuffer(t.READ_FRAMEBUFFER,this._MSAAFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this._frameBuffer);for(var c=0;c<a;c++){var u=t.COLOR_ATTACHMENT0+c;this._blitDrawBuffers[c]=u,t.readBuffer(u),t.drawBuffers(this._blitDrawBuffers),t.blitFramebuffer(0,0,s,l,0,0,s,l,e,t.NEAREST),this._blitDrawBuffers[c]=t.NONE}t.bindFramebuffer(t.FRAMEBUFFER,null)}},o.destroy=function(){var t=this._gl;this._frameBuffer&&t.deleteFramebuffer(this._frameBuffer),this._depthRenderBuffer&&t.deleteRenderbuffer(this._depthRenderBuffer),this._MSAAFrameBuffer&&t.deleteFramebuffer(this._MSAAFrameBuffer),this._MSAADepthRenderBuffer&&t.deleteRenderbuffer(this._MSAADepthRenderBuffer);for(var e=0;e<this._MSAAColorRenderBuffers.length;e++)t.deleteRenderbuffer(this._MSAAColorRenderBuffers[e]);this._frameBuffer=null,this._depthRenderBuffer=null,this._MSAAFrameBuffer=null,this._MSAAColorRenderBuffers.length=0,this._MSAADepthRenderBuffer=null},o._activeRenderTarget=function(){var t=this._gl;this._MSAAFrameBuffer?t.bindFramebuffer(t.FRAMEBUFFER,this._MSAAFrameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer)},o._bindMainFBO=function(){var t=this._gl,e=this._isWebGL2,r=this._target,a=r._depth,s=r.colorTextureCount,l=r.width,c=r.height,u=new Array(s);t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer);for(var h=0;h<s;h++){var d=this._target.getColorTexture(h),f=t.COLOR_ATTACHMENT0+h;u[h]=f,d instanceof jt||t.framebufferTexture2D(t.FRAMEBUFFER,f,t.TEXTURE_2D,d._platformTexture._glTexture,0)}if(s>1&&t.drawBuffers(u),this._oriDrawBuffers=u,a!==null){if(a instanceof Rr)a instanceof jt||t.framebufferTexture2D(t.FRAMEBUFFER,a._platformTexture._formatDetail.attachment,t.TEXTURE_2D,a._platformTexture._glTexture,0);else if(this._target.antiAliasing<=1){var _=St._getRenderBufferDepthFormatDetail(a,t,e),g=_.internalFormat,v=_.attachment,p=t.createRenderbuffer();this._depthRenderBuffer=p,t.bindRenderbuffer(t.RENDERBUFFER,p),t.renderbufferStorage(t.RENDERBUFFER,g,l,c),t.framebufferRenderbuffer(t.FRAMEBUFFER,v,t.RENDERBUFFER,p)}}t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},o._bindMSAAFBO=function(){var t=this._gl,e=this._isWebGL2,r=t.createRenderbuffer(),a=this._target,s=a._depth,l=a.colorTextureCount,c=a.antiAliasing,u=a.width,h=a.height;this._blitDrawBuffers=new Array(l),this._MSAADepthRenderBuffer=r,t.bindFramebuffer(t.FRAMEBUFFER,this._MSAAFrameBuffer);for(var d=0;d<l;d++){var f=t.createRenderbuffer();this._MSAAColorRenderBuffers[d]=f,this._blitDrawBuffers[d]=t.NONE,t.bindRenderbuffer(t.RENDERBUFFER,f),t.renderbufferStorageMultisample(t.RENDERBUFFER,c,this._target.getColorTexture(d)._platformTexture._formatDetail.internalFormat,u,h),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+d,t.RENDERBUFFER,f)}if(t.drawBuffers(this._oriDrawBuffers),s!==null){var _=s instanceof Rr?s._platformTexture._formatDetail:St._getRenderBufferDepthFormatDetail(s,t,e),g=_.internalFormat,v=_.attachment;t.bindRenderbuffer(t.RENDERBUFFER,r),t.renderbufferStorageMultisample(t.RENDERBUFFER,c,g,u,h),t.framebufferRenderbuffer(t.FRAMEBUFFER,v,t.RENDERBUFFER,r)}this._checkFrameBuffer(),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},o._checkFrameBuffer=function(){var t=this._gl,e=this._isWebGL2,r=t.checkFramebufferStatus(t.FRAMEBUFFER);switch(r){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete");case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment");case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error(" Height and width of the attachment are not the same.");case t.FRAMEBUFFER_UNSUPPORTED:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer")}if(e&&r===t.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE)throw new Error("The values of gl.RENDERBUFFER_SAMPLES are different among attached renderbuffers, or are non-zero if the attached images are a mix of renderbuffers and textures.")},i}(),fv=function(i){Ta(o,i);function o(t,e){var r;r=i.call(this,t,e,t.gl.TEXTURE_2D)||this,r._compressedMipFilled=0;var a=e.format,s=e._mipmap,l=e.width,c=e.height,u=r._isWebGL2;if(!St._supportTextureFormat(a,t))throw new Error("Texture format is not supported:"+ee[a]);return s&&!u&&(!St._isPowerOf2(l)||!St._isPowerOf2(c))&&(me.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),e._mipmap=!1,e._mipmapCount=e._getMipmapCount()),r._formatDetail=St._getFormatDetail(a,r._gl,u),r._formatDetail.isCompressed&&!u||r._initMipmap(!1),r}var n=o.prototype;return n.setPixelBuffer=function(e,r,a,s,l,c){r===void 0&&(r=0);var u=this._gl,h=this._isWebGL2,d=this._formatDetail,f=d.internalFormat,_=d.baseFormat,g=d.dataType,v=d.isCompressed,p=Math.max(1,this._texture.width>>r),m=Math.max(1,this._texture.height>>r);if(l=l||p-a,c=c||m-s,this._bind(),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,0),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),v){var y=1<<r;h||this._compressedMipFilled&y?u.compressedTexSubImage2D(this._target,r,a,s,l,c,f,e):(u.compressedTexImage2D(this._target,r,f,l,c,0,e),this._compressedMipFilled|=y)}else u.texSubImage2D(this._target,r,a,s,l,c,_,g,e)},n.setImageSource=function(e,r,a,s,l,c){var u=this._gl,h=this._formatDetail,d=h.baseFormat,f=h.dataType;this._bind(),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,+a),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+s),u.texSubImage2D(this._target,r,l||0,c||0,d,f,e)},n.getPixelBuffer=function(e,r,a,s,l,c){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");i.prototype._getPixelBuffer.call(this,null,e,r,a,s,l,c)},o}(St),vv=function(i){Ta(o,i);function o(t,e){var r;r=i.call(this,t,e,t.gl.TEXTURE_2D_ARRAY)||this;var a=e.format,s=e.width,l=e.height,c=e.length,u=e.mipmapCount;if(!r._isWebGL2)throw new Error("Texture2D Array is not supported in WebGL1.0");if(!St._supportTextureFormat(a,t))throw new Error("Texture format is not supported:"+ee[a]);return r._bind(),r._formatDetail=St._getFormatDetail(a,r._gl,!0),r._gl.texStorage3D(r._target,u,r._formatDetail.internalFormat,s,l,c),r}var n=o.prototype;return n.setPixelBuffer=function(e,r,a,s,l,c,u,h){var d=this._target,f=this._gl,_=this._formatDetail,g=_.internalFormat,v=_.baseFormat,p=_.dataType,m=_.isCompressed;c=c||Math.max(1,this._texture.width>>a)-s,u=u||Math.max(1,this._texture.height>>a)-l,h=h||this._texture.length,this._bind(),f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,0),f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),m?f.compressedTexSubImage3D(d,a,s,l,e,c,u,h,g,r):f.texSubImage3D(d,a,s,l,e,c,u,h,v,p,r)},n.setImageSource=function(e,r,a,s,l,c,u){var h=this._gl,d=this._formatDetail,f=d.baseFormat,_=d.dataType;this._bind(),h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,+s),h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+l),h.texSubImage3D(this._target,a,c,u,e,r.width,r.height,1,f,_,r)},n.getPixelBuffer=function(e,r,a,s,l,c,u){var h=this._gl,d=this._formatDetail;if(d.isCompressed)throw new Error("Unable to read compressed texture");h.bindFramebuffer(h.FRAMEBUFFER,this._getReadFrameBuffer()),h.framebufferTextureLayer(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,this._glTexture,c,e),h.readPixels(r,a,s,l,d.baseFormat,d.dataType,u),h.bindFramebuffer(h.FRAMEBUFFER,null)},o}(St),pv=function(i){Ta(o,i);function o(t,e){var r;r=i.call(this,t,e,t.gl.TEXTURE_CUBE_MAP)||this,r._compressedFaceFilled=[0,0,0,0,0,0];var a=e.format,s=e._mipmap,l=e.width,c=r._isWebGL2;if(!St._supportTextureFormat(a,t))throw new Error("Texture format is not supported:"+ee[a]);return s&&!c&&!St._isPowerOf2(l)&&(me.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),e._mipmap=!1,e._mipmapCount=e._getMipmapCount()),r._formatDetail=St._getFormatDetail(a,r._gl,c),r._formatDetail.isCompressed&&!c||r._initMipmap(!0),r}var n=o.prototype;return n.setPixelBuffer=function(e,r,a,s,l,c,u){var h=this._gl,d=this._isWebGL2,f=this._formatDetail,_=f.internalFormat,g=f.baseFormat,v=f.dataType,p=f.isCompressed,m=Math.max(1,this._texture.width>>a);if(c=c||m-s,u=u||m-l,this._bind(),h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,0),h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),p){var y=1<<a;d||this._compressedFaceFilled[e]&y?h.compressedTexSubImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+e,a,s,l,c,u,_,r):(h.compressedTexImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+e,a,_,c,u,0,r),this._compressedFaceFilled[e]|=y)}else h.texSubImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+e,a,s,l,c,u,g,v,r)},n.setImageSource=function(e,r,a,s,l,c,u){var h=this._gl,d=this._formatDetail,f=d.baseFormat,_=d.dataType;this._bind(),h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,+s),h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+l),h.texSubImage2D(h.TEXTURE_CUBE_MAP_POSITIVE_X+e,a,c||0,u||0,f,_,r)},n.getPixelBuffer=function(e,r,a,s,l,c,u){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");i.prototype._getPixelBuffer.call(this,e,r,a,s,l,c,u)},o}(St),Si;(function(i){i[i.Auto=0]="Auto",i[i.WebGL2=1]="WebGL2",i[i.WebGL1=2]="WebGL1"})(Si||(Si={}));var gv=function(){function i(n){n===void 0&&(n={}),this._readFrameBuffer=void 0,this._currentBind=void 0,this._options=void 0,this._gl=void 0,this._renderStates=void 0,this._extensions=void 0,this._capability=void 0,this._isWebGL2=void 0,this._webCanvas=void 0,this._activeTextureID=void 0,this._activeTextures=new Array(32),this._lastViewport=new Ve(null,null,null,null),this._lastClearColor=new oe(null,null,null,null),this._scissorEnable=!1,this._options=n}var o=i.prototype;return o.init=function(t){var e=this._options;e.alpha===void 0&&(e.alpha=!1),e.stencil===void 0&&(e.stencil=!0);var r=this._webCanvas=t._webCanvas,a=e.webGLMode||Si.Auto,s;if((a==Si.Auto||a==Si.WebGL2)&&(s=r.getContext("webgl2",e),!s&&(typeof OffscreenCanvas=="undefined"||!(r instanceof OffscreenCanvas))&&(s=r.getContext("experimental-webgl2",e)),this._isWebGL2=!0,s&&!s.deleteQuery&&(this._isWebGL2=!1)),s||(a==Si.Auto||a==Si.WebGL1)&&(s=r.getContext("webgl",e),!s&&(typeof OffscreenCanvas=="undefined"||!(r instanceof OffscreenCanvas))&&(s=r.getContext("experimental-webgl",e)),this._isWebGL2=!1),!s)throw new Error("Get GL Context FAILED.");this._gl=s,this._activeTextureID=s.TEXTURE0,this._renderStates=new dv(s),this._extensions=new uv(this),this._capability=new cv(this),s.activeTexture(s.TEXTURE0),this._options=null},o.createPlatformPrimitive=function(t){return new hv(this,t)},o.createPlatformTexture2D=function(t){return new fv(this,t)},o.createPlatformTexture2DArray=function(t){return new vv(this,t)},o.createPlatformTextureCube=function(t){return new pv(this,t)},o.createPlatformRenderTarget=function(t){return new _v(this,t)},o.requireExtension=function(t){return this._extensions.requireExtension(t)},o.canIUse=function(t){return this.capability.canIUse(t)},o.canIUseCompressedTextureInternalFormat=function(t){return this.capability.canIUseCompressedTextureInternalFormat(t)},o.viewport=function(t,e,r,a){var s=this._gl,l=this._lastViewport;if(t!==l.x||e!==l.y||r!==l.z||a!==l.w){var c=this._webCanvas;t===0&&e===0&&r===c.width&&a===c.height?this._scissorEnable&&(s.disable(s.SCISSOR_TEST),this._scissorEnable=!1):(this._scissorEnable||(s.enable(s.SCISSOR_TEST),this._scissorEnable=!0),s.scissor(t,e,r,a)),s.viewport(t,e,r,a),l.set(t,e,r,a)}},o.colorMask=function(t,e,r,a){this._gl.colorMask(t,e,r,a)},o.clearRenderTarget=function(t,e,r){var a=this._gl,s=t._lastRenderState,l=s.blendState.targetBlendState,c=s.depthState,u=s.stencilState,h=0;if(e&vr.Color){h|=a.COLOR_BUFFER_BIT;var d=this._lastClearColor,f=r.r,_=r.g,g=r.b,v=r.a;r&&(f!==d.r||_!==d.g||g!==d.b||v!==d.a)&&(a.clearColor(f,_,g,v),d.set(f,_,g,v)),l.colorWriteMask!==fr.All&&(a.colorMask(!0,!0,!0,!0),l.colorWriteMask=fr.All)}e&vr.Depth&&(h|=a.DEPTH_BUFFER_BIT,c.writeEnabled!==!0&&(a.depthMask(!0),c.writeEnabled=!0)),e&vr.Stencil&&(h|=a.STENCIL_BUFFER_BIT,u.writeMask!==255&&(a.stencilMask(255),u.writeMask=255)),a.clear(h)},o.drawPrimitive=function(t,e,r){t?t._draw(r,e):me.error("draw primitive failed.")},o.activeRenderTarget=function(t,e,r){var a=this._gl;if(t){var s;(s=t._platformRenderTarget)===null||s===void 0||s._activeRenderTarget();var l=t.width,c=t.height;this.viewport(0,0,l>>r,c>>r)}else{a.bindFramebuffer(a.FRAMEBUFFER,null);var u=e.viewport,h=a.drawingBufferWidth,d=a.drawingBufferHeight,f=h*u.z,_=d*u.w,g=u.x*h,v=d-u.y*d-_;this.viewport(g,v,f,_)}},o.destroy=function(){},o.activeTexture=function(t){this._activeTextureID!==t&&(this._gl.activeTexture(t),this._activeTextureID=t)},o.bindTexture=function(t){var e=this._activeTextureID-this._gl.TEXTURE0;this._activeTextures[e]!==t&&(this._gl.bindTexture(t._target,t._glTexture),this._activeTextures[e]=t)},kn(i,[{key:"isWebGL2",get:function(){return this._isWebGL2}},{key:"gl",get:function(){return this._gl}},{key:"renderStates",get:function(){return this._renderStates}},{key:"capability",get:function(){return this._capability}},{key:"canIUseMoreJoints",get:function(){return this.capability.canIUseMoreJoints}}]),i}(),mv=function(i){Ta(o,i);function o(n,t){var e=new lv(typeof n=="string"?document.getElementById(n):n),r=new gv(t);return i.call(this,e,r)||this}return kn(o,[{key:"canvas",get:function(){return this._canvas}}]),o}(yr);function gc(i,o){for(var n=0;n<o.length;n++){var t=o[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(i,t.key,t)}}function yv(i,o,n){return o&&gc(i.prototype,o),n&&gc(i,n),Object.defineProperty(i,"prototype",{writable:!1}),i}var xv=function(){function i(n,t){var e=this;this._worker=void 0,this._costs={},this._currentLoad=0,this._callbacks={},this._worker=new Worker(n),this._worker.onmessage=function(r){var a=r.data;switch(a.type){case"decode":e._callbacks[a.id].resolve(a.geometry);break;case"error":e._callbacks[a.id].reject(a);break;default:me.error('DRACOWorker: Unexpected message, "'+a.type+'"')}},t?this._worker.postMessage({type:"init",decoderConfig:{wasmBinary:t}}):this._worker.postMessage({type:"init",decoderConfig:{}})}var o=i.prototype;return o.setCosts=function(t,e){this._costs[t]=e},o.addCurrentLoad=function(t){this._currentLoad+=t},o.setCallback=function(t,e,r){this._callbacks[t]={resolve:e,reject:r}},o.decode=function(t,e,r){this._worker.postMessage({type:"decode",id:t,taskConfig:e,buffer:r},[r])},o.releaseTask=function(t){this._currentLoad-=this._costs[t],delete this._callbacks[t],delete this._costs[t]},yv(i,[{key:"currentLoad",get:function(){return this._currentLoad}}]),i}(),mc=`let decoderPending;
let decoderConfig;

onmessage = function(e) {
  const message = e.data;

  switch (message.type) {
    case "init":
      decoderConfig = message.decoderConfig;
      decoderPending = new Promise(function(resolve /*, reject*/) {
        decoderConfig.onModuleLoaded = function(draco) {
          // Module is Promise-like. Wrap before resolving to avoid loop.
          resolve({ draco: draco });
        };
        DracoDecoderModule(decoderConfig);
      });
      break;

    case "decode":
      const buffer = message.buffer;
      const taskConfig = message.taskConfig;
      decoderPending.then(module => {
        const draco = module.draco;
        const decoder = new draco.Decoder();
        const decoderBuffer = new draco.DecoderBuffer();
        decoderBuffer.Init(new Int8Array(buffer), buffer.byteLength);
        try {
          const geometry = decodeGeometry(draco, decoder, decoderBuffer, taskConfig);
          const buffers = geometry.attributes.map(attr => attr.array.buffer);
          if (geometry.index) buffers.push(geometry.index.array.buffer);
          self.postMessage({ type: "decode", id: message.id, geometry }, buffers);
        } catch (error) {
          console.error(error);
          self.postMessage({ type: "error", id: message.id, error: error.message });
        } finally {
          draco.destroy(decoderBuffer);
          draco.destroy(decoder);
        }
      });
      break;
  }
};

function decodeGeometry(draco, decoder, decoderBuffer, taskConfig) {
  const attributeIDs = taskConfig.attributeIDs;
  const attributeTypes = taskConfig.attributeTypes;

  let dracoGeometry;
  let decodingStatus;

  const geometryType = decoder.GetEncodedGeometryType(decoderBuffer);
  if (geometryType === draco.TRIANGULAR_MESH) {
    dracoGeometry = new draco.Mesh();
    decodingStatus = decoder.DecodeBufferToMesh(decoderBuffer, dracoGeometry);
  } else {
    throw new Error("DRACODecoder worker: Unexpected geometry type.");
  }

  if (!decodingStatus.ok() || dracoGeometry.ptr === 0) {
    throw new Error("DRACODecoder worker: Decoding failed: " + decodingStatus.error_msg());
  }

  const geometry = { index: null, attributes: [] };

  // Gather all vertex attributes.
  for (let attributeName in attributeIDs) {
    const attributeType = self[attributeTypes[attributeName]];

    let attribute;
    let attributeID;

    // A Draco file may be created with default vertex attributes, whose attribute IDs
    // are mapped 1:1 from their semantic name (POSITION, NORMAL, ...). Alternatively,
    // a Draco file may contain a custom set of attributes, identified by known unique
    // IDs. glTF files always do the latter, and .drc files typically do the former.
    if (taskConfig.useUniqueIDs) {
      attributeID = attributeIDs[attributeName];
      attribute = decoder.GetAttributeByUniqueId(dracoGeometry, attributeID);
    } else {
      attributeID = decoder.GetAttributeId(dracoGeometry, draco[attributeIDs[attributeName]]);
      if (attributeID === -1) continue;
      attribute = decoder.GetAttribute(dracoGeometry, attributeID);
    }
    geometry.attributes.push(decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute));
  }
  // Add index.
  if (geometryType === draco.TRIANGULAR_MESH) {
    // Generate mesh faces.
    const numFaces = dracoGeometry.num_faces();
    const numIndices = numFaces * 3;
    let dataSize;
    let ptr;
    let index;
    const indexType = self[taskConfig.indexType];

    switch (indexType) {
      case Uint16Array:
        dataSize = numIndices * 2;
        ptr = draco._malloc(dataSize);
        decoder.GetTrianglesUInt16Array(dracoGeometry, dataSize, ptr);
        index = new Uint16Array(draco.HEAPU16.buffer, ptr, numIndices).slice();
        draco._free(ptr);
        break;
      case Uint32Array:
        dataSize = numIndices * 4;
        ptr = draco._malloc(dataSize);
        decoder.GetTrianglesUInt32Array(dracoGeometry, dataSize, ptr);
        index = new Uint32Array(draco.HEAPU32.buffer, ptr, numIndices).slice();
        draco._free(ptr);
        break;
      default:
        throw new Error("DRACODecoder: Unexpected index type.");
    }
    geometry.index = { array: index, itemSize: 1 };
  }
  draco.destroy(dracoGeometry);
  return geometry;
}

function decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute) {
  const numComponents = attribute.num_components();
  const numPoints = dracoGeometry.num_points();
  const numValues = numPoints * numComponents;
  let ptr;
  let array;
  let dataSize;
  switch (attributeType) {
    case Float32Array:
      dataSize = numValues * 4;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_FLOAT32, dataSize, ptr);
      array = new Float32Array(draco.HEAPF32.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Int8Array:
      ptr = draco._malloc(numValues);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT8, numValues, ptr);
      array = new Int8Array(draco.HEAP8.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Int16Array:
      dataSize = numValues * 2;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT16, dataSize, ptr);
      array = new Int16Array(draco.HEAP16.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Int32Array:
      dataSize = numValues * 4;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT32, dataSize, ptr);
      array = new Int32Array(draco.HEAP32.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Uint8Array:
      ptr = draco._malloc(numValues);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT8, numValues, ptr);
      array = new Uint8Array(draco.HEAPU8.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Uint16Array:
      dataSize = numValues * 2;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT16, dataSize, ptr);
      array = new Uint16Array(draco.HEAPU16.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Uint32Array:
      dataSize = numValues * 4;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT32, dataSize, ptr);
      array = new Uint32Array(draco.HEAPU32.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    default:
      throw new Error("DRACODecoder: Unexpected attribute type.");
  }

  return {
    name: attributeName,
    array: array,
    itemSize: numComponents
  };
}
`,Fa="https://gw.alipayobjects.com/os/lib/alipay/draco-javascript/1.3.6/lib/",bv="draco_decoder_gltf.js",wv="draco_decoder_gltf.r3bin",Sv="draco_wasm_wrapper_gltf.js",Cv=function(){function i(n){if(n===void 0&&(n={type:"wasm",workerLimit:4}),this.pool=[],this.workerLimit=Math.min(navigator.hardwareConcurrency||4,4),this.useJS=void 0,this.currentTaskId=1,this.taskCache=new WeakMap,this.loadLibPromise=void 0,n.workerLimit>this.workerLimit)me.warn("DRACOWorkerPool: Can not initialize worker pool with limit:"+n.workerLimit);else{var t;this.workerLimit=(t=n.workerLimit)!=null?t:4}this.useJS=typeof WebAssembly!="object"||n.type==="js",this.loadLibPromise=this.preloadLib()}var o=i.prototype;return o.preloadLib=function(){var t=this;return this.loadLibPromise?this.loadLibPromise:new Promise(function(e,r){t.useJS?pn(""+Fa+bv,{type:"text"}).then(function(a){var s=[a,mc].join(`
`),l=URL.createObjectURL(new Blob([s]));e({workerSourceURL:l,decoderWASMBinary:null})}).catch(function(a){r(a)}):Promise.all([pn(""+Fa+Sv,{type:"text"}),pn(""+Fa+wv,{type:"arraybuffer"})]).then(function(a){var s=a[0],l=a[1],c=[s,mc].join(`
`),u=URL.createObjectURL(new Blob([c]));e({workerSourceURL:u,decoderWASMBinary:l})}).catch(function(a){r(a)})})},o.getWorker=function(){var t=this;return this.preloadLib().then(function(e){if(t.pool.length<t.workerLimit){var r=new xv(e.workerSourceURL,e.decoderWASMBinary);t.pool.push(r)}else t.pool.sort(function(a,s){return a.currentLoad>s.currentLoad?-1:1});return t.pool[t.pool.length-1]})},o.decode=function(t,e){var r=this,a=JSON.stringify(e);if(this.taskCache.has(t)){var s=this.taskCache.get(t);if(s.key===a)return s.promise;if(t.byteLength===0)throw new Error("DRACODecoder: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var l=this.currentTaskId++,c=t.byteLength,u,h=new Promise(function(d,f){r.getWorker().then(function(_){u=_,_.setCosts(l,c),_.addCurrentLoad(c),_.setCallback(l,d,f),_.decode(l,e,t)}).catch(function(_){f(_)})});return h.finally(function(){u&&l&&u.releaseTask(l)}),this.taskCache.set(t,{key:a,promise:h}),h},i}();function yc(i,o){var n=Object.keys(i);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(i);o&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})),n.push.apply(n,t)}return n}function rt(i){for(var o=1;o<arguments.length;o++){var n=arguments[o]!=null?arguments[o]:{};o%2?yc(Object(n),!0).forEach(function(t){Tv(i,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(n)):yc(Object(n)).forEach(function(t){Object.defineProperty(i,t,Object.getOwnPropertyDescriptor(n,t))})}return i}function xc(i,o){for(var n=0;n<o.length;n++){var t=o[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(i,t.key,t)}}function $h(i,o,n){return o&&xc(i.prototype,o),n&&xc(i,n),Object.defineProperty(i,"prototype",{writable:!1}),i}function Tv(i,o,n){return o in i?Object.defineProperty(i,o,{value:n,enumerable:!0,configurable:!0,writable:!0}):i[o]=n,i}function Re(i,o){i.prototype=Object.create(o.prototype),i.prototype.constructor=i,ca(i,o)}function ca(i,o){return ca=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},ca(i,o)}function Av(){if(typeof Reflect=="undefined"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function Kn(i,o,n){return Av()?Kn=Reflect.construct.bind():Kn=function(e,r,a){var s=[null];s.push.apply(s,r);var l=Function.bind.apply(e,s),c=new l;return a&&ca(c,a.prototype),c},Kn.apply(null,arguments)}function Pv(i,o){if(!!i){if(typeof i=="string")return bc(i,o);var n=Object.prototype.toString.call(i).slice(8,-1);if(n==="Object"&&i.constructor&&(n=i.constructor.name),n==="Map"||n==="Set")return Array.from(i);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return bc(i,o)}}function bc(i,o){(o==null||o>i.length)&&(o=i.length);for(var n=0,t=new Array(o);n<o;n++)t[n]=i[n];return t}function qh(i,o){var n=typeof Symbol!="undefined"&&i[Symbol.iterator]||i["@@iterator"];if(n)return(n=n.call(i)).next.bind(n);if(Array.isArray(i)||(n=Pv(i))||o&&i&&typeof i.length=="number"){n&&(i=n);var t=0;return function(){return t>=i.length?{done:!0}:{done:!1,value:i[t++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var wc,Sc;function Mv(i){return/^data:(.+?);base64,/.test(i)}wc=Tt(Xe.Buffer,["bin","r3bin"],!1),wc(Sc=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.load=function(e){var r=e.url;return Mv(r)?new ot(function(a){var s=r.slice(13+RegExp.$1.length),l=Uint8Array.from(atob(s),function(c){return c.charCodeAt(0)});a(l.buffer)}):this.request(r,rt(rt({},e),{},{type:"arraybuffer"}))},o}(st));var At;(function(i){i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.UNSIGNED_INT=5125]="UNSIGNED_INT",i[i.FLOAT=5126]="FLOAT"})(At||(At={}));var Pr;(function(i){i.SCALAR="SCALAR",i.VEC2="VEC2",i.VEC3="VEC3",i.VEC4="VEC4",i.MAT2="MAT2",i.MAT3="MAT3",i.MAT4="MAT4"})(Pr||(Pr={}));var Xi;(function(i){i.TRANSLATION="translation",i.ROTATION="rotation",i.SCALE="scale",i.WEIGHTS="weights"})(Xi||(Xi={}));var ji;(function(i){i.Linear="LINEAR",i.Step="STEP",i.CubicSpine="CUBICSPLINE"})(ji||(ji={}));var ua;(function(i){i.PERSPECTIVE="perspective",i.ORTHOGRAPHIC="orthographic"})(ua||(ua={}));var Cc;(function(i){i.JPEG="image/jpeg",i.PNG="image/png"})(Cc||(Cc={}));var gn;(function(i){i.OPAQUE="OPAQUE",i.MASK="MASK",i.BLEND="BLEND"})(gn||(gn={}));var Tc;(function(i){i[i.NEAREST=9728]="NEAREST",i[i.LINEAR=9729]="LINEAR"})(Tc||(Tc={}));var Ac;(function(i){i[i.NEAREST=9728]="NEAREST",i[i.LINEAR=9729]="LINEAR",i[i.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",i[i.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",i[i.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",i[i.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(Ac||(Ac={}));var Pc;(function(i){i[i.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",i[i.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",i[i.REPEAT=10497]="REPEAT"})(Pc||(Pc={}));var Pe=function(){function i(){}return i.floatBufferToVector2Array=function(n){for(var t=n.length,e=new Array(t/2),r=0;r<t;r+=2)e[r/2]=new q(n[r],n[r+1]);return e},i.floatBufferToVector3Array=function(n){for(var t=n.length,e=new Array(t/3),r=0;r<t;r+=3)e[r/3]=new T(n[r],n[r+1],n[r+2]);return e},i.floatBufferToVector4Array=function(n){for(var t=n.length,e=new Array(t/4),r=0;r<t;r+=4)e[r/4]=new Ve(n[r],n[r+1],n[r+2],n[r+3]);return e},i.floatBufferToColorArray=function(n,t){var e=n.length,r=new Array(e/(t?3:4));if(t)for(var a=0;a<e;a+=3)r[a/3]=new oe(n[a],n[a+1],n[a+2],1);else for(var s=0;s<e;s+=4)r[s/4]=new oe(n[s],n[s+1],n[s+2],n[s+3]);return r},i.decodeText=function(n){if(typeof TextDecoder!="undefined")return new TextDecoder().decode(n);for(var t="",e=0,r=n.length;e<r;e++)t+=String.fromCharCode(n[e]);return decodeURIComponent(encodeURIComponent(t))},i.getAccessorTypeSize=function(n){switch(n){case Pr.SCALAR:return 1;case Pr.VEC2:return 2;case Pr.VEC3:return 3;case Pr.VEC4:return 4;case Pr.MAT2:return 4;case Pr.MAT3:return 9;case Pr.MAT4:return 16}},i.getComponentType=function(n){switch(n){case At.BYTE:return Int8Array;case At.UNSIGNED_BYTE:return Uint8Array;case At.SHORT:return Int16Array;case At.UNSIGNED_SHORT:return Uint16Array;case At.UNSIGNED_INT:return Uint32Array;case At.FLOAT:return Float32Array}},i.getAccessorData=function(n,t,e){var r,a=n.bufferViews,s=a[t.bufferView],l=e[s.buffer],c=t.hasOwnProperty("byteOffset")?t.byteOffset:0,u=s.hasOwnProperty("byteOffset")?s.byteOffset:0,h=c+u,d=i.getAccessorTypeSize(t.type),f=d*t.count,_=(r=s.byteStride)!=null?r:0,g=i.getComponentType(t.componentType),v;if(_){var p=d*g.BYTES_PER_ELEMENT;v=new Uint8Array(t.count*p);for(var m=new Uint8Array(l,u,s.byteLength),y=0;y<t.count;y++)for(var x=0;x<p;x++)v[y*p+x]=m[y*_+c+x]}else v=new Uint8Array(l.slice(h,h+f*g.BYTES_PER_ELEMENT));var S=new g(v.buffer);if(t.sparse)for(var w,b,A,E,C=t.sparse,M=C.count,P=C.indices,R=C.values,B=a[P.bufferView],D=a[R.bufferView],L=e[B.buffer],N=e[D.buffer],W=((w=P.byteOffset)!=null?w:0)+((b=B.byteOffset)!=null?b:0),I=B.byteLength,V=((A=R.byteOffset)!=null?A:0)+((E=D.byteOffset)!=null?E:0),se=D.byteLength,Z=i.getComponentType(P.componentType),Y=new Z(L,W,I/Z.BYTES_PER_ELEMENT),ue=new g(N,V,se/g.BYTES_PER_ELEMENT),ie=0;ie<M;ie++)for(var be=Y[ie],ye=0;ye<d;ye++)S[be*d+ye]=ue[ie*d+ye];return S},i.getBufferViewData=function(n,t){var e=n.buffer,r=n.byteOffset,a=r===void 0?0:r,s=n.byteLength,l=t[e];return l.slice(a,a+s)},i.getVertexStride=function(n,t){var e,r=n.bufferViews[(e=t.bufferView)!=null?e:0].byteStride;if(r)return r;var a=i.getAccessorTypeSize(t.type),s=i.getComponentType(t.componentType);return a*s.BYTES_PER_ELEMENT},i.createVertexElement=function(n,t,e){var r=i.getAccessorTypeSize(t.type);return new Ee(n,0,i.getElementFormat(t.componentType,r,t.normalized),e)},i.getIndexFormat=function(n){switch(n){case At.UNSIGNED_BYTE:return nt.UInt8;case At.UNSIGNED_SHORT:return nt.UInt16;case At.UNSIGNED_INT:return nt.UInt32}},i.getElementFormat=function(n,t,e){if(e===void 0&&(e=!1),n==At.FLOAT)switch(t){case 1:return ne.Float;case 2:return ne.Vector2;case 3:return ne.Vector3;case 4:return ne.Vector4}if(n==At.SHORT)switch(t){case 2:return e?ne.NormalizedShort2:ne.Short2;case 3:case 4:return e?ne.NormalizedShort4:ne.Short4}if(n==At.UNSIGNED_SHORT)switch(t){case 2:return e?ne.NormalizedUShort2:ne.UShort2;case 3:case 4:return e?ne.NormalizedUShort4:ne.UShort4}if(n==At.BYTE)switch(t){case 2:case 3:case 4:return e?ne.NormalizedByte4:ne.Byte4}if(n==At.UNSIGNED_BYTE)switch(t){case 2:case 3:case 4:return e?ne.NormalizedUByte4:ne.UByte4}},i.loadImageBuffer=function(n,t){return new Promise(function(e,r){var a=new window.Blob([n],{type:t}),s=new Image;s.src=URL.createObjectURL(a),s.crossOrigin="anonymous",s.onerror=function(){r(new Error("Failed to load image buffer"))},s.onload=function(){requestAnimationFrame(function(){e(s),s.onload=null,s.onerror=null,s.onabort=null})}})},i.isAbsoluteUrl=function(n){return/^(?:http|blob|data:|\/)/.test(n)},i.parseRelativeUrl=function(n,t){if(i.isAbsoluteUrl(t))return t;var e=t.charAt(0);return e==="."?i._formatRelativePath(t+t):n.substring(0,n.lastIndexOf("/")+1)+t},i.parseGLB=function(n){var t=4,e=1179937895,r=12,a={JSON:1313821514,BIN:5130562},s=new DataView(n),l={magic:s.getUint32(0,!0),version:s.getUint32(t,!0),length:s.getUint32(2*t,!0)};if(l.magic!==e)return console.error("Invalid glb magic number. Expected 0x46546C67, found 0x"+l.magic.toString(16)),null;var c=s.getUint32(r,!0),u=s.getUint32(r+t,!0);if(u!==a.JSON)return console.error("Invalid glb chunk type. Expected 0x4E4F534A, found 0x"+u.toString(16)),null;for(var h=new Uint8Array(n,r+2*t,c),d=JSON.parse(i.decodeText(h)),f=[],_=r+2*t+c;_<l.length;){if(c=s.getUint32(_,!0),u=s.getUint32(_+t,!0),u!==a.BIN)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+u.toString(16)),null;var g=_+2*t,v=n.slice(g,g+c);f.push(v),_+=c+2*t}return{gltf:d,buffers:f}},i._formatRelativePath=function(n){for(var t=n.split("/"),e=0,r=t.length;e<r;e++)t[e]==".."&&(t.splice(e-1,2),e-=2);return t.join("/")},i}(),at=function(){function i(){}return i.parseEngineResource=function(n,t,e,r){var a=i._extensionParsers[n];if(a!=null&&a.length){for(var s=arguments.length,l=new Array(s>4?s-4:0),c=4;c<s;c++)l[c-4]=arguments[c];for(var u=0;u<a.length;u++){var h;(h=a[u]).parseEngineResource.apply(h,[t,e,r].concat(l))}}},i.createEngineResource=function(n,t,e){var r=i._extensionParsers[n];if(r!=null&&r.length){for(var a,s=arguments.length,l=new Array(s>3?s-3:0),c=3;c<s;c++)l[c-3]=arguments[c];return(a=r[0]).createEngineResource.apply(a,[t,e].concat(l))}},i.hasExtensionParser=function(n){var t=i._extensionParsers[n];return!!(t!=null&&t.length)},i.initialize=function(n){var t=i._extensionParsers[n];if(t!=null&&t.length)for(var e=0;e<t.length;e++)t[e].initialize()},i._addExtensionParser=function(n,t){i._extensionParsers[n]||(i._extensionParsers[n]=[]),i._extensionParsers[n].push(t)},i}();at._extensionParsers={};function di(i){return function(o){var n=new o;at._addExtensionParser(i,n)}}var Ev=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.parse=function(e){var r=e.gltf,a=e.buffers,s=e.entities,l=r.animations,c=r.accessors;if(!!l){for(var u=l.length,h=new Array(u),d=new Array(u),f=0;f<u;f++){for(var _=l[f],g=_.channels,v=_.samplers,p=_.name,m=p===void 0?"AnimationClip"+f:p,y=new zh(m),x=new Array,S=0;S<v.length;S++){var w,b=v[S],A=c[b.input],E=c[b.output],C=Pe.getAccessorData(r,A,a),M=Pe.getAccessorData(r,E,a),P=M.length/C.length,R=(w=b.interpolation)!=null?w:ji.Linear,B=void 0;switch(R){case ji.CubicSpine:B=Er.CubicSpine;break;case ji.Step:B=Er.Step;break;case ji.Linear:B=Er.Linear;break}C[C.length-1],x.push({type:E.type,interpolation:B,input:C,output:M,outputSize:P})}for(var D=0;D<g.length;D++){for(var L=g[D],N=L.target,W=s[N.node],I="",V=W;V.parent;)I=I===""?""+V.name:V.name+"/"+I,V=V.parent;var se=void 0,Z=void 0,Y=void 0;switch(N.path){case Xi.TRANSLATION:se=$t,Z="position",Y=Te.Vector3;break;case Xi.ROTATION:se=$t,Z="rotation",Y=Te.Quaternion;break;case Xi.SCALE:se=$t,Z="scale",Y=Te.Vector3;break;case Xi.WEIGHTS:se=si,Z="blendShapeWeights",Y=Te.FloatArray;break}var ue=this._addCurve(Y,L,x);y.addCurveBinding(I,se,Z,ue)}h[f]=y,d[f]={name:m,index:f}}e.animations=h,e._animationsIndices=d}},n._addCurve=function(e,r,a){var s=new Vh,l=a[r.sampler],c=l.input,u=l.output,h=l.outputSize;s.interpolation=l.interpolation;for(var d=0,f=c.length;d<f;d++){var _=d*h;if(e===Te.Float){var g=new wi;g.time=c[d],g.inTangent=0,g.outTangent=0,g.value=u[_],s.addKey(g)}else if(e===Te.FloatArray){var v=new wi;v.time=c[d],v.inTangent=new Float32Array(h),v.outTangent=new Float32Array(h),v.value=u.subarray(_,_+h),s.addKey(v)}else if(e===Te.Vector2){var p=new wi;p.time=c[d],p.value=new q(u[_],u[_+1]),p.inTangent=new q,p.outTangent=new q,s.addKey(p)}else if(e===Te.Vector3){var m=new wi;m.time=c[d],m.value=new T(u[_],u[_+1],u[_+2]),m.inTangent=new T,m.outTangent=new T,s.addKey(m)}else if(e===Te.Vector4){var y=new wi;y.time=c[d],y.value=new Ve(u[_],u[_+1],u[_+2],u[_+3]),y.inTangent=new Ve,y.outTangent=new Ve,s.addKey(y)}else if(e===Te.Quaternion){var x=new wi;x.time=c[d],x.value=new De(u[_],u[_+1],u[_+2],u[_+3]),x.inTangent=new Ve,x.outTangent=new Ve,s.addKey(x)}}return s},o}(at),Rv=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.parse=function(e){var r=e.url,a=e.engine;return this._isGLB(r)?a.resourceManager.load({url:r,type:Xe.Buffer}).then(Pe.parseGLB).then(function(s){var l=s.gltf,c=s.buffers;e.gltf=l,e.buffers=c}):a.resourceManager.load({url:r,type:Xe.JSON}).then(function(s){return e.gltf=s,Promise.all(s.buffers.map(function(l){return a.resourceManager.load({type:Xe.Buffer,url:Pe.parseRelativeUrl(r,l.uri)})})).then(function(l){e.buffers=l})})},n._isGLB=function(e){return e.substring(e.lastIndexOf(".")+1)==="glb"},o}(at),Yh=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.parse=function(e){var r=e.engine,a=e.gltf.nodes;if(!!a){for(var s=[],l=0;l<a.length;l++){var c=a[l],u=c.matrix,h=c.translation,d=c.rotation,f=c.scale,_=new Lr(r,c.name||""+o._defaultName+l),g=_.transform;if(u){var v=g.localMatrix;v.copyFromArray(u),g.localMatrix=v}else h&&g.setPosition(h[0],h[1],h[2]),d&&g.setRotationQuaternion(d[0],d[1],d[2],d[3]),f&&g.setScale(f[0],f[1],f[2]);s[l]=_}e.entities=s,this._buildEntityTree(e),this._createSceneRoots(e)}},n._buildEntityTree=function(e){for(var r=e.gltf.nodes,a=e.entities,s=0;s<r.length;s++){var l=r[s].children,c=a[s];if(l)for(var u=0;u<l.length;u++){var h=a[l[u]];c.addChild(h)}}},n._createSceneRoots=function(e){var r=e.engine,a=e.gltf,s=a.scene,l=s===void 0?0:s,c=a.scenes,u=e.entities;if(!!c){for(var h=[],d=0;d<c.length;d++){var f=c[d].nodes;if(!!f)if(f.length===1)h[d]=u[f[0]];else{for(var _=new Lr(r,"GLTF_ROOT"),g=0;g<f.length;g++)_.addChild(u[f[g]]);h[d]=_}}e.sceneRoots=h,e.defaultSceneRoot=h[l]}},o}(at);Yh._defaultName="_GLTF_ENTITY_";var Zi=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}o._parseTextureTransform=function(e,r,a){r===void 0&&(r={});var s=r.KHR_texture_transform;s&&at.parseEngineResource("KHR_texture_transform",s,e,a)};var n=o.prototype;return n.parse=function(e){var r=e.gltf,a=e.engine,s=e.textures;if(!!r.materials){for(var l=[],c=0;c<r.materials.length;c++){var u=r.materials[c],h=u.extensions,d=h===void 0?{}:h,f=u.pbrMetallicRoughness,_=u.normalTexture,g=u.occlusionTexture,v=u.emissiveTexture,p=u.emissiveFactor,m=u.alphaMode,y=u.alphaCutoff,x=u.doubleSided,S=u.name,w=S===void 0?"":S,b=d.KHR_materials_unlit,A=d.KHR_materials_pbrSpecularGlossiness,E=d.KHR_materials_clearcoat,C=null;if(b?C=at.createEngineResource("KHR_materials_unlit",b,e):A?C=at.createEngineResource("KHR_materials_pbrSpecularGlossiness",A,e):C=new Li(a),C.name=w,E&&at.parseEngineResource("KHR_materials_clearcoat",E,C,e),f){var M=f.baseColorFactor,P=f.baseColorTexture,R=f.metallicFactor,B=f.roughnessFactor,D=f.metallicRoughnessTexture;if(M&&(C.baseColor=new oe(oe.linearToGammaSpace(M[0]),oe.linearToGammaSpace(M[1]),oe.linearToGammaSpace(M[2]),M[3])),P&&(C.baseTexture=s[P.index],o._parseTextureTransform(C,P.extensions,e)),!b&&!A){var L=C;L.metallic=R!=null?R:1,L.roughness=B!=null?B:1,D&&(L.roughnessMetallicTexture=s[D.index],o._parseTextureTransform(C,D.extensions,e))}}if(!b){var N=C;if(v&&(N.emissiveTexture=s[v.index],o._parseTextureTransform(C,v.extensions,e)),p&&(N.emissiveColor=new oe(oe.linearToGammaSpace(p[0]),oe.linearToGammaSpace(p[1]),oe.linearToGammaSpace(p[2]))),_){var W=_.index,I=_.scale;N.normalTexture=s[W],o._parseTextureTransform(C,_.extensions,e),I!==void 0&&(N.normalTextureIntensity=I)}if(g){var V=g.index,se=g.strength,Z=g.texCoord;N.occlusionTexture=s[V],o._parseTextureTransform(C,g.extensions,e),se!==void 0&&(N.occlusionTextureIntensity=se),Z===ni.UV1?N.occlusionTextureCoord=ni.UV1:Z>ni.UV1&&me.warn("Occlusion texture uv coordinate must be UV0 or UV1.")}}switch(x?C.renderFace=Mr.Double:C.renderFace=Mr.Front,m){case gn.OPAQUE:C.isTransparent=!1;break;case gn.BLEND:C.isTransparent=!0;break;case gn.MASK:C.alphaCutoff=y!=null?y:.5;break}l[c]=C}e.materials=l}},o}(at),Qh=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.parse=function(e){var r=this,a=e.engine,s=e.gltf,l=e.buffers;if(!!s.meshes){for(var c=[],u=function(f){for(var _=s.meshes[f],g=[],v=function(y){var x=_.primitives[y],S=x.extensions,w=S===void 0?{}:S,b=w.KHR_draco_mesh_compression;g.push(new Promise(function(A){var E=new Wt(a,_.name||y+"");b?at.createEngineResource("KHR_draco_mesh_compression",b,e,x).then(function(C){return r._parseMeshFromGLTFPrimitive(E,_,x,s,function(M){for(var P=0;P<C.attributes.length;P++)if(C.attributes[P].name===M)return C.attributes[P].array;return null},function(M,P){throw"BlendShape animation is not supported when using draco."},function(){return C.index.array},a)}).then(A):r._parseMeshFromGLTFPrimitive(E,_,x,s,function(C){var M=x.attributes[C],P=s.accessors[M];return Pe.getAccessorData(s,P,l)},function(C,M){var P=x.targets[M],R=P[C];if(R){var B=s.accessors[R];return Pe.getAccessorData(s,B,l)}else return null},function(){var C=s.accessors[x.indices];return Pe.getAccessorData(s,C,l)},a).then(A)}))},p=0;p<_.primitives.length;p++)v(p);c.push(Promise.all(g))},h=0;h<s.meshes.length;h++)u(h);return Promise.all(c).then(function(d){e.meshes=d})}},n._parseMeshFromGLTFPrimitive=function(e,r,a,s,l,c,u,h){var d=a.attributes,f=a.targets,_=a.indices,g=a.mode,v,p=s.accessors,m=p[d.POSITION],y=l("POSITION"),x=Pe.floatBufferToVector3Array(y);e.setPositions(x);var S=e.bounds;if(v=m.count,m.min&&m.max)S.min.copyFromArray(m.min),S.max.copyFromArray(m.max);else{var w=o._tempVector3,b=S.min,A=S.max;b.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),A.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var E=y.length/v,C=0;C<v;C++){var M=C*E;w.copyFromArray(y,M),T.min(b,w,b),T.max(A,w,A)}}for(var P in d)if(P!=="POSITION"){var R=l(P);switch(P){case"NORMAL":var B=Pe.floatBufferToVector3Array(R);e.setNormals(B);break;case"TEXCOORD_0":var D=Pe.floatBufferToVector2Array(R);e.setUVs(D,0);break;case"TEXCOORD_1":var L=Pe.floatBufferToVector2Array(R);e.setUVs(L,1);break;case"TEXCOORD_2":var N=Pe.floatBufferToVector2Array(R);e.setUVs(N,2);break;case"TEXCOORD_3":var W=Pe.floatBufferToVector2Array(R);e.setUVs(W,3);break;case"TEXCOORD_4":var I=Pe.floatBufferToVector2Array(R);e.setUVs(I,4);break;case"TEXCOORD_5":var V=Pe.floatBufferToVector2Array(R);e.setUVs(V,5);break;case"TEXCOORD_6":var se=Pe.floatBufferToVector2Array(R);e.setUVs(se,6);break;case"TEXCOORD_7":var Z=Pe.floatBufferToVector2Array(R);e.setUVs(Z,7);break;case"COLOR_0":var Y=Pe.floatBufferToColorArray(R,p[d.COLOR_0].type===Pr.VEC3);e.setColors(Y);break;case"TANGENT":var ue=Pe.floatBufferToVector4Array(R);e.setTangents(ue);break;case"JOINTS_0":var ie=Pe.floatBufferToVector4Array(R);e.setBoneIndices(ie);break;case"WEIGHTS_0":var be=Pe.floatBufferToVector4Array(R);e.setBoneWeights(be);break}}if(_!==void 0){var ye=s.accessors[_],Fe=u();e.setIndices(Fe),e.addSubMesh(0,ye.count,g)}else e.addSubMesh(0,v,g);return f&&this._createBlendShape(e,r,f,c),e.uploadData(!0),Promise.resolve(e)},n._createBlendShape=function(e,r,a,s){for(var l=r.extras?r.extras.targetNames:null,c=0,u=a.length;c<u;c++){var h=l?l[c]:"blendShape"+c,d=s("POSITION",c),f=s("NORMAL",c),_=s("TANGENT",c),g=d?Pe.floatBufferToVector3Array(d):null,v=f?Pe.floatBufferToVector3Array(f):null,p=_?Pe.floatBufferToVector3Array(_):null,m=new xo(h);m.addFrame(1,g,v,p),e.addBlendShape(m)}},o}(at);Qh._tempVector3=new T;var Jh=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}o._getDefaultMaterial=function(e){return o._defaultMaterial||(o._defaultMaterial=new on(e)),o._defaultMaterial};var n=o.prototype;return n.parse=function(e){var r=e.gltf,a=r.nodes,s=r.cameras,l=e.entities;if(!!a){for(var c=0;c<a.length;c++){var u=a[c],h=u.camera,d=u.mesh,f=u.extensions,_=f===void 0?{}:f,g=_.KHR_lights_punctual,v=l[c];if(h!==void 0&&this._createCamera(e,s[h],v),d!==void 0&&this._createRenderer(e,u,v),g){var p=g.light,m=e.gltf.extensions.KHR_lights_punctual.lights;at.parseEngineResource("KHR_lights_punctual",m[p],v,e)}}e.defaultSceneRoot&&this._createAnimator(e)}},n._createCamera=function(e,r,a){var s=r.orthographic,l=r.perspective,c=r.type,u=a.addComponent(Sa);if(c===ua.ORTHOGRAPHIC){var h=s.xmag,d=s.ymag,f=s.zfar,_=s.znear;u.isOrthographic=!0,_!==void 0&&(u.nearClipPlane=_),f!==void 0&&(u.farClipPlane=f),u.orthographicSize=Math.max(d!=null?d:0,h!=null?h:0)/2}else if(c===ua.PERSPECTIVE){var g=l.aspectRatio,v=l.yfov,p=l.zfar,m=l.znear;g!==void 0&&(u.aspectRatio=g),v!==void 0&&(u.fieldOfView=v*180/Math.PI),p!==void 0&&(u.farClipPlane=p),m!==void 0&&(u.nearClipPlane=m)}e.cameras||(e.cameras=[]),e.cameras.push(u),u.enabled=!1},n._createRenderer=function(e,r,a){for(var s=e.engine,l=e.gltf.meshes,c=e.meshes,u=e.materials,h=e.skins,d=r.mesh,f=r.skin,_=l[d],g=_.primitives,v=r.weights||_.weights,p=0;p<g.length;p++){var m=c[d][p],y=void 0;if(f!==void 0||v){var x=a.addComponent(si);x.mesh=m,f!==void 0&&(x.skin=h[f]),v&&(x.blendShapeWeights=new Float32Array(v)),y=x}else y=a.addComponent(Ir),y.mesh=m;var S=g[p].material,w=(u==null?void 0:u[S])||o._getDefaultMaterial(s);y.setMaterial(w);var b=g[p].extensions,A=b===void 0?{}:b,E=A.KHR_materials_variants;E&&at.parseEngineResource("KHR_materials_variants",E,y,e)}},n._createAnimator=function(e){var r=e.defaultSceneRoot,a=e.animations;if(!!a){var s=r.addComponent(So),l=new Ih,c=new Nh("layer"),u=new kh;if(l.addLayer(c),s.animatorController=l,c.stateMachine=u,a)for(var h=0;h<a.length;h++){var d=a[h],f=d.name,_=u.makeUniqueStateName(f);_!==f&&console.warn("AnimatorState name is existed, name: "+f+" reset to "+_);var g=u.addState(_);g.clip=d}}},o}(at);Jh._defaultMaterial=void 0;var Fv=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.parse=function(e){var r=e.gltf,a=e.buffers,s=e.entities,l=e.defaultSceneRoot,c=r.skins;if(!!c){for(var u=[],h=0;h<c.length;h++){var d=c[h],f=d.inverseBindMatrices,_=d.skeleton,g=d.joints,v=d.name,p=v===void 0?"SKIN_"+h:v,m=g.length,y=new Ch(p);y.inverseBindMatrices.length=m;for(var x=r.accessors[f],S=Pe.getAccessorData(r,x,a),w=0;w<m;w++){var b=new ce;b.copyFromArray(S,w*16),y.inverseBindMatrices[w]=b}for(var A=0;A<m;A++)y.joints[A]=s[g[A]].name;_!==void 0?y.skeleton=s[_].name:y.skeleton=l.name,u[h]=y}e.skins=u}},o}(at),Zh=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.parse=function(e){var r=this,a=e.gltf,s=e.buffers,l=e.engine,c=e.url;if(a.textures)return Promise.all(a.textures.map(function(u,h){var d=u.sampler,f=u.source,_=f===void 0?0:f,g=u.name,v=a.images[_],p=v.uri,m=v.bufferView,y=v.mimeType,x=v.name;if(p)return l.resourceManager.load({url:Pe.parseRelativeUrl(c,p),type:Xe.Texture2D}).then(function(b){return b.name||(b.name=g||x||"texture_"+h),d!==void 0&&r._parseSampler(b,a.samplers[d]),b});var S=a.bufferViews[m],w=Pe.getBufferViewData(S,s);return Pe.loadImageBuffer(w,y).then(function(b){var A=new Ct(l,b.width,b.height);return A.setImageSource(b),A.generateMipmaps(),A.name=g||x||"texture_"+h,d!==void 0&&r._parseSampler(A,a.samplers[d]),A})})).then(function(u){e.textures=u})},n._parseSampler=function(e,r){var a=r.magFilter,s=r.minFilter,l=r.wrapS,c=r.wrapT;(a||s)&&me.warn("texture use filterMode in engine"),l&&(e.wrapModeU=o._wrapMap[l]),c&&(e.wrapModeV=o._wrapMap[c])},o}(at);Zh._wrapMap={33071:Nt.Clamp,33648:Nt.Mirror,10497:Nt.Repeat};var Bv=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.parse=function(e){var r=e.gltf,a=r.asset.version,s=r.extensionsUsed,l=r.extensionsRequired,c=Number(a);if(!(c>=2&&c<3))throw"Only support gltf 2.x.";if(s){me.info("extensionsUsed: ",s);for(var u=0;u<s.length;u++)at.hasExtensionParser(s[u])||me.warn("Extension "+s[u]+" is not implemented, you can customize this extension in gltf.")}if(l){me.info("extensionsRequired: "+l);for(var h=0;h<l.length;h++){var d=l[h];at.hasExtensionParser(d)?at.initialize(d):me.error("GLTF parser has not supported required extension "+d+".")}}},o}(at),Ya=function(){function i(n){var t=this;this._pipes=[],n.forEach(function(e,r){t._pipes[r]=new e})}var o=i.prototype;return o.parse=function(t){var e=this,r;return new Promise(function(a,s){e._pipes.forEach(function(l){r?r=r.then(function(){return l.parse(t)}):r=l.parse(t)}),r?r.then(function(){a(t)}).catch(s):a(t)})},i}();Ya.instance=new Ya([Rv,Bv,Zh,Zi,Qh,Yh,Fv,Ev,Jh]);var Dv=function(i){Re(o,i);function o(){for(var n,t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return n=i.call.apply(i,[this].concat(e))||this,n.url=void 0,n.gltf=void 0,n.buffers=void 0,n.textures=void 0,n.materials=void 0,n.meshes=void 0,n.skins=void 0,n.animations=void 0,n.entities=void 0,n.cameras=void 0,n.lights=void 0,n.sceneRoots=void 0,n.defaultSceneRoot=void 0,n.variants=void 0,n}return o}(Vr),Mc,Ec;Mc=Tt(Xe.Prefab,["gltf","glb"]),Mc(Ec=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.load=function(e,r){var a=e.url;return new ot(function(s,l){var c=new Dv(r.engine);c.url=a,Ya.instance.parse(c).then(s).catch(function(u){console.error(u),l("Error loading glTF model from "+a+" .")})})},o}(st));var Rc,Fc;Rc=Tt(Xe.JSON,["json"],!1),Rc(Fc=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.load=function(e){return this.request(e.url,rt(rt({},e),{},{type:"json"}))},o}(st));var Lv=12+13*4,zv=0;function Ov(i,o){for(var n=[],t=Lv+i.bytesOfKeyValueData,e=i.pixelWidth,r=i.pixelHeight,a=o?i.numberOfMipmapLevels:1,s=0;s<a;s++){var l=new Int32Array(i.buffer,t,1)[0];t+=4;for(var c=0;c<i.numberOfFaces;c++){var u=new Uint8Array(i.buffer,t,l);n.push({data:u,width:e,height:r}),t+=l,t+=3-(l+3)%4}e=Math.max(1,e*.5),r=Math.max(1,r*.5)}return n}function Iv(i){if(i.byteLength>=12){var o=new Uint8Array(i,0,12);if(o[0]===171&&o[1]===75&&o[2]===84&&o[3]===88&&o[4]===32&&o[5]===49&&o[6]===49&&o[7]===187&&o[8]===13&&o[9]===10&&o[10]===26&&o[11]===10)return!0}return!1}function Nv(i){switch(i){case _e.RGB_S3TC_DXT1_EXT:return ee.DXT1;case _e.RGBA_S3TC_DXT5_EXT:return ee.DXT5;case _e.RGB_ETC1_WEBGL:return ee.ETC1_RGB;case _e.RGB8_ETC2:return ee.ETC2_RGB;case _e.RGB8_PUNCHTHROUGH_ALPHA1_ETC2:return ee.ETC2_RGBA5;case _e.RGBA8_ETC2_EAC:return ee.ETC2_RGBA8;case _e.RGB_PVRTC_2BPPV1_IMG:return ee.PVRTC_RGB2;case _e.RGBA_PVRTC_2BPPV1_IMG:return ee.PVRTC_RGBA2;case _e.RGB_PVRTC_4BPPV1_IMG:return ee.PVRTC_RGB4;case _e.RGBA_PVRTC_4BPPV1_IMG:return ee.PVRTC_RGBA4;case _e.RGBA_ASTC_4X4_KHR:return ee.ASTC_4x4;case _e.RGBA_ASTC_5X5_KHR:return ee.ASTC_5x5;case _e.RGBA_ASTC_6X6_KHR:return ee.ASTC_6x6;case _e.RGBA_ASTC_8X8_KHR:return ee.ASTC_8x8;case _e.RGBA_ASTC_10X10_KHR:return ee.ASTC_10x10;case _e.RGBA_ASTC_12X12_KHR:return ee.ASTC_12x12;default:var o=_e[i];throw new Error("this format is not supported in Oasis Engine: "+o)}}var Kh={parse:function(o,n,t,e){if(e===void 0&&(e=!1),!Iv(o))throw new Error("khronosTextureContainerParser: invalid KTX file, texture missing KTX identifier");var r=Uint32Array.BYTES_PER_ELEMENT,a=new DataView(o,12,13*r),s=a.getUint32(0,!0),l=s===67305985,c={buffer:o,glType:a.getUint32(1*r,l),glTypeSize:a.getUint32(2*r,l),glFormat:a.getUint32(3*r,l),glInternalFormat:a.getUint32(4*r,l),glBaseInternalFormat:a.getUint32(5*r,l),pixelWidth:a.getUint32(6*r,l),pixelHeight:a.getUint32(7*r,l),pixelDepth:a.getUint32(8*r,l),numberOfArrayElements:a.getUint32(9*r,l),numberOfFaces:a.getUint32(10*r,l),numberOfMipmapLevels:a.getUint32(11*r,l),bytesOfKeyValueData:a.getUint32(12*r,l),loadType:zv};if(c.glType!==0)throw new Error("only compressed formats currently supported");if(c.numberOfMipmapLevels=Math.max(1,c.numberOfMipmapLevels),c.pixelHeight===0||c.pixelDepth!==0)throw new Error("only 2D textures currently supported");if(c.numberOfArrayElements!==0)throw new Error("texture arrays not currently supported");if(c.numberOfFaces!==n)throw new Error("number of faces expected"+n+", but found "+c.numberOfFaces);return t&&(c.mipmaps=Ov(c,!0)),e&&(c.engineFormat=Nv(c.glInternalFormat)),c}};function Uv(i){var o=Kh.parse(i,1,!0,!0);return{mipmaps:o.mipmaps,engineFormat:o.engineFormat,internalFormat:o.glInternalFormat,width:o.pixelWidth,height:o.pixelHeight}}function kv(i){for(var o=[],n,t,e,r,a=0;a<i.length;a++){var s=Kh.parse(i[a],1,!0,!0);o.push(s.mipmaps),a===0&&(e=s.pixelWidth,r=s.pixelHeight,n=s.glInternalFormat,t=s.engineFormat)}return{mipmapsFaces:o,engineFormat:t,internalFormat:n,width:e,height:r}}var Bc,Dc;Bc=Tt(Xe.KTXCube,[]),Bc(Dc=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.load=function(e,r){var a=this;return new ot(function(s,l){Promise.all(e.urls.map(function(c){return a.request(c,rt(rt({},e),{},{type:"arraybuffer"}))})).then(function(c){for(var u=kv(c),h=u.width,d=u.mipmapsFaces,f=u.engineFormat,_=d[0].length>1,g=new jt(r.engine,h,f,_),v=0;v<6;v++)for(var p=d[v].length,m=0;m<p;m++){var y=d[v][m],x=y.data,S=y.width,w=y.height;g.setPixelBuffer(It.PositiveX+v,x,m,0,0,S,w)}s(g)}).catch(function(c){l(c)})})},o}(st));var Lc,zc;Lc=Tt(Xe.KTX,["ktx"]),Lc(zc=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.load=function(e,r){var a=this;return new ot(function(s,l){a.request(e.url,rt(rt({},e),{},{type:"arraybuffer"})).then(function(c){for(var u=Uv(c),h=u.width,d=u.height,f=u.mipmaps,_=u.engineFormat,g=f.length>1,v=new Ct(r.engine,h,d,_,g),p=0;p<f.length;p++){var m=f[p],y=m.width,x=m.height,S=m.data;v.setPixelBuffer(S,p,0,0,y,x)}s(v)}).catch(function(c){l(c)})})},o}(st));var Oc,Ic;Oc=Tt(Xe.Texture2D,["png","jpg","webp","jpeg"]),Oc(Ic=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.load=function(e,r){var a=this;return new ot(function(s,l){a.request(e.url,rt(rt({},e),{},{type:"image"})).then(function(c){var u=new Ct(r.engine,c.width,c.height);if(!!u._platformTexture){if(u.setImageSource(c),u.generateMipmaps(),e.url.indexOf("data:")!==0){var h=e.url.split("/");u.name=h[h.length-1]}s(u)}}).catch(function(c){l(c)})})},o}(st));var Nc,Uc;Nc=Tt(Xe.TextureCube,[""]),Nc(Uc=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.load=function(e,r){var a=this;return new ot(function(s,l){Promise.all(e.urls.map(function(c){return a.request(c,rt(rt({},e),{},{type:"image"}))})).then(function(c){var u=c[0],h=u.width,d=u.height;if(h!==d){console.error("The cube texture must have the same width and height");return}var f=new jt(r.engine,h);if(!!f._platformTexture){for(var _=0;_<6;_++)f.setImageSource(It.PositiveX+_,c[_],0);f.generateMipmaps(),s(f)}}).catch(function(c){l(c)})})},o}(st));var kc,Vc;kc=Tt(Xe.Sprite,["sprite"],!1),kc(Vc=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.load=function(e,r){var a=this;return new ot(function(s,l){a.request(e.url,rt(rt({},e),{},{type:"json"})).then(function(c){r.getResourceByRef(c.texture).then(function(u){var h=new wo(r.engine,u);h.region=c.region,h.pivot=c.pivot,s(h)})})})},o}(st));var Gc,Hc;Gc=Tt(Xe.SpriteAtlas,["atlas"],!1),Gc(Hc=function(i){Re(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t._tempRect=new Na,t._tempVec2=new q,t}var n=o.prototype;return n.load=function(e,r){var a=this;return new ot(function(s,l){a.request(e.url,rt(rt({},e),{},{type:"json"})).then(function(c){var u=c.atlasItems,h=c.format,d=u.length;Promise.all(u.map(function(f){var _=f.img;return a.request(Pe.parseRelativeUrl(e.url,_),rt(rt({},e),{},{type:"image"}))})).then(function(f){for(var _=r.engine,g=a._tempRect,v=a._tempVec2,p=new Fh(_),m=0;m<d;m++){var y=f[m],x=y.width,S=y.height,w=new Ct(_,x,S,h);w.setImageSource(y),w.generateMipmaps();for(var b=u[m],A=b.sprites,E=1/x,C=1/S,M=A.length-1;M>=0;M--){var P=A[M],R=P.region,B=P.atlasRegionOffset,D=P.atlasRegion,L=P.id,N=P.pivot,W=new wo(_,w,R?g.set(R.x,R.y,R.w,R.h):void 0,N?v.set(N.x,N.y):void 0,void 0,P.name);if(W.atlasRegion.set(D.x*E,D.y*C,D.w*E,D.h*C),P.atlasRotated&&(W.atlasRotated=!0),B){var I=B.x,V=B.y,se=B.z,Z=B.w;W.atlasRegionOffset.set(I*E,V*C,se*E,Z*C)}L!==void 0&&(W._assetID=L),p._addSprite(W)}}s(p)})}).catch(function(c){l(c)})})},o}(st));var Wc,Xc;Wc=Tt(Xe.Env,["env"]),Wc(Xc=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.load=function(e,r){var a=this;return new ot(function(s,l){a.request(e.url,{type:"arraybuffer"}).then(function(c){var u,h=new Float32Array(c,0,27),d=27*4,f=(u=new Uint16Array(c,d,1))===null||u===void 0?void 0:u[0],_=new jt(r.engine,f);_.filterMode=Ut.Trilinear;for(var g=_.mipmapCount,v=d+2,p=0;p<g;p++)for(var m=f>>p,y=0;y<6;y++){var x=m*m*4,S=new Uint8Array(c,v,x);v+=x,_.setPixelBuffer(It.PositiveX+y,S,p)}var w=new Jt,b=new bd;w.diffuseMode=rn.SphericalHarmonics,b.copyFromArray(h),w.diffuseSphericalHarmonics=b,w.specularTexture=_,w.specularTextureDecodeRGBM=!0,s(w)}).catch(function(c){l(c)})})},o}(st));var jc,$c,fe,Ui=Math.PI;jc=Tt(Xe.HDR,["hdr"]),jc($c=(fe=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}o._convertToCubemap=function(e,r,a,s){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=r*a*4)throw"ConvertPanoramaToCubemap: input size is wrong";var l=this._createCubemapData(s,this._faceRight,e,r,a),c=this._createCubemapData(s,this._faceLeft,e,r,a),u=this._createCubemapData(s,this._faceUp,e,r,a),h=this._createCubemapData(s,this._faceBottom,e,r,a),d=this._createCubemapData(s,this._faceFront,e,r,a),f=this._createCubemapData(s,this._faceBack,e,r,a);return[l,c,u,h,d,f]},o._createCubemapData=function(e,r,a,s,l){for(var c=new Uint8ClampedArray(e*e*4),u=this._tempVector3.set(0,0,0).add(r[1]).subtract(r[0]).scale(1/e),h=this._temp2Vector3.set(0,0,0).add(r[3]).subtract(r[2]).scale(1/e),d=1/e,f=0,_=0;_<e;_++){for(var g=this._temp3Vector3.set(0,0,0).add(r[0]),v=this._temp4Vector3.set(0,0,0).add(r[2]),p=0;p<e;p++){var m=this._temp5Vector3.set(0,0,0).add(v).subtract(g).scale(f).add(g);m.normalize();var y=this._calcProjectionSpherical(m,a,s,l);this._RGBEToLinear(y),this._linearToRGBM(y,5);var x=_*e*4+p*4;c[x]=y.r,c[x+1]=y.g,c[x+2]=y.b,c[x+3]=y.a,g.add(u),v.add(h)}f+=d}return c},o._calcProjectionSpherical=function(e,r,a,s){for(var l=Math.atan2(e.z,-e.x),c=Math.acos(e.y);l<-Ui;)l+=2*Ui;for(;l>Ui;)l-=2*Ui;var u=l/Ui,h=c/Ui;u=u*.5+.5;var d=Math.round(u*a);d<0?d=0:d>=a&&(d=a-1);var f=Math.round(h*s);f<0?f=0:f>=s&&(f=s-1);var _=s-f-1,g=_*a*4+d*4,v=r[g],p=r[g+1],m=r[g+2],y=r[g+3];return new oe(v,p,m,y)},o._readStringLine=function(e,r){for(var a="",s="",l=r;l<e.length-r&&(s=String.fromCharCode(e[l]),s!=`
`);l++)a+=s;return a},o._parseHeader=function(e){var r=0,a=0,s=this._readStringLine(e,0);if(s[0]!="#"||s[1]!="?")throw"Bad HDR Format.";var l=!1,c=!1,u=0;do u+=s.length+1,s=this._readStringLine(e,u),s=="FORMAT=32-bit_rle_rgbe"?c=!0:s.length==0&&(l=!0);while(!l);if(!c)throw"HDR Bad header format, unsupported FORMAT";u+=s.length+1,s=this._readStringLine(e,u);var h=/^\-Y (.*) \+X (.*)$/g,d=h.exec(s);if(!d||d.length<3)throw"HDR Bad header format, no size";if(a=parseInt(d[2]),r=parseInt(d[1]),a<8||a>32767)throw"HDR Bad header format, unsupported size";return u+=s.length+1,{height:r,width:a,dataPosition:u}},o._readPixels=function(e,r,a){for(var s=r,l=e.byteLength,c=new Uint8Array(4*r*a),u=0,h=0,d=4*s,f=new Uint8Array(4),_=new Uint8Array(d),g=a;g>0&&h<l;){if(f[0]=e[h++],f[1]=e[h++],f[2]=e[h++],f[3]=e[h++],f[0]!=2||f[1]!=2||(f[2]<<8|f[3])!=s)throw"HDR Bad header format, wrong scan line width";for(var v=0,p=void 0;v<d&&h<l;){p=e[h++];var m=p>128;if(m&&(p-=128),p===0||v+p>d)throw"HDR Bad Format, bad scanline data (run)";if(m)for(var y=e[h++],x=0;x<p;x++)_[v++]=y;else _.set(e.subarray(h,h+p),v),v+=p,h+=p}for(var S=s,w=0;w<S;w++){var b=0;c[u]=_[w+b],b+=s,c[u+1]=_[w+b],b+=s,c[u+2]=_[w+b],b+=s,c[u+3]=_[w+b],u+=4}g--}return c},o._RGBEToLinear=function(e){var r=Math.pow(2,e.a-128)/255;e.r*=r,e.g*=r,e.b*=r,e.a=1},o._linearToRGBM=function(e,r){var a=Math.max(e.r,Math.max(e.g,e.b)),s=Math.min(a/r,1);s=Math.ceil(s*255);var l=65025/(s*r);e.r*=l,e.g*=l,e.b*=l,e.a*=s};var n=o.prototype;return n.load=function(e,r){var a=this;return new ot(function(s,l){var c=r.engine;a.request(e.url,{type:"arraybuffer"}).then(function(u){for(var h=new Uint8Array(u),d=o._parseHeader(h),f=d.width,_=d.height,g=d.dataPosition,v=o._readPixels(h.subarray(g),f,_),p=_>>1,m=o._convertToCubemap(v,f,_,p),y=new jt(c,p),x=0;x<6;x++)y.setPixelBuffer(It.PositiveX+x,m[x],0);y.generateMipmaps(),s(y)}).catch(l)})},o}(st),fe._rightBottomBack=new T(1,-1,-1),fe._rightBottomFront=new T(1,-1,1),fe._rightUpBack=new T(1,1,-1),fe._rightUpFront=new T(1,1,1),fe._leftBottomBack=new T(-1,-1,-1),fe._leftBottomFront=new T(-1,-1,1),fe._leftUpBack=new T(-1,1,-1),fe._leftUpFront=new T(-1,1,1),fe._faceRight=[fe._rightBottomBack,fe._rightBottomFront,fe._rightUpBack,fe._rightUpFront],fe._faceLeft=[fe._leftBottomFront,fe._leftBottomBack,fe._leftUpFront,fe._leftUpBack],fe._faceUp=[fe._leftBottomFront,fe._rightBottomFront,fe._leftBottomBack,fe._rightBottomBack],fe._faceBottom=[fe._leftUpBack,fe._rightUpBack,fe._leftUpFront,fe._rightUpFront],fe._faceFront=[fe._leftBottomBack,fe._rightBottomBack,fe._leftUpBack,fe._rightUpBack],fe._faceBack=[fe._rightBottomFront,fe._leftBottomFront,fe._rightUpFront,fe._leftUpFront],fe._tempVector3=new T,fe._temp2Vector3=new T,fe._temp3Vector3=new T,fe._temp4Vector3=new T,fe._temp5Vector3=new T,fe));var _i=function(){function i(){}var o=i.prototype;return o.initialize=function(){},o.parseEngineResource=function(t,e,r){},o.createEngineResource=function(t,e){return null},i}(),qc,Yc,Ba;qc=di("KHR_draco_mesh_compression"),qc(Yc=(Ba=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.initialize=function(){o._decoder||(o._decoder=new Cv)},n.createEngineResource=function(e,r,a){var s=r.gltf,l=r.buffers,c=s.bufferViews,u=s.accessors,h=e.bufferView,d=e.attributes,f={},_={};for(var g in d)f[g]=d[g];for(var v in a.attributes)if(d[v]!==void 0){var p=u[a.attributes[v]];_[v]=Pe.getComponentType(p.componentType).name}var m=u[a.indices],y=Pe.getComponentType(m.componentType).name,x={attributeIDs:f,attributeTypes:_,useUniqueIDs:!0,indexType:y},S=Pe.getBufferViewData(c[h],l);return o._decoder.decode(S,x).then(function(w){return w})},o}(_i),Ba._decoder=void 0,Ba));var Qc,Jc;Qc=di("KHR_lights_punctual"),Qc(Jc=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.parseEngineResource=function(e,r,a){var s=e.color,l=e.intensity,c=l===void 0?1:l,u=e.type,h=e.range,d=e.spot,f;if(u==="directional"?f=r.addComponent(mr):u==="point"?f=r.addComponent(kr):u==="spot"&&(f=r.addComponent(Qt)),s&&f.color.set(s[0],s[1],s[2],1),f.intensity=c,h&&!(f instanceof mr)&&(f.distance=h),d&&f instanceof Qt){var _=d.innerConeAngle,g=_===void 0?0:_,v=d.outerConeAngle,p=v===void 0?Math.PI/4:v;f.angle=g,f.penumbra=p-g}a.lights||(a.lights=[]),a.lights.push(f)},o}(_i));var Zc,Kc;Zc=di("KHR_materials_clearcoat"),Zc(Kc=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.parseEngineResource=function(e,r,a){var s=a.textures,l=e.clearcoatFactor,c=l===void 0?0:l,u=e.clearcoatTexture,h=e.clearcoatRoughnessFactor,d=h===void 0?0:h,f=e.clearcoatRoughnessTexture,_=e.clearcoatNormalTexture;r.clearCoat=c,r.clearCoatRoughness=d,u&&(r.clearCoatTexture=s[u.index],Zi._parseTextureTransform(r,u.extensions,a)),f&&(r.clearCoatRoughnessTexture=s[f.index],Zi._parseTextureTransform(r,f.extensions,a)),_&&(r.clearCoatNormalTexture=s[_.index],Zi._parseTextureTransform(r,_.extensions,a))},o}(_i));var eu,tu;eu=di("KHR_materials_pbrSpecularGlossiness"),eu(tu=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.createEngineResource=function(e,r){var a=r.engine,s=r.textures,l=new hi(a),c=e.diffuseFactor,u=e.diffuseTexture,h=e.specularFactor,d=e.glossinessFactor,f=e.specularGlossinessTexture;return c&&(l.baseColor=new oe(oe.linearToGammaSpace(c[0]),oe.linearToGammaSpace(c[1]),oe.linearToGammaSpace(c[2]),c[3])),u&&(l.baseTexture=s[u.index],Zi._parseTextureTransform(l,u.extensions,r)),h&&(l.specularColor=new oe(oe.linearToGammaSpace(h[0]),oe.linearToGammaSpace(h[1]),oe.linearToGammaSpace(h[2]))),d!==void 0&&(l.glossiness=d),f&&(l.specularGlossinessTexture=s[f.index],Zi._parseTextureTransform(l,f.extensions,r)),l},o}(_i));var ru,iu;ru=di("KHR_materials_unlit"),ru(iu=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.createEngineResource=function(e,r){var a=r.engine,s=new ai(a);return s},o}(_i));var nu,au;nu=di("KHR_materials_variants"),nu(au=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.parseEngineResource=function(e,r,a){for(var s=a.gltf.extensions.KHR_materials_variants.variants,l=a.materials,c=e.mappings,u=0;u<c.length;u++){var h=c[u],d=h.material,f=h.variants;a.variants||(a.variants=[]),a.variants.push({renderer:r,material:l[d],variants:f.map(function(_){return s[_].name})})}},o}(_i));var ou,su;ou=di("KHR_mesh_quantization"),ou(su=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}return o}(_i));var lu,cu;lu=di("KHR_texture_transform"),lu(cu=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.parseEngineResource=function(e,r,a){var s=e.offset,l=e.rotation,c=e.scale,u=e.texCoord;s&&(r.tilingOffset.z=s[0],r.tilingOffset.w=s[1]),c&&(r.tilingOffset.x=c[0],r.tilingOffset.y=c[1]),l&&me.warn("rotation in KHR_texture_transform is not supported now"),u&&me.warn("texCoord in KHR_texture_transform is not supported now")},o}(_i));var uu,hu;uu=Tt(Xe.Material,["json"]),uu(hu=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.load=function(e,r){var a=this;return new ot(function(s,l){a.request(e.url,rt(rt({},e),{},{type:"json"})).then(function(c){var u=r.engine,h=c.shader,d=c.shaderData,f=c.macros,_=c.renderState,g;switch(h){case"pbr":g=new Li(u);break;case"pbr-specular":g=new hi(u);break;case"unlit":g=new ai(u);break;case"blinn-phong":g=new on(u);break}var v=g.shaderData,p=function(C){var M=d[C],P=M.type,R=M.value;switch(P){case"Vector2":v.setVector2(C,new q(R.x,R.y));break;case"Vector3":v.setVector3(C,new T(R.x,R.y,R.z));break;case"Vector4":v.setVector4(C,new Ve(R.x,R.y,R.z,R.w));break;case"Color":v.setColor(C,new oe(R.r,R.g,R.b,R.a));break;case"Float":v.setFloat(C,R);break;case"Texture":r.getResourceByRef(R).then(function(B){v.setTexture(C,B)});break}};for(var m in d)p(m);for(var y=0,x=f.length;y<x;y++){var S=f[y],w=S.name,b=S.value;b==null?v.enableMacro(w):v.enableMacro(w,b)}for(var A in _)v[A]=_[A];s(g)})})},o}(st));var ed=function(){function i(n,t,e,r){t===void 0&&(t=0),r===void 0&&(r=!0),this.buffer=n,this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(n),this._littleEndian=r,this._offset=t}var o=i.prototype;return o.nextUint8=function(){var t=this._dataView.getUint8(this._offset);return this._offset+=1,t},o.nextUint16=function(){var t=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,t},o.nextUint32=function(){var t=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,t},o.nextInt32=function(){var t=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,t},o.nextInt32Array=function(t){var e=new Int32Array(this.buffer,this._offset,t);return this._offset+=4*t,e},o.nextFloat32=function(){var t=this._dataView.getFloat32(this._offset,this._littleEndian);return this._offset+=4,t},o.nextFloat32Array=function(t){var e=new Float32Array(this.buffer,this._offset,t);return this._offset+=4*t,e},o.nextUint32Array=function(t){var e=new Uint32Array(this.buffer,this._offset,t);return this._offset+=4*t,e},o.nextUint8Array=function(t){var e=new Uint8Array(this.buffer,this._offset,t);return this._offset+=t,e},o.nextUint64=function(){var t=this._dataView.getUint32(this._offset,this._littleEndian),e=this._dataView.getUint32(this._offset+4,this._littleEndian),r=t+Math.pow(2,32)*e;return this._offset+=8,r},o.nextStr=function(){var t=this.nextUint16(),e=new Uint8Array(this.buffer,this._offset,t);return this._offset+=t,Pe.decodeText(e)},o.nextImageData=function(t){return this.buffer.slice(this._offset)},o.nextImagesData=function(t){for(var e=new Array(t),r=0;r<t;r++){var a=this._dataView.getUint32(this._offset,this._littleEndian);e[r]=a,this._offset+=4}for(var s=[],l=0;l<t;l++){var c=e[l],u=this.buffer.slice(this._offset,this._offset+c);this._offset+=c,s.push(u)}return s},o.skip=function(t){return this._offset+=t,this},o.scan=function(t,e){e===void 0&&(e=0);for(var r=this._offset,a=0;this._dataView.getUint8(this._offset)!==e&&a<t;)a++,this._offset++;return a<t&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+r,a)},$h(i,[{key:"offset",get:function(){return this._offset}}]),i}();ed.imageMapping={0:"image/png",1:"image/jpg",2:"image/webp",3:"ktx"};var td={};function rd(i){return function(o){td[i]=o}}var Vv=function(){function i(){this.totalLength=0,this.version=0,this.type="",this.name="",this.headerLength=0}return i.decode=function(n){var t=new DataView(n),e=t.getUint32(0,!0),r=t.getUint8(4),a=t.getUint16(5,!0),s=new Uint8Array(n,7,a),l=t.getUint16(7+a,!0),c=new Uint8Array(n,9+a,l),u=Pe.decodeText(c),h=Pe.decodeText(s),d=new i;return d.totalLength=e,d.name=u,d.type=h,d.version=r,d.headerLength=c.byteLength+s.byteLength+9,d},$h(i,[{key:"dataLength",get:function(){return this.totalLength-this.headerLength}}]),i}(),du,_u;du=rd("Mesh"),du(_u=function(){function i(){}return i.decode=function(n,t){return new Promise(function(e){var r=new Wt(n),a=t.nextStr(),s=JSON.parse(a),l=Math.ceil(t.offset/4)*4,c=new Float32Array(t.buffer,s.positions.start+l,(s.positions.end-s.positions.start)/4),u=c.length/3,h=jn(c,u);if(r.setPositions(h),s.normals){var d=new Float32Array(t.buffer,s.normals.start+l,(s.normals.end-s.normals.start)/4),f=jn(d,u);r.setNormals(f)}if(s.uvs){var _=new Float32Array(t.buffer,s.uvs.start+l,(s.uvs.end-s.uvs.start)/4);r.setUVs(qr(_,u))}if(s.uv1){var g=new Float32Array(t.buffer,s.uv1.start+l,(s.uv1.end-s.uv1.start)/4);r.setUVs(qr(g,u),1)}if(s.uv2){var v=new Float32Array(t.buffer,s.uv2.start+l,(s.uv2.end-s.uv2.start)/4);r.setUVs(qr(v,u),2)}if(s.uv3){var p=new Float32Array(t.buffer,s.uv3.start+l,(s.uv3.end-s.uv3.start)/4);r.setUVs(qr(p,u),3)}if(s.uv4){var m=new Float32Array(t.buffer,s.uv4.start+l,(s.uv4.end-s.uv4.start)/4);r.setUVs(qr(m,u),4)}if(s.uv5){var y=new Float32Array(t.buffer,s.uv5.start+l,(s.uv5.end-s.uv5.start)/4);r.setUVs(qr(y,u),5)}if(s.uv6){var x=new Float32Array(t.buffer,s.uv6.start+l,(s.uv6.end-s.uv6.start)/4);r.setUVs(qr(x,u),6)}if(s.uv7){var S=new Float32Array(t.buffer,s.uv7.start+l,(s.uv7.end-s.uv7.start)/4);r.setUVs(qr(S,u),7)}if(s.colors){var w=new Float32Array(t.buffer,s.colors.start+l,(s.colors.end-s.colors.start)/4);r.setColors(Gv(w,u))}if(s.boneWeights){var b=new Float32Array(t.buffer,s.boneWeights.start+l,(s.boneWeights.end-s.boneWeights.start)/4);r.setBoneWeights(Da(b,u))}if(s.boneIndices){var A=new Float32Array(t.buffer,s.boneIndices.start+l,(s.boneIndices.end-s.boneIndices.start)/4);r.setBoneIndices(Da(A,u))}if(s.blendShapes&&s.blendShapes.forEach(function(C){var M=new xo(C.name);C.frames.forEach(function(P){var R=new Float32Array(t.buffer,P.deltaPosition.start+l,(P.deltaPosition.end-P.deltaPosition.start)/4),B=R.length/3,D=jn(R,B);if(P.deltaNormals){var L=new Float32Array(t.buffer,P.deltaNormals.start+l,(P.deltaNormals.end-P.deltaNormals.start)/4);jn(L,B)}if(P.deltaTangents){var N=new Float32Array(t.buffer,P.deltaTangents.start+l,(P.deltaTangents.end-P.deltaTangents.start)/4);Da(N,B)}M.addFrame(P.weight,D)}),r.addBlendShape(M)}),s.indices){var E=null;s.indices.type===0?E=new Uint16Array(t.buffer,s.indices.start+l,(s.indices.end-s.indices.start)/2):E=new Uint32Array(t.buffer,s.indices.start+l,(s.indices.end-s.indices.start)/4),r.setIndices(E)}s.subMeshes.forEach(function(C){r.addSubMesh(C)}),r.uploadData(!1),e(r)})},i}());function Gv(i,o){for(var n=new Array(o),t=0;t<o;t++)n[t]=new oe(i[t*4],i[t*4+1],i[t*4+2],i[t*4+3]);return n}function Da(i,o){for(var n=new Array(o),t=0;t<o;t++)n[t]=new Ve(i[t*4],i[t*4+1],i[t*4+2],i[t*4+3]);return n}function jn(i,o){for(var n=new Array(o),t=0;t<o;t++)n[t]=new T(i[t*3],i[t*3+1],i[t*3+2]);return n}function qr(i,o){for(var n=new Array(o),t=0;t<o;t++)n[t]=new q(i[t*2],i[t*2+1]);return n}var fu,vu;fu=rd("Texture2D"),fu(vu=function(){function i(){}return i.decode=function(n,t){return new Promise(function(e,r){var a=t.nextStr(),s=!!t.nextUint8(),l=t.nextUint8(),c=t.nextUint8(),u=t.nextUint8(),h=t.nextUint8(),d=t.nextUint8(),f=t.nextUint16(),_=t.nextUint16(),g=t.nextUint8(),v=t.nextUint8(),p=t.nextImagesData(v),m=new Ct(n,f,_,d,s);if(m.filterMode=l,m.anisoLevel=c,m.wrapModeU=u,m.wrapModeV=h,g){var y=new Uint8Array(p[0]);if(m.setPixelBuffer(y),s){m.generateMipmaps();for(var x=1;x<v;x++){var S=new Uint8Array(p[x]);m.setPixelBuffer(S,x)}}n.resourceManager._objectPool[a]=m,e(m)}else{var w=new window.Blob([p[0]]),b=new Image;b.src=URL.createObjectURL(w),b.onload=function(){m.setImageSource(b);var A=0,E=function(){A++,A>=v&&e(m)};if(E(),s){m.generateMipmaps();for(var C=function(R){var B=new window.Blob([p[R]]),D=new Image;D.src=URL.createObjectURL(B),D.onload=function(){m.setImageSource(D,R),E()}},M=1;M<v;M++)C(M)}}}})},i}());var id=function(){function i(){}return i.parseEntity=function(n,t){var e=this;return i.getEntityByConfig(n,t).then(function(r){var a;r.isActive=(a=n.isActive)!=null?a:!0;var s=n.position,l=n.rotation,c=n.scale;s&&r.transform.setPosition(s.x,s.y,s.z),l&&r.transform.setRotation(l.x,l.y,l.z),c&&r.transform.setScale(c.x,c.y,c.z);for(var u=[],h=0;h<n.components.length;h++){var d=n.components[h],f=d.refId?d.refId:d.class,_=r.addComponent(st.getClass(f)),g=e.parsePropsAndMethods(_,d,t);u.push(g)}return Promise.all(u).then(function(){return r})})},i.getEntityByConfig=function(n,t){var e=n.assetRefId;if(e)return t.resourceManager.getResourceByRef({refId:e,key:n.key});var r=new Lr(t,n.name);return Promise.resolve(r)},i.parseClassObject=function(n,t,e){var r;e===void 0&&(e=t.resourceManager);var a=st.getClass(n.class),s=(r=n.constructParams)!=null?r:[],l=Kn(a,s);return this.parsePropsAndMethods(l,n,t,e)},i.parseBasicType=function(n,t,e){var r=this;return e===void 0&&(e=t.resourceManager),Array.isArray(n)?Promise.all(n.map(function(a){return r.parseBasicType(a,t,e)})):typeof n=="object"?this._isClass(n)?this.parseClassObject(n,t,e):this._isRef(n)?e.getResourceByRef(n):Promise.resolve(n):Promise.resolve(n)},i.parsePropsAndMethods=function(n,t,e,r){var a=this;r===void 0&&(r=e.resourceManager);var s=[];if(t.methods)for(var l in t.methods)for(var c=t.methods[l],u=0,h=c.length;u<h;u++){var d=c[u],f=this.parseMethod(n,l,d,e,r);s.push(f)}if(t.props){var _=function(p){var m=t.props[p],y=a.parseBasicType(m,e).then(function(x){return n[p]=x});s.push(y)};for(var g in t.props)_(g)}return Promise.all(s).then(function(){return n})},i.parseMethod=function(n,t,e,r,a){var s=this;return a===void 0&&(a=r.resourceManager),Promise.all(e.map(function(l){return s.parseBasicType(l,r,a)})).then(function(l){return n[t].apply(n,l)})},i._isClass=function(n){return"class"in n},i._isRef=function(n){return"refId"in n},i}(),Hv=function(){function i(n){this._engine=n}var o=i.prototype;return o.parse=function(t){for(var e={},r={},a=[],s=t.entities,l=qh(s),c;!(c=l()).done;){var u=c.value;r[u.id]=u,a.push(id.parseEntity(u,this._engine))}return Promise.all(a).then(function(h){var d=s[0].id;return h.forEach(function(f,_){e[s[_].id]=f}),i.parseChildren(r,e,d),e[d]})},i.parseChildren=function(t,e,r){var a=t[r].children;if(a&&a.length>0)for(var s=e[r],l=0;l<a.length;l++){var c=a[l],u=e[c];s.addChild(u),this.parseChildren(t,e,c)}},i}(),Wv=function(){function i(){}return i.parse=function(n,t){for(var e=new Nr(n),r={},a={},s=[],l=t.entities,c=qh(l),u;!(u=c()).done;){var h=u.value;a[h.id]=h,s.push(id.parseEntity(h,n))}return Promise.all(s).then(function(d){var f=[];d.forEach(function(y,x){r[l[x].id]=y,l[x].parent||f.push(l[x].id)});for(var _=0,g=f;_<g.length;_++){var v=g[_];Hv.parseChildren(a,r,v)}for(var p=f.map(function(y){return r[y]}),m=0;m<p.length;m++)e.addRootEntity(p[m]);return e})},i}(),pu,gu;pu=Tt("Mesh",["prefab"],!0),pu(gu=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.load=function(e,r){var a=this;return new ot(function(s,l){a.request(e.url,{type:"arraybuffer"}).then(function(c){Po(c,r.engine).then(function(u){s(u)})})})},o}(st));var mu,yu;mu=Tt("EditorTexture2D",["prefab"],!0),mu(yu=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.load=function(e,r){var a=this;return new ot(function(s){a.request(e.url,{type:"arraybuffer"}).then(function(l){Po(l,r.engine).then(function(c){s(c)})})})},o}(st));function Po(i,o){var n=Vv.decode(i),t=new ed(i,n.headerLength,n.dataLength);return td[n.type].decode(o,t).then(function(e){return e.name=n.name,e})}var xu,bu;xu=Tt(Xe.Mesh,["mesh"]),xu(bu=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.load=function(e,r){var a=this;return new ot(function(s){a.request(e.url,rt(rt({},e),{},{type:"arraybuffer"})).then(function(l){return Po(l,r.engine)}).then(function(l){s(l)})})},o}(st));var wu,Su;wu=Tt(Xe.Scene,["prefab"],!0),wu(Su=function(i){Re(o,i);function o(){return i.apply(this,arguments)||this}var n=o.prototype;return n.load=function(e,r){var a=this,s=r.engine;return new ot(function(l,c){return a.request(e.url,{type:"json"}).then(function(u){return s.resourceManager.initVirtualResources(u.files),Wv.parse(s,u).then(function(h){var d=u.scene.ambient;d.ambientLight&&r.getResourceByRef(u.scene.ambient.ambientLight).then(function(_){h.ambientLight=_,h.ambientLight.diffuseIntensity=d.diffuseIntensity,h.ambientLight.specularIntensity=d.specularIntensity});var f=u.scene.background;switch(h.background.mode=f.mode,h.background.mode){case rr.SolidColor:h.background.solidColor.copyFrom(f.color);break;case rr.Sky:f.sky&&r.getResourceByRef(f.sky).then(function(_){var g=h.background.sky,v=new Co(s);v.textureCubeMap=_.specularTexture,v.textureDecodeRGBM=!0,g.material=v,g.mesh=vn.createCuboid(s,1,1,1)});break;case rr.Texture:f.texture&&r.getResourceByRef(f.texture).then(function(_){h.background.texture=_});break}l(h)})})})},o}(st));var Xv="0.8.0-beta.21";console.log("oasis engine version: "+Xv);for(var Cu in fc)st.registerClass(Cu,fc[Cu]);var Tu=[0,1,2,3,4,4,5,5,6,6,6,6,7,7,7,7,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,0,0,16,17,18,18,19,19,20,20,20,20,21,21,21,21,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29];function Ye(){var i=this;function o(n,t){var e=0;do e|=1&n,n>>>=1,e<<=1;while(--t>0);return e>>>1}i.build_tree=function(n){var t,e,r,a=i.dyn_tree,s=i.stat_desc.static_tree,l=i.stat_desc.elems,c=-1;for(n.heap_len=0,n.heap_max=573,t=0;t<l;t++)a[2*t]!==0?(n.heap[++n.heap_len]=c=t,n.depth[t]=0):a[2*t+1]=0;for(;n.heap_len<2;)a[2*(r=n.heap[++n.heap_len]=c<2?++c:0)]=1,n.depth[r]=0,n.opt_len--,s&&(n.static_len-=s[2*r+1]);for(i.max_code=c,t=Math.floor(n.heap_len/2);t>=1;t--)n.pqdownheap(a,t);r=l;do t=n.heap[1],n.heap[1]=n.heap[n.heap_len--],n.pqdownheap(a,1),e=n.heap[1],n.heap[--n.heap_max]=t,n.heap[--n.heap_max]=e,a[2*r]=a[2*t]+a[2*e],n.depth[r]=Math.max(n.depth[t],n.depth[e])+1,a[2*t+1]=a[2*e+1]=r,n.heap[1]=r++,n.pqdownheap(a,1);while(n.heap_len>=2);n.heap[--n.heap_max]=n.heap[1],function(u){var h,d,f,_,g,v,p=i.dyn_tree,m=i.stat_desc.static_tree,y=i.stat_desc.extra_bits,x=i.stat_desc.extra_base,S=i.stat_desc.max_length,w=0;for(_=0;_<=15;_++)u.bl_count[_]=0;for(p[2*u.heap[u.heap_max]+1]=0,h=u.heap_max+1;h<573;h++)(_=p[2*p[2*(d=u.heap[h])+1]+1]+1)>S&&(_=S,w++),p[2*d+1]=_,d>i.max_code||(u.bl_count[_]++,g=0,d>=x&&(g=y[d-x]),u.opt_len+=(v=p[2*d])*(_+g),m&&(u.static_len+=v*(m[2*d+1]+g)));if(w!==0){do{for(_=S-1;u.bl_count[_]===0;)_--;u.bl_count[_]--,u.bl_count[_+1]+=2,u.bl_count[S]--,w-=2}while(w>0);for(_=S;_!==0;_--)for(d=u.bl_count[_];d!==0;)(f=u.heap[--h])>i.max_code||(p[2*f+1]!=_&&(u.opt_len+=(_-p[2*f+1])*p[2*f],p[2*f+1]=_),d--)}}(n),function(u,h,d){var f,_,g,v=[],p=0;for(f=1;f<=15;f++)v[f]=p=p+d[f-1]<<1;for(_=0;_<=h;_++)(g=u[2*_+1])!==0&&(u[2*_]=o(v[g]++,g))}(a,i.max_code,n.bl_count)}}function xt(i,o,n,t,e){var r=this;r.static_tree=i,r.extra_bits=o,r.extra_base=n,r.elems=t,r.max_length=e}function Cr(i,o,n,t,e){var r=this;r.good_length=i,r.max_lazy=o,r.nice_length=n,r.max_chain=t,r.func=e}Ye._length_code=[0,1,2,3,4,5,6,7,8,8,9,9,10,10,11,11,12,12,12,12,13,13,13,13,14,14,14,14,15,15,15,15,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28],Ye.base_length=[0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,0],Ye.base_dist=[0,1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,256,384,512,768,1024,1536,2048,3072,4096,6144,8192,12288,16384,24576],Ye.d_code=function(i){return i<256?Tu[i]:Tu[256+(i>>>7)]},Ye.extra_lbits=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],Ye.extra_dbits=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Ye.extra_blbits=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Ye.bl_order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],xt.static_ltree=[12,8,140,8,76,8,204,8,44,8,172,8,108,8,236,8,28,8,156,8,92,8,220,8,60,8,188,8,124,8,252,8,2,8,130,8,66,8,194,8,34,8,162,8,98,8,226,8,18,8,146,8,82,8,210,8,50,8,178,8,114,8,242,8,10,8,138,8,74,8,202,8,42,8,170,8,106,8,234,8,26,8,154,8,90,8,218,8,58,8,186,8,122,8,250,8,6,8,134,8,70,8,198,8,38,8,166,8,102,8,230,8,22,8,150,8,86,8,214,8,54,8,182,8,118,8,246,8,14,8,142,8,78,8,206,8,46,8,174,8,110,8,238,8,30,8,158,8,94,8,222,8,62,8,190,8,126,8,254,8,1,8,129,8,65,8,193,8,33,8,161,8,97,8,225,8,17,8,145,8,81,8,209,8,49,8,177,8,113,8,241,8,9,8,137,8,73,8,201,8,41,8,169,8,105,8,233,8,25,8,153,8,89,8,217,8,57,8,185,8,121,8,249,8,5,8,133,8,69,8,197,8,37,8,165,8,101,8,229,8,21,8,149,8,85,8,213,8,53,8,181,8,117,8,245,8,13,8,141,8,77,8,205,8,45,8,173,8,109,8,237,8,29,8,157,8,93,8,221,8,61,8,189,8,125,8,253,8,19,9,275,9,147,9,403,9,83,9,339,9,211,9,467,9,51,9,307,9,179,9,435,9,115,9,371,9,243,9,499,9,11,9,267,9,139,9,395,9,75,9,331,9,203,9,459,9,43,9,299,9,171,9,427,9,107,9,363,9,235,9,491,9,27,9,283,9,155,9,411,9,91,9,347,9,219,9,475,9,59,9,315,9,187,9,443,9,123,9,379,9,251,9,507,9,7,9,263,9,135,9,391,9,71,9,327,9,199,9,455,9,39,9,295,9,167,9,423,9,103,9,359,9,231,9,487,9,23,9,279,9,151,9,407,9,87,9,343,9,215,9,471,9,55,9,311,9,183,9,439,9,119,9,375,9,247,9,503,9,15,9,271,9,143,9,399,9,79,9,335,9,207,9,463,9,47,9,303,9,175,9,431,9,111,9,367,9,239,9,495,9,31,9,287,9,159,9,415,9,95,9,351,9,223,9,479,9,63,9,319,9,191,9,447,9,127,9,383,9,255,9,511,9,0,7,64,7,32,7,96,7,16,7,80,7,48,7,112,7,8,7,72,7,40,7,104,7,24,7,88,7,56,7,120,7,4,7,68,7,36,7,100,7,20,7,84,7,52,7,116,7,3,8,131,8,67,8,195,8,35,8,163,8,99,8,227,8],xt.static_dtree=[0,5,16,5,8,5,24,5,4,5,20,5,12,5,28,5,2,5,18,5,10,5,26,5,6,5,22,5,14,5,30,5,1,5,17,5,9,5,25,5,5,5,21,5,13,5,29,5,3,5,19,5,11,5,27,5,7,5,23,5],xt.static_l_desc=new xt(xt.static_ltree,Ye.extra_lbits,257,286,15),xt.static_d_desc=new xt(xt.static_dtree,Ye.extra_dbits,0,30,15),xt.static_bl_desc=new xt(null,Ye.extra_blbits,0,19,7);var ur=[new Cr(0,0,0,0,0),new Cr(4,4,8,4,1),new Cr(4,5,16,8,1),new Cr(4,6,32,32,1),new Cr(4,4,16,16,2),new Cr(8,16,32,32,2),new Cr(8,16,128,128,2),new Cr(8,32,128,256,2),new Cr(32,128,258,1024,2),new Cr(32,258,258,4096,2)],$n=["need dictionary","stream end","","","stream error","data error","","buffer error","",""];function Au(i,o,n,t){var e=i[2*o],r=i[2*n];return e<r||e==r&&t[o]<=t[n]}function jv(){var i,o,n,t,e,r,a,s,l,c,u,h,d,f,_,g,v,p,m,y,x,S,w,b,A,E,C,M,P,R,B,D,L,N,W,I,V,se,Z,Y,ue,ie=this,be=new Ye,ye=new Ye,Fe=new Ye;function Qe(){var $;for($=0;$<286;$++)B[2*$]=0;for($=0;$<30;$++)D[2*$]=0;for($=0;$<19;$++)L[2*$]=0;B[512]=1,ie.opt_len=ie.static_len=0,I=se=0}function Be($,X){var Q,K,j=-1,le=$[1],he=0,we=7,Ie=4;for(le===0&&(we=138,Ie=3),$[2*(X+1)+1]=65535,Q=0;Q<=X;Q++)K=le,le=$[2*(Q+1)+1],++he<we&&K==le||(he<Ie?L[2*K]+=he:K!==0?(K!=j&&L[2*K]++,L[32]++):he<=10?L[34]++:L[36]++,he=0,j=K,le===0?(we=138,Ie=3):K==le?(we=6,Ie=3):(we=7,Ie=4))}function Oe($){ie.pending_buf[ie.pending++]=$}function Ge($){Oe(255&$),Oe($>>>8&255)}function Ae($,X){var Q,K=X;ue>16-K?(Ge(Y|=(Q=$)<<ue&65535),Y=Q>>>16-ue,ue+=K-16):(Y|=$<<ue&65535,ue+=K)}function pe($,X){var Q=2*$;Ae(65535&X[Q],65535&X[Q+1])}function Je($,X){var Q,K,j=-1,le=$[1],he=0,we=7,Ie=4;for(le===0&&(we=138,Ie=3),Q=0;Q<=X;Q++)if(K=le,le=$[2*(Q+1)+1],!(++he<we&&K==le)){if(he<Ie)do pe(K,L);while(--he!=0);else K!==0?(K!=j&&(pe(K,L),he--),pe(16,L),Ae(he-3,2)):he<=10?(pe(17,L),Ae(he-3,3)):(pe(18,L),Ae(he-11,7));he=0,j=K,le===0?(we=138,Ie=3):K==le?(we=6,Ie=3):(we=7,Ie=4)}}function Ze(){ue==16?(Ge(Y),Y=0,ue=0):ue>=8&&(Oe(255&Y),Y>>>=8,ue-=8)}function He($,X){var Q,K,j;if(ie.pending_buf[V+2*I]=$>>>8&255,ie.pending_buf[V+2*I+1]=255&$,ie.pending_buf[N+I]=255&X,I++,$===0?B[2*X]++:(se++,$--,B[2*(Ye._length_code[X]+256+1)]++,D[2*Ye.d_code($)]++),(8191&I)==0&&C>2){for(Q=8*I,K=x-v,j=0;j<30;j++)Q+=D[2*j]*(5+Ye.extra_dbits[j]);if(Q>>>=3,se<Math.floor(I/2)&&Q<Math.floor(K/2))return!0}return I==W-1}function Ke($,X){var Q,K,j,le,he=0;if(I!==0)do Q=ie.pending_buf[V+2*he]<<8&65280|255&ie.pending_buf[V+2*he+1],K=255&ie.pending_buf[N+he],he++,Q===0?pe(K,$):(pe((j=Ye._length_code[K])+256+1,$),(le=Ye.extra_lbits[j])!==0&&Ae(K-=Ye.base_length[j],le),Q--,pe(j=Ye.d_code(Q),X),(le=Ye.extra_dbits[j])!==0&&Ae(Q-=Ye.base_dist[j],le));while(he<I);pe(256,$),Z=$[513]}function ft(){ue>8?Ge(Y):ue>0&&Oe(255&Y),Y=0,ue=0}function Ue($,X,Q){Ae(0+(Q?1:0),3),function(K,j,le){ft(),Z=8,Ge(j),Ge(~j),ie.pending_buf.set(s.subarray(K,K+j),ie.pending),ie.pending+=j}($,X)}function ke($){(function(X,Q,K){var j,le,he=0;C>0?(be.build_tree(ie),ye.build_tree(ie),he=function(){var we;for(Be(B,be.max_code),Be(D,ye.max_code),Fe.build_tree(ie),we=18;we>=3&&L[2*Ye.bl_order[we]+1]===0;we--);return ie.opt_len+=3*(we+1)+5+5+4,we}(),(le=ie.static_len+3+7>>>3)<=(j=ie.opt_len+3+7>>>3)&&(j=le)):j=le=Q+5,Q+4<=j&&X!=-1?Ue(X,Q,K):le==j?(Ae(2+(K?1:0),3),Ke(xt.static_ltree,xt.static_dtree)):(Ae(4+(K?1:0),3),function(we,Ie,lt){var ct;for(Ae(we-257,5),Ae(Ie-1,5),Ae(lt-4,4),ct=0;ct<lt;ct++)Ae(L[2*Ye.bl_order[ct]+1],3);Je(B,we-1),Je(D,Ie-1)}(be.max_code+1,ye.max_code+1,he+1),Ke(B,D)),Qe(),K&&ft()})(v>=0?v:-1,x-v,$),v=x,i.flush_pending()}function wr(){var $,X,Q,K;do{if((K=l-w-x)==0&&x===0&&w===0)K=e;else if(K==-1)K--;else if(x>=e+e-262){s.set(s.subarray(e,e+e),0),S-=e,x-=e,v-=e,Q=$=d;do X=65535&u[--Q],u[Q]=X>=e?X-e:0;while(--$!=0);Q=$=e;do X=65535&c[--Q],c[Q]=X>=e?X-e:0;while(--$!=0);K+=e}if(i.avail_in===0)return;$=i.read_buf(s,x+w,K),(w+=$)>=3&&(h=((h=255&s[x])<<g^255&s[x+1])&_)}while(w<262&&i.avail_in!==0)}function Br($){var X,Q,K=A,j=x,le=b,he=x>e-262?x-(e-262):0,we=R,Ie=a,lt=x+258,ct=s[j+le-1],Hr=s[j+le];b>=P&&(K>>=2),we>w&&(we=w);do if(s[(X=$)+le]==Hr&&s[X+le-1]==ct&&s[X]==s[j]&&s[++X]==s[j+1]){j+=2,X++;do;while(s[++j]==s[++X]&&s[++j]==s[++X]&&s[++j]==s[++X]&&s[++j]==s[++X]&&s[++j]==s[++X]&&s[++j]==s[++X]&&s[++j]==s[++X]&&s[++j]==s[++X]&&j<lt);if(Q=258-(lt-j),j=lt-258,Q>le){if(S=$,le=Q,Q>=we)break;ct=s[j+le-1],Hr=s[j+le]}}while(($=65535&c[$&Ie])>he&&--K!=0);return le<=w?le:w}ie.depth=[],ie.bl_count=[],ie.heap=[],B=[],D=[],L=[],ie.pqdownheap=function($,X){for(var Q=ie.heap,K=Q[X],j=X<<1;j<=ie.heap_len&&(j<ie.heap_len&&Au($,Q[j+1],Q[j],ie.depth)&&j++,!Au($,K,Q[j],ie.depth));)Q[X]=Q[j],X=j,j<<=1;Q[X]=K},ie.deflateInit=function($,X,Q,K,j,le){return K||(K=8),j||(j=8),le||(le=0),$.msg=null,X==-1&&(X=6),j<1||j>9||K!=8||Q<9||Q>15||X<0||X>9||le<0||le>2?-2:($.dstate=ie,a=(e=1<<(r=Q))-1,_=(d=1<<(f=j+7))-1,g=Math.floor((f+3-1)/3),s=new Uint8Array(2*e),c=[],u=[],W=1<<j+6,ie.pending_buf=new Uint8Array(4*W),n=4*W,V=Math.floor(W/2),N=3*W,C=X,M=le,function(he){return he.total_in=he.total_out=0,he.msg=null,ie.pending=0,ie.pending_out=0,o=113,t=0,be.dyn_tree=B,be.stat_desc=xt.static_l_desc,ye.dyn_tree=D,ye.stat_desc=xt.static_d_desc,Fe.dyn_tree=L,Fe.stat_desc=xt.static_bl_desc,Y=0,ue=0,Z=8,Qe(),function(){var we;for(l=2*e,u[d-1]=0,we=0;we<d-1;we++)u[we]=0;E=ur[C].max_lazy,P=ur[C].good_length,R=ur[C].nice_length,A=ur[C].max_chain,x=0,v=0,w=0,p=b=2,y=0,h=0}(),0}($))},ie.deflateEnd=function(){return o!=42&&o!=113&&o!=666?-2:(ie.pending_buf=null,u=null,c=null,s=null,ie.dstate=null,o==113?-3:0)},ie.deflateParams=function($,X,Q){var K=0;return X==-1&&(X=6),X<0||X>9||Q<0||Q>2?-2:(ur[C].func!=ur[X].func&&$.total_in!==0&&(K=$.deflate(1)),C!=X&&(E=ur[C=X].max_lazy,P=ur[C].good_length,R=ur[C].nice_length,A=ur[C].max_chain),M=Q,K)},ie.deflateSetDictionary=function($,X,Q){var K,j=Q,le=0;if(!X||o!=42)return-2;if(j<3)return 0;for(j>e-262&&(le=Q-(j=e-262)),s.set(X.subarray(le,le+j),0),x=j,v=j,h=((h=255&s[0])<<g^255&s[1])&_,K=0;K<=j-3;K++)c[K&a]=u[h=(h<<g^255&s[K+2])&_],u[h]=K;return 0},ie.deflate=function($,X){var Q,K,j,le,he,we;if(X>4||X<0)return-2;if(!$.next_out||!$.next_in&&$.avail_in!==0||o==666&&X!=4)return $.msg=$n[4],-2;if($.avail_out===0)return $.msg=$n[7],-5;if(i=$,le=t,t=X,o==42&&(K=8+(r-8<<4)<<8,(j=(C-1&255)>>1)>3&&(j=3),K|=j<<6,x!==0&&(K|=32),o=113,Oe((we=K+=31-K%31)>>8&255),Oe(255&we)),ie.pending!==0){if(i.flush_pending(),i.avail_out===0)return t=-1,0}else if(i.avail_in===0&&X<=le&&X!=4)return i.msg=$n[7],-5;if(o==666&&i.avail_in!==0)return $.msg=$n[7],-5;if(i.avail_in!==0||w!==0||X!=0&&o!=666){switch(he=-1,ur[C].func){case 0:he=function(Ie){var lt,ct=65535;for(ct>n-5&&(ct=n-5);;){if(w<=1){if(wr(),w===0&&Ie==0)return 0;if(w===0)break}if(x+=w,w=0,lt=v+ct,(x===0||x>=lt)&&(w=x-lt,x=lt,ke(!1),i.avail_out===0)||x-v>=e-262&&(ke(!1),i.avail_out===0))return 0}return ke(Ie==4),i.avail_out===0?Ie==4?2:0:Ie==4?3:1}(X);break;case 1:he=function(Ie){for(var lt,ct=0;;){if(w<262){if(wr(),w<262&&Ie==0)return 0;if(w===0)break}if(w>=3&&(ct=65535&u[h=(h<<g^255&s[x+2])&_],c[x&a]=u[h],u[h]=x),ct!==0&&(x-ct&65535)<=e-262&&M!=2&&(p=Br(ct)),p>=3)if(lt=He(x-S,p-3),w-=p,p<=E&&w>=3){p--;do x++,ct=65535&u[h=(h<<g^255&s[x+2])&_],c[x&a]=u[h],u[h]=x;while(--p!=0);x++}else x+=p,p=0,h=((h=255&s[x])<<g^255&s[x+1])&_;else lt=He(0,255&s[x]),w--,x++;if(lt&&(ke(!1),i.avail_out===0))return 0}return ke(Ie==4),i.avail_out===0?Ie==4?2:0:Ie==4?3:1}(X);break;case 2:he=function(Ie){for(var lt,ct,Hr=0;;){if(w<262){if(wr(),w<262&&Ie==0)return 0;if(w===0)break}if(w>=3&&(Hr=65535&u[h=(h<<g^255&s[x+2])&_],c[x&a]=u[h],u[h]=x),b=p,m=S,p=2,Hr!==0&&b<E&&(x-Hr&65535)<=e-262&&(M!=2&&(p=Br(Hr)),p<=5&&(M==1||p==3&&x-S>4096)&&(p=2)),b>=3&&p<=b){ct=x+w-3,lt=He(x-1-m,b-3),w-=b-1,b-=2;do++x<=ct&&(Hr=65535&u[h=(h<<g^255&s[x+2])&_],c[x&a]=u[h],u[h]=x);while(--b!=0);if(y=0,p=2,x++,lt&&(ke(!1),i.avail_out===0))return 0}else if(y!==0){if((lt=He(0,255&s[x-1]))&&ke(!1),x++,w--,i.avail_out===0)return 0}else y=1,x++,w--}return y!==0&&(lt=He(0,255&s[x-1]),y=0),ke(Ie==4),i.avail_out===0?Ie==4?2:0:Ie==4?3:1}(X)}if(he!=2&&he!=3||(o=666),he==0||he==2)return i.avail_out===0&&(t=-1),0;if(he==1){if(X==1)Ae(2,3),pe(256,xt.static_ltree),Ze(),1+Z+10-ue<9&&(Ae(2,3),pe(256,xt.static_ltree),Ze()),Z=7;else if(Ue(0,0,!1),X==3)for(Q=0;Q<d;Q++)u[Q]=0;if(i.flush_pending(),i.avail_out===0)return t=-1,0}}return X!=4?0:1}}function nd(){var i=this;i.next_in_index=0,i.next_out_index=0,i.avail_in=0,i.total_in=0,i.avail_out=0,i.total_out=0}function ad(i){var o=new nd,n=512,t=new Uint8Array(n),e=i?i.level:-1;e===void 0&&(e=-1),o.deflateInit(e),o.next_out=t,this.append=function(r,a){var s,l=[],c=0,u=0,h=0;if(r.length){o.next_in_index=0,o.next_in=r,o.avail_in=r.length;do{if(o.next_out_index=0,o.avail_out=n,o.deflate(0)!=0)throw new Error("deflating: "+o.msg);o.next_out_index&&l.push(o.next_out_index==n?new Uint8Array(t):new Uint8Array(t.subarray(0,o.next_out_index))),h+=o.next_out_index,a&&o.next_in_index>0&&o.next_in_index!=c&&(a(o.next_in_index),c=o.next_in_index)}while(o.avail_in>0||o.avail_out===0);return s=new Uint8Array(h),l.forEach(function(d){s.set(d,u),u+=d.length}),s}},this.flush=function(){var r,a,s=[],l=0,c=0;do{if(o.next_out_index=0,o.avail_out=n,(r=o.deflate(4))!=1&&r!=0)throw new Error("deflating: "+o.msg);n-o.avail_out>0&&s.push(new Uint8Array(t.subarray(0,o.next_out_index))),c+=o.next_out_index}while(o.avail_in>0||o.avail_out===0);return o.deflateEnd(),a=new Uint8Array(c),s.forEach(function(u){a.set(u,l),l+=u.length}),a}}nd.prototype={deflateInit:function(i,o){var n=this;return n.dstate=new jv,o||(o=15),n.dstate.deflateInit(n,i,o)},deflate:function(i){var o=this;return o.dstate?o.dstate.deflate(o,i):-2},deflateEnd:function(){var i=this;if(!i.dstate)return-2;var o=i.dstate.deflateEnd();return i.dstate=null,o},deflateParams:function(i,o){var n=this;return n.dstate?n.dstate.deflateParams(n,i,o):-2},deflateSetDictionary:function(i,o){var n=this;return n.dstate?n.dstate.deflateSetDictionary(n,i,o):-2},read_buf:function(i,o,n){var t=this,e=t.avail_in;return e>n&&(e=n),e===0?0:(t.avail_in-=e,i.set(t.next_in.subarray(t.next_in_index,t.next_in_index+e),o),t.next_in_index+=e,t.total_in+=e,e)},flush_pending:function(){var i=this,o=i.dstate.pending;o>i.avail_out&&(o=i.avail_out),o!==0&&(i.next_out.set(i.dstate.pending_buf.subarray(i.dstate.pending_out,i.dstate.pending_out+o),i.next_out_index),i.next_out_index+=o,i.dstate.pending_out+=o,i.total_out+=o,i.avail_out-=o,i.dstate.pending-=o,i.dstate.pending===0&&(i.dstate.pending_out=0))}},self._zipjs_Deflater=ad;var Ht=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],$v=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],qv=[80,5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],Yv=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],Qv=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],Jv=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],Zv=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];function Qa(){var i,o,n,t,e,r;function a(l,c,u,h,d,f,_,g,v,p,m){var y,x,S,w,b,A,E,C,M,P,R,B,D,L,N;P=0,b=u;do n[l[c+P]]++,P++,b--;while(b!==0);if(n[0]==u)return _[0]=-1,g[0]=0,0;for(C=g[0],A=1;A<=15&&n[A]===0;A++);for(E=A,C<A&&(C=A),b=15;b!==0&&n[b]===0;b--);for(S=b,C>b&&(C=b),g[0]=C,L=1<<A;A<b;A++,L<<=1)if((L-=n[A])<0)return-3;if((L-=n[b])<0)return-3;for(n[b]+=L,r[1]=A=0,P=1,D=2;--b!=0;)r[D]=A+=n[P],D++,P++;b=0,P=0;do(A=l[c+P])!==0&&(m[r[A]++]=b),P++;while(++b<u);for(u=r[S],r[0]=b=0,P=0,w=-1,B=-C,e[0]=0,R=0,N=0;E<=S;E++)for(y=n[E];y--!=0;){for(;E>B+C;){if(w++,N=(N=S-(B+=C))>C?C:N,(x=1<<(A=E-B))>y+1&&(x-=y+1,D=E,A<N))for(;++A<N&&!((x<<=1)<=n[++D]);)x-=n[D];if(p[0]+(N=1<<A)>1440)return-3;e[w]=R=p[0],p[0]+=N,w!==0?(r[w]=b,t[0]=A,t[1]=C,t[2]=R-e[w-1]-(A=b>>>B-C),v.set(t,3*(e[w-1]+A))):_[0]=R}for(t[1]=E-B,P>=u?t[0]=192:m[P]<h?(t[0]=m[P]<256?0:96,t[2]=m[P++]):(t[0]=f[m[P]-h]+16+64,t[2]=d[m[P++]-h]),x=1<<E-B,A=b>>>B;A<N;A+=x)v.set(t,3*(R+A));for(A=1<<E-1;(b&A)!=0;A>>>=1)b^=A;for(b^=A,M=(1<<B)-1;(b&M)!=r[w];)w--,M=(1<<(B-=C))-1}return L!==0&&S!=1?-5:0}function s(l){var c;for(i||(i=[],o=[],n=new Int32Array(16),t=[],e=new Int32Array(15),r=new Int32Array(16)),o.length<l&&(o=[]),c=0;c<l;c++)o[c]=0;for(c=0;c<16;c++)n[c]=0;for(c=0;c<3;c++)t[c]=0;e.set(n.subarray(0,15),0),r.set(n.subarray(0,16),0)}this.inflate_trees_bits=function(l,c,u,h,d){var f;return s(19),i[0]=0,(f=a(l,0,19,19,null,null,u,c,h,i,o))==-3?d.msg="oversubscribed dynamic bit lengths tree":f!=-5&&c[0]!==0||(d.msg="incomplete dynamic bit lengths tree",f=-3),f},this.inflate_trees_dynamic=function(l,c,u,h,d,f,_,g,v){var p;return s(288),i[0]=0,(p=a(u,0,l,257,Yv,Qv,f,h,g,i,o))!=0||h[0]===0?(p==-3?v.msg="oversubscribed literal/length tree":p!=-4&&(v.msg="incomplete literal/length tree",p=-3),p):(s(288),(p=a(u,l,c,0,Jv,Zv,_,d,g,i,o))!=0||d[0]===0&&l>257?(p==-3?v.msg="oversubscribed distance tree":p==-5?(v.msg="incomplete distance tree",p=-3):p!=-4&&(v.msg="empty distance tree with lengths",p=-3),p):0)}}function Kv(){var i,o,n,t,e=this,r=0,a=0,s=0,l=0,c=0,u=0,h=0,d=0,f=0,_=0;function g(v,p,m,y,x,S,w,b){var A,E,C,M,P,R,B,D,L,N,W,I,V,se,Z,Y;B=b.next_in_index,D=b.avail_in,P=w.bitb,R=w.bitk,N=(L=w.write)<w.read?w.read-L-1:w.end-L,W=Ht[v],I=Ht[p];do{for(;R<20;)D--,P|=(255&b.read_byte(B++))<<R,R+=8;if((M=(E=m)[Y=3*((C=y)+(A=P&W))])!==0)for(;;){if(P>>=E[Y+1],R-=E[Y+1],(16&M)!=0){for(V=E[Y+2]+(P&Ht[M&=15]),P>>=M,R-=M;R<15;)D--,P|=(255&b.read_byte(B++))<<R,R+=8;for(M=(E=x)[Y=3*((C=S)+(A=P&I))];;){if(P>>=E[Y+1],R-=E[Y+1],(16&M)!=0){for(M&=15;R<M;)D--,P|=(255&b.read_byte(B++))<<R,R+=8;if(se=E[Y+2]+(P&Ht[M]),P>>=M,R-=M,N-=V,L>=se)L-(Z=L-se)>0&&2>L-Z?(w.window[L++]=w.window[Z++],w.window[L++]=w.window[Z++],V-=2):(w.window.set(w.window.subarray(Z,Z+2),L),L+=2,Z+=2,V-=2);else{Z=L-se;do Z+=w.end;while(Z<0);if(V>(M=w.end-Z)){if(V-=M,L-Z>0&&M>L-Z)do w.window[L++]=w.window[Z++];while(--M!=0);else w.window.set(w.window.subarray(Z,Z+M),L),L+=M,Z+=M,M=0;Z=0}}if(L-Z>0&&V>L-Z)do w.window[L++]=w.window[Z++];while(--V!=0);else w.window.set(w.window.subarray(Z,Z+V),L),L+=V,Z+=V,V=0;break}if((64&M)!=0)return b.msg="invalid distance code",D+=V=R>>3<(V=b.avail_in-D)?R>>3:V,B-=V,R-=V<<3,w.bitb=P,w.bitk=R,b.avail_in=D,b.total_in+=B-b.next_in_index,b.next_in_index=B,w.write=L,-3;A+=E[Y+2],M=E[Y=3*(C+(A+=P&Ht[M]))]}break}if((64&M)!=0)return(32&M)!=0?(D+=V=R>>3<(V=b.avail_in-D)?R>>3:V,B-=V,R-=V<<3,w.bitb=P,w.bitk=R,b.avail_in=D,b.total_in+=B-b.next_in_index,b.next_in_index=B,w.write=L,1):(b.msg="invalid literal/length code",D+=V=R>>3<(V=b.avail_in-D)?R>>3:V,B-=V,R-=V<<3,w.bitb=P,w.bitk=R,b.avail_in=D,b.total_in+=B-b.next_in_index,b.next_in_index=B,w.write=L,-3);if(A+=E[Y+2],(M=E[Y=3*(C+(A+=P&Ht[M]))])===0){P>>=E[Y+1],R-=E[Y+1],w.window[L++]=E[Y+2],N--;break}}else P>>=E[Y+1],R-=E[Y+1],w.window[L++]=E[Y+2],N--}while(N>=258&&D>=10);return D+=V=R>>3<(V=b.avail_in-D)?R>>3:V,B-=V,R-=V<<3,w.bitb=P,w.bitk=R,b.avail_in=D,b.total_in+=B-b.next_in_index,b.next_in_index=B,w.write=L,0}e.init=function(v,p,m,y,x,S){i=0,h=v,d=p,n=m,f=y,t=x,_=S,o=null},e.proc=function(v,p,m){var y,x,S,w,b,A,E,C=0,M=0,P=0;for(P=p.next_in_index,w=p.avail_in,C=v.bitb,M=v.bitk,A=(b=v.write)<v.read?v.read-b-1:v.end-b;;)switch(i){case 0:if(A>=258&&w>=10&&(v.bitb=C,v.bitk=M,p.avail_in=w,p.total_in+=P-p.next_in_index,p.next_in_index=P,v.write=b,m=g(h,d,n,f,t,_,v,p),P=p.next_in_index,w=p.avail_in,C=v.bitb,M=v.bitk,A=(b=v.write)<v.read?v.read-b-1:v.end-b,m!=0)){i=m==1?7:9;break}s=h,o=n,a=f,i=1;case 1:for(y=s;M<y;){if(w===0)return v.bitb=C,v.bitk=M,p.avail_in=w,p.total_in+=P-p.next_in_index,p.next_in_index=P,v.write=b,v.inflate_flush(p,m);m=0,w--,C|=(255&p.read_byte(P++))<<M,M+=8}if(C>>>=o[1+(x=3*(a+(C&Ht[y])))],M-=o[x+1],(S=o[x])===0){l=o[x+2],i=6;break}if((16&S)!=0){c=15&S,r=o[x+2],i=2;break}if((64&S)==0){s=S,a=x/3+o[x+2];break}if((32&S)!=0){i=7;break}return i=9,p.msg="invalid literal/length code",m=-3,v.bitb=C,v.bitk=M,p.avail_in=w,p.total_in+=P-p.next_in_index,p.next_in_index=P,v.write=b,v.inflate_flush(p,m);case 2:for(y=c;M<y;){if(w===0)return v.bitb=C,v.bitk=M,p.avail_in=w,p.total_in+=P-p.next_in_index,p.next_in_index=P,v.write=b,v.inflate_flush(p,m);m=0,w--,C|=(255&p.read_byte(P++))<<M,M+=8}r+=C&Ht[y],C>>=y,M-=y,s=d,o=t,a=_,i=3;case 3:for(y=s;M<y;){if(w===0)return v.bitb=C,v.bitk=M,p.avail_in=w,p.total_in+=P-p.next_in_index,p.next_in_index=P,v.write=b,v.inflate_flush(p,m);m=0,w--,C|=(255&p.read_byte(P++))<<M,M+=8}if(C>>=o[1+(x=3*(a+(C&Ht[y])))],M-=o[x+1],(16&(S=o[x]))!=0){c=15&S,u=o[x+2],i=4;break}if((64&S)==0){s=S,a=x/3+o[x+2];break}return i=9,p.msg="invalid distance code",m=-3,v.bitb=C,v.bitk=M,p.avail_in=w,p.total_in+=P-p.next_in_index,p.next_in_index=P,v.write=b,v.inflate_flush(p,m);case 4:for(y=c;M<y;){if(w===0)return v.bitb=C,v.bitk=M,p.avail_in=w,p.total_in+=P-p.next_in_index,p.next_in_index=P,v.write=b,v.inflate_flush(p,m);m=0,w--,C|=(255&p.read_byte(P++))<<M,M+=8}u+=C&Ht[y],C>>=y,M-=y,i=5;case 5:for(E=b-u;E<0;)E+=v.end;for(;r!==0;){if(A===0&&(b==v.end&&v.read!==0&&(A=(b=0)<v.read?v.read-b-1:v.end-b),A===0&&(v.write=b,m=v.inflate_flush(p,m),A=(b=v.write)<v.read?v.read-b-1:v.end-b,b==v.end&&v.read!==0&&(A=(b=0)<v.read?v.read-b-1:v.end-b),A===0)))return v.bitb=C,v.bitk=M,p.avail_in=w,p.total_in+=P-p.next_in_index,p.next_in_index=P,v.write=b,v.inflate_flush(p,m);v.window[b++]=v.window[E++],A--,E==v.end&&(E=0),r--}i=0;break;case 6:if(A===0&&(b==v.end&&v.read!==0&&(A=(b=0)<v.read?v.read-b-1:v.end-b),A===0&&(v.write=b,m=v.inflate_flush(p,m),A=(b=v.write)<v.read?v.read-b-1:v.end-b,b==v.end&&v.read!==0&&(A=(b=0)<v.read?v.read-b-1:v.end-b),A===0)))return v.bitb=C,v.bitk=M,p.avail_in=w,p.total_in+=P-p.next_in_index,p.next_in_index=P,v.write=b,v.inflate_flush(p,m);m=0,v.window[b++]=l,A--,i=0;break;case 7:if(M>7&&(M-=8,w++,P--),v.write=b,m=v.inflate_flush(p,m),A=(b=v.write)<v.read?v.read-b-1:v.end-b,v.read!=v.write)return v.bitb=C,v.bitk=M,p.avail_in=w,p.total_in+=P-p.next_in_index,p.next_in_index=P,v.write=b,v.inflate_flush(p,m);i=8;case 8:return m=1,v.bitb=C,v.bitk=M,p.avail_in=w,p.total_in+=P-p.next_in_index,p.next_in_index=P,v.write=b,v.inflate_flush(p,m);case 9:return m=-3,v.bitb=C,v.bitk=M,p.avail_in=w,p.total_in+=P-p.next_in_index,p.next_in_index=P,v.write=b,v.inflate_flush(p,m);default:return m=-2,v.bitb=C,v.bitk=M,p.avail_in=w,p.total_in+=P-p.next_in_index,p.next_in_index=P,v.write=b,v.inflate_flush(p,m)}},e.free=function(){}}Qa.inflate_trees_fixed=function(i,o,n,t){return i[0]=9,o[0]=5,n[0]=$v,t[0]=qv,0};var Pu=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];function ep(i,o){var n,t=this,e=0,r=0,a=0,s=0,l=[0],c=[0],u=new Kv,h=0,d=new Int32Array(4320),f=new Qa;t.bitk=0,t.bitb=0,t.window=new Uint8Array(o),t.end=o,t.read=0,t.write=0,t.reset=function(_,g){g&&(g[0]=0),e==6&&u.free(_),e=0,t.bitk=0,t.bitb=0,t.read=t.write=0},t.reset(i,null),t.inflate_flush=function(_,g){var v,p,m;return p=_.next_out_index,(v=((m=t.read)<=t.write?t.write:t.end)-m)>_.avail_out&&(v=_.avail_out),v!==0&&g==-5&&(g=0),_.avail_out-=v,_.total_out+=v,_.next_out.set(t.window.subarray(m,m+v),p),p+=v,(m+=v)==t.end&&(m=0,t.write==t.end&&(t.write=0),(v=t.write-m)>_.avail_out&&(v=_.avail_out),v!==0&&g==-5&&(g=0),_.avail_out-=v,_.total_out+=v,_.next_out.set(t.window.subarray(m,m+v),p),p+=v,m+=v),_.next_out_index=p,t.read=m,g},t.proc=function(_,g){var v,p,m,y,x,S,w,b;for(y=_.next_in_index,x=_.avail_in,p=t.bitb,m=t.bitk,w=(S=t.write)<t.read?t.read-S-1:t.end-S;;)switch(e){case 0:for(;m<3;){if(x===0)return t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);g=0,x--,p|=(255&_.read_byte(y++))<<m,m+=8}switch(h=1&(v=7&p),v>>>1){case 0:p>>>=3,p>>>=v=7&(m-=3),m-=v,e=1;break;case 1:var A=[],E=[],C=[[]],M=[[]];Qa.inflate_trees_fixed(A,E,C,M),u.init(A[0],E[0],C[0],0,M[0],0),p>>>=3,m-=3,e=6;break;case 2:p>>>=3,m-=3,e=3;break;case 3:return p>>>=3,m-=3,e=9,_.msg="invalid block type",g=-3,t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g)}break;case 1:for(;m<32;){if(x===0)return t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);g=0,x--,p|=(255&_.read_byte(y++))<<m,m+=8}if((~p>>>16&65535)!=(65535&p))return e=9,_.msg="invalid stored block lengths",g=-3,t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);r=65535&p,p=m=0,e=r!==0?2:h!==0?7:0;break;case 2:if(x===0||w===0&&(S==t.end&&t.read!==0&&(w=(S=0)<t.read?t.read-S-1:t.end-S),w===0&&(t.write=S,g=t.inflate_flush(_,g),w=(S=t.write)<t.read?t.read-S-1:t.end-S,S==t.end&&t.read!==0&&(w=(S=0)<t.read?t.read-S-1:t.end-S),w===0)))return t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);if(g=0,(v=r)>x&&(v=x),v>w&&(v=w),t.window.set(_.read_buf(y,v),S),y+=v,x-=v,S+=v,w-=v,(r-=v)!=0)break;e=h!==0?7:0;break;case 3:for(;m<14;){if(x===0)return t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);g=0,x--,p|=(255&_.read_byte(y++))<<m,m+=8}if(a=v=16383&p,(31&v)>29||(v>>5&31)>29)return e=9,_.msg="too many length or distance symbols",g=-3,t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);if(v=258+(31&v)+(v>>5&31),!n||n.length<v)n=[];else for(b=0;b<v;b++)n[b]=0;p>>>=14,m-=14,s=0,e=4;case 4:for(;s<4+(a>>>10);){for(;m<3;){if(x===0)return t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);g=0,x--,p|=(255&_.read_byte(y++))<<m,m+=8}n[Pu[s++]]=7&p,p>>>=3,m-=3}for(;s<19;)n[Pu[s++]]=0;if(l[0]=7,(v=f.inflate_trees_bits(n,l,c,d,_))!=0)return(g=v)==-3&&(n=null,e=9),t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);s=0,e=5;case 5:for(;!(s>=258+(31&(v=a))+(v>>5&31));){var P,R;for(v=l[0];m<v;){if(x===0)return t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);g=0,x--,p|=(255&_.read_byte(y++))<<m,m+=8}if((R=d[3*(c[0]+(p&Ht[v=d[3*(c[0]+(p&Ht[v]))+1]]))+2])<16)p>>>=v,m-=v,n[s++]=R;else{for(b=R==18?7:R-14,P=R==18?11:3;m<v+b;){if(x===0)return t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);g=0,x--,p|=(255&_.read_byte(y++))<<m,m+=8}if(m-=v,P+=(p>>>=v)&Ht[b],p>>>=b,m-=b,(b=s)+P>258+(31&(v=a))+(v>>5&31)||R==16&&b<1)return n=null,e=9,_.msg="invalid bit length repeat",g=-3,t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);R=R==16?n[b-1]:0;do n[b++]=R;while(--P!=0);s=b}}c[0]=-1;var B=[],D=[],L=[],N=[];if(B[0]=9,D[0]=6,(v=f.inflate_trees_dynamic(257+(31&(v=a)),1+(v>>5&31),n,B,D,L,N,d,_))!=0)return v==-3&&(n=null,e=9),g=v,t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);u.init(B[0],D[0],d,L[0],d,N[0]),e=6;case 6:if(t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,(g=u.proc(t,_,g))!=1)return t.inflate_flush(_,g);if(g=0,u.free(_),y=_.next_in_index,x=_.avail_in,p=t.bitb,m=t.bitk,w=(S=t.write)<t.read?t.read-S-1:t.end-S,h===0){e=0;break}e=7;case 7:if(t.write=S,g=t.inflate_flush(_,g),w=(S=t.write)<t.read?t.read-S-1:t.end-S,t.read!=t.write)return t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);e=8;case 8:return g=1,t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);case 9:return g=-3,t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g);default:return g=-2,t.bitb=p,t.bitk=m,_.avail_in=x,_.total_in+=y-_.next_in_index,_.next_in_index=y,t.write=S,t.inflate_flush(_,g)}},t.free=function(_){t.reset(_,null),t.window=null,d=null},t.set_dictionary=function(_,g,v){t.window.set(_.subarray(g,g+v),0),t.read=t.write=v},t.sync_point=function(){return e==1?1:0}}var tp=[0,0,255,255];function rp(){var i=this;function o(n){return n&&n.istate?(n.total_in=n.total_out=0,n.msg=null,n.istate.mode=7,n.istate.blocks.reset(n,null),0):-2}i.mode=0,i.method=0,i.was=[0],i.need=0,i.marker=0,i.wbits=0,i.inflateEnd=function(n){return i.blocks&&i.blocks.free(n),i.blocks=null,0},i.inflateInit=function(n,t){return n.msg=null,i.blocks=null,t<8||t>15?(i.inflateEnd(n),-2):(i.wbits=t,n.istate.blocks=new ep(n,1<<t),o(n),0)},i.inflate=function(n,t){var e,r;if(!n||!n.istate||!n.next_in)return-2;for(t=t==4?-5:0,e=-5;;)switch(n.istate.mode){case 0:if(n.avail_in===0)return e;if(e=t,n.avail_in--,n.total_in++,(15&(n.istate.method=n.read_byte(n.next_in_index++)))!=8){n.istate.mode=13,n.msg="unknown compression method",n.istate.marker=5;break}if(8+(n.istate.method>>4)>n.istate.wbits){n.istate.mode=13,n.msg="invalid window size",n.istate.marker=5;break}n.istate.mode=1;case 1:if(n.avail_in===0)return e;if(e=t,n.avail_in--,n.total_in++,r=255&n.read_byte(n.next_in_index++),((n.istate.method<<8)+r)%31!=0){n.istate.mode=13,n.msg="incorrect header check",n.istate.marker=5;break}if((32&r)==0){n.istate.mode=7;break}n.istate.mode=2;case 2:if(n.avail_in===0)return e;e=t,n.avail_in--,n.total_in++,n.istate.need=(255&n.read_byte(n.next_in_index++))<<24&4278190080,n.istate.mode=3;case 3:if(n.avail_in===0)return e;e=t,n.avail_in--,n.total_in++,n.istate.need+=(255&n.read_byte(n.next_in_index++))<<16&16711680,n.istate.mode=4;case 4:if(n.avail_in===0)return e;e=t,n.avail_in--,n.total_in++,n.istate.need+=(255&n.read_byte(n.next_in_index++))<<8&65280,n.istate.mode=5;case 5:return n.avail_in===0?e:(e=t,n.avail_in--,n.total_in++,n.istate.need+=255&n.read_byte(n.next_in_index++),n.istate.mode=6,2);case 6:return n.istate.mode=13,n.msg="need dictionary",n.istate.marker=0,-2;case 7:if((e=n.istate.blocks.proc(n,e))==-3){n.istate.mode=13,n.istate.marker=0;break}if(e==0&&(e=t),e!=1)return e;e=t,n.istate.blocks.reset(n,n.istate.was),n.istate.mode=12;case 12:return 1;case 13:return-3;default:return-2}},i.inflateSetDictionary=function(n,t,e){var r=0,a=e;return n&&n.istate&&n.istate.mode==6?(a>=1<<n.istate.wbits&&(r=e-(a=(1<<n.istate.wbits)-1)),n.istate.blocks.set_dictionary(t,r,a),n.istate.mode=7,0):-2},i.inflateSync=function(n){var t,e,r,a,s;if(!n||!n.istate)return-2;if(n.istate.mode!=13&&(n.istate.mode=13,n.istate.marker=0),(t=n.avail_in)===0)return-5;for(e=n.next_in_index,r=n.istate.marker;t!==0&&r<4;)n.read_byte(e)==tp[r]?r++:r=n.read_byte(e)!==0?0:4-r,e++,t--;return n.total_in+=e-n.next_in_index,n.next_in_index=e,n.avail_in=t,n.istate.marker=r,r!=4?-3:(a=n.total_in,s=n.total_out,o(n),n.total_in=a,n.total_out=s,n.istate.mode=7,0)},i.inflateSyncPoint=function(n){return n&&n.istate&&n.istate.blocks?n.istate.blocks.sync_point():-2}}function od(){}function sd(){var i=new od,o=new Uint8Array(512),n=!1;i.inflateInit(),i.next_out=o,this.append=function(t,e){var r,a,s=[],l=0,c=0,u=0;if(t.length!==0){i.next_in_index=0,i.next_in=t,i.avail_in=t.length;do{if(i.next_out_index=0,i.avail_out=512,i.avail_in!==0||n||(i.next_in_index=0,n=!0),r=i.inflate(0),n&&r===-5){if(i.avail_in!==0)throw new Error("inflating: bad input")}else if(r!==0&&r!==1)throw new Error("inflating: "+i.msg);if((n||r===1)&&i.avail_in===t.length)throw new Error("inflating: bad input");i.next_out_index&&s.push(i.next_out_index===512?new Uint8Array(o):new Uint8Array(o.subarray(0,i.next_out_index))),u+=i.next_out_index,e&&i.next_in_index>0&&i.next_in_index!=l&&(e(i.next_in_index),l=i.next_in_index)}while(i.avail_in>0||i.avail_out===0);return a=new Uint8Array(u),s.forEach(function(h){a.set(h,c),c+=h.length}),a}},this.flush=function(){i.inflateEnd()}}od.prototype={inflateInit:function(i){var o=this;return o.istate=new rp,i||(i=15),o.istate.inflateInit(o,i)},inflate:function(i){var o=this;return o.istate?o.istate.inflate(o,i):-2},inflateEnd:function(){var i=this;if(!i.istate)return-2;var o=i.istate.inflateEnd(i);return i.istate=null,o},inflateSync:function(){var i=this;return i.istate?i.istate.inflateSync(i):-2},inflateSetDictionary:function(i,o){var n=this;return n.istate?n.istate.inflateSetDictionary(n,i,o):-2},read_byte:function(i){return this.next_in.subarray(i,i+1)[0]},read_buf:function(i,o){return this.next_in.subarray(i,i+o)}},self._zipjs_Inflater=sd;var Mo,cn="File format is not recognized.",Mu="Error while reading zip file.";try{Mo=new Blob([new DataView(new ArrayBuffer(0))]).size===0}catch{}function ea(){this.crc=-1}function Ja(){}function Yr(i,o){var n,t;return n=new ArrayBuffer(i),t=new Uint8Array(n),o&&t.set(o,0),{buffer:n,array:t,view:new DataView(n)}}function ta(){}function Za(i){var o,n=this;n.size=0,n.init=function(t,e){var r=new Blob([i],{type:"text/plain"});(o=new ha(r)).init(function(){n.size=o.size,t()},e)},n.readUint8Array=function(t,e,r,a){o.readUint8Array(t,e,r,a)}}function Ka(i){var o,n=this;n.size=0,n.init=function(t){for(var e=i.length;i.charAt(e-1)=="=";)e--;o=i.indexOf(",")+1,n.size=Math.floor(.75*(e-o)),t()},n.readUint8Array=function(t,e,r){var a,s=Yr(e),l=4*Math.floor(t/3),c=4*Math.ceil((t+e)/3),u=self.atob(i.substring(l+o,c+o)),h=t-3*Math.floor(l/4);for(a=h;a<h+e;a++)s.array[a-h]=u.charCodeAt(a);r(s.array)}}function ha(i){var o=this;o.size=0,o.init=function(n){o.size=i.size,n()},o.readUint8Array=function(n,t,e,r){var a=new FileReader;a.onload=function(s){e(new Uint8Array(s.target.result))},a.onerror=r;try{a.readAsArrayBuffer(function(s,l,c){if(l<0||c<0||l+c>s.size)throw new RangeError("offset:"+l+", length:"+c+", size:"+s.size);return s.slice?s.slice(l,l+c):s.webkitSlice?s.webkitSlice(l,l+c):s.mozSlice?s.mozSlice(l,l+c):s.msSlice?s.msSlice(l,l+c):void 0}(i,n,t))}catch(s){r(s)}}}function _n(){}function eo(i){var o,n=this;n.init=function(t){o=new Blob([],{type:"text/plain"}),t()},n.writeUint8Array=function(t,e){o=new Blob([o,Mo?t:t.buffer],{type:"text/plain"}),e()},n.getData=function(t,e){var r=new FileReader;r.onload=function(a){t(a.target.result)},r.onerror=e,r.readAsText(o,i)}}function to(i){var o=this,n="",t="";o.init=function(e){n+="data:"+(i||"")+";base64,",e()},o.writeUint8Array=function(e,r){var a,s=t.length,l=t;for(t="",a=0;a<3*Math.floor((s+e.length)/3)-s;a++)l+=String.fromCharCode(e[a]);for(;a<e.length;a++)t+=String.fromCharCode(e[a]);l.length>2?n+=self.btoa(l):t=l,r()},o.getData=function(e){e(n+self.btoa(t))}}function ro(i){var o,n=this;n.init=function(t){o=new Blob([],{type:i}),t()},n.writeUint8Array=function(t,e){o=new Blob([o,Mo?t:t.buffer],{type:i}),e()},n.getData=function(t){t(o)}}function io(i,o,n,t,e,r,a,s,l,c){var u,h,d,f=0,_=o.sn;function g(){i.removeEventListener("message",v,!1),s(h,d)}function v(m){var y=m.data,x=y.data,S=y.error;if(S)return S.toString=function(){return"Error: "+this.message},void l(S);if(y.sn===_)switch(typeof y.codecTime=="number"&&(i.codecTime+=y.codecTime),typeof y.crcTime=="number"&&(i.crcTime+=y.crcTime),y.type){case"append":x?(h+=x.length,t.writeUint8Array(x,function(){p()},c)):p();break;case"flush":d=y.crc,x?(h+=x.length,t.writeUint8Array(x,function(){g()},c)):g();break;case"progress":a&&a(u+y.loaded,r);break;case"importScripts":case"newTask":case"echo":break;default:console.warn("zip.js:launchWorkerProcess: unknown message: ",y)}}function p(){(u=524288*f)<=r?n.readUint8Array(e+u,Math.min(524288,r-u),function(m){a&&a(u,r);var y=u===0?o:{sn:_};y.type="append",y.data=m;try{i.postMessage(y,[m.buffer])}catch{i.postMessage(y)}f++},l):i.postMessage({sn:_,type:"flush"})}h=0,i.addEventListener("message",v,!1),p()}function no(i,o,n,t,e,r,a,s,l,c){var u,h=0,d=0,f=r==="input",_=r==="output",g=new ea;(function v(){var p;if((u=524288*h)<e)o.readUint8Array(t+u,Math.min(524288,e-u),function(m){var y;try{y=i.append(m,function(x){a&&a(u+x,e)})}catch(x){return void l(x)}y?(d+=y.length,n.writeUint8Array(y,function(){h++,setTimeout(v,1)},c),_&&g.append(y)):(h++,setTimeout(v,1)),f&&g.append(m),a&&a(u,e)},l);else{try{p=i.flush()}catch(m){return void l(m)}p?(_&&g.append(p),d+=p.length,n.writeUint8Array(p,function(){s(d,g.get())},c)):s(d,g.get())}})()}function Eu(i,o,n,t,e,r,a,s,l,c,u){var h="input";We.useWebWorkers&&a?io(i,{sn:o,codecClass:"_zipjs_NOOP",crcType:h},n,t,e,r,l,s,c,u):no(new Ja,n,t,e,r,h,l,s,c,u)}function Ru(i){var o,n,t="",e=["\xC7","\xFC","\xE9","\xE2","\xE4","\xE0","\xE5","\xE7","\xEA","\xEB","\xE8","\xEF","\xEE","\xEC","\xC4","\xC5","\xC9","\xE6","\xC6","\xF4","\xF6","\xF2","\xFB","\xF9","\xFF","\xD6","\xDC","\xF8","\xA3","\xD8","\xD7","\u0192","\xE1","\xED","\xF3","\xFA","\xF1","\xD1","\xAA","\xBA","\xBF","\xAE","\xAC","\xBD","\xBC","\xA1","\xAB","\xBB","_","_","_","\xA6","\xA6","\xC1","\xC2","\xC0","\xA9","\xA6","\xA6","+","+","\xA2","\xA5","+","+","-","-","+","-","+","\xE3","\xC3","+","+","-","-","\xA6","-","+","\xA4","\xF0","\xD0","\xCA","\xCB","\xC8","i","\xCD","\xCE","\xCF","+","+","_","_","\xA6","\xCC","_","\xD3","\xDF","\xD4","\xD2","\xF5","\xD5","\xB5","\xFE","\xDE","\xDA","\xDB","\xD9","\xFD","\xDD","\xAF","\xB4","\xAD","\xB1","_","\xBE","\xB6","\xA7","\xF7","\xB8","\xB0","\xA8","\xB7","\xB9","\xB3","\xB2","_"," "];for(o=0;o<i.length;o++)t+=(n=255&i.charCodeAt(o))>127?e[n-128]:String.fromCharCode(n);return t}function Fu(i){return decodeURIComponent(escape(i))}function Bu(i){var o,n="";for(o=0;o<i.length;o++)n+=String.fromCharCode(i[o]);return n}function Du(i,o,n,t,e){i.version=o.view.getUint16(n,!0),i.bitFlag=o.view.getUint16(n+2,!0),i.compressionMethod=o.view.getUint16(n+4,!0),i.lastModDateRaw=o.view.getUint32(n+6,!0),i.lastModDate=function(r){var a=(4294901760&r)>>16,s=65535&r;try{return new Date(1980+((65024&a)>>9),((480&a)>>5)-1,31&a,(63488&s)>>11,(2016&s)>>5,2*(31&s),0)}catch{}}(i.lastModDateRaw),(1&i.bitFlag)!=1?((t||(8&i.bitFlag)!=8)&&(i.crc32=o.view.getUint32(n+10,!0),i.compressedSize=o.view.getUint32(n+14,!0),i.uncompressedSize=o.view.getUint32(n+18,!0)),i.compressedSize!==4294967295&&i.uncompressedSize!==4294967295?(i.filenameLength=o.view.getUint16(n+22,!0),i.extraFieldLength=o.view.getUint16(n+24,!0)):e("File is using Zip64 (4gb+ file size).")):e("File contains encrypted entry.")}function Lu(i){return unescape(encodeURIComponent(i))}function zu(i){var o,n=[];for(o=0;o<i.length;o++)n.push(i.charCodeAt(o));return n}ea.prototype.append=function(i){for(var o=0|this.crc,n=this.table,t=0,e=0|i.length;t<e;t++)o=o>>>8^n[255&(o^i[t])];this.crc=o},ea.prototype.get=function(){return~this.crc},ea.prototype.table=function(){var i,o,n,t=[];for(i=0;i<256;i++){for(n=i,o=0;o<8;o++)1&n?n=n>>>1^3988292384:n>>>=1;t[i]=n}return t}(),Ja.prototype.append=function(i,o){return i},Ja.prototype.flush=function(){},(Za.prototype=new ta).constructor=Za,(Ka.prototype=new ta).constructor=Ka,(ha.prototype=new ta).constructor=ha,_n.prototype.getData=function(i){i(this.data)},(eo.prototype=new _n).constructor=eo,(to.prototype=new _n).constructor=to,(ro.prototype=new _n).constructor=ro;var ip={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};function Ou(i,o,n){if(We.workerScripts===null||We.workerScriptsPath===null){var t,e,r;if(We.workerScripts){if(t=We.workerScripts[i],!Array.isArray(t))return void n(new Error("zip.workerScripts."+i+" is not an array!"));e=t,r=document.createElement("a"),t=e.map(function(l){return r.href=l,r.href})}else(t=ip[i].slice(0))[0]=(We.workerScriptsPath||"")+t[0];var a=new Worker(t[0]);a.codecTime=a.crcTime=0,a.postMessage({type:"importScripts",scripts:t.slice(1)}),a.addEventListener("message",function l(c){var u=c.data;if(u.error)return a.terminate(),void n(u.error);u.type==="importScripts"&&(a.removeEventListener("message",l),a.removeEventListener("error",s),o(a))}),a.addEventListener("error",s)}else n(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."));function s(l){a.terminate(),n(l)}}function Iu(i){console.error(i)}const We={Reader:ta,Writer:_n,BlobReader:ha,Data64URIReader:Ka,TextReader:Za,BlobWriter:ro,Data64URIWriter:to,TextWriter:eo,createReader:function(i,o,n){i.init(function(){(function(t,e,r){var a=0;function s(){}s.prototype.getData=function(c,u,h,d){var f=this;function _(p,m){d&&!function(y){var x=Yr(4);return x.view.setUint32(0,y),f.crc32==x.view.getUint32(0)}(m)?r("CRC failed."):c.getData(function(y){u(y)})}function g(p){r(p||"Error while reading file data.")}function v(p){r(p||"Error while writing file data.")}t.readUint8Array(f.offset,30,function(p){var m,y=Yr(p.length,p);y.view.getUint32(0)==1347093252?(Du(f,y,4,!1,r),m=f.offset+30+f.filenameLength+f.extraFieldLength,c.init(function(){f.compressionMethod===0?Eu(f._worker,a++,t,c,m,f.compressedSize,d,_,h,g,v):function(x,S,w,b,A,E,C,M,P,R,B){var D=C?"output":"none";We.useWebWorkers?io(x,{sn:S,codecClass:"_zipjs_Inflater",crcType:D},w,b,A,E,P,M,R,B):no(new sd,w,b,A,E,D,P,M,R,B)}(f._worker,a++,t,c,m,f.compressedSize,d,_,h,g,v)},v)):r(cn)},g)};var l={getEntries:function(c){var u=this._worker;(function(h){function d(f,_){t.readUint8Array(t.size-f,f,function(g){for(var v=g.length-22;v>=0;v--)if(g[v]===80&&g[v+1]===75&&g[v+2]===5&&g[v+3]===6)return void h(new DataView(g.buffer,v,22));_()},function(){r(Mu)})}t.size<22?r(cn):d(22,function(){d(Math.min(65558,t.size),function(){r(cn)})})})(function(h){var d,f;d=h.getUint32(16,!0),f=h.getUint16(8,!0),d<0||d>=t.size?r(cn):t.readUint8Array(d,t.size-d,function(_){var g,v,p,m,y=0,x=[],S=Yr(_.length,_);for(g=0;g<f;g++){if((v=new s)._worker=u,S.view.getUint32(y)!=1347092738)return void r(cn);Du(v,S,y+6,!0,r),v.commentLength=S.view.getUint16(y+32,!0),v.directory=(16&S.view.getUint8(y+38))==16,v.offset=S.view.getUint32(y+42,!0),p=Bu(S.array.subarray(y+46,y+46+v.filenameLength)),v.filename=(2048&v.bitFlag)==2048?Fu(p):Ru(p),v.directory||v.filename.charAt(v.filename.length-1)!="/"||(v.directory=!0),m=Bu(S.array.subarray(y+46+v.filenameLength+v.extraFieldLength,y+46+v.filenameLength+v.extraFieldLength+v.commentLength)),v.comment=(2048&v.bitFlag)==2048?Fu(m):Ru(m),x.push(v),y+=46+v.filenameLength+v.extraFieldLength+v.commentLength}c(x)},function(){r(Mu)})})},close:function(c){this._worker&&(this._worker.terminate(),this._worker=null),c&&c()},_worker:null};We.useWebWorkers?Ou("inflater",function(c){l._worker=c,e(l)},function(c){r(c)}):e(l)})(i,o,n)},n=n||Iu)},createWriter:function(i,o,n,t){t=!!t,i.init(function(){(function(e,r,a,s){var l={},c=[],u=0,h=0;function d(g){a(g||"Error while writing zip file.")}function f(g){a(g||"Error while reading file data.")}var _={add:function(g,v,p,m,y){var x,S,w,b=this._worker;function A(C,M){var P=Yr(16);u+=C||0,P.view.setUint32(0,1347094280),M!==void 0&&(x.view.setUint32(10,M,!0),P.view.setUint32(4,M,!0)),v&&(P.view.setUint32(8,C,!0),x.view.setUint32(14,C,!0),P.view.setUint32(12,v.size,!0),x.view.setUint32(18,v.size,!0)),e.writeUint8Array(P.array,function(){u+=16,p()},d)}function E(){var C;y=y||{},g=g.trim(),y.directory&&g.charAt(g.length-1)!="/"&&(g+="/"),l.hasOwnProperty(g)?a("File already exists."):(S=zu(Lu(g)),c.push(g),w=y.lastModDate||new Date,x=Yr(26),l[g]={headerArray:x.array,directory:y.directory,filename:S,offset:u,comment:zu(Lu(y.comment||""))},x.view.setUint32(0,335546376),y.version&&x.view.setUint8(0,y.version),s||y.level===0||y.directory||x.view.setUint16(4,2048),x.view.setUint16(6,(w.getHours()<<6|w.getMinutes())<<5|w.getSeconds()/2,!0),x.view.setUint16(8,(w.getFullYear()-1980<<4|w.getMonth()+1)<<5|w.getDate(),!0),x.view.setUint16(22,S.length,!0),(C=Yr(30+S.length)).view.setUint32(0,1347093252),C.array.set(x.array,4),C.array.set(S,30),u+=C.array.length,e.writeUint8Array(C.array,function(){v?s||y.level===0?Eu(b,h++,v,e,0,v.size,!0,A,m,f,d):function(M,P,R,B,D,L,N,W,I){var V="input";We.useWebWorkers?io(M,{sn:P,options:{level:D},codecClass:"_zipjs_Deflater",crcType:V},R,B,0,R.size,N,L,W,I):no(new ad,R,B,0,R.size,V,N,L,W,I)}(b,h++,v,e,y.level,A,m,f,d):A()},d))}v?v.init(E,f):E()},close:function(g){this._worker&&(this._worker.terminate(),this._worker=null);var v,p,m,y=0,x=0;for(p=0;p<c.length;p++)y+=46+(m=l[c[p]]).filename.length+m.comment.length;for(v=Yr(y+22),p=0;p<c.length;p++)m=l[c[p]],v.view.setUint32(x,1347092738),v.view.setUint16(x+4,5120),v.array.set(m.headerArray,x+6),v.view.setUint16(x+32,m.comment.length,!0),m.directory&&v.view.setUint8(x+38,16),v.view.setUint32(x+42,m.offset,!0),v.array.set(m.filename,x+46),v.array.set(m.comment,x+46+m.filename.length),x+=46+m.filename.length+m.comment.length;v.view.setUint32(x,1347093766),v.view.setUint16(x+8,c.length,!0),v.view.setUint16(x+10,c.length,!0),v.view.setUint32(x+12,y,!0),v.view.setUint32(x+16,u,!0),e.writeUint8Array(v.array,function(){e.getData(g)},d)},_worker:null};We.useWebWorkers?Ou("deflater",function(g){_._worker=g,r(_)},function(g){a(g)}):r(_)})(i,o,n,t)},n=n||Iu)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null};var ki,pt,La=We.TextWriter,ra=We.BlobWriter,za=We.Data64URIWriter,Nu=We.TextReader,ao=We.BlobReader,Uu=We.Data64URIReader,np=We.createReader,ap=We.createWriter;function qn(i){var o,n=this;n.size=0,n.init=function(t){n.size=i.uncompressedSize,t()},n.readUint8Array=function(t,e,r,a){(function(s){n.data?s():i.getData(new ra,function(l){n.data=l,o=new ao(l),s()},null,n.checkCrc32)})(function(){o.readUint8Array(t,e,r,a)})}}function ku(i){var o=0;return function n(t){o+=t.uncompressedSize||0,t.children.forEach(n)}(i),o}function oo(i,o,n){var t=0;function e(){++t<i.children.length?r(i.children[t]):o()}function r(a){a.directory?oo(a,e,n):(a.reader=new a.Reader(a.data,n),a.reader.init(function(){a.uncompressedSize=a.reader.size,e()}))}i.children.length?r(i.children[t]):o()}function Vu(i){var o=i.parent.children;o.forEach(function(n,t){n.id==i.id&&o.splice(t,1)})}function ia(i){i.entries=[],i.root=new Ki(i)}function Vi(i,o,n,t){if(i.directory)return t?new Ki(i.fs,o,n,i):new da(i.fs,o,n,i);throw"Parent entry is not a directory."}function $i(){}function da(i,o,n,t){var e=this;$i.prototype.init.call(e,i,o,n,t),e.Reader=n.Reader,e.Writer=n.Writer,e.data=n.data,n.getData&&(e.getData=n.getData)}function Ki(i,o,n,t){$i.prototype.init.call(this,i,o,n,t),this.directory=!0}function ld(){ia(this)}(qn.prototype=new We.Reader).constructor=qn,qn.prototype.checkCrc32=!1,($i.prototype={init:function(i,o,n,t){var e=this;if(i.root&&t&&t.getChildByName(o))throw"Entry filename already exists.";n||(n={}),e.fs=i,e.name=o,e.id=i.entries.length,e.parent=t,e.children=[],e.zipVersion=n.zipVersion||20,e.uncompressedSize=0,i.entries.push(e),t&&e.parent.children.push(e)},getFileEntry:function(i,o,n,t,e){var r=this;oo(r,function(){(function(a,s,l,c,u,h,d){var f=0;s.directory?function _(g,v,p,m,y,x){var S=0;(function w(){var b=v.children[S];b?function(A){function E(C){f+=A.uncompressedSize||0,_(C,A,function(){S++,w()},m,y,x)}A.directory?g.getDirectory(A.name,{create:!0},E,y):g.getFile(A.name,{create:!0},function(C){A.getData(new We.FileWriter(C,We.getMimeType(A.name)),E,function(M){m&&m(f+M,x)},d)},y)}(b):p()})()}(a,s,l,c,u,h):s.getData(new We.FileWriter(a,We.getMimeType(s.name)),l,c,d)})(i,r,o,n,t,ku(r),e)},t)},moveTo:function(i){var o=this;if(!i.directory)throw"Target entry is not a directory.";if(i.isDescendantOf(o))throw"Entry is a ancestor of target entry.";if(o!=i){if(i.getChildByName(o.name))throw"Entry filename already exists.";Vu(o),o.parent=i,i.children.push(o)}},getFullname:function(){for(var i=this.name,o=this.parent;o;)i=(o.name?o.name+"/":"")+i,o=o.parent;return i},isDescendantOf:function(i){for(var o=this.parent;o&&o.id!=i.id;)o=o.parent;return!!o}}).constructor=$i,da.prototype=ki=new $i,ki.constructor=da,ki.getData=function(i,o,n,t){var e=this;!i||i.constructor==e.Writer&&e.data?o(e.data):(e.reader||(e.reader=new e.Reader(e.data,t)),e.reader.init(function(){i.init(function(){(function(r,a,s,l,c){var u=0;(function h(){var d=524288*u;l&&l(d,r.size),d<r.size?r.readUint8Array(d,Math.min(524288,r.size-d),function(f){a.writeUint8Array(new Uint8Array(f),function(){u++,h()})},c):a.getData(s)})()})(e.reader,i,o,n,t)},t)}))},ki.getText=function(i,o,n,t){this.getData(new La(t),i,o,n)},ki.getBlob=function(i,o,n,t){this.getData(new ra(i),o,n,t)},ki.getData64URI=function(i,o,n,t){this.getData(new za(i),o,n,t)},Ki.prototype=pt=new $i,pt.constructor=Ki,pt.addDirectory=function(i){return Vi(this,i,null,!0)},pt.addText=function(i,o){return Vi(this,i,{data:o,Reader:Nu,Writer:La})},pt.addBlob=function(i,o){return Vi(this,i,{data:o,Reader:ao,Writer:ra})},pt.addData64URI=function(i,o){return Vi(this,i,{data:o,Reader:Uu,Writer:za})},pt.addFileEntry=function(i,o,n){(function(t,e,r,a){e.isDirectory?function s(l,c,u){(function(h,d){h.isDirectory&&h.createReader().readEntries(d),h.isFile&&d([])})(c,function(h){var d=0;(function f(){var _=h[d];_?function(g){function v(p){s(p,g,function(){d++,f()})}g.isDirectory&&v(l.addDirectory(g.name)),g.isFile&&g.file(function(p){var m=l.addBlob(g.name,p);m.uncompressedSize=p.size,v(m)},a)}(_):u()})()})}(t,e,r):e.file(function(s){t.addBlob(e.name,s),r()},a)})(this,i,o,n)},pt.addData=function(i,o){return Vi(this,i,o)},pt.importBlob=function(i,o,n){this.importZip(new ao(i),o,n)},pt.importText=function(i,o,n){this.importZip(new Nu(i),o,n)},pt.importData64URI=function(i,o,n){this.importZip(new Uu(i),o,n)},pt.exportBlob=function(i,o,n){this.exportZip(new ra("application/zip"),i,o,n)},pt.exportText=function(i,o,n){this.exportZip(new La,i,o,n)},pt.exportFileEntry=function(i,o,n,t){this.exportZip(new We.FileWriter(i,"application/zip"),o,n,t)},pt.exportData64URI=function(i,o,n){this.exportZip(new za("application/zip"),i,o,n)},pt.importZip=function(i,o,n){var t=this;np(i,function(e){e.getEntries(function(r){r.forEach(function(a){var s=t,l=a.filename.split("/"),c=l.pop();l.forEach(function(u){s=s.getChildByName(u)||new Ki(t.fs,u,null,s)}),a.directory||Vi(s,c,{data:a,Reader:qn})}),o()})},n)},pt.exportZip=function(i,o,n,t){var e=this;oo(e,function(){ap(i,function(r){(function(a,s,l,c,u){var h=0;(function d(f,_,g,v,p){var m=0;(function y(){var x=_.children[m];x?f.add(x.getFullname(),x.reader,function(){h+=x.uncompressedSize||0,d(f,x,function(){m++,y()},v,p)},function(S){v&&v(h+S,p)},{directory:x.directory,version:x.zipVersion}):g()})()})(a,s,l,c,u)})(r,e,function(){r.close(o)},n,ku(e))},t)},t)},pt.getChildByName=function(i){var o,n;for(o=0;o<this.children.length;o++)if((n=this.children[o]).name==i)return n},ld.prototype={remove:function(i){Vu(i),this.entries[i.id]=null},find:function(i){var o,n=i.split("/"),t=this.root;for(o=0;t&&o<n.length;o++)t=t.getChildByName(n[o]);return t},getById:function(i){return this.entries[i]},importBlob:function(i,o,n){ia(this),this.root.importBlob(i,o,n)},importText:function(i,o,n){ia(this),this.root.importText(i,o,n)},importData64URI:function(i,o,n){ia(this),this.root.importData64URI(i,o,n)},exportBlob:function(i,o,n){this.root.exportBlob(i,o,n)},exportText:function(i,o,n){this.root.exportText(i,o,n)},exportFileEntry:function(i,o,n,t){this.root.exportFileEntry(i,o,n,t)},exportData64URI:function(i,o,n){this.root.exportData64URI(i,o,n)}},We.getMimeType=function(){return"application/octet-stream"};var op={FS:ld,ZipDirectoryEntry:Ki,ZipFileEntry:da};We.useWebWorkers=!1;var sp=function(){function i(n,t){this.el=n,this.inputEl=t,this.listeners={drop:[],dropstart:[],droperror:[]},this._onDragover=this._onDragover.bind(this),this._onDrop=this._onDrop.bind(this),this._onSelect=this._onSelect.bind(this),n.addEventListener("dragover",this._onDragover,!1),n.addEventListener("drop",this._onDrop,!1),t.addEventListener("change",this._onSelect)}var o=i.prototype;return o.on=function(n,t){return this.listeners[n].push(t),this},o._emit=function(n,t){return this.listeners[n].forEach(function(e){return e(t)}),this},o.destroy=function(){var n=this.el,t=this.inputEl;n.removeEventListener("dragover",this._onDragover,!1),n.removeEventListener("drop",this._onDrop,!1),t.removeEventListener("change",this._onSelect),delete this.el,delete this.inputEl,delete this.listeners},o._onDrop=function(n){n.stopPropagation(),n.preventDefault(),this._emit("dropstart");var t=Array.from(n.dataTransfer.files||[]),e=Array.from(n.dataTransfer.items||[]);if(t.length!==0||e.length!==0)if(e.length>0){var r=e.map(function(a){return a.webkitGetAsEntry()});r[0].name.match(/\.zip$/)?this._loadZip(e[0].getAsFile()):this._loadNextEntry(new Map,r)}else t.length===1&&t[0].name.match(/\.zip$/)&&this._loadZip(t[0]),this._emit("drop",{files:new Map(t.map(function(a){return[a.name,a]}))});else this._fail("Required drag-and-drop APIs are not supported in this browser.")},o._onDragover=function(n){n.stopPropagation(),n.preventDefault(),n.dataTransfer.dropEffect="copy"},o._onSelect=function(n){this._emit("dropstart");var t=[].slice.call(this.inputEl.files);if(t.length===1&&this._isZip(t[0]))this._loadZip(t[0]);else{var e=new Map;t.forEach(function(r){return e.set(r.webkitRelativePath||r.name,r)}),this._emit("drop",{files:e})}},o._loadNextEntry=function(n,t){var e=this,r=t.pop();if(r)if(r.isFile)r.file(function(s){n.set(r.fullPath,s),e._loadNextEntry(n,t)},function(){return console.error("Could not load file: %s",r.fullPath)});else if(r.isDirectory){var a=r.createReader();a.readEntries(function s(l){l.length?(t=t.concat(l),a.readEntries(s)):e._loadNextEntry(n,t)})}else console.warn("Unknown asset type: "+r.fullPath),this._loadNextEntry(n,t);else this._emit("drop",{files:n})},o._loadZip=function(n){var t=this,e=[],r=new Map,a=new op.FS,s=function l(c){c.directory?c.children.forEach(l):c.name[0]!=="."&&e.push(new Promise(function(u){c.getData(new We.BlobWriter,function(h){h.name=c.name,r.set(c.getFullname(),h),u()})}))};a.importBlob(n,function(){s(a.root),Promise.all(e).then(function(){t._emit("drop",{files:r,archive:n})})})},o._isZip=function(n){return n.type==="application/zip"||n.name.match(/\.zip$/)},o._fail=function(n){this._emit("droperror",{message:n})},i}();function lp(i){if(!!i&&typeof window!="undefined"){var o=document.createElement("style");return o.setAttribute("type","text/css"),o.innerHTML=i,document.head.appendChild(o),i}}function qi(i,o){var n=i.__state.conversionName.toString(),t=Math.round(i.r),e=Math.round(i.g),r=Math.round(i.b),a=i.a,s=Math.round(i.h),l=i.s.toFixed(1),c=i.v.toFixed(1);if(o||n==="THREE_CHAR_HEX"||n==="SIX_CHAR_HEX"){for(var u=i.hex.toString(16);u.length<6;)u="0"+u;return"#"+u}else{if(n==="CSS_RGB")return"rgb("+t+","+e+","+r+")";if(n==="CSS_RGBA")return"rgba("+t+","+e+","+r+","+a+")";if(n==="HEX")return"0x"+i.hex.toString(16);if(n==="RGB_ARRAY")return"["+t+","+e+","+r+"]";if(n==="RGBA_ARRAY")return"["+t+","+e+","+r+","+a+"]";if(n==="RGB_OBJ")return"{r:"+t+",g:"+e+",b:"+r+"}";if(n==="RGBA_OBJ")return"{r:"+t+",g:"+e+",b:"+r+",a:"+a+"}";if(n==="HSV_OBJ")return"{h:"+s+",s:"+l+",v:"+c+"}";if(n==="HSVA_OBJ")return"{h:"+s+",s:"+l+",v:"+c+",a:"+a+"}"}return"unknown format"}var Gu=Array.prototype.forEach,un=Array.prototype.slice,G={BREAK:{},extend:function(o){return this.each(un.call(arguments,1),function(n){var t=this.isObject(n)?Object.keys(n):[];t.forEach(function(e){this.isUndefined(n[e])||(o[e]=n[e])}.bind(this))},this),o},defaults:function(o){return this.each(un.call(arguments,1),function(n){var t=this.isObject(n)?Object.keys(n):[];t.forEach(function(e){this.isUndefined(o[e])&&(o[e]=n[e])}.bind(this))},this),o},compose:function(){var o=un.call(arguments);return function(){for(var n=un.call(arguments),t=o.length-1;t>=0;t--)n=[o[t].apply(this,n)];return n[0]}},each:function(o,n,t){if(!!o){if(Gu&&o.forEach&&o.forEach===Gu)o.forEach(n,t);else if(o.length===o.length+0){var e=void 0,r=void 0;for(e=0,r=o.length;e<r;e++)if(e in o&&n.call(t,o[e],e)===this.BREAK)return}else for(var a in o)if(n.call(t,o[a],a)===this.BREAK)return}},defer:function(o){setTimeout(o,0)},debounce:function(o,n,t){var e=void 0;return function(){var r=this,a=arguments;function s(){e=null,t||o.apply(r,a)}var l=t||!e;clearTimeout(e),e=setTimeout(s,n),l&&o.apply(r,a)}},toArray:function(o){return o.toArray?o.toArray():un.call(o)},isUndefined:function(o){return o===void 0},isNull:function(o){return o===null},isNaN:function(i){function o(n){return i.apply(this,arguments)}return o.toString=function(){return i.toString()},o}(function(i){return isNaN(i)}),isArray:Array.isArray||function(i){return i.constructor===Array},isObject:function(o){return o===Object(o)},isNumber:function(o){return o===o+0},isString:function(o){return o===o+""},isBoolean:function(o){return o===!1||o===!0},isFunction:function(o){return o instanceof Function}},cp=[{litmus:G.isString,conversions:{THREE_CHAR_HEX:{read:function(o){var n=o.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return n===null?!1:{space:"HEX",hex:parseInt("0x"+n[1].toString()+n[1].toString()+n[2].toString()+n[2].toString()+n[3].toString()+n[3].toString(),0)}},write:qi},SIX_CHAR_HEX:{read:function(o){var n=o.match(/^#([A-F0-9]{6})$/i);return n===null?!1:{space:"HEX",hex:parseInt("0x"+n[1].toString(),0)}},write:qi},CSS_RGB:{read:function(o){var n=o.match(/^rgb\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return n===null?!1:{space:"RGB",r:parseFloat(n[1]),g:parseFloat(n[2]),b:parseFloat(n[3])}},write:qi},CSS_RGBA:{read:function(o){var n=o.match(/^rgba\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return n===null?!1:{space:"RGB",r:parseFloat(n[1]),g:parseFloat(n[2]),b:parseFloat(n[3]),a:parseFloat(n[4])}},write:qi}}},{litmus:G.isNumber,conversions:{HEX:{read:function(o){return{space:"HEX",hex:o,conversionName:"HEX"}},write:function(o){return o.hex}}}},{litmus:G.isArray,conversions:{RGB_ARRAY:{read:function(o){return o.length!==3?!1:{space:"RGB",r:o[0],g:o[1],b:o[2]}},write:function(o){return[o.r,o.g,o.b]}},RGBA_ARRAY:{read:function(o){return o.length!==4?!1:{space:"RGB",r:o[0],g:o[1],b:o[2],a:o[3]}},write:function(o){return[o.r,o.g,o.b,o.a]}}}},{litmus:G.isObject,conversions:{RGBA_OBJ:{read:function(o){return G.isNumber(o.r)&&G.isNumber(o.g)&&G.isNumber(o.b)&&G.isNumber(o.a)?{space:"RGB",r:o.r,g:o.g,b:o.b,a:o.a}:!1},write:function(o){return{r:o.r,g:o.g,b:o.b,a:o.a}}},RGB_OBJ:{read:function(o){return G.isNumber(o.r)&&G.isNumber(o.g)&&G.isNumber(o.b)?{space:"RGB",r:o.r,g:o.g,b:o.b}:!1},write:function(o){return{r:o.r,g:o.g,b:o.b}}},HSVA_OBJ:{read:function(o){return G.isNumber(o.h)&&G.isNumber(o.s)&&G.isNumber(o.v)&&G.isNumber(o.a)?{space:"HSV",h:o.h,s:o.s,v:o.v,a:o.a}:!1},write:function(o){return{h:o.h,s:o.s,v:o.v,a:o.a}}},HSV_OBJ:{read:function(o){return G.isNumber(o.h)&&G.isNumber(o.s)&&G.isNumber(o.v)?{space:"HSV",h:o.h,s:o.s,v:o.v}:!1},write:function(o){return{h:o.h,s:o.s,v:o.v}}}}}],hn=void 0,Yn=void 0,so=function(){Yn=!1;var o=arguments.length>1?G.toArray(arguments):arguments[0];return G.each(cp,function(n){if(n.litmus(o))return G.each(n.conversions,function(t,e){if(hn=t.read(o),Yn===!1&&hn!==!1)return Yn=hn,hn.conversionName=e,hn.conversion=t,G.BREAK}),G.BREAK}),Yn},Hu=void 0,_a={hsv_to_rgb:function(o,n,t){var e=Math.floor(o/60)%6,r=o/60-Math.floor(o/60),a=t*(1-n),s=t*(1-r*n),l=t*(1-(1-r)*n),c=[[t,l,a],[s,t,a],[a,t,l],[a,s,t],[l,a,t],[t,a,s]][e];return{r:c[0]*255,g:c[1]*255,b:c[2]*255}},rgb_to_hsv:function(o,n,t){var e=Math.min(o,n,t),r=Math.max(o,n,t),a=r-e,s=void 0,l=void 0;if(r!==0)l=a/r;else return{h:NaN,s:0,v:0};return o===r?s=(n-t)/a:n===r?s=2+(t-o)/a:s=4+(o-n)/a,s/=6,s<0&&(s+=1),{h:s*360,s:l,v:r/255}},rgb_to_hex:function(o,n,t){var e=this.hex_with_component(0,2,o);return e=this.hex_with_component(e,1,n),e=this.hex_with_component(e,0,t),e},component_from_hex:function(o,n){return o>>n*8&255},hex_with_component:function(o,n,t){return t<<(Hu=n*8)|o&~(255<<Hu)}},up=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(i){return typeof i}:function(i){return i&&typeof Symbol=="function"&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i},xr=function(i,o){if(!(i instanceof o))throw new TypeError("Cannot call a class as a function")},br=function(){function i(o,n){for(var t=0;t<n.length;t++){var e=n[t];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(o,e.key,e)}}return function(o,n,t){return n&&i(o.prototype,n),t&&i(o,t),o}}(),li=function i(o,n,t){o===null&&(o=Function.prototype);var e=Object.getOwnPropertyDescriptor(o,n);if(e===void 0){var r=Object.getPrototypeOf(o);return r===null?void 0:i(r,n,t)}else{if("value"in e)return e.value;var a=e.get;return a===void 0?void 0:a.call(t)}},fi=function(i,o){if(typeof o!="function"&&o!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof o);i.prototype=Object.create(o&&o.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),o&&(Object.setPrototypeOf?Object.setPrototypeOf(i,o):i.__proto__=o)},vi=function(i,o){if(!i)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return o&&(typeof o=="object"||typeof o=="function")?o:i},yt=function(){function i(){if(xr(this,i),this.__state=so.apply(this,arguments),this.__state===!1)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return br(i,[{key:"toString",value:function(){return qi(this)}},{key:"toHexString",value:function(){return qi(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),i}();function Eo(i,o,n){Object.defineProperty(i,o,{get:function(){return this.__state.space==="RGB"?this.__state[o]:(yt.recalculateRGB(this,o,n),this.__state[o])},set:function(e){this.__state.space!=="RGB"&&(yt.recalculateRGB(this,o,n),this.__state.space="RGB"),this.__state[o]=e}})}function Ro(i,o){Object.defineProperty(i,o,{get:function(){return this.__state.space==="HSV"?this.__state[o]:(yt.recalculateHSV(this),this.__state[o])},set:function(t){this.__state.space!=="HSV"&&(yt.recalculateHSV(this),this.__state.space="HSV"),this.__state[o]=t}})}yt.recalculateRGB=function(i,o,n){if(i.__state.space==="HEX")i.__state[o]=_a.component_from_hex(i.__state.hex,n);else if(i.__state.space==="HSV")G.extend(i.__state,_a.hsv_to_rgb(i.__state.h,i.__state.s,i.__state.v));else throw new Error("Corrupted color state")};yt.recalculateHSV=function(i){var o=_a.rgb_to_hsv(i.r,i.g,i.b);G.extend(i.__state,{s:o.s,v:o.v}),G.isNaN(o.h)?G.isUndefined(i.__state.h)&&(i.__state.h=0):i.__state.h=o.h};yt.COMPONENTS=["r","g","b","h","s","v","hex","a"];Eo(yt.prototype,"r",2);Eo(yt.prototype,"g",1);Eo(yt.prototype,"b",0);Ro(yt.prototype,"h");Ro(yt.prototype,"s");Ro(yt.prototype,"v");Object.defineProperty(yt.prototype,"a",{get:function(){return this.__state.a},set:function(o){this.__state.a=o}});Object.defineProperty(yt.prototype,"hex",{get:function(){return this.__state.space!=="HEX"&&(this.__state.hex=_a.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(o){this.__state.space="HEX",this.__state.hex=o}});var zi=function(){function i(o,n){xr(this,i),this.initialValue=o[n],this.domElement=document.createElement("div"),this.object=o,this.property=n,this.__onChange=void 0,this.__onFinishChange=void 0}return br(i,[{key:"onChange",value:function(n){return this.__onChange=n,this}},{key:"onFinishChange",value:function(n){return this.__onFinishChange=n,this}},{key:"setValue",value:function(n){return this.object[this.property]=n,this.__onChange&&this.__onChange.call(this,n),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),i}(),hp={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},cd={};G.each(hp,function(i,o){G.each(i,function(n){cd[n]=o})});var dp=/(\d+(\.\d+)?)px/;function Tr(i){if(i==="0"||G.isUndefined(i))return 0;var o=i.match(dp);return G.isNull(o)?0:parseFloat(o[1])}var O={makeSelectable:function(o,n){o===void 0||o.style===void 0||(o.onselectstart=n?function(){return!1}:function(){},o.style.MozUserSelect=n?"auto":"none",o.style.KhtmlUserSelect=n?"auto":"none",o.unselectable=n?"on":"off")},makeFullscreen:function(o,n,t){var e=t,r=n;G.isUndefined(r)&&(r=!0),G.isUndefined(e)&&(e=!0),o.style.position="absolute",r&&(o.style.left=0,o.style.right=0),e&&(o.style.top=0,o.style.bottom=0)},fakeEvent:function(o,n,t,e){var r=t||{},a=cd[n];if(!a)throw new Error("Event type "+n+" not supported.");var s=document.createEvent(a);switch(a){case"MouseEvents":{var l=r.x||r.clientX||0,c=r.y||r.clientY||0;s.initMouseEvent(n,r.bubbles||!1,r.cancelable||!0,window,r.clickCount||1,0,0,l,c,!1,!1,!1,!1,0,null);break}case"KeyboardEvents":{var u=s.initKeyboardEvent||s.initKeyEvent;G.defaults(r,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),u(n,r.bubbles||!1,r.cancelable,window,r.ctrlKey,r.altKey,r.shiftKey,r.metaKey,r.keyCode,r.charCode);break}default:{s.initEvent(n,r.bubbles||!1,r.cancelable||!0);break}}G.defaults(s,e),o.dispatchEvent(s)},bind:function(o,n,t,e){var r=e||!1;return o.addEventListener?o.addEventListener(n,t,r):o.attachEvent&&o.attachEvent("on"+n,t),O},unbind:function(o,n,t,e){var r=e||!1;return o.removeEventListener?o.removeEventListener(n,t,r):o.detachEvent&&o.detachEvent("on"+n,t),O},addClass:function(o,n){if(o.className===void 0)o.className=n;else if(o.className!==n){var t=o.className.split(/ +/);t.indexOf(n)===-1&&(t.push(n),o.className=t.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return O},removeClass:function(o,n){if(n)if(o.className===n)o.removeAttribute("class");else{var t=o.className.split(/ +/),e=t.indexOf(n);e!==-1&&(t.splice(e,1),o.className=t.join(" "))}else o.className=void 0;return O},hasClass:function(o,n){return new RegExp("(?:^|\\s+)"+n+"(?:\\s+|$)").test(o.className)||!1},getWidth:function(o){var n=getComputedStyle(o);return Tr(n["border-left-width"])+Tr(n["border-right-width"])+Tr(n["padding-left"])+Tr(n["padding-right"])+Tr(n.width)},getHeight:function(o){var n=getComputedStyle(o);return Tr(n["border-top-width"])+Tr(n["border-bottom-width"])+Tr(n["padding-top"])+Tr(n["padding-bottom"])+Tr(n.height)},getOffset:function(o){var n=o,t={left:0,top:0};if(n.offsetParent)do t.left+=n.offsetLeft,t.top+=n.offsetTop,n=n.offsetParent;while(n);return t},isActive:function(o){return o===document.activeElement&&(o.type||o.href)}},ud=function(i){fi(o,i);function o(n,t){xr(this,o);var e=vi(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,n,t)),r=e;e.__prev=e.getValue(),e.__checkbox=document.createElement("input"),e.__checkbox.setAttribute("type","checkbox");function a(){r.setValue(!r.__prev)}return O.bind(e.__checkbox,"change",a,!1),e.domElement.appendChild(e.__checkbox),e.updateDisplay(),e}return br(o,[{key:"setValue",value:function(t){var e=li(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"setValue",this).call(this,t);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),e}},{key:"updateDisplay",value:function(){return this.getValue()===!0?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),li(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"updateDisplay",this).call(this)}}]),o}(zi),_p=function(i){fi(o,i);function o(n,t,e){xr(this,o);var r=vi(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,n,t)),a=e,s=r;if(r.__select=document.createElement("select"),G.isArray(a)){var l={};G.each(a,function(c){l[c]=c}),a=l}return G.each(a,function(c,u){var h=document.createElement("option");h.innerHTML=u,h.setAttribute("value",c),s.__select.appendChild(h)}),r.updateDisplay(),O.bind(r.__select,"change",function(){var c=this.options[this.selectedIndex].value;s.setValue(c)}),r.domElement.appendChild(r.__select),r}return br(o,[{key:"setValue",value:function(t){var e=li(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"setValue",this).call(this,t);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),e}},{key:"updateDisplay",value:function(){return O.isActive(this.__select)?this:(this.__select.value=this.getValue(),li(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"updateDisplay",this).call(this))}}]),o}(zi),fp=function(i){fi(o,i);function o(n,t){xr(this,o);var e=vi(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,n,t)),r=e;function a(){r.setValue(r.__input.value)}function s(){r.__onFinishChange&&r.__onFinishChange.call(r,r.getValue())}return e.__input=document.createElement("input"),e.__input.setAttribute("type","text"),O.bind(e.__input,"keyup",a),O.bind(e.__input,"change",a),O.bind(e.__input,"blur",s),O.bind(e.__input,"keydown",function(l){l.keyCode===13&&this.blur()}),e.updateDisplay(),e.domElement.appendChild(e.__input),e}return br(o,[{key:"updateDisplay",value:function(){return O.isActive(this.__input)||(this.__input.value=this.getValue()),li(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"updateDisplay",this).call(this)}}]),o}(zi);function Wu(i){var o=i.toString();return o.indexOf(".")>-1?o.length-o.indexOf(".")-1:0}var hd=function(i){fi(o,i);function o(n,t,e){xr(this,o);var r=vi(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,n,t)),a=e||{};return r.__min=a.min,r.__max=a.max,r.__step=a.step,G.isUndefined(r.__step)?r.initialValue===0?r.__impliedStep=1:r.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(r.initialValue))/Math.LN10))/10:r.__impliedStep=r.__step,r.__precision=Wu(r.__impliedStep),r}return br(o,[{key:"setValue",value:function(t){var e=t;return this.__min!==void 0&&e<this.__min?e=this.__min:this.__max!==void 0&&e>this.__max&&(e=this.__max),this.__step!==void 0&&e%this.__step!==0&&(e=Math.round(e/this.__step)*this.__step),li(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"setValue",this).call(this,e)}},{key:"min",value:function(t){return this.__min=t,this}},{key:"max",value:function(t){return this.__max=t,this}},{key:"step",value:function(t){return this.__step=t,this.__impliedStep=t,this.__precision=Wu(t),this}}]),o}(zi);function vp(i,o){var n=Math.pow(10,o);return Math.round(i*n)/n}var fa=function(i){fi(o,i);function o(n,t,e){xr(this,o);var r=vi(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,n,t,e));r.__truncationSuspended=!1;var a=r,s=void 0;function l(){var _=parseFloat(a.__input.value);G.isNaN(_)||a.setValue(_)}function c(){a.__onFinishChange&&a.__onFinishChange.call(a,a.getValue())}function u(){c()}function h(_){var g=s-_.clientY;a.setValue(a.getValue()+g*a.__impliedStep),s=_.clientY}function d(){O.unbind(window,"mousemove",h),O.unbind(window,"mouseup",d),c()}function f(_){O.bind(window,"mousemove",h),O.bind(window,"mouseup",d),s=_.clientY}return r.__input=document.createElement("input"),r.__input.setAttribute("type","text"),O.bind(r.__input,"change",l),O.bind(r.__input,"blur",u),O.bind(r.__input,"mousedown",f),O.bind(r.__input,"keydown",function(_){_.keyCode===13&&(a.__truncationSuspended=!0,this.blur(),a.__truncationSuspended=!1,c())}),r.updateDisplay(),r.domElement.appendChild(r.__input),r}return br(o,[{key:"updateDisplay",value:function(){return this.__input.value=this.__truncationSuspended?this.getValue():vp(this.getValue(),this.__precision),li(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"updateDisplay",this).call(this)}}]),o}(hd);function Xu(i,o,n,t,e){return t+(e-t)*((i-o)/(n-o))}var lo=function(i){fi(o,i);function o(n,t,e,r,a){xr(this,o);var s=vi(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,n,t,{min:e,max:r,step:a})),l=s;s.__background=document.createElement("div"),s.__foreground=document.createElement("div"),O.bind(s.__background,"mousedown",c),O.bind(s.__background,"touchstart",d),O.addClass(s.__background,"slider"),O.addClass(s.__foreground,"slider-fg");function c(g){document.activeElement.blur(),O.bind(window,"mousemove",u),O.bind(window,"mouseup",h),u(g)}function u(g){g.preventDefault();var v=l.__background.getBoundingClientRect();return l.setValue(Xu(g.clientX,v.left,v.right,l.__min,l.__max)),!1}function h(){O.unbind(window,"mousemove",u),O.unbind(window,"mouseup",h),l.__onFinishChange&&l.__onFinishChange.call(l,l.getValue())}function d(g){g.touches.length===1&&(O.bind(window,"touchmove",f),O.bind(window,"touchend",_),f(g))}function f(g){var v=g.touches[0].clientX,p=l.__background.getBoundingClientRect();l.setValue(Xu(v,p.left,p.right,l.__min,l.__max))}function _(){O.unbind(window,"touchmove",f),O.unbind(window,"touchend",_),l.__onFinishChange&&l.__onFinishChange.call(l,l.getValue())}return s.updateDisplay(),s.__background.appendChild(s.__foreground),s.domElement.appendChild(s.__background),s}return br(o,[{key:"updateDisplay",value:function(){var t=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=t*100+"%",li(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"updateDisplay",this).call(this)}}]),o}(hd),dd=function(i){fi(o,i);function o(n,t,e){xr(this,o);var r=vi(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,n,t)),a=r;return r.__button=document.createElement("div"),r.__button.innerHTML=e===void 0?"Fire":e,O.bind(r.__button,"click",function(s){return s.preventDefault(),a.fire(),!1}),O.addClass(r.__button,"button"),r.domElement.appendChild(r.__button),r}return br(o,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),o}(zi),co=function(i){fi(o,i);function o(n,t){xr(this,o);var e=vi(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,n,t));e.__color=new yt(e.getValue()),e.__temp=new yt(0);var r=e;e.domElement=document.createElement("div"),O.makeSelectable(e.domElement,!1),e.__selector=document.createElement("div"),e.__selector.className="selector",e.__saturation_field=document.createElement("div"),e.__saturation_field.className="saturation-field",e.__field_knob=document.createElement("div"),e.__field_knob.className="field-knob",e.__field_knob_border="2px solid ",e.__hue_knob=document.createElement("div"),e.__hue_knob.className="hue-knob",e.__hue_field=document.createElement("div"),e.__hue_field.className="hue-field",e.__input=document.createElement("input"),e.__input.type="text",e.__input_textShadow="0 1px 1px ",O.bind(e.__input,"keydown",function(g){g.keyCode===13&&h.call(this)}),O.bind(e.__input,"blur",h),O.bind(e.__selector,"mousedown",function(){O.addClass(this,"drag").bind(window,"mouseup",function(){O.removeClass(r.__selector,"drag")})}),O.bind(e.__selector,"touchstart",function(){O.addClass(this,"drag").bind(window,"touchend",function(){O.removeClass(r.__selector,"drag")})});var a=document.createElement("div");G.extend(e.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),G.extend(e.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:e.__field_knob_border+(e.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),G.extend(e.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),G.extend(e.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),G.extend(a.style,{width:"100%",height:"100%",background:"none"}),ju(a,"top","rgba(0,0,0,0)","#000"),G.extend(e.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),gp(e.__hue_field),G.extend(e.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:e.__input_textShadow+"rgba(0,0,0,0.7)"}),O.bind(e.__saturation_field,"mousedown",s),O.bind(e.__saturation_field,"touchstart",s),O.bind(e.__field_knob,"mousedown",s),O.bind(e.__field_knob,"touchstart",s),O.bind(e.__hue_field,"mousedown",l),O.bind(e.__hue_field,"touchstart",l);function s(g){f(g),O.bind(window,"mousemove",f),O.bind(window,"touchmove",f),O.bind(window,"mouseup",c),O.bind(window,"touchend",c)}function l(g){_(g),O.bind(window,"mousemove",_),O.bind(window,"touchmove",_),O.bind(window,"mouseup",u),O.bind(window,"touchend",u)}function c(){O.unbind(window,"mousemove",f),O.unbind(window,"touchmove",f),O.unbind(window,"mouseup",c),O.unbind(window,"touchend",c),d()}function u(){O.unbind(window,"mousemove",_),O.unbind(window,"touchmove",_),O.unbind(window,"mouseup",u),O.unbind(window,"touchend",u),d()}function h(){var g=so(this.value);g!==!1?(r.__color.__state=g,r.setValue(r.__color.toOriginal())):this.value=r.__color.toString()}function d(){r.__onFinishChange&&r.__onFinishChange.call(r,r.__color.toOriginal())}e.__saturation_field.appendChild(a),e.__selector.appendChild(e.__field_knob),e.__selector.appendChild(e.__saturation_field),e.__selector.appendChild(e.__hue_field),e.__hue_field.appendChild(e.__hue_knob),e.domElement.appendChild(e.__input),e.domElement.appendChild(e.__selector),e.updateDisplay();function f(g){g.type.indexOf("touch")===-1&&g.preventDefault();var v=r.__saturation_field.getBoundingClientRect(),p=g.touches&&g.touches[0]||g,m=p.clientX,y=p.clientY,x=(m-v.left)/(v.right-v.left),S=1-(y-v.top)/(v.bottom-v.top);return S>1?S=1:S<0&&(S=0),x>1?x=1:x<0&&(x=0),r.__color.v=S,r.__color.s=x,r.setValue(r.__color.toOriginal()),!1}function _(g){g.type.indexOf("touch")===-1&&g.preventDefault();var v=r.__hue_field.getBoundingClientRect(),p=g.touches&&g.touches[0]||g,m=p.clientY,y=1-(m-v.top)/(v.bottom-v.top);return y>1?y=1:y<0&&(y=0),r.__color.h=y*360,r.setValue(r.__color.toOriginal()),!1}return e}return br(o,[{key:"updateDisplay",value:function(){var t=so(this.getValue());if(t!==!1){var e=!1;G.each(yt.COMPONENTS,function(s){if(!G.isUndefined(t[s])&&!G.isUndefined(this.__color.__state[s])&&t[s]!==this.__color.__state[s])return e=!0,{}},this),e&&G.extend(this.__color.__state,t)}G.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var r=this.__color.v<.5||this.__color.s>.5?255:0,a=255-r;G.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+r+","+r+","+r+")"}),this.__hue_knob.style.marginTop=(1-this.__color.h/360)*100+"px",this.__temp.s=1,this.__temp.v=1,ju(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),G.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+r+","+r+","+r+")",textShadow:this.__input_textShadow+"rgba("+a+","+a+","+a+",.7)"})}}]),o}(zi),pp=["-moz-","-o-","-webkit-","-ms-",""];function ju(i,o,n,t){i.style.background="",G.each(pp,function(e){i.style.cssText+="background: "+e+"linear-gradient("+o+", "+n+" 0%, "+t+" 100%); "})}function gp(i){i.style.background="",i.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",i.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",i.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",i.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",i.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var mp={load:function(o,n){var t=n||document,e=t.createElement("link");e.type="text/css",e.rel="stylesheet",e.href=o,t.getElementsByTagName("head")[0].appendChild(e)},inject:function(o,n){var t=n||document,e=document.createElement("style");e.type="text/css",e.innerHTML=o;var r=t.getElementsByTagName("head")[0];try{r.appendChild(e)}catch{}}},yp=`<div id="dg-save" class="dg dialogue">

  Here's the new load parameter for your <code>GUI</code>'s constructor:

  <textarea id="dg-new-constructor"></textarea>

  <div id="dg-save-locally">

    <input id="dg-local-storage" type="checkbox"/> Automatically save
    values to <code>localStorage</code> on exit.

    <div id="dg-local-explain">The values saved to <code>localStorage</code> will
      override those passed to <code>dat.GUI</code>'s constructor. This makes it
      easier to work incrementally, but <code>localStorage</code> is fragile,
      and your friends may not see the same values you do.

    </div>

  </div>

</div>`,xp=function(o,n){var t=o[n];return G.isArray(arguments[2])||G.isObject(arguments[2])?new _p(o,n,arguments[2]):G.isNumber(t)?G.isNumber(arguments[2])&&G.isNumber(arguments[3])?G.isNumber(arguments[4])?new lo(o,n,arguments[2],arguments[3],arguments[4]):new lo(o,n,arguments[2],arguments[3]):G.isNumber(arguments[4])?new fa(o,n,{min:arguments[2],max:arguments[3],step:arguments[4]}):new fa(o,n,{min:arguments[2],max:arguments[3]}):G.isString(t)?new fp(o,n):G.isFunction(t)?new dd(o,n,""):G.isBoolean(t)?new ud(o,n):null};function bp(i){setTimeout(i,1e3/60)}var wp=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||bp,Sp=function(){function i(){xr(this,i),this.backgroundElement=document.createElement("div"),G.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),O.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),G.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var o=this;O.bind(this.backgroundElement,"click",function(){o.hide()})}return br(i,[{key:"show",value:function(){var n=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),G.defer(function(){n.backgroundElement.style.opacity=1,n.domElement.style.opacity=1,n.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var n=this,t=function e(){n.domElement.style.display="none",n.backgroundElement.style.display="none",O.unbind(n.domElement,"webkitTransitionEnd",e),O.unbind(n.domElement,"transitionend",e),O.unbind(n.domElement,"oTransitionEnd",e)};O.bind(this.domElement,"webkitTransitionEnd",t),O.bind(this.domElement,"transitionend",t),O.bind(this.domElement,"oTransitionEnd",t),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-O.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-O.getHeight(this.domElement)/2+"px"}}]),i}(),Cp=lp(`.dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .cr.function .property-name{width:100%}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}
`);mp.inject(Cp);var $u="dg",qu=72,Yu=20,zn="Default",fn=function(){try{return!!window.localStorage}catch{return!1}}(),mn=void 0,Qu=!0,Hi=void 0,Oa=!1,_d=[],$e=function i(o){var n=this,t=o||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),O.addClass(this.domElement,$u),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],t=G.defaults(t,{closeOnTop:!1,autoPlace:!0,width:i.DEFAULT_WIDTH}),t=G.defaults(t,{resizable:t.autoPlace,hideable:t.autoPlace}),G.isUndefined(t.load)?t.load={preset:zn}:t.preset&&(t.load.preset=t.preset),G.isUndefined(t.parent)&&t.hideable&&_d.push(this),t.resizable=G.isUndefined(t.parent)&&t.resizable,t.autoPlace&&G.isUndefined(t.scrollable)&&(t.scrollable=!0);var e=fn&&localStorage.getItem(Wi(this,"isLocal"))==="true",r=void 0,a=void 0;if(Object.defineProperties(this,{parent:{get:function(){return t.parent}},scrollable:{get:function(){return t.scrollable}},autoPlace:{get:function(){return t.autoPlace}},closeOnTop:{get:function(){return t.closeOnTop}},preset:{get:function(){return n.parent?n.getRoot().preset:t.load.preset},set:function(d){n.parent?n.getRoot().preset=d:t.load.preset=d,Mp(this),n.revert()}},width:{get:function(){return t.width},set:function(d){t.width=d,_o(n,d)}},name:{get:function(){return t.name},set:function(d){t.name=d,a&&(a.innerHTML=t.name)}},closed:{get:function(){return t.closed},set:function(d){t.closed=d,t.closed?O.addClass(n.__ul,i.CLASS_CLOSED):O.removeClass(n.__ul,i.CLASS_CLOSED),this.onResize(),n.__closeButton&&(n.__closeButton.innerHTML=d?i.TEXT_OPEN:i.TEXT_CLOSED)}},load:{get:function(){return t.load}},useLocalStorage:{get:function(){return e},set:function(d){fn&&(e=d,d?O.bind(window,"unload",r):O.unbind(window,"unload",r),localStorage.setItem(Wi(n,"isLocal"),d))}}}),G.isUndefined(t.parent)){if(this.closed=t.closed||!1,O.addClass(this.domElement,i.CLASS_MAIN),O.makeSelectable(this.domElement,!1),fn&&e){n.useLocalStorage=!0;var s=localStorage.getItem(Wi(this,"gui"));s&&(t.load=JSON.parse(s))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=i.TEXT_CLOSED,O.addClass(this.__closeButton,i.CLASS_CLOSE_BUTTON),t.closeOnTop?(O.addClass(this.__closeButton,i.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(O.addClass(this.__closeButton,i.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),O.bind(this.__closeButton,"click",function(){n.closed=!n.closed})}else{t.closed===void 0&&(t.closed=!0);var l=document.createTextNode(t.name);O.addClass(l,"controller-name"),a=Fo(n,l);var c=function(d){return d.preventDefault(),n.closed=!n.closed,!1};O.addClass(this.__ul,i.CLASS_CLOSED),O.addClass(a,"title"),O.bind(a,"click",c),t.closed||(this.closed=!1)}t.autoPlace&&(G.isUndefined(t.parent)&&(Qu&&(Hi=document.createElement("div"),O.addClass(Hi,$u),O.addClass(Hi,i.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(Hi),Qu=!1),Hi.appendChild(this.domElement),O.addClass(this.domElement,i.CLASS_AUTO_PLACE)),this.parent||_o(n,t.width)),this.__resizeHandler=function(){n.onResizeDebounced()},O.bind(window,"resize",this.__resizeHandler),O.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),O.bind(this.__ul,"transitionend",this.__resizeHandler),O.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),t.resizable&&Pp(this),r=function(){fn&&localStorage.getItem(Wi(n,"isLocal"))==="true"&&localStorage.setItem(Wi(n,"gui"),JSON.stringify(n.getSaveObject()))},this.saveToLocalStorageIfPossible=r;function u(){var h=n.getRoot();h.width+=1,G.defer(function(){h.width-=1})}t.parent||u()};$e.toggleHide=function(){Oa=!Oa,G.each(_d,function(i){i.domElement.style.display=Oa?"none":""})};$e.CLASS_AUTO_PLACE="a";$e.CLASS_AUTO_PLACE_CONTAINER="ac";$e.CLASS_MAIN="main";$e.CLASS_CONTROLLER_ROW="cr";$e.CLASS_TOO_TALL="taller-than-window";$e.CLASS_CLOSED="closed";$e.CLASS_CLOSE_BUTTON="close-button";$e.CLASS_CLOSE_TOP="close-top";$e.CLASS_CLOSE_BOTTOM="close-bottom";$e.CLASS_DRAG="drag";$e.DEFAULT_WIDTH=245;$e.TEXT_CLOSED="Close Controls";$e.TEXT_OPEN="Open Controls";$e._keydownHandler=function(i){document.activeElement.type!=="text"&&(i.which===qu||i.keyCode===qu)&&$e.toggleHide()};O.bind(window,"keydown",$e._keydownHandler,!1);G.extend($e.prototype,{add:function(o,n){return yn(this,o,n,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(o,n){return yn(this,o,n,{color:!0})},remove:function(o){this.__ul.removeChild(o.__li),this.__controllers.splice(this.__controllers.indexOf(o),1);var n=this;G.defer(function(){n.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&Hi.removeChild(this.domElement);var o=this;G.each(this.__folders,function(n){o.removeFolder(n)}),O.unbind(window,"keydown",$e._keydownHandler,!1),Ju(this)},addFolder:function(o){if(this.__folders[o]!==void 0)throw new Error('You already have a folder in this GUI by the name "'+o+'"');var n={name:o,parent:this};n.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[o]&&(n.closed=this.load.folders[o].closed,n.load=this.load.folders[o]);var t=new $e(n);this.__folders[o]=t;var e=Fo(this,t.domElement);return O.addClass(e,"folder"),t},removeFolder:function(o){this.__ul.removeChild(o.domElement.parentElement),delete this.__folders[o.name],this.load&&this.load.folders&&this.load.folders[o.name]&&delete this.load.folders[o.name],Ju(o);var n=this;G.each(o.__folders,function(t){o.removeFolder(t)}),G.defer(function(){n.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var o=this.getRoot();if(o.scrollable){var n=O.getOffset(o.__ul).top,t=0;G.each(o.__ul.childNodes,function(e){o.autoPlace&&e===o.__save_row||(t+=O.getHeight(e))}),window.innerHeight-n-Yu<t?(O.addClass(o.domElement,$e.CLASS_TOO_TALL),o.__ul.style.height=window.innerHeight-n-Yu+"px"):(O.removeClass(o.domElement,$e.CLASS_TOO_TALL),o.__ul.style.height="auto")}o.__resize_handle&&G.defer(function(){o.__resize_handle.style.height=o.__ul.offsetHeight+"px"}),o.__closeButton&&(o.__closeButton.style.width=o.width+"px")},onResizeDebounced:G.debounce(function(){this.onResize()},50),remember:function(){if(G.isUndefined(mn)&&(mn=new Sp,mn.domElement.innerHTML=yp),this.parent)throw new Error("You can only call remember on a top level GUI.");var o=this;G.each(Array.prototype.slice.call(arguments),function(n){o.__rememberedObjects.length===0&&Ap(o),o.__rememberedObjects.indexOf(n)===-1&&o.__rememberedObjects.push(n)}),this.autoPlace&&_o(this,this.width)},getRoot:function(){for(var o=this;o.parent;)o=o.parent;return o},getSaveObject:function(){var o=this.load;return o.closed=this.closed,this.__rememberedObjects.length>0&&(o.preset=this.preset,o.remembered||(o.remembered={}),o.remembered[this.preset]=Qn(this)),o.folders={},G.each(this.__folders,function(n,t){o.folders[t]=n.getSaveObject()}),o},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=Qn(this),uo(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(o){this.load.remembered||(this.load.remembered={},this.load.remembered[zn]=Qn(this,!0)),this.load.remembered[o]=Qn(this),this.preset=o,ho(this,o,!0),this.saveToLocalStorageIfPossible()},revert:function(o){G.each(this.__controllers,function(n){this.getRoot().load.remembered?fd(o||this.getRoot(),n):n.setValue(n.initialValue),n.__onFinishChange&&n.__onFinishChange.call(n,n.getValue())},this),G.each(this.__folders,function(n){n.revert(n)}),o||uo(this.getRoot(),!1)},listen:function(o){var n=this.__listening.length===0;this.__listening.push(o),n&&vd(this.__listening)},updateDisplay:function(){G.each(this.__controllers,function(o){o.updateDisplay()}),G.each(this.__folders,function(o){o.updateDisplay()})}});function Fo(i,o,n){var t=document.createElement("li");return o&&t.appendChild(o),n?i.__ul.insertBefore(t,n):i.__ul.appendChild(t),i.onResize(),t}function Ju(i){O.unbind(window,"resize",i.__resizeHandler),i.saveToLocalStorageIfPossible&&O.unbind(window,"unload",i.saveToLocalStorageIfPossible)}function uo(i,o){var n=i.__preset_select[i.__preset_select.selectedIndex];o?n.innerHTML=n.value+"*":n.innerHTML=n.value}function Tp(i,o,n){if(n.__li=o,n.__gui=i,G.extend(n,{options:function(a){if(arguments.length>1){var s=n.__li.nextElementSibling;return n.remove(),yn(i,n.object,n.property,{before:s,factoryArgs:[G.toArray(arguments)]})}if(G.isArray(a)||G.isObject(a)){var l=n.__li.nextElementSibling;return n.remove(),yn(i,n.object,n.property,{before:l,factoryArgs:[a]})}},name:function(a){return n.__li.firstElementChild.firstElementChild.innerHTML=a,n},listen:function(){return n.__gui.listen(n),n},remove:function(){return n.__gui.remove(n),n}}),n instanceof lo){var t=new fa(n.object,n.property,{min:n.__min,max:n.__max,step:n.__step});G.each(["updateDisplay","onChange","onFinishChange","step","min","max"],function(r){var a=n[r],s=t[r];n[r]=t[r]=function(){var l=Array.prototype.slice.call(arguments);return s.apply(t,l),a.apply(n,l)}}),O.addClass(o,"has-slider"),n.domElement.insertBefore(t.domElement,n.domElement.firstElementChild)}else if(n instanceof fa){var e=function(a){if(G.isNumber(n.__min)&&G.isNumber(n.__max)){var s=n.__li.firstElementChild.firstElementChild.innerHTML,l=n.__gui.__listening.indexOf(n)>-1;n.remove();var c=yn(i,n.object,n.property,{before:n.__li.nextElementSibling,factoryArgs:[n.__min,n.__max,n.__step]});return c.name(s),l&&c.listen(),c}return a};n.min=G.compose(e,n.min),n.max=G.compose(e,n.max)}else n instanceof ud?(O.bind(o,"click",function(){O.fakeEvent(n.__checkbox,"click")}),O.bind(n.__checkbox,"click",function(r){r.stopPropagation()})):n instanceof dd?(O.bind(o,"click",function(){O.fakeEvent(n.__button,"click")}),O.bind(o,"mouseover",function(){O.addClass(n.__button,"hover")}),O.bind(o,"mouseout",function(){O.removeClass(n.__button,"hover")})):n instanceof co&&(O.addClass(o,"color"),n.updateDisplay=G.compose(function(r){return o.style.borderLeftColor=n.__color.toString(),r},n.updateDisplay),n.updateDisplay());n.setValue=G.compose(function(r){return i.getRoot().__preset_select&&n.isModified()&&uo(i.getRoot(),!0),r},n.setValue)}function fd(i,o){var n=i.getRoot(),t=n.__rememberedObjects.indexOf(o.object);if(t!==-1){var e=n.__rememberedObjectIndecesToControllers[t];if(e===void 0&&(e={},n.__rememberedObjectIndecesToControllers[t]=e),e[o.property]=o,n.load&&n.load.remembered){var r=n.load.remembered,a=void 0;if(r[i.preset])a=r[i.preset];else if(r[zn])a=r[zn];else return;if(a[t]&&a[t][o.property]!==void 0){var s=a[t][o.property];o.initialValue=s,o.setValue(s)}}}}function yn(i,o,n,t){if(o[n]===void 0)throw new Error('Object "'+o+'" has no property "'+n+'"');var e=void 0;if(t.color)e=new co(o,n);else{var r=[o,n].concat(t.factoryArgs);e=xp.apply(i,r)}t.before instanceof zi&&(t.before=t.before.__li),fd(i,e),O.addClass(e.domElement,"c");var a=document.createElement("span");O.addClass(a,"property-name"),a.innerHTML=e.property;var s=document.createElement("div");s.appendChild(a),s.appendChild(e.domElement);var l=Fo(i,s,t.before);return O.addClass(l,$e.CLASS_CONTROLLER_ROW),e instanceof co?O.addClass(l,"color"):O.addClass(l,up(e.getValue())),Tp(i,l,e),i.__controllers.push(e),e}function Wi(i,o){return document.location.href+"."+o}function ho(i,o,n){var t=document.createElement("option");t.innerHTML=o,t.value=o,i.__preset_select.appendChild(t),n&&(i.__preset_select.selectedIndex=i.__preset_select.length-1)}function Zu(i,o){o.style.display=i.useLocalStorage?"block":"none"}function Ap(i){var o=i.__save_row=document.createElement("li");O.addClass(i.domElement,"has-save"),i.__ul.insertBefore(o,i.__ul.firstChild),O.addClass(o,"save-row");var n=document.createElement("span");n.innerHTML="&nbsp;",O.addClass(n,"button gears");var t=document.createElement("span");t.innerHTML="Save",O.addClass(t,"button"),O.addClass(t,"save");var e=document.createElement("span");e.innerHTML="New",O.addClass(e,"button"),O.addClass(e,"save-as");var r=document.createElement("span");r.innerHTML="Revert",O.addClass(r,"button"),O.addClass(r,"revert");var a=i.__preset_select=document.createElement("select");if(i.load&&i.load.remembered?G.each(i.load.remembered,function(h,d){ho(i,d,d===i.preset)}):ho(i,zn,!1),O.bind(a,"change",function(){for(var h=0;h<i.__preset_select.length;h++)i.__preset_select[h].innerHTML=i.__preset_select[h].value;i.preset=this.value}),o.appendChild(a),o.appendChild(n),o.appendChild(t),o.appendChild(e),o.appendChild(r),fn){var s=document.getElementById("dg-local-explain"),l=document.getElementById("dg-local-storage"),c=document.getElementById("dg-save-locally");c.style.display="block",localStorage.getItem(Wi(i,"isLocal"))==="true"&&l.setAttribute("checked","checked"),Zu(i,s),O.bind(l,"change",function(){i.useLocalStorage=!i.useLocalStorage,Zu(i,s)})}var u=document.getElementById("dg-new-constructor");O.bind(u,"keydown",function(h){h.metaKey&&(h.which===67||h.keyCode===67)&&mn.hide()}),O.bind(n,"click",function(){u.innerHTML=JSON.stringify(i.getSaveObject(),void 0,2),mn.show(),u.focus(),u.select()}),O.bind(t,"click",function(){i.save()}),O.bind(e,"click",function(){var h=prompt("Enter a new preset name.");h&&i.saveAs(h)}),O.bind(r,"click",function(){i.revert()})}function Pp(i){var o=void 0;i.__resize_handle=document.createElement("div"),G.extend(i.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});function n(r){return r.preventDefault(),i.width+=o-r.clientX,i.onResize(),o=r.clientX,!1}function t(){O.removeClass(i.__closeButton,$e.CLASS_DRAG),O.unbind(window,"mousemove",n),O.unbind(window,"mouseup",t)}function e(r){return r.preventDefault(),o=r.clientX,O.addClass(i.__closeButton,$e.CLASS_DRAG),O.bind(window,"mousemove",n),O.bind(window,"mouseup",t),!1}O.bind(i.__resize_handle,"mousedown",e),O.bind(i.__closeButton,"mousedown",e),i.domElement.insertBefore(i.__resize_handle,i.domElement.firstElementChild)}function _o(i,o){i.domElement.style.width=o+"px",i.__save_row&&i.autoPlace&&(i.__save_row.style.width=o+"px"),i.__closeButton&&(i.__closeButton.style.width=o+"px")}function Qn(i,o){var n={};return G.each(i.__rememberedObjects,function(t,e){var r={},a=i.__rememberedObjectIndecesToControllers[e];G.each(a,function(s,l){r[l]=o?s.initialValue:s.getValue()}),n[e]=r}),n}function Mp(i){for(var o=0;o<i.__preset_select.length;o++)i.__preset_select[o].value===i.preset&&(i.__preset_select.selectedIndex=o)}function vd(i){i.length!==0&&wp.call(window,function(){vd(i)}),G.each(i,function(o){o.updateDisplay()})}var Ep=$e;function Ku(i,o){for(var n=0;n<o.length;n++){var t=o[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(i,t.key,t)}}function Rp(i,o,n){return o&&Ku(i.prototype,o),n&&Ku(i,n),Object.defineProperty(i,"prototype",{writable:!1}),i}function Fp(i,o){i.prototype=Object.create(o.prototype),i.prototype.constructor=i,fo(i,o)}function fo(i,o){return fo=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},fo(i,o)}var eh=H.zeroTolerance,Ia=function(){function i(n,t,e){this.radius=n,this.phi=t,this.theta=e,this.radius=n!==void 0?n:1,this.phi=t!==void 0?t:0,this.theta=e!==void 0?e:0}var o=i.prototype;return o.set=function(t,e,r){return this.radius=t,this.phi=e,this.theta=r,this},o.makeSafe=function(){return this.phi=H.clamp(this.phi,eh,Math.PI-eh),this},o.setFromVec3=function(t){return this.radius=t.length(),this.radius===0?(this.theta=0,this.phi=0):(this.theta=Math.atan2(t.x,t.z),this.phi=Math.acos(H.clamp(t.y/this.radius,-1,1))),this},o.setToVec3=function(t){var e=this.radius,r=this.phi,a=this.theta,s=Math.sin(r)*e;return t.set(s*Math.sin(a),e*Math.cos(r),s*Math.cos(a)),this},i}();H.zeroTolerance;var ze;(function(i){i[i.None=0]="None",i[i.ROTATE=1]="ROTATE",i[i.ZOOM=2]="ZOOM",i[i.PAN=4]="PAN",i[i.All=7]="All"})(ze||(ze={}));function Bo(){return function(i){}}var th,rh,Bp=(th=Bo(),th(rh=function(){function i(){}return i.onUpdateHandler=function(n){return n.isKeyHeldDown(er.ArrowLeft)||n.isKeyHeldDown(er.ArrowRight)||n.isKeyHeldDown(er.ArrowUp)||n.isKeyHeldDown(er.ArrowDown)?ze.PAN:ze.None},i.onUpdateDelta=function(n,t){var e=n.keyPanSpeed,r=n.input;t.x=t.y=0,r.isKeyHeldDown(er.ArrowLeft)&&(t.x+=e),r.isKeyHeldDown(er.ArrowRight)&&(t.x-=e),r.isKeyHeldDown(er.ArrowUp)&&(t.y+=e),r.isKeyHeldDown(er.ArrowDown)&&(t.y-=e)},i}())||rh),ih,nh,yi,Kt;(function(i){i[i.Moving=0]="Moving",i[i.Distance=1]="Distance"})(Kt||(Kt={}));var Dp=(ih=Bo(),ih(nh=(yi=function(){function i(){}return i.onUpdateHandler=function(n){++this._frameIndex;var t=n.pointers;switch(t.length){case 1:n.isPointerHeldDown(ri.Secondary)?this._updateType(ze.PAN,Kt.Moving):n.isPointerHeldDown(ri.Auxiliary)?this._updateType(ze.ZOOM,Kt.Moving):n.isPointerHeldDown(ri.Primary)?this._updateType(ze.ROTATE,Kt.Moving):this._updateType(ze.None,Kt.Moving);break;case 2:this._updateType(ze.ZOOM,Kt.Distance);break;case 3:this._updateType(ze.PAN,Kt.Moving);break;default:this._updateType(ze.None,Kt.Moving);break}return this._handlerType},i.onUpdateDelta=function(n,t){var e=this._frameIndex;switch(this._deltaType){case Kt.Moving:if(this._lastUsefulFrameIndex===e-1){var r=n.input.pointerMovingDelta;t.x=r.x,t.y=r.y}else t.x=0,t.y=0;break;case Kt.Distance:var a=n.input.pointers,s=a[0],l=a[1],c=q.distance(s.position,l.position);this._lastUsefulFrameIndex===e-1?t.set(0,this._distanceOfPointers-c,0):t.set(0,0,0),this._distanceOfPointers=c;break}this._lastUsefulFrameIndex=e},i._updateType=function(n,t){(this._handlerType!==n||this._deltaType!==t)&&(this._handlerType=n,this._deltaType=t,this._lastUsefulFrameIndex=-1)},i}(),yi._deltaType=Kt.Moving,yi._handlerType=ze.None,yi._frameIndex=0,yi._lastUsefulFrameIndex=-1,yi._distanceOfPointers=0,yi))||nh),ah,oh,Lp=(ah=Bo(),ah(oh=function(){function i(){}return i.onUpdateHandler=function(n){var t=n.wheelDelta;return t.x===0&&t.y===0&&t.z===0?ze.None:ze.ZOOM},i.onUpdateDelta=function(n,t){t.copyFrom(n.input.wheelDelta)},i}())||oh),zp=function(i){Fp(o,i);function o(){for(var t,e=arguments.length,r=new Array(e),a=0;a<e;a++)r[a]=arguments[a];return t=i.call.apply(i,[this].concat(r))||this,t.canvas=void 0,t.input=void 0,t.inputDevices=[Bp,Dp,Lp],t.camera=void 0,t.cameraTransform=void 0,t.target=new T,t.up=new T(0,1,0),t.autoRotate=!1,t.autoRotateSpeed=Math.PI,t.enableKeys=!1,t.enableDamping=!0,t.rotateSpeed=1,t.zoomSpeed=1,t.keyPanSpeed=7,t.dampingFactor=.1,t.zoomFactor=.2,t.minDistance=.1,t.maxDistance=1/0,t.minZoom=0,t.maxZoom=1/0,t.minPolarAngle=0,t.maxPolarAngle=Math.PI,t.minAzimuthAngle=-1/0,t.maxAzimuthAngle=1/0,t._spherical=new Ia,t._sphericalDelta=new Ia,t._sphericalDump=new Ia,t._zoomFrag=0,t._scale=1,t._panOffset=new T,t._tempVec3=new T,t._enableHandler=ze.All,t}var n=o.prototype;return n.onAwake=function(){var e=this.engine,r=this.entity;this.canvas=e.canvas,this.input=e.inputManager,this.camera=r.getComponent(Sa),this.cameraTransform=r.transform},n.onUpdate=function(e){this._updateInputDelta(e),this._updateTransform()},n._updateInputDelta=function(e){for(var r=ze.None,a=this._tempVec3,s=this._enableHandler,l=this.inputDevices,c=this.input,u=l.length-1;u>=0;u--){var h=l[u],d=h.onUpdateHandler(c);if(d&s)switch(r|=d,h.onUpdateDelta(this,a),d){case ze.ROTATE:this._rotate(a);break;case ze.ZOOM:this._zoom(a);break;case ze.PAN:this._pan(a);break}}var f=this._sphericalDump,_=this._sphericalDelta;if(this.autoRotate){var g=this.autoRotateSpeed/1e3*e;this._sphericalDelta.theta-=g}this.enableDamping&&(s&ze.ZOOM&&r^ze.ZOOM&&(this._zoomFrag*=1-this.zoomFactor),s&ze.ROTATE&&r^ze.ROTATE&&(_.theta=f.theta*=1-this.dampingFactor,_.phi=f.phi*=1-this.dampingFactor))},n._rotate=function(e){var r=2*Math.PI*e.x/this.canvas.width*this.rotateSpeed;this._sphericalDelta.theta-=r;var a=2*Math.PI*e.y/this.canvas.height*this.rotateSpeed;this._sphericalDelta.phi-=a,this.enableDamping&&(this._sphericalDump.theta=-r,this._sphericalDump.phi=-a)},n._zoom=function(e){e.y>0?this._scale/=Math.pow(.95,this.zoomSpeed):e.y<0&&(this._scale*=Math.pow(.95,this.zoomSpeed))},n._pan=function(e){var r=this.cameraTransform,a=r.worldMatrix.elements,s=this.canvas.height,l=T.distance(r.position,this.target)*(this.camera.fieldOfView/2)*(Math.PI/180),c=-2*e.x*(l/s),u=2*e.y*(l/s);this._panOffset.x+=a[0]*c+a[4]*u,this._panOffset.y+=a[1]*c+a[5]*u,this._panOffset.z+=a[2]*c+a[6]*u},n._updateTransform=function(){var e=this.cameraTransform,r=this.target,a=this._tempVec3,s=this._spherical,l=this._sphericalDelta,c=this._panOffset;T.subtract(e.position,r,a),s.setFromVec3(a),s.theta+=l.theta,s.phi+=l.phi,s.theta=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,s.theta)),s.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,s.phi)),s.makeSafe(),this._scale!==1&&(this._zoomFrag=s.radius*(this._scale-1)),s.radius+=this._zoomFrag,s.radius=Math.max(this.minDistance,Math.min(this.maxDistance,s.radius)),s.setToVec3(a),T.add(r.add(c),a,e.position),e.lookAt(r,this.up),this._zoomFrag=0,this._scale=1,l.set(0,0,0),c.set(0,0,0)},Rp(o,[{key:"enableRotate",get:function(){return(this._enableHandler&ze.ROTATE)!==0},set:function(e){e?this._enableHandler|=ze.ROTATE:this._enableHandler&=~ze.ROTATE}},{key:"enableZoom",get:function(){return(this._enableHandler&ze.ZOOM)!==0},set:function(e){e?this._enableHandler|=ze.ZOOM:this._enableHandler&=~ze.ZOOM}},{key:"enablePan",get:function(){return(this._enableHandler&ze.PAN)!==0},set:function(e){e?this._enableHandler|=ze.PAN:this._enableHandler&=~ze.PAN}}]),o}(Di);const sh={sunset:"https://gw.alipayobjects.com/os/bmw-prod/89c54544-1184-45a1-b0f5-c0b17e5c3e68.bin",pisa:"https://gw.alipayobjects.com/os/bmw-prod/6470ea5e-094b-4a77-a05f-4945bf81e318.bin",park:"https://gw.alipayobjects.com/os/bmw-prod/37f204c2-bc5b-4344-a368-8251bbeb0717.bin",foot_2K:"https://gw.alipayobjects.com/os/bmw-prod/23c1893a-fe29-4e91-bd6a-bb1c4201a876.bin"};class Lt extends Di{constructor(){super(...arguments),this.dropEl=document.querySelector("#dropzone"),this.inputEl=document.querySelector("#input"),this.gui=new Ep,this.materialFolder=null,this.animationFolder=null,this.sceneFolder=null,this.lightFolder=null,this.state={background:!0,env:"park"},this.skyMaterial=new Co(this.engine),this.materials=[],this.textures={},this.env={},this.cameraEntity=this.entity.createChild("camera"),this.gltfRootEntity=this.entity.createChild("gltf"),this.camera=this.cameraEntity.addComponent(Sa),this.controller=this.cameraEntity.addComponent(zp),this.boundingBox=new ir,this.center=new T,this.extent=new T}static guiToColor(o,n){n.set(o[0]/255,o[1]/255,o[2]/255,n.a)}static colorToGui(o=new oe(1,1,1)){const n=[];return n[0]=o.r*255,n[1]=o.g*255,n[2]=o.b*255,n}laterOnTextureLoader(){}gltfProcess(o){}onAwake(){this.gltfRootEntity=this.entity.createChild("gltf"),this.dropCtrl=new sp(this.dropEl,this.inputEl),this.dropCtrl.on("drop",({files:o})=>{this._loadFileMaps(o)}),this._loadEnv(this.state.env),this.initScene(),this._addSceneGUI(),window.onresize=()=>{this.engine.canvas.resizeByClientSize()}}_loadFileMaps(o){const n=/\.(gltf|glb)$/i,t=/\.(jpg|jpeg|png)$/i,e=/\.(hdr|hdri)$/i;let r,a="gltf";const s={},l=Array.from(o);if(l.some(c=>{const u=c[1];return n.test(u.name)?(a=RegExp.$1,r=u,!0):!1}),l.forEach(c=>{const u=c[1];if(!n.test(u.name)){const h=URL.createObjectURL(u),d=u.name;s[d]=h,t.test(d)?this._addTexture(d,h):e.test(d)}}),r){const c=URL.createObjectURL(r);this._loadModel(c,s,a)}}_addTexture(o,n){if(Object.keys(this.textures).find(e=>e===o)){console.warn(`${o} \u5DF2\u7ECF\u5B58\u5728\uFF0C\u8BF7\u66F4\u6362\u56FE\u7247\u540D\u5B57\u91CD\u65B0\u4E0A\u4F20`);return}this.engine.resourceManager.load({type:Xe.Texture2D,url:n}).then(e=>{this.textures[o]=e,this.laterOnTextureLoader(),this._addMaterialGUI(),console.log("\u56FE\u7247\u4E0A\u4F20\u6210\u529F\uFF01",o)})}_loadModel(o,n,t){this._destroyGLTF(),t.toLowerCase()==="gltf"?this.engine.resourceManager.load({type:Xe.JSON,url:o}).then(e=>{e.buffers.concat(e.images).forEach(s=>{if(!s)return;let{uri:l}=s;if(l){let c=l.lastIndexOf("/");c>-1&&(l=l.substr(c+1)),n[l]&&(s.uri=n[l])}});const r=new Blob([JSON.stringify(e)]),a=URL.createObjectURL(r);this.engine.resourceManager.load({type:Xe.Prefab,url:`${a}#.gltf`}).then(s=>{this._handleGltfResource(s)}).catch(()=>{console.log("Fail loader")})}):this.engine.resourceManager.load({type:Xe.Prefab,url:`${o}#.glb`}).then(e=>{this._handleGltfResource(e)}).catch(()=>{console.log("Fail loader")})}_handleGltfResource(o){const{defaultSceneRoot:n,materials:t,animations:e}=o;console.log(o),this.gltfRootEntity=n,this.entity.addChild(n),this.gltfProcess(o);const r=[];n.getComponentsIncludeChildren(Ir,r),this._setCenter(r),this._addMaterialGUI(t),this._addAnimationGUI(e)}_destroyGLTF(){this.gltfRootEntity.destroy()}_setCenter(o){const n=this.boundingBox,t=this.center,e=this.extent;n.min.set(0,0,0),n.max.set(0,0,0),o.forEach(a=>{ir.merge(a.bounds,n,n)}),n.getExtent(e);const r=e.length();n.getCenter(t),this.controller.target.set(t.x,t.y,t.z),this.controller.entity.transform.setPosition(t.x,t.y,r*3),this.controller.camera.farClipPlane=r*12,this.controller.camera.nearClipPlane=r/100,this.controller.maxDistance=r*10}_loadEnv(o){return new Promise(n=>{this.engine.resourceManager.load({type:Xe.Env,url:sh[o]}).then(t=>{this.env[o]=t,this.scene.ambientLight=t,this.skyMaterial.textureCubeMap=t.specularTexture,this.skyMaterial.textureDecodeRGBM=!0,n(!0)})})}_addMaterialGUI(o){const{gui:n}=this;this.materialFolder&&(n.removeFolder(this.materialFolder),this.materialFolder=null);const t=o||this.materials;if(this.materials=t,!t.length)return;const e=this.materialFolder=n.addFolder("Material"),r={};t.forEach(a=>{if(!(a instanceof Zt)&&!(a instanceof ai))return;a.name||(a.name="default");const s={opacity:a.baseColor.a,baseColor:Lt.colorToGui(a.baseColor),emissiveColor:Lt.colorToGui(a.emissiveColor),specularColor:Lt.colorToGui(a.specularColor),baseTexture:a.baseTexture?"origin":"",roughnessMetallicTexture:a.roughnessMetallicTexture?"origin":"",normalTexture:a.normalTexture?"origin":"",emissiveTexture:a.emissiveTexture?"origin":"",occlusionTexture:a.occlusionTexture?"origin":"",specularGlossinessTexture:a.specularGlossinessTexture?"origin":""},l={baseTexture:a.baseTexture,roughnessMetallicTexture:a.roughnessMetallicTexture,normalTexture:a.normalTexture,emissiveTexture:a.emissiveTexture,occlusionTexture:a.occlusionTexture,specularGlossinessTexture:a.specularGlossinessTexture},c=e.addFolder(r[a.name]?`${a.name}_${r[a.name]+1}`:a.name);if(r[a.name]=r[a.name]==null?1:r[a.name]+1,a instanceof Li){const u=c.addFolder("Metallic-Roughness props");u.add(a,"metallic",0,1).step(.01),u.add(a,"roughness",0,1).step(.01),u.add(s,"roughnessMetallicTexture",["None","origin",...Object.keys(this.textures)]).onChange(h=>{a.roughnessMetallicTexture=h==="None"?null:this.textures[h]||l.roughnessMetallicTexture}),u.open()}else if(a instanceof hi){const u=c.addFolder("Specular-Glossiness props");u.add(a,"glossiness",0,1).step(.01),u.addColor(s,"specularColor").onChange(h=>{Lt.guiToColor(h,a.specularColor)}),u.add(s,"specularGlossinessTexture",["None","origin",...Object.keys(this.textures)]).onChange(h=>{a.specularGlossinessTexture=h==="None"?null:this.textures[h]||l.specularGlossinessTexture}),u.open()}else a instanceof ai&&(c.add(s,"baseTexture",["None","origin",...Object.keys(this.textures)]).onChange(u=>{a.baseTexture=u==="None"?null:this.textures[u]||l.baseTexture}),c.addColor(s,"baseColor").onChange(u=>{Lt.guiToColor(u,a.baseColor)}));if(!(a instanceof ai)){const u=c.addFolder("Common props");u.add(s,"opacity",0,1).step(.01).onChange(h=>{a.baseColor.a=h}),u.add(a,"isTransparent"),u.add(a,"alphaCutoff",0,1).step(.01),u.addColor(s,"baseColor").onChange(h=>{Lt.guiToColor(h,a.baseColor)}),u.addColor(s,"emissiveColor").onChange(h=>{Lt.guiToColor(h,a.emissiveColor)}),u.add(s,"baseTexture",["None","origin",...Object.keys(this.textures)]).onChange(h=>{a.baseTexture=h==="None"?null:this.textures[h]||l.baseTexture}),u.add(s,"normalTexture",["None","origin",...Object.keys(this.textures)]).onChange(h=>{a.normalTexture=h==="None"?null:this.textures[h]||l.normalTexture}),u.add(s,"emissiveTexture",["None","origin",...Object.keys(this.textures)]).onChange(h=>{a.emissiveTexture=h==="None"?null:this.textures[h]||l.emissiveTexture}),u.add(s,"occlusionTexture",["None","origin",...Object.keys(this.textures)]).onChange(h=>{a.occlusionTexture=h==="None"?null:this.textures[h]||l.occlusionTexture}),u.open()}})}_addAnimationGUI(o){if(this.animationFolder&&(this.gui.removeFolder(this.animationFolder),this.animationFolder=null),o!=null&&o.length){this.animationFolder=this.gui.addFolder("Animation"),this.animationFolder.open();const n=this.gltfRootEntity.getComponent(So);n.play(o[0].name);const t={animation:o[0].name};this.animationFolder.add(t,"animation",["None",...o.map(e=>e.name)]).onChange(e=>{e==="None"?n.speed=0:(n.speed=1,n.play(e))})}}_addSceneGUI(){const{gui:o}=this;this.sceneFolder&&o.removeFolder(this.sceneFolder),this.sceneFolder&&o.removeFolder(this.lightFolder),this.sceneFolder=o.addFolder("Scene"),this.sceneFolder.add(this.state,"background").onChange(n=>{n?this.scene.background.mode=rr.Sky:this.scene.background.mode=rr.SolidColor}),this.lightFolder=o.addFolder("Lighting"),this.lightFolder.add(this.state,"env",[...Object.keys(sh)]).name("IBL").onChange(n=>{this._loadEnv(n)}),this.sceneGUI(this.lightFolder),this.sceneFolder.open(),this.lightFolder.open()}}var zr=(i=>(i[i.Wireframe=0]="Wireframe",i[i.Normal=1]="Normal",i[i.Tangent=2]="Tangent",i[i.BiTangent=3]="BiTangent",i))(zr||{});const pd=`
   uniform sampler2D u_verticesSampler;
   uniform float u_verticesTextureWidth;
   uniform float u_verticesTextureHeight;
   
   uniform sampler2D u_indicesSampler;
   uniform float u_indicesTextureWidth;
   uniform float u_indicesTextureHeight;
   
   vec4 getVertexElement(float row, float col) {
        return texture2D(u_verticesSampler, vec2((col + 0.5) / u_verticesTextureWidth, (row + 0.5) / u_verticesTextureHeight));
   }
   
   vec3 getIndicesElement(float row, float col) {
        return texture2D(u_indicesSampler, vec2((col + 0.5) / u_indicesTextureWidth, (row + 0.5) / u_indicesTextureHeight )).xyz;
   }
   
   vec2 getVec2(inout vec4[ELEMENT_COUNT] rows, inout int row_index, inout int value_index) {
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float x = rows[row_index][value_index];
        
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float y = rows[row_index][value_index];
        
        return vec2(x, y);
   }
   
   vec3 getVec3(inout vec4[ELEMENT_COUNT] rows, inout int row_index, inout int value_index) {
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float x = rows[row_index][value_index];
        
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float y = rows[row_index][value_index];
        
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float z = rows[row_index][value_index];
        return vec3(x, y, z);
   }
   
   vec4 getVec4(inout vec4[ELEMENT_COUNT] rows, inout int row_index, inout int value_index) {
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float x = rows[row_index][value_index];
        
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float y = rows[row_index][value_index];
        
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float z = rows[row_index][value_index];
        
        row_index += (value_index+1)/4;
        value_index = (value_index+1)%4;
        float w = rows[row_index][value_index];
        return vec4(x, y, z, w);
   }
`,gd=`
        int row = pointIndex * ELEMENT_COUNT / int(u_verticesTextureWidth);
        int col = pointIndex * ELEMENT_COUNT % int(u_verticesTextureWidth);
        
        vec4 rows[ELEMENT_COUNT];
        for( int i = 0; i < ELEMENT_COUNT; i++ ) {
            rows[i] = getVertexElement(float(row), float(col + i));
        }
        
        vec3 POSITION = vec3(rows[0].x, rows[0].y, rows[0].z);        
        int row_index = 0;
        int value_index = 2;
#ifdef O3_HAS_NORMAL 
        vec3 NORMAL = getVec3(rows, row_index, value_index);
#endif

#ifdef O3_HAS_VERTEXCOLOR
        vec4 COLOR_0 = getVec4(rows, row_index, value_index);
#endif

#ifdef O3_HAS_WEIGHT
        vec4 WEIGHTS_0 = getVec4(rows, row_index, value_index);
#endif

#ifdef O3_HAS_JOINT
        vec4 JOINTS_0 = getVec4(rows, row_index, value_index);
#endif

#ifdef O3_HAS_TANGENT
        vec4 TANGENT = getVec4(rows, row_index, value_index);
#endif

#ifdef O3_HAS_UV
        vec2 TEXCOORD_0 = getVec2(rows, row_index, value_index);
#endif
`;F.create("tbnShader",`
   uniform float u_lineScale;
   uniform mat4 u_VPMat;
   uniform mat4 u_worldMatrix;
   uniform mat4 u_worldNormal;

#ifdef O3_HAS_SKIN
#ifdef O3_USE_JOINT_TEXTURE
    uniform sampler2D u_jointSampler;
    uniform float u_jointCount;

    mat4 getJointMatrix(sampler2D smp, float index) {
        float base = index / u_jointCount;
        float hf = 0.5 / u_jointCount;
        float v = base + hf;

        vec4 m0 = texture2D(smp, vec2(0.125, v ));
        vec4 m1 = texture2D(smp, vec2(0.375, v ));
        vec4 m2 = texture2D(smp, vec2(0.625, v ));
        vec4 m3 = texture2D(smp, vec2(0.875, v ));

        return mat4(m0, m1, m2, m3);
    }
#else
    uniform mat4 u_jointMatrix[ O3_JOINTS_NUM ];
#endif
#endif

${pd}

void main() {
    int pointIndex = gl_VertexID / 2;
    ${gd}

    #include <begin_position_vert>
    #include <begin_normal_vert>
    #include <skinning_vert>

    gl_Position = position;
    #ifndef O3_HAS_SKIN
        gl_Position = u_worldMatrix * gl_Position; 
    #endif
    
#if defined(SHOW_NORMAL) && defined(O3_HAS_NORMAL)
    if (gl_VertexID % 2 == 1) {
        vec3 normalW = normalize( mat3(u_worldNormal) * normal.xyz );
        gl_Position.xyz += normalize(normalW) * u_lineScale;
    }
#endif

#if defined(SHOW_TANGENT) && defined(O3_HAS_TANGENT)
    if (gl_VertexID % 2 == 1) {
        vec3 tangentW = normalize( mat3(u_worldNormal) * tangent.xyz );
        gl_Position.xyz += normalize(tangentW) * u_lineScale;
    }
#endif

#if defined(SHOW_BITANGENT) && defined(O3_HAS_TANGENT) && defined(O3_HAS_NORMAL)
    if (gl_VertexID % 2 == 1) {
        vec3 normalW = normalize( mat3(u_worldNormal) * normal.xyz );
        vec3 tangentW = normalize( mat3(u_worldNormal) * tangent.xyz );
        vec3 bitangentW = cross( normalW, tangentW ) * tangent.w;
        gl_Position.xyz += normalize(bitangentW) * u_lineScale;
    }
#endif
    
    gl_Position = u_VPMat * gl_Position; 
}
`,`
uniform vec4 u_baseColor;
void main() {
    gl_FragColor = u_baseColor;
}
`);class xn extends ut{get baseColor(){return this.shaderData.getColor(xn._baseColorProp)}set baseColor(o){const n=this.shaderData.getColor(xn._baseColorProp);o!==n&&n.copyFrom(o)}constructor(o){super(o,F.find("tbnShader")),this.shaderData.setColor(xn._baseColorProp,new oe(1,0,0,1)),this.shaderData.enableMacro("SHOW_NORMAL")}}class bn extends ut{get baseColor(){return this.shaderData.getColor(bn._baseColorProp)}set baseColor(o){const n=this.shaderData.getColor(bn._baseColorProp);o!==n&&n.copyFrom(o)}constructor(o){super(o,F.find("tbnShader")),this.shaderData.setColor(bn._baseColorProp,new oe(0,1,0,1)),this.shaderData.enableMacro("SHOW_TANGENT")}}class wn extends ut{get baseColor(){return this.shaderData.getColor(wn._baseColorProp)}set baseColor(o){const n=this.shaderData.getColor(wn._baseColorProp);o!==n&&n.copyFrom(o)}constructor(o){super(o,F.find("tbnShader")),this.shaderData.setColor(wn._baseColorProp,new oe(0,0,1,1)),this.shaderData.enableMacro("SHOW_BITANGENT")}}F.create("wireframeShader",`
   uniform float u_lineScale;
   uniform mat4 u_VPMat;
   uniform mat4 u_worldMatrix;
   uniform mat4 u_worldNormal;

#ifdef O3_HAS_SKIN
#ifdef O3_USE_JOINT_TEXTURE
    uniform sampler2D u_jointSampler;
    uniform float u_jointCount;

    mat4 getJointMatrix(sampler2D smp, float index) {
        float base = index / u_jointCount;
        float hf = 0.5 / u_jointCount;
        float v = base + hf;

        vec4 m0 = texture2D(smp, vec2(0.125, v ));
        vec4 m1 = texture2D(smp, vec2(0.375, v ));
        vec4 m2 = texture2D(smp, vec2(0.625, v ));
        vec4 m3 = texture2D(smp, vec2(0.875, v ));

        return mat4(m0, m1, m2, m3);
    }
#else
    uniform mat4 u_jointMatrix[ O3_JOINTS_NUM ];
#endif
#endif

${pd}

varying vec3 v_baryCenter;

void main() {
    int indicesIndex = gl_VertexID / 3;
    int indicesRow = indicesIndex / int(u_indicesTextureWidth);
    int indicesCol = indicesIndex % int(u_indicesTextureWidth);
    vec3 triangleIndices = getIndicesElement(float(indicesRow), float(indicesCol));
    int subIndex = gl_VertexID % 3;
    v_baryCenter = vec3(0.0);
    v_baryCenter[subIndex] = 1.0;
    
    int pointIndex = int(triangleIndices[subIndex]);
    ${gd}

    #include <begin_position_vert>
    #include <begin_normal_vert>
    #include <skinning_vert>
    
    gl_Position = position;
    #ifndef O3_HAS_SKIN
        gl_Position = u_worldMatrix * gl_Position; 
    #endif
    gl_Position = u_VPMat * gl_Position; 
}
`,`
varying vec3 v_baryCenter;

float edgeFactor(){
    vec3 d = fwidth(v_baryCenter);
    vec3 a3 = smoothstep(vec3(0.0), d * 1.5, v_baryCenter);
    return min(min(a3.x, a3.y), a3.z);
}

uniform vec4 u_baseColor;
void main() {
    if (gl_FrontFacing) {
        gl_FragColor = vec4(u_baseColor.xyz, 1.0 - edgeFactor());
    } else {
        // fade back face
        gl_FragColor = vec4(u_baseColor.xyz, (1.0 - edgeFactor()) * 0.3);
    }
}
`);class Sn extends ut{get baseColor(){return this.shaderData.getColor(Sn._baseColorProp)}set baseColor(o){const n=this.shaderData.getColor(Sn._baseColorProp);o!==n&&n.copyFrom(o)}constructor(o){super(o,F.find("wireframeShader")),this.shaderData.setColor(Sn._baseColorProp,new oe(0,0,0,1)),this.isTransparent=!0,this.renderFace=Mr.Double}}const ge=class extends si{constructor(i){super(i),this._worldNormalMatrix=new ce,this._worldTransform=null,this._targetMesh=null,this._verticesTexture=null,this._indicesTexture=null,this._showState=[!1,!1,!1,!1],this._triangleSubMesh=new Fn,this._lineSubMesh=new Fn(0,0,oi.Lines);const o=this.engine;this.mesh=new Wt(o);const{bounds:n}=this.mesh;n.min.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.max.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._wireframeMaterial=new Sn(o),this._normalMaterial=new xn(o),this._tangentMaterial=new bn(o),this._biTangentMaterial=new wn(o),this.mesh.addSubMesh(this._triangleSubMesh),this.mesh.addSubMesh(this._lineSubMesh),this.mesh.addSubMesh(this._lineSubMesh),this.mesh.addSubMesh(this._lineSubMesh),this.scale=.1}get scale(){return this.shaderData.getFloat(ge._lineScaleProp)}set scale(i){this.shaderData.setFloat(ge._lineScaleProp,i)}set worldTransform(i){i!==this._worldTransform&&(this._worldTransform=i,this.shaderData.setMatrix(ge._worldMatrixProp,i.worldMatrix))}set targetMesh(i){if(i==null){this._targetMesh=null,this._triangleSubMesh.count=0,this._lineSubMesh.count=0;return}if(i!==this._targetMesh){this._destroy(),this._targetMesh=i,this._uploadVerticesBuffer(i),this._uploadIndicesBuffer(i),this._updateTriangleSubMesh(i),this._updateLineSubMesh(i);for(let o=0;o<4;o++)this.setSketchMode(o,this._showState[o])}}get wireframeMaterial(){return this._wireframeMaterial}get normalMaterial(){return this._normalMaterial}get tangentMaterial(){return this._normalMaterial}get biTangentMaterial(){return this._normalMaterial}setSketchMode(i,o){switch(i){case zr.Wireframe:o?(this._targetMesh&&this.setMaterial(0,this._wireframeMaterial),this._showState[0]=!0):(this.setMaterial(0,null),this._showState[0]=!1);break;case zr.Normal:o?(this._targetMesh&&this.setMaterial(1,this._normalMaterial),this._showState[1]=!0):(this.setMaterial(1,null),this._showState[1]=!1);break;case zr.Tangent:o?(this._targetMesh&&this.setMaterial(2,this._tangentMaterial),this._showState[2]=!0):(this.setMaterial(2,null),this._showState[2]=!1);break;case zr.BiTangent:o?(this._targetMesh&&this.setMaterial(3,this._biTangentMaterial),this._showState[3]=!0):(this.setMaterial(3,null),this._showState[3]=!1);break}}clear(){this.setMaterial(0,null),this.setMaterial(1,null),this.setMaterial(2,null),this.setMaterial(3,null)}update(i){super.update(i);const o=this._worldTransform;if(o){const n=this._worldNormalMatrix;ce.invert(o.worldMatrix,n),n.transpose(),this.shaderData.setMatrix(ge._worldNormalProp,n)}}_uploadIndicesBuffer(i){const o=i._indexBufferBinding.buffer,n=o.byteLength,t=new Uint8Array(n);o.getData(t);const e=i._indicesFormat;let r=0;switch(e){case nt.UInt8:{r=n/3;const a=Math.min(r,ge._MAX_TEXTURE_ROWS),s=Math.ceil(r/ge._MAX_TEXTURE_ROWS);this._indicesTexture=new Ct(this.engine,a,s,ee.R32G32B32A32,!1);const l=new Float32Array(a*s*4);for(let c=0;c<r;c++){for(let u=0;u<3;u++)l[c*4+u]=t[c*3+u];l[c*4+3]=0}this._indicesTexture.setPixelBuffer(l),this.shaderData.setTexture(ge._indicesSamplerProp,this._indicesTexture),this.shaderData.setFloat(ge._indicesTextureWidthProp,a),this.shaderData.setFloat(ge._indicesTextureHeightProp,s);break}case nt.UInt16:{const a=new Uint16Array(t.buffer);r=n/6;const s=Math.min(r,ge._MAX_TEXTURE_ROWS),l=Math.ceil(r/ge._MAX_TEXTURE_ROWS);this._indicesTexture=new Ct(this.engine,s,l,ee.R32G32B32A32,!1);const c=new Float32Array(s*l*4);for(let u=0;u<r;u++){for(let h=0;h<3;h++)c[u*4+h]=a[u*3+h];c[u*4+3]=0}this._indicesTexture.setPixelBuffer(c),this.shaderData.setTexture(ge._indicesSamplerProp,this._indicesTexture),this.shaderData.setFloat(ge._indicesTextureWidthProp,s),this.shaderData.setFloat(ge._indicesTextureHeightProp,l);break}case nt.UInt32:{const a=new Uint32Array(t.buffer);r=n/12;const s=Math.min(r,ge._MAX_TEXTURE_ROWS),l=Math.ceil(r/ge._MAX_TEXTURE_ROWS);this._indicesTexture=new Ct(this.engine,s,l,ee.R32G32B32A32,!1);const c=new Float32Array(s*l*4);for(let u=0;u<r;u++){for(let h=0;h<3;h++)c[u*4+h]=a[u*3+h];c[u*4+3]=0}this._indicesTexture.setPixelBuffer(c),this.shaderData.setTexture(ge._indicesSamplerProp,this._indicesTexture),this.shaderData.setFloat(ge._indicesTextureWidthProp,s),this.shaderData.setFloat(ge._indicesTextureHeightProp,l);break}}this._indicesTexture.filterMode=Ut.Point}_uploadVerticesBuffer(i){const o=i._vertexBufferBindings[0],n=i.vertexCount,t=this._updateMeshElement(i),e=ge._jointIndexBegin;let r=t;e!==-1&&(r+=3);const a=new Float32Array(t*n);o.buffer.getData(a);const s=new Uint8Array(a.buffer),l=Math.ceil(r/4)*4;this.shaderData.enableMacro("ELEMENT_COUNT",(l/4).toString());const c=Math.min(n,ge._MAX_TEXTURE_ROWS)*l,u=Math.ceil(n/ge._MAX_TEXTURE_ROWS),h=new Float32Array(c*u);for(let d=0;d<n;d++)for(let f=0;f<r;f++)e!==-1&&f===e?h[d*l+f]=s[d*t*4+e*4]:e!==-1&&f===e+1?h[d*l+f]=s[d*t*4+e*4+1]:e!==-1&&f===e+2?h[d*l+f]=s[d*t*4+e*4+2]:e!==-1&&f===e+3?h[d*l+f]=s[d*t*4+e*4+3]:e!==-1&&f>e+3?h[d*l+f]=a[d*t+f-3]:h[d*l+f]=a[d*t+f];this._createVerticesTexture(h,c/4,u),ge._jointIndexBegin=-1}_createVerticesTexture(i,o,n){this._verticesTexture=new Ct(this.engine,o,n,ee.R32G32B32A32,!1),this._verticesTexture.filterMode=Ut.Point,this._verticesTexture.setPixelBuffer(i),this.shaderData.setTexture(ge._verticesSamplerProp,this._verticesTexture),this.shaderData.setFloat(ge._verticesTextureWidthProp,o),this.shaderData.setFloat(ge._verticesTextureHeightProp,n)}_updateMeshElement(i){const o=this.shaderData;o.disableMacro(ge._normalMacro),o.disableMacro(ge._vertexColorMacro),o.disableMacro(ge._tangentMacro),o.disableMacro(ge._uvMacro),o.disableMacro(ge._uv1Macro),o.disableMacro(ge._weightMacro),o.disableMacro(ge._jointMacro);let n=0;const t=i._vertexElements;for(let e=0,r=t.length;e<r;e++){const{semantic:a}=t[e];switch(a){case"POSITION":n+=3;break;case"NORMAL":n+=3,o.enableMacro(ge._normalMacro);break;case"COLOR_0":n+=4,o.enableMacro(ge._vertexColorMacro);break;case"WEIGHTS_0":n+=4,o.enableMacro(ge._weightMacro);break;case"JOINTS_0":ge._jointIndexBegin=n,n+=1,o.enableMacro(ge._jointMacro);break;case"TANGENT":o.enableMacro(ge._tangentMacro),n+=4;break;case"TEXCOORD_0":o.enableMacro(ge._uvMacro),n+=2;break;case"TEXCOORD_1":o.enableMacro(ge._uv1Macro),n+=2;break;case"TEXCOORD_2":n+=2;break;case"TEXCOORD_3":n+=2;break;case"TEXCOORD_4":n+=2;break;case"TEXCOORD_5":n+=2;break;case"TEXCOORD_6":n+=2;break;case"TEXCOORD_7":n+=2;break}}return n}_updateLineSubMesh(i){this._lineSubMesh.count=i.vertexCount*2}_updateTriangleSubMesh(i){let o=0;const n=i.subMeshes;for(let t=0;t<n.length;t++)o+=n[t].count;this._triangleSubMesh.count=o}_destroy(){this._indicesTexture&&this._indicesTexture.destroy(),this._verticesTexture&&this._verticesTexture.destroy()}};let Vt=ge;Vt._weightMacro=F.getMacroByName("O3_HAS_WEIGHT");Vt._jointMacro=F.getMacroByName("O3_HAS_JOINT");Vt._MAX_TEXTURE_ROWS=512;Vt._jointIndexBegin=-1;Vt._verticesSamplerProp=F.getPropertyByName("u_verticesSampler");Vt._verticesTextureHeightProp=F.getPropertyByName("u_verticesTextureHeight");Vt._verticesTextureWidthProp=F.getPropertyByName("u_verticesTextureWidth");Vt._indicesSamplerProp=F.getPropertyByName("u_indicesSampler");Vt._indicesTextureHeightProp=F.getPropertyByName("u_indicesTextureHeight");Vt._indicesTextureWidthProp=F.getPropertyByName("u_indicesTextureWidth");Vt._lineScaleProp=F.getPropertyByName("u_lineScale");Vt._worldMatrixProp=F.getPropertyByName("u_worldMatrix");Vt._worldNormalProp=F.getPropertyByName("u_worldNormal");function lh(i,o){for(var n=0;n<o.length;n++){var t=o[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(i,t.key,t)}}function Op(i,o,n){return o&&lh(i.prototype,o),n&&lh(i,n),Object.defineProperty(i,"prototype",{writable:!1}),i}function Do(i,o){i.prototype=Object.create(o.prototype),i.prototype.constructor=i,vo(i,o)}function vo(i,o){return vo=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},vo(i,o)}var Ip=`#define GLSLIFY 1
#include <common>
#include <common_frag>
uniform vec3 u_colorId;void main(){gl_FragColor=vec4(u_colorId,1.0);}`,Np=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <position_vert>
}`;F.create("framebuffer-picker-color",Np,Ip);var Up=function(i){Do(o,i);function o(t){var e;return e=i.call(this,t,F.find("framebuffer-picker-color"))||this,e._currentId=0,e._primitivesMap=[],e}var n=o.prototype;return n.reset=function(){this._currentId=0,this._primitivesMap=[]},n.id2Color=function(e){if(e>=16777215)return me.warn("Framebuffer Picker encounter primitive's id greater than "+16777215),new T(0,0,0);var r=new T((e&255)/255,((e&65280)>>8)/255,((e&16711680)>>16)/255);return r},n.color2Id=function(e){return e[0]|e[1]<<8|e[2]<<16},n.getObjectByColor=function(e){return this._primitivesMap[this.color2Id(e)]},n._preRender=function(e){this._currentId+=1,this._primitivesMap[this._currentId]=e,e.component.shaderData.setVector3("u_colorId",this.id2Color(this._currentId))},o}(pr),kp=function(i){Do(o,i);function o(t,e,r,a,s){var l;return l=i.call(this,t,e,r,new Up(s),a)||this,l._needPick=void 0,l._pickPos=void 0,l._pickResolve=void 0,l._needPick=!1,l}var n=o.prototype;return n.preRender=function(){this._needPick?(this.enabled=!0,this.replaceMaterial.reset()):this.enabled=!1},n.postRender=function(e){if(this._needPick){var r=this.readColorFromRenderTarget(e),a=this.replaceMaterial.getObjectByColor(r);this._needPick=!1,this._pickResolve&&this._pickResolve(a)}},n.pick=function(e,r){this._pickPos=[e,r],this._needPick=!0},n.readColorFromRenderTarget=function(e){var r=e.engine._hardwareRenderer.gl,a=this._pickPos,s=r.drawingBufferWidth,l=r.drawingBufferHeight,c=a[0],u=a[1],h=e.viewport,d=(h.z-h.x)*s,f=(h.w-h.y)*l,_=(c-h.x)/d,g=(u-h.y)/f,v=Math.floor(_*(this.renderTarget.width-1)),p=Math.floor((1-g)*(this.renderTarget.height-1)),m=new Uint8Array(4);return this.renderTarget.getColorTexture().getPixelBuffer(v,p,1,1,0,m),m},o}(ei),Vp=function(i){Do(o,i);function o(t){var e;e=i.call(this,t)||this,e.colorRenderTarget=void 0,e.colorRenderPass=void 0,e._camera=void 0,e._needPick=void 0,e._pickPos=void 0;var r=1024,a=1024;return e.colorRenderTarget=new Bn(e.engine,r,a,new Ct(e.engine,r,a)),e.colorRenderPass=new kp("ColorRenderTarget_FBP",-1,e.colorRenderTarget,0,e.engine),e}var n=o.prototype;return n.pick=function(e,r){var a=this;if(this.enabled)return this._needPick=!0,this._pickPos=[e,r],new Promise(function(s){a.colorRenderPass._pickResolve=s})},n.onUpdate=function(e){i.prototype.onUpdate.call(this,e),this.enabled&&this._needPick&&(this.colorRenderPass.pick(this._pickPos[0],this._pickPos[1]),this._needPick=!1)},n.onDestroy=function(){this.camera.destroyed||this.camera._renderPipeline.removeRenderPass(this.colorRenderPass)},Op(o,[{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this.camera._renderPipeline.addRenderPass(this.colorRenderPass))}}]),o}(Di);class Gp{set material(o){this._material=o,this._alpha=o.baseColor.r,this._isTransparent=o.isTransparent}setSelectedState(){const o=this._material;o&&(o.baseColor.a=.6),o&&(o.isTransparent=!0)}setOriginState(){const o=this._material;o&&(o.baseColor.a=this._alpha),o&&(o.isTransparent=this._isTransparent)}}class Hp extends Di{constructor(){super(...arguments),this._specificEntity=null,this._selection=new Gp}get specificEntity(){return this._specificEntity}set specificEntity(o){this._specificEntity=o,this.sketch.targetMesh=null}set camera(o){this._framebufferPicker.camera=o}onAwake(){this._framebufferPicker=this.entity.addComponent(Vp),this.sketch=this.entity.addComponent(Vt),this.sketch.scale=.02}onUpdate(){const{_selection:o,sketch:n}=this,t=this.engine.inputManager;if(t.isPointerDown(ri.Primary)){const e=t.pointerPosition;this._framebufferPicker.pick(e.x,e.y).then(r=>{if(r){if(this.specificEntity!==null&&r.component.entity!==this.specificEntity)return;if(r.mesh instanceof Wt)if(o.mesh!==r.mesh){o.setOriginState(),o.mesh=r.mesh,o.material=r.material,o.setSelectedState();const a=r.component;n.targetMesh=r.mesh,n.worldTransform=a.entity.transform,n.skin=null,n.shaderData.disableMacro("O3_HAS_SKIN"),a instanceof si&&(n._hasInitJoints=!1,n.skin=a.skin)}else o.setSelectedState()}else o.setOriginState()})}}}const Se=class extends Zt{get specularShiftTexture(){return this.shaderData.getTexture(Se._specularShiftTextureProp)}set specularShiftTexture(i){const o=this.shaderData;o.setTexture(Se._specularShiftTextureProp,i),i!=null?o.enableMacro(Se._specularShiftTextureMacro):o.disableMacro(Se._specularShiftTextureMacro)}get specularShift(){return this.shaderData.getFloat(Se._specularShiftProp)}set specularShift(i){this.shaderData.setFloat(Se._specularShiftProp,i)}get primaryColor(){return this.shaderData.getColor(Se._primaryColorProp)}set primaryColor(i){const o=this.shaderData.getColor(Se._primaryColorProp);o!==i&&o.copyFrom(i)}get primaryShift(){return this.shaderData.getFloat(Se._primaryShiftProp)}set primaryShift(i){this.shaderData.setFloat(Se._primaryShiftProp,i)}get secondaryColor(){return this.shaderData.getColor(Se._secondaryColorProp)}set secondaryColor(i){const o=this.shaderData.getColor(Se._secondaryColorProp);o!==i&&o.copyFrom(i)}get secondaryShift(){return this.shaderData.getFloat(Se._secondaryShiftProp)}set secondaryShift(i){this.shaderData.setFloat(Se._secondaryShiftProp,i)}get specularPower(){return this.shaderData.getFloat(Se._specPowerProp)}set specularPower(i){this.shaderData.setFloat(Se._specPowerProp,i)}get specularWidth(){return this.shaderData.getFloat(Se._specularWidthProp)}set specularWidth(i){this.shaderData.setFloat(Se._specularWidthProp,i)}get specularScale(){return this.shaderData.getFloat(Se._specularScaleProp)}set specularScale(i){this.shaderData.setFloat(Se._specularScaleProp,i)}get metallic(){return this.shaderData.getFloat(Se._metallicProp)}set metallic(i){this.shaderData.setFloat(Se._metallicProp,i)}get roughness(){return this.shaderData.getFloat(Se._roughnessProp)}set roughness(i){this.shaderData.setFloat(Se._roughnessProp,i)}get roughnessMetallicTexture(){return this.shaderData.getTexture(Se._roughnessMetallicTextureProp)}set roughnessMetallicTexture(i){this.shaderData.setTexture(Se._roughnessMetallicTextureProp,i),i?this.shaderData.enableMacro("ROUGHNESSMETALLICTEXTURE"):this.shaderData.disableMacro("ROUGHNESSMETALLICTEXTURE")}constructor(i){super(i,F.find("hair"));const o=this.shaderData;o.setColor(Se._primaryColorProp,new oe(1,1,1,1)),o.setColor(Se._secondaryColorProp,new oe(1,1,1,1)),o.setFloat(Se._specPowerProp,64),o.setFloat(Se._specularScaleProp,1),o.setFloat(Se._specularWidthProp,1),o.setFloat(Se._specularShiftProp,0),o.setFloat(Se._primaryShiftProp,0),o.setFloat(Se._secondaryShiftProp,0),o.setFloat(Se._metallicProp,1),o.setFloat(Se._roughnessProp,1)}};let Gt=Se;Gt._metallicProp=F.getPropertyByName("u_metal");Gt._roughnessProp=F.getPropertyByName("u_roughness");Gt._roughnessMetallicTextureProp=F.getPropertyByName("u_roughnessMetallicTexture");Gt._specularShiftTextureMacro=F.getMacroByName("USE_SPECULAR_SHIFT_TEXTURE");Gt._specularShiftTextureProp=F.getPropertyByName("u_specularShift");Gt._specularShiftProp=F.getPropertyByName("u_specularShift_ST");Gt._primaryColorProp=F.getPropertyByName("u_primaryColor");Gt._primaryShiftProp=F.getPropertyByName("u_primaryShift");Gt._secondaryColorProp=F.getPropertyByName("u_secondaryColor");Gt._secondaryShiftProp=F.getPropertyByName("u_secondaryShift");Gt._specPowerProp=F.getPropertyByName("u_specPower");Gt._specularWidthProp=F.getPropertyByName("u_specularWidth");Gt._specularScaleProp=F.getPropertyByName("u_specularScale");F.create("hair",`
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <color_share>
#include <normal_share>
#include <worldpos_share>
#include <shadow_share>

#include <fog_share>

void main() {

    #include <begin_position_vert>
    #include <begin_normal_vert>
    #include <blendShape_vert>
    #include <skinning_vert>
    #include <uv_vert>
    #include <color_vert>
    #include <normal_vert>
    #include <worldpos_vert>
    #include <shadow_vert>
    #include <position_vert>

    #include <fog_vert>

}`,`
#define IS_METALLIC_WORKFLOW
#include <common>
#include <common_frag>

#include <fog_share>

#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>

#include <light_frag_define>

#include <pbr_frag_define>
#include <pbr_helper>

#ifdef USE_SPECULAR_SHIFT_TEXTURE
    uniform sampler2D u_specularShift;
#else
    uniform float u_specularShift_ST;
#endif

uniform vec4 u_primaryColor;
uniform float u_primaryShift;

uniform vec4 u_secondaryColor;
uniform float u_secondaryShift;
    
uniform float u_specPower;
uniform float u_specularWidth;
uniform float u_specularScale;
    
vec3 shiftTangent(vec3 T, vec3 N, float shift) {
	return normalize(T + shift * N);
}

float hairStrandSpecular(vec3 N, vec3 T, vec3 V, vec3 L, float specPower) {
	vec3 H = normalize(V + L);

	float HdotT = dot(T, H);
	float scale = smoothstep(0.0, 1.0, dot(N, L)); // prevent back light
	float sinTH = sqrt(1.0 - HdotT * HdotT);
	float dirAtten = smoothstep(-u_specularWidth, 0.0, HdotT);
	
	return scale * dirAtten * clamp(pow(sinTH, specPower), 0.0, 1.0);
}

vec4 getSpecular(vec4 primaryColor, float primaryShift,
				   vec4 secondaryColor, float secondaryShift,
				   vec3 N, vec3 T, vec3 V, vec3 L, float specPower) {
#ifdef USE_SPECULAR_SHIFT_TEXTURE
	float shiftTex = texture2D(u_specularShift, v_uv).r;
#else
    float shiftTex = u_specularShift_ST;
#endif		
    shiftTex -= 0.5;	   

	vec3 t1 = shiftTangent(T, N, primaryShift + shiftTex);
	vec3 t2 = shiftTangent(T, N, secondaryShift + shiftTex);

	vec4 specular = vec4(0.0, 0.0, 0.0, 0.0);
	specular += primaryColor * hairStrandSpecular(N, t1, V, L, specPower);
	specular += secondaryColor * hairStrandSpecular(N, t2, V, L, specPower);

	return specular;
}

float getDiffuse(vec3 N, vec3 L) {
    return clamp(mix(0.25, 1.0, dot(N, L)), 0.0, 1.0);
}

void addTotalHairRadiance(vec3 hairColor, vec3 viewDir, vec3 N, inout ReflectedLight reflectedLight) {
	mat3 tbn = getTBN();
    vec3 T = normalize(tbn[0]);
	vec3 B = normalize(tbn[1]);
	
	for( int i = 0; i < O3_DIRECT_LIGHT_COUNT; i++ ) {
        vec3 lightDir = normalize(-u_directLightDirection[i]);
        vec3 lightColor = u_directLightColor[i];
        
        float diffuse = getDiffuse(N, lightDir);
        vec4 specular = getSpecular(u_primaryColor, u_primaryShift, 
                                    u_secondaryColor, u_secondaryShift, N, B, viewDir, lightDir, u_specPower);
                                    
        reflectedLight.directSpecular += specular.xyz * u_specularScale * lightColor;
        reflectedLight.directDiffuse += diffuse * hairColor * lightColor;
    }
}

void main() {
    Geometry geometry;
    Material material;
    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
    
    initGeometry(geometry);
    initMaterial(material, geometry);
    
    // Direct Light
    addTotalHairRadiance(material.diffuseColor, geometry.viewDir, geometry.normal, reflectedLight);
    
    // IBL diffuse
    #ifdef O3_USE_SH
        vec3 irradiance = getLightProbeIrradiance(u_env_sh, geometry.normal);
        #ifdef OASIS_COLORSPACE_GAMMA
            irradiance = linearToGamma(vec4(irradiance, 1.0)).rgb;
        #endif
        irradiance *= u_envMapLight.diffuseIntensity;
    #else
       vec3 irradiance = u_envMapLight.diffuse * u_envMapLight.diffuseIntensity;
       irradiance *= PI;
    #endif
    
    reflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );
    
    // IBL specular
    vec3 radiance = getLightProbeRadiance(geometry.viewDir, geometry.normal, material.roughness, int(u_envMapLight.mipMapLevel), u_envMapLight.specularIntensity);
    float radianceAttenuation = 1.0;
    
    #ifdef CLEARCOAT
        vec3 clearCoatRadiance = getLightProbeRadiance( geometry.viewDir, geometry.clearCoatNormal, material.clearCoatRoughness, int(u_envMapLight.mipMapLevel), u_envMapLight.specularIntensity );
    
        reflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * envBRDFApprox(vec3( 0.04 ), material.clearCoatRoughness, geometry.clearCoatDotNV);
        radianceAttenuation -= material.clearCoat * F_Schlick(geometry.clearCoatDotNV);
    #endif
    
    reflectedLight.indirectSpecular += radianceAttenuation * radiance * envBRDFApprox(material.specularColor, material.roughness, geometry.dotNV );
    
    
    // Occlusion
    #ifdef OCCLUSIONTEXTURE
        vec2 aoUV = v_uv;
        #ifdef O3_HAS_UV1
            if(u_occlusionTextureCoord == 1.0){
                aoUV = v_uv1;
            }
        #endif
        float ambientOcclusion = (texture2D(u_occlusionTexture, aoUV).r - 1.0) * u_occlusionIntensity + 1.0;
        reflectedLight.indirectDiffuse *= ambientOcclusion;
        #ifdef O3_USE_SPECULAR_ENV
            reflectedLight.indirectSpecular *= computeSpecularOcclusion(ambientOcclusion, material.roughness, geometry.dotNV);
        #endif
    #endif
    
    
    // Emissive
    vec3 emissiveRadiance = u_emissiveColor;
    #ifdef EMISSIVETEXTURE
        vec4 emissiveColor = texture2D(u_emissiveTexture, v_uv);
        #ifndef OASIS_COLORSPACE_GAMMA
            emissiveColor = gammaToLinear(emissiveColor);
        #endif
        emissiveRadiance *= emissiveColor.rgb;
    #endif
    
    // Total
    vec3 totalRadiance =    reflectedLight.directDiffuse + 
                            reflectedLight.indirectDiffuse + 
                            reflectedLight.directSpecular + 
                            reflectedLight.indirectSpecular + 
                            emissiveRadiance;
    
    vec4 targetColor =vec4(totalRadiance, material.opacity);
    #ifndef OASIS_COLORSPACE_GAMMA
        targetColor = linearToGamma(targetColor);
    #endif
    gl_FragColor = targetColor;
}`);class Wp extends Di{constructor(){super(...arguments),this.pause=!0,this._time=0}onUpdate(o){this.pause||(this._time+=o/20,this._time>360&&(this._time-=360),this.entity.transform.rotation.y=this._time)}}class Yi extends Lt{constructor(){super(...arguments),this.lightState={lights:!0,mainLightColor:Yi.colorToGui(new oe(1,1,1)),purpleLightColor:Yi.colorToGui(new oe(1,1,1)),mainLightIntensity:.55,purpleLightIntensity:.15},this.mainLightEntity=this.entity.createChild("mainLight"),this.mainLight=this.mainLightEntity.addComponent(mr),this.purpleLightEntity=this.entity.createChild("purpleLight"),this.purpleLight=this.purpleLightEntity.addComponent(mr),this.sketchSelection=null,this.sketchState={wireframeMode:!1,wireframeBaseColor:[0,0,0],normalMode:!1,normalColor:[255,0,0],tangentMode:!1,tangentColor:[0,255,0],bitangentMode:!1,bitangentColor:[0,0,255]},this.sketchFolder=null,this.rotate=null,this.specularShiftTexture=null,this.hairMaterial=new Gt(this.engine),this.hairFolder=null}onAwake(){super.onAwake(),this.sketchSelection=this.entity.addComponent(Hp),this.sketchSelection.camera=this.camera,this._addSketchGUI()}gltfProcess(o){const n=o.defaultSceneRoot;this.rotate=n.addComponent(Wp),n.transform.setPosition(0,-1.5,0);const t=this.hairMaterial,e=this._findHair(n);if(e){this.sketchSelection.specificEntity=e;const r=e.getComponent(Ir),a=r.getMaterial();t.roughness=a.roughness,t.metallic=a.metallic,t.baseColor=a.baseColor,t.baseTexture=a.baseTexture,t.normalTexture=a.normalTexture,t.normalTextureIntensity=a.normalTextureIntensity,t.occlusionTexture=a.occlusionTexture,t.occlusionTextureIntensity=a.occlusionTextureIntensity,t.occlusionTextureCoord=a.occlusionTextureCoord,t.specularShiftTexture=this.specularShiftTexture,t.specularWidth=1,t.specularScale=.15,t.specularPower=64,t.primaryColor.set(1,1,1,1),t.primaryShift=.25,t.secondaryColor.set(1,1,1,1),t.secondaryShift=.25,r.setMaterial(t),this._addHairGUI()}else console.log("dont' find hair entity")}_findHair(o){if(o.name=="hair"||o.name=="Hair"||o.name=="hair_16"||o.name=="Hair_16")return o;let n=o.findByName("hair");return n||(n=o.findByName("Hair"),n)||(n=o.findByName("hair_16"),n)||(n=o.findByName("Hair_16"),n)?n:null}initScene(){this.engine.canvas.resizeByClientSize(),this.controller.minDistance=0,this.state.background&&(this.scene.background.mode=rr.Sky),this.scene.background.solidColor=new oe(0,0,0,0),this.scene.background.sky.material=this.skyMaterial,this.scene.background.sky.mesh=vn.createCuboid(this.engine,1,1,1),this.lightState.lights||(this.mainLight.enabled=this.purpleLight.enabled=!1),this.mainLight.intensity=this.lightState.mainLightIntensity,this.purpleLight.intensity=this.lightState.purpleLightIntensity,this.mainLightEntity.transform.setPosition(0,0,.5),this.mainLightEntity.transform.setRotation(-22,0,0),this.purpleLightEntity.transform.setPosition(0,0,-.5),this.purpleLightEntity.transform.setRotation(0,210,0),this.purpleLight.color.set(189/255,16/255,224/255,1);const o=this.mainLightEntity.addComponent(Ir);o.mesh=vn.createCuboid(Zr,.01,.01,.01),o.setMaterial(new ai(Zr));const n=this.purpleLightEntity.addComponent(Ir);n.mesh=vn.createCuboid(Zr,.01,.01,.01),n.setMaterial(new ai(Zr)),Zr.resourceManager.load({type:Xe.Texture2D,url:"https://gw.alipayobjects.com/mdn/rms_7c464e/afts/img/A*c0I7QbEzqYoAAAAAAAAAAAAAARQnAQ"}).then(t=>{this.specularShiftTexture=t,this.textures.defaultHairShift=t,this._addHairGUI()})}laterOnTextureLoader(){this._addHairGUI()}sceneGUI(o){this.lightFolder.add(this.lightState,"lights").onChange(n=>{this.mainLight.enabled=this.purpleLight.enabled=n}),this.lightFolder.addColor(this.lightState,"mainLightColor").onChange(n=>{Yi.guiToColor(n,this.mainLight.color)}),this.lightFolder.addColor(this.lightState,"purpleLightColor").onChange(n=>{Yi.guiToColor(n,this.purpleLight.color)}),this.lightFolder.add(this.lightState,"mainLightIntensity",0,2).onChange(n=>{this.mainLight.intensity=n}),this.lightFolder.add(this.lightState,"purpleLightIntensity",0,2).onChange(n=>{this.purpleLight.intensity=n})}_addHairGUI(){const{gui:o}=this;this.hairFolder&&(o.removeFolder(this.hairFolder),this.hairFolder=null);const n=this.hairMaterial,t=this.hairFolder=o.addFolder("Hair"),e={pause:!0,primaryColor:Lt.colorToGui(n.primaryColor),secondaryColor:Lt.colorToGui(n.secondaryColor),shiftTexture:n.specularShiftTexture?"defaultHairShift":"",opacity:n.baseColor.a,baseColor:Lt.colorToGui(n.baseColor),emissiveColor:Lt.colorToGui(n.emissiveColor),baseTexture:n.baseTexture?"origin":"",roughnessMetallicTexture:n.roughnessMetallicTexture?"origin":"",normalTexture:n.normalTexture?"origin":"",emissiveTexture:n.emissiveTexture?"origin":"",occlusionTexture:n.occlusionTexture?"origin":""},r={baseTexture:n.baseTexture,roughnessMetallicTexture:n.roughnessMetallicTexture,normalTexture:n.normalTexture,emissiveTexture:n.emissiveTexture,occlusionTexture:n.occlusionTexture},a=t.addFolder("Metallic-Roughness props");a.add(n,"metallic",0,1).step(.01),a.add(n,"roughness",0,1).step(.01),a.add(e,"roughnessMetallicTexture",["None","origin",...Object.keys(this.textures)]).onChange(c=>{n.roughnessMetallicTexture=c==="None"?null:this.textures[c]||r.roughnessMetallicTexture});const s=t.addFolder("Common props");s.add(e,"opacity",0,1).step(.01).onChange(c=>{n.baseColor.a=c}),s.add(n,"isTransparent"),s.add(n,"alphaCutoff",0,1).step(.01),s.addColor(e,"baseColor").onChange(c=>{Lt.guiToColor(c,n.baseColor)}),s.addColor(e,"emissiveColor").onChange(c=>{Lt.guiToColor(c,n.emissiveColor)}),s.add(e,"baseTexture",["None","origin",...Object.keys(this.textures)]).onChange(c=>{n.baseTexture=c==="None"?null:this.textures[c]||r.baseTexture}),s.add(e,"normalTexture",["None","origin",...Object.keys(this.textures)]).onChange(c=>{n.normalTexture=c==="None"?null:this.textures[c]||r.normalTexture}),s.add(e,"emissiveTexture",["None","origin",...Object.keys(this.textures)]).onChange(c=>{n.emissiveTexture=c==="None"?null:this.textures[c]||r.emissiveTexture}),s.add(e,"occlusionTexture",["None","origin",...Object.keys(this.textures)]).onChange(c=>{n.occlusionTexture=c==="None"?null:this.textures[c]||r.occlusionTexture});const l=t.addFolder("Specular props");l.add(e,"pause").onChange(c=>{this.rotate.pause=!!c}),l.add(n,"specularWidth",0,1),l.add(n,"specularScale",0,1),l.add(n,"specularPower",0,100),l.add(n,"primaryShift",-1,1),l.addColor(e,"primaryColor").onChange(c=>{n.primaryColor.set(c[0]/255,c[1]/255,c[2]/255,1)}),l.add(n,"secondaryShift",-1,1),l.addColor(e,"secondaryColor").onChange(c=>{n.secondaryColor.set(c[0]/255,c[1]/255,c[2]/255,1)}),l.add(e,"shiftTexture",["None","defaultHairShift",...Object.keys(this.textures)]).onChange(c=>{n.specularShiftTexture=c==="None"?null:this.textures[c]||r.occlusionTexture}),l.open(),t.open()}_addSketchGUI(){const{gui:o}=this;this.sketchFolder&&o.removeFolder(this.sketchFolder),this.sketchFolder=o.addFolder("Sketch"),this.sketchFolder.add(this.sketchSelection.sketch,"scale",0,.3),this.sketchFolder.add(this.sketchState,"wireframeMode").onChange(n=>{this.sketchSelection.sketch.setSketchMode(zr.Wireframe,n)}),this.sketchFolder.addColor(this.sketchState,"wireframeBaseColor").onChange(n=>{this.sketchSelection.sketch.wireframeMaterial.baseColor.set(n[0]/255,n[1]/255,n[2]/255,1)}),this.sketchFolder.add(this.sketchState,"normalMode").onChange(n=>{this.sketchSelection.sketch.setSketchMode(zr.Normal,n)}),this.sketchFolder.add(this.sketchState,"tangentMode").onChange(n=>{this.sketchSelection.sketch.setSketchMode(zr.Tangent,n)}),this.sketchFolder.add(this.sketchState,"bitangentMode").onChange(n=>{this.sketchSelection.sketch.setSketchMode(zr.BiTangent,n)}),this.sketchFolder.addColor(this.sketchState,"normalColor").onChange(n=>{this.sketchSelection.sketch.normalMaterial.baseColor.set(n[0]/255,n[1]/255,n[2]/255,1)}),this.sketchFolder.addColor(this.sketchState,"tangentColor").onChange(n=>{this.sketchSelection.sketch.tangentMaterial.baseColor.set(n[0]/255,n[1]/255,n[2]/255,1)}),this.sketchFolder.addColor(this.sketchState,"bitangentColor").onChange(n=>{this.sketchSelection.sketch.biTangentMaterial.baseColor.set(n[0]/255,n[1]/255,n[2]/255,1)}),this.sketchFolder.open()}}const Zr=new mv("canvas");Zr.canvas.resizeByClientSize();const Xp=Zr.sceneManager.activeScene,jp=Xp.createRootEntity();jp.addComponent(Yi);Zr.run();
